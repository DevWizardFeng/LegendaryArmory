<h1 _ngcontent-orb-c119="" class="doc-title ng-star-inserted" title="实现富文本编辑器"> 实现富文本编辑器 </h1>

<div _ngcontent-orb-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section48341559122915">概述<i class="anchor-icon anchor-icon-link" anchorid="section48341559122915" tips="复制节点链接"></i></h2><p>在移动应用开发中，富文本编辑器是社交、评论、笔记等场景的核心组件。ArkUI提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor" target="_blank">RichEditor</a>组件，支持图文混排和交互式文本编辑。</p> <p>本文旨在探讨如何使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor" target="_blank">RichEditor</a>组件，在内容发布场景中实现自定义表情、@好友、添加话题等功能，并提供示例代码详细拆解细节逻辑，如@好友如何被视为一个整体，编辑器中内容如何获取并归一化处理等。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.83321940906233473590001625514692:50001231000000:2800:931A651D49222FC30C0CCD854BD721E46A24812388E8C437EA6735D094E98A7B.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h2 id="section57822612309">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section57822612309" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19875144973211" class="firsth2">RichEditor组件内容管理方式选型<i class="anchor-icon anchor-icon-link" anchorid="section19875144973211" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor" target="_blank">RichEditor</a>组件提供两套内容管理接口，方式一使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditorstyledstringoptions12" target="_blank">RichEditor(options: RichEditorStyledStringOptions)</a>接口创建基于属性字符串（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-styled-string" target="_blank">StyledString/MutableStyledString</a>）进行内容管理的组件，方式二使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditoroptions" target="_blank">RichEditor(value: RichEditorOptions)</a>接口创建基于Span进行内容管理的组件。在本文内容发布场景中需要频繁进行输入文字、添加表情、@好友、删除等操作，且无需复杂的样式操作，选择使用方式二基于Span进行内容管理更为合适。</p> <ul><li>方式一：基于属性字符串管理<ul><li>进行内容样式更新，更加灵活便捷。</li><li>序列化困难，需手动提取属性存储，增加持久化逻辑复杂度。</li><li>动态内容维护成本高，不适合频繁增删操作。</li></ul> </li><li>方式二：基于Span管理<ul><li>使用便捷，通过直接操作独立的Span来动态构建和修改内容。</li><li>支持增量式操作，适合需要频繁交互、动态修改（如插入表情、@好友）的场景。</li></ul> </li></ul> </div> <div class="tiledSection"><h3 id="section0845456185414">添加不同类型内容的方式选型<i class="anchor-icon anchor-icon-link" anchorid="section0845456185414" tips="复制节点链接"></i></h3><p>编辑区域支持输入文字、表情、@好友等内容。</p> <ul><li>使用系统键盘可输入文字，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#settypingstyle11" target="_blank">RichEditorController.setTypingStyle()</a>方法可以设置默认的文本样式。</li><li>添加自定义表情图片可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">RichEditorController.addImageSpan()</a>方法实现。</li><li>@好友可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">RichEditorController.addTextSpan()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addbuilderspan11" target="_blank">RichEditorController.addBuilderSpan()</a>两种方法实现。<p>通过如下对比分析可知，使用addBuilderSpan()方法实现更为便捷，但是无法规避折行问题，具体实现可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-comment-reply-pop-up-window#section1318482323916" target="_blank">评论回复弹窗</a>。本文使用addTextSpan()方法实现，提供@好友等自定义内容需要折行显示的开发指导。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.3.3.4.1.4.1.1" valign="top" width="21.07210721072107%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.3.4.1.4.1.2" valign="top" width="45.24452445244525%"><p>使用addBuilderSpan()方法</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.3.3.4.1.4.1.3" valign="top" width="33.68336833683368%"><p>使用addTextSpan()方法</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="21.07210721072107%"><p>内容长度</p> </td> <td class="cellrowborder" valign="top" width="45.24452445244525%"><p>默认作为一个整体，长度视为一个文字</p> </td> <td class="cellrowborder" valign="top" width="33.68336833683368%"><p>以文本形式添加，长度为文本长度</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.07210721072107%"><p>光标与删除逻辑</p> </td> <td class="cellrowborder" valign="top" width="45.24452445244525%"><p>默认作为一个整体，无需额外处理</p> </td> <td class="cellrowborder" valign="top" width="33.68336833683368%"><p>需手动处理光标变化、删除规则</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.07210721072107%"><p>折行与显示规则</p> </td> <td class="cellrowborder" valign="top" width="45.24452445244525%"><p>长度超一行：光标高度随builderSpan高度自动调整</p> <p>长度不超一行：无法折行，触达边界后自动换行</p> </td> <td class="cellrowborder" valign="top" width="33.68336833683368%"><p>与普通文本逻辑一致，支持正常折行显示</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="21.07210721072107%"><p>数据获取与维护</p> </td> <td class="cellrowborder" valign="top" width="45.24452445244525%"><p>无法获取builderSpan中的内容</p> </td> <td class="cellrowborder" valign="top" width="33.68336833683368%"><p>可获取textSpan内容，但额外携带数据需自行维护</p> </td> </tr>  </tbody></table></div> </div> </li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>为了方便表述，对通过addTextSpan()方法和addBuilderSpan()方法添加到编辑区域的内容分别命名为textSpan和builderSpan。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section153701489425">维护输入内容<i class="anchor-icon anchor-icon-link" anchorid="section153701489425" tips="复制节点链接"></i></h3><p>由上述选型可知，使用addTextSpan()方法实现@好友、添加话题等自定义内容时，需手动处理光标变化、删除内容和携带数据的逻辑。</p> <p>需要定义一个数据结构能将自定义的textSpan维护起来，value用于存储显示的文字内容，spanRange记录内容在编辑区的起始位置和结束位置，以便查找，type用于区分不同类型（例如是@好友还是添加的话题）。data用于携带结构化数据，如好友id、头像等。</p> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L21-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">interface</span> <span class="hljs-title class_">TextSpan</span> {</li><li>  <span class="hljs-variable">value</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">spanRange</span>: [<span class="hljs-variable">number</span>, <span class="hljs-variable">number</span>];</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">data</span>: <span class="hljs-title class_">ESObject</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L21-L26" target="_blank">EditorView.ets</a></div></div></div></div> <p>通过维护一个textSpans数组记录所有自定义的textSpan，涉及编辑区域添加或删除内容的操作都需要去更新当前光标后所有textSpan的位置信息（spanRange字段）。</p> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L56-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-attr">textSpans</span>: <span class="hljs-title class_">TextSpan</span>[] = [];</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// Update the textSpans range that come after the current offset</span></li><li><span class="hljs-title function_">updateTextSpans</span>(<span class="hljs-params">insertOffset: <span class="hljs-built_in">number</span>, insertLength: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">textSpans</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">textSpan</span> =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (textSpan.<span class="hljs-property">spanRange</span>[<span class="hljs-number">0</span>] &gt;= insertOffset) {</li><li>      textSpan.<span class="hljs-property">spanRange</span>[<span class="hljs-number">0</span>] += insertLength;</li><li>      textSpan.<span class="hljs-property">spanRange</span>[<span class="hljs-number">1</span>] += insertLength;</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L56-L78" target="_blank">EditorView.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section151528591015">添加自定义表情<i class="anchor-icon anchor-icon-link" anchorid="section151528591015" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1726056183420" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1726056183420" tips="复制节点链接"></i></h3><p>点击下方表情按钮，系统键盘切换为表情面板。点击表情图标，会在编辑区域光标后方添加对应的表情内容。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.51562473288926322180548887224028:50001231000000:2800:ABB97152103352FCB4BE81D74E767DF0B5BB69DE9D05165FD4D66102BD4C5393.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section135731813341">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section135731813341" tips="复制节点链接"></i></h3><ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#customkeyboard" target="_blank">customKeyboard(value: CustomBuilder, options?: KeyboardOptions)</a>属性给编辑区域绑定自定义键盘，通过状态变量isEmojiKeyboard控制系统键盘和自定义键盘（表情面板）的切换。并设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#keyboardoptions12" target="_blank">KeyboardOptions</a>参数中的supportAvoidance属性值为true，使自定义键盘也支持避让功能。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L59-L351" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Link</span> <span class="hljs-variable">isEmojiKeyboard</span>: <span class="hljs-title class_">boolean</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">RichEditor</span>({</li><li>    <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">richEditorController</span></li><li>  })</li><li>    .<span class="hljs-title function_">customKeyboard</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isEmojiKeyboard</span> ? <span class="hljs-keyword">this</span>.<span class="hljs-title function_">EmojiKeyboard</span>() : <span class="hljs-title class_">undefined</span>, {</li><li>      <span class="hljs-variable">supportAvoidance</span>: <span class="hljs-keyword">true</span></li><li>    })</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L59-L351" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>在表情面板中点击表情，可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">addImageSpan()</a>方法在编辑区域添加表情图片，默认在内容最后方插入。<p>通过设置offset属性为当前光标位置，使表情在正确位置插入。</p> <p>当前光标位置可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getcaretoffset10" target="_blank">getCaretOffset()</a>方法获取。后文类似的插入操作都遵循此规则。</p> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L96-L107" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">value</span>: <span class="hljs-title class_">ResourceStr</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">controller</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">curOffset</span> = <span class="hljs-variable">controller</span>.<span class="hljs-title function_">getCaretOffset</span>();</li><li>  <span class="hljs-variable">controller</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">value</span>, {</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-title class_">curOffset</span>,</li><li>    <span class="hljs-variable">imageStyle</span>: {</li><li>      <span class="hljs-variable">size</span>: [<span class="hljs-number">16</span>, <span class="hljs-number">16</span>]</li><li>    }</li><li>  });</li><li>  <span class="hljs-comment">// Update the textSpans spanRange that come after the current offset</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">updateTextSpans</span>(<span class="hljs-variable">curOffset</span>, <span class="hljs-number">1</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L96-L107" target="_blank">EditorView.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section13381137195312">@好友<i class="anchor-icon anchor-icon-link" anchorid="section13381137195312" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section123464306523" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section123464306523" tips="复制节点链接"></i></h3><p>点击下方工具栏@图标或使用系统键盘输入@字符，会跳转到好友列表页面，选择对应好友将自动跳转回编辑页面并在编辑区域添加对应的@好友内容。</p> <p>添加话题、标题与@好友逻辑一致。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.22524461777916903257645549931300:50001231000000:2800:D8AE6D419F6E39B56D8DE9F7F79B9447BD120C19AD74F772903357416DEF1F5C.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section83621264812">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section83621264812" tips="复制节点链接"></i></h3><ul><li id="li4151245711"><strong>点击工具栏@图标跳转好友列表</strong></li></ul> <ol><li>点击下方工具栏@图标，跳转到好友列表页面，选择好友后，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">addTextSpan()</a>方法将@好友作为文本内容添加到编辑区域。通过offset属性和style属性分别控制插入的位置和样式。可通过添加一个空字符和其他内容做视觉上的分割。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L111-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">value</span>: <span class="hljs-title class_">string</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">data</span>: <span class="hljs-title class_">ESObject</span>, <span class="hljs-variable">style</span>: <span class="hljs-title class_">RichEditorTextStyle</span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">controller</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">curOffset</span> = <span class="hljs-variable">controller</span>.<span class="hljs-title function_">getCaretOffset</span>();</li><li>  <span class="hljs-variable">controller</span>.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">value</span>, {</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-title class_">curOffset</span>,</li><li>    <span class="hljs-variable">style</span></li><li>  });</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">splitChar</span> = <span class="hljs-string">' '</span>;</li><li>  <span class="hljs-variable">controller</span>.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">splitChar</span>, {</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-title class_">controller</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L111-L142" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>维护自定义textSpan数据。更新在当前光标后面所有的自定义textSpan的位置信息，起始位置往后移动的距离为新添加内容的长度，并在textSpans数组中添加该自定义内容textSpan的信息。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L112-L143" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addTextSpan</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>, data: ESObject, style: RichEditorTextStyle</span>) {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateTextSpans</span>(curOffset, value.<span class="hljs-property">length</span> + splitChar.<span class="hljs-property">length</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">textSpans</span>.<span class="hljs-title function_">push</span>({</li><li>    value,</li><li>    <span class="hljs-keyword">type</span>,</li><li>    data,</li><li>    <span class="hljs-attr">spanRange</span>: [curOffset, curOffset + value.<span class="hljs-property">length</span>],</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L112-L143" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>在编辑区域添加了@好友内容后，在其前后输入的文字会拥有@好友内容的样式，并与其合并成一个textSpan。<p>在RichEditor组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#onready" target="_blank">onReady()</a>事件回调函数中，为键盘输入内容设置默认样式，这样就能与@好友等自定义textSpan内容隔离开。</p> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L318-L340" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">RichEditor</span>({</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">richEditorController</span></li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onReady</span>(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>.<span class="hljs-title function_">setTypingStyle</span>({</li><li>      <span class="hljs-variable">fontColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-title class_">Black</span>,</li><li>    })</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L318-L340" target="_blank">EditorView.ets</a></div></div></div></div> </li></ol> <ul><li><strong>键盘输入@符号跳转好友列表</strong></li></ul> <ol><li>通过键盘输入@符号的方式跳转好友列表，键盘默认行为会先在编辑区添加@符号，在选择好友后需要先删除默认行为添加@符号，再将@好友作为整体通过addTextSpan()方法添加。<p>通过状态变量isKeyboardTriggered标志是否为键盘输入触发。在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#abouttoimeinput" target="_blank">aboutToIMEInput()</a>键盘输入事件的回调函数中，判断插入字符是@，则更新标志位为true，并跳转联系人页面。在添加@好友内容时如果是键盘输入触发，则删除光标前一个字符，并将标志位重置为false。</p> <div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@State</span> <span class="hljs-attr">isKeyboardTriggered</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">deletePrevChar</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> controller = <span class="hljs-variable language_">this</span>.<span class="hljs-property">richEditorController</span>;</li><li>  <span class="hljs-keyword">const</span> offset = controller.<span class="hljs-title function_">getCaretOffset</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">range</span>: <span class="hljs-title class_">RichEditorRange</span> = { <span class="hljs-attr">start</span>: offset - <span class="hljs-number">1</span>, <span class="hljs-attr">end</span>: offset };</li><li>  controller.<span class="hljs-title function_">deleteSpans</span>(range);</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">addTextSpan</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span>, <span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>, data: ESObject, style: RichEditorTextStyle</span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardTriggered</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">deletePrevChar</span>()</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardTriggered</span> = <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-attr">aboutToIMEInput</span>: <span class="hljs-function">(<span class="hljs-params">value: RichEditorInsertValue</span>) =&gt;</span> <span class="hljs-built_in">boolean</span> = <span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (value.<span class="hljs-property">insertValue</span> === <span class="hljs-string">'@'</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardTriggered</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">pushUrl</span>({ <span class="hljs-attr">url</span>: <span class="hljs-string">'pages/ContactListPage'</span> });</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre></div></div> </li><li>后续步骤与<a href="/consumer/cn/doc/best-practices/bpta-rich-text-editor#li4151245711">点击工具栏@图标跳转好友列表</a>方式的开发步骤中的1、2、3步一致。</li></ol> </div> <div class="tiledSection"><h2 id="section13471220154519">处理光标位置<i class="anchor-icon anchor-icon-link" anchorid="section13471220154519" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section9320182619508" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section9320182619508" tips="复制节点链接"></i></h3><p>光标不可落入@好友文本的内部。当用户点击或选中@好友这种自定义内容时，光标应自动跳转到内容的开始或结束位置。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.29964669227920105804973880821533:50001231000000:2800:2CFD88E2B551D98FAAECF81FE9CA7CB7C1207E01D3B65FBDAE6809EB16B4A564.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section55611733105015">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section55611733105015" tips="复制节点链接"></i></h3><ol><li>判断当前光标位置是否在自定义内容的textSpan中间，是则根据就近原则返回textSpan的起始位置或结束位置，否则返回当前光标位置。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L250-L261" data-highlighted="yes"><ol class="linenums"><li>snapCaretToTextSpanBoundary(caretOffset: number, type?: <span class="hljs-string">'start'</span> | <span class="hljs-string">'end'</span>) {</li><li>  <span class="hljs-keyword">const</span> textSpan = <span class="hljs-keyword">this</span>.textSpans.find(textSpan =&gt; {</li><li>    <span class="hljs-keyword">return</span> caretOffset &gt; textSpan.spanRange[<span class="hljs-number">0</span>] &amp;&amp; caretOffset &lt; textSpan.spanRange[<span class="hljs-number">1</span>];</li><li>  });</li><li>  <span class="hljs-keyword">if</span> (!textSpan) <span class="hljs-keyword">return</span> caretOffset;</li><li>  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'start'</span>) <span class="hljs-keyword">return</span> textSpan.spanRange[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'end'</span>) <span class="hljs-keyword">return</span> textSpan.spanRange[<span class="hljs-number">1</span>];</li><li>  <span class="hljs-keyword">const</span> disToStart = caretOffset - textSpan.spanRange[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">const</span> disToEnd = textSpan.spanRange[<span class="hljs-number">1</span>] - caretOffset;</li><li>  <span class="hljs-keyword">if</span> (disToStart &lt;= disToEnd) <span class="hljs-keyword">return</span> textSpan.spanRange[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">return</span> textSpan.spanRange[<span class="hljs-number">1</span>];</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L250-L261" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>当用户点击@好友内容时，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#onselectionchange12" target="_blank">onSelectionChange()</a>事件的回调函数中重新计算并使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#setcaretoffset10" target="_blank">setCaretOffset()</a>设置光标位置。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L231-L237" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">onSelectionChange</span>: <span class="hljs-function">(<span class="hljs-params">range: RichEditorRange</span>) =&gt;</span> <span class="hljs-keyword">void</span> = <span class="hljs-function"><span class="hljs-params">range</span> =&gt;</span> {</li><li>  <span class="hljs-comment">// When start and end values are the same, it indicates a cursor position change triggered by a click, with no selected area.</span></li><li>  <span class="hljs-keyword">if</span> (range.<span class="hljs-property">start</span> === range.<span class="hljs-property">end</span>) {</li><li>    <span class="hljs-keyword">const</span> targetCaretOffset = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">snapCaretToTextSpanBoundary</span>(range.<span class="hljs-property">start</span>!);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">richEditorController</span>.<span class="hljs-title function_">setCaretOffset</span>(targetCaretOffset);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L231-L237" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>当选中内容发生变化时，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#onselect" target="_blank">onSelect()</a>事件的回调函数中获取选中内容的起始位置和结束位置。<ul><li>当它们处于同一个自定义内容的textSpan中间时，更新两个光标的位置到该textSpan的起始位置和结束为止。</li><li>否则，更新两个光标的位置到各自就近的textSpan边缘。</li></ul> <p>最后通过setSelection()方法设置计算后的选中区域。</p> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L208-L227" data-highlighted="yes"><ol class="linenums"><li>onSelect: (selection: RichEditorSelection) =&gt; void = richEditorSelection =&gt; {</li><li>  <span class="hljs-keyword">const</span> caretStart = richEditorSelection.selection[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">const</span> caretEnd = richEditorSelection.selection[<span class="hljs-number">1</span>];</li><li>  <span class="hljs-comment">// Determine if the selected content lies within a single textSpan.</span></li><li>  <span class="hljs-comment">// If it does, adjust the selection range to the start and end of that textSpan.</span></li><li>  <span class="hljs-keyword">const</span> textSpan = <span class="hljs-keyword">this</span>.textSpans.find(textSpan =&gt; {</li><li>    <span class="hljs-keyword">return</span> caretStart &gt;= textSpan.spanRange[<span class="hljs-number">0</span>] &amp;&amp; caretEnd &lt;= textSpan.spanRange[<span class="hljs-number">1</span>];</li><li>  });</li><li>  <span class="hljs-keyword">if</span> (textSpan) {</li><li>    <span class="hljs-keyword">this</span>.richEditorController.setSelection(textSpan.spanRange[<span class="hljs-number">0</span>], textSpan.spanRange[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-comment">// Both values being -1 indicates clear selection operation.</span></li><li>  <span class="hljs-keyword">if</span> (caretStart === -<span class="hljs-number">1</span> &amp;&amp; caretEnd ===  -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-keyword">return</span></li><li>  }</li><li>  <span class="hljs-keyword">const</span> selectionStart = <span class="hljs-keyword">this</span>.snapCaretToTextSpanBoundary(caretStart);</li><li>  <span class="hljs-keyword">const</span> selectionEnd = <span class="hljs-keyword">this</span>.snapCaretToTextSpanBoundary(caretEnd);</li><li>  <span class="hljs-keyword">this</span>.richEditorController.setSelection(selectionStart, selectionEnd);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L208-L227" target="_blank">EditorView.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section326113715452">删除内容<i class="anchor-icon anchor-icon-link" anchorid="section326113715452" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1091217437500" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1091217437500" tips="复制节点链接"></i></h3><p>点击软键盘删除按钮，光标前待删除的是@好友等自定义内容时，则作为整体删除。其余内容删除时无需额外处理。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.37099224281148273960821567150921:50001231000000:2800:45A6C814650FDA7999A074D8AAAD5ADD54AA8557B057A93A41178E2F66A2FA31.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section192762486503">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section192762486503" tips="复制节点链接"></i></h3><ol><li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#abouttodelete" target="_blank">aboutToDelete()</a>事件的回调函数中，获取将要删除内容的起始位置和结束位置。</li><li>若起始位置在自定义的textSpan中间，则更新起始位置为该textSpan的起始位置。若结束位置在自定义的textSpan中间，则更新结束位置为该textSpan的结束位置。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#deletespans" target="_blank">deleteSpans()</a>方法删除编辑区域中的内容。</li><li>更新自行维护的textSpans数据，删除起始位置和结束位置中间所有的textSpan数据，并更新在删除内容后所有的自定义textSpan的位置信息。</li></ol> <div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L188-L204" data-highlighted="yes"><ol class="linenums"><li>aboutToDelete: (value: RichEditorDeleteValue) =&gt; boolean = deleteValue =&gt; {</li><li>  <span class="hljs-keyword">const</span> start = deleteValue.offset;</li><li>  <span class="hljs-keyword">const</span> end = start + deleteValue.length;</li><li>  <span class="hljs-keyword">const</span> snapStart = <span class="hljs-keyword">this</span>.snapCaretToTextSpanBoundary(start, <span class="hljs-string">'start'</span>);</li><li>  <span class="hljs-keyword">const</span> snapEnd = <span class="hljs-keyword">this</span>.snapCaretToTextSpanBoundary(end, <span class="hljs-string">'end'</span>);</li><li>  <span class="hljs-keyword">this</span>.richEditorController.deleteSpans({</li><li>    start: snapStart,</li><li>    end: snapEnd</li><li>  });</li><li>  <span class="hljs-comment">// delete all textSpans in selection</span></li><li>  <span class="hljs-keyword">this</span>.textSpans = <span class="hljs-keyword">this</span>.textSpans.filter(ts =&gt; {</li><li>    <span class="hljs-keyword">const</span> isInRange = ts.spanRange[<span class="hljs-number">0</span>] &gt;= snapStart &amp;&amp; ts.spanRange[<span class="hljs-number">1</span>] &lt;= snapEnd</li><li>    <span class="hljs-keyword">return</span> !isInRange;</li><li>  });</li><li>  <span class="hljs-keyword">this</span>.updateTextSpans(snapStart, snapStart - snapEnd);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L188-L204" target="_blank">EditorView.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section13583102185219">获取内容<i class="anchor-icon anchor-icon-link" anchorid="section13583102185219" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0689112135210" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section0689112135210" tips="复制节点链接"></i></h3><p>发布内容时，需要获取编辑区域的文本内容，同时还需要获取带有结构化信息（如好友的id）的数据，用于提交到服务器或持久化存储。</p> </div> <div class="tiledSection"><h3 id="section653452535214">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section653452535214" tips="复制节点链接"></i></h3><ol><li>实际开发中编辑区域不同类型的内容往往需要一种统一的数据结构来表达，方便传输和存储。这里定义为CustomSpan，其中value表示文本内容，resourceValue表示表情图片资源，type用于区分不同类型的textSpan，例如是@好友还是添加的话题，data用于存储携带的信息，例如好友id等。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L30-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CustomSpan</span> {</li><li>  <span class="hljs-variable">value</span>?: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">resourceValue</span>?: <span class="hljs-title class_">ResourceStr</span>;</li><li>  <span class="hljs-keyword">type</span>?: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">data</span>?: <span class="hljs-title class_">ESObject</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L30-L35" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>RichEditor组件提供<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getspans" target="_blank">getSpans()</a>方法来获取内容，但是例如@好友中一些结构化信息仍需要根据位置信息去手动维护的<a href="/consumer/cn/doc/best-practices/bpta-rich-text-editor#section153701489425">textSpans</a>数组中去查找。最后将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getspans" target="_blank">getSpans()</a>方法获取的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditortextspanresult" target="_blank">RichEditorTextSpanResult</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditorimagespanresult" target="_blank">RichEditorImageSpanResult</a>转换成CustomSpan。<div class="screenLinkPre"><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L269-L291" data-highlighted="yes"><ol class="linenums"><li>getData(): CustomSpan[] {</li><li>  <span class="hljs-keyword">const</span> customSpans = <span class="hljs-keyword">this</span>.richEditorController.getSpans().map(span =&gt; {</li><li>    <span class="hljs-keyword">const</span> textSpan = span <span class="hljs-keyword">as</span> RichEditorTextSpanResult;</li><li>    <span class="hljs-keyword">const</span> imageSpan = span <span class="hljs-keyword">as</span> RichEditorImageSpanResult;</li><li>    <span class="hljs-comment">// is imageSpan</span></li><li>    <span class="hljs-keyword">if</span> (!textSpan.value) {</li><li>      <span class="hljs-keyword">return</span> { resourceValue: imageSpan.valueResourceStr } <span class="hljs-keyword">as</span> CustomSpan;</li><li>    }</li><li>    <span class="hljs-comment">// is textSpan</span></li><li>    <span class="hljs-keyword">const</span> customTextSpan = <span class="hljs-keyword">this</span>.textSpans.find(customTextSpan =&gt; {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isTheSameRange(customTextSpan.spanRange, textSpan.spanPosition.spanRange);</li><li>    })</li><li>    <span class="hljs-keyword">if</span> (!customTextSpan) {</li><li>      <span class="hljs-keyword">return</span> { value: textSpan.value } <span class="hljs-keyword">as</span> CustomSpan;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> {</li><li>      value: customTextSpan.value,</li><li>      type: customTextSpan.type,</li><li>      <span class="hljs-keyword">data</span>: customTextSpan.<span class="hljs-keyword">data</span></li><li>    } <span class="hljs-keyword">as</span> CustomSpan;</li><li>  });</li><li>  <span class="hljs-keyword">return</span> customSpans;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/content-publisher/blob/master/entry/src/main/ets/views/EditorView.ets#L269-L291" target="_blank">EditorView.ets</a></div></div></div></div> </li><li>图中内容通过getData()方法生成的数据序列化后的数据如下，如何与服务端交互或使用这些数据，根据业务需求调整即可。<div class="p"><span><img height="105.133574" originheight="225" originwidth="777" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162937.46084807389536465872638710315285:50001231000000:2800:FF71F2ADB85F23E761A39D6B7768E8427D37A8F7C7C6A74133C399A37B5B9D34.png" title="点击放大" width="363.09000000000003"></span><div _ngcontent-orb-c106="" class="highlight-div"><div _ngcontent-orb-c106="" class="highlight-div-header"><div _ngcontent-orb-c106="" class="highlight-div-header-left"><div _ngcontent-orb-c106="" class="handle-button expand-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-orb-c106="" class="highlight-div-header-right"><div _ngcontent-orb-c106="" class="handle-button ai-button"></div><div _ngcontent-orb-c106="" class="handle-button line-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-orb-c106="" class="handle-button theme-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-orb-c106="" class="handle-button copy-button"><div _ngcontent-orb-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-orb-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>[{</li><li>  <span class="hljs-string">"value"</span>: <span class="hljs-string">"Hello"</span></li><li>}, {</li><li>  <span class="hljs-string">"resourceValue"</span>: <span class="hljs-string">"resource:///emoji_3.png"</span></li><li>}, {</li><li>  <span class="hljs-string">"value"</span>: <span class="hljs-string">"@阿飞"</span>,</li><li>  <span class="hljs-string">"type"</span>: <span class="hljs-string">"contact"</span>,</li><li>  <span class="hljs-string">"data"</span>: {</li><li>    <span class="hljs-string">"imgName"</span>: <span class="hljs-string">"app.media.ic_comm_pic1"</span>,</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"阿飞"</span></li><li>  }</li><li>}, {</li><li>  <span class="hljs-string">"value"</span>: <span class="hljs-string">" "</span></li><li>}, {</li><li>  <span class="hljs-string">"value"</span>: <span class="hljs-string">"#众测主题赛#"</span>,</li><li>  <span class="hljs-string">"type"</span>: <span class="hljs-string">"topic"</span>,</li><li>  <span class="hljs-string">"data"</span>: {</li><li>    <span class="hljs-string">"topicId"</span>: <span class="hljs-string">"1"</span>,</li><li>    <span class="hljs-string">"title"</span>: <span class="hljs-string">"众测主题赛"</span></li><li>}, {</li><li>  <span class="hljs-string">"value"</span>: <span class="hljs-string">" "</span></li><li>}]</li></ol></pre></div></div> </div> </li></ol> </div> <div class="tiledSection"><h2 id="section03628157572">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section03628157572" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1001744165714" class="firsth2">使用addBuilderSpan自定义内容时，折行显示与光标异常<i class="anchor-icon anchor-icon-link" anchorid="section1001744165714" tips="复制节点链接"></i></h3><p>对折行显示有硬性需求可使用addTextSpan方式实现。参考<a href="/consumer/cn/doc/best-practices/bpta-rich-text-editor#section0845456185414">添加不同类型内容的方式选型</a>。</p> </div> <div class="tiledSection"><h3 id="section51856125915">发布内容时如何处理富文本数据<i class="anchor-icon anchor-icon-link" anchorid="section51856125915" tips="复制节点链接"></i></h3><p>通过维护自定义textSpan数据的方式实现。参考<a href="/consumer/cn/doc/best-practices/bpta-rich-text-editor#section13583102185219">获取内容</a>。</p> </div> <div class="tiledSection"><h3 id="section3475152418620">如何自定义选择菜单<i class="anchor-icon anchor-icon-link" anchorid="section3475152418620" tips="复制节点链接"></i></h3><p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#bindselectionmenu" target="_blank">bindSelectionMenu</a>属性对不同类型的Span绑定不同的菜单。参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-common-components-richeditor#设置自定义选择菜单" target="_blank">自定义选择菜单</a>。</p> </div> <div class="tiledSection"><h2 id="section1982317381167">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1982317381167" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/content-publisher" target="_blank">实现富文本编辑器</a></li></ul> </div> </div> <div></div></div>