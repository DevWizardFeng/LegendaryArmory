<h1 _ngcontent-tku-c119="" class="doc-title ng-star-inserted" title="常见瀑布流操作"> 常见瀑布流操作 </h1>

<div _ngcontent-tku-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1972818599186">概述<i class="anchor-icon anchor-icon-link" anchorid="section1972818599186" tips="复制节点链接"></i></h2><p>在应用开发中，开发者常会遇到希望某些页面的内容呈现出“瀑布流”效果，如图片资讯页面、商品列表页面等。通过将元素自上而下排列，形成参差不齐的界面。本文介绍瀑布流常见操作，帮助开发者高效构建自己想要的瀑布流效果。</p> </div> <div class="tiledSection"><h2 id="section154611537122218">瀑布流排版<i class="anchor-icon anchor-icon-link" anchorid="section154611537122218" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section168611161198" class="firsth2"><strong>分组参差布局</strong><i class="anchor-icon anchor-icon-link" anchorid="section168611161198" tips="复制节点链接"></i></h3><p>在瀑布流常见开发场景中，主要实现方式类似下图布局效果。</p> <p><span><img height="549.5693" originheight="657" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.55102036998316367112624215658306:50001231000000:2800:6D6FA424DF493E7AB15C6027A0D67A9D304D2A05A37A649421FC50DC2FA701C9.png" title="点击放大" width="266"></span></p> <p>为了实现上图中分组参差不齐的效果，首先需要创建多个SectionOptions，并重写其中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#getitemmainsizebyindex12" target="_blank">onGetItemMainSizeByIndex()</a>方法的返回值。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/SectionOptionsUsePage.ets#L17-L203" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/CommonConstants"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">SectionsWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SectionOptionsUsePage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable">dataSource</span>: <span class="hljs-title class_">SectionsWaterFlowDataSource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SectionsWaterFlowDataSource</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">itemHeightArray</span>: <span class="hljs-title class_">number</span>[] = [];</li><li>  <span class="hljs-variable">sectionMargin</span>: <span class="hljs-title class_">Margin</span> = {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-number">16</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">16</span></li><li>  }</li><li>  <span class="hljs-comment">// 1、Create group information.</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WaterFlowSections</span>();</li><li>  @<span class="hljs-title function_">StorageProp</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">AS_KEY_STATUS_BAR_HEIGHT</span>) <span class="hljs-variable">statusBarHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// 2、Create the first group.</span></li><li>  <span class="hljs-variable">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">3</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">120</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// 3、Create the second group.</span></li><li>  <span class="hljs-variable">twoColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">160</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// 4、Create the third group.</span></li><li>  <span class="hljs-variable">dataSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">20</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">itemHeightArray</span>[<span class="hljs-variable">index</span> % <span class="hljs-number">100</span>];</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setItemSizeArray</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">initSections</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 5、Initialise group data.</span></li><li>  <span class="hljs-title function_">initSections</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sectionOptions</span>: <span class="hljs-title class_">SectionOptions</span>[] = [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">count</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">oneOrTwo</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dataCount</span>: <span class="hljs-title class_">number</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>.<span class="hljs-title function_">totalCount</span>();</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">count</span> &lt; <span class="hljs-title class_">dataCount</span>) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">dataCount</span> - <span class="hljs-variable">count</span> &lt; <span class="hljs-number">96</span>) {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSection</span>.<span class="hljs-variable">itemsCount</span> = <span class="hljs-variable">dataCount</span> - <span class="hljs-variable">count</span>;</li><li>        <span class="hljs-variable">sectionOptions</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSection</span>);</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">oneOrTwo</span>++ % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable">sectionOptions</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">oneColumnSection</span>);</li><li>        <span class="hljs-variable">count</span> += <span class="hljs-keyword">this</span>.<span class="hljs-variable">oneColumnSection</span>.<span class="hljs-variable">itemsCount</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">sectionOptions</span>.<span class="hljs-title function_">push</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">twoColumnSection</span>);</li><li>        <span class="hljs-variable">count</span> += <span class="hljs-keyword">this</span>.<span class="hljs-variable">twoColumnSection</span>.<span class="hljs-variable">itemsCount</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">sections</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">sectionOptions</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">0</span> }) {</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.section_sort'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-variable">FontWeight</span>.<span class="hljs-variable">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-string">'18vp'</span>, <span class="hljs-variable">left</span>: <span class="hljs-string">'16vp'</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-string">'8vp'</span> })</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 6、Link the grouping information to WaterFlow.</span></li><li>      <span class="hljs-title function_">WaterFlow</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> }) {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">12</span>)</li><li>      .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">statusBarHeight</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/SectionOptionsUsePage.ets#L17-L203" target="_blank">SectionOptionsUsePage.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ol><li>使用分组混合布局时，会忽略columnsTemplate和rowsTemplate属性。</li><li>使用分组混合布局时，不支持单独设置footer，如果需要footer组件，可使用最后一个分组作为尾部组件。</li><li>使用section分组后，必须确保WaterFlow中数据总数与section分组所有itemCount之和相等，否则界面可能显示为空白。</li></ol> </div></div></div> </div> <div class="tiledSection"><h3 id="section13982153920191"><strong>自定义高度</strong><i class="anchor-icon anchor-icon-link" anchorid="section13982153920191" tips="复制节点链接"></i></h3><p>WaterFlow中FlowItem的高度通过SectionOptions的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#getitemmainsizebyindex12" target="_blank">onGetItemMainSizeByIndex()</a>方法返回值来控制，其中参数index表示FlowItem的索引位置。</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/CustomItemHeightPage.ets#L17-L189" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">SectionsWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CustomItemHeightPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// 1、Create group information.</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WaterFlowSections</span>();</li><li>  <span class="hljs-variable">sectionMargin</span>: <span class="hljs-title class_">Margin</span> = {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">0</span></li><li>  };</li><li>  <span class="hljs-variable">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">3</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">columnsGap</span>: <span class="hljs-number">5</span>,</li><li>    <span class="hljs-variable">rowsGap</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-comment">// 1、Return item height.</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">120</span>;</li><li>    }</li><li>  };</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/CustomItemHeightPage.ets#L17-L189" target="_blank">CustomItemHeightPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section203101957171911"><strong>瀑布流吸顶</strong><i class="anchor-icon anchor-icon-link" anchorid="section203101957171911" tips="复制节点链接"></i></h3><p>在某些开发场景中，开发者可能希望WaterFlow向上滑动时，部分内容先跟随滑动，随后吸附于顶部。效果图如下：</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.17015195880042590730691709327532:50001231000000:2800:FC8E9B059B8C942B3B420F94F91AAA1BC41BCEDA5176D4FC4AE6294F95118208.gif" title="点击放大" width="266"></span></p> <p>为了实现上图效果，需在WaterFlow分组中需为吸顶的部分预留位置，并监听瀑布流滚动事件。吸顶部分依据瀑布流滑动后的偏移量设置位置，实现与瀑布流同步滚动；吸顶部分达到顶部后固定不动。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/StickOnTopPage.ets#L17-L462" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/constants/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-package">MediaItem</span>, { <span class="hljs-variable">ItemType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/MediaItem'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">StickyWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/StickyWaterFlowDataSource'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'StickOnTopPage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">StickyPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// 1、Define the height of the ceiling layout.</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">scrollOffset</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">stickItemHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">90</span>;</li><li>  <span class="hljs-variable">sectionMargin</span>: <span class="hljs-title class_">Margin</span> = {</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">8</span>,</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-number">16</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">16</span></li><li>  };</li><li>  <span class="hljs-variable">oneColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">3</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">1</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-comment">// 2、Set the ceiling layout height in the group.</span></li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">stickItemHeight</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">200</span>;</li><li>      }</li><li>    }</li><li>  };</li><li>  <span class="hljs-variable">twoColumnSection</span>: <span class="hljs-title class_">SectionOptions</span> = {</li><li>    <span class="hljs-variable">itemsCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">crossCount</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">margin</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sectionMargin</span>,</li><li>    <span class="hljs-variable">onGetItemMainSizeByIndex</span>: (<span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-number">250</span>;</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">TopStart</span> }) {</li><li>      <span class="hljs-title function_">WaterFlow</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">MediaItem</span>) =&gt; {</li><li>          <span class="hljs-title function_">FlowItem</span>() {</li><li>            <span class="hljs-comment">// 3、A location is reserved for the ceiling part, and the ceiling position is at the second element location, so the id is 1.</span></li><li>            <span class="hljs-title function_">FlowVideoItem</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> })</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">MediaItem</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">12</span>)</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">8</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>      .<span class="hljs-title function_">onWillScroll</span>((<span class="hljs-variable">offset</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>        <span class="hljs-comment">// 4、Listen to the waterfall scrolling event.</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">scrollOffset</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">scroller</span>.<span class="hljs-title function_">currentOffset</span>().<span class="hljs-variable">yOffset</span> + <span class="hljs-variable">offset</span>;</li><li>      })</li><li>
</li><li>      <span class="hljs-title function_">Stack</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-variable">HitTestMode</span>.<span class="hljs-variable">Transparent</span>)</li><li>      <span class="hljs-comment">// 5、Dynamically adjust the sticky position according to the waterfall flow sliding offset.</span></li><li>      .<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">y</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scrollOffset</span> &gt;= <span class="hljs-number">210</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">210</span> - <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scrollOffset</span> })</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/StickOnTopPage.ets#L17-L462" target="_blank">StickOnTopPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section515815611203"><strong>动态切换列数</strong><i class="anchor-icon anchor-icon-link" anchorid="section515815611203" tips="复制节点链接"></i></h3><p>在应用开发中，开发者需要在列表模式与瀑布流模式间进行切换，或适应屏幕宽度的变化。为解决此类需求，通常通过动态调整瀑布流的列数来实现。建议采用瀑布流的移动窗口布局模式，以实现更快速的列数转换。参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-create-waterflow#动态切换列数" target="_blank">动态切换列数</a>。</p> </div> <div class="tiledSection"><h2 id="section119347413579">瀑布流滑动<i class="anchor-icon anchor-icon-link" anchorid="section119347413579" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section14550824115710" class="firsth2">滑动性能优化<i class="anchor-icon anchor-icon-link" anchorid="section14550824115710" tips="复制节点链接"></i></h3><p>瀑布流上下滑动时，因其具有无限加载数据的特性，能够展示大量数据。不同大小的子元素将会带来测量和绘制的性能消耗过大。例如，在实际开发中，当瀑布流中的数据量过大时，可能会遇到渲染速度慢、滑动丢帧、内存占用高等问题，这些问题直接影响用户操作体验。为了解决这些开发中可能遇到的性能问题，建议参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-waterflow-performance-optimization#section088318458314" target="_blank">瀑布流优化</a>。</p> </div> <div class="tiledSection"><h3 id="section9392105018572">停止滑动时自动播放<i class="anchor-icon anchor-icon-link" anchorid="section9392105018572" tips="复制节点链接"></i></h3><p>在某些开发场景中，开发者可能想要在瀑布流停止滑动时播放其中的视频，效果图如下：</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162919.87729962095657467841288890407874:50001231000000:2800:7096E62F9815D3EEE622E84FD0DDC84126C07136EDD445CBDADC761978C7578A.gif" title="点击放大" width="266"></span></p> <p>若要实现上述效果，可利用组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-component-visible-area-change-event#onvisibleareachange" target="_blank">onVisibleAreaChange()</a>方法监听组件显示状态，以控制视频播放或暂停。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemAutoPlayPage.ets#L17-L230" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/constants/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-package">MediaItem</span>, { <span class="hljs-variable">ItemType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/MediaItem'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">StickyWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/StickyWaterFlowDataSource'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'FlowItemAutoPlayPage'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FlowVideoItem</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">item</span>: <span class="hljs-title class_">MediaItem</span>;</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">VideoController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">VideoController</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">MediaItem</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">item</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">MediaItem</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span>.<span class="hljs-keyword">type</span> === <span class="hljs-variable">ItemType</span>.<span class="hljs-variable">VIDEO</span>) {</li><li>      <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">BottomStart</span> }) {</li><li>        <span class="hljs-title function_">Video</span>({ <span class="hljs-variable">src</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">item</span>.<span class="hljs-title class_">videoUri</span>, <span class="hljs-variable">previewUri</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">item</span>.<span class="hljs-title class_">videoCover</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span> })</li><li>          .<span class="hljs-title function_">controls</span>(<span class="hljs-keyword">false</span>)</li><li>          .<span class="hljs-title function_">muted</span>(<span class="hljs-keyword">true</span>)</li><li>          .<span class="hljs-title function_">loop</span>(<span class="hljs-keyword">true</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>          .<span class="hljs-title function_">onVisibleAreaChange</span>([<span class="hljs-number">0.0</span>, <span class="hljs-number">1.0</span>], (<span class="hljs-variable">isVisible</span>: <span class="hljs-title class_">boolean</span>, <span class="hljs-variable">currentRatio</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>            <span class="hljs-comment">// 1、Slide to play the video when visible.</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">isVisible</span> &amp;&amp; <span class="hljs-variable">currentRatio</span> &gt;= <span class="hljs-number">1.0</span>) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">controller</span>.<span class="hljs-title function_">start</span>();</li><li>            }</li><li>            <span class="hljs-comment">// 2、Slide to pause the video when hidden.</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isVisible</span> || <span class="hljs-variable">currentRatio</span> &lt; <span class="hljs-number">1.0</span>) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">controller</span>.<span class="hljs-title function_">pause</span>();</li><li>            }</li><li>          })</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'NO. '</span> + (<span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span>.<span class="hljs-variable">id</span> + <span class="hljs-number">1</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-variable">left</span>: <span class="hljs-number">8</span>,</li><li>            <span class="hljs-variable">bottom</span>: <span class="hljs-number">4</span></li><li>          })</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemAutoPlayPage.ets#L17-L230" target="_blank">FlowItemAutoPlayPage.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>示例代码构建的数据屏幕中仅有一个视频。若屏幕中包含多个视频，滑动停止时需要播放首个完全显示的视频，则需借助WaterFlow的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onscrollindex11" target="_blank">onScrollIndex()</a>方法，实现相关逻辑。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section193081340162215">瀑布流数据更新<i class="anchor-icon anchor-icon-link" anchorid="section193081340162215" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section15666612131518" class="firsth2"><strong>下拉刷新</strong><i class="anchor-icon anchor-icon-link" anchorid="section15666612131518" tips="复制节点链接"></i></h3><p>在某些应用场景中，开发者可能实现如下图所示的刷新效果。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.74316427043288848202668782397302:50001231000000:2800:C9C9B96FF1ECD909313348983E866BD342D0CD8970092F77BE377FA37D1000CE.gif" title="点击放大" width="266"></span></p> <p>为了实现上述效果，开发者可通过Refresh组件实现瀑布流下拉刷新。通过Refresh组件进行页面下拉操作，并绑定显示刷新Loading动效的容器组件，以实现下拉刷新效果。随后，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-refresh#onrefreshing" target="_blank">onRefreshing()</a>事件中更新数据。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/DataUpdateAndAnimationPage.ets#L17-L319" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } from <span class="hljs-string">"@kit.PerformanceAnalysisKit"</span>;</li><li><span class="hljs-keyword">import</span> { CommonConstants } from <span class="hljs-string">"../common/constants/CommonConstants"</span>;</li><li><span class="hljs-keyword">import</span> { SectionsWaterFlowDataSource } from <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> TAG: string = <span class="hljs-string">'DataUpdateAndAnimationPage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct DataUpdateAndAnimationPage {</li><li>  <span class="hljs-meta">@State</span> isRefreshing: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> currentItem: number = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// 1、Refresh Loading Animation Component.</span></li><li>  <span class="hljs-meta">@Builder</span></li><li>  headerRefresh(): void {</li><li>    Column() {</li><li>      LoadingProgress()</li><li>        .color(Color.Black)</li><li>        .opacity(<span class="hljs-number">0.6</span>)</li><li>        .width(<span class="hljs-number">36</span>)</li><li>        .height(<span class="hljs-number">36</span>)</li><li>    }</li><li>    .justifyContent(FlexAlign.Center)</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 5、Pull down to refresh the data update logic.</span></li><li>  refresh(): void {</li><li>    <span class="hljs-keyword">this</span>.currentItem = -<span class="hljs-number">1</span>;</li><li>    setTimeout(() =&gt; {</li><li>      <span class="hljs-comment">// Add new data.</span></li><li>      <span class="hljs-keyword">this</span>.dataSource.dataArray = [];</li><li>      let value: number = Math.floor(Math.random() * <span class="hljs-number">100</span>);</li><li>      <span class="hljs-keyword">for</span> (let i: number = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {</li><li>        <span class="hljs-keyword">this</span>.dataSource.dataArray.push(i + value);</li><li>        <span class="hljs-keyword">this</span>.dataSource.notifyDataAdd(i);</li><li>      }</li><li>      <span class="hljs-comment">// Update sections itemsCount.</span></li><li>      <span class="hljs-keyword">this</span>.oneColumnSection.itemsCount = <span class="hljs-number">3</span>;</li><li>      <span class="hljs-keyword">this</span>.oneColumnSection.crossCount = <span class="hljs-number">1</span>;</li><li>      <span class="hljs-keyword">this</span>.twoColumnSection.itemsCount = <span class="hljs-number">2</span>;</li><li>      <span class="hljs-keyword">this</span>.twoColumnSection.crossCount = <span class="hljs-number">2</span>;</li><li>      <span class="hljs-keyword">this</span>.dataSection.itemsCount = <span class="hljs-number">95</span>;</li><li>      <span class="hljs-keyword">this</span>.dataSection.crossCount = <span class="hljs-number">2</span>;</li><li>      <span class="hljs-keyword">this</span>.sections.update(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.oneColumnSection);</li><li>      <span class="hljs-keyword">this</span>.sections.update(<span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.twoColumnSection);</li><li>      <span class="hljs-keyword">this</span>.sections.update(<span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.dataSection);</li><li>      <span class="hljs-keyword">this</span>.isRefreshing = <span class="hljs-literal">false</span>;</li><li>    }, <span class="hljs-number">2000</span>);</li><li>  }</li><li>
</li><li>  loadMore(last: number): void {</li><li>    setTimeout(() =&gt; {</li><li>      let totalCount: number = <span class="hljs-keyword">this</span>.dataSource.totalCount();</li><li>      <span class="hljs-keyword">if</span> (last + <span class="hljs-number">20</span> &gt;= totalCount) {</li><li>        <span class="hljs-keyword">for</span> (let i: number = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">20</span>; i++) {</li><li>          <span class="hljs-keyword">this</span>.dataSource.addLastItem();</li><li>        }</li><li>        <span class="hljs-comment">// Update sections itemsCount.</span></li><li>        <span class="hljs-keyword">this</span>.dataSection.itemsCount += <span class="hljs-number">20</span>;</li><li>        <span class="hljs-keyword">this</span>.sections.update(<span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.dataSection);</li><li>      }</li><li>    }, <span class="hljs-number">1000</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  build() {</li><li>    Column({ space: <span class="hljs-number">0</span> }) {</li><li>      Row() {</li><li>        Text($r(<span class="hljs-string">'app.string.pull_down_refresh'</span>))</li><li>          .width(<span class="hljs-string">'100%'</span>)</li><li>          .fontSize(<span class="hljs-number">24</span>)</li><li>          .fontWeight(FontWeight.Bold)</li><li>          .margin({ top: <span class="hljs-string">'18vp'</span>, left: <span class="hljs-string">'16vp'</span>, bottom: <span class="hljs-string">'8vp'</span> })</li><li>      }</li><li>
</li><li>      <span class="hljs-comment">// 2、Pull-to-refresh control.</span></li><li>      Refresh({ refreshing: $$<span class="hljs-keyword">this</span>.isRefreshing, builder: <span class="hljs-keyword">this</span>.headerRefresh() }) {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// For better experience, pre load data.</span></li><li>        .onScrollIndex((first: number, last: number) =&gt; {</li><li>          <span class="hljs-keyword">this</span>.loadMore(last);</li><li>        })</li><li>      }</li><li>      <span class="hljs-comment">// 3、Pull down to refresh offset.</span></li><li>      .refreshOffset(<span class="hljs-number">56</span>)</li><li>      .onRefreshing(() =&gt; {</li><li>        <span class="hljs-comment">// 4、Pull down to refresh, triggering the refresh callback function.</span></li><li>        <span class="hljs-keyword">this</span>.refresh();</li><li>      })</li><li>    }</li><li>    .padding({</li><li>      top: <span class="hljs-keyword">this</span>.statusBarHeight</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/DataUpdateAndAnimationPage.ets#L17-L319" target="_blank">DataUpdateAndAnimationPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section143235431159"><strong>上拉加载</strong><i class="anchor-icon anchor-icon-link" anchorid="section143235431159" tips="复制节点链接"></i></h3><p>WaterFlow实现加载更多功能，通常采用onReachEnd回调（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onreachend" target="_blank">onReachEnd</a>）或onScrollIndex回调（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onscrollindex11" target="_blank">onScrollIndex</a>）来实现。</p> <ol><li>在onReachEnd加载数据时，应用会在数据源中的所有数据渲染完成后加载新数据，这会导致明显的加载动画出现，用户需等待新数据加载完毕后才能继续浏览瀑布流。</li><li>相比onReachEnd方式，onScrollIndex回调可以在用户滑动到接近底部时预加载数据，实现无缝浏览体验。例如，当前可视区最后一个组件的索引加上20等于数据源总量时，才开始加载数据，这能避免每次索引变化时均加载数据。建议在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onscrollindex11" target="_blank">onScrollIndex</a>回调中执行此操作，使瀑布流在未触底前即开始加载数据，进而提高用户体验，确保用户几乎不察觉数据加载过程。<div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/DataLoadMorePage.ets#L17-L307" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.PerformanceAnalysisKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/CommonConstants"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">SectionsWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'DataLoadMorePage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">DataLoadMorePage</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">WaterFlowSections</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">WaterFlowSections</span>();</li><li>  <span class="hljs-variable">dataSource</span>: <span class="hljs-title class_">SectionsWaterFlowDataSource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SectionsWaterFlowDataSource</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">0</span> }) {</li><li>      <span class="hljs-title function_">Refresh</span>({ <span class="hljs-variable">refreshing</span>: $$<span class="hljs-keyword">this</span>.<span class="hljs-title class_">isRefreshing</span>, <span class="hljs-variable">builder</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">headerRefresh</span>() }) {</li><li>        <span class="hljs-title function_">WaterFlow</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> }) {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">12</span>)</li><li>        .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">8</span>)</li><li>        .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">8</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>        <span class="hljs-comment">// For better experience, pre load data.</span></li><li>        .<span class="hljs-title function_">onScrollIndex</span>((<span class="hljs-variable">first</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">last</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-comment">// 1、Obtain the total amount of data in the waterfall flow.</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">totalCount</span>: <span class="hljs-title class_">number</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>.<span class="hljs-title function_">totalCount</span>();</li><li>          <span class="hljs-comment">// 2、If the index of the last visible area is greater than the total amount of data, it triggers loading more.</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">last</span> + <span class="hljs-number">20</span> &gt;= <span class="hljs-variable">totalCount</span>) {</li><li>            <span class="hljs-comment">// 3、Re-add 20 data entries to the waterfall.</span></li><li>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">20</span>; <span class="hljs-title class_">i</span>++) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>.<span class="hljs-title function_">addLastItem</span>();</li><li>            }</li><li>            <span class="hljs-comment">// 4、Update the itemsCount in the group and refresh the group information.</span></li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSection</span>.<span class="hljs-variable">itemsCount</span> += <span class="hljs-number">20</span>;</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">sections</span>.<span class="hljs-title function_">update</span>(<span class="hljs-number">2</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSection</span>);</li><li>          }</li><li>        })</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">statusBarHeight</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/DataLoadMorePage.ets#L17-L307" target="_blank">DataLoadMorePage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section182994559158"><strong>增删数据项</strong><i class="anchor-icon anchor-icon-link" anchorid="section182994559158" tips="复制节点链接"></i></h3><p>在使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#sections12" target="_blank">WaterFlowSections</a>对WaterFlow中的子元素进行分组的场景下，若需删除WaterFlow中的数据，不仅需从数据源中删除数据，还需更新对应section的itemsCount数量，并执行sections.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#update12" target="_blank">update()</a>操作。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemRemovePage.ets#L17-L302" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">hilog</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.PerformanceAnalysisKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">SectionsWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'FlowItemRemovePage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">FlowItemRemovePage</span> {</li><li>  <span class="hljs-comment">// 1、Select the index of the FlowItem.</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">currentItem</span>: <span class="hljs-title class_">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">removeItem</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// 5、Delete source data.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>.<span class="hljs-title function_">indexOf</span>(<span class="hljs-variable">item</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>.<span class="hljs-title function_">deleteItem</span>(<span class="hljs-variable">index</span>);</li><li>    <span class="hljs-comment">// 6、Update the itemsCount quantity in the group and refresh.</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">sections</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">SectionOptions</span>&gt; = <span class="hljs-keyword">this</span>.<span class="hljs-variable">sections</span>.<span class="hljs-title function_">values</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">newSection</span>: <span class="hljs-title class_">SectionOptions</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tmpIndex</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sectionIndex</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">sections</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-variable">tmpIndex</span> += <span class="hljs-variable">sections</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">itemsCount</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> &lt; <span class="hljs-title class_">tmpIndex</span>) {</li><li>        <span class="hljs-variable">sectionIndex</span> = <span class="hljs-variable">i</span>;</li><li>        <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>    <span class="hljs-variable">newSection</span> = <span class="hljs-variable">sections</span>[<span class="hljs-variable">sectionIndex</span>];</li><li>    <span class="hljs-variable">newSection</span>.<span class="hljs-variable">itemsCount</span> -= <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">newSection</span>.<span class="hljs-variable">crossCount</span> &amp;&amp; <span class="hljs-variable">newSection</span>.<span class="hljs-variable">crossCount</span> &gt; <span class="hljs-variable">newSection</span>.<span class="hljs-variable">itemsCount</span>) {</li><li>      <span class="hljs-variable">newSection</span>.<span class="hljs-variable">crossCount</span> = <span class="hljs-variable">newSection</span>.<span class="hljs-variable">itemsCount</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">sections</span>.<span class="hljs-title function_">update</span>(<span class="hljs-variable">sectionIndex</span>, <span class="hljs-variable">newSection</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">0</span> }) {</li><li>      <span class="hljs-title function_">Refresh</span>({ <span class="hljs-variable">refreshing</span>: $$<span class="hljs-keyword">this</span>.<span class="hljs-title class_">isRefreshing</span>, <span class="hljs-variable">builder</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">headerRefresh</span>() }) {</li><li>        <span class="hljs-title function_">WaterFlow</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> }) {</li><li>          <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>            <span class="hljs-title function_">FlowItem</span>() {</li><li>              <span class="hljs-title function_">Stack</span>() {</li><li>                <span class="hljs-comment">// 3、Delete button.</span></li><li>                <span class="hljs-title function_">Row</span>() {</li><li>                  <span class="hljs-title function_">Button</span>(<span class="hljs-string">'Delete'</span>)</li><li>                    .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>)</li><li>                    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>                    .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>                      <span class="hljs-keyword">try</span> {</li><li>                        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-variable">duration</span>: <span class="hljs-number">300</span> }, () =&gt; {</li><li>                          <span class="hljs-comment">// 4、Trigger delete operation.</span></li><li>                          <span class="hljs-keyword">this</span>.<span class="hljs-title function_">removeItem</span>(<span class="hljs-variable">item</span>);</li><li>                        });</li><li>                      } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>                        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">animateTo</span> <span class="hljs-variable">get</span> <span class="hljs-variable">exception</span>, <span class="hljs-variable">error</span>:${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}.`);</li><li>                      }</li><li>                    })</li><li>                }</li><li>                .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>                .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>                .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>                .<span class="hljs-title function_">zIndex</span>(<span class="hljs-number">1</span>)</li><li>                .<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentItem</span> === <span class="hljs-variable">item</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">Hidden</span>)</li><li>                .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#33000000'</span>)</li><li>
</li><li>                <span class="hljs-title function_">ReusableFlowItem</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> })</li><li>              }</li><li>            }</li><li>            .<span class="hljs-title function_">transition</span>({ <span class="hljs-keyword">type</span>: <span class="hljs-title class_">TransitionType</span>.<span class="hljs-title class_">Delete</span>, <span class="hljs-variable">opacity</span>: <span class="hljs-number">0</span> })</li><li>            <span class="hljs-comment">// 2、FlowItem's long press event</span></li><li>            .<span class="hljs-title function_">priorityGesture</span>(<span class="hljs-title function_">LongPressGesture</span>()</li><li>              .<span class="hljs-title function_">onAction</span>(() =&gt; {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">currentItem</span> = <span class="hljs-variable">item</span>;</li><li>              }))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Gray</span>)</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">item</span>)</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemRemovePage.ets#L17-L302" target="_blank">FlowItemRemovePage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section8332244132210">瀑布流动效<i class="anchor-icon anchor-icon-link" anchorid="section8332244132210" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section760318598812" class="firsth2">删除滑动错位<i class="anchor-icon anchor-icon-link" anchorid="section760318598812" tips="复制节点链接"></i></h3></div> <p>在某些场景，开发者可能想要删除WaterFlow中的数据后，并且界面还需要显示动画效果，效果图如下：</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.24638141496906914859713682351939:50001231000000:2800:DF46B9F20DA389D2B18F55C27BF44F7D4D4F2032E091FE07DA16D2D760B8D7E3.gif" title="点击放大" width="266"></span></p> <p>为了实现上图的效果，可通过配置FlowItem的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-transition-animation-component" target="_blank">transition()</a>属性并添加转场参数，使组件在插入和删除时显示过渡动画。同时，在删除时添加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-explicit-animation" target="_blank">animateTo</a>动画效果即可。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemRemoveAnimationPage.ets#L17-L308" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.PerformanceAnalysisKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../common/constants/CommonConstants"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">SectionsWaterFlowDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"../model/SectionsWaterFlowDataSource"</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'FlowItemRemoveAnimationPage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">FlowItemRemoveAnimationPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">0</span> }) {</li><li>      <span class="hljs-title class_">Refresh</span>({ <span class="hljs-attr">refreshing</span>: $$this.<span class="hljs-property">isRefreshing</span>, <span class="hljs-attr">builder</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">headerRefresh</span>() }) {</li><li>        <span class="hljs-title class_">WaterFlow</span>({ <span class="hljs-attr">scroller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span>, <span class="hljs-attr">sections</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sections</span> }) {</li><li>          <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">FlowItem</span>() {</li><li>              <span class="hljs-title class_">Stack</span>() {</li><li>                <span class="hljs-title class_">Row</span>() {</li><li>                  <span class="hljs-title class_">Button</span>($r(<span class="hljs-string">'app.string.delete'</span>))</li><li>                    .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)</li><li>                    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>                    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                      <span class="hljs-comment">// 2、Execute the animateTo animation when triggering the delete operation.</span></li><li>                      <span class="hljs-keyword">try</span> {</li><li>                        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-function">() =&gt;</span> {</li><li>                          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeItem</span>(item);</li><li>                        });</li><li>                      } <span class="hljs-keyword">catch</span> (err) {</li><li>                        hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`animateTo get exception, error:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>.`</span>);</li><li>                      }</li><li>                    })</li><li>                }</li><li>                <span class="hljs-comment">// ...</span></li><li>              }</li><li>            }</li><li>            <span class="hljs-comment">// 1、Add a transition property to FlowItem and configure the transition parameters.</span></li><li>            .<span class="hljs-title function_">transition</span>({ <span class="hljs-attr">type</span>: <span class="hljs-title class_">TransitionType</span>.<span class="hljs-property">Delete</span>, <span class="hljs-attr">opacity</span>: <span class="hljs-number">0</span> })</li><li>            .<span class="hljs-title function_">priorityGesture</span>(<span class="hljs-title class_">LongPressGesture</span>()</li><li>              .<span class="hljs-title function_">onAction</span>(<span class="hljs-function">() =&gt;</span> {</li><li>                <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentItem</span> = item;</li><li>              }))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Gray</span>)</li><li>          }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> item)</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusBarHeight</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/FlowItemRemoveAnimationPage.ets#L17-L308" target="_blank">FlowItemRemoveAnimationPage.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section191322361287">边缘渐隐<i class="anchor-icon anchor-icon-link" anchorid="section191322361287" tips="复制节点链接"></i></h3></div> <p>在某些开发场景中，开发者可能需要瀑布流边缘具有渐隐效果，如下图所示：</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.89495308882922714144304619345145:50001231000000:2800:DDDF298EBAE72CA54F9DDD67FF177268DE57FCC1C45F50B96537EECAF3F0A3AC.gif" title="点击放大" width="266"></span></p> <p>该效果可通过WaterFlow组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scrollable-common#fadingedge14" target="_blank">fadingEdge</a>实现，并通过fadingEdgeLength参数设置边缘渐隐长度。具体代码参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#示例5设置边缘渐隐效果" target="_blank">设置边缘渐隐效果</a> 。</p> <div class="tiledSection"><h2 id="section3929101903017">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section3929101903017" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6244611316" class="firsth2"><strong>场景描述</strong><i class="anchor-icon anchor-icon-link" anchorid="section6244611316" tips="复制节点链接"></i></h3><p>本案例集成了下拉刷新、预加载、删除错位滑动、滑动吸顶、自动播放等功能，应用于分组混排场景与滑动吸顶场景中。通过上述两场景的开发，可以使开发者更深入地理解WaterFlow在实际应用中的使用方式。</p> </div> <div class="tiledSection"><h3 id="section03514276138"><strong>关键技术</strong><i class="anchor-icon anchor-icon-link" anchorid="section03514276138" tips="复制节点链接"></i></h3><ol><li>实现瀑布流分组混排<p>通过创建多个SectionOptions，不同SectionOptions设置不同的宽度和高度，以实现分组混排效果。具体实现参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-operations#section154611537122218">瀑布流排版</a>。</p> </li><li>实现下拉刷新/上拉加载更多<p>通过Refresh组件和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#onscrollindex11" target="_blank">onScrollIndex()</a>方法实现下拉刷新与上拉加载更多功能。具体实现参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-operations#section193081340162215">瀑布流数据更新</a>。</p> </li><li>实现长按删除FlowItem<p>通过长按显示删除按钮，执行删除操作时，不仅需删除源数据，还须更新section对应的itemsCount数量，确保分组数据与数据源数据同步。具体实现参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-operations#section8332244132210">瀑布流动效</a>。</p> </li><li>实现瀑布流吸顶效果<p>通过WaterFlow的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scrollable-common#onwillscroll12" target="_blank">onWillScroll()</a>方法和position属性设置最大滑动偏移量，以实现滑动吸顶效果。具体参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-operations#section154611537122218">瀑布流排版</a>。</p> </li><li>实现FlowItem自动播放效果<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-component-visible-area-change-event#onvisibleareachange" target="_blank">onVisibleAreaChange()</a>方法检测组件显示状态，控制FlowItem中视频的播放或暂停。具体参考<a href="/consumer/cn/doc/best-practices/bpta-waterflow-operations#section119347413579">瀑布流滑动</a>。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section12849103511137"><strong>实现效果</strong><i class="anchor-icon anchor-icon-link" anchorid="section12849103511137" tips="复制节点链接"></i></h3><p>最终效果如下图：</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.80277545267172179725893136044930:50001231000000:2800:3570F05330E47BF18A1EEDC26917B641F1281F0F3324E78F5F2A03384B5F1C07.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h2 id="section93501432171517">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section93501432171517" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section181970230109" class="firsth2"><strong>如何将多个FlowItem强制显示到左上角位置，如下图所示</strong>：<i class="anchor-icon anchor-icon-link" anchorid="section181970230109" tips="复制节点链接"></i></h3><p><span><img height="549.556" originheight="657" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.80788266905811459327028473246307:50001231000000:2800:8887CE265FB0C3D76ABD76D03111EB792C5DB716027DCE488020F12E2CED3CBB.png" title="点击放大" width="266"></span></p> <p>通过在WaterFlow根节点添加FlowItem，将需要显示在左上角的元素放在此FlowItem内部即可，完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/ForceShowOnTopLeftPage.ets#L17-L91" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/constants/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">MyDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/MyDataSource'</span></li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ForceShowOnTopLeftPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>({ <span class="hljs-attr">space</span>: <span class="hljs-number">0</span> }) {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.force_left_show'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-string">'18vp'</span>, <span class="hljs-attr">left</span>: <span class="hljs-string">'16vp'</span>, <span class="hljs-attr">bottom</span>: <span class="hljs-string">'16vp'</span> })</li><li>      }</li><li>
</li><li>      <span class="hljs-title class_">WaterFlow</span>() {</li><li>        <span class="hljs-comment">// 1、Add the layout content in the top left corner of WaterFlow.</span></li><li>        <span class="hljs-title class_">FlowItem</span>() {</li><li>          <span class="hljs-title class_">Column</span>() {</li><li>            <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">getTopMastData</span>(<span class="hljs-number">5</span>), <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Top Hello <span class="hljs-subst">${item}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">22</span>)</li><li>            })</li><li>          }</li><li>          .<span class="hljs-title function_">margin</span>({</li><li>            <span class="hljs-attr">top</span>: <span class="hljs-number">4</span>,</li><li>            <span class="hljs-attr">bottom</span>: <span class="hljs-number">4</span></li><li>          })</li><li>        }</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">alignSelf</span>(<span class="hljs-title class_">ItemAlign</span>.<span class="hljs-property">End</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>
</li><li>        <span class="hljs-comment">// 2、Add WaterFlow data.</span></li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">FlowItem</span>() {</li><li>            <span class="hljs-title class_">Row</span>() {</li><li>              <span class="hljs-title class_">Text</span>(<span class="hljs-string">`Hello <span class="hljs-subst">${item}</span>`</span>).<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">20</span>)</li><li>            }</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-number">30</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">8</span>)</li><li>        }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">number</span></span>) =&gt;</span> item.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr'</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#efefef'</span>)</li><li>      .<span class="hljs-title function_">columnsGap</span>(<span class="hljs-number">10</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">margin</span>({</li><li>        <span class="hljs-attr">left</span>: <span class="hljs-string">'16vp'</span>,</li><li>        <span class="hljs-attr">right</span>: <span class="hljs-string">'16vp'</span></li><li>      })</li><li>    }</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#efefef'</span>)</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-attr">top</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">statusBarHeight</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/ForceShowOnTopLeftPage.ets#L17-L91" target="_blank">ForceShowOnTopLeftPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section19565105981015"><strong>如何实现双瀑布流衔接效果，如下图所示</strong>：<i class="anchor-icon anchor-icon-link" anchorid="section19565105981015" tips="复制节点链接"></i></h3><p><span><img height="549.556" originheight="657" originwidth="318" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162920.04356754757879016136923455494626:50001231000000:2800:E82DB4658BE3D06A7DA6089F7989382462BA983E17CF907BF93B9D4734F9FFA2.png" title="点击放大" width="266"></span></p> <p>通过WaterFlow的分组能力(SectionOptions)实现。在中间的FlowItem中预留位置显示 "分类信息" ，随后继续填充瀑布流数据。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/MergeDoubleWaterFlowPage.ets#L17-L141" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">CommonConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/constants/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">MyDataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/MyDataSource'</span></li><li>
</li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MergeDoubleWaterFlowPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.merge_double_waterflow'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-variable">FontWeight</span>.<span class="hljs-variable">Bold</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-string">'18vp'</span>, <span class="hljs-variable">left</span>: <span class="hljs-string">'16vp'</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-string">'12vp'</span> })</li><li>      }</li><li>
</li><li>      <span class="hljs-title function_">WaterFlow</span>({ <span class="hljs-variable">scroller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">scroller</span>, <span class="hljs-variable">sections</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sections</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">data</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>          <span class="hljs-title function_">FlowItem</span>() {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">item</span> === <span class="hljs-number">21</span>) {</li><li>              <span class="hljs-comment">// 1、This is the content for stitching the item.</span></li><li>              <span class="hljs-title function_">Column</span>() {</li><li>                <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.recommend_goods'</span>))</li><li>                  .<span class="hljs-title function_">align</span>(<span class="hljs-variable">Alignment</span>.<span class="hljs-variable">Center</span>)</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                  .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">16</span>, <span class="hljs-variable">top</span>: <span class="hljs-number">24</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-number">24</span> })</li><li>                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">24</span>)</li><li>                  .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-variable">FontWeight</span>.<span class="hljs-variable">Bold</span>)</li><li>              }</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// 2、Other data within WaterFlow.</span></li><li>              <span class="hljs-title function_">Column</span>() {</li><li>                <span class="hljs-title function_">Text</span>(<span class="hljs-string">'N '</span> + <span class="hljs-variable">item</span>)</li><li>                  .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">12</span>)</li><li>                  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'16vp'</span>)</li><li>                <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">rawfile</span>(`<span class="hljs-variable">sections</span>/${<span class="hljs-variable">item</span> % <span class="hljs-number">4</span>}.<span class="hljs-variable">jpg</span>`))</li><li>                  .<span class="hljs-title function_">objectFit</span>(<span class="hljs-variable">ImageFit</span>.<span class="hljs-variable">Cover</span>)</li><li>                  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>                  .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>              }</li><li>            }</li><li>          }</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">10</span>)</li><li>      .<span class="hljs-title function_">rowsGap</span>(<span class="hljs-number">5</span>)</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#efefef'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">padding</span>({</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">statusBarHeight</span></li><li>    })</li><li>    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#efefef'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/MergeDoubleWaterFlowPage.ets#L17-L141" target="_blank">MergeDoubleWaterFlowPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section12998153515118"><strong>如何实现双指缩放动态改变瀑布流列数</strong>，如下图所示：<i class="anchor-icon anchor-icon-link" anchorid="section12998153515118" tips="复制节点链接"></i></h3><p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162921.22130873228824890120027172394277:50001231000000:2800:DD982F14DE9936FB6B7143CC1B685EA1DF83C21DF6F15826675E67577F108A0F.gif" title="点击放大" width="266"></span></p> <p>通过监听用户捏合手势并配合缩放比例进行动态控制瀑布流列数。完整代码如下：</p> <div class="screenLinkPre"><div _ngcontent-tku-c106="" class="highlight-div"><div _ngcontent-tku-c106="" class="highlight-div-header"><div _ngcontent-tku-c106="" class="highlight-div-header-left"><div _ngcontent-tku-c106="" class="handle-button expand-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tku-c106="" class="highlight-div-header-right"><div _ngcontent-tku-c106="" class="handle-button ai-button"></div><div _ngcontent-tku-c106="" class="handle-button line-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tku-c106="" class="handle-button theme-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tku-c106="" class="handle-button copy-button"><div _ngcontent-tku-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tku-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/ZoomChangeColumnPage.ets#L17-L226" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } from <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { image } from <span class="hljs-string">'@kit.ImageKit'</span>;</li><li><span class="hljs-keyword">import</span> { CommonConstants } from <span class="hljs-string">'../common/constants/CommonConstants'</span>;</li><li><span class="hljs-keyword">import</span> { MyDataSource } from <span class="hljs-string">'../model/MyDataSource'</span></li><li>
</li><li><span class="hljs-keyword">const</span> TAG: string = <span class="hljs-string">'StickOnTopPage'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct ZoomChangeColumnPage {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// 1、Variables required for scaling operations.</span></li><li>  <span class="hljs-meta">@State</span> itemScale: number = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> imageScale: number = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> itemOpacity: number = <span class="hljs-number">1</span>;</li><li>  <span class="hljs-meta">@State</span> gestureEnd: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> pixelMap: image.PixelMap | undefined = undefined;</li><li>  <span class="hljs-meta">@State</span> columns: number = <span class="hljs-number">4</span>;</li><li>  <span class="hljs-meta">@StorageProp(CommonConstants.AS_KEY_STATUS_BAR_HEIGHT)</span> statusBarHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> pinchTime: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> columnChanged: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> oldColumn: number = <span class="hljs-keyword">this</span>.columns;</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// 7、Adjust the number of columns according to the zoom ratio.</span></li><li>  changeColumns(scale: number): void {</li><li>    <span class="hljs-keyword">this</span>.oldColumn = <span class="hljs-keyword">this</span>.columns;</li><li>    <span class="hljs-keyword">if</span> (scale &gt; (<span class="hljs-keyword">this</span>.columns / (<span class="hljs-keyword">this</span>.columns - <span class="hljs-number">0.5</span>))) {</li><li>      <span class="hljs-keyword">this</span>.columns--;</li><li>      <span class="hljs-keyword">this</span>.columnChanged = <span class="hljs-literal">true</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (scale &lt; <span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">this</span>.columns &lt; <span class="hljs-number">4</span>) {</li><li>      <span class="hljs-keyword">this</span>.columns++;</li><li>      <span class="hljs-keyword">this</span>.columnChanged = <span class="hljs-literal">true</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.columns = Math.min(<span class="hljs-number">4</span>, Math.max(<span class="hljs-number">1</span>, <span class="hljs-keyword">this</span>.columns));</li><li>  }</li><li>
</li><li>  build() {</li><li>    Column({ space: <span class="hljs-number">2</span> }) {</li><li>      <span class="hljs-comment">// ...</span></li><li>      Stack() {</li><li>        <span class="hljs-comment">// 2、Display the current screen's snapshot when zooming.</span></li><li>        Image(<span class="hljs-keyword">this</span>.pixelMap)</li><li>          .width(<span class="hljs-string">'100%'</span>)</li><li>          .height(<span class="hljs-string">'100%'</span>)</li><li>          .scale({</li><li>            x: <span class="hljs-keyword">this</span>.imageScale,</li><li>            y: <span class="hljs-keyword">this</span>.imageScale,</li><li>            centerX: <span class="hljs-number">0</span>,</li><li>            centerY: <span class="hljs-number">0</span></li><li>          })</li><li>        WaterFlow() {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        .id(<span class="hljs-string">'waterflow'</span>)</li><li>        <span class="hljs-comment">// 3、Dynamic adjustment of column numbers.</span></li><li>        .columnsTemplate(<span class="hljs-string">'1fr '</span>.repeat(<span class="hljs-keyword">this</span>.columns))</li><li>        .backgroundColor(<span class="hljs-number">0xFAEEE0</span>)</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .height(<span class="hljs-string">'100%'</span>)</li><li>        .layoutWeight(<span class="hljs-number">1</span>)</li><li>        <span class="hljs-comment">// 4、WaterFlow's scaling information.</span></li><li>        .opacity(<span class="hljs-keyword">this</span>.itemOpacity)</li><li>        .scale({</li><li>          x: <span class="hljs-keyword">this</span>.itemScale,</li><li>          y: <span class="hljs-keyword">this</span>.itemScale,</li><li>          centerX: <span class="hljs-number">0</span>,</li><li>          centerY: <span class="hljs-number">0</span></li><li>        })</li><li>        .priorityGesture(</li><li>          PinchGesture()</li><li>            .onActionStart((event: GestureEvent) =&gt; {</li><li>              <span class="hljs-comment">// 5、Initialise scaling parameters.</span></li><li>              <span class="hljs-keyword">this</span>.gestureEnd = <span class="hljs-literal">false</span>;</li><li>              <span class="hljs-keyword">this</span>.pinchTime = event.timestamp;</li><li>              <span class="hljs-keyword">this</span>.columnChanged = <span class="hljs-literal">false</span>;</li><li>              <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(<span class="hljs-string">'waterflow'</span>, (error: Error, pixelMap: image.PixelMap) =&gt; {</li><li>                <span class="hljs-keyword">if</span> (error) {</li><li>                  console.info(<span class="hljs-string">'error: '</span> + error.message);</li><li>                  <span class="hljs-keyword">return</span>;</li><li>                }</li><li>                <span class="hljs-keyword">this</span>.pixelMap = pixelMap;</li><li>              })</li><li>            })</li><li>            .onActionUpdate((event: GestureEvent) =&gt; {</li><li>              <span class="hljs-comment">// 6、Calculate the zoom ratio based on the finger swipe event and dynamically change the number of columns.</span></li><li>              <span class="hljs-comment">// 6.1、Intercept duplicate gestures.</span></li><li>              <span class="hljs-keyword">if</span> (event.timestamp - <span class="hljs-keyword">this</span>.pinchTime &lt; <span class="hljs-number">10000000</span>) {</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>              <span class="hljs-keyword">this</span>.pinchTime = event.timestamp;</li><li>              <span class="hljs-comment">// 6.2、Calculate the scaling ratio.</span></li><li>              let maxScale: number = <span class="hljs-keyword">this</span>.oldColumn / (<span class="hljs-keyword">this</span>.oldColumn - <span class="hljs-number">1</span>);</li><li>              <span class="hljs-keyword">this</span>.itemScale = event.scale &gt; maxScale ? maxScale : event.scale;</li><li>              <span class="hljs-keyword">this</span>.imageScale = event.scale &gt; maxScale ? maxScale : event.scale;</li><li>              <span class="hljs-keyword">this</span>.itemOpacity = (<span class="hljs-keyword">this</span>.itemScale &gt; <span class="hljs-number">1</span>) ? (<span class="hljs-keyword">this</span>.itemScale - <span class="hljs-number">1</span>) : (<span class="hljs-number">1</span> - <span class="hljs-keyword">this</span>.itemScale);</li><li>              <span class="hljs-keyword">this</span>.itemOpacity *= <span class="hljs-number">3</span>;</li><li>              <span class="hljs-comment">// 6.3、Dynamically adjust the number of columns.</span></li><li>              <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.columnChanged) {</li><li>                <span class="hljs-keyword">this</span>.changeColumns(event.scale);</li><li>              }</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.columnChanged) {</li><li>                <span class="hljs-keyword">this</span>.itemScale = <span class="hljs-keyword">this</span>.imageScale * <span class="hljs-keyword">this</span>.columns / <span class="hljs-keyword">this</span>.oldColumn;</li><li>                <span class="hljs-keyword">if</span> (event.scale &lt; <span class="hljs-number">1</span>) {</li><li>                  <span class="hljs-keyword">this</span>.itemScale = <span class="hljs-keyword">this</span>.itemScale &gt; <span class="hljs-number">1</span> ? <span class="hljs-keyword">this</span>.itemScale : <span class="hljs-number">1</span>;</li><li>                } <span class="hljs-keyword">else</span> {</li><li>                  <span class="hljs-keyword">this</span>.itemScale = <span class="hljs-keyword">this</span>.itemScale &lt; <span class="hljs-number">1</span> ? <span class="hljs-keyword">this</span>.itemScale : <span class="hljs-number">1</span>;</li><li>                }</li><li>              }</li><li>            })</li><li>            .onActionEnd((event: GestureEvent) =&gt; {</li><li>              <span class="hljs-comment">// 8、Reset the relevant scaling parameters and execute the scaling animation.</span></li><li>              <span class="hljs-keyword">this</span>.gestureEnd = <span class="hljs-literal">true</span>;</li><li>              <span class="hljs-keyword">try</span> {</li><li>                <span class="hljs-keyword">this</span>.getUIContext().animateTo({ duration: <span class="hljs-number">300</span> }, () =&gt; {</li><li>                  <span class="hljs-keyword">this</span>.itemScale = <span class="hljs-number">1</span>;</li><li>                  <span class="hljs-keyword">this</span>.itemOpacity = <span class="hljs-number">1</span>;</li><li>                });</li><li>              } <span class="hljs-keyword">catch</span> (err) {</li><li>                hilog.error(<span class="hljs-number">0x0000</span>, TAG, `animateTo <span class="hljs-keyword">get</span> exception, error:${JSON.stringify(err)}.`);</li><li>              }</li><li>              AppStorage.setOrCreate&lt;number&gt;(<span class="hljs-string">'columnsCount'</span>, <span class="hljs-keyword">this</span>.columns);</li><li>            })</li><li>        )</li><li>      }</li><li>      .width(<span class="hljs-string">'100%'</span>)</li><li>      .height(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .padding({</li><li>      top: <span class="hljs-keyword">this</span>.statusBarHeight</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/WaterFlowSample/entry/src/main/ets/pages/ZoomChangeColumnPage.ets#L17-L226" target="_blank">ZoomChangeColumnPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1667296690">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1667296690" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/water-flow" target="_blank">WaterFlow瀑布流实例</a></li></ul> </div> </div></div>