<h1 _ngcontent-qwk-c119="" class="doc-title ng-star-inserted" title="应用代码混淆"> 应用代码混淆 </h1>

<div _ngcontent-qwk-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section19566162415210">概述<i class="anchor-icon anchor-icon-link" anchorid="section19566162415210" tips="复制节点链接"></i></h2><p>代码混淆技术可以增加代码的复杂性和模糊性，从而提高攻击者分析代码的难度。代码混淆有以下几个方面的作用：</p> <ol><li>保护知识产权：代码混淆防止他人轻易复制和窃取软件代码，增加逆向工程难度。</li><li>防止逆向工程：逆向工程是分析软件以了解其工作原理和实现细节的过程。代码混淆可增加逆向工程的难度，保护应用程序免受恶意修改或破坏。</li><li>提高安全性：代码混淆减少漏洞和安全风险，增加攻击者利用漏洞的难度。</li><li>降低反盗版和欺诈风险：混淆代码可增加攻击者破解软件许可验证系统或修改代码绕过付费机制的难度，从而减少盗版和欺诈。</li></ol> <p>针对工程源码的混淆提高破解难度，缩短类和成员名称，减小应用大小。</p> </div> <div class="tiledSection"><h2 id="section13780943192313">混淆开启<i class="anchor-icon anchor-icon-link" anchorid="section13780943192313" tips="复制节点链接"></i></h2><p>从DevEco Studio版本4.0 Beta1开始，hvigor插件提供代码混淆功能。开启混淆的条件如下：</p> <ul><li>工程为Stage模型</li><li>在Release编译模式下</li><li>模块build-profile.json5文件中开启混淆配置<div class="screenLinkPre"><div _ngcontent-qwk-c106="" class="highlight-div"><div _ngcontent-qwk-c106="" class="highlight-div-header"><div _ngcontent-qwk-c106="" class="highlight-div-header-left"><div _ngcontent-qwk-c106="" class="handle-button expand-button"><div _ngcontent-qwk-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qwk-c106="" class="highlight-div-header-right"><div _ngcontent-qwk-c106="" class="handle-button ai-button"></div><div _ngcontent-qwk-c106="" class="handle-button line-button"><div _ngcontent-qwk-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qwk-c106="" class="handle-button theme-button"><div _ngcontent-qwk-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qwk-c106="" class="handle-button copy-button"><div _ngcontent-qwk-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qwk-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/Privacy/privacy/build-profile.json5#L12-L23" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"arkOptions"</span>: {</li><li>  <span class="hljs-string">"obfuscation"</span>: {</li><li>    <span class="hljs-string">"ruleOptions"</span>: {</li><li>      <span class="hljs-string">"enable"</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>},</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/Privacy/privacy/build-profile.json5#L12-L23" target="_blank">build-profile.json5</a></div></div></div></div> </li></ul> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>enable默认为false，默认不开启代码混淆功能。</p> </div></div></div> <p>满足开启混淆的条件后，选择目标模块，点击Build -&gt; Make Module开始编译。</p> <p>如果工程或模块是Static Library，则该工程或模块是一个HAR。</p> <p>构建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hvigor-build-har#section16598338112415" target="_blank">字节码HAR</a>时有以下三种方式：</p> <ol><li>以Debug模式构建HAR，会直接打包源码，不进行代码混淆。</li><li>以Release模式构建HAR，会编译、混淆并压缩代码。</li><li>构建字节码格式的HAR。开启混淆时，编译器会先对源码中间文件进行混淆，再生成abc字节码。</li></ol> <div class="fignone"><span class="figcap"><b>图1 </b>DevEco Studio选择release编译模式</span></div> <p><span><img height="386.0325" originheight="407" originwidth="552" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.45466169864399803873446951408951:50001231000000:2800:E97E7C362DCC83082E23C405912148C66C8182CC49EC64224C18574306AD0EF4.png" title="点击放大" width="523.6875"></span></p> <div class="fignone"><span class="figcap"><b>图2 </b>DevEco Studio指定模块编译</span></div> <p><span><img height="251.35670000000002" originheight="621" originwidth="1299" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.26230541281109620475008613994134:50001231000000:2800:0BB99F79E6E063D2B76B1DDF484DA7B5F0168EB0678FEF549ABF18C01D9AC0CC.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h2 id="section6163038182420">混淆配置能力<i class="anchor-icon anchor-icon-link" anchorid="section6163038182420" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section12528195311241" class="firsth2">编译选项<i class="anchor-icon anchor-icon-link" anchorid="section12528195311241" tips="复制节点链接"></i></h3><p>若按照上述编译流程开启代码混淆，在DevEco Studio 5.0.3.600之前的版本，默认仅混淆参数名和局部变量名。从DevEco Studio 5.0.3.600版本起，默认启用四项推荐的混淆选项：-enable-property-obfuscation、-enable-toplevel-obfuscation、-enable-filename-obfuscation和-enable-export-obfuscation。开发者可以根据需要进一步修改混淆配置。</p> </div> <div class="tiledSection"><h3 id="section171089239254">混淆配置<i class="anchor-icon anchor-icon-link" anchorid="section171089239254" tips="复制节点链接"></i></h3><p>在每个模块下都能找到build-profile.json5文件，如下图所示。可以在此文件中配置是否开启混淆及混淆配置文件。</p> <div class="fignone"><span class="figcap"><b>图3 </b>编译配置文件</span><br><span><img height="243.39000000000001" originheight="471" originwidth="1010" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.14188345438266622809920186091879:50001231000000:2800:88D33A251FACEC0631D5AF52970BC351E20C4363DA53768B7673242B50C9E0E1.png" title="点击放大" width="523.6875"></span></div> <p>新建工程时，每个模块下都有obfuscation-rules.txt文件，用于配置混淆。</p> <div class="fignone"><span class="figcap"><b>图4 </b>混淆配置文件</span><br><span><img height="197.50500000000002" originheight="512" originwidth="1352" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.81994121752647531010218674491453:50001231000000:2800:65031828931217B1A062B780A24B712CD626EBD21DC86683A2251CE84985BD01.png" title="点击放大" width="523.6875"></span></div> <p>在上图中，obfuscation-rules.txt文件中添加了-enable-property-obfuscation和-enable-toplevel-obfuscation开关，表示已启用属性混淆和顶层作用域名称混淆。</p> <p>DevEco Studio混淆现有选项及功能描述如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="12%">&nbsp;&nbsp;</td> <td class="cellrowborder" valign="top" width="40%"><p>混淆自定义选项名称</p> </td> <td class="cellrowborder" valign="top" width="48%"><p>功能简述</p> </td> </tr> <tr><td class="cellrowborder" rowspan="10" valign="top" width="12%"><p>混淆选项</p> </td> <td class="cellrowborder" valign="top" width="40%"><p>-disable-obfuscation</p> </td> <td class="cellrowborder" valign="top" width="48%"><p>关闭混淆</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-enable-property-obfuscation</p> </td> <td class="cellrowborder" valign="top"><p>属性混淆</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-enable-toplevel-obfuscation</p> </td> <td class="cellrowborder" valign="top"><p>顶层作用域名称混淆</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-enable-filename-obfuscation</p> </td> <td class="cellrowborder" valign="top"><p>文件名混淆</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-enable-export-obfuscation</p> </td> <td class="cellrowborder" valign="top"><p>export导出名称与属性混淆</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-compact</p> </td> <td class="cellrowborder" valign="top"><p>代码压缩</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-remove-log</p> </td> <td class="cellrowborder" valign="top"><p>删除console.*方法</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-print-namecache filepath</p> </td> <td class="cellrowborder" valign="top"><p>指定路径输出namecache.json文件及内容</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-apply-namecache filepath</p> </td> <td class="cellrowborder" valign="top"><p>复用指定的名称缓存文件</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-remove-comments</p> </td> <td class="cellrowborder" valign="top"><p>删除注释</p> </td> </tr> <tr><td class="cellrowborder" rowspan="7" valign="top" width="12%"><p>保留选项</p> </td> <td class="cellrowborder" valign="top" width="40%"><p>-keep-property-name</p> </td> <td class="cellrowborder" valign="top" width="48%"><p>保留属性名</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-keep-global-name</p> </td> <td class="cellrowborder" valign="top"><p>保留顶层作用域和导出元素的名称</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-keep-file-name</p> </td> <td class="cellrowborder" valign="top"><p>保留指定的文件/文件夹的名称</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-keep-dts</p> </td> <td class="cellrowborder" valign="top"><p>读取指定.d.ts文件中的名称作为白名单</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-keep-comments</p> </td> <td class="cellrowborder" valign="top"><p>保留编译生成的声明文件中class, function, namespace, enum, struct, interface, module, type及属性上方的JsDoc注释</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>-keep</p> </td> <td class="cellrowborder" valign="top"><p>保留指定相对路径中的所有名称（例如变量名、类名、属性名等）</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>通配符</p> </td> <td class="cellrowborder" valign="top"><p>名称类和路径类的保留选项支持通配符</p> </td> </tr>  </tbody></table></div> </div> <p>混淆选项具体的使用方法和样例代码可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation" target="_blank">代码混淆</a>。</p> <p><strong>混淆优化建议</strong></p> <p>开发人员混淆工程时，发现缓存文件或SDK中的文件中存在大量未混淆的源码名称。原因包括以下两类：</p> <ul><li>- 混淆选项开启较少；开启-enable-property-obfuscation、-enable-toplevel-obfuscation、-enable-export-obfuscation、-enable-filename-obfuscation选项。</li><li>- 源码名称与系统白名单、语言白名单重名；添加后缀避开白名单。</li></ul> </div> <div class="tiledSection"><h3 id="section1842224516252">混淆规则合并策略<i class="anchor-icon anchor-icon-link" anchorid="section1842224516252" tips="复制节点链接"></i></h3><p>在编译一个模块时，生效的混淆规则是当前编译模块混淆规则和依赖模块混淆规则的合并结果。具体规则请参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation#混淆规则合并策略" target="_blank">混淆规则合并策略</a>。</p> </div> <div class="tiledSection"><h2 id="section910111762615">查看混淆结果<i class="anchor-icon anchor-icon-link" anchorid="section910111762615" tips="复制节点链接"></i></h2><p>开发人员在编译模块的build目录中可找到编译和混淆生成的缓存文件、名称映射表及系统API白名单文件。</p> <ul><li>源码编译及混淆缓存文件目录：build/[…]/release/模块名</li><li>混淆名称映射表及系统API白名单目录：build/[…]/release/obfuscation<ul><li>- 名称映射表文件：nameCache.json，记录源码名称映射。</li><li>- 系统API白名单文件：systemApiCache.json，记录SDK接口与属性名称。</li></ul> <div class="fignone"><span class="figcap"><b>图5 </b>DevEco Studio编译产物与缓存文件</span><br><span><img originheight="523" originwidth="464" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.74137244322305656940531527266000:50001231000000:2800:93E2A9B713B1D6EE7C4291BA32518E7AE658008EA8F547F2584272706D703261.png" width="464" height="523"></span></div> </li></ul> </div> <div class="tiledSection"><h2 id="section1594016439268">调试<i class="anchor-icon anchor-icon-link" anchorid="section1594016439268" tips="复制节点链接"></i></h2><p>代码经过混淆工具处理后，名称会发生更改，这可能导致运行时崩溃堆栈日志难以理解，因为堆栈与源代码不完全一致。如果未保留调试信息，行号及名称更改将导致无法准确定位问题。此外，启用-enable-property-obfuscation、-enable-toplevel-obfuscation等选项后，代码混淆可能会引发运行时崩溃或功能性错误。开发人员需要还原报错堆栈，排查并配置白名单以确保功能正常。</p> </div> <div class="tiledSection"><h3 id="section9148176122819" class="firsth2">函数调用栈还原<i class="anchor-icon anchor-icon-link" anchorid="section9148176122819" tips="复制节点链接"></i></h3><p>经过混淆的应用程序中代码名称会发生更改，因此报错栈与源码不完全一致，crash时打印的报错栈会难以理解，如何处理请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation-guide#报错栈还原" target="_blank">报错栈还原</a>。</p> </div> <div class="tiledSection"><h3 id="section14504105562813">反混淆工具hstack<i class="anchor-icon anchor-icon-link" anchorid="section14504105562813" tips="复制节点链接"></i></h3><p>hstack需要将Node.js配置到环境变量中，详细使用说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-command-line-hstack" target="_blank">堆栈解析工具（hstack）</a>。</p> </div> <div class="tiledSection"><h3 id="section16858193119291">常见报错案例<i class="anchor-icon anchor-icon-link" anchorid="section16858193119291" tips="复制节点链接"></i></h3><p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/source-obfuscation-questions" target="_blank">ArkGuard混淆常见问题</a>。</p> </div> <div class="tiledSection"><h2 id="section4564113173012">使用第三方加固<i class="anchor-icon anchor-icon-link" anchorid="section4564113173012" tips="复制节点链接"></i></h2><p>在HarmonyOS提供的代码混淆能力之外，开发者还可以使用第三方安全厂商提供的高级混淆和加固能力。多家安全加固厂商已经启动了HarmonyOS开发，开发者可以根据需求选择这些安全厂商的服务。开发者需要与第三方安全厂商自行沟通合作方式和范围，本文档不做详细说明。具体的官方与第三方代码混淆能力的关系如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>特性</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p><strong>特性描述</strong></p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p><strong>HarmonyOS</strong></p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p><strong>三方</strong></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>名称混淆</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>混淆类、字段、属性、方法和文件名。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>√</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>控制混淆</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>混淆方法内的控制流以防御自动或手动代码分析，包括虚假控制流和控制流扁平化。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>指令替换</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>通过将简单的算术和逻辑表达式转换为难以分析的代码来保护专有公式。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>数据混淆</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>加密敏感字符串，以防止通过尝试搜索的黑客攻击，也用来加密类、asset文件、资源文件和Native库。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>代码虚拟化</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>转换方法实现为随机生成虚拟机的指令序列。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>调用隐藏</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>为访问敏感的APIs添加反射，比如用于签名校验和密码操作的标准APIs。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="14.44%"><p><strong>移除日志代码</strong></p> </td> <td class="cellrowborder" valign="top" width="66.31%"><p>移除logging、调试和测试代码，以阻止任何利用此信息的企图。</p> </td> <td class="cellrowborder" valign="top" width="10.16%"><p>×</p> </td> <td class="cellrowborder" valign="top" width="9.09%"><p>√</p> </td> </tr>  </tbody></table></div> </div> <p>由于HarmonyOS代码签名、应用加密等安全机制的限制，以及应用市场上架审核的纯净安全要求，三方加固厂商提供的安全加固内容必须满足以下六点要求：</p> <p>1、不允许隐藏敏感系统API的调用，审核人员必须能够清晰地看到应用的特性。</p> <p>2、不允许混淆非自研的SDK。SDK应由SDK厂商自行进行混淆保护。如果非自研SDK被混淆，将会影响应用市场审核相关SDK的指纹信息。</p> <p>3、通过第三方安全加固的应用程序，必须确保不包含恶意行为，以免对生态系统造成影响。此要求为约束性条款，不遵守可能导致应用被下架。</p> <p>4、不允许使用第三方虚拟机，HarmonyOS系统通过代码签名等机制限制动态加载代码，这可能导致应用无法正常运行。</p> <p>5、不允许对方舟字节码文件进行篡改，此方法可能让应用无法正常运行，以及影响应用市场对应用的纯净安全进行审核。</p> <p>6、不允许对系统库使用hook技术，此方法影响应用市场对应用的纯净安全进行审核。</p> </div> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/Privacy" target="_blank">应用安全示例代码</a></li></ul> </div> </div></div>