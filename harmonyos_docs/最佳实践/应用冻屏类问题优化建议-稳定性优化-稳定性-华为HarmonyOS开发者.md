<h1 _ngcontent-dpu-c119="" class="doc-title ng-star-inserted" title="应用冻屏类问题优化建议"> 应用冻屏类问题优化建议 </h1>

<div _ngcontent-dpu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section395763916392">优化建议1：多线程操作锁时，需要合理使用lock_guard这类自动控制持锁和释放锁的管理方式<i class="anchor-icon anchor-icon-link" anchorid="section395763916392" tips="复制节点链接"></i></h2></div> <p>以下代码为没有考虑到多线程操作时锁的时序问题，从而导致死锁。</p> <div class="screenLinkPre"><div _ngcontent-dpu-c106="" class="highlight-div"><div _ngcontent-dpu-c106="" class="highlight-div-header"><div _ngcontent-dpu-c106="" class="highlight-div-header-left"><div _ngcontent-dpu-c106="" class="handle-button expand-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpu-c106="" class="highlight-div-header-right"><div _ngcontent-dpu-c106="" class="handle-button ai-button"></div><div _ngcontent-dpu-c106="" class="handle-button line-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpu-c106="" class="handle-button theme-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpu-c106="" class="handle-button copy-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L53-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">AppFreezeAdviseNegative</span>()</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    mtx.<span class="hljs-keyword">lock</span>();</li><li>    <span class="hljs-keyword">if</span> (ContainTarget(<span class="hljs-number">1</span>)) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L53-L61" target="_blank">AppFreezeCase.cpp</a></div></div></div></div> <p>优化建议：多线程操作锁时，需要合理使用lock_guard这类自动控制持锁和释放锁的管理方式，同时注意锁的控制范围尽量要小，或按照如下修改方式及时释放锁。</p> <div class="screenLinkPre"><div _ngcontent-dpu-c106="" class="highlight-div"><div _ngcontent-dpu-c106="" class="highlight-div-header"><div _ngcontent-dpu-c106="" class="highlight-div-header-left"><div _ngcontent-dpu-c106="" class="handle-button expand-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpu-c106="" class="highlight-div-header-right"><div _ngcontent-dpu-c106="" class="handle-button ai-button"></div><div _ngcontent-dpu-c106="" class="handle-button line-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpu-c106="" class="handle-button theme-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpu-c106="" class="handle-button copy-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L65-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">AppFreezeAdvisePositive</span>()</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    mtx.<span class="hljs-keyword">lock</span>();</li><li>    <span class="hljs-keyword">if</span> (ContainTarget(<span class="hljs-number">1</span>)) {</li><li>        mtx.unlock();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    mtx.unlock();</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L65-L75" target="_blank">AppFreezeCase.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section931564110402">优化建议2：不要在主线程中提交大量重复或耗时操作<i class="anchor-icon anchor-icon-link" anchorid="section931564110402" tips="复制节点链接"></i></h2></div> <p>应用发生冻屏，但是主线程中却没有识别到耗时函数调用。</p> <div class="screenLinkPre"><div _ngcontent-dpu-c106="" class="highlight-div"><div _ngcontent-dpu-c106="" class="highlight-div-header"><div _ngcontent-dpu-c106="" class="highlight-div-header-left"><div _ngcontent-dpu-c106="" class="handle-button expand-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpu-c106="" class="highlight-div-header-right"><div _ngcontent-dpu-c106="" class="handle-button ai-button"></div><div _ngcontent-dpu-c106="" class="handle-button line-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpu-c106="" class="handle-button theme-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpu-c106="" class="handle-button copy-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L31-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getForeachKey</span>(<span class="hljs-params">item : ItemType</span>) : string {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${item.xxx2}</span><span class="hljs-subst">${item.xxx2}</span>...<span class="hljs-subst">${item.themeStyle}</span>`</span>;</li><li>} <span class="hljs-comment">// 这部分逻辑如果较为耗时，执行次数多，总时长就是发生冻屏的耗时操作</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L31-L34" target="_blank">appfreezecase.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-dpu-c106="" class="highlight-div"><div _ngcontent-dpu-c106="" class="highlight-div-header"><div _ngcontent-dpu-c106="" class="highlight-div-header-left"><div _ngcontent-dpu-c106="" class="handle-button expand-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpu-c106="" class="highlight-div-header-right"><div _ngcontent-dpu-c106="" class="handle-button ai-button"></div><div _ngcontent-dpu-c106="" class="handle-button line-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpu-c106="" class="handle-button theme-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpu-c106="" class="handle-button copy-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L42-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">xxxFunction1</span>(<span class="hljs-variable">fileUris</span> : <span class="hljs-title class_">string</span>[]): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">fileuri</span> <span class="hljs-variable">of</span> <span class="hljs-variable">fileUris</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">fileuri</span>, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_ONLY</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-comment">// 如果使用同步操作，需要考虑到容器弱网或无网等极端情况发生</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L42-L49" target="_blank">appfreezecase.ets</a></div></div></div></div> <p>优化建议：</p> <ol><li>不要在主线程中提交大量重复或耗时操作，需要合理控制页面刷新的范围，考虑大量组件、频繁刷新等场景。</li><li>请求云测数据需进行无网/弱网等边界场景测试，避免在生命周期函数中执行耗时操作。</li></ol> <div class="screenLinkPre"><div _ngcontent-dpu-c106="" class="highlight-div"><div _ngcontent-dpu-c106="" class="highlight-div-header"><div _ngcontent-dpu-c106="" class="highlight-div-header-left"><div _ngcontent-dpu-c106="" class="handle-button expand-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dpu-c106="" class="highlight-div-header-right"><div _ngcontent-dpu-c106="" class="handle-button ai-button"></div><div _ngcontent-dpu-c106="" class="handle-button line-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dpu-c106="" class="handle-button theme-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dpu-c106="" class="handle-button copy-button"><div _ngcontent-dpu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dpu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L53-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">xxxFunction2</span>(<span class="hljs-params">fileUris : <span class="hljs-built_in">string</span>[]</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">'isLoadingPic'</span>, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 用于页面load效果展示</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fileuri <span class="hljs-keyword">of</span> fileUris) {</li><li>        <span class="hljs-keyword">let</span> file = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">openSync</span>(fileuri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>); <span class="hljs-comment">// 改为异步加载</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L53-L61" target="_blank">appfreezecase.ets</a></div></div></div></div> </div> <div></div></div>