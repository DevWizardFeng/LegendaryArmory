<h1 _ngcontent-pbl-c119="" class="doc-title ng-star-inserted" title="应用冻屏类问题案例"> 应用冻屏类问题案例 </h1>

<div _ngcontent-pbl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7412134135816">ThreadBlock类问题案例-未正确使用锁<i class="anchor-icon anchor-icon-link" anchorid="section7412134135816" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="threadblock-类典型案例未正确使用锁" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="threadblock-类典型案例未正确使用锁" tips="复制节点链接"></i></h3><p>由于没有考虑到多线程操作时锁的时序问题，从而导致死锁，触发ThreadBlock检测，原理可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines#thread_block_6s-应用主线程卡死超时" target="_blank">THREAD_BLOCK_6S 应用主线程卡死超时检测</a><span style="color: rgb(68,114,196);">。</span></p> </div> <div class="tiledSection"><h3 id="section33653945917">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section33653945917" tips="复制节点链接"></i></h3><p>xxxservice上报THREAD_BLOCK_6S的AppFreeze问题。后台应用卡死时，用户无感知，但相关功能将不可用。</p> </div> <div class="tiledSection"><h3 id="section102131419195913">问题代码<i class="anchor-icon anchor-icon-link" anchorid="section102131419195913" tips="复制节点链接"></i></h3><p>代码中通过mutex_.lock()加锁，但是在返回失败情况下未解锁，会导致其他线程一直等锁。</p> <div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L27-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">ContainTarget</span><span class="hljs-params">(<span class="hljs-type">int</span> target)</span> </span>{</li><li>    <span class="hljs-keyword">auto</span> ret = std::<span class="hljs-built_in">find</span>(sharedVec.<span class="hljs-built_in">begin</span>(), sharedVec.<span class="hljs-built_in">end</span>(), target);</li><li>    <span class="hljs-keyword">if</span> (ret == sharedVec.<span class="hljs-built_in">end</span>()) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AppFreezeAdvise1</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    mtx.<span class="hljs-built_in">lock</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ContainTarget</span>(<span class="hljs-number">1</span>)) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>        <span class="hljs-comment">// 没有释放锁</span></li><li>    }</li><li>    <span class="hljs-comment">// 没有释放锁</span></li><li>     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L27-L44" target="_blank">AppFreezeCase.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section392934115915">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section392934115915" tips="复制节点链接"></i></h3></div> <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-freeze-way#section1950514261110">应用冻屏问题定位步骤与思路</a>。</p> <div class="tiledSection"><h3 id="section9856104115591">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section9856104115591" tips="复制节点链接"></i></h3></div> <p>提取故障日志关键类别信息。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">appfreeze</span>: <span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">hmsapp</span>.<span class="hljs-title class_">xxx</span> <span class="hljs-title class_">THREAD_BLOCK_6S</span> <span class="hljs-title class_">at</span> <span class="hljs-number">20240408082432</span></li><li><span class="hljs-variable">DisplayPowerInfo</span>:<span class="hljs-title class_">powerState</span>:<span class="hljs-title class_">AWAKE</span></li></ol></pre></div></div> <p>从Foreground值可看出，应用此时处于后台。当真正的3s事件上报上来时，后台应用已卡<strong>18s</strong>前。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Module</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">Version</span>:<span class="hljs-number">1.2</span><span class="hljs-number">.2.202</span></li><li><span class="hljs-variable">VersionCode</span>:<span class="hljs-number">1002002202</span></li><li><span class="hljs-variable">PreInstalled</span>:<span class="hljs-title class_">Yes</span></li><li><span class="hljs-variable">Foreground</span>:<span class="hljs-title class_">No</span>  --&gt; <span class="hljs-title class_">后台</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">43675</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20020029</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">THREAD_BLOCK_6S</span></li></ol></pre></div></div> <p>THREAD_BLOCK_3S上报的时间为08:24:29:612；</p> <p>THREAD_BLOCK_6S上报的时间为08:24:32:638，相隔3s符合预期。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</li><li><span class="hljs-variable">DOMAIN</span>:<span class="hljs-title class_">AAFWK</span></li><li><span class="hljs-variable">STRINGID</span>:<span class="hljs-title class_">THREAD_BLOCK_6S</span></li><li><span class="hljs-variable">TIMESTAMP</span>:<span class="hljs-number">2024</span>/<span class="hljs-number">04</span>/<span class="hljs-number">08</span>-<span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">32</span>:<span class="hljs-number">638</span></li><li><span class="hljs-variable">PID</span>:<span class="hljs-number">43675</span></li><li><span class="hljs-variable">UID</span>:<span class="hljs-number">20020029</span></li><li><span class="hljs-variable">PACKAGE_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span></li><li><span class="hljs-variable">PROCESS_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span>.<span class="hljs-title class_">xxx</span></li><li>*******************************************</li><li><span class="hljs-variable">start</span> <span class="hljs-variable">time</span>: <span class="hljs-number">2024</span>/<span class="hljs-number">04</span>/<span class="hljs-number">08</span>-<span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29</span>:<span class="hljs-number">627</span></li><li><span class="hljs-variable">DOMAIN</span> = <span class="hljs-variable">AAFWK</span></li><li><span class="hljs-variable">EVENTNAME</span> = <span class="hljs-variable">THREAD_BLOCK_3S</span></li><li><span class="hljs-variable">TIMESTAMP</span> = <span class="hljs-number">2024</span>/<span class="hljs-number">04</span>/<span class="hljs-number">08</span>-<span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29</span>:<span class="hljs-number">612</span></li><li><span class="hljs-variable">PID</span> = <span class="hljs-number">43675</span></li><li><span class="hljs-variable">UID</span> = <span class="hljs-number">20020029</span></li><li><span class="hljs-variable">PACKAGE_NAME</span> = <span class="hljs-variable">com</span>.<span class="hljs-variable">xxx</span>.<span class="hljs-variable">xxx</span>.<span class="hljs-variable">xxx</span></li><li><span class="hljs-variable">PROCESS_NAME</span> = <span class="hljs-variable">com</span>.<span class="hljs-variable">xxx</span>.<span class="hljs-variable">xxx</span>.<span class="hljs-variable">xxx</span></li></ol></pre></div></div> <p>3s上报时会抓取此时的EventHandler信息，时间为08:24:29.413，符合预期上报的原因为：App main thread is not response! 主线程无响应，当前正在运行的任务开始时间为08:24:01.514。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">MSG</span> = </li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">time</span>:<span class="hljs-number">2024</span>/<span class="hljs-number">04</span>/<span class="hljs-number">08</span>-<span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29</span></li><li><span class="hljs-variable">App</span> <span class="hljs-keyword">main</span> <span class="hljs-variable">thread</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">response</span>!</li><li><span class="hljs-variable">mainHandler</span> <span class="hljs-variable">dump</span> <span class="hljs-keyword">is</span>:</li><li> <span class="hljs-variable">EventHandler</span> <span class="hljs-variable">dump</span> <span class="hljs-variable">begin</span> <span class="hljs-variable">curTime</span>: <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29.413</span></li><li> <span class="hljs-variable">Event</span> <span class="hljs-variable">runner</span> (<span class="hljs-variable">Thread</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">Thread</span> <span class="hljs-variable">ID</span> = <span class="hljs-number">43675</span>) <span class="hljs-keyword">is</span> <span class="hljs-variable">running</span></li><li> <span class="hljs-variable">Current</span> <span class="hljs-variable">Running</span>: <span class="hljs-title class_">start</span> <span class="hljs-title class_">at</span> <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">01.514</span>, <span class="hljs-variable">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43675</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">01.514</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">01.514</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = <span class="hljs-variable">uvLoopTask</span> }</li></ol></pre></div></div> <p>watchdog 任务位于高优先级队列（VIP priority event queue），如下图可发现：每隔3s就会抛一个任务到主线程去，符合预期。</p> <p>THREAD_BLOCK_3S、THREAD_BLOCK_6S的队列一致，6s队列较3s队列多了一个event。</p> <p>最早的一个event send time为<strong>08:24:11.388</strong>，与3s上报上来的时间08:24:29:612刚好差18s，符合预期。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-variable">VIP</span> <span class="hljs-variable">priority</span> <span class="hljs-variable">event</span> <span class="hljs-variable">queue</span> <span class="hljs-variable">information</span>:</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.1</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">11.388</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">11.388</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.2</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">14.458</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">14.458</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.3</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">17.383</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">17.383</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.4</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">20.363</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">20.363</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.5</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">23.418</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">23.418</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.6</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">26.369</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">26.369</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.7</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">43679</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29.412</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29.412</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">139</span>)] }</li></ol></pre></div></div> <p>以上可总结：应用<strong>主线程从08:24:01.514开始运行本次任务，第一次3s检测开始时间为08:24:11.388，真正开始卡住的时间在08:24:11左右。</strong></p> <p>查看主线程栈：从xxx_request_client.so-&gt;libsamgr_proxy.z.so-&gt;libipc_core.z.so(OHOS::BinderConnector::WriteBinder)</p> <p>可知：<strong>此时，主线程发起了一个ipc请求，对端进程未返回导致卡死，堆栈如下所示：</strong></p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">43675</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">xxx</span></li><li># <span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000168</span><span class="hljs-variable">c44</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">ioctl</span>+<span class="hljs-number">176</span>)(<span class="hljs-number">91</span><span class="hljs-variable">b804d2409a13f27463debe9e19fb5d</span>)</li><li># <span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000049268</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderConnector</span>::<span class="hljs-title class_">WriteBinder</span>(<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">long</span>, <span class="hljs-variable">void</span>*)+<span class="hljs-number">112</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000054</span><span class="hljs-variable">fd4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">TransactWithDriver</span>(<span class="hljs-title class_">bool</span>)+<span class="hljs-number">296</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000544</span><span class="hljs-variable">c8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">WaitForCompletion</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">MessageParcel</span>*, <span class="hljs-variable">int</span>*)+<span class="hljs-number">304</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000053</span><span class="hljs-variable">c84</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">SendRequest</span>(<span class="hljs-title class_">int</span>, <span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;)+<span class="hljs-number">312</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002</span><span class="hljs-variable">d6d8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">IPCObjectProxy</span>::<span class="hljs-title class_">SendRequestInner</span>(<span class="hljs-title class_">bool</span>, <span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;)+<span class="hljs-number">128</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000030e00</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">IPCObjectProxy</span>::<span class="hljs-title class_">GetProtoInfo</span>()+<span class="hljs-number">396</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002e990</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">IPCObjectProxy</span>::<span class="hljs-title class_">WaitForInit</span>()+<span class="hljs-number">292</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">08</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000036</span><span class="hljs-variable">cd0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">IPCProcessSkeleton</span>::<span class="hljs-title class_">FindOrNewObject</span>(<span class="hljs-title class_">int</span>)+<span class="hljs-number">116</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">09</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000571</span><span class="hljs-variable">cc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">UnflattenObject</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">Parcel</span>&amp;)+<span class="hljs-number">272</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">10</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000463</span><span class="hljs-variable">a4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_core</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>::<span class="hljs-title class_">ReadRemoteObject</span>()+<span class="hljs-number">116</span>)(<span class="hljs-variable">e59500a4ea66775388332f6e3cc12fe3</span>)</li><li># <span class="hljs-number">11</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001250</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libsamgr_proxy</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">SystemAbilityManagerProxy</span>::<span class="hljs-title class_">CheckSystemAbility</span>(<span class="hljs-title class_">int</span>, <span class="hljs-title class_">bool</span>&amp;)+<span class="hljs-number">952</span>)(<span class="hljs-number">6</span><span class="hljs-variable">f113f37ac6ac882cfa16077ad5b406a</span>)</li><li># <span class="hljs-number">12</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000010e7</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libsamgr_proxy</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">SystemAbilityManagerProxy</span>::<span class="hljs-title class_">GetSystemAbilityWrapper</span>(<span class="hljs-title class_">int</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">basic_string</span>&lt;<span class="hljs-title class_">char</span>, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">char_traits</span>&lt;<span class="hljs-title class_">char</span>&gt;, <span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">allocator</span>&lt;<span class="hljs-title class_">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">232</span>)(<span class="hljs-number">6</span><span class="hljs-variable">f113f37ac6ac882cfa16077ad5b406a</span>)</li><li># <span class="hljs-number">13</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000118</span><span class="hljs-variable">b8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libsamgr_proxy</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">SystemAbilityManagerProxy</span>::<span class="hljs-title class_">Recompute</span>(<span class="hljs-title class_">int</span>, <span class="hljs-title class_">int</span>)+<span class="hljs-number">132</span>)(<span class="hljs-number">6</span><span class="hljs-variable">f113f37ac6ac882cfa16077ad5b406a</span>)</li><li># <span class="hljs-number">14</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000011170</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libsamgr_proxy</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">DynamicCache</span>&lt;<span class="hljs-title class_">int</span>, <span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">sptr</span>&lt;<span class="hljs-title class_">OHOS</span>::<span class="hljs-title class_">IRemoteObject</span>&gt;&gt;::<span class="hljs-title class_">QueryResult</span>(<span class="hljs-title class_">int</span>, <span class="hljs-title class_">int</span>)+<span class="hljs-number">316</span>)(<span class="hljs-number">6</span><span class="hljs-variable">f113f37ac6ac882cfa16077ad5b406a</span>)</li><li># <span class="hljs-number">15</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000007e0</span><span class="hljs-variable">c</span> <span class="hljs-variable">xxx_request_client</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">xxx</span>::<span class="hljs-title class_">RPCRequestClient</span>::<span class="hljs-title class_">GetService</span>()+<span class="hljs-number">540</span>)(<span class="hljs-number">557450139184527807025</span><span class="hljs-variable">a632613fd76</span>)</li><li># <span class="hljs-number">16</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000008824</span> <span class="hljs-variable">xxx_request_client</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">xxx</span>::<span class="hljs-title class_">RPCRequestClient</span>::<span class="hljs-title class_">Init</span>()+<span class="hljs-number">16</span>)(<span class="hljs-number">557450139184527807025</span><span class="hljs-variable">a632613fd76</span>)</li><li># <span class="hljs-number">17</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000008</span><span class="hljs-variable">d60</span> <span class="hljs-variable">xxx_request_client</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">CreateRpcRequestByServiceName</span>+<span class="hljs-number">104</span>)(<span class="hljs-number">557450139184527807025</span><span class="hljs-variable">a632613fd76</span>)</li><li># <span class="hljs-number">18</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000008</span><span class="hljs-variable">f98</span> <span class="hljs-variable">xxx_request_client</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">CreateRpcRequest</span>+<span class="hljs-number">72</span>)(<span class="hljs-number">557450139184527807025</span><span class="hljs-variable">a632613fd76</span>)</li><li># <span class="hljs-number">19</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000002944</span> <span class="hljs-variable">xxx_rpc_client</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">xxx</span>::<span class="hljs-title class_">xxx</span>::<span class="hljs-title class_">RpcRequestClient</span>::<span class="hljs-title class_">RpcRequestClient</span>()+<span class="hljs-number">224</span>)(<span class="hljs-number">02343</span><span class="hljs-variable">ed2fff69759d408b23eaf69fcde</span>)</li></ol></pre></div></div> <p>查看binderCatcher：<strong>此时43675的主线程正在与979进程通信，抓binder时已经卡了27s。</strong></p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">PeerBinderCatcher</span> -- <span class="hljs-variable">pid</span>==<span class="hljs-number">43675</span> <span class="hljs-variable">layer_</span> == <span class="hljs-number">1</span></li><li>
</li><li><span class="hljs-variable">BinderCatcher</span> --</li><li>
</li><li>    <span class="hljs-number">43675</span>:<span class="hljs-number">43675</span> <span class="hljs-title class_">to</span> <span class="hljs-number">979</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">code</span> <span class="hljs-number">5</span><span class="hljs-title class_">f475249</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">27.104545829</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">1</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">35854</span>:<span class="hljs-number">35854</span> <span class="hljs-title class_">to</span> <span class="hljs-number">52462</span>:<span class="hljs-number">52462</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span>  --&gt; <span class="hljs-title class_">binder通信等待了27s</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39147</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">30753</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.337894271</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39147</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">30753</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39151</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">28652</span> <span class="hljs-title class_">code</span> <span class="hljs-number">7</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.531140625</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39151</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">28652</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39150</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">31297</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.976419270</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39150</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">31297</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">38979</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">32554</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.22108334</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">38979</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">32554</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39149</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">30754</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.534261979</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39149</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">30754</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">38949</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">31301</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.977779166</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">38949</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">31301</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39172</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">35667</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">1.47387500</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39172</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">35667</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">57187</span>:<span class="hljs-number">39173</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">28822</span> <span class="hljs-title class_">code</span> <span class="hljs-number">0</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.565389063</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">57187</span>:<span class="hljs-number">39173</span> <span class="hljs-title class_">to</span> <span class="hljs-number">28644</span>:<span class="hljs-number">28822</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">1477</span>:<span class="hljs-number">1676</span> <span class="hljs-title class_">to</span> <span class="hljs-number">1408</span>:<span class="hljs-number">2026</span> <span class="hljs-title class_">code</span> <span class="hljs-number">17</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">0.0</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">3</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">1477</span>:<span class="hljs-number">1676</span> <span class="hljs-title class_">to</span> <span class="hljs-number">1408</span>:<span class="hljs-number">2026</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">628</span>:<span class="hljs-number">8136</span> <span class="hljs-title class_">to</span> <span class="hljs-number">979</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">code</span> <span class="hljs-number">2</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">13166.722870859</span> <span class="hljs-title class_">s</span> <span class="hljs-title class_">frz_state</span>:<span class="hljs-number">1</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">628</span>:<span class="hljs-number">8136</span> <span class="hljs-title class_">to</span> <span class="hljs-number">979</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li></ol></pre></div></div> <p>查看979进程主线程栈：xxxserver在等待锁释放。<strong>该问题即为典型的锁使用不当，导致的等锁卡死。</strong></p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-rust" data-highlighted="yes"><ol class="linenums"><li>Binder catcher stacktrace, <span class="hljs-keyword">type</span> <span class="hljs-title class_">is</span> peer, pid : <span class="hljs-number">979</span></li><li><span class="hljs-type">Result</span>: <span class="hljs-number">0</span> ( no error )</li><li>Timestamp:<span class="hljs-number">2024</span>-<span class="hljs-number">04</span>-<span class="hljs-number">08</span> <span class="hljs-number">08</span>:<span class="hljs-number">24</span>:<span class="hljs-number">29.000</span></li><li>Pid:<span class="hljs-number">979</span></li><li>Uid:<span class="hljs-number">3094</span></li><li>Process name:xxxserver</li><li>Process life time:<span class="hljs-number">60410</span>s</li><li>Tid:<span class="hljs-number">979</span>, Name:xxxserver</li><li># <span class="hljs-number">00</span> pc <span class="hljs-number">00000000001</span>aafc4 /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(__timedwait_cp+<span class="hljs-number">192</span>)(<span class="hljs-number">91</span>b804d2409a13f27463debe9e19fb5d)</li><li># <span class="hljs-number">01</span> pc <span class="hljs-number">00000000001</span>b0d50 /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(__pthread_mutex_timedlock_inner+<span class="hljs-number">592</span>)(<span class="hljs-number">91</span>b804d2409a13f27463debe9e19fb5d)</li><li># <span class="hljs-number">02</span> pc <span class="hljs-number">00000000000</span>c38e0 /system/lib64/libc++.<span class="hljs-title function_ invoke__">so</span>(std::__h::mutex::<span class="hljs-title function_ invoke__">lock</span>()+<span class="hljs-number">8</span>)(<span class="hljs-number">0</span>b61ba21a775725a1bd8802a393b133afbc503a5)   -<span class="hljs-punctuation">-&gt;</span> 调用了lock，然后等待</li><li># <span class="hljs-number">03</span> pc <span class="hljs-number">00000000000086</span>dc xxx_server.<span class="hljs-title function_ invoke__">so</span>(xxx::xxx::<span class="hljs-title function_ invoke__">InitImpl</span>(int, std::__h::vector&lt;xxx::xxx::RpcHandle, std::__h::allocator&lt;xxx::xxx::RpcHandle&gt;&gt; <span class="hljs-keyword">const</span>&amp;, std::__h::vector&lt;xxx::xxx::RpcHandle, std::__h::allocator&lt;xxx::xxx::RpcHandle&gt;&gt;&amp;)+<span class="hljs-number">84</span>)(f4bb275898d797b22eae35fe48db9009)</li><li># <span class="hljs-number">04</span> pc <span class="hljs-number">000000000000798</span>c xxx_request_server.<span class="hljs-title function_ invoke__">so</span>(xxx::RPCRequestStub::<span class="hljs-title function_ invoke__">SyncExecute</span>(OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;)+<span class="hljs-number">164</span>)(<span class="hljs-number">70</span>cbb10c758902c1e3e179efc93ce0af)</li><li># <span class="hljs-number">05</span> pc <span class="hljs-number">0000000000008314</span> xxx_request_server.<span class="hljs-title function_ invoke__">so</span>(xxx::RPCRequestStub::<span class="hljs-title function_ invoke__">OnRemoteRequest</span>(unsigned int, OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;, OHOS::MessageOption&amp;)+<span class="hljs-number">300</span>)(<span class="hljs-number">70</span>cbb10c758902c1e3e179efc93ce0af)</li><li># <span class="hljs-number">06</span> pc <span class="hljs-number">00000000000153e4</span> /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPCObjectStub::<span class="hljs-title function_ invoke__">SendRequest</span>(unsigned int, OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;, OHOS::MessageOption&amp;)+<span class="hljs-number">604</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">07</span> pc <span class="hljs-number">000000000002</span>b464 /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPC_SINGLE::BinderInvoker::<span class="hljs-title function_ invoke__">OnTransaction</span>(unsigned <span class="hljs-type">char</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">1220</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">08</span> pc <span class="hljs-number">000000000002</span>baec /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPC_SINGLE::BinderInvoker::<span class="hljs-title function_ invoke__">HandleCommandsInner</span>(unsigned int)+<span class="hljs-number">368</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">09</span> pc <span class="hljs-number">000000000002</span>a6b0 /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPC_SINGLE::BinderInvoker::<span class="hljs-title function_ invoke__">HandleCommands</span>(unsigned int)+<span class="hljs-number">60</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">10</span> pc <span class="hljs-number">000000000002</span>a4dc /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPC_SINGLE::BinderInvoker::<span class="hljs-title function_ invoke__">StartWorkLoop</span>()+<span class="hljs-number">120</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">11</span> pc <span class="hljs-number">000000000002</span>bc2c /system/lib64/chipset-<span class="hljs-keyword">pub</span>-sdk/libipc_single.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPC_SINGLE::BinderInvoker::<span class="hljs-title function_ invoke__">JoinThread</span>(<span class="hljs-type">bool</span>)+<span class="hljs-number">92</span>)(<span class="hljs-number">25</span>b3d63905ef47289c096ea42ba2d86a)</li><li># <span class="hljs-number">12</span> pc <span class="hljs-number">0000000000004</span>bd4 <span class="hljs-title function_ invoke__">xxxserver</span>(<span class="hljs-number">02</span>cff7e5dce05d6d28096601458b6f6d)</li><li># <span class="hljs-number">13</span> pc <span class="hljs-number">00000000000</span>a3b58 /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(libc_start_main_stage2+<span class="hljs-number">64</span>)(<span class="hljs-number">91</span>b804d2409a13f27463debe9e19fb5d)</li></ol></pre></div></div> <p>反编译后，确定对应卡锁代码行，结合上下文检测锁的使用。</p> <div class="tiledSection"><h3 id="section9768185420599">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section9768185420599" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L53-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">AppFreezeAdviseNegative</span>()</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    mtx.<span class="hljs-keyword">lock</span>();</li><li>    <span class="hljs-keyword">if</span> (ContainTarget(<span class="hljs-number">1</span>)) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>     <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L53-L61" target="_blank">AppFreezeCase.cpp</a></div></div></div></div> </div> <p>修改为：</p> <div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L65-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-built_in">int</span> <span class="hljs-title">AppFreezeAdvisePositive</span>()</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    mtx.<span class="hljs-keyword">lock</span>();</li><li>    <span class="hljs-keyword">if</span> (ContainTarget(<span class="hljs-number">1</span>)) {</li><li>        mtx.unlock();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</li><li>    }</li><li>    mtx.unlock();</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/cpp/AppFreezeCase.cpp#L65-L75" target="_blank">AppFreezeCase.cpp</a></div></div></div></div> <p>结合上下文，合理调整锁的使用。</p> <div class="tiledSection"><h3 id="section12660829016">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section12660829016" tips="复制节点链接"></i></h3></div> <p>多线程交互时需要格外注意时序、死锁问题。</p> <div class="tiledSection"><h2 id="section9165111512020">APP_INPUT_BLOCK类典型案例-组件全量刷新<i class="anchor-icon anchor-icon-link" anchorid="section9165111512020" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1496315311020" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section1496315311020" tips="复制节点链接"></i></h3></div> <p>由于线程繁忙，导致用户在合一桌面切换主题时，页面高概率卡死，点击无响应，然后闪退到锁屏界面，严重影响用户体验，从而触发APP_INPUT_BLOCK检测，原理可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines#app_input_block-用户输入响应超时" target="_blank">APP_INPUT_BLOCK 用户输入响应超时</a>。</p> <div class="tiledSection"><h3 id="section1634441001">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section1634441001" tips="复制节点链接"></i></h3></div> <p>用户在切换主题时突然卡死，有sceneboard的AppFreeze问题上报。</p> <div class="tiledSection"><h3 id="section31189512004">问题代码<i class="anchor-icon anchor-icon-link" anchorid="section31189512004" tips="复制节点链接"></i></h3></div> <p>组件的刷新复用通过其key值控制。页面更新时，key值不变复用之前的组件，key值变化更新组件及其子组件。</p> <p>该函数用于生成桌面组件的key，并与themeStyle关联，当用户在桌面连续切换主题时，组件反复全量刷新，导致卡死。</p> <div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L31-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">getForeachKey</span>(<span class="hljs-params">item : ItemType</span>) : string {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${item.xxx2}</span><span class="hljs-subst">${item.xxx2}</span>...<span class="hljs-subst">${item.themeStyle}</span>`</span>;</li><li>} <span class="hljs-comment">// 这部分逻辑如果较为耗时，执行次数多，总时长就是发生冻屏的耗时操作</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L31-L34" target="_blank">appfreezecase.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section78021557908">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section78021557908" tips="复制节点链接"></i></h3></div> <p>请参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-freeze-way#section1950514261110">应用冻屏问题定位步骤与思路</a>。</p> <div class="tiledSection"><h3 id="section994218412111">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section994218412111" tips="复制节点链接"></i></h3></div> <p>提取故障关键信息。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">appfreeze</span>: <span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">sceneboard</span> <span class="hljs-title class_">APP_INPUT_BLOCK</span> <span class="hljs-title class_">at</span> <span class="hljs-number">202403144059</span></li><li><span class="hljs-variable">DisplayPowerInfo</span>:<span class="hljs-title class_">powerState</span>:<span class="hljs-title class_">AWAKE</span></li></ol></pre></div></div> <p>APP_INPUT_BLOCK 事件上报时间为 <strong>14:40:59:440</strong>。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">DOMAIN</span>:<span class="hljs-title class_">AAFWK</span></li><li><span class="hljs-variable">STRINGID</span>:<span class="hljs-title class_">APP_INPUT_BLOCK</span></li><li><span class="hljs-variable">TIMESTAMP</span>:<span class="hljs-number">2024</span>/<span class="hljs-number">03</span>/<span class="hljs-number">14</span>-<span class="hljs-number">14</span>:<span class="hljs-number">40</span>:<span class="hljs-number">59</span>:<span class="hljs-number">440</span> --&gt; <span class="hljs-title class_">故障上报时间</span></li><li><span class="hljs-variable">PID</span>:<span class="hljs-number">2918</span></li><li><span class="hljs-variable">UID</span>:<span class="hljs-number">20020017</span></li><li><span class="hljs-variable">PACKAGE_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">sceneboard</span></li><li><span class="hljs-variable">PROCESS_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">sceneboard</span></li></ol></pre></div></div> <p>上报的原因是：User input does not respond! 用户输入事件没有响应。</p> <p>可以看到，当前任务在主线程（Thread ID == Pid）上运行，任务从<strong>14:40:53.499</strong>开始运行，直到Fault time<strong>14:40:58</strong>仍未运行完。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">MSG</span> <span class="hljs-string">=</span> </li><li><span class="hljs-string">Fault</span> <span class="hljs-string">time:2024/03/14-14:40:58</span></li><li><span class="hljs-string">User</span> <span class="hljs-string">input</span> <span class="hljs-string">does</span> <span class="hljs-string">not</span> <span class="hljs-string">respond!</span></li><li><span class="hljs-attr">mainHandler dump is:</span></li><li> <span class="hljs-attr">EventHandler dump begin curTime:</span> <span class="hljs-number">2024-03-14 02:40:58.520</span></li><li> <span class="hljs-string">Event</span> <span class="hljs-string">runner</span> <span class="hljs-string">(Thread</span> <span class="hljs-string">name</span> <span class="hljs-string">=</span> <span class="hljs-string">,</span> <span class="hljs-string">Thread</span> <span class="hljs-string">ID</span> <span class="hljs-string">=</span> <span class="hljs-number">2918</span><span class="hljs-string">)</span> <span class="hljs-string">is</span> <span class="hljs-string">running</span></li><li> <span class="hljs-attr">Current Running:</span> <span class="hljs-string">start</span> <span class="hljs-string">at</span> <span class="hljs-number">2024-03-14 02:40:53.499</span><span class="hljs-string">,</span> <span class="hljs-string">Event</span> { <span class="hljs-string">send</span> <span class="hljs-string">thread</span> <span class="hljs-string">=</span> <span class="hljs-number">2918</span>, <span class="hljs-string">send</span> <span class="hljs-string">time</span> <span class="hljs-string">=</span> <span class="hljs-number">2024-03-14 02:40:53.499</span>, <span class="hljs-string">handle</span> <span class="hljs-string">time</span> <span class="hljs-string">=</span> <span class="hljs-number">2024-03-14 02:40:53.499</span>, <span class="hljs-string">task</span> <span class="hljs-string">name</span> <span class="hljs-string">=</span>  }</li></ol></pre></div></div> <p>用户输入事件需要第一时间响应，所以同watchdog一样都在VIP priority event queue。</p> <p>可以看出队列中已经有200+的input event阻塞中未被处理。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li> <span class="hljs-variable">VIP</span> <span class="hljs-variable">priority</span> <span class="hljs-variable">event</span> <span class="hljs-variable">queue</span> <span class="hljs-variable">information</span>:</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.1</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.690</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.690</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.2</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.699</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.699</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.3</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.708</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.708</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.4</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.717</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.717</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.5</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.726</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.726</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.6</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.736</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.736</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.7</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.745</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.745</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.8</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.754</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">53.754</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> ...</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.190</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.166</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.166</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.191</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.176</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.176</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.192</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.186</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.186</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.193</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">2923</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.196</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.196</span>, <span class="hljs-variable">id</span> = <span class="hljs-number">1</span>, <span class="hljs-variable">caller</span> = [<span class="hljs-variable">watchdog</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">Timer</span>:<span class="hljs-number">140</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.194</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.196</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.196</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.195</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.206</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.206</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.196</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.216</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.216</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.197</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.226</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.226</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.198</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.236</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.236</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.199</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.245</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.245</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.200</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.254</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.254</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.201</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.265</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.265</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.202</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.275</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.274</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.203</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.284</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.284</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.204</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.294</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.294</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li><li> <span class="hljs-variable">No</span><span class="hljs-number">.205</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">3370</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.305</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">03</span>-<span class="hljs-number">14</span> <span class="hljs-number">02</span>:<span class="hljs-number">40</span>:<span class="hljs-number">56.305</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">caller</span> = [<span class="hljs-variable">input_manager_impl</span>.<span class="hljs-title function_">cpp</span>(<span class="hljs-variable">OnPointerEvent</span>:<span class="hljs-number">465</span>)] }</li></ol></pre></div></div> <p>从逻辑上看，input event触发应用主线程任务开始执行，但是6s还没有执行完，导致应用冻屏（AppFreeze）；</p> <p>因此，只需要关注input触发应用执行的具体任务，及对应任务执行超时的原因。</p> <p>主线程栈：此时运行时状态，栈顶的ark_jsruntime.so中的GetCurrentThreadId并非持锁阻塞或耗时很长的函数，抓到的栈为瞬时栈，没有参考意义。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-rust" data-highlighted="yes"><ol class="linenums"><li>Tid:<span class="hljs-number">2918</span>, Name:example.sceneboard</li><li># <span class="hljs-number">00</span> pc <span class="hljs-number">000000000009</span>f73c /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(<span class="hljs-number">8</span>fa55898166cd804dad43d909b5319cc)</li><li># <span class="hljs-number">01</span> pc <span class="hljs-number">000000000054</span>b7b4 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::os::thread::<span class="hljs-title function_ invoke__">GetCurrentThreadId</span>()+<span class="hljs-number">12</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">02</span> pc <span class="hljs-number">00000000002107</span>a4 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::ecmascript::EcmaVM::<span class="hljs-title function_ invoke__">CheckThread</span>() <span class="hljs-keyword">const</span>+<span class="hljs-number">200</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">03</span> pc <span class="hljs-number">0000000000432998</span> /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::JSNApi::<span class="hljs-title function_ invoke__">GetHandleAddr</span>(panda::ecmascript::EcmaVM <span class="hljs-keyword">const</span>*, unsigned long)+<span class="hljs-number">64</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">04</span> pc <span class="hljs-number">000000000003</span>eeb8 /system/lib64/platformsdk/libace_napi.z.<span class="hljs-title function_ invoke__">so</span>(ArkNativeReference::<span class="hljs-title function_ invoke__">Get</span>()+<span class="hljs-number">32</span>)(c3a760aff0c73a2e76accaf518321fc9)</li><li># <span class="hljs-number">05</span> pc <span class="hljs-number">0000000000043</span>cb4 /system/lib64/platformsdk/libace_napi.z.<span class="hljs-title function_ invoke__">so</span>(napi_get_reference_value+<span class="hljs-number">48</span>)(c3a760aff0c73a2e76accaf518321fc9)</li><li># <span class="hljs-number">06</span> pc <span class="hljs-number">0000000000007564</span> /system/lib64/module/events/libemitter.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::AppExecFwk::<span class="hljs-title function_ invoke__">SearchCallbackInfo</span>(napi_env__*, std::__h::variant&lt;unsigned int, std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt;&gt; <span class="hljs-keyword">const</span>&amp;, napi_value__*)+<span class="hljs-number">248</span>)(<span class="hljs-number">8</span>fe2937855aab3ea839419f952597511)</li><li># <span class="hljs-number">07</span> pc <span class="hljs-number">0000000000007</span>d8c /system/lib64/module/events/libemitter.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::AppExecFwk::<span class="hljs-title function_ invoke__">OnOrOnce</span>(napi_env__*, napi_callback_info__*, <span class="hljs-type">bool</span>)+<span class="hljs-number">568</span>)(<span class="hljs-number">8</span>fe2937855aab3ea839419f952597511)</li><li># <span class="hljs-number">08</span> pc <span class="hljs-number">00000000000096</span>d8 /system/lib64/module/events/libemitter.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::AppExecFwk::<span class="hljs-title function_ invoke__">JS_Once</span>(napi_env__*, napi_callback_info__*) (.cfi)+<span class="hljs-number">84</span>)(<span class="hljs-number">8</span>fe2937855aab3ea839419f952597511)</li><li># <span class="hljs-number">09</span> pc <span class="hljs-number">000000000002</span>c8f0 /system/lib64/platformsdk/libace_napi.z.<span class="hljs-title function_ invoke__">so</span>(<span class="hljs-title function_ invoke__">ArkNativeFunctionCallBack</span>(panda::JsiRuntimeCallInfo*)+<span class="hljs-number">168</span>)(c3a760aff0c73a2e76accaf518321fc9)</li><li># <span class="hljs-number">10</span> pc <span class="hljs-number">0000000000187</span>b48 /system/lib64/module/arkcompiler/stub.<span class="hljs-title function_ invoke__">an</span>(RTStub_PushCallArgsAndDispatchNative+<span class="hljs-number">40</span>)</li><li># <span class="hljs-number">11</span> pc <span class="hljs-number">00000000002</span>da5fc /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::ecmascript::InterpreterAssembly::<span class="hljs-title function_ invoke__">Execute</span>(panda::ecmascript::EcmaRuntimeCallInfo*)+<span class="hljs-number">416</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">12</span> pc <span class="hljs-number">00000000002</span>da5fc /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::ecmascript::InterpreterAssembly::<span class="hljs-title function_ invoke__">Execute</span>(panda::ecmascript::EcmaRuntimeCallInfo*)+<span class="hljs-number">416</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">13</span> pc <span class="hljs-number">00000000003954</span>a0 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::ecmascript::JSStableArray::<span class="hljs-title function_ invoke__">HandleforEachOfStable</span>(panda::ecmascript::JSThread*, panda::ecmascript::JSHandle&lt;panda::ecmascript::JSObject&gt;, panda::ecmascript::JSHandle&lt;panda::ecmascript::JSTaggedValue&gt;, panda::ecmascript::JSHandle&lt;panda::ecmascript::JSTaggedValue&gt;, unsigned int, unsigned int&amp;)+<span class="hljs-number">596</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li># <span class="hljs-number">14</span> pc <span class="hljs-number">000000000018</span>f4b0 /system/lib64/platformsdk/libark_jsruntime.<span class="hljs-title function_ invoke__">so</span>(panda::ecmascript::builtins::BuiltinsArray::<span class="hljs-title function_ invoke__">ForEach</span>(panda::ecmascript::EcmaRuntimeCallInfo*)+<span class="hljs-number">840</span>)(<span class="hljs-number">7715646e48</span>f750f3dc31e660b056eb43)</li><li>...</li></ol></pre></div></div> <p>接下来排查HiLog流水日志：</p> <p>首先找到上报APP_INPUT_BLOCK的时间点，大约在13:40:59.448。事件上报完后，dfx将卡死的scb杀掉。</p> <p><span><img originheight="420" originwidth="1954" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.22623490804807479952527818042450:50001231000000:2800:70381DD7C8AB1BEDC52FEB6F15324A3549E57CA430CB9EF06AE5B1150D649D15.png" width="920" height="197.74820880245647"></span>往前推6s左右，可以看到在14:40:53.498左右，有一个点击事件发给了scb。</p> <p><span><img originheight="436" originwidth="1956" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.78428995955084414829136801786834:50001231000000:2800:0D5689C9442EAFFA9CC2654E8684364003E1657C95FD935438CC41930B115218.png" width="920" height="205.0715746421268"></span>这之间的6s存在大量的scb日志，判断是在进行更新渲染。</p> <p><span><img originheight="720" originwidth="1050" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.73828067140154811799482489232192:50001231000000:2800:C00227EE18D76347D78CFD3D548FD1466AE0270C4BBD45182573C9AB87CEE171.png" width="920" height="630.8571428571429"></span></p> <p>查看对应时间点的trace：</p> <p><span><img originheight="726" originwidth="1793" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.75113330259996611931551390777815:50001231000000:2800:9418675981421206D98F3948B386F5B2F528389BB381716A4B5A0AB8E5BC3038.png" width="920" height="372.51533742331293"></span>发现scb主线程被占满，非常繁忙。耗时较长的任务是<strong>CustomNodeUpdate SwiperPage</strong>，后续需排查该组件里为何一直在刷新。</p> <p>对应领域排查后发现：swiperPage上将themeStyle加入到了key里面，key变化就会触发控件新建流程。</p> <p>当切换主题或者切换图标风格时，桌面上控件会全量新建，使得主线程繁忙，导致输入事件未响应。</p> <div class="tiledSection"><h3 id="section13735151812113">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section13735151812113" tips="复制节点链接"></i></h3></div> <p>仅在切换桌面组件风格时，才触发桌面组件的刷新，缩小刷新范围。</p> <div class="tiledSection"><h3 id="section15052261012">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section15052261012" tips="复制节点链接"></i></h3></div> <p>用户点击触发页面更新时，需要合理控制页面刷新的范围，考虑大量组件、频繁刷新等场景。</p> <div class="tiledSection"><h2 id="section15931164017114">LIFECYCLE_TIMEOUT类典型案例-加载云图<i class="anchor-icon anchor-icon-link" anchorid="section15931164017114" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1020014555118" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section1020014555118" tips="复制节点链接"></i></h3></div> <p>由于主线程中存在耗时操作，导致应用拉起、切前台等过程中卡死并闪退，触发LIFECYCLE_TIMEOUT，原理可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/appfreeze-guidelines#生命周期切换超时" target="_blank">LIFECYCLE_TIMEOUT 生命周期切换超时检测</a>。</p> <div class="tiledSection"><h3 id="section191407416213">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section191407416213" tips="复制节点链接"></i></h3></div> <p>用户在打开云笔记时应用卡死后闪退。</p> <div class="tiledSection"><h3 id="section152436114216">问题代码<i class="anchor-icon anchor-icon-link" anchorid="section152436114216" tips="复制节点链接"></i></h3></div> <p>在循环中同步获取云图。</p> <div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L42-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">xxxFunction1</span>(<span class="hljs-variable">fileUris</span> : <span class="hljs-title class_">string</span>[]): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">fileuri</span> <span class="hljs-variable">of</span> <span class="hljs-variable">fileUris</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">fileuri</span>, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_ONLY</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-comment">// 如果使用同步操作，需要考虑到容器弱网或无网等极端情况发生</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L42-L49" target="_blank">appfreezecase.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1752141715214">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section1752141715214" tips="复制节点链接"></i></h3></div> <p>详见<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-freeze-way#section1950514261110">应用冻屏类问题定位步骤与思路</a>。</p> <div class="tiledSection"><h3 id="section114414561128">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section114414561128" tips="复制节点链接"></i></h3></div> <p>提取故障关键信息：</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">sysfreeze</span>: <span class="hljs-title class_">LIFECYCLE_TIMEOUT</span> <span class="hljs-title class_">LIFECYCLE_TIMEOUT</span> <span class="hljs-title class_">at</span> <span class="hljs-number">20240201100459</span></li></ol></pre></div></div> <p>查看MSG信息：<strong>foreground timeout，对应时长为 5s</strong>。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">MSG</span> = </li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">time</span>:<span class="hljs-number">2024</span>/<span class="hljs-number">02</span>/<span class="hljs-number">01</span>-<span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">57</span></li><li><span class="hljs-variable">ability</span>:<span class="hljs-title class_">MainAbility</span> <span class="hljs-title class_">foreground</span> <span class="hljs-title class_">timeout</span>.</li><li><span class="hljs-variable">server</span>:</li><li><span class="hljs-number">312522</span>; <span class="hljs-variable">AbilityRecord</span>::<span class="hljs-title class_">ForegroundAbility</span>; <span class="hljs-title class_">the</span> <span class="hljs-title class_">ForegroundAbility</span> <span class="hljs-title class_">lifecycle</span> <span class="hljs-title class_">starts</span>.</li><li><span class="hljs-variable">client</span>:</li><li><span class="hljs-number">312522</span>; <span class="hljs-variable">AbilityThread</span>::<span class="hljs-title class_">ScheduleAbilityTransaction</span>; <span class="hljs-title class_">the</span> <span class="hljs-title class_">foreground</span> <span class="hljs-title class_">lifecycle</span>.</li></ol></pre></div></div> <p>LIFECYCLE_HALF_TIMEOUT 上报时间为<strong>10:04:57:538</strong>；</p> <p>LIFECYCLE_TIMEOUT 上报时间为<strong>10:04:59:965</strong>；相隔约2.5s，符合预期。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</li><li><span class="hljs-variable">DOMAIN</span>:<span class="hljs-title class_">AAFWK</span></li><li><span class="hljs-variable">STRINGID</span>:<span class="hljs-title class_">LIFECYCLE_TIMEOUT</span></li><li><span class="hljs-variable">TIMESTAMP</span>:<span class="hljs-number">2024</span>/<span class="hljs-number">02</span>/<span class="hljs-number">01</span>-<span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">59</span>:<span class="hljs-number">965</span></li><li><span class="hljs-variable">PID</span>:<span class="hljs-number">18083</span></li><li><span class="hljs-variable">UID</span>:<span class="hljs-number">20020041</span></li><li><span class="hljs-variable">PACKAGE_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">notepad</span></li><li><span class="hljs-variable">PROCESS_NAME</span>:<span class="hljs-title class_">com</span>.<span class="hljs-title class_">example</span>.<span class="hljs-title class_">notepad</span></li><li>*******************************************</li><li><span class="hljs-variable">start</span> <span class="hljs-variable">time</span>: <span class="hljs-number">2024</span>/<span class="hljs-number">02</span>/<span class="hljs-number">01</span>-<span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">57</span>:<span class="hljs-number">555</span></li><li><span class="hljs-variable">DOMAIN</span> = <span class="hljs-variable">AAFWK</span></li><li><span class="hljs-variable">EVENTNAME</span> = <span class="hljs-variable">LIFECYCLE_HALF_TIMEOUT</span></li><li><span class="hljs-variable">TIMESTAMP</span> = <span class="hljs-number">2024</span>/<span class="hljs-number">02</span>/<span class="hljs-number">01</span>-<span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">57</span>:<span class="hljs-number">538</span></li><li><span class="hljs-variable">PID</span> = <span class="hljs-number">18083</span></li><li><span class="hljs-variable">UID</span> = <span class="hljs-number">20020041</span></li><li><span class="hljs-variable">TID</span> = <span class="hljs-number">17286</span></li><li><span class="hljs-variable">PACKAGE_NAME</span> = <span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">notepad</span></li><li><span class="hljs-variable">PROCESS_NAME</span> = <span class="hljs-variable">com</span>.<span class="hljs-variable">example</span>.<span class="hljs-variable">notepad</span></li></ol></pre></div></div> <p>任务开始的时间为<strong>10:04:54.778</strong>，离LIFECYCLE_HALF_TIMEOUT相隔约2.5s，符合预期。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">mainHandler</span> <span class="hljs-variable">dump</span> <span class="hljs-keyword">is</span>:</li><li> <span class="hljs-variable">EventHandler</span> <span class="hljs-variable">dump</span> <span class="hljs-variable">begin</span> <span class="hljs-variable">curTime</span>: <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">57.306</span></li><li> <span class="hljs-variable">Event</span> <span class="hljs-variable">runner</span> (<span class="hljs-variable">Thread</span> <span class="hljs-variable">name</span> = , <span class="hljs-variable">Thread</span> <span class="hljs-variable">ID</span> = <span class="hljs-number">18083</span>) <span class="hljs-keyword">is</span> <span class="hljs-variable">running</span></li><li> <span class="hljs-variable">Current</span> <span class="hljs-variable">Running</span>: <span class="hljs-title class_">start</span> <span class="hljs-title class_">at</span> <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.798</span>, <span class="hljs-variable">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18132</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.778</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.778</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = <span class="hljs-variable">UIAbilityThread</span>:<span class="hljs-title class_">SendResult</span> }</li><li> <span class="hljs-variable">History</span> <span class="hljs-variable">event</span> <span class="hljs-variable">queue</span> <span class="hljs-variable">information</span>:</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">0</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18083</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">46.481</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">46.981</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">46.982</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">46.982</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> =  }</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">1</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18132</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.149</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.149</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.149</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.197</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> = <span class="hljs-variable">MainThread</span>:<span class="hljs-title class_">BackgroundApplication</span> }</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">2</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18083</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">44.329</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.329</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.329</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">47.329</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> =  }</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">3</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18087</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">48.091</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">48.091</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">48.091</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">48.091</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> =  }</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">4</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18087</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">51.047</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">51.047</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">51.048</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">51.048</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> =  }</li><li> <span class="hljs-variable">No</span>. <span class="hljs-number">5</span> : <span class="hljs-title class_">Event</span> { <span class="hljs-variable">send</span> <span class="hljs-variable">thread</span> = <span class="hljs-number">18087</span>, <span class="hljs-variable">send</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.067</span>, <span class="hljs-variable">handle</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.067</span>, <span class="hljs-variable">trigger</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.067</span>, <span class="hljs-variable">completeTime</span> <span class="hljs-variable">time</span> = <span class="hljs-number">2024</span>-<span class="hljs-number">02</span>-<span class="hljs-number">01</span> <span class="hljs-number">10</span>:<span class="hljs-number">04</span>:<span class="hljs-number">54.067</span>, <span class="hljs-variable">task</span> <span class="hljs-variable">name</span> =  }</li><li> ...</li></ol></pre></div></div> <p>查看对应的堆栈信息：libfs.z.so-&gt;libdatashare_consumer.z.so-&gt;libipc_core.z.so。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-rust" data-highlighted="yes"><ol class="linenums"><li>Tid:<span class="hljs-number">18083</span>, Name:ei.example.notepad</li><li># <span class="hljs-number">00</span> pc <span class="hljs-number">00000000001617</span>a4 /system/lib/ld-musl-aarch64.so.<span class="hljs-number">1</span>(ioctl+<span class="hljs-number">180</span>)(<span class="hljs-number">4</span>ca73cff61bea7c4a687eb0f71c9df69)</li><li># <span class="hljs-number">01</span> pc <span class="hljs-number">000000000003e8</span>a0 /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::BinderConnector::<span class="hljs-title function_ invoke__">WriteBinder</span>(unsigned long, void*)+<span class="hljs-number">72</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">02</span> pc <span class="hljs-number">0000000000049</span>f38 /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::BinderInvoker::<span class="hljs-title function_ invoke__">TransactWithDriver</span>(<span class="hljs-type">bool</span>)+<span class="hljs-number">296</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">03</span> pc <span class="hljs-number">00000000000496</span>f8 /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::BinderInvoker::<span class="hljs-title function_ invoke__">WaitForCompletion</span>(OHOS::MessageParcel*, int*)+<span class="hljs-number">116</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">04</span> pc <span class="hljs-number">00000000000490</span>bc /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::BinderInvoker::<span class="hljs-title function_ invoke__">SendRequest</span>(int, unsigned int, OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;, OHOS::MessageOption&amp;)+<span class="hljs-number">312</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">05</span> pc <span class="hljs-number">0000000000027700</span> /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPCObjectProxy::<span class="hljs-title function_ invoke__">SendRequestInner</span>(<span class="hljs-type">bool</span>, unsigned int, OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;, OHOS::MessageOption&amp;)+<span class="hljs-number">132</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">06</span> pc <span class="hljs-number">000000000002799</span>c /system/lib64/platformsdk/libipc_core.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::IPCObjectProxy::<span class="hljs-title function_ invoke__">SendRequest</span>(unsigned int, OHOS::MessageParcel&amp;, OHOS::MessageParcel&amp;, OHOS::MessageOption&amp;)+<span class="hljs-number">140</span>)(<span class="hljs-number">3248</span>fceb1fa676994734e0437430ce37)</li><li># <span class="hljs-number">07</span> pc <span class="hljs-number">000000000002640</span>c /system/lib64/platformsdk/libdatashare_consumer.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::DataShare::DataShareProxy::<span class="hljs-title function_ invoke__">OpenFile</span>(OHOS::Uri <span class="hljs-keyword">const</span>&amp;, std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">440</span>)(e93b5085235269d4b7218ea7de64b69a)</li><li># <span class="hljs-number">08</span> pc <span class="hljs-number">0000000000014</span>b2c /system/lib64/platformsdk/libdatashare_consumer.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::DataShare::ExtSpecialController::<span class="hljs-title function_ invoke__">OpenFile</span>(OHOS::Uri <span class="hljs-keyword">const</span>&amp;, std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">160</span>)(e93b5085235269d4b7218ea7de64b69a)</li><li># <span class="hljs-number">09</span> pc <span class="hljs-number">0000000000022</span>c54 /system/lib64/platformsdk/libdatashare_consumer.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::DataShare::DataShareHelperImpl::<span class="hljs-title function_ invoke__">OpenFile</span>(OHOS::Uri&amp;, std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;)+<span class="hljs-number">96</span>)(e93b5085235269d4b7218ea7de64b69a)</li><li># <span class="hljs-number">10</span> pc <span class="hljs-number">0000000000108</span>b34 /system/lib64/module/file/libfs.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::FileManagement::ModuleFileIO::<span class="hljs-title function_ invoke__">OpenFileByDatashare</span>(std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;, unsigned int)+<span class="hljs-number">468</span>)(<span class="hljs-number">152580</span>bf9c379f11f29fdded278541bd)</li><li># <span class="hljs-number">11</span> pc <span class="hljs-number">0000000000108264</span> /system/lib64/module/file/libfs.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::FileManagement::ModuleFileIO::<span class="hljs-title function_ invoke__">OpenFileByUri</span>(std::__h::basic_string&lt;<span class="hljs-type">char</span>, std::__h::char_traits&lt;<span class="hljs-type">char</span>&gt;, std::__h::allocator&lt;<span class="hljs-type">char</span>&gt;&gt; <span class="hljs-keyword">const</span>&amp;, unsigned int)+<span class="hljs-number">1760</span>)(<span class="hljs-number">152580</span>bf9c379f11f29fdded278541bd)</li><li># <span class="hljs-number">12</span> pc <span class="hljs-number">00000000001077</span>fc /system/lib64/module/file/libfs.z.<span class="hljs-title function_ invoke__">so</span>(OHOS::FileManagement::ModuleFileIO::Open::<span class="hljs-title function_ invoke__">Sync</span>(napi_env__*, napi_callback_info__*) (.cfi)+<span class="hljs-number">1036</span>)(<span class="hljs-number">152580</span>bf9c379f11f29fdded278541bd)</li><li># <span class="hljs-number">13</span> pc <span class="hljs-number">000000000002</span>bbf8 /system/lib64/platformsdk/libace_napi.z.<span class="hljs-title function_ invoke__">so</span>(<span class="hljs-title function_ invoke__">ArkNativeFunctionCallBack</span>(panda::JsiRuntimeCallInfo*)+<span class="hljs-number">168</span>)(f5b81db475835ee752235c606b1c5e33)</li><li># <span class="hljs-number">14</span> pc <span class="hljs-number">0000000000132e48</span> /system/lib64/module/arkcompiler/stub.an</li></ol></pre></div></div> <p>通过binder可以看出与5235进程通信时长大于2.5s，符合预期。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">PeerBinderCatcher</span> -- <span class="hljs-variable">pid</span>==<span class="hljs-number">18083</span> <span class="hljs-variable">layer_</span> == <span class="hljs-number">1</span></li><li>
</li><li><span class="hljs-variable">BinderCatcher</span> --</li><li>
</li><li>    <span class="hljs-number">18083</span>:<span class="hljs-number">18083</span> <span class="hljs-title class_">to</span> <span class="hljs-number">5235</span>:<span class="hljs-number">7437</span> <span class="hljs-title class_">code</span> <span class="hljs-number">2</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">2.723147396</span> <span class="hljs-title class_">s</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">18083</span>:<span class="hljs-number">18083</span> <span class="hljs-title class_">to</span> <span class="hljs-number">5235</span>:<span class="hljs-number">7437</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">3462</span>:<span class="hljs-number">3840</span> <span class="hljs-title class_">to</span> <span class="hljs-number">4956</span>:<span class="hljs-number">4958</span> <span class="hljs-title class_">code</span> <span class="hljs-number">8</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">261.213830169</span> <span class="hljs-title class_">s</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">3462</span>:<span class="hljs-number">3840</span> <span class="hljs-title class_">to</span> <span class="hljs-number">4956</span>:<span class="hljs-number">4958</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li><li>    <span class="hljs-number">3462</span>:<span class="hljs-number">3621</span> <span class="hljs-title class_">to</span> <span class="hljs-number">4956</span>:<span class="hljs-number">4981</span> <span class="hljs-title class_">code</span> <span class="hljs-number">8</span> <span class="hljs-title class_">wait</span>:<span class="hljs-number">273.550283291</span> <span class="hljs-title class_">s</span>,  <span class="hljs-variable">ns</span>:-<span class="hljs-number">1</span>:-<span class="hljs-number">1</span> <span class="hljs-title class_">to</span> -<span class="hljs-number">1</span>:-<span class="hljs-number">1</span>, <span class="hljs-variable">debug</span>:<span class="hljs-number">3462</span>:<span class="hljs-number">3621</span> <span class="hljs-title class_">to</span> <span class="hljs-number">4956</span>:<span class="hljs-number">4981</span>, <span class="hljs-variable">active_code</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">active_thread</span>:<span class="hljs-number">0</span>, <span class="hljs-variable">pending_async_proc</span>=<span class="hljs-number">0</span></li></ol></pre></div></div> <p>5235是媒体库进程，该堆栈无有效信息。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-shell" data-highlighted="yes"><ol class="linenums"><li>Binder catcher stacktrace, type is peer, pid : 5235</li><li>Result: 0 ( no error )</li><li>Timestamp:2024-02-01 10:04:57.000</li><li>Pid:5235</li><li>Uid:20020079</li><li>Process name:com.medialibrary.medialibrarydata</li><li>Tid:5235, Name:edialibrarydata</li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">00 pc 0000000000142d1c /system/lib/ld-musl-aarch64.so.1(epoll_wait+84)(4ca73cff61bea7c4a687eb0f71c9df69)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">01 pc 000000000000fb74 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EpollIoWaiter::WaitFor(std::__h::unique_lock&lt;std::__h::mutex&gt;&amp;, long)+224)(a4d21072c08fd3ac639d5cf5b8fb8b51)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">02 pc 0000000000019df8 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EventQueue::WaitUntilLocked(std::__h::chrono::time_point&lt;std::__h::chrono::steady_clock, std::__h::chrono::duration&lt;long long, std::__h::ratio&lt;1l, 1000000000l&gt;&gt;&gt; const&amp;, std::__h::unique_lock&lt;std::__h::mutex&gt;&amp;)+180)(a4d21072c08fd3ac639d5cf5b8fb8b51)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">03 pc 0000000000019c6c /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EventQueue::GetEvent()+128)(a4d21072c08fd3ac639d5cf5b8fb8b51)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">04 pc 00000000000202b8 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::(anonymous namespace)::EventRunnerImpl::Run()+1164)(a4d21072c08fd3ac639d5cf5b8fb8b51)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">05 pc 0000000000022388 /system/lib64/chipset-pub-sdk/libeventhandler.z.so(OHOS::AppExecFwk::EventRunner::Run()+120)(a4d21072c08fd3ac639d5cf5b8fb8b51)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">06 pc 000000000007ea08 /system/lib64/platformsdk/libappkit_native.z.so(OHOS::AppExecFwk::MainThread::Start()+772)(183fe2babcfdd3e1ea4bca16a0e26a5d)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">07 pc 0000000000011ac8 /system/bin/appspawn(RunChildProcessor+236)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">08 pc 0000000000034684 /system/bin/appspawn(AppSpawnChild+264)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">09 pc 00000000000344f4 /system/bin/appspawn(AppSpawnProcessMsg+380)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">10 pc 00000000000305a0 /system/bin/appspawn(OnReceiveRequest+1820)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">11 pc 0000000000017c58 /system/lib64/chipset-pub-sdk/libbegetutil.z.so(HandleRecvMsg_+260)(22f33d1b0218f31bad0dcc75cf348b90)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">12 pc 00000000000178fc /system/lib64/chipset-pub-sdk/libbegetutil.z.so(HandleStreamEvent_+148)(22f33d1b0218f31bad0dcc75cf348b90)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">13 pc 0000000000015478 /system/lib64/chipset-pub-sdk/libbegetutil.z.so(ProcessEvent+112)(22f33d1b0218f31bad0dcc75cf348b90)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">14 pc 0000000000015090 /system/lib64/chipset-pub-sdk/libbegetutil.z.so(RunLoop_+308)(22f33d1b0218f31bad0dcc75cf348b90)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">15 pc 000000000002eff4 /system/bin/appspawn(AppSpawnRun+116)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">16 pc 000000000001f438 /system/bin/appspawn(main+724)(7b715884c45cfe57b22df46fdaeeca88)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">17 pc 00000000000a0974 /system/lib/ld-musl-aarch64.so.1(libc_start_main_stage2+64)(4ca73cff61bea7c4a687eb0f71c9df69)</span></li><li><span class="hljs-meta prompt_"># </span><span class="language-bash">18 pc 000000000001106c /system/bin/appspawn(_start_c+76)(7b715884c45cfe57b22df46fdaeeca88)</span></li></ol></pre></div></div> <p>以上可以得到信息：应用通过文件系统Open::Sync同步通过uri加载文件，调用datashare请求媒体库文件数据。</p> <p>查看对应时间点的流水信息：进程调用datashare加载云图后卡死，与堆栈信息吻合。</p> <p><span><img originheight="820" originwidth="1626" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163452.57170640782638831369357409836751:50001231000000:2800:C6BB887387409725906D38FD1D8D17D5351F86358237B2BE6F2BB5D596C2C2DE.png" width="920" height="463.96063960639606"></span>查看具体代码：</p> <p>在循环中同步加载fileUri是不合理的，当弱网环境或者同时加载大量数据时，极易出现卡死情况，应用侧需进行整改。</p> <div class="tiledSection"><h3 id="section76421481333">修复方法<i class="anchor-icon anchor-icon-link" anchorid="section76421481333" tips="复制节点链接"></i></h3></div> <p>同步加载改为异步加载，并使用标志位标识是否加载完毕，用户界面展示加载中效果。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">xxxFunction1</span>(<span class="hljs-variable">fileUris</span> : <span class="hljs-title class_">string</span>[]): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">fileuri</span> <span class="hljs-variable">of</span> <span class="hljs-variable">fileUris</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span> = <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">fileuri</span>, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_ONLY</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>} <span class="hljs-comment">// 如果使用同步操作，需要考虑到容器弱网或无网等极端情况发生</span></li></ol></pre></div></div> <p>修改为：</p> <div class="screenLinkPre"><div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L53-L61" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">xxxFunction2</span>(<span class="hljs-params">fileUris : <span class="hljs-built_in">string</span>[]</span>) : <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-property">setOrCreate</span>&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-string">'isLoadingPic'</span>, <span class="hljs-literal">true</span>); <span class="hljs-comment">// 用于页面 load 效果展示</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> fileuri <span class="hljs-keyword">of</span> fileUris) {</li><li>        <span class="hljs-keyword">let</span> file = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">openSync</span>(fileuri, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>); <span class="hljs-comment">// 改为异步加载</span></li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppFreeze/entry/src/main/ets/pages/appfreezecase.ets#L53-L61" target="_blank">appfreezecase.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1962561819312">建议与总结<i class="anchor-icon anchor-icon-link" anchorid="section1962561819312" tips="复制节点链接"></i></h3></div> <ol><li>请求云侧数据需要验证充分，包括有网、弱网和无网场景下；</li><li>不要在应用生命周期函数中做耗时操作。</li></ol> <div class="tiledSection"><h2 id="section14613940236">资源高负载类典型案例<i class="anchor-icon anchor-icon-link" anchorid="section14613940236" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section221145113314" class="firsth2">概述<i class="anchor-icon anchor-icon-link" anchorid="section221145113314" tips="复制节点链接"></i></h3></div> <p>该类问题一般由于整机资源问题导致进程执行慢或没有执行，从而出现应用冻屏（AppFreeze）问题。</p> <div class="tiledSection"><h3 id="section157065913314">问题现象<i class="anchor-icon anchor-icon-link" anchorid="section157065913314" tips="复制节点链接"></i></h3></div> <p>进程执行慢或者不执行，导致出现无响应。</p> <div class="tiledSection"><h3 id="section0296546">分析思路<i class="anchor-icon anchor-icon-link" anchorid="section0296546" tips="复制节点链接"></i></h3></div> <p>遇到此类问题时，需要结合AppFreeze日志中的日志信息和HiLog流水分析。具体而言就是发生故障时间段内故障进行HiLog打印不多，且故障日志获取的信息之间时间间隔较久，可以怀疑是整机资源出现问题。</p> <div class="tiledSection"><h3 id="section36588201946">分析步骤<i class="anchor-icon anchor-icon-link" anchorid="section36588201946" tips="复制节点链接"></i></h3></div> <p>查看CPU 故障时间内1min、5min和15min的平均负载（Load average）,该数值越大表示此时整机负载越高，数值越接近100表明负载越高，超过100表明负载极高。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" data-highlighted="yes"><ol class="linenums"><li>Load average: <span class="hljs-number">129.</span> / <span class="hljs-number">82.1</span> / <span class="hljs-number">56.9</span>; the cpu <span class="hljs-built_in">load</span> average <span class="hljs-keyword">in</span> <span class="hljs-number">1</span> <span class="hljs-built_in">min</span>, <span class="hljs-number">5</span> <span class="hljs-built_in">min</span> <span class="hljs-keyword">and</span> <span class="hljs-number">15</span> <span class="hljs-built_in">min</span></li></ol></pre></div></div> <p>查看整机剩余可用内存信息（ReclaimAvailBuffer），数值越小表明此时整机可用内存越少，一般低于1G就会出现由于低内存造成的freeze场景。</p> <div _ngcontent-pbl-c106="" class="highlight-div"><div _ngcontent-pbl-c106="" class="highlight-div-header"><div _ngcontent-pbl-c106="" class="highlight-div-header-left"><div _ngcontent-pbl-c106="" class="handle-button expand-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pbl-c106="" class="highlight-div-header-right"><div _ngcontent-pbl-c106="" class="handle-button ai-button"></div><div _ngcontent-pbl-c106="" class="handle-button line-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pbl-c106="" class="handle-button theme-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pbl-c106="" class="handle-button copy-button"><div _ngcontent-pbl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pbl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">MemoryCatcher</span> --</li><li><span class="hljs-variable">some</span> <span class=""><span class="hljs-variable">avg10</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">avg60</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">avg300</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">total</span></span>=<span class="hljs-number">69</span></li><li><span class="hljs-variable">full</span> <span class=""><span class="hljs-variable">avg10</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">avg60</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">avg300</span></span>=<span class="hljs-number">69.85</span> <span class=""><span class="hljs-variable">total</span></span>=<span class="hljs-number">69</span></li><li><span class="hljs-comment">//...</span></li><li><span class="hljs-variable">ReclaimAvailBuffer</span>:                    <span class="hljs-number">6914048</span> <span class="hljs-title class_">kB</span></li><li><span class="hljs-comment">//...</span></li></ol></pre></div></div> </div> <div></div></div>