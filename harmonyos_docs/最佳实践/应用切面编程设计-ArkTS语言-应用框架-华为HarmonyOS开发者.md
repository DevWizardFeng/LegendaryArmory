<h1 _ngcontent-mri-c119="" class="doc-title ng-star-inserted" title="应用切面编程设计"> 应用切面编程设计 </h1>

<div _ngcontent-mri-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7148435113516">概述<i class="anchor-icon anchor-icon-link" anchorid="section7148435113516" tips="复制节点链接"></i></h2><p>切面编程（AOP）通过预编译和运行期间的动态代理来实现程序功能的统一维护。AOP将程序的关注点分离，通过插入代码实现横切关注点，从而隔离业务逻辑的各个部分，降低耦合度，提高可维护性和可重用性，进而提升开发效率。</p> <p>在AOP中，定义切面（aspect）封装横切关注点，无需直接修改业务逻辑代码。这种方式在不修改源代码的前提下添加功能，常用于剥离业务代码和非业务代码，如参数校验、日志记录、性能统计等，以实现更好的代码解耦。</p> <p>HarmonyOS主要通过插桩机制来实现切面编程，并提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-util#aspect11" target="_blank">Aspect类</a>，该类包含addBefore()、addAfter()和replace()接口。这些接口允许在运行时对类方法进行前置插桩、后置插桩和替换实现，为开发者提供了更加灵活的操作方式。在具体业务场景中，不同的需求可能需要不同的埋点功能和日志记录。通过调用addBefore()、addAfter()和replace()接口，可以实现对类方法的各种功能增强和定制化需求：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section087691214917">方法参数校验</a>，可以在方法执行前或执行后进行参数校验，确保参数和返回值的合法性。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section2641205324412">统计方法执行次数、时间</a>，可以在方法执行前后插入统计逻辑，记录执行时间和次数。通过组合使用addBefore()和addAfter()接口，可以方便地实现方法执行情况的监控和统计，为性能优化提供数据支持。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section1160718122503">校验方法返回值</a>，可以对方法的返回值进行校验。在addAfter()的回调参数中，第二个参数为原方法的返回值，可校验该返回值。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section9742181635910">在方法中校验成员变量</a>，在方法执行时，检查成员变量以确保数据完整和准确，从而及时发现并处理潜在问题。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section188512613119">替换方法实现</a>，使用AOP的replace()接口，动态替换原有方法的实现逻辑。这种机制可在不改变原有方法调用的情况下，实现方法功能的替换或增强，便于项目功能扩展。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section7971133114214">替换子类继承的方法实现</a>，可以利用replace()接口以子类为targetClass参数，替换子类方法的实现。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section636212218413">拉起应用时获取目标包名信息</a>，可以在应用启动时获取并记录目标包名信息。通过调用addBefore()接口，实现应用启动过程的监控和记录，为性能优化和故障排查提供帮助。</li><li><a href="/consumer/cn/doc/best-practices/bpta-application-aspect-programming-design#section8383163112217">对系统SDK的接口插桩</a>，通过使用addBefore()接口，可以对系统SDK的接口进行插桩或者替换。</li></ul> <p>本文将介绍对应接口的基本原理，并具体说明如何在上述业务场景中使用运行时插桩接口对类方法进行埋点和添加日志。</p> </div> <div class="tiledSection"><h2 id="section1269109184313">插桩原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section1269109184313" tips="复制节点链接"></i></h2><p>addBefore()、addAfter()、replace()接口的原理基于class的ECMAScript语义，即类的静态方法是类的属性，类的实例方法是类的原型对象(prototype)的属性。</p> <div class="fignone"><span class="figcap"><b>图1 </b>class的ECMAScript语义示意</span><br><span><img height="412.96500000000003" originheight="655" originwidth="829" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163020.77657498561311360035461986564997:50001231000000:2800:940528EFB889722AAB2C22DC7F695F83817B2B80251DC1F1B59AB14BD96F7D7E.png" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h3 id="section1637913716383" class="firsth2">原理解析<i class="anchor-icon anchor-icon-link" anchorid="section1637913716383" tips="复制节点链接"></i></h3><p>类的实例有一个属性__proto__（称为原型），它是指向类的prototype的引用，如图2所示。实例调用方法时，会通过__proto__找到类的prototype，再在prototype中找到方法并执行。类的原型对象prototype被所有实例共享，因此修改原型对象中的方法会影响所有实例。</p> <div class="fignone"><span class="figcap"><b>图2 </b>类的实例化示意</span><br><span><img height="411.96750000000003" originheight="667" originwidth="847" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163020.24594836409314884856284234584084:50001231000000:2800:CE23F813C5B9B4BDCFBB0103BE81E512199DC904122A92772BA41423DED3C7D5.png" title="点击放大" width="523.6875"></span></div> <p>原型对象也有原型_proto_。类的继承通过原型实现。实例方法调用时，会在原型链上查找方法，找到后执行调用。具体如图3所示。</p> <div class="fignone"><span class="figcap"><b>图3 </b>类的原型与继承</span><br><span><img height="307.423515" originheight="721" originwidth="1267" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163020.32116204200983116380913567542730:50001231000000:2800:8C226210F7CA8737EAC8A32D9AB18A2F7EC803CB3E322A4C56348F00F9D93FE1.png" title="点击放大" width="535.6575"></span></div> <p>插桩和替换的操作是将回调参数与原方法组合成新函数，再用新函数替换原方法。具体如图4所示。</p> <div class="fignone"><span class="figcap"><b>图4 </b>插桩和替换原理示意图</span><br><span><img height="370.087529" originheight="754" originwidth="1099" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163021.17444377065504992900818980956046:50001231000000:2800:BE281D8CF2ADC5CC42B11E491B1A0396F9177BB28192538961612BDBEC501BC6.png" title="点击放大" width="536.655"></span></div> </div> <div class="tiledSection"><h3 id="section5291113010525">接口原理的伪代码示例<i class="anchor-icon anchor-icon-link" anchorid="section5291113010525" tips="复制节点链接"></i></h3><p><strong>addBefore: 类方法前插桩</strong></p> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L25-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Instrument before class method execution</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">addBefore</span>(targetClass, methodName, isStatic, before): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">let</span> target =  isStatic ? targetClass : targetClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;</li><li>  <span class="hljs-keyword">let</span> origin = target[methodName];</li><li>  <span class="hljs-comment">// Define a new function that first executes "before" and then executes the old method.</span></li><li>  <span class="hljs-keyword">let</span> newFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {</li><li>    <span class="hljs-title function_">before</span>(<span class="hljs-variable language_">this</span>, ...args);</li><li>    <span class="hljs-keyword">return</span> origin.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)(...args);</li><li>  }</li><li>  <span class="hljs-comment">// Replace the method with a new function</span></li><li>  target[methodName] = newFunc;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L25-L36" target="_blank">MethodDecorator.ts</a></div></div></div></div> <p><strong>addAfter: 类方法后插桩</strong></p> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L40-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Instrument after class method execution</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">addAfter</span>(targetClass, methodName, isStatic, after) : <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">let</span> target =  isStatic ? targetClass : targetClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;</li><li>  <span class="hljs-keyword">let</span> origin = target[methodName];</li><li>  <span class="hljs-comment">// Define a new function that first executes the old method, then executes after.</span></li><li>  <span class="hljs-keyword">let</span> newFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {</li><li>    <span class="hljs-keyword">let</span> ret = origin.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>)(...args);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">after</span>(<span class="hljs-variable language_">this</span>, ret, ...args);</li><li>  }</li><li>  <span class="hljs-comment">// Replace the method with a new function</span></li><li>  target[methodName] = newFunc;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L40-L51" target="_blank">MethodDecorator.ts</a></div></div></div></div> <p><strong>replace: 替换类方法</strong></p> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L55-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">replace</span>(targetClass, methodName, isStatic, instead) : <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">let</span> target =  isStatic ? targetClass : targetClass.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;</li><li>  <span class="hljs-comment">// Define a new function that only executes "instead" inside.</span></li><li>  <span class="hljs-keyword">let</span> newFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">instead</span>(<span class="hljs-variable language_">this</span>, ...args);</li><li>  }</li><li>  <span class="hljs-comment">// Replace the method with a new function</span></li><li>  target[methodName] = newFunc;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/MethodDecorator.ts#L55-L63" target="_blank">MethodDecorator.ts</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section087691214917">场景1：方法参数校验<i class="anchor-icon anchor-icon-link" anchorid="section087691214917" tips="复制节点链接"></i></h2><p>业务开发团队忽略了参数的合法性，运维团队发现了这一问题，需要紧急修复。由于让业务开发团队修改的流程较为复杂，运维团队决定临时通过插桩的方式为方法添加参数合法性校验的逻辑。</p> <p>业务开发团队开发了基础能力模块，并将能力封装在类A中。在应用集成基础能力模块时，发现需要对类A的方法加入参数校验逻辑，以应对非法输入。因此，运维团队决定在临时修复过程中，通过插桩的方式临时添加参数合法性校验逻辑，以确保系统的稳定性和安全性。</p> </div> <div class="tiledSection"><h3 id="section6807379497" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section6807379497" tips="复制节点链接"></i></h3><p>在addBefore()接口的回调参数中，可以访问原方法的参数，因此可以利用addBefore()在方法前插入参数校验逻辑。这是运行时行为，需要在addBefore()执行后生效，通常在应用入口调用该接口进行插桩。</p> </div> <div class="tiledSection"><h3 id="section124421652144912">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section124421652144912" tips="复制节点链接"></i></h3><ol><li><span>在class A中，封装其基础能力，此处为获取数组指定下标的元素。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/baseAbility.ts#L21-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// baseAbility.ts</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">A</span> {</li><li>  <span class="hljs-title class_">getElementByIndex</span>&lt;<span class="hljs-title class_">T</span>&gt;(<span class="hljs-variable">arr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">T</span>&gt;, <span class="hljs-variable">idx</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">T</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">arr</span>[<span class="hljs-variable">idx</span>];</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/baseAbility.ts#L21-L26" target="_blank">baseAbility.ts</a></div></div></div></div> <p></p></li><li><span>在主界面中集成基础能力，并校验参数类型、判断下标是否越界。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index.ets#L20-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { A } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/baseAbility'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li>
</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(A, <span class="hljs-string">'getElementByIndex'</span>, <span class="hljs-literal">false</span>,</li><li>  <span class="hljs-comment">// Check the parameters</span></li><li>  <span class="hljs-function">(<span class="hljs-params">instance: A, arr: <span class="hljs-built_in">Object</span>, idx: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (!(arr <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Array</span>)) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'arg arr is expected to be an array'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!(<span class="hljs-title class_">Number</span>.<span class="hljs-title function_">isInteger</span>(idx) &amp;&amp; idx &gt;= <span class="hljs-number">0</span>)) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'arg idx is expected to be a non-negative integer'</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (idx &gt;= arr.<span class="hljs-property">length</span>) {</li><li>      <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'arg idx is expected to be smaller than arr.length'</span>);</li><li>    }</li><li>  });</li><li><span class="hljs-comment">// The original method is executed</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">buffer</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>];</li><li><span class="hljs-keyword">let</span> that = <span class="hljs-keyword">new</span> <span class="hljs-title function_">A</span>();</li><li>that.<span class="hljs-title function_">getElementByIndex</span>(buffer, -<span class="hljs-number">1</span>);</li><li>that.<span class="hljs-title function_">getElementByIndex</span>(buffer, <span class="hljs-number">5</span>);</li><li>that.<span class="hljs-title function_">getElementByIndex</span>(<span class="hljs-number">123</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Object</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt;, <span class="hljs-number">5</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index.ets#L20-L50" target="_blank">Index.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section2641205324412">场景2：统计方法执行次数、时间<i class="anchor-icon anchor-icon-link" anchorid="section2641205324412" tips="复制节点链接"></i></h2><p>在性能分析或调试场景中，性能管控团队需统计应用运行过程中调用某个方法的次数或执行时间。如果要求业务开发团队临时修改源代码并重新打包，效率低下且业务团队可能无法提供足够的人力支持。因此，性能管控团队需临时插入一个插桩，以获取所需信息。</p> </div> <div class="tiledSection"><h3 id="section388951818488" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section388951818488" tips="复制节点链接"></i></h3><p>在方法前插入调用次数自增的逻辑，addBefore()可用于统计调用次数。执行时间统计时，使用addBefore()记录开始时间，addAfter()记录结束时间。</p> <p>利用闭包变量或覆盖每次执行的变量存储执行次数和时间。</p> </div> <div class="tiledSection"><h3 id="section9492163084816">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9492163084816" tips="复制节点链接"></i></h3><ol><li><span>统计执行次数。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L21-L24" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// somePackage.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>){}</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L21-L24" target="_blank">somePackage.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index1.ets#L22-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Test</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/somePackage'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li>util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">toString</span>();</li><li><span class="hljs-comment">// increment call count</span></li><li><span class="hljs-keyword">let</span> countFoo = <span class="hljs-number">0</span>;</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-title class_">Test</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  countFoo++;</li><li>});</li><li><span class="hljs-comment">// Invoke and print logs</span></li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>().<span class="hljs-title function_">foo</span>();</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countFoo = '</span>, countFoo);</li><li><span class="hljs-comment">// [LOG]: "countFoo = ", 1</span></li><li><span class="hljs-keyword">let</span> a = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>();</li><li>a.<span class="hljs-title function_">foo</span>()</li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countFoo = '</span>, countFoo);</li><li><span class="hljs-comment">// [LOG]: "countFoo = ", 2</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params">a: Test</span>) {</li><li>  a.<span class="hljs-title function_">foo</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countFoo = '</span>, countFoo);</li><li>  <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>().<span class="hljs-title function_">foo</span>();</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countFoo = '</span>, countFoo);</li><li>}</li><li><span class="hljs-title function_">bar</span>(a);</li><li><span class="hljs-comment">// [LOG]: "countFoo = ", 3</span></li><li><span class="hljs-comment">// [LOG]: "countFoo = ", 4</span></li><li><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'countFoo = '</span>, countFoo);</li><li><span class="hljs-comment">// [LOG]: "countFoo = ", 4</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index1.ets#L22-L57" target="_blank">Index1.ets</a></div></div></div></div> <p></p></li><li><span>统计执行时间。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage1.ets#L21-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// somePackage1.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> {</li><li>  <span class="hljs-title function_">doSomething</span>(<span class="hljs-params"></span>) { <span class="hljs-comment">// instance method</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">test</span>(<span class="hljs-params"></span>) { <span class="hljs-comment">// static method</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage1.ets#L21-L29" target="_blank">somePackage1.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index2.ets#L21-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index2.ets</span></li><li><span class="hljs-keyword">import</span> {util} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Test1</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/somePackage1'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// Print the time before and after the insertion, and encapsulate the insertion action into an interface</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">addTimePrinter</span>(<span class="hljs-params">targetClass: <span class="hljs-built_in">Object</span>, methodName: <span class="hljs-built_in">string</span>, isStatic: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">let</span> t1 = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> t2 = <span class="hljs-number">0</span>;</li><li>  util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(targetClass, methodName, isStatic, <span class="hljs-function">() =&gt;</span> {</li><li>    t1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>  });</li><li>  util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addAfter</span>(targetClass, methodName, isStatic, <span class="hljs-function">() =&gt;</span> {</li><li>    t2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"t2---t1 = "</span> + (t2 - t1).<span class="hljs-title function_">toString</span>());</li><li>  });</li><li>}</li><li><span class="hljs-comment">// Add the logic for printing the execution time to the doSomething instance method of Test</span></li><li><span class="hljs-title function_">addTimePrinter</span>(<span class="hljs-title class_">Test1</span>, <span class="hljs-string">'doSomething'</span>, <span class="hljs-literal">false</span>);</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Test1</span>().<span class="hljs-title function_">doSomething</span>()</li><li><span class="hljs-comment">// Add the logic for printing the execution time to the test static method of the test</span></li><li><span class="hljs-title function_">addTimePrinter</span>(<span class="hljs-title class_">Test1</span>, <span class="hljs-string">'test'</span>, <span class="hljs-literal">true</span>);</li><li><span class="hljs-title class_">Test1</span>.<span class="hljs-title function_">test</span>()</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index2.ets#L21-L49" target="_blank">Index2.ets</a></div></div></div></div> <p></p></li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>不推荐使用该方式统计多个线程执行的函数，以免造成方法次数变量或执行时间变量的写冲突。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section1160718122503">场景3：校验方法返回值<i class="anchor-icon anchor-icon-link" anchorid="section1160718122503" tips="复制节点链接"></i></h2><p>在应用中使用三方库提供的方法时，建议对方法的返回值进行校验。</p> </div> <div class="tiledSection"><h3 id="section16389121365813" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section16389121365813" tips="复制节点链接"></i></h3><p>在addAfter的回调参数中，第二个参数为原方法的返回值，可校验该返回值。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>addAfter回调返回值会代替原方法的返回值。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section1984193711583">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1984193711583" tips="复制节点链接"></i></h3><ol><li><span>对三方库方法返回的网址进行校验，校验不通过的抛出异常。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/someThirdParty.ets#L21-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// someThirdParty.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebHandler</span> {</li><li>  <span class="hljs-title function_">getWebAddrHttps</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> ret = <span class="hljs-string">'http'</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span> ret;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/someThirdParty.ets#L21-L28" target="_blank">someThirdParty.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index3.ets#L21-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> {util} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">WebHandler</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/someThirdParty'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addAfter</span>(<span class="hljs-title class_">WebHandler</span>, <span class="hljs-string">'getWebAddrHttps'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: WebHandler, ret: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (!ret.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'https'</span>)) {</li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Handler\'s method \'getWebAddrHttps\': return value does not start with \'https\''</span>);</li><li>  }</li><li>  <span class="hljs-comment">// Verification is correct, remember to return the original method's return value.</span></li><li>  <span class="hljs-keyword">return</span> ret;</li><li>});</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">WebHandler</span>().<span class="hljs-title function_">getWebAddrHttps</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index3.ets#L21-L39" target="_blank">Index3.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section9742181635910">场景4：在方法中校验成员变量<i class="anchor-icon anchor-icon-link" anchorid="section9742181635910" tips="复制节点链接"></i></h2><p>在方法执行时，检查成员变量以确保数据完整和准确，从而及时发现并处理潜在问题。</p> </div> <div class="tiledSection"><h3 id="section13717223307" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section13717223307" tips="复制节点链接"></i></h3><p>在addBefore()的回调参数中，第一个参数是原方法的this对象，可以获取成员变量或调用成员方法，实现对成员变量的实时监测和校验。</p> </div> <div class="tiledSection"><h3 id="section142542422019">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section142542422019" tips="复制节点链接"></i></h3><ol><li><span>在getInfo()方法中校验Person类的name和age属性是否正常。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L28-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// somePackage.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">n: <span class="hljs-built_in">string</span>, a: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = n;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = a;</li><li>  }</li><li>  <span class="hljs-title function_">getInfo</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'name: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">', '</span> + <span class="hljs-string">'age: '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>.<span class="hljs-title function_">toString</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L28-L39" target="_blank">somePackage.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index4.ets#L21-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> {util} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Person</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/somePackage'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// Verify the name and age members</span></li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-title class_">Person</span>, <span class="hljs-string">'getInfo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: Person</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">name</span>.<span class="hljs-property">length</span> == <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'empty name'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">age</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">throw</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'invalid age'</span>);</li><li>  }</li><li>});</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'c'</span>, -<span class="hljs-number">1</span>).<span class="hljs-title function_">getInfo</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index4.ets#L21-L41" target="_blank">Index4.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section188512613119">场景5：替换方法实现<i class="anchor-icon anchor-icon-link" anchorid="section188512613119" tips="复制节点链接"></i></h2><p>在特定情况下需要对原方法进行替换，以确保应用程序的正常运行和性能优化。例如，方法的实现调用了禁用的接口，或者方法的性能表现不佳需要进行改进。</p> </div> <div class="tiledSection"><h3 id="section349812521818" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section349812521818" tips="复制节点链接"></i></h3><p>replace()的第四个参数是回调函数，该回调函数会代替原方法执行。回调函数的第一个参数是this对象，从第二个参数开始依次是原方法的参数。通过replace()的回调参数，可以获取原方法的所有执行上下文，从而实现对原方法执行过程的全面控制和定制。</p> </div> <div class="tiledSection"><h3 id="section121021481222">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section121021481222" tips="复制节点链接"></i></h3><ol><li><span>修改foo()方法中的打印日志。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L43-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Test2</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params">arg: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/somePackage.ets#L43-L47" target="_blank">somePackage.ets</a></div></div></div></div> <div class="p"><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index5.ets#L21-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> {util} <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Test2</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/somePackage'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UI code</span></li><li>  }</li><li>}</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Test2</span>().<span class="hljs-title function_">foo</span>(<span class="hljs-string">'123'</span>);</li><li><span class="hljs-comment">// [LOG]: "123"</span></li><li><span class="hljs-comment">// replace the original method</span></li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-title class_">Test2</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: Test2, arg: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arg + <span class="hljs-string">' __replaced implementation'</span>);</li><li>});</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Test2</span>().<span class="hljs-title function_">foo</span>(<span class="hljs-string">'123'</span>);</li><li><span class="hljs-comment">// [LOG]: "123 __replaced implementation"</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index5.ets#L21-L39" target="_blank">Index5.ets</a></div></div></div></div> </div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section7971133114214">场景6：替换子类继承的方法实现<i class="anchor-icon anchor-icon-link" anchorid="section7971133114214" tips="复制节点链接"></i></h2><p>子类调用父类方法时，如果需要修改子类的方法实现，应确保不影响父类，从而避免影响其他继承该父类的子类。</p> </div> <div class="tiledSection"><h3 id="section189714183310" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section189714183310" tips="复制节点链接"></i></h3><p>利用replace()接口以子类为targetClass参数，替换子类方法的实现。</p> <p>这一操作的底层原理是基于JavaScript的原型链机制。通过replace()接口，新函数会被放置到子类的原型上。这样当执行子类的方法时，原型链机制会首先在子类原型上查找新函数来执行，而不会执行父类的方法，也不会影响到父类的其他子类。</p> </div> <div class="tiledSection"><h3 id="section684214016314">案例一：替换子类一方法实现<i class="anchor-icon anchor-icon-link" anchorid="section684214016314" tips="复制节点链接"></i></h3><ol><li><span>Base有两个子类Child1和Child2，两个子类都继承了foo()方法。需要修改Child1的foo()的实现，但不影响Base和Child2的foo()方法。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/base.ts#L24-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// base.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Base</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/base.ts#L24-L29" target="_blank">base.ts</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child1.ts#L20-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// child1</span></li><li><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Base</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base</span> {}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child1.ts#L20-L22" target="_blank">child1.ts</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child2.ts#L20-L24" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// child.ets</span></li><li><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Base</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">'./base'</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base</span> {</li><li>  <span class="hljs-comment">// Inherit the getCurrentLocation method of the parent class</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child2.ts#L20-L24" target="_blank">child2.ts</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h3 id="section665210312461">案例二：获取实时位置信息<i class="anchor-icon anchor-icon-link" anchorid="section665210312461" tips="复制节点链接"></i></h3><ol><li><span>Child类继承了Base类的获取实时位置方法，但测试发现Child类的getCurrentLocation()方法在实际场景中调用非常频繁，需要控制调用频率。采取的措施是修改Child类的getCurrentLocation()方法的实现，通过缓存位置信息来减少系统接口的调用次数。具体实现为：如果从上次调用到现在的时间不足60秒，则直接返回缓存的位置信息；否则，调用系统接口获取新的位置信息并更新缓存。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/base.ts#L21-L38" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.LocationKit"</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Base1</span> {</li><li>  <span class="hljs-title function_">getCurrentLocation</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> geoLocationManager.<span class="hljs-title function_">getCurrentLocation</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/base.ts#L21-L38" target="_blank">base.ts</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child.ts#L21-L25" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// child.ets</span></li><li><span class="hljs-keyword">import</span> {<span class="hljs-title class_">Base1</span>} <span class="hljs-keyword">from</span> <span class="hljs-string">"./base"</span>;</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Base1</span> {</li><li>  <span class="hljs-comment">// inherit the getCurrentLocation method from the parent class</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/child.ts#L21-L25" target="_blank">child.ts</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index7.ets#L21-L45" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// index.ets</span></li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">"@kit.LocationKit"</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Child</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/child'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// UIcode</span></li><li>  }</li><li>}</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">cached_location</span>: <span class="hljs-title class_">Object</span> | <span class="hljs-literal">undefined</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">time</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>;</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-title class_">Child</span>, <span class="hljs-string">'getCurrentLocation'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> newTime = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>();</li><li>  <span class="hljs-comment">// Real-time location can be called at most once per minute.</span></li><li>  <span class="hljs-keyword">if</span> (!cached_location || !time || newTime - time &gt; <span class="hljs-number">60000</span>) {</li><li>    time = newTime;</li><li>    cached_location = geoLocationManager.<span class="hljs-title function_">getCurrentLocation</span>();</li><li>  }</li><li>  <span class="hljs-comment">// Return cached location information</span></li><li>  <span class="hljs-keyword">return</span> cached_location;</li><li>});</li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Child</span>().<span class="hljs-title function_">getCurrentLocation</span>()</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/Index7.ets#L21-L45" target="_blank">Index7.ets</a></div></div></div></div> <p></p></li></ol> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>访问设备的位置信息，必须申请以下权限，并且获得用户授权：</p> <ul><li>ohos.permission.LOCATION</li><li>ohos.permission.APPROXIMATELY_LOCATION</li></ul> <p>具体方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/request-user-authorization" target="_blank">向用户申请授权</a>。</p> </div></div></div> <div class="tiledSection"><h2 id="section636212218413">场景7：拉起应用时获取目标包名信息<i class="anchor-icon anchor-icon-link" anchorid="section636212218413" tips="复制节点链接"></i></h2><p>在应用跳转时，需获取目标应用的包名，以实现对目标应用的识别与监控，确保跳转操作的安全性和准确性。</p> </div> <div class="tiledSection"><h3 id="section95991755983" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section95991755983" tips="复制节点链接"></i></h3><p>在EntryAbility的onCreate()方法中，对UIAbilityContext类的startAbility()方法进行插桩，以获取Want参数的bundleName属性。由于UIAbilityContext是系统提供的类且没有导出，无法直接导入，因此可以通过EntryAbility的context成员（该成员从UIAbility继承而来）获取UIAbilityContext类对象，然后在onCreate()方法中完成插桩操作。这样可以实现对目标方法的监控和定制，以满足特定需求。</p> </div> <div class="tiledSection"><h3 id="section677815194915">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section677815194915" tips="复制节点链接"></i></h3><ol><li><span>通过类实例的constructor属性获取类对象。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/entryability/EntryAbility.ets#L21-L37" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// EntryAbility.ets</span></li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-comment">// Obtain the target package name</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">' onCreate'</span>);</li><li>    util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">constructor</span>, <span class="hljs-string">'startAbility'</span>, <span class="hljs-literal">false</span>,</li><li>      <span class="hljs-function">(<span class="hljs-params">instance: <span class="hljs-built_in">Object</span>, wantParam: Want</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'UIAbilityContext startAbility: want.bundleName is '</span> + wantParam.<span class="hljs-property">bundleName</span>);</li><li>      });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">startAbility</span>(want, <span class="hljs-function">() =&gt;</span> {})</li><li>  }</li><li>  <span class="hljs-comment">// Other related configurations</span></li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/entryability/EntryAbility.ets#L21-L37" target="_blank">EntryAbility.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section8383163112217">场景8： 对系统SDK的接口插桩<i class="anchor-icon anchor-icon-link" anchorid="section8383163112217" tips="复制节点链接"></i></h2><p>应用出于业务需求，可能需要对系统SDK的接口进行插桩或者替换。util.Aspect要求被插桩的是类和类方法，因此需要确保参数是运行时存在的类。</p> </div> <div class="tiledSection"><h3 id="section998311398" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section998311398" tips="复制节点链接"></i></h3><p>系统SDK的接口暴露有以下两种方式：</p> <ul><li>场景1：直接暴露类和类方法，外部通过类的实例化或者实例调用系统能力，如AppStorage、UIAbilityContext等。</li><li>场景2：声明namespace，并在namespace内暴露方法，如window、router等。</li></ul> <p>对于第一种场景，可以接将类名、类方法名传给util.Aspect。如果类未导出，仅有类的示例，可参考场景7，通过实例的构造方法返回传参。</p> <p>对于第二种场景，应用可以将该接口自行包装成类，再使用util.Aspect进行插桩。</p> </div> <div class="tiledSection"><h3 id="section106381613205115">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section106381613205115" tips="复制节点链接"></i></h3><ol><li><span>对于场景2，以window.createWindow()插桩为例，可以将window的相关需要插桩的方法封装成包装类，再对包装类进行插桩。</span><p></p><div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/WindowWrap.ets#L21-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// WindowWrap.ets</span></li><li>
</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowWrap</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">WindowWrap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WindowWrap</span>();</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">WindowWrap</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">createWindow</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">config</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Configuration</span> = {</li><li>      <span class="hljs-attr">name</span>: <span class="hljs-string">'test'</span>,</li><li>      <span class="hljs-attr">windowType</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">WindowType</span>.<span class="hljs-property">TYPE_DIALOG</span></li><li>    }</li><li>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">createWindow</span>(config, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// do something</span></li><li>    })</li><li>  }</li><li>}</li><li>
</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-title class_">WindowWrap</span>, <span class="hljs-string">'createWindow'</span>, <span class="hljs-literal">false</span>, (<span class="hljs-attr">instance</span>: <span class="hljs-title class_">WindowWrap</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'addBefore createWindow'</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/components/WindowWrap.ets#L21-L50" target="_blank">WindowWrap.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section146871458184520">附录：接口使用注意事项<i class="anchor-icon anchor-icon-link" anchorid="section146871458184520" tips="复制节点链接"></i></h2><ol><li>插桩的目标类通常需要导入。对于没有导出的场景，如果有实例，可以通过实例的constructor属性获取目标类。</li><li>插桩的目标方法名不得混淆，以确保插桩接口的正确运行。</li><li>对父类进行插桩会影响所有子类；对子类进行插桩不会影响父类（无论方法是否继承自父类），但会影响该子类的所有子类。</li><li>接口的第四个参数是回调函数，回调函数的第一个参数是执行方法调用的this对象。如果通过该对象调用原方法且没有退出机制，容易导致无限递归。若需调用原方法，建议在接口调用前将其存储起来。不推荐的用法如下示例。<div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index8.ets#L4-L11" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) {}</li><li>}</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-title class_">Test</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: Test</span>) =&gt;</span> {</li><li>  instance.<span class="hljs-title function_">foo</span>();</li><li>});</li><li><span class="hljs-comment">// Infinite recursion</span></li><li><span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>().<span class="hljs-title function_">foo</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index8.ets#L4-L11" target="_blank">index8.ets</a></div></div></div></div> <p>如果有需要调用原方法的场景，实现方法参考如下示例。</p> <div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index9.ets#L4-L12" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) {}</li><li>}</li><li><span class="hljs-comment">// Save the original method implementation first</span></li><li><span class="hljs-keyword">let</span> originalFoo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Test</span>().<span class="hljs-property">foo</span>;</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addBefore</span>(<span class="hljs-title class_">Test</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: Test</span>) =&gt;</span> {</li><li>  <span class="hljs-comment">// If the original method does not use this, you can directly call the originalFoo () method.</span></li><li>  <span class="hljs-comment">// If this is used in the original method, bind should be used to bind the instance, but there will be a compilation warning originalFoo.bind (instance);</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index9.ets#L4-L12" target="_blank">index9.ets</a></div></div></div></div> </li></ol><ol start="5"><li>不推荐对ArkUI的struct进行方法插桩、替换。因为ArkUI的struct从设计上是一种介于函数和类之间的特殊存在，在编译时会进行中间码的转换，该转换可能会导致开发态的对象、方法在运行时并不存在，导致插桩、替换失败。虽然目前struct底层实现是类，使用接口可能也不会导致编译报错，但是仍然不推荐对struct的方法插桩/替换实现，因为可能随着ArkUI的演进，底层实现会改变，从而导致一些难以预料的问题。以下代码是错误示例。<div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index10.ets#L4-L17" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Counterexample</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-title function_">foo</span>(<span class="hljs-params"></span>) {}</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {};</li><li>}</li><li>
</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-title class_">Index</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-title class_">Index</span>, <span class="hljs-string">'build'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index10.ets#L4-L17" target="_blank">index10.ets</a></div></div></div></div> </li></ol><ol start="6"><li>由于addAfter()的回调参数的返回值会劫持原方法的返回值，因此需要在回调参数中返回与原方法匹配的返回值。如果不修改返回值，请直接返回原方法的返回值（即回调参数的第二个参数）。<div class="screenLinkPre"><div _ngcontent-mri-c106="" class="highlight-div"><div _ngcontent-mri-c106="" class="highlight-div-header"><div _ngcontent-mri-c106="" class="highlight-div-header-left"><div _ngcontent-mri-c106="" class="handle-button expand-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-mri-c106="" class="highlight-div-header-right"><div _ngcontent-mri-c106="" class="handle-button ai-button"></div><div _ngcontent-mri-c106="" class="handle-button line-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-mri-c106="" class="handle-button theme-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-mri-c106="" class="handle-button copy-button"><div _ngcontent-mri-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-mri-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index10.ets#L21-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Example of unrecommended usage:</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test</span> {</li><li>  <span class="hljs-title function_">foo</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'hello'</span>;</li><li>  }</li><li>}</li><li>
</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addAfter</span>(<span class="hljs-title class_">Test</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'execute foo'</span>);</li><li>});</li><li>
</li><li><span class="hljs-comment">// The correct usage example is as follows:</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Test1</span> {</li><li>  <span class="hljs-title function_">foo</span>(): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'hello'</span>;</li><li>  }</li><li>}</li><li>
</li><li>util.<span class="hljs-property">Aspect</span>.<span class="hljs-title function_">addAfter</span>(<span class="hljs-title class_">Test1</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-literal">false</span>, <span class="hljs-function">(<span class="hljs-params">instance: Test, ret: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'execute foo'</span>);</li><li>  <span class="hljs-keyword">return</span> ret; <span class="hljs-comment">// Return the return value of the original method</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/AppAspectProgrammingDesign/entry/src/main/ets/pages/index10.ets#L21-L42" target="_blank">index10.ets</a></div></div></div></div> </li></ol><ol start="7"><li>接口不限制对系统提供的类方法进行插桩。只要类和方法在运行时是实际存在的对象，并且方法的属性描述符的writable字段为true，就可以使用对应接口进行插桩和替换。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果类方法的属性描述符的writable字段为false，比如冻结(freeze) 的场景， 则不能调用接口操作这个类方法。</p> <p>方法的属性描述符的writable字段默认为true。</p> </div></div></div> </li><li>使用Aspect类接口进行插桩，对AoT和JIT编译后的性能没有明显影响。</li></ol> </div> </div> <div></div></div>