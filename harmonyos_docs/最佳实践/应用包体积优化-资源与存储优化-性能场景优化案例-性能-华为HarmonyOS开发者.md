<h1 _ngcontent-ped-c119="" class="doc-title ng-star-inserted" title="应用包体积优化"> 应用包体积优化 </h1>

<div _ngcontent-ped-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section6472195261717">概述<i class="anchor-icon anchor-icon-link" anchorid="section6472195261717" tips="复制节点链接"></i></h2><p>减小应用包大小可以提升应用下载和安装体验。压缩、精简或复用代码和资源可以有效降低应用包体积。在优化包大小前，先了解HarmonyOS应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-package-structure-stage" target="_blank">Stage模型应用程序包结构</a>，对HAP、HAR、HSP等特点建立一定认知，然后使用扫描工具分析App包，根据报告优化应用。具体优化方法可以参考以下内容：</p> <ol><li>对于含有so库的App工程，可以配置so库压缩选项，以减小应用包大小。</li><li>在应用存在多包（HAP、HSP）的场景中，可以使用HSP动态共享包在多个包（HAP、HSP）之间共享代码和资源，消除使用HAR静态共享包导致的代码和资源重复拷贝，从而减小应用包大小，同时开发者需要综合评估对编译性能的影响：大量使用HSP替代HAR，会在编译引用这些HSP共享包的模块时触发更多的语言编译任务，导致编译耗时、编译内存占用增加。</li><li>使用ohpm的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-oh-package-json5#zh-cn_topic_0000001792256137_overrides" target="_blank">override</a>机制或开启 `<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpmrc#section368717475562" target="_blank">resolve_conflict</a>` 解决依赖冲突，减少依赖包导致的重复编译问题。</li><li>将不常用的功能作为按需加载的模块。</li></ol> </div> <div class="tiledSection"><h2 id="section1660158101012">使用扫描工具分析App大小问题<i class="anchor-icon anchor-icon-link" anchorid="section1660158101012" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-check-tool" target="_blank">扫描工具</a>可用于分析检测应用包，根据不同的参数设定，扫描指定路径的App、HAP、HSP包内容并输出检测结果报告，为开发者优化包结构或排查问题提供数据支撑。</p> <p>根据扫描结果优化应用：</p> <div class="p">1. 重复文件<ul><li>删除同一包内的重复资源。多包（HAP、HSP）间重复资源，可以使用HSP实现资源的复用，参考<a href="/consumer/cn/doc/best-practices/bpta-decrease_pakage_size#section13745162092020">多包情况下使用hsp共享代码及资源</a>。</li></ul> </div> <p>2. 较大文件</p> <ul><li>确认应用是否必需，是否可以删除。</li><li>JPG、PNG、GIF等文件，可以考虑压缩图片。</li></ul> <p>3. 特定类型的文件</p> <p>so文件，通过<a href="/consumer/cn/doc/best-practices/bpta-decrease_pakage_size#section15826132851819">配置so库压缩选项</a>来实现压缩打包。</p> </div> <div class="tiledSection"><h2 id="section1286810176182">减小应用包大小的方法<i class="anchor-icon anchor-icon-link" anchorid="section1286810176182" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section15826132851819" class="firsth2">配置so库压缩选项<i class="anchor-icon anchor-icon-link" anchorid="section15826132851819" tips="复制节点链接"></i></h3><p>DevEco Studio 默认在打包应用时不压缩 so 库文件。配置 so 压缩选项后，DevEco Studio 将 so 库文件压缩并打包到应用中，从而减小应用包的大小。</p> <p><strong>配置方法</strong></p> <p>修改应用模块配置文件module.json5中的compressNativeLibs字段，将值配置为true，重新编译、打包应用。</p> <div _ngcontent-ped-c106="" class="highlight-div"><div _ngcontent-ped-c106="" class="highlight-div-header"><div _ngcontent-ped-c106="" class="highlight-div-header-left"><div _ngcontent-ped-c106="" class="handle-button expand-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ped-c106="" class="highlight-div-header-right"><div _ngcontent-ped-c106="" class="handle-button ai-button"></div><div _ngcontent-ped-c106="" class="handle-button line-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ped-c106="" class="handle-button theme-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ped-c106="" class="handle-button copy-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ped-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: { </li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"compressNativeLibs"</span>: <span class="hljs-keyword">true</span> <span class="hljs-comment">// Identify whether the so library is packaged in compressed storage. ’true’ means compressed so library, ’false’ means non-compressed.</span></li><li>  }</li><li>}</li></ol></pre></div></div> </div> <p><strong>so压缩效果</strong></p> <p>以DevEco Studio中的C++默认库文件为例，展示压缩前后的文件大小对比：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.1" valign="top" width="41.65%"><p>文件名</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.2" valign="top" width="25.55%"><p>原始大小</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.3" valign="top" width="15.9%"><p>压缩后大小</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.1.5.1.4" valign="top" width="16.900000000000002%"><p>压缩率</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="41.65%"><p>armeabi-v7a/libc++_shared.so</p> </td> <td class="cellrowborder" valign="top" width="25.55%"><p>1108k</p> </td> <td class="cellrowborder" valign="top" width="15.9%"><p>386k</p> </td> <td class="cellrowborder" valign="top" width="16.900000000000002%"><p>34%</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section11931132644217">解决依赖减少依赖包重复编译<i class="anchor-icon anchor-icon-link" anchorid="section11931132644217" tips="复制节点链接"></i></h3><p>对于ohpm 1.5.0之前的版本，如果hap依赖了不同版本的har（例如下图中的V1版本的harC和V2版本的harC），默认情况下，V1和V2两个版本的harC都会被打包到hap中。开发者可以使用ohpm的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-oh-package-json5#zh-cn_topic_0000001792256137_overrides" target="_blank">override</a>机制，指定只打包一个版本。</p> </div> <p><span><img height="309.888404" originheight="433" originwidth="538" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163416.63332419673193849619515389635568:50001231000000:2800:9E5C62017E3EC66EE65C8A47776D6C42E7B152150D5A0E8874CD5F403B136C24.png" title="点击放大" width="385.035"></span></p> <p>如果使用的是ohpm 1.4.0 版本，可以使用override机制，开发者可以在项目级别的 oh-package.json5 （即项目根目录下的 oh-package.json5）文件中添加 overrides 配置，将依赖树中的依赖替换为另一个版本。替换的版本既可以是一个具体的版本号，也可以是本地存在的HAR包或源码目录。</p> <p><strong>注意：</strong></p> <p>必须在项目级别的 oh-package.json5 中配置 overrides，配置在模块级别的 oh-package.json5 中不会生效。</p> <p>例如， 这里以 'foo' 库为例，如果在项目中始终需要使用'1.0.0'版本，可在项目级的 oh-package.json5 中添加以下配置：</p> <div _ngcontent-ped-c106="" class="highlight-div"><div _ngcontent-ped-c106="" class="highlight-div-header"><div _ngcontent-ped-c106="" class="highlight-div-header-left"><div _ngcontent-ped-c106="" class="handle-button expand-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ped-c106="" class="highlight-div-header-right"><div _ngcontent-ped-c106="" class="handle-button ai-button"></div><div _ngcontent-ped-c106="" class="handle-button line-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ped-c106="" class="handle-button theme-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ped-c106="" class="handle-button copy-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ped-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"overrides"</span>: {</li><li>    <span class="hljs-string">"foo"</span>: <span class="hljs-string">"1.0.0"</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p>若本地存在 foo 的源码或 HAR 包，确保 foo 始终使用本地版本，可在项目级 oh-package.json5 中进行如下配置：</p> <p>1、本地存在"foo"的源码，即配置项目根目录的的foo目录，以"file:./foo"标识其路径。</p> <div _ngcontent-ped-c106="" class="highlight-div"><div _ngcontent-ped-c106="" class="highlight-div-header"><div _ngcontent-ped-c106="" class="highlight-div-header-left"><div _ngcontent-ped-c106="" class="handle-button expand-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ped-c106="" class="highlight-div-header-right"><div _ngcontent-ped-c106="" class="handle-button ai-button"></div><div _ngcontent-ped-c106="" class="handle-button line-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ped-c106="" class="handle-button theme-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ped-c106="" class="handle-button copy-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ped-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"overrides"</span>: {</li><li>    <span class="hljs-string">"foo"</span>: <span class="hljs-string">"file:./foo"</span> </li><li>  }</li><li>}</li></ol></pre></div></div> <p>2、本地存在"foo.har"的HAR包，其存放在libs目录下，即配置"file:./libs/foo.har"。</p> <div _ngcontent-ped-c106="" class="highlight-div"><div _ngcontent-ped-c106="" class="highlight-div-header"><div _ngcontent-ped-c106="" class="highlight-div-header-left"><div _ngcontent-ped-c106="" class="handle-button expand-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ped-c106="" class="highlight-div-header-right"><div _ngcontent-ped-c106="" class="handle-button ai-button"></div><div _ngcontent-ped-c106="" class="handle-button line-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ped-c106="" class="handle-button theme-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ped-c106="" class="handle-button copy-button"><div _ngcontent-ped-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ped-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"overrides"</span>: {   </li><li>    <span class="hljs-string">"foo"</span>: <span class="hljs-string">"file:./libs/foo.har"</span></li><li>  }</li><li>}</li></ol></pre></div></div> <p></p> <p>对于1.5.0版本之后的ohpm，可以通过开启`<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-ohpmrc#section368717475562" target="_blank">resolve_conflict</a>`，自动解决依赖冲突。依赖冲突的处理策略为：当项目同时依赖某个三方库的不同版本时，ohpm会选择其中的最高版本进行安装。</p> <div class="tiledSection"><h3 id="section67903407613">按需分发<i class="anchor-icon anchor-icon-link" anchorid="section67903407613" tips="复制节点链接"></i></h3><p>对于应用中用户不常用的功能，可以考虑通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/store-moduleinstall" target="_blank">产品特性按需分发</a>的方式，将下载时机交由用户选择，使用时从应用市场获取安装，减少用户初次下载的包大小。</p> </div> <div class="tiledSection"><h3 id="section13745162092020">多包场景下使用HSP共享代码和资源<i class="anchor-icon anchor-icon-link" anchorid="section13745162092020" tips="复制节点链接"></i></h3><p>当前系统提供了两种共享包：HAR静态共享包和HSP动态共享包。HAR和HSP都用于实现代码和资源的共享，可以包含代码、C++库、资源和配置文件。HAR中的代码和资源跟随使用方编译，如果有多个使用方，编译产物中会存在多份相同拷贝。HSP中的代码和资源可以独立编译，在运行时进程中只存在一份。</p> <p>在多包场景下，如果应用的多个HAP或HSP包使用HAR包实现代码和资源的共享，打包后的每个HAP或HSP包中都会包含共享HAR包的拷贝，导致App包中存在冗余代码和资源。如下图示例，应用模块HAP1和HAP2/HSP1都引用了HAR2和HAR3，打包后，App包中HAR2和HAR3有多份重复拷贝，体积较大。</p> <p><span><img height="175.56" originheight="303" originwidth="899" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163416.59131518031991628741560571305543:50001231000000:2800:AC79C105CB2C810C86A7D2379E2EAC2A6836ECA6121F4F07129A310C6547378E.png" title="点击放大" width="523.6875"></span></p> <p>推荐使用HSP代替HAR实现代码和资源共享。如下图示例，使用HSP2对原应用进行升级改造，打包后，APP包中HAR2和HAR3仅保留一份拷贝。当HAR2和HAR3的总大小超过HSP时，可以减小应用包大小。</p> <p><span><img height="204.4875" originheight="352" originwidth="900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163416.41542338927114758717341813064503:50001231000000:2800:8C9374F472706E44668827CBD139FB2FB42358B7A03DC9986DEFA73573F2BA35.png" title="点击放大" width="523.6875"></span></p> </div> </div> <div></div></div>