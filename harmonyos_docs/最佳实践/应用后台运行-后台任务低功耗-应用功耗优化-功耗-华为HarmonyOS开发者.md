<h1 _ngcontent-fpx-c119="" class="doc-title ng-star-inserted" title="应用后台运行"> 应用后台运行 </h1>

<div _ngcontent-fpx-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section11031352143716">概述<i class="anchor-icon anchor-icon-link" anchorid="section11031352143716" tips="复制节点链接"></i></h2><p>为有效降低设备耗电量并确保用户体验流畅，系统会对后台应用进行管理，包括进程挂起和终止。当应用处于音乐播放或地图导航等场景时，如果用户将应用退至后台、锁屏或切换应用，系统会自动将应用转入后台运行。为确保应用在后台期间仍能正常使用，系统提供了符合规范的后台任务机制。本文将介绍应用切后台的常见问题及解决方案，并通过分析应用短暂切换前后台和后台长时间运行的开发实践案例，指导开发者如何有效使用后台任务处理冻结场景，从而确保应用在前后台之间能够流畅切换。</p> </div> <p><strong>应用后台规格建议</strong></p> <p>当前系统将对切换至后台的应用程序所使用的资源进行严格管控，具体措施包括挂起和终止进程。如果不进行后台处理，可能会导致应用程序功能异常。请参考官网指南和最佳实践文档，了解具体的限制条件和建议。</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/standard-background-hardware" target="_blank">后台硬件资源使用建议</a>、<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-use-of-background-hardware-resources" target="_blank">后台硬件资源最佳实践</a>：后台进程CPU负载约束（长时任务、短时任务）；应用退到后台无长时任务时使用蓝牙、网络资源、麦克风或者扬声器、GPS资源；退到后台禁止使用传感器。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/standard-background-software" target="_blank">后台软件资源使用建议</a>、<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-use-of-background-software-resources" target="_blank">后台软件资源最佳实践</a>：后台合理使用上传下载、使用音频服务、使用定位导航服务、使用系统资源。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview" target="_blank">Background Tasks Kit简介（后台任务开发服务指南）</a>：后台任务的功能介绍、资源使用约束、后台任务类型。</li></ul> <div class="tiledSection"><h2 id="section5506141605412">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section5506141605412" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section83543711194" class="firsth2">后台任务类型<i class="anchor-icon anchor-icon-link" anchorid="section83543711194" tips="复制节点链接"></i></h3><p>标准系统支持规范内受约束的后台任务，包括短时任务、长时任务、延迟任务、代理提醒。开发者可以根据如下介绍，选择合适的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview#后台任务类型" target="_blank">后台任务</a>，以满足应用退至后台后继续运行的需求。</p> <p><span><img height="146.63250000000002" originheight="358" originwidth="1275" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163442.92027022267852772605362270800537:50001231000000:2800:D5DD7DD19A01B24E8DA86393DF2241BDE5F88F1053798D0EDA0646EE364E5C2C.png" title="点击放大" width="523.6875"></span></p> <p>以下表格对比总结了各类后台任务的概念、适用场景以及任务执行过程中的应用状态。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.5.1.6.1.1" valign="top" width="26.790000000000003%"><p>适用场景</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.6.1.2" valign="top" width="25.21%"><p>概念</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.6.1.3" valign="top" width="10.489999999999998%"><p>常见问题</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.6.1.4" valign="top" width="30.869999999999997%"><p>应用退至后台状态</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.5.1.6.1.5" valign="top" width="6.64%"><p>任务类型</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="26.790000000000003%"><p>不执行任何任务的后台场景：直接退至后台。</p> </td> <td align="left" class="cellrowborder" valign="top" width="25.21%"><p>不执行任何任务，直接退至后台。</p> </td> <td class="cellrowborder" valign="top" width="10.489999999999998%"><p>-</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.869999999999997%"><p>几秒后应用挂起。</p> </td> <td align="left" class="cellrowborder" valign="top" width="6.64%"><p>无后台</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26.790000000000003%"><p>任务类型：小文件下载、缓存、信息发送等时效性高、需要临时占用资源的任务。</p> </td> <td align="left" class="cellrowborder" valign="top" width="25.21%"><p>任务类型：实时性要求高、耗时不长的任务。</p> </td> <td class="cellrowborder" valign="top" width="10.489999999999998%"><p>应用短暂切换前后台，进程被挂起。</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.869999999999997%"><p>在单次配额内，应用不会被挂起直到取消任务。单次配额超时不取消，应用进程会被终止。</p> </td> <td align="left" class="cellrowborder" valign="top" width="6.64%"><p>短时任务</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26.790000000000003%"><p>任务类型：数据传输、音频播放、录音、定位导航、蓝牙、WLAN相关、多设备互联、音视频通话、计算任务。</p> </td> <td align="left" class="cellrowborder" valign="top" width="25.21%"><p>任务类型：长时间运行在后台且用户可感知的任务。</p> </td> <td class="cellrowborder" valign="top" width="10.489999999999998%"><p>应用后台长时间运行后会中断。</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.869999999999997%"><p>应用不会被挂起，直到任务取消。如果任务结束时不取消应用进程，进程会被终止。</p> </td> <td align="left" class="cellrowborder" valign="top" width="6.64%"><p>长时任务</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26.790000000000003%"><p>任务类型：软件更新、信息收集、数据处理等。</p> </td> <td align="left" class="cellrowborder" valign="top" width="25.21%"><p>任务类型：实时性要求不高、可延迟执行的任务。满足条件后，任务将放入执行队列，系统会根据内存和功耗进行统一调度。</p> </td> <td class="cellrowborder" valign="top" width="10.489999999999998%"><p>-</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.869999999999997%"><p>应用退到后台时会挂起，满足任务设定条件时由系统统一调度拉起应用，创建Extension进程执行任务。单次回调最长运行时间为2分钟，如果超时未取消，系统会终止对应的Extension进程。</p> </td> <td align="left" class="cellrowborder" valign="top" width="6.64%"><p>延迟任务</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="26.790000000000003%"><p>任务类型：闹钟、倒计时、日历。</p> </td> <td align="left" class="cellrowborder" valign="top" width="25.21%"><p>任务类型：系统代理应用做出相应提醒。</p> </td> <td class="cellrowborder" valign="top" width="10.489999999999998%"><p>-</p> </td> <td align="left" class="cellrowborder" valign="top" width="30.869999999999997%"><p>应用挂起或进程终止时，满足条件后系统会自动进行相应的提醒。</p> </td> <td align="left" class="cellrowborder" valign="top" width="6.64%"><p>代理提醒</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1676119578305">场景示例<i class="anchor-icon anchor-icon-link" anchorid="section1676119578305" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section246385503114" class="firsth2">应用短暂切换前后台，避免进程挂起<i class="anchor-icon anchor-icon-link" anchorid="section246385503114" tips="复制节点链接"></i></h3><p>在应用进行小文件下载、缓存、信息发送等业务场景时，如果应用短暂退至后台导致进程被挂起，重新切换到前台，可能因应用的前后台周期回调中存在业务代码逻辑，导致应用使用状态异常。此时，可以申请短时任务作为解决方案。以下示例展示了如何使用ApplicationContext订阅应用前后台切换的回调，以在应用切后台时申请短时任务，解决因短暂切换前后台导致的消息发送异常问题。</p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163442.93507679280512303508795789189043:50001231000000:2800:EED473264BDE5C13C742D9209EF051601D0398BF24A84118C714BD4A4C13670F.png" title="点击放大" width="266"></span></p> <ol><li>定义短时任务信息SuspendTaskInfo()接口，包括短时任务的ID和获取对应短时任务的剩余时间delayTime。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/SuspendTaskInfo.ets#L17-L20" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuspendTaskInfo</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span>; <span class="hljs-comment">// Short-time task ID</span></li><li>  <span class="hljs-variable">delayTime</span>: <span class="hljs-title class_">number</span>; <span class="hljs-comment">// The remaining time of this request short assignment</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/SuspendTaskInfo.ets#L17-L20" target="_blank">SuspendTaskInfo.ets</a></div></div></div></div> </li><li>在信息发送的场景中，当应用处于前台时，在onAppear()回调函数中启动一个定时器，每隔2秒发送一条消息，模拟后台业务。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/view/ShortTermTaskPage.ets#L53-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">NavDestination</span>() {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>.<span class="hljs-title function_">title</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">builderTitle</span>())</li><li>.<span class="hljs-title function_">onAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">shortTermTaskModel</span>.<span class="hljs-title function_">subscribeStateChange</span>();</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">taskTimer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">messageCount</span>++;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`already sent ：<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.messageCount}</span> messages`</span>);</li><li>  }, <span class="hljs-number">2000</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/view/ShortTermTaskPage.ets#L53-L96" target="_blank">ShortTermTaskPage.ets</a></div></div></div></div> </li><li>在信息发送的场景中，通过ApplicationContext.on('applicationStateChange')注册对当前应用前后台变化的监听。当应用退至后台时，触发onApplicationBackground()回调函数，在此回调函数中申请短时任务。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/ShortTermTaskModel.ets#L28-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Apply front - and back-end status monitoring</span></li><li><span class="hljs-title function_">subscribeStateChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> that = <span class="hljs-variable language_">this</span>;</li><li>  <span class="hljs-comment">// Gets applicationContext</span></li><li>  <span class="hljs-keyword">let</span> applicationContext = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-title function_">getApplicationContext</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">applicationStateChangeCallback</span>: <span class="hljs-title class_">ApplicationStateChangeCallback</span> = {</li><li>    <span class="hljs-title function_">onApplicationForeground</span>(<span class="hljs-params"></span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'applicationStateChangeCallback onApplicationForeground'</span>);</li><li>    },</li><li>    <span class="hljs-title function_">onApplicationBackground</span>(<span class="hljs-params"></span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'applicationStateChangeCallback onApplicationBackground'</span>);</li><li>      <span class="hljs-comment">// Apply for short-time tasks when the application changes from foreground to background</span></li><li>      that.<span class="hljs-property">suspendTaskInfo</span> = <span class="hljs-title class_">SuspendTaskUtils</span>.<span class="hljs-title function_">requestSuspendDelay</span>(<span class="hljs-string">'Suspend Task'</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>        <span class="hljs-string">`requestSuspendDelay, id:<span class="hljs-subst">${that.suspendTaskInfo.id}</span>, delayTime:<span class="hljs-subst">${that.suspendTaskInfo.delayTime}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Registers the background and pre - application status monitoring through applicationContext</span></li><li>    applicationContext.<span class="hljs-title function_">on</span>(<span class="hljs-string">'applicationStateChange'</span>, applicationStateChangeCallback);</li><li>  } <span class="hljs-keyword">catch</span> (paramError) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>,</li><li>      <span class="hljs-string">`error: <span class="hljs-subst">${(paramError <span class="hljs-keyword">as</span> BusinessError).code}</span>, <span class="hljs-subst">${(paramError <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/ShortTermTaskModel.ets#L28-L52" target="_blank">ShortTermTaskModel.ets</a></div></div></div></div> </li><li>在小文件下载、缓存、信息发送等场景中，应用退至后台时，可使用backgroundTaskManager.requestSuspendDelay()接口，后台应用申请短时任务。短时任务的申请和使用过程中的约束与限制请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/transient-task#约束与限制" target="_blank">指南</a>。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L25-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param reason Set the delay task suspension reason</span></li><li><span class="hljs-comment"> * @returns</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">requestSuspendDelay</span>(<span class="hljs-variable">reason</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">SuspendTaskInfo</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">id</span>: <span class="hljs-title class_">number</span>; <span class="hljs-comment">// Apply for a short-time task ID</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">delayTime</span>: <span class="hljs-title class_">number</span>; <span class="hljs-comment">// The remaining time of this request short assignment</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Request deferred task</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">delayInfo</span> = <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">requestSuspendDelay</span>(<span class="hljs-variable">reason</span>, () =&gt; {</li><li>      <span class="hljs-comment">// This function is used to call back the application when a short task requested by the application is about to time out.</span></li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Request</span> <span class="hljs-variable">suspension</span> <span class="hljs-variable">delay</span> <span class="hljs-variable">will</span> <span class="hljs-variable">time</span> <span class="hljs-variable">out</span>.`);</li><li>      <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">cancelSuspendDelay</span>(<span class="hljs-variable">delayInfo</span>.<span class="hljs-variable">requestId</span>);</li><li>    })</li><li>    <span class="hljs-variable">id</span> = <span class="hljs-variable">delayInfo</span>.<span class="hljs-variable">requestId</span>;</li><li>    <span class="hljs-variable">delayTime</span> = <span class="hljs-variable">delayInfo</span>.<span class="hljs-variable">actualDelayTime</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">taskInfo</span> = {</li><li>      <span class="hljs-variable">id</span>: <span class="hljs-title class_">id</span>,</li><li>      <span class="hljs-variable">delayTime</span>: <span class="hljs-title class_">delayTime</span></li><li>    } <span class="hljs-keyword">as</span> <span class="hljs-variable">SuspendTaskInfo</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">taskInfo</span>;</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">taskInfo</span> = {</li><li>      <span class="hljs-variable">id</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">delayTime</span>: <span class="hljs-number">0</span></li><li>    } <span class="hljs-keyword">as</span> <span class="hljs-variable">SuspendTaskInfo</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">taskInfo</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L25-L54" target="_blank">SuspendTaskUtils.ets</a></div></div></div></div> </li><li>应用返回前台后，调用backgroundTaskManager.getRemainingDelayTime()接口，获取对应短时任务的剩余时间。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L58-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">getRemainingDelayTime</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">delayTime</span>: <span class="hljs-built_in">number</span> = -<span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">await</span> backgroundTaskManager.<span class="hljs-title function_">getRemainingDelayTime</span>(id).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>    delayTime = res;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Operation getRemainingDelayTime succeeded. Data: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(res));</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Operation getRemainingDelayTime failed. Cause: '</span> + err.<span class="hljs-property">code</span>);</li><li>  });</li><li>  <span class="hljs-keyword">return</span> delayTime;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L58-L67" target="_blank">SuspendTaskUtils.ets</a></div></div></div></div> </li><li>应用退至后台，可调用backgroundTaskManager.cancelSuspendDelay()接口取消短时任务。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L71-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">cancelSuspendDelay</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    backgroundTaskManager.<span class="hljs-title function_">cancelSuspendDelay</span>(id);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'cancelSuspendDelay succeeded.'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`cancelSuspendDelay failed. Cause: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/utils/SuspendTaskUtils.ets#L71-L80" target="_blank">SuspendTaskUtils.ets</a></div></div></div></div> </li></ol> </div> <p><strong>实现效果</strong></p> <ul><li><strong>系统息屏场景/应用置于后台场景：</strong>前台应用在自动息屏后，会被识别为置于后台。此时，应用可以申请短时任务，剩余时长上限为3分钟（如下图所示，delayTime为18000ms）。<span><img originheight="197" originwidth="1252" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163442.62252752402313518143486880335093:50001231000000:2800:0297D0D75AF7E5958D1310B0BE065A856142806486465A64730FD181BC8CB536.png" width="920" height="144.76038338658148"></span></li><li>当短时任务的剩余时间不足时，系统会触发回调，停止任务。<span><img originheight="137" originwidth="1158" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163442.73600207770576027885076215228206:50001231000000:2800:D84C4FC85BD4CDAC8FC9C17CCF5B0AC705434045DD9F44B8629DAAF7AD1B96FD.png" width="920" height="108.84283246977547"></span></li></ul> <div class="tiledSection"><h3 id="section1939219588326">应用后台长时间运行不中断<i class="anchor-icon anchor-icon-link" anchorid="section1939219588326" tips="复制节点链接"></i></h3><p>当应用涉及数据传输、音频播放、录音操作、定位导航、蓝牙和WLAN相关应用、多设备互联、音视频通话、复杂计算任务等场景时，需要应用在后台长时间运行。为了确保应用在这些情况下正常运作，可以申请后台长时任务来实现。以下示例展示了如何使用长时任务管理应用的定位服务，以实现应用在后台长时间运行时，持续获取设备位置信息的功能。</p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163443.78759071040333947238306594526411:50001231000000:2800:B0ADD79E8BD9DBC6ADEA10AEFBB0DDBA9985B2C7884F4A89BF11005952F7C49B.png" title="点击放大" width="266"></span></p> <ol><li>在定位、导航类的应用场景下，为了确保应用在后台仍能使用定位服务，需在module.json5配置文件中为EntryAbility声明定位类型的长时任务，并申请定位相关权限。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/module.json5#L2-L110" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ets"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-string">"backgroundModes"</span>: [</li><li>          <span class="hljs-string">'location'</span></li><li>        ]</li><li>      }</li><li>    ],</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.LOCATION"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.LOCATION_IN_BACKGROUND"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.APPROXIMATELY_LOCATION"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/module.json5#L2-L110" target="_blank">module.json5</a></div></div></div></div> </li><li>应用跳转到定位功能页面，系统请求定位权限和网络访问权限。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L28-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Apply for location-related permissions</span></li><li><span class="hljs-title function_">requestPermissionsFromUser</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">atManager</span>: <span class="hljs-title class_">abilityAccessCtrl</span>.<span class="hljs-title class_">AtManager</span> = <span class="hljs-variable">abilityAccessCtrl</span>.<span class="hljs-title function_">createAtManager</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">permissionList</span>: <span class="hljs-title class_">Permissions</span>[] = [</li><li>    <span class="hljs-string">'ohos.permission.INTERNET'</span>,</li><li>    <span class="hljs-string">'ohos.permission.LOCATION'</span>,</li><li>    <span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span></li><li>  ];</li><li>  <span class="hljs-variable">atManager</span>.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">permissionList</span>)</li><li>    .<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">PermissionRequestResult</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">data</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">data</span>)}`);</li><li>    })</li><li>    .<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">requestPermissionsFromUser</span> <span class="hljs-variable">fail</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L28-L43" target="_blank">LongTermTaskModel.ets</a></div></div></div></div> </li><li>应用需获取位置信息，使用geoLocationManager.on('locationChange')接口，开启位置变化订阅并发起定位请求。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L47-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">locationCallback</span> = <span class="hljs-variable">async</span> (<span class="hljs-variable">location</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">Location</span>) =&gt; {</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">locationCallback</span>: <span class="hljs-title class_">data</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">location</span>)}`);</li><li>};</li><li>
</li><li><span class="hljs-comment">// Get the location</span></li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">getLocation</span>() {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">request</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">LocationRequest</span> = {</li><li>    <span class="hljs-variable">priority</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">LocationRequestPriority</span>.<span class="hljs-title class_">FIRST_FIX</span>, <span class="hljs-comment">// Quick location acquisition is preferred</span></li><li>    <span class="hljs-variable">scenario</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">LocationRequestScenario</span>.<span class="hljs-title class_">UNSET</span>, <span class="hljs-comment">// Indicates that no scenario information is set</span></li><li>    <span class="hljs-variable">timeInterval</span>: <span class="hljs-number">1</span>, <span class="hljs-comment">// Interval for reporting the location information</span></li><li>    <span class="hljs-variable">distanceInterval</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// Distance for reporting location information</span></li><li>    <span class="hljs-variable">maxAccuracy</span>: <span class="hljs-number">100</span> <span class="hljs-comment">// The precision value required when the application requests location information from the system</span></li><li>  };</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">geoLocationManager</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'locationChange'</span>, <span class="hljs-variable">request</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">locationCallback</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">errCode</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L47-L65" target="_blank">LongTermTaskModel.ets</a></div></div></div></div> </li><li>应用退至后台需持续运行时，应调用backgroundTaskManager.startBackgroundRunning()接口申请长时任务。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L69-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Start a long task</span></li><li><span class="hljs-title function_">startLongTask</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">actionType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITY</span>,</li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// wantAgent object is obtained by getWantAgent method in WantAgent module</span></li><li>    <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">wantAgentObj</span>: <span class="hljs-title class_">WantAgent</span>) =&gt; {</li><li>      <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-variable">BackgroundMode</span>.<span class="hljs-variable">LOCATION</span>,</li><li>        <span class="hljs-variable">wantAgentObj</span>)</li><li>        .<span class="hljs-title function_">then</span>(() =&gt; {</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Operation</span> <span class="hljs-variable">startBackgroundRunning</span> <span class="hljs-variable">succeeded</span>`);</li><li>        })</li><li>        .<span class="hljs-keyword">catch</span>((<span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>,</li><li>            `<span class="hljs-variable">Operation</span> <span class="hljs-variable">startBackgroundRunning</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>} <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>        });</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Operation</span> <span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">error</span>)} `);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L69-L99" target="_blank">LongTermTaskModel.ets</a></div></div></div></div> </li><li>在定位和导航类的应用场景中，当应用退出时，需调用geoLocationManager.off('locationChange')接口，关闭位置变化订阅。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-vbnet" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/view/LongTermTaskPage.ets#L77-L77" data-highlighted="yes"><ol class="linenums"><li>geoLocationManager.<span class="hljs-keyword">off</span>(<span class="hljs-comment">'locationChange');</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/view/LongTermTaskPage.ets#L77-L77" target="_blank">LongTermTaskPage.ets</a></div></div></div></div> </li><li>应用退出时，调用backgroundTaskManager.stopBackgroundRunning()接口，取消长时任务。<div class="screenLinkPre"><div _ngcontent-fpx-c106="" class="highlight-div"><div _ngcontent-fpx-c106="" class="highlight-div-header"><div _ngcontent-fpx-c106="" class="highlight-div-header-left"><div _ngcontent-fpx-c106="" class="handle-button expand-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fpx-c106="" class="highlight-div-header-right"><div _ngcontent-fpx-c106="" class="handle-button ai-button"></div><div _ngcontent-fpx-c106="" class="handle-button line-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fpx-c106="" class="handle-button theme-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fpx-c106="" class="handle-button copy-button"><div _ngcontent-fpx-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fpx-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L103-L110" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Stop a long task</span></li><li><span class="hljs-title function_">stopLongTask</span>(): <span class="hljs-keyword">void</span> {</li><li>  backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Operation stopBackgroundRunning succeeded`</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Operation stopBackgroundRunning failed. error is <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span> `</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BackTaskImplement/blob/master/entry/src/main/ets/viewModel/LongTermTaskModel.ets#L103-L110" target="_blank">LongTermTaskModel.ets</a></div></div></div></div> </li></ol> <p><strong>实现效果</strong></p> <ul><li>在定位和导航应用场景中，应用前台运行时开启位置订阅，控制台定期打印位置信息。<span><img originheight="202" originwidth="1495" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163443.32978534660612874800906671087123:50001231000000:2800:7FB4F19AD908ADD23B94679F54518F8DA3C5E2DD3885F5C38FF7F0BE78CC2C0B.png" width="920" height="124.30769230769232"></span></li></ul> <ul><li>在定位和导航应用场景中，应用退至后台持续运行，控制台日志定时打印位置信息。<span><img originheight="198" originwidth="1504" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163443.92043340637042453600516084049865:50001231000000:2800:56DAB1285E5D16F3D86CE9DE4F02DDC53A16B59EF233A4F3B4C625F20DCEAAB3.png" width="920" height="121.11702127659574"></span></li></ul> </div> <div class="tiledSection"><h2 id="section184771544141710">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section184771544141710" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BackTaskImplement" target="_blank">基于后台任务实现应用流畅体验</a></li></ul> </div> </div> <div></div></div>