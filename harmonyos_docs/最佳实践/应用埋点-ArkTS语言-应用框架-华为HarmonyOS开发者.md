<h1 _ngcontent-pin-c119="" class="doc-title ng-star-inserted" title="应用埋点"> 应用埋点 </h1>

<div _ngcontent-pin-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section116581319173014">概述<i class="anchor-icon anchor-icon-link" anchorid="section116581319173014" tips="复制节点链接"></i></h2></div> <p>埋点是指将信息采集程序和原本的功能代码结合起来，针对特定用户行为收集、处理和发送一些信息，用来跟踪应用使用情况。包括访问数、访客数、停留时长、页面浏览数和跳出率。以下是几种常见业务场景：</p> <ul><li>页面中可视区域或者组件的点击量，统计点击频率，分析用户的偏好行为。</li><li>监听页面中组件滑动的开始与结束，计算滑动偏移量以及曝光比例。</li><li>监听页面切换，统计页面的停留时间以及切换的来源页和目标页，分析页面浏览数和跳出率。</li><li>分析页面加载性能，计算加载过程各个节点的耗时，可针对某个关键点进行优化。</li></ul> <div class="tiledSection"><h2 id="section3801851193012">埋点分类<i class="anchor-icon anchor-icon-link" anchorid="section3801851193012" tips="复制节点链接"></i></h2></div> <p>按照用户行为不同，埋点可以分为点击埋点、曝光埋点以及页面埋点等。</p> <ul><li>点击埋点：用户在任意区域的一次单击，比如一个icon或一张图片。区别于被动的用户曝光行为，单击属于主动行为。</li><li>曝光埋点：统计页面局部区域是否被用户有效浏览，例如瀑布流中的每个卡片的曝光比例和曝光时长，这是被动行为。</li><li>页面埋点：统计用户在固定页面的停留时间，页面加载性能以及页面跳转时的来源页和去向页信息。</li></ul> <div class="tiledSection"><h2 id="section690752012319">方案介绍<i class="anchor-icon anchor-icon-link" anchorid="section690752012319" tips="复制节点链接"></i></h2></div> <p>接下来会从（1）组件动态绑定埋点数据；（2）点击埋点方案；（3）曝光埋点方案；（4）页面埋点方案四部分介绍。整体方案使用全局无感监听能力<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver" target="_blank">UIObserver</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-uicommonevent#setonvisibleareaapproximatechange" target="_blank">setOnVisibleAreaApproximateChange</a>属性实现埋点功能。</p> <p><span><img height="920" originheight="8192" originwidth="8192" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163022.34895440231142941429584598249618:50001231000000:2800:5928690C20EC9DA36C09E0CBC2CA9B3BBFA1C96D9636A97CB92A028C55DC70A9.png" title="点击放大" width="920"></span></p> <div class="tiledSection"><h3 id="section123411637327" class="firsth2">绑定埋点数据<i class="anchor-icon anchor-icon-link" anchorid="section123411637327" tips="复制节点链接"></i></h3></div> <p>首先，为需要埋点的组件指定对应的ID值和埋点数据。例如，Button组件的ID可以设为“button-1”，并通过customProperty属性设置key和value，其中key为组件ID，value为埋点数据。为了方便获取，可以将埋点数据统一定义在DataResource中。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/ClickPage.ets#L82-L90" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\pages\ClickPage.ets</span></li><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">'Click Tracing Point - Single Component'</span>)</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">id</span>(<span class="hljs-string">'button-1'</span>)</li><li>  .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>  .<span class="hljs-title function_">customProperty</span>(<span class="hljs-string">'button-1'</span>, <span class="hljs-title class_">DataResource</span>[<span class="hljs-string">'Index'</span>][<span class="hljs-string">'button-1'</span>])</li><li>  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'btn'</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/ClickPage.ets#L82-L90" target="_blank">ClickPage.ets</a></div></div></div></div> <p>DataResource根据Page名、组件名和索引封装，Page名为最外层key，组件名+索引为里层key。value值根据实际业务配置。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/DataResource.ets#L21-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\viewModel\DataResource.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">DataResource</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">DataResourceType</span>&gt;&gt; = {</li><li>  <span class="hljs-string">'Index'</span>: {</li><li>    <span class="hljs-string">'button-1'</span>: { <span class="hljs-variable">id</span>: <span class="hljs-string">'button-1'</span> },</li><li>    <span class="hljs-string">'button-2'</span>: { <span class="hljs-variable">id</span>: <span class="hljs-string">'button-2'</span> }</li><li>  },</li><li>  <span class="hljs-string">'Page2'</span>: {</li><li>    <span class="hljs-string">'component-1'</span>: { <span class="hljs-variable">id</span>: <span class="hljs-string">'text-2'</span> }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">DataResourceType</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/DataResource.ets#L21-L35" target="_blank">DataResource.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1340062193320">点击埋点<i class="anchor-icon anchor-icon-link" anchorid="section1340062193320" tips="复制节点链接"></i></h3></div> <p>配置完埋点数据并绑定组件后，在EntryAbility中注册点击事件监听，在事件回调中获取触发节点。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver" target="_blank">UIObserver</a>一共提供了两种监听事件：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onwillclick12" target="_blank">on('willClick')</a>：用于监听点击事件指令下发情况，所注册回调将于点击事件触发前触发。</li></ul> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#ondidclick12" target="_blank">on('didClick')</a>：用于监听点击事件指令下发情况，所注册回调将于点击事件触发后触发。</li></ul> <p>这两种方法都能在用户点击组件时触发回调。本示例使用 `willClick` 监听方式，下面介绍具体实现方案。</p> <p><strong>实现步骤</strong></p> <ol><li>首先实现一个简单页面，在组件上绑定ID和埋点数据。ID可以根据组件名-索引命名，例如代码示例中的两个组件，ID值分别为“button-1”和“button-2”。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/ClickPage.ets#L47-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\pages\ClickPage.ets</span></li><li><span class="hljs-selector-tag">Row</span>() {</li><li>  <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'Click Tracing Point - Composite Component'</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.media.ic_public_arrow_right'</span>))</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-selector-class">.id</span>(<span class="hljs-string">'button-2'</span>)</li><li><span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">top</span>: <span class="hljs-number">12</span> })</li><li><span class="hljs-selector-class">.customProperty</span>(<span class="hljs-string">'button-2'</span>, DataResource[<span class="hljs-string">'Index'</span>][<span class="hljs-string">'button-2'</span>])</li><li><span class="hljs-selector-class">.onClick</span>(() =&gt; {</li><li>  <span class="hljs-selector-tag">hilog</span><span class="hljs-selector-class">.info</span>(<span class="hljs-number">0</span>x0000, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'row'</span>);</li><li>})</li><li>
</li><li><span class="hljs-selector-tag">Row</span>() {</li><li>  <span class="hljs-comment">// entry\src\main\ets\pages\ClickPage.ets</span></li><li>  <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'Click Tracing Point - Single Component'</span>)</li><li>    <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)</li><li>    <span class="hljs-selector-class">.id</span>(<span class="hljs-string">'button-1'</span>)</li><li>    <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)</li><li>    <span class="hljs-selector-class">.customProperty</span>(<span class="hljs-string">'button-1'</span>, DataResource[<span class="hljs-string">'Index'</span>][<span class="hljs-string">'button-1'</span>])</li><li>    <span class="hljs-selector-class">.onClick</span>(() =&gt; {</li><li>      <span class="hljs-selector-tag">hilog</span><span class="hljs-selector-class">.info</span>(<span class="hljs-number">0</span>x0000, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'btn'</span>);</li><li>    })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/ClickPage.ets#L47-L92" target="_blank">ClickPage.ets</a></div></div></div></div> </li><li>在EntryAbility中注册UIObserver的willClick事件监听，并在事件回调中获取触发的组件节点FrameNode。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L49-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li><span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">getUIObserver</span>()?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'willClick'</span>, (<span class="hljs-variable">_event</span>: <span class="hljs-title class_">ClickEvent</span>, <span class="hljs-variable">node</span>?: <span class="hljs-title class_">FrameNode</span>) =&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">clickCallback</span> = <span class="hljs-variable">CallbackManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getClickCallback</span>();</li><li>  <span class="hljs-title function_">clickCallback</span>(<span class="hljs-variable">node</span>, <span class="hljs-variable">uiContext</span>);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L49-L53" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>接着可以根据FrameNode获取当前组件所在的Page和ID值，并且通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#getcustomproperty12" target="_blank">getCustomProperty</a>获取当前组件绑定的埋点数据。此外FrameNode还提供一些方法获取组件的基础属性，比如组件大小、组件位置以及是否可见等一些信息。具体可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#framenode-1" target="_blank">FrameNode</a>官方文档。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/CallBackManager.ets#L54-L86" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\viewModel\CallBackManager.ets</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Obtains the ClickCallback callback.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">getClickCallback</span>() {</li><li>  <span class="hljs-keyword">return</span> (<span class="hljs-variable">node</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">undefined</span>, <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">FrameNode</span>: ${<span class="hljs-variable">node</span>}`);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">uniqueId</span> = <span class="hljs-variable">node</span>?.<span class="hljs-title function_">getUniqueId</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">ID</span> = <span class="hljs-variable">node</span>?.<span class="hljs-title function_">getId</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">pageInfo</span> = <span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">getPageInfoByUniqueId</span>(<span class="hljs-variable">uniqueId</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">trackData</span> = <span class="hljs-variable">node</span>?.<span class="hljs-title function_">getCustomProperty</span>(<span class="hljs-variable">ID</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">eventParams</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span>&gt; = {</li><li>      <span class="hljs-string">'component_id'</span>: <span class="hljs-title class_">ID</span> ?? <span class="hljs-string">''</span>,</li><li>      <span class="hljs-string">'pageInfo'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title class_">stringify</span>(<span class="hljs-title class_">pageInfo</span> ?? {}),</li><li>      <span class="hljs-string">'trackData'</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title class_">stringify</span>(<span class="hljs-title class_">trackData</span> ?? {})</li><li>    };</li><li>    <span class="hljs-variable">hiAppEvent</span>.<span class="hljs-title function_">write</span>({</li><li>      <span class="hljs-variable">domain</span>: <span class="hljs-string">'test_domain'</span>,</li><li>      <span class="hljs-variable">name</span>: <span class="hljs-string">'test_event'</span>,</li><li>      <span class="hljs-variable">eventType</span>: <span class="hljs-title class_">hiAppEvent</span>.<span class="hljs-title class_">EventType</span>.<span class="hljs-title class_">FAULT</span>,</li><li>      <span class="hljs-variable">params</span>: <span class="hljs-title class_">eventParams</span></li><li>    }, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>        <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'CallBackManager'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">getClickCallback</span>, <span class="hljs-variable">success</span> <span class="hljs-variable">to</span> <span class="hljs-variable">write</span> <span class="hljs-variable">event</span>`);</li><li>    });</li><li>  };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/CallBackManager.ets#L54-L86" target="_blank">CallBackManager.ets</a></div></div></div></div> </li><li>然后通过@kit.PerformanceAnalysisKit的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventwrite" target="_blank">write()</a>方法将需要的数据写入当天的事件文件中。需要注意的是eventParams的参数值只能是number、string、boolean以及数组类型。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/CallBackManager.ets#L72-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">hiAppEvent</span>.<span class="hljs-title function_">write</span>({</li><li>  <span class="hljs-variable">domain</span>: <span class="hljs-string">'test_domain'</span>,</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-string">'test_event'</span>,</li><li>  <span class="hljs-variable">eventType</span>: <span class="hljs-title class_">hiAppEvent</span>.<span class="hljs-title class_">EventType</span>.<span class="hljs-title class_">FAULT</span>,</li><li>  <span class="hljs-variable">params</span>: <span class="hljs-title class_">eventParams</span></li><li>}, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'CallBackManager'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">getClickCallback</span>, <span class="hljs-variable">success</span> <span class="hljs-variable">to</span> <span class="hljs-variable">write</span> <span class="hljs-variable">event</span>`);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/CallBackManager.ets#L72-L83" target="_blank">CallBackManager.ets</a></div></div></div></div> </li><li>最后在onWindowStageDestroy()调用UIObserver的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#offwillclick12" target="_blank">off()</a>接口取消监听事件。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L104-L113" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li><span class="hljs-title function_">onWindowStageDestroy</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'uiContext'</span>);</li><li>  <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">off</span>(<span class="hljs-string">'willClick'</span>);</li><li>  <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">off</span>(<span class="hljs-string">'scrollEvent'</span>);</li><li>  <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">off</span>(<span class="hljs-string">'navDestinationSwitch'</span>);</li><li>  <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">off</span>(<span class="hljs-string">'routerPageUpdate'</span>);</li><li>  <span class="hljs-comment">// Main window is destroyed, release UI related resources</span></li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onWindowStageDestroy'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L104-L113" target="_blank">EntryAbility.ets</a></div></div></div></div> </li></ol> <p></p> <p>除了点击事件外，UIObserver还可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onscrollevent12" target="_blank">on('scrollEvent')</a>监听组件滑动。在滑动开始与结束触发回调并得到滑动偏移量。以<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-waterflow#子组件" target="_blank">瀑布流</a>为例，对WaterFlow和FlowItem设置组件ID。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/WaterFlowPage.ets#L80-L121" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\pages\WaterFlowPage.ets</span></li><li><span class="hljs-title function_">TrackNode</span>({ <span class="hljs-variable">track</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Track</span>().<span class="hljs-title class_">id</span>('<span class="hljs-variable">WaterFlow</span>-<span class="hljs-number">1</span>') }) {</li><li>  <span class="hljs-title function_">WaterFlow</span>() {</li><li>    <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-title function_">FlowItem</span>() {</li><li>        <span class="hljs-title function_">TrackNode</span>({ <span class="hljs-variable">track</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Track</span>().<span class="hljs-title class_">id</span>(`<span class="hljs-title class_">flowItem_</span>${<span class="hljs-title class_">index</span>}`) }) {</li><li>          <span class="hljs-title function_">WaterFlowCard</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">index</span> }).<span class="hljs-title function_">id</span>(`<span class="hljs-variable">flowItem_</span>${<span class="hljs-variable">index</span>}`)</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>  .<span class="hljs-title function_">id</span>(<span class="hljs-string">'WaterFlow-1'</span>)</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onReachStart</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow reach start'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollStart</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow scroll start'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollStop</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow scroll stop'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollFrameBegin</span>((<span class="hljs-variable">offset</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">state</span>: <span class="hljs-title class_">ScrollState</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">waterFlow</span> <span class="hljs-variable">scrollFrameBegin</span> <span class="hljs-variable">offset</span>: ${<span class="hljs-variable">offset</span>}`);</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>      `<span class="hljs-variable">waterFlow</span> <span class="hljs-variable">scrollFrameBegin</span> <span class="hljs-variable">state</span>: ${<span class="hljs-variable">state</span>.<span class="hljs-title function_">toString</span>()}`);</li><li>    <span class="hljs-keyword">return</span> { <span class="hljs-variable">offsetRemain</span>: <span class="hljs-title class_">offset</span> };</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/WaterFlowPage.ets#L80-L121" target="_blank">WaterFlowPage.ets</a></div></div></div></div> <p>接着在EntryAbility里统一注册scrollEvent的事件监听，在回调中获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-observer#scrolleventinfo12" target="_blank">ScrollEventInfo</a>信息，包括id、uniqueId、scrollEvent以及offset。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L56-L58" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li>uiContext.<span class="hljs-title function_">getUIObserver</span>()</li><li>  .<span class="hljs-title function_">on</span>(<span class="hljs-string">'scrollEvent'</span>, <span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> <span class="hljs-title class_">CallbackManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getScrollEvent</span>(info))</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L56-L58" target="_blank">EntryAbility.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在scrollEvent监听事件中，回调参数的id值仅能精确到外层组件WaterFlow，无法精确到内层FlowItem。 若要在滑动过程中获取各Item组件的曝光比例，请参考第三小节的曝光埋点。</p> </div></div></div> <div class="tiledSection"><h3 id="section34018518345">曝光埋点<i class="anchor-icon anchor-icon-link" anchorid="section34018518345" tips="复制节点链接"></i></h3></div> <p>曝光埋点需要监测页面中每个组件的出现与消失。例如，当用户滑动瀑布流时，如果某个项目出现的时长超过500毫秒，则记录为一次有效曝光。为避免在每个页面注入冗长代码，建议使用自定义的“埋点钩子”组件进行封装。以下是具体实现步骤。</p> <p><strong>实现步骤</strong></p> <ol><li>首先自定义一个TrackNode“钩子”组件，该组件需支持嵌套子组件、组件ID值注入以及注册监听事件。因此，TrackNode中的build()方法需由外部调用方决定，并且在onDidBuild()生命周期中将组件信息注入。onDidBuild()主要完成以下三件事：<p>（1）调用TrackManager的addTrack()方法，将当前组件与TrackShadow对象绑定。</p> <p>（2）通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-uicommonevent#setonvisibleareaapproximatechange" target="_blank">setOnVisibleAreaApproximateChange()</a>监听埋点组件的可视区域的变化；其中ratio值可以自定义设置，比如本示例设置了0.0、0.5、1.0。</p> <p>（3）根据当前组件获取其父节点，判断父节点是否有埋点钩子。如果没有，继续往上追溯，直到父节点为null。如果有，则在父节点的子组件集合中添加当前节点。</p> <p>在aboutToDisappear()生命周期中，调用TrackManager的removeTrack()方法删除当前组件信息。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L41-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\viewModel\TrackNode.ets</span></li><li><span class="hljs-comment">// onDidBuild Life Cycle.</span></li><li><span class="hljs-title function_">onDidBuild</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-comment">// Construct the virtual tree of the tracing point.</span></li><li>  <span class="hljs-comment">// The obtained node is the root node of the current page (row in the test case).</span></li><li>  <span class="hljs-keyword">let</span> uid = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUniqueId</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">node</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getFrameNodeByUniqueId</span>(uid);</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`Track onDidBuild node:<span class="hljs-subst">${node?.getNodeType()}</span>`</span>);</li><li>  <span class="hljs-keyword">if</span> (node === <span class="hljs-literal">null</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">node</span> = node;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">id</span> = node?.<span class="hljs-title function_">getId</span>();</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">track</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">track</span>;</li><li>  <span class="hljs-title class_">TrackManager</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">addTrack</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">id</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>);</li><li>  <span class="hljs-comment">// The setOnVisibleAreaApproximateChange monitors and records the visible area of the tracing point component.</span></li><li>  node?.<span class="hljs-property">commonEvent</span>.<span class="hljs-title function_">setOnVisibleAreaApproximateChange</span>(</li><li>    { <span class="hljs-attr">ratios</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">1</span>], <span class="hljs-attr">expectedUpdateInterval</span>: <span class="hljs-number">500</span> },</li><li>    <span class="hljs-function">(<span class="hljs-params">ratioInc: <span class="hljs-built_in">boolean</span>, ratio: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> areaChangeCb = <span class="hljs-title class_">CallbackManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getAreaChangeCallback</span>();</li><li>      <span class="hljs-title function_">areaChangeCb</span>(node, ratio);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">visibleRatio</span> = ratio;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`ratioInc: <span class="hljs-subst">${ratioInc}</span>`</span>);</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`ratio: <span class="hljs-subst">${ratio}</span>`</span>);</li><li>    });</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">parent</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = node?.<span class="hljs-title function_">getParent</span>();</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`Parent getId: <span class="hljs-subst">${parent?.getId()}</span>`</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">attachTrackToParent</span>: <span class="hljs-function">(<span class="hljs-params">parent: FrameNode | <span class="hljs-literal">null</span></span>) =&gt;</span> <span class="hljs-built_in">boolean</span> =</li><li>    <span class="hljs-function">(<span class="hljs-params">parent: FrameNode | <span class="hljs-literal">null</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">while</span> (parent !== <span class="hljs-literal">null</span>) {</li><li>        <span class="hljs-keyword">let</span> parentTrack = <span class="hljs-title class_">TrackManager</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">getTrackById</span>(parent?.<span class="hljs-title function_">getId</span>());</li><li>        <span class="hljs-keyword">if</span> (parentTrack !== <span class="hljs-literal">undefined</span>) {</li><li>          parentTrack.<span class="hljs-property">childIds</span>.<span class="hljs-title function_">add</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">id</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackShadow</span>.<span class="hljs-property">parentId</span> = parentTrack.<span class="hljs-property">id</span>;</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>        }</li><li>        parent = parent.<span class="hljs-title function_">getParent</span>();</li><li>      }</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    };</li><li>  <span class="hljs-keyword">let</span> attached = <span class="hljs-title function_">attachTrackToParent</span>(parent);</li><li>
</li><li>  <span class="hljs-keyword">if</span> (!attached) {</li><li>    node?.<span class="hljs-property">commonEvent</span>.<span class="hljs-title function_">setOnAppear</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> attached = <span class="hljs-title function_">attachTrackToParent</span>(parent);</li><li>      <span class="hljs-keyword">if</span> (attached) {</li><li>        hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`Track lazy attached: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.trackShadow.id}</span>`</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L41-L93" target="_blank">TrackNode.ets</a></div></div></div></div> </li><li>TrackManager封装了埋点钩子的操作方法，包括绑定、删除和导出。绑定是将当前组件ID与TrackShadow对象存入全局Map中。导出是以根节点为起点，递归输出所有子组件的曝光比例。删除是根据具体ID值从Map中移除对应数据。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L142-L183" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\viewModel\TrackNode.ets</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Tracing point data operation class</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackManager</span> {</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">TrackManager</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">trackMap</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">TrackShadow</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">rootTrack</span>: <span class="hljs-title class_">TrackShadow</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">get</span>(): <span class="hljs-title class_">TrackManager</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">TrackManager</span>.<span class="hljs-property">instance</span> !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-title class_">TrackManager</span>.<span class="hljs-property">instance</span>;</li><li>    }</li><li>    <span class="hljs-title class_">TrackManager</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TrackManager</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">TrackManager</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">addTrack</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">track</span>: <span class="hljs-title class_">TrackShadow</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">trackMap</span>.<span class="hljs-property">size</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootTrack</span> = track;</li><li>    }</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`Track add id: <span class="hljs-subst">${id}</span>`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackMap</span>.<span class="hljs-title function_">set</span>(id, track);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">removeTrack</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">let</span> current = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTrackById</span>(id);</li><li>    <span class="hljs-keyword">if</span> (current !== <span class="hljs-literal">undefined</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackMap</span>.<span class="hljs-title function_">delete</span>(id);</li><li>      <span class="hljs-keyword">let</span> parent = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getTrackById</span>(current?.<span class="hljs-property">parentId</span>);</li><li>      parent?.<span class="hljs-property">childIds</span>.<span class="hljs-title function_">delete</span>(id);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">getTrackById</span>(<span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">TrackShadow</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackMap</span>.<span class="hljs-title function_">get</span>(id);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">dump</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">rootTrack</span>?.<span class="hljs-title function_">dump</span>(<span class="hljs-number">0</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L142-L183" target="_blank">TrackNode.ets</a></div></div></div></div> </li><li>TrackShadow对象包含FrameNode、track、childIds和parentId。FrameNode表示组件节点，track包含ID值，childIds表示子组件列表，parentId表示父组件的ID值。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L98-L138" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\viewModel\TrackNode.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Track</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">areaPercent</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">trackId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">id</span>(<span class="hljs-attr">newId</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Track</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">trackId</span> = newId;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Tracing point data.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackShadow</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">node</span>: <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">track</span>: <span class="hljs-title class_">Track</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">childIds</span>: <span class="hljs-title class_">Set</span>&lt;<span class="hljs-built_in">string</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>();</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">parentId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">visibleRect</span>: common2D.<span class="hljs-property">Rect</span> = {</li><li>    <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span></li><li>  };</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">visibleRatio</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-comment">// Output the information about the tracing point tree through global dump.</span></li><li>  <span class="hljs-title function_">dump</span>(<span class="hljs-attr">depth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`Track Dp: <span class="hljs-subst">${depth}</span>`</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`AreaPer: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.track?.areaPercent}</span>`</span>);</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">`VisibleRatio: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.visibleRatio}</span>`</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">childIds</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">TrackManager</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">getTrackById</span>(value)?.<span class="hljs-title function_">dump</span>(depth + <span class="hljs-number">1</span>);</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/viewModel/TrackNode.ets#L98-L138" target="_blank">TrackNode.ets</a></div></div></div></div> </li><li>根据上述TrackNode组件改造瀑布流代码：使用TrackNode钩子将WaterFlow和FlowItem组件包裹起来，并传递一个包含id的track对象，id作为组件的唯一标识。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/WaterFlowPage.ets#L80-L121" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\pages\WaterFlowPage.ets</span></li><li><span class="hljs-title function_">TrackNode</span>({ <span class="hljs-variable">track</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Track</span>().<span class="hljs-title class_">id</span>('<span class="hljs-variable">WaterFlow</span>-<span class="hljs-number">1</span>') }) {</li><li>  <span class="hljs-title function_">WaterFlow</span>() {</li><li>    <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>      <span class="hljs-title function_">FlowItem</span>() {</li><li>        <span class="hljs-title function_">TrackNode</span>({ <span class="hljs-variable">track</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Track</span>().<span class="hljs-title class_">id</span>(`<span class="hljs-title class_">flowItem_</span>${<span class="hljs-title class_">index</span>}`) }) {</li><li>          <span class="hljs-title function_">WaterFlowCard</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">index</span> }).<span class="hljs-title function_">id</span>(`<span class="hljs-variable">flowItem_</span>${<span class="hljs-variable">index</span>}`)</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-title function_">toString</span>())</li><li>  }</li><li>  .<span class="hljs-title function_">id</span>(<span class="hljs-string">'WaterFlow-1'</span>)</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onReachStart</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow reach start'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollStart</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow scroll start'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollStop</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'waterFlow scroll stop'</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">onScrollFrameBegin</span>((<span class="hljs-variable">offset</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">state</span>: <span class="hljs-title class_">ScrollState</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, `<span class="hljs-variable">waterFlow</span> <span class="hljs-variable">scrollFrameBegin</span> <span class="hljs-variable">offset</span>: ${<span class="hljs-variable">offset</span>}`);</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>      `<span class="hljs-variable">waterFlow</span> <span class="hljs-variable">scrollFrameBegin</span> <span class="hljs-variable">state</span>: ${<span class="hljs-variable">state</span>.<span class="hljs-title function_">toString</span>()}`);</li><li>    <span class="hljs-keyword">return</span> { <span class="hljs-variable">offsetRemain</span>: <span class="hljs-title class_">offset</span> };</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/WaterFlowPage.ets#L80-L121" target="_blank">WaterFlowPage.ets</a></div></div></div></div> </li></ol> <p>滚动瀑布流时，不仅可以监听每个Item的曝光比例，还可以追溯到根节点，统计根节点中每个子组件的曝光比例。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>滑动容器中的子组件曝光，例如List、Grid、Swiper、WaterFlow，可以参考本章节进行实现。</li><li>当该曝光埋点在组件未发生变化时，不会触发回调记录一次有效曝光。例如：在瀑布流场景下，如果某个Item已经达到设定的500ms，但用户后续不再滑动或直接退出应用，则此次曝光将不会被记录。</li></ul> </div></div></div> <div class="tiledSection"><h3 id="section145830214358">页面埋点<i class="anchor-icon anchor-icon-link" anchorid="section145830214358" tips="复制节点链接"></i></h3></div> <p>页面埋点在本示例中分为两类：监听页面切换和采集页面加载性能。以下将从Navigation和Router两种路由方案进行讲解。</p> <p><strong>Navigation路由</strong>：</p> <p>针对Navigation方案，UIObserver提供`navDestinationSwitch`事件，用于监听页面切换，并支持在回调中获取当前页面的切换信息。在`EntryAbility`中统一注册`UIObserver`的`navDestinationSwitch`事件监听。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L61-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li>uiContext.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'navDestinationSwitch'</span>, <span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">const</span> switchCallback = <span class="hljs-title class_">CallbackManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSwitchCallback</span>();</li><li>  <span class="hljs-title function_">switchCallback</span>(info);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L61-L65" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>回调函数中的info包含context、from、to和operation，用于标识页面的来源和去向。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.40.1.4.1.1" valign="top" width="33.33333333333333%"><p>字段</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.40.1.4.1.2" valign="top" width="33.33333333333333%"><p>类型</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.40.1.4.1.3" valign="top" width="33.33333333333333%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>context</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>UIContext</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>页面上下文信息</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>from</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>NavDestinationInfo | NavBar</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>来源页</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>to</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>NavDestinationInfo | NavBar</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>去向页</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>operation</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-navigation#navigationoperation11枚举说明" target="_blank">NavigationOperation</a></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>页面操作</p> </td> </tr>  </tbody></table></div> </div> <p>此外还可以通过UIObserver的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onnavdestinationupdate11" target="_blank">on("navDestinationUpdate")</a>事件监听页面的显示与隐藏，回调传参中包含页面名称、状态信息以及页面的唯一标识ID。</p> <p></p> <p><strong>Router路由</strong>：</p> <p>针对Router路由方案，UIObserver提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onrouterpageupdate11" target="_blank">on('routerPageUpdate')</a>监听事件，在页面切换过程中触发相应回调。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L68-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li>uiContext.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'routerPageUpdate'</span>, <span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">const</span> switchCallback = <span class="hljs-title class_">CallbackManager</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getSwitchCallback</span>();</li><li>  <span class="hljs-title function_">switchCallback</span>(info);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L68-L72" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>比如调用pushPath()从A页面跳转到B页面时，该回调会被触发三次：第一次触发的页面名称为PageB，页面状态为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-observer#routerpagestate" target="_blank">ABOUT_TO_APPEAR</a>即将显示；第二次触发的页面名称为PageA，页面状态为ON_PAGE_HIDE页面隐藏；第三次触发的页面名称为PageB，页面状态为ON_PAGE_SHOW页面显示。回调传参同样包含页面上下文、触发事件的页面名称等等。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.47.1.4.1.1" valign="top" width="33.33333333333333%"><p>字段名</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.47.1.4.1.2" valign="top" width="33.33333333333333%"><p>类型</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.47.1.4.1.3" valign="top" width="33.33333333333333%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>context</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>UIContext</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>页面上下文信息</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>index</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>number</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>触发页面在路由栈中的位置</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>name</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>String</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>触发页面名称</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>path</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>String</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>触发页面路径</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>state</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-observer#routerpagestate" target="_blank">RouterPageState</a></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>页面状态</p> </td> </tr> <tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>pageId</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>String</p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p>页面唯一标识</p> </td> </tr>  </tbody></table></div> </div> <p><strong>页面加载性能：</strong></p> <p>页面加载性能可以通过计算首帧绘制与绘制结束的时间差来判断。UIObserver同样提供了on("willDraw")事件和on("didLayout")事件，可以在首帧监听中记录初始时间，在完成绘制时记录结束时间。此事件监听需要在页面中注册，Navigation与Router路由相同，本示例以Navigation为例。在aboutToAppear注册on("willDraw")和on("didLayout")事件。</p> <div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/NavigationPage.ets#L17-L164" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li><li><span class="hljs-keyword">import</span> { router } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">NavigationPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">const</span> uiContext = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>    <span class="hljs-comment">// Registering a Listening Event</span></li><li>    uiContext.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'willDraw'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">startTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>    })</li><li>    uiContext.<span class="hljs-title function_">getUIObserver</span>().<span class="hljs-title function_">on</span>(<span class="hljs-string">'didLayout'</span>, <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">endTime</span> = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">getResourceString</span>(<span class="hljs-attr">resource</span>: <span class="hljs-title class_">Resource</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">resourceString</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      resourceString = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>(resource.<span class="hljs-property">id</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'[getResourceString]'</span>, <span class="hljs-string">`getResourceString err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> resourceString;</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>) {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'pushPath'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-comment">// Put the NavDestination page information specified by name into the stack.</span></li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">pushPath</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'pageOne'</span> });</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Use interception'</span>, { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          <span class="hljs-comment">// ...</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isUseInterception</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isUseInterception</span>;</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isUseInterception</span>) {</li><li>              <span class="hljs-comment">// Register Interceptor.</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">registerInterception</span>();</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// Do not use interceptors.</span></li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">pageInfos</span>.<span class="hljs-title function_">setInterception</span>(<span class="hljs-literal">undefined</span>);</li><li>            }</li><li>          })</li><li>        <span class="hljs-title class_">Button</span>($r(<span class="hljs-string">'app.string.back'</span>), { <span class="hljs-attr">stateEffect</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Capsule</span> })</li><li>          <span class="hljs-comment">// ...</span></li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getRouter</span>().<span class="hljs-title function_">back</span>();</li><li>          })</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/pages/NavigationPage.ets#L17-L164" target="_blank">NavigationPage.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section82731558354">埋点数据上传<i class="anchor-icon anchor-icon-link" anchorid="section82731558354" tips="复制节点链接"></i></h2></div> <div class="p">如果需要将埋点数据上传至服务器，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent" target="_blank">@kit.PerformanceAnalysisKit</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-hiviewdfx-hiappevent#hiappeventaddwatcher" target="_blank">addWatcher()</a>方法添加订阅事件观察者、onTrigger()回调以及回调触发条件。可以自定义设置回调触发条件，比如在示例代码中当事件size大于等于1000字节时才会触发，然后在onTrigger()回调中调用http的request方法发起网络请求，将示例中的EXAMPLE_URL替换为服务器的IP地址即可。<div class="screenLinkPre"><div _ngcontent-pin-c106="" class="highlight-div"><div _ngcontent-pin-c106="" class="highlight-div-header"><div _ngcontent-pin-c106="" class="highlight-div-header-left"><div _ngcontent-pin-c106="" class="handle-button expand-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pin-c106="" class="highlight-div-header-right"><div _ngcontent-pin-c106="" class="handle-button ai-button"></div><div _ngcontent-pin-c106="" class="handle-button line-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pin-c106="" class="handle-button theme-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pin-c106="" class="handle-button copy-button"><div _ngcontent-pin-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pin-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L80-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\ets\entryability\EntryAbility.ets</span></li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">onTrigger</span> = CallbackManager.<span class="hljs-title function_ invoke__">getInstance</span>().<span class="hljs-title function_ invoke__">getOnTrigger</span>();</li><li>hiAppEvent.<span class="hljs-title function_ invoke__">addWatcher</span>({</li><li>  <span class="hljs-attr">name</span>: <span class="hljs-string">'watcher1'</span>,</li><li>  <span class="hljs-attr">appEventFilters</span>: [</li><li>    {</li><li>      <span class="hljs-attr">domain</span>: <span class="hljs-string">'test_domain'</span>,</li><li>      <span class="hljs-attr">eventTypes</span>: [hiAppEvent.EventType.FAULT, hiAppEvent.EventType.BEHAVIOR]</li><li>    }</li><li>  ],</li><li>  <span class="hljs-attr">triggerCondition</span>: {</li><li>    <span class="hljs-attr">row</span>: <span class="hljs-number">10</span>,</li><li>    <span class="hljs-attr">size</span>: <span class="hljs-number">1000</span>,</li><li>    <span class="hljs-attr">timeOut</span>: <span class="hljs-number">1</span></li><li>  },</li><li>  <span class="hljs-attr">onTrigger</span>: onTrigger</li><li>})</li><li>hilog.<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'ApplicationTrack'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in loading the content.'</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/application-track/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L80-L97" target="_blank">EntryAbility.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section45611712153618">总结<i class="anchor-icon anchor-icon-link" anchorid="section45611712153618" tips="复制节点链接"></i></h2></div> <p>本文从绑定埋点数据入手，介绍三种埋点的开发实现：点击、曝光和页面埋点。最后调用hiAppEvent的addWatcher()方法添加订阅对象和onTrigger()回调，在回调中实现数据上报逻辑。</p> <ul><li>点击埋点：使用UIObserver的on("willClick")跟hiAppEvent的write()方法共同实现埋点操作，将埋点数据写入本地设备文件。</li><li>曝光埋点：使用setOnVisibleAreaApproximateChange跟hiAppEvent的write()方法共同实现埋点操作，将埋点数据写入本地设备文件。</li><li>页面埋点：使用UIObserver的on("navDestinationSwitch")跟hiAppEvent的write()方法共同实现埋点操作，将埋点数据写入本地设备文件。</li></ul> <div class="tiledSection"><h2 id="section472104581920">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section472104581920" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/application-track" target="_blank">基于UIObserver能力的应用埋点</a></li></ul> </div> </div> <div></div></div>