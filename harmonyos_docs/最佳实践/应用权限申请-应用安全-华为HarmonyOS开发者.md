<h1 _ngcontent-cow-c119="" class="doc-title ng-star-inserted" title="应用权限申请"> 应用权限申请 </h1>

<div _ngcontent-cow-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1154641611553">概述<i class="anchor-icon anchor-icon-link" anchorid="section1154641611553" tips="复制节点链接"></i></h2><p>在HarmonyOS开发中，应用访问如相机、麦克风、位置、图库等系统资源或系统能力时，需通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/use-picker" target="_blank">系统Picker</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/security-component-overview" target="_blank">安全控件</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/app-permission-mgmt-overview" target="_blank">授权使用</a>等方式来访问，以确保用户隐私安全。在申请权限授权过程中需严格遵循HarmonyOS<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/security-privacy-experience-standards" target="_blank">应用安全隐私体验建议</a>，同时符合UX体验设计，以提供合理且用户友好的交互体验。本文将从以下五个方面，介绍应用申请权限时的注意事项：</p> <ul><li>优先使用系统Picker或者安全控件</li><li>权限申请时机</li><li>明确申请原因</li><li>向用户申请授权</li><li>功能被禁用处理方式</li></ul> </div> <div class="tiledSection"><h2 id="section203261420183614">优先使用系统Picker或者安全控件<i class="anchor-icon anchor-icon-link" anchorid="section203261420183614" tips="复制节点链接"></i></h2><p>系统通过提供系统Picker和安全控件两种方式，使得应用能够便捷地访问系统资源。这两种方法均依赖于系统的独立进程来实现，当应用拉起系统Picker或展示安全控件时，必须依赖用户的主动操作来获取资源或结果。这一流程避免了应用额外申请权限，同时，由于用户的积极参与，进一步增强了用户隐私和安全的保护。</p> <p><strong>系统Picker</strong></p> <p>系统Picker是拉起系统资源的一种方式，由于系统Picker已经获取了对应权限的预授权，开发者使用系统Picker时，无需再次申请权限也可临时受限访问对应的资源。</p> <p>使用系统Picker组件拉起系统应用的场景主要有：联系人Picker（Contacts Picker），地图Picker，相机Picker（Camera Picker），扫码Picker，卡证识别Picker，文档扫描Picker，文件Picker，音频Picker和照片Picker（PhotoViewPicker）等，详细可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/system-app-startup" target="_blank">拉起系统应用</a>。</p> <p><strong>安全控件</strong></p> <p>安全控件是系统提供的一组系统实现的ArkUI组件，应用集成这类组件就可以实现在用户点击后自动授权，而无需弹窗授权。它们可以作为一种“特殊的按钮”融入应用页面，实现用户点击即许可的设计思路。</p> <p>目前系统提供两类安全控件：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/pastebutton" target="_blank">粘贴控件（PasteButton）</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/savebutton" target="_blank">保存控件（SaveButton）</a>。</p> <p><strong>使用场景示例</strong></p> <p>以下场景优先使用系统Picker或安全控件：</p> <ol><li>读写媒体库中的图片或视频：<ul><li>推荐方案（无需申请权限）：使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-photoviewpicker" target="_blank">PhotoViewPicker</a>读取媒体库的图片与视频；使用安全控件中的保存控件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/photoaccesshelper-savebutton" target="_blank">保存媒体库资源</a>。</li><li>申请权限方案：申请受限权限<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionread_imagevideo" target="_blank">ohos.permission.READ_IMAGEVIDEO</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/restricted-permissions#ohospermissionwrite_imagevideo" target="_blank">ohos.permission.WRITE_IMAGEVIDEO</a>读取媒体库的图片与视频。</li></ul> </li><li>拉起系统相机进行拍照和录制：<ul><li>推荐方案（无需申请权限）：仅是需要拉起系统相机拍摄一张照片、录制一段视频，可直接使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-camerapicker" target="_blank">CameraPicker</a>，无需申请相机权限。</li><li>申请权限方案：开发一个相机应用（或是在应用内开发相机模块）时，需按<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation" target="_blank">相机开发指导</a>在开发前做好申请权限的准备。</li></ul> </li></ol> </div> <div class="tiledSection"><h2 id="section44096197551">权限申请时机<i class="anchor-icon anchor-icon-link" anchorid="section44096197551" tips="复制节点链接"></i></h2><p>为了应用发挥完整功能，需要访问系统特定资源，这些资源的访问需要获得相应权限许可。在应用进行权限申请时，选择合适的申请时机是提升用户体验和保护用户隐私安全的关键。具体包括两点：</p> <p><strong>按需请求权限</strong></p> <ul><li>核心原则：应用应遵循最小权限原则，仅申请实际需要的权限。</li><li>实施策略：将权限请求与应用内的具体功能场景紧密结合。避免在应用首次启动时请求大量权限。应在用户实际使用某项功能，且该功能依赖于特定权限时，再请求相应权限。例如，当用户点击“获取当前位置”按钮时，触发查看位置信息的场景，此时弹出请求位置权限的弹框。</li></ul> <p><strong>尊重用户选择，避免强制请求</strong></p> <ul><li>核心原则：尊重用户选择权，不应强制授予权限。</li><li>实施策略：如果用户拒绝了某项权限申请，应用不应再次弹窗请求该权限。应在页面的适当位置添加明确的提示，指导用户开启权限或退出当前需要该权限的场景，直到用户重新触发时再引导其完成授权。例如，权限申请被拒绝后，按钮上方显示提示文字，具体效果见下图：<p><span><img height="549.2235000000001" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.39414596708183447923764114935940:50001231000000:2800:5661D09CC3B208DD4FD0B3B4AA8A8B377EC38F9353EECA5DB919F329E0752A81.png" title="点击放大" width="266"></span></p> </li></ul> </div> <div class="tiledSection"><h2 id="section855412208589">明确声明原因<i class="anchor-icon anchor-icon-link" anchorid="section855412208589" tips="复制节点链接"></i></h2><p>请求应用权限时，增强用户信任并减少拒绝风险的关键在于清晰说明。通过对话框或提示信息，向用户解释为何需要权限，或说明数据如何被使用，即明确声明原因。</p> <p>在应用开发过程中，首先需要在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file" target="_blank">module.json5配置文件</a>的requestPermissions标签中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions" target="_blank">声明权限</a>。其中权限使用理由必须按照规范来填写，具体规范可参考官方声明权限中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions#权限使用理由的文案内容规范" target="_blank">权限使用理由的文案内容规范</a>章节。</p> </div> <p>填写权限声明原因时，应遵循以下原则与规范，以增强用户的理解度、提升信任感、降低权限拒绝率并优化整体用户体验：</p> <ul><li>明确性与具体性：清晰具体地阐述每个权限请求的实际用途及场景，避免模糊语言。多个场景需申请同一权限时，首次申请时展示所有相关场景。</li><li>透明性：确保声明信息真实可信，不夸大或隐瞒权限用途。</li><li>简洁性：语言简洁明了，避免冗长复杂描述。</li><li>尊重用户：强调信息保密性和安全性，体现应用诚信和责任感。</li></ul> <p>以下是一些正反例来说明如何按照规范填写权限声明原因了，详细内容可参考指南<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/declare-permissions#reason字段的内容写作规范及建议" target="_blank">reason字段的内容写作规范及建议</a>。</p> <p><strong>正例</strong></p> <ul><li>正例1（以示例代码为例，效果图如下）<p>权限：位置信息</p> <p>权限声明原因：“为了向您展示您的当前位置信息，且该信息仅用于本应用的展示，并严格保密。”</p> <p>解释：此示例清晰地说明了应用为何需要位置信息（展示您的当前位置信息），并承诺了信息的使用范围及用途（仅用于本应用的展示），确保了信息的保密性，符合规范且易于用户理解。</p> <p><span><img height="549.2235000000001" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.20720561417896886345262262414102:50001231000000:2800:9740A0BF542005F3B8E765E078B9030D26E0D69287339A2BBD567D8130069CFB.png" title="点击放大" width="266"></span></p> </li></ul> <ul><li>正例2<p>权限：相机</p> <p>规范填写示例：“我们需要访问您的相机权限，用于拍摄照片、录制视频以及进行人脸识别等功能。”</p> <p>解释：此示例明确指出了相机权限的用途（拍摄照片、录制视频、人脸识别），并强调了这些功能对提升应用体验的重要性，符合规范。</p> </li></ul> <p><strong>反例</strong></p> <ul><li>反例1<p>权限：位置信息</p> <p>不规范填写示例：“我们需要您的位置信息。”</p> <p>解释：此示例虽然简短，但并未明确说明位置信息的具体用途，用户可能不清楚为何需要此权限，缺乏明确性与透明度，不符合规范。</p> </li><li>反例2<p>权限：相机</p> <p>不规范填写示例：“为了应用功能，请允许访问相机。”</p> <p>解释：此示例同样过于笼统，没有具体说明相机权限将用于哪些功能，用户难以判断权限请求的合理性，也不符合规范。</p> </li></ul> <div class="tiledSection"><h2 id="section1816918297167">向用户申请授权<i class="anchor-icon anchor-icon-link" anchorid="section1816918297167" tips="复制节点链接"></i></h2><p>在配置文件中声明user_grant类型权限后，还需向用户请求授权。只有经过用户允许，才能获得该权限。在此过程中，应确保符合UX体验设计，为用户提供良好的体验，避免出现二次弹框或要求用户手动到设置中开启权限。</p> </div> <p>当用户触发需要使用权限的场景时，首先需要判断当前是否已经授权，如果已经授权，则可以直接访问目标操作，否则需要向用户申请授权。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestpermissionsfromuser9" target="_blank">requestPermissionsFromUser()</a>方法可以向用户申请授权，通过判断返回结果authResults字段为0则表示用户已经授权，则可以继续访问目标操作，authResults字段为-1则表示用户没有授权，这时需要判断返回结果的dialogShownResults，当结果为true表示有弹框表明已经向用户展示请求授权的弹窗但是用户拒绝了授权，那应用需要在页面内合适的位置添加提示语引导用户开启权限或者退出该场景，dialogShownResults结果为false表示当前应用没有被授权且没有向用户展示请求授权的弹框，那应用可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestpermissiononsetting12" target="_blank">requestPermissionOnSetting()</a>方法直接拉起权限设置弹框，引导用户授予权限。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>在调用requestPermissionOnSetting()方法前，需先调用requestPermissionsFromUser()方法。</p> <p>若用户点击了“本次使用允许”，下次申请权限应调用requestPermissionsFromUser()方法，而不是直接调用requestPermissionOnSetting()方法。</p> </div></div></div> <p>系统弹框一般有三种操作，如下图所示。</p> <ol><li>仅使用期间允许：点击后应用直接获取该权限，且再次调用requestPermissionsFromUser()方法无法拉起该权限设置弹框；</li><li>本次使用允许：点击后将会对应用授予临时的权限，详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/one-time-authorization" target="_blank">向用户申请单次授权</a>，若临时权限被取消，再次调用requestPermissionsFromUser()方法将会拉起该权限设置弹框；</li><li>不允许：点击后应用无法获取该权限，且再次调用requestPermissionsFromUser()方法无法拉起该权限设置弹框。<p><span><img height="549.2235000000001" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.95224302790772302216990318950229:50001231000000:2800:009EC1E3FD566BD2A67BB9DB2B63FDB9CD56931E65535692826E22B1C85FB126.png" title="点击放大" width="266"></span></p> </li></ol> <p>具体流程图如下：</p> <p><span><img height="506.73" originheight="4869" originwidth="5025" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163354.80249896288962273882485538079352:50001231000000:2800:BE907B86EE924054D6A2C23CE40AF24CFFA22A18E27DCC73E2EAD7EB437C41CD.jpg" title="点击放大" width="523.6875"></span></p> <p><strong>示例代码</strong></p> <p>判断当前应用是否已经被授权。</p> <div class="screenLinkPre"><div _ngcontent-cow-c106="" class="highlight-div"><div _ngcontent-cow-c106="" class="highlight-div-header"><div _ngcontent-cow-c106="" class="highlight-div-header-left"><div _ngcontent-cow-c106="" class="handle-button expand-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cow-c106="" class="highlight-div-header-right"><div _ngcontent-cow-c106="" class="handle-button ai-button"></div><div _ngcontent-cow-c106="" class="handle-button line-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cow-c106="" class="handle-button theme-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cow-c106="" class="handle-button copy-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cow-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L149-L179" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Verify if the application has been granted permission.</span></li><li><span class="hljs-title function_">checkPermissionGrant</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> hasPermission = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">tokenId</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">bundleInfo</span>: bundleManager.<span class="hljs-property">BundleInfo</span> =</li><li>      bundleManager.<span class="hljs-title function_">getBundleInfoForSelfSync</span>(bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_WITH_APPLICATION</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">appInfo</span>: bundleManager.<span class="hljs-property">ApplicationInfo</span> = bundleInfo.<span class="hljs-property">appInfo</span>;</li><li>    tokenId = appInfo.<span class="hljs-property">accessTokenId</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>,</li><li>      <span class="hljs-string">`Failed to get bundle info for self. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> atManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>    <span class="hljs-keyword">let</span> approximatelyLocation = atManager.<span class="hljs-title function_">checkAccessTokenSync</span>(tokenId, <span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>);</li><li>    <span class="hljs-keyword">let</span> location = atManager.<span class="hljs-title function_">checkAccessTokenSync</span>(tokenId, <span class="hljs-string">'ohos.permission.LOCATION'</span>);</li><li>    hasPermission = approximatelyLocation === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span> &amp;&amp;</li><li>      location === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>;</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">`Failed to check access token. Code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (hasPermission) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isLocationToggle</span>();</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissions</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L149-L179" target="_blank">Index.ets</a></div></div></div></div> <p>向用户申请授权。</p> <div class="screenLinkPre"><div _ngcontent-cow-c106="" class="highlight-div"><div _ngcontent-cow-c106="" class="highlight-div-header"><div _ngcontent-cow-c106="" class="highlight-div-header-left"><div _ngcontent-cow-c106="" class="handle-button expand-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cow-c106="" class="highlight-div-header-right"><div _ngcontent-cow-c106="" class="handle-button ai-button"></div><div _ngcontent-cow-c106="" class="handle-button line-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cow-c106="" class="handle-button theme-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cow-c106="" class="handle-button copy-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cow-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L183-L214" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Requests location permissions from the user.</span></li><li>requestPermissions(): void {</li><li>  let atManager = abilityAccessCtrl.createAtManager();</li><li>  <span class="hljs-keyword">try</span> {</li><li>    atManager.requestPermissionsFromUser(<span class="hljs-keyword">this</span>.context, [<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>,</li><li>      <span class="hljs-string">'ohos.permission.LOCATION'</span>]).then((<span class="hljs-keyword">data</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.authResults[<span class="hljs-number">0</span>] === -<span class="hljs-number">1</span> || <span class="hljs-keyword">data</span>.authResults[<span class="hljs-number">1</span>] === -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.dialogShownResults &amp;&amp; (<span class="hljs-keyword">data</span>.dialogShownResults[<span class="hljs-number">0</span>] || <span class="hljs-keyword">data</span>.dialogShownResults[<span class="hljs-number">1</span>])) {</li><li>          <span class="hljs-keyword">this</span>.isShowPermissions = <span class="hljs-literal">true</span>;</li><li>          <span class="hljs-keyword">if</span>(<span class="hljs-keyword">data</span>.authResults[<span class="hljs-number">0</span>] === -<span class="hljs-number">1</span>){</li><li>            <span class="hljs-keyword">this</span>.permissionsMessage = $r(<span class="hljs-string">'app.string.obtain_location_permission'</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">this</span>.permissionsMessage = $r(<span class="hljs-string">'app.string.obtain_precise_positioning'</span>)</li><li>          }</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-keyword">this</span>.openPermissionsSetting();</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.isShowPermissions = <span class="hljs-literal">false</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.authResults[<span class="hljs-number">0</span>] !== <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.isLocationToggle();</li><li>    }).<span class="hljs-keyword">catch</span>((err: Error) =&gt; {</li><li>      hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'requestPermissionsFromUser err:'</span> + JSON.stringify(err));</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'requestPermissionsFromUser err:'</span> + JSON.stringify(err));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L183-L214" target="_blank">Index.ets</a></div></div></div></div> <p>引导用户授权。</p> <div class="screenLinkPre"><div _ngcontent-cow-c106="" class="highlight-div"><div _ngcontent-cow-c106="" class="highlight-div-header"><div _ngcontent-cow-c106="" class="highlight-div-header-left"><div _ngcontent-cow-c106="" class="handle-button expand-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cow-c106="" class="highlight-div-header-right"><div _ngcontent-cow-c106="" class="handle-button ai-button"></div><div _ngcontent-cow-c106="" class="handle-button line-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cow-c106="" class="handle-button theme-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cow-c106="" class="handle-button copy-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cow-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L126-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// The permission setting dialog box is displayed.</span></li><li><span class="hljs-keyword">private</span> openPermissionsSetting(): void {</li><li>  let atManager = abilityAccessCtrl.createAtManager();</li><li>  atManager.requestPermissionOnSetting(<span class="hljs-keyword">this</span>.context, [<span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>,</li><li>    <span class="hljs-string">'ohos.permission.LOCATION'</span>]).then((<span class="hljs-keyword">data</span>: Array&lt;abilityAccessCtrl.GrantStatus&gt;) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>] === -<span class="hljs-number">1</span> &amp;&amp; <span class="hljs-keyword">data</span>[<span class="hljs-number">1</span>] === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">this</span>.isShowPermissions = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">this</span>.permissionsMessage = $r(<span class="hljs-string">'app.string.obtain_location_permission'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">data</span>[<span class="hljs-number">1</span>] === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">this</span>.isShowPermissions = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-keyword">this</span>.permissionsMessage = $r(<span class="hljs-string">'app.string.obtain_precise_positioning'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.isShowPermissions = <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.isLocationToggle();</li><li>  }).<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>    hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'data:'</span> + JSON.stringify(err));</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L126-L145" target="_blank">Index.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section109832047175018">功能被禁用处理方式<i class="anchor-icon anchor-icon-link" anchorid="section109832047175018" tips="复制节点链接"></i></h2><p>用户可以在系统设置中，打开超级隐私模式或者关闭相机、麦克风、位置的全局开关，此时，即使应用已经被授权相关权限，也不能完成访问目标的操作。应用需要检测到这种状态，并通过适当的方式（如拉起全局开关的弹窗或一段描述性文字引导用户开启全局开关等）来提醒用户并辅助开启对应的全局开关。所以需要在调用接口前判断全局开关是否被关闭，如果全局开关被关闭，则需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestglobalswitch12" target="_blank">requestGlobalSwitch()</a>方法来打开它，之后才能继续调用所需的接口，具体流程图如下：</p> </div> <p><span><img height="379.05" originheight="3013" originwidth="4156" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163355.55832751036002257888015404016177:50001231000000:2800:24709528439724306B80387A5939A96C5604DCE92EC2D6CFC5A867814E875417.jpg" title="点击放大" width="523.6875"></span></p> <p>以下为判断各全局开关是否打开的方法：</p> <p>位置：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagerislocationenabled" target="_blank">geoLocationManager.isLocationEnabled()</a>判断位置服务是否已经使能，返回true表示位置信息开关已开启，false表示位置信息开关已关闭；</p> <p>相机：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#iscameramuted" target="_blank">isCameraMuted()</a>查询相机当前的禁用状态（禁用/未禁用），返回true表示相机被禁用，false表示相机未被禁用；</p> <p>麦克风：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiovolumegroupmanager#ismicrophonemute9" target="_blank">isMicrophoneMute()</a>查询麦克风当前静音状态，返回true表示麦克风被静音，false表示麦克风未被静音。</p> <p><strong>示例代码</strong></p> <p>以位置权限为例，功能被禁用的处理方式代码如下：</p> <div class="screenLinkPre"><div _ngcontent-cow-c106="" class="highlight-div"><div _ngcontent-cow-c106="" class="highlight-div-header"><div _ngcontent-cow-c106="" class="highlight-div-header-left"><div _ngcontent-cow-c106="" class="handle-button expand-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-cow-c106="" class="highlight-div-header-right"><div _ngcontent-cow-c106="" class="handle-button ai-button"></div><div _ngcontent-cow-c106="" class="handle-button line-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-cow-c106="" class="handle-button theme-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-cow-c106="" class="handle-button copy-button"><div _ngcontent-cow-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-cow-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L218-L266" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Obtain current location switch status and pull up the global switch to set the pop-up box.</span></li><li><span class="hljs-title function_">isLocationToggle</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">atManager</span> = <span class="hljs-variable">abilityAccessCtrl</span>.<span class="hljs-title function_">createAtManager</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">isLocationEnabled</span> = <span class="hljs-variable">geoLocationManager</span>.<span class="hljs-title function_">isLocationEnabled</span>();</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isLocationEnabled</span>) {</li><li>    <span class="hljs-variable">atManager</span>.<span class="hljs-title function_">requestGlobalSwitch</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">abilityAccessCtrl</span>.<span class="hljs-variable">SwitchType</span>.<span class="hljs-variable">LOCATION</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">boolean</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">data</span>) {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">isShowLocation</span> = <span class="hljs-keyword">false</span>;</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getLocation</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">isShowLocation</span> = <span class="hljs-keyword">true</span>;</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">locationServiceMessage</span> = $<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.open_location_services'</span>);</li><li>      }</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'data:'</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>));</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">isShowLocation</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getLocation</span>();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">getLocation</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">request</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">SingleLocationRequest</span> = {</li><li>    <span class="hljs-string">'locatingTimeoutMs'</span>: <span class="hljs-number">10000</span>,</li><li>    <span class="hljs-string">'locatingPriority'</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">LocatingPriority</span>.<span class="hljs-title class_">PRIORITY_LOCATING_SPEED</span></li><li>  };</li><li>  <span class="hljs-comment">// Get current location.</span></li><li>  <span class="hljs-variable">geoLocationManager</span>.<span class="hljs-title function_">getCurrentLocation</span>(<span class="hljs-variable">request</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">location</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">latitude</span> = <span class="hljs-variable">location</span>.<span class="hljs-variable">latitude</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">longitude</span> = <span class="hljs-variable">location</span>.<span class="hljs-variable">longitude</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">reverseGeocodeRequest</span>: <span class="hljs-title class_">geoLocationManager</span>.<span class="hljs-title class_">ReverseGeoCodeRequest</span> = {</li><li>      <span class="hljs-string">'locale'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">systemLanguages</span>.<span class="hljs-title class_">toString</span>().<span class="hljs-title class_">includes</span>('<span class="hljs-title class_">zh</span>') ? <span class="hljs-string">'zh'</span> : <span class="hljs-string">'en'</span>,</li><li>      <span class="hljs-string">'latitude'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">latitude</span>,</li><li>      <span class="hljs-string">'longitude'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">longitude</span>,</li><li>      <span class="hljs-string">'maxItems'</span>: <span class="hljs-number">1</span></li><li>    };</li><li>    <span class="hljs-comment">// Call the inverse geocoding service to convert coordinates into geographic descriptions.</span></li><li>    <span class="hljs-variable">geoLocationManager</span>.<span class="hljs-title function_">getAddressesFromLocation</span>(<span class="hljs-variable">reverseGeocodeRequest</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">data</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">placeName</span>) {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">currentLocation</span> = <span class="hljs-variable">data</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">placeName</span>;</li><li>      }</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'GetAddressesFromLocation err:'</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>));</li><li>    });</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Index'</span>, <span class="hljs-string">'Promise getCurrentLocation err:'</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>));</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PermissionApplication/blob/master/entry/src/main/ets/pages/Index.ets#L218-L266" target="_blank">Index.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1848121119213">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1848121119213" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/PermissionApplication" target="_blank">应用权限申请</a></li></ul> </div> </div> <div></div></div>