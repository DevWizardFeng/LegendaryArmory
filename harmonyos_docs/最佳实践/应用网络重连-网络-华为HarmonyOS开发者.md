<h1 _ngcontent-ekn-c119="" class="doc-title ng-star-inserted" title="应用网络重连"> 应用网络重连 </h1>

<div _ngcontent-ekn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section14827174684712">概述<i class="anchor-icon anchor-icon-link" anchorid="section14827174684712" tips="复制节点链接"></i></h2></div> <p>网络重连是指在网络连接出现中断或异常断开的情况下，设备或应用程序重新建立网络连接的过程。对于许多依赖网络的业务和应用来说，网络重连能够确保在网络出现短暂中断后，业务能够快速恢复，减少因网络故障导致的业务中断时间，提高业务的连续性和可靠性。例如，在线金融交易、远程医疗、音视频播放等对实时性和连续性要求较高的业务，网络重连功能至关重要。根据应用的实际场景，网络重连可以分为以下多种方式。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-network-reconnection#section090112944811">网络超时重连</a>：客户端向服务器发送请求后，如果发生网络超时，那么客户端将自动尝试与服务器重新建立连接。</li><li><a href="/consumer/cn/doc/best-practices/bpta-network-reconnection#section4111121185017">网络切换重连</a>：当网络连接发生变化后，客户端应用可能会出现网络异常。应用需要检测网络状态变化，并根据网络状态进行连接。</li><li><a href="/consumer/cn/doc/best-practices/bpta-network-reconnection#section6593152718515">应用前后台切换后重连</a>：应用切换到后台一段时间后，网络资源会被冻结释放，需要客户端重新建立连接。</li></ul> <div class="tiledSection"><h2 id="section090112944811">网络超时重连<i class="anchor-icon anchor-icon-link" anchorid="section090112944811" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section13263340174811" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section13263340174811" tips="复制节点链接"></i></h3><p>在网络请求中，经常会遇到网络波动、服务器宕机等情况，从而导致网络不可用、网络超时等问题。为了减少网络超时等带来的影响，在实际应用开发中经常使用超时机制和重试机制。如HTTP请求列表数据时，设置HTTP连接超时和请求重试。</p> </div> <ul><li>网络超时机制是指在网络通信过程中，当一个操作在规定的时间内没有得到预期的响应或完成时，系统会自动判定该操作失败，并触发相应的处理逻辑。其原理是通过设置一个定时器，从网络操作开始时计时，一旦超过设定的时间阈值，就认为操作超时。</li><li>重试机制一般配合超时机制一起使用，指的是多次发送相同的请求来避免瞬态故障和偶然性故障。</li></ul> <div class="tiledSection"><h3 id="section1087459134810">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1087459134810" tips="复制节点链接"></i></h3><p>网络超时分为网络连接超时和网络读取超时。</p> </div> <ul><li>网络连接超时就是在程序默认的等待时间内没有得到服务器的响应。</li><li>网络读取超时指客户端在读取服务器响应时等待的时间。</li></ul> <p>网络重试常用的策略有定时重试、指数退避重试、随机退避重试等。</p> <ul><li>定时重试：设定一个固定的重试次数，当网络请求失败时，在该次数范围内进行重试，每次重试之间的时间间隔可以是固定的，也可以根据具体情况进行调整。例如，设定重试次数为 3 次，每次重试间隔为 2 秒。</li><li>指数退避重试：每次重试的时间间隔按照指数级增长，如重试间隔时间依次为2、4、8、16等。</li><li>随机退避重试：每次重试的时间间隔在一个指定的范围内随机取值。例如，设定重试间隔时间在 1 秒到 5 秒之间随机，这样可以避免多个请求同时重试，分散服务器的负载压力，提高整体的重试成功率。</li></ul> <p>在设置重试策略时，需要根据实际的场景来进行设置，既要考虑网络超时的时间，还需要关注重试的次数和时间间隔，避免网络资源浪费。</p> <div class="tiledSection"><h3 id="section097471264912">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section097471264912" tips="复制节点链接"></i></h3><p>在HarmonyOS中，在Http、RCP发生错误或者超时后，都可以使用网络超时重连的机制。HTTP超时重连的实现步骤如下所示。</p> </div> <ul><li>设置HTTP请求的读取超时时间、连接超时时间。</li><li>可以根据网络状态进行判断，然后再进行重连。这样可以在非网络问题的情况下进行重试，可以更精准地控制重试行为，提高请求的成功率和效率。例如，对于一些表示服务错误的响应码（如 500 Internal Server Error、503 Service Unavailable 等），可以进行重试。</li><li>使用setTimeout进行函数执行延迟，配合使用Promise，进而同步获取网络请求结果。</li></ul> <p>HTTP超时重连的代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/HTTPReconnection.ets#L121-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">getHttpRequest</span>(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">retry</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">httpRequest</span>?.<span class="hljs-title function_">requestInStream</span>(url,</li><li>      { <span class="hljs-attr">method</span>: http.<span class="hljs-property">RequestMethod</span>.<span class="hljs-property">GET</span>, <span class="hljs-attr">connectTimeout</span>: <span class="hljs-number">6000</span>, <span class="hljs-attr">readTimeout</span>: <span class="hljs-number">60000</span> })</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (data === <span class="hljs-number">408</span> || data === <span class="hljs-number">500</span> &amp;&amp; retry &gt; <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve: <span class="hljs-built_in">Function</span></span>) =&gt;</span> {</li><li>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-title function_">resolve</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getHttpRequest</span>(url, retry - <span class="hljs-number">1</span>));</li><li>            }, <span class="hljs-number">2000</span>);</li><li>          });</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-keyword">return</span> data;</li><li>        }</li><li>      });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isDownload</span> = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: $r(<span class="hljs-string">'app.string.download_error'</span>) });</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">"Download Error"</span> });</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/HTTPReconnection.ets#L121-L142" target="_blank">HTTPReconnection.ets</a></div></div></div></div> <p>RCP超时重连的实现与HTTP的实现步骤类似，RCP超时重连的代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/RCPReconnection.ets#L91-L164" data-highlighted="yes"><ol class="linenums"><li>createRCPSession(): rcp.Session {</li><li>  <span class="hljs-keyword">const</span> customHttpEventsHandler: rcp.HttpEventsHandler = {</li><li>    onDownloadProgress: (totalSize: number, transferredSize: number) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.contentLength = totalSize;</li><li>      <span class="hljs-keyword">this</span>.downloadSize = transferredSize;</li><li>      <span class="hljs-keyword">this</span>.process = <span class="hljs-keyword">this</span>.contentLength === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : Math.floor(<span class="hljs-keyword">this</span>.downloadSize / <span class="hljs-keyword">this</span>.contentLength * <span class="hljs-number">100</span>);</li><li>    },</li><li>
</li><li>    onDataEnd: () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.contentLength = -<span class="hljs-number">1</span>;</li><li>      <span class="hljs-keyword">this</span>.downloadSize = <span class="hljs-number">0</span>;</li><li>    },</li><li>  };</li><li>  <span class="hljs-keyword">const</span> sessionConfig: rcp.SessionConfiguration = {</li><li>    requestConfiguration: {</li><li>      transfer: {</li><li>        timeout: {</li><li>          connectMs: <span class="hljs-number">6000</span>,</li><li>          transferMs: <span class="hljs-number">60000</span></li><li>        }</li><li>      },</li><li>      tracing: { httpEventsHandler: customHttpEventsHandler }</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> rcp.createSession(sessionConfig);</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>async getRcpRequest(url: string, retry: number): Promise&lt;rcp.Response | undefined&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">return</span> await <span class="hljs-keyword">this</span>.session.<span class="hljs-keyword">get</span>(url)</li><li>      .then((response) =&gt; {</li><li>        <span class="hljs-keyword">if</span> ((response.statusCode === <span class="hljs-number">408</span> || response.statusCode === <span class="hljs-number">500</span>) &amp;&amp; retry &gt; <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">return</span> new Promise((resolve: Function) =&gt; {</li><li>            setTimeout(() =&gt; {</li><li>              resolve(<span class="hljs-keyword">this</span>.getRcpRequest(url, retry - <span class="hljs-number">1</span>));</li><li>            }, <span class="hljs-number">2000</span>)</li><li>          })</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-keyword">return</span> response;</li><li>        }</li><li>      })</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: $r(<span class="hljs-string">'app.string.download_error'</span>) });</li><li>    <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: <span class="hljs-string">"Download Error"</span> });</li><li>    <span class="hljs-keyword">this</span>.isDownload = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/RCPReconnection.ets#L91-L164" target="_blank">RCPReconnection.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section4111121185017">网络切换重连<i class="anchor-icon anchor-icon-link" anchorid="section4111121185017" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section960317513411" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section960317513411" tips="复制节点链接"></i></h3><p>在当下这个数字化时代，大部分的应用确实离不开网络，网络已经深度渗透到各类应用场景之中。然而，在网络状态切换后，如何继续保持网络连接是许多应用需要处理的问题。</p> </div> <div class="tiledSection"><h3 id="section11527481754">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section11527481754" tips="复制节点链接"></i></h3><p>网络切换主要分为网络类型切换和无网络与有网络之间的切换。针对网络切换的场景，HarmonyOS提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection" target="_blank">网络连接管理</a>能力，用于查询网络信息、监听网络连接的变化等。</p> <p>在实现网络切换重连上，主要包含以下步骤。</p> <ul><li>使用网络连接管理的能力监听网络变化，并使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage" target="_blank">AppStorage</a>存储应用全局网络状态。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storageprop" target="_blank">@StorageProp</a>，将AppStorage存储的网络状态与对应的属性建立单向数据同步。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-watch" target="_blank">@Watch</a>监听状态变量的变化，当状态变量变化后，对网络进行关闭或重连。</li></ul> </div> <div class="tiledSection"><h3 id="section78034221254">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section78034221254" tips="复制节点链接"></i></h3><p>调用connection的register()方法订阅网络变化通知，同时，订阅netCapabilitiesChange网络能力变化事件，订阅netLost网络丢失事件。在设备从有网络到无网络状态会触发netLost事件，从无网络到有网络会触发netCapabilitiesChange事件。而在网络类型切换时，也会触发netLost事件和netCapabilitiesChange事件，开发者可以根据实际场景需要在netCapabilitiesChange事件中，将网络类型及网络状态存储在AppStorage中。</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/utils/ConnectionUtil.ets#L22-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-attr">netCon</span>: connection.<span class="hljs-property">NetConnection</span> = connection.<span class="hljs-title function_">createNetConnection</span>();</li><li>
</li><li><span class="hljs-title function_">register</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">netCon</span>.<span class="hljs-title function_">register</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'net register'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(error));</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">netCapabilitiesChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">netCon</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netCapabilitiesChange'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetCapabilityInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> netAvailable = <span class="hljs-literal">false</span>;</li><li>    data.<span class="hljs-property">netCap</span>.<span class="hljs-property">networkCap</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (value === connection.<span class="hljs-property">NetCap</span>.<span class="hljs-property">NET_CAPABILITY_INTERNET</span>) {</li><li>        netAvailable = <span class="hljs-literal">true</span>;</li><li>      }</li><li>    })</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'ConnectionUtil.netAvailable:'</span> + netAvailable);</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'netAvailable'</span>, netAvailable);</li><li>  })</li><li>
</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">netCon</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netLost'</span>, <span class="hljs-function">(<span class="hljs-params">data: connection.NetHandle</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'netAvailable'</span>, <span class="hljs-literal">false</span>);</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"WifiChangeListen-- Succeeded to get data: "</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data));</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/utils/ConnectionUtil.ets#L22-L46" target="_blank">ConnectionUtil.ets</a></div></div></div></div> </div> <p>使用AppStorage存储应用全局网络状态。</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L31-L31" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@StorageProp</span>(<span class="hljs-string">'netAvailable'</span>) <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onSocketUpdated'</span>) <span class="hljs-attribute">netAvailable</span>: boolean = true;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L31-L31" target="_blank">SocketReconnection.ets</a></div></div></div></div> <p>使用@Watch监听状态变量的变化，并根据对应的变化和实际应用场景重新连接网络。</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L58-L166" data-highlighted="yes"><ol class="linenums"><li>onSocketUpdated() {</li><li>  <span class="hljs-keyword">this</span>.netAvailable ? <span class="hljs-keyword">this</span>.tcpSocketConnect() : <span class="hljs-keyword">this</span>.tcpSocketDisconnect();</li><li>  Logger.info(<span class="hljs-string">'netAvailable:'</span> + <span class="hljs-keyword">this</span>.netAvailable);</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>tcpSocketConnect() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.netAvailable) {</li><li>    <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: $r(<span class="hljs-string">'app.string.connect_error'</span>) });</li><li>    <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: <span class="hljs-string">"Connect error"</span> });</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">this</span>.tcp = socket.constructTCPSocketInstance();</li><li>  <span class="hljs-keyword">this</span>.tcp.on(<span class="hljs-string">'connect'</span>, () =&gt; {</li><li>    Logger.info(<span class="hljs-string">'on connect'</span>);</li><li>  });</li><li>  <span class="hljs-keyword">this</span>.tcp.on(<span class="hljs-string">'close'</span>, () =&gt; {</li><li>    Logger.info(<span class="hljs-string">'on close'</span>);</li><li>  });</li><li>  <span class="hljs-keyword">this</span>.tcp.on(<span class="hljs-string">'error'</span>, (error: BusinessError) =&gt; {</li><li>    Logger.error(<span class="hljs-string">'error:'</span> + error.code + error.message</li><li>    );</li><li>  });</li><li>  <span class="hljs-keyword">const</span> clientIpAddress: socket.NetAddress = {</li><li>    address: CommonConstants.IP_ADDRESS,</li><li>    port: CommonConstants.CLIENT_IP_PORT</li><li>  } <span class="hljs-keyword">as</span> socket.NetAddress;</li><li>
</li><li>  <span class="hljs-keyword">this</span>.tcp.bind(clientIpAddress, (err: BusinessError) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      Logger.error(<span class="hljs-string">'bind fail'</span> + JSON.stringify(err));</li><li>      <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: $r(<span class="hljs-string">'app.string.connect_error'</span>) });</li><li>      <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: <span class="hljs-string">"Connect error"</span> });</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    let tcpConnect: socket.TCPConnectOptions = {} <span class="hljs-keyword">as</span> socket.TCPConnectOptions;</li><li>    <span class="hljs-keyword">const</span> serverIpAddress: socket.NetAddress = {</li><li>      address: CommonConstants.IP_ADDRESS,</li><li>      port: CommonConstants.IP_PORT</li><li>    } <span class="hljs-keyword">as</span> socket.NetAddress;</li><li>    tcpConnect.address = serverIpAddress;</li><li>    tcpConnect.timeout = <span class="hljs-number">3000</span>;</li><li>    <span class="hljs-keyword">this</span>.tcp?.connect(tcpConnect, (err: BusinessError) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        Logger.error(<span class="hljs-string">'connect fail'</span>);</li><li>        <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: $r(<span class="hljs-string">'app.string.connect_error'</span>) });</li><li>        <span class="hljs-keyword">this</span>.getUIContext().getPromptAction().showToast({ message: <span class="hljs-string">"Connect error"</span> });</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>    });</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L58-L166" target="_blank">SocketReconnection.ets</a></div></div></div></div> <p>无网络切换有网络后重连下载效果图如下。</p> <div class="fignone"><span class="figcap"><b>图1 </b>无网络切换有网络后重连下载</span><br><span><img height="545.965" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163024.55468433255492633519467074669004:50001231000000:2800:9F4BA8A6D173884B7A8591F808E97896FFB42E85192B20B13143A5FF8F7AD1D5.gif" title="点击放大" width="266"></span></div> <div class="tiledSection"><h2 id="section6593152718515">应用前后台切换后重连<i class="anchor-icon anchor-icon-link" anchorid="section6593152718515" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section386610451357" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section386610451357" tips="复制节点链接"></i></h3><p>应用在使用TCPSocket、UDPSocket等通信时，如果未申请长时任务或短时任务，当应用退到后台一段时间后，可能遇到网络不可用或网络资源异常的情况，并且将应用切回前台后，继续使用之前的TCPSocket、UDPSocket等连接对象继续和服务器通信也可能出现网络异常。</p> </div> <div class="tiledSection"><h3 id="section029512587512">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section029512587512" tips="复制节点链接"></i></h3><p>在HarmonyOS中，应用切换到后台2秒后，应用的网络资源会被冻结，并且在12秒后进行释放。此时，再继续使用网络资源，就会出现网络不可用的情况。如果应用有后台使用网络资源的场景，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/transient-task" target="_blank">短时任务</a>或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task" target="_blank">长时任务</a>。</p> <p>由于Socket通信是基于IP和端口进行通信的，在应用退到后台后，网络资源被冻结时会清空TCP、UDP连接对象的IP和端口，但是不会释放连接对象。在应用切换到前台后，系统会给连接对象重新分配新的IP和端口，继续使用之前的连接对象与服务器进行通信时，服务器会认为同一个连接对象前后IP和端口不一致，从而导致通信不可信、网络异常。</p> <p>应用前后台切换后网络重连在实现上有以下两个关键部分。</p> <ul><li>结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-lifecycle" target="_blank">UIAbility组件生命周期</a>onForeground和onBackground，在前后台切换时，将应用前后台的状态存储在AppStorage中。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage#storageprop" target="_blank">@StorageProp</a>将AppStorage存储的前后台状态与对应的属性建立单向数据同步。并使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-watch" target="_blank">@Watch</a>监听状态变量的变化，当前后台变化后，关闭或重新连接。</li></ul> </div> <div class="tiledSection"><h3 id="section194981716769">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section194981716769" tips="复制节点链接"></i></h3><p>前后台切换时，在UIAbility组件生命周期中存储前后台状态。</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/entryability/EntryAbility.ets#L7-L55" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> EntryAbility extends <span class="hljs-built_in">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  onForeground(): <span class="hljs-type">void</span> {</li><li>    <span class="hljs-comment">// Ability has brought to foreground</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    hilog.info(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onForeground'</span>);</li><li>  }</li><li>
</li><li>  onBackground(): <span class="hljs-type">void</span> {</li><li>    <span class="hljs-comment">// Ability has back to background</span></li><li>    <span class="hljs-comment">// ...</span></li><li>    AppStorage.setOrCreate(<span class="hljs-string">'onForeground'</span>, <span class="hljs-literal">false</span>);</li><li>    hilog.info(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onBackground'</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/entryability/EntryAbility.ets#L7-L55" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>使用@StorageProp同步前后台状态，并使用@Watch监听状态变化。</p> <div class="screenLinkPre"><div _ngcontent-ekn-c106="" class="highlight-div"><div _ngcontent-ekn-c106="" class="highlight-div-header"><div _ngcontent-ekn-c106="" class="highlight-div-header-left"><div _ngcontent-ekn-c106="" class="handle-button expand-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ekn-c106="" class="highlight-div-header-right"><div _ngcontent-ekn-c106="" class="handle-button ai-button"></div><div _ngcontent-ekn-c106="" class="handle-button line-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ekn-c106="" class="handle-button theme-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ekn-c106="" class="handle-button copy-button"><div _ngcontent-ekn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ekn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L34-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@StorageProp</span>(<span class="hljs-string">'onForeground'</span>) <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onForegroundChange'</span>) <span class="hljs-attribute">onForeground</span>: boolean = true;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-selector-tag">onForegroundChange</span>(): <span class="hljs-selector-tag">void</span> {</li><li>  <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.onForeground</span> ? <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.tcpSocketConnect</span>() : <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.tcpSocketDisconnect</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/NetworkReconnection/blob/master/NetworkReconnection/entry/src/main/ets/pages/SocketReconnection.ets#L34-L54" target="_blank">SocketReconnection.ets</a></div></div></div></div> </div> <p>前后台切换网络重连实现效果如下：</p> <div class="fignone"><span class="figcap"><b>图2 </b>应用前后台切换后重连下载</span><br><span><img height="545.965" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163024.80058473487777933275383545224157:50001231000000:2800:A4C9EC059AF82B3AFAFB4D441FEEDF90C86541550C2FA36C481E0B142CEA4312.gif" title="点击放大" width="266"></span></div> <div class="tiledSection"><h2 id="section1367813421863">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1367813421863" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/NetworkReconnection" target="_blank">实现应用网络重连功能</a></li></ul> </div> </div></div>