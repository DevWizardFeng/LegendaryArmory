<h1 _ngcontent-kre-c119="" class="doc-title ng-star-inserted" title="文件上传下载优化"> 文件上传下载优化 </h1>

<div _ngcontent-kre-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1759621516208">概述<i class="anchor-icon anchor-icon-link" anchorid="section1759621516208" tips="复制节点链接"></i></h2></div> <p>在开发应用时，客户端与服务器之间数据交换的效率取决于文件传输的性能。数据交换性能较低的应用会导致加载时间延长，在多个场景中造成页面卡顿，严重影响用户体验。相反，数据交换高效的应用会提升应用的流畅性。</p> <p>本文介绍数据压缩和断点续传，减少带宽占用，提高传输效率，提升数据交换性能。</p> <div class="tiledSection"><h2 id="section1778214082217">上传下载接口<i class="anchor-icon anchor-icon-link" anchorid="section1778214082217" tips="复制节点链接"></i></h2><p>目前系统内提供文件上传下载的模块有http模块和request模块。http模块提供基础的HTTP数据请求能力，功能较为基础，本文不做介绍。request模块主要为应用提供上传下载文件和后台传输代理的基础能力。它具备任务管理系统的默认并发功能，可简化下载功能的实现和管理，提升数据传输的安全性，整合通知机制，新增任务状态与进度查询功能，具有灵活性、高效性、可扩展性、可靠性和一致性等优势。</p> <p>具体来说，request模块包含以下功能：</p> <ol><li>任务管理：任务管理包括创建、暂停、恢复、删除任务、文件上传、下载及系统通知。创建的任务分为前端任务和后台任务。前端任务立即执行，模态界面，跟随应用生命周期，数据量小、耗时短，如发布微信朋友圈、微博，优先级高且倾斜带宽资源。后台任务可等待，任意界面，异步执行，数据量大、耗时长，如缓存电影、同步大量数据，优先级低且与应用生命周期无关。</li><li>任务查询管理：查询所有任务、过滤上传任务、过滤下载任务、过滤时间段内任务、过滤前端任务、过滤后台任务、查询指定任务信息、查询指定隐藏任务信息、清理指定任务。</li><li>任务自动恢复：网络条件不满足时任务暂停，条件满足后自动恢复（需HTTP服务器支持断点续传）。</li><li>安全隐私保护：安全隐私保护包括网络权限检查、接口操作安全处理、任务信息加密存储、接口查询隐匿敏感字段、防御遍历攻击和DOS攻击、管理恶意静默后台任务及系统管理接口权限。</li><li>日志：日志分为调试模式和发布模式。调试模式下，可打印所有内存修改、磁盘和网络读写、逻辑分支等日志。发布模式下，仅记录导致任务失败或服务异常的日志，其余日志关闭。</li><li>任务失败重试：对于不可恢复的原因，直接失败；对于可恢复的原因，网络断开、网络类型不匹配等，不现场重试，任务到等待网络恢复队列；网络超时则就地重试1次，仍网络超时，则立即失败。</li><li>服务按需启停：上传下载服务不随系统自启动。应用调用任意接口时，上传下载服务自动启动。网络连接事件也会触发上传下载服务启动。任务队列中无正在处理的任务或等待网络恢复的任务，延迟一段时间后，若仍无任务，则通知系统服务框架(SAMGR)停止并卸载上传下载服务。服务退出过程中，新的接口请求可能失败，客户端需检查服务状态并通过重试按需启动</li><li>通知：任务从开始到结束都应有进度通知。目前，前台任务每1秒、后台任务每3秒触发一次进度通知。任务状态变化时也会触发进度通知。任务完成或失败时，将触发专用的进度通知。创建任务时可开启抑制开关，以减少频繁通知。</li></ol> </div> <div class="tiledSection"><h3 id="section14912941192217" class="firsth2">下载任务的状态迁移流程<i class="anchor-icon anchor-icon-link" anchorid="section14912941192217" tips="复制节点链接"></i></h3><p>使用request模块执行下载的任务，具有四种运行状态：初始任务、就绪任务、挂起任务、待网任务。可以通过create()创建任务，start()开始任务，pause()挂起任务，resume()恢复任务，remove()移除任务，stop()停止任务，任务结果有final-failed任务失败，final-completed下载完成，recoverable-failed重试失败，并支持查询任务状态，具体流程如下图所示：</p> <div class="fignone"><span class="figcap"><b>图1 </b>模块流程图</span><br><span><img height="666.859606" originheight="610" originwidth="771" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163429.31718912925047499861565772394612:50001231000000:2800:44F432F70DD25E496B6292354256A2F1F1546EF70A9DF840AE6EF5DB05BE7FE6.png" title="点击放大" width="842.8875"></span></div> </div> <div class="tiledSection"><h2 id="section14487421122317">常见场景和解决方案<i class="anchor-icon anchor-icon-link" anchorid="section14487421122317" tips="复制节点链接"></i></h2><p><strong>场景1：低带宽网络上传琐碎文件场景</strong></p> <p>在网络连接不佳、带宽较低的环境中，HTTP连接的建立时间可能显著增加。此时，进行数据压缩可以加速页面加载，减少HTTP请求次数和移动数据流量。</p> <p><strong>场景2：处理大量资源的场景</strong></p> <p>应用商店和网盘应用等包含大量大体积文件资源。当用户从暂停或断网中恢复时，从头开始上传或下载会额外耗费大量时间。此时可以采用断点续传方法进行上传和下载。</p> </div> <div class="tiledSection"><h3 id="section6312574242" class="firsth2">数据压缩<i class="anchor-icon anchor-icon-link" anchorid="section6312574242" tips="复制节点链接"></i></h3><p>数据压缩减少存储空间和传输量，节省带宽，提高加载速度。在网络传输和存储中，特别是在处理大量数据或频繁传输数据时，数据压缩发挥重要作用。</p> <p>在应用开发中，常见的数据压缩技术分类如下：</p> <ul><li>有损压缩：仅限图片、视频、音频等文件适用。通过减少图片和视频文件的分辨率、降低音频的音质等手段，减少文件大小，从而实现减少加载时间和带宽消耗。</li><li>无损压缩：对一些零碎文件，可以使用zlib（Zip模块）进行打包压缩，减少上传请求次数；对一些大文件，可以利用缓存技术，服务器将曾经上传过的大文件MD5码缓存起来，本地在上传前预生成MD5码并传输到服务器进行比对，如果相同则说明服务器存在该文件，可以跳过该文件上传，从而省略重复传输时间。</li></ul> <p>以批量上传分辨率为480×640、24位、平均大小为50至120KB的照片为例，在设备上测试的结果如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>文件上传耗时</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.6.2.4.1.1" valign="top" width="33.33333333333333%"><p>上传照片数量</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.2.4.1.2" valign="top" width="33.3033303330333%"><p>优化前耗时（ms）</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.6.2.4.1.3" valign="top" width="33.36333633363336%"><p>优化后耗时（ms）</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>10</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>470</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>526</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>20</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>1124</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>1091</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>...</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>50</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>2379</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>2138</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>80</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>3950</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>3258</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>...</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>100</p> </td> <td class="cellrowborder" valign="top" width="33.3033303330333%"><p>5276</p> </td> <td class="cellrowborder" valign="top" width="33.36333633363336%"><p>3906</p> </td> </tr>  </tbody></table></div> </div> <div class="fignone"><span class="figcap"><b>图2 </b>上传数量和耗时对比图表</span><br><span><img height="340.70011500000004" originheight="452" originwidth="794" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163429.51259712783785415944739945613524:50001231000000:2800:63AF7AB584EE8E54E2FE6CABD72ED2FBBAA1739C49A4B35C13DCF5D3320E6536.png" title="点击放大" width="598.5"></span></div> <p>由于上传耗时受网络状态影响较大，结果取多次测量的最小值。尽管如此，数据仍显示优化前的耗时呈线性增长，而压缩优化后的耗时在上传文件数量较少时变化不明显，甚至因额外的压缩处理而增加耗时。然而，随着上传照片数量的增加，优化后的耗时与优化前的差距逐渐增大，优化效果更加显著。</p> <p><strong>数据压缩的相关示例代码如下：</strong></p> <ol><li>导入相关模块:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L17-L21" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { fileIo } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, zlib } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { hilog } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.PerformanceAnalysisKit'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L17-L21" target="_blank">ZipUploadPage.ets</a></div></div></div></div> </li><li>创建压缩上传相关类:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L25-L31" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ZipUpload</span> {</li><li>  <span class="hljs-comment">// Uri stored before creating the task</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">waitList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  <span class="hljs-comment">// Files that need to be uploaded uri</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">fileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [];</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L25-L31" target="_blank">ZipUploadPage.ets</a></div></div></div></div> </li><li>建立用于接收图库图片的临时文件夹，并将整个临时文件夹打包添加到待上传list内:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L42-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Data compression processing</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">zipUploadFiles</span>(<span class="hljs-attr">fileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>    <span class="hljs-keyword">let</span> cacheDir = <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>.<span class="hljs-property">cacheDir</span>;</li><li>    <span class="hljs-keyword">let</span> tempDir = fileIo.<span class="hljs-title function_">mkdtempSync</span>(<span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span>/XXXXXX`</span>);</li><li>    <span class="hljs-comment">// Put the uri obtained from the library picture into fileUris and copy it to the temporary folder.</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; fileUris.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">let</span> fileName = fileUris[i].<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">resourceFile</span>: fileIo.<span class="hljs-property">File</span> = fileIo.<span class="hljs-title function_">openSync</span>(fileUris[i], fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>);</li><li>      fileIo.<span class="hljs-title function_">copyFileSync</span>(resourceFile.<span class="hljs-property">fd</span>, <span class="hljs-string">`<span class="hljs-subst">${tempDir}</span>/<span class="hljs-subst">${fileName}</span>`</span>, <span class="hljs-number">0</span>);</li><li>      fileIo.<span class="hljs-title function_">closeSync</span>(resourceFile);</li><li>    }</li><li>    <span class="hljs-comment">// File compression, package the previously generated temporary folder into test.zip</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: zlib.<span class="hljs-property">Options</span> = {</li><li>      <span class="hljs-attr">level</span>: zlib.<span class="hljs-property">CompressLevel</span>.<span class="hljs-property">COMPRESS_LEVEL_DEFAULT_COMPRESSION</span>,</li><li>      <span class="hljs-attr">memLevel</span>: zlib.<span class="hljs-property">MemLevel</span>.<span class="hljs-property">MEM_LEVEL_DEFAULT</span>,</li><li>      <span class="hljs-attr">strategy</span>: zlib.<span class="hljs-property">CompressStrategy</span>.<span class="hljs-property">COMPRESS_STRATEGY_DEFAULT_STRATEGY</span></li><li>    };</li><li>    <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> zlib.<span class="hljs-title function_">compressFile</span>(tempDir, <span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span>/test.zip`</span>, options);</li><li>    <span class="hljs-comment">// Delete temporary folders</span></li><li>    fileIo.<span class="hljs-title function_">rmdirSync</span>(tempDir);</li><li>    <span class="hljs-comment">// Put the generated zip package into the transmission queue.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">waitList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${cacheDir}</span>/test.zip`</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'FileUploadAndDownloadSlow'</span>, <span class="hljs-string">`zipUploadFiles error <span class="hljs-subst">${error.code}</span> <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/FileUploadAndDownloadSlow/entry/src/main/ets/pages/ZipUploadPage.ets#L42-L70" target="_blank">ZipUploadPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section103551219102513">断点续传<i class="anchor-icon anchor-icon-link" anchorid="section103551219102513" tips="复制节点链接"></i></h3><p>断点续传功能的实现需要应用端和服务器端的合理技术协同。在实际开发中，开发者无需亲自实现断点续传功能，只需对SDK进行合理配置。</p> <p>应用端需要使用以下技术和API：</p> <ul><li>fileIo（文件管理）：用于处理文件上传操作，提供了读取文件内容，文件分片和组合的功能。</li><li>hash（文件哈希处理）：用于实现文件MD5的计算，将计算的MD5值预先传到服务器端进行预处理，实现文件秒传，同时确保传输的准确性和可靠性。</li><li>request（上传下载）：用于实现文件上传操作，并支持在上传过程中的断点续传功能。</li></ul> <p>服务器端需要以下技术：</p> <ul><li>协议需要支持Range，用于服务器端处理文件上传下载的断点续传。</li><li>文件校验相关逻辑：实现文件校验，确保传输中断后能准确恢复并继续传输。</li></ul> <p>结合应用端和服务器端技术，实现高效可靠的文件断点续传功能，提升用户体验并确保数据传输稳定。</p> <p>本文基于<a href="https://gitee.com/harmonyos_samples/upload-and-down-load" target="_blank">上传和下载</a>中的后台上传场景，给出了部分断点续传的示例代码，具体可以参考该工程。</p> </div> <div class="tiledSection"><h3 id="section1485114332616">文件上传<i class="anchor-icon anchor-icon-link" anchorid="section1485114332616" tips="复制节点链接"></i></h3><p>本文使用request模块中的<strong>request.agent</strong><strong>()</strong>任务托管接口，自动实现暂停、继续、重试等操作，无需手动分片和记录分片信息。流程图如下：</p> <div class="fignone"><span class="figcap"><b>图3 </b>断点续传上传流程图</span><br><span><img height="536.655" originheight="759" originwidth="740" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163429.83371679621162198870138469826517:50001231000000:2800:22E5E4CF05F72E367FF896D36BCA00340DF7A063BE63CF893D6A214183532BD6.png" title="点击放大" width="523.6875"></span></div> <ol><li>导入相关模块:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L17-L18" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L17-L18" target="_blank">RequestUpload.ets</a></div></div></div></div> </li><li>创建相关上传类:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L30-L295" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Upload</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">backgroundTask</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Task</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">waitList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt; = [];</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L30-L295" target="_blank">RequestUpload.ets</a></div></div></div></div> </li><li>配置Config，创建后台上传任务:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L35-L290" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span> = {</li><li>  <span class="hljs-variable">action</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Action</span>.<span class="hljs-title class_">UPLOAD</span>,</li><li>  <span class="hljs-variable">headers</span>: <span class="hljs-title class_">HEADER</span>,</li><li>  <span class="hljs-variable">url</span>: <span class="hljs-string">''</span>,</li><li>  <span class="hljs-variable">mode</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Mode</span>.<span class="hljs-title class_">FOREGROUND</span>,</li><li>  <span class="hljs-variable">method</span>: <span class="hljs-string">'POST'</span>,</li><li>  <span class="hljs-variable">title</span>: <span class="hljs-string">'upload'</span>,</li><li>  <span class="hljs-variable">network</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Network</span>.<span class="hljs-title class_">ANY</span>,</li><li>  <span class="hljs-variable">data</span>: [],</li><li>  <span class="hljs-variable">token</span>: <span class="hljs-title class_">UPLOAD_TOKEN</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">createBackgroundTask</span>(<span class="hljs-variable">fileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>.<span class="hljs-variable">url</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">urlUtils</span>.<span class="hljs-title function_">getUrl</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>.<span class="hljs-variable">data</span> = <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getFilesAndData</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">cacheDir</span>, <span class="hljs-variable">fileUris</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>.<span class="hljs-variable">mode</span> = <span class="hljs-variable">request</span>.<span class="hljs-variable">agent</span>.<span class="hljs-variable">Mode</span>.<span class="hljs-variable">BACKGROUND</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">backgroundTask</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">request</span>.<span class="hljs-variable">agent</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">config</span>);</li><li>    <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">backgroundTask</span>.<span class="hljs-title function_">start</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">state</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title class_">get</span>&lt;<span class="hljs-title class_">number</span>&gt;(<span class="hljs-string">'backTaskState'</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">state</span> === <span class="hljs-variable">BackgroundTaskState</span>.<span class="hljs-variable">PAUSE</span>) {</li><li>      <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">backgroundTask</span>.<span class="hljs-title function_">pause</span>();</li><li>    }</li><li>    <span class="hljs-variable">logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">createBackgroundTask</span> <span class="hljs-variable">success</span>`);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">task</span>  <span class="hljs-variable">err</span>, <span class="hljs-variable">err</span>  = ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">getFilesAndData</span>(<span class="hljs-variable">cacheDir</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">fileUris</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">FormItem</span>&gt;&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L35-L290" target="_blank">RequestUpload.ets</a></div></div></div></div> </li><li>任务开始:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L118-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.backgroundTask.start();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L118-L118" target="_blank">RequestUpload.ets</a></div></div></div></div> </li><li>任务暂停，可以暂停正在等待/正在运行/正在重试的任务:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L234-L247" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">pause</span>(<span class="hljs-params"></span>) {</li><li>  logger.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'pause'</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">backgroundTask</span> === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">backgroundTask</span>.<span class="hljs-title function_">pause</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`pause fail,err= <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L234-L247" target="_blank">RequestUpload.ets</a></div></div></div></div> </li><li>任务继续，已暂停的任务可被resume恢复:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L251-L264" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">resume</span>(<span class="hljs-params"></span>) {</li><li>  logger.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'resume'</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">backgroundTask</span> === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">backgroundTask</span>.<span class="hljs-title function_">resume</span>();</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    logger.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`resume fail,err= <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/upload/RequestUpload.ets#L251-L264" target="_blank">RequestUpload.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section1559881416269">文件下载<i class="anchor-icon anchor-icon-link" anchorid="section1559881416269" tips="复制节点链接"></i></h3><p>对于大文件断点续传下载，可以直接调用 <strong>request.agent</strong><strong>()</strong>接口。该接口的断点续传功能基于HTTP协议Header中的Range字段实现。在任务暂停并重启时，会自动设置Header中的Range字段，无需额外配置。</p> <p><strong>Range简介</strong></p> <p>HTTP协议中的Range字段允许服务器发送部分HTTP消息到客户端，用于请求部分数据。</p> <p>Range的格式通常是Range: &lt;unit&gt;=&lt;start&gt;-&lt;end&gt;，其中&lt;unit&gt;表示范围所采用的单位，通常是字节（bytes），&lt;start&gt; 和 &lt;end&gt; 表示请求的起始字节和结束字节的位置。</p> <p>Range语法如下:</p> <div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Indicates from range-start to the end of the file.</span></li><li><span class="hljs-variable">Range</span>: &lt;<span class="hljs-title class_">unit</span>&gt;=&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">start</span>&gt;-</li><li><span class="hljs-comment">// Indicates from range-start to range-end.</span></li><li><span class="hljs-variable">Range</span>: &lt;<span class="hljs-title class_">unit</span>&gt;=&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">start</span>&gt;-&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">end</span>&gt;</li><li><span class="hljs-comment">// You can select multiple segments simultaneously, separated by commas.</span></li><li><span class="hljs-variable">Range</span>: &lt;<span class="hljs-title class_">unit</span>&gt;=&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">start</span>&gt;-&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">end</span>&gt;, &lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">start</span>&gt;-&lt;<span class="hljs-title class_">range</span>-<span class="hljs-title class_">end</span>&gt;</li><li>
</li><li><span class="hljs-comment">// Example: Indicates the file after returning 1024 bytes.</span></li><li><span class="hljs-variable">Range</span>: <span class="hljs-title class_">bytes</span>=<span class="hljs-number">1024</span>-</li></ol></pre></div></div> <p>服务器收到请求后，正确处理会回复206 Partial Content，未正常处理则回复其他响应码。下表列出服务器回复的常见响应码：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>服务器回复响应码</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.9.2.3.1.1" valign="top" width="50%"><p>服务器响应码</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.9.2.3.1.2" valign="top" width="50%"><p>常见的原因</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>206 Partial Content</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>服务器收到正常Range请求的响应码，返回部分内容的响应。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>416 Range Not Satisfiable</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>所请求的范围不合法，表示服务器错误。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>200 OK</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>服务器忽略了Range首部，返回整个文件。</p> </td> </tr>  </tbody></table></div> </div> <p><strong>断点续传下载示例代码如下：</strong></p> <ol><li>导入模块:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L17-L18" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, request } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L17-L18" target="_blank">RequestDownload.ets</a></div></div></div></div> </li><li>创建下载类:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L35-L260" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestDownload</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">waitList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>[]&gt; = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">downloadTask</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Task</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L35-L260" target="_blank">RequestDownload.ets</a></div></div></div></div> </li><li>配置Config，创建后台下载任务:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L88-L116" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">async</span> <span class="hljs-title function_">createBackgroundTask</span>(<span class="hljs-variable">downloadList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>[]&gt;) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">downloadList</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">splitUrl</span> = <span class="hljs-variable">downloadList</span>[<span class="hljs-variable">i</span>][<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">'//'</span>)[<span class="hljs-number">1</span>].<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">downloadConfig</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span> = {</li><li>        <span class="hljs-variable">action</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Action</span>.<span class="hljs-title class_">DOWNLOAD</span>,</li><li>        <span class="hljs-variable">url</span>: <span class="hljs-title class_">downloadList</span>[<span class="hljs-title class_">i</span>][<span class="hljs-number">1</span>],</li><li>        <span class="hljs-variable">method</span>: <span class="hljs-string">'POST'</span>,</li><li>        <span class="hljs-variable">title</span>: <span class="hljs-string">'download'</span>,</li><li>        <span class="hljs-variable">mode</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Mode</span>.<span class="hljs-title class_">BACKGROUND</span>,</li><li>        <span class="hljs-variable">network</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Network</span>.<span class="hljs-title class_">ANY</span>,</li><li>        <span class="hljs-variable">saveas</span>: `./${<span class="hljs-variable">downloadList</span>[<span class="hljs-variable">i</span>][<span class="hljs-number">0</span>]}/${<span class="hljs-variable">splitUrl</span>[<span class="hljs-variable">splitUrl</span>.<span class="hljs-variable">length</span>-<span class="hljs-number">1</span>]}`,</li><li>        <span class="hljs-variable">overwrite</span>: <span class="hljs-keyword">true</span>,</li><li>        <span class="hljs-variable">gauge</span>: <span class="hljs-keyword">true</span></li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">downTask</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">request</span>.<span class="hljs-variable">agent</span>.<span class="hljs-title function_">create</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">downloadConfig</span>);</li><li>      <span class="hljs-variable">await</span> <span class="hljs-variable">downTask</span>.<span class="hljs-title function_">start</span>();</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>      <span class="hljs-variable">logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">task</span>  <span class="hljs-variable">err</span> <span class="hljs-variable">code</span>=${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>=${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">waitList</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">downloadList</span>[<span class="hljs-variable">i</span>]);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L88-L116" target="_blank">RequestDownload.ets</a></div></div></div></div> </li><li>任务开始:<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L108-L108" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">await</span> downTask.start();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/upload-and-down-load/blob/master/features/uploadanddownload/src/main/ets/download/RequestDownload.ets#L108-L108" target="_blank">RequestDownload.ets</a></div></div></div></div> </li></ol> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>对文件进行上传下载过程中，若在错误的任务状态下调用了不应使用的接口，在不支持的状态上操作任务，任务分组不存在或已移除等情况，均会导致无法正常停止、恢复文件的上传下载任务。具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/errorcode-request" target="_blank">上传下载错误码</a>。</p> </div></div></div> <div class="tiledSection"><h3 id="section112431714165217">多文件下载监听<i class="anchor-icon anchor-icon-link" anchorid="section112431714165217" tips="复制节点链接"></i></h3><p>文件下载监听是指在单文件下载的功能基础上，同时进行多个文件下载进度和状态的监听管理。实际开发中，需要使用request上传下载模块实现，包括监听每个文件下载任务的进度，任务是否暂停，下载是否完成等状态情况。相关规格说明参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentcreate10-1" target="_blank">request.agent.create()</a>。</p> <p>以具体场景为例，下图是常见的多文件下载列表：</p> <p><span><img height="545.566" originheight="661" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163429.92065469952828138390050087511141:50001231000000:2800:F9965160E01E20D5677BC7A3B3E79313465A6A0385B4934E4A4C3A65E7B13815.png" title="点击放大" width="266"></span></p> <p>进入页面后，点击“全部开始”按钮，启动所有文件的下载任务。点击“全部暂停”按钮，暂停所有文件的下载任务。再次点击“全部开始”按钮，可重新启动未完成的下载任务。下载完成的文件将保存在应用的缓存路径下。如果下载失败，通常是因为网络不稳定，点击“全部开始”按钮可重新下载。</p> <p><strong>实现思路</strong></p> <ol><li>配置下载参数。下载任务需对应配置一套下载参数request.agent.Config。本例中使用downloadConfig方法配置下载文件的URL，实际业务中按需调整。<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/pages/Index.ets#L29-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">function</span> <span class="hljs-title function_">downloadConfig</span>(<span class="hljs-variable">downloadUrl</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span> = {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Action</span>.<span class="hljs-title class_">DOWNLOAD</span>,</li><li>    <span class="hljs-variable">url</span>: <span class="hljs-title class_">downloadUrl</span>,</li><li>    <span class="hljs-variable">overwrite</span>: <span class="hljs-keyword">true</span>,</li><li>    <span class="hljs-variable">method</span>: <span class="hljs-string">'GET'</span>,</li><li>    <span class="hljs-variable">saveas</span>: <span class="hljs-string">'./'</span>,</li><li>    <span class="hljs-variable">mode</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Mode</span>.<span class="hljs-title class_">BACKGROUND</span>,</li><li>    <span class="hljs-variable">gauge</span>: <span class="hljs-keyword">true</span>,</li><li>    <span class="hljs-variable">retry</span>: <span class="hljs-keyword">false</span></li><li>  };</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">config</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/pages/Index.ets#L29-L41" target="_blank">Index.ets</a></div></div></div></div> </li><li>创建多个文件下载监听实例。每个文件下载监听需配置下载参数，创建下载任务，注册任务监听，启动下载任务。多文件下载监听中，每个下载任务需注册独立的监听回调。示例中，通过封装自定义组件FileDownloadItem，在每个FileDownloadItem中创建各自的下载任务和监听回调，实现多文件下载监听。<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/pages/Index.ets#L157-L166" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">downloadConfigArray</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span>) =&gt; {</li><li>  <span class="hljs-title function_">ListItem</span>() {</li><li>    <span class="hljs-title function_">FileDownloadItem</span>({</li><li>      <span class="hljs-variable">downloadConfig</span>: <span class="hljs-title class_">item</span>,</li><li>      <span class="hljs-variable">isStartAllDownload</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isStartAllDownload</span>,</li><li>      <span class="hljs-variable">downloadCount</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">downloadCount</span>,</li><li>      <span class="hljs-variable">downloadFailCount</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">downloadFailCount</span></li><li>    })</li><li>  }</li><li>}, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">request</span>.<span class="hljs-title class_">agent</span>.<span class="hljs-title class_">Config</span>) =&gt; <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">item</span>))</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/pages/Index.ets#L157-L166" target="_blank">Index.ets</a></div></div></div></div> </li><li>创建下载任务并注册相关监听。本例中，在每个 `FileDownloadItem` 中使用 `request.agent.create()` 创建下载任务。下载任务创建成功后，注册以下回调：下载完成、下载失败、进度更新、暂停、重新启动以及响应头数据。在相应的回调中，获取当前文件的下载状态等数据。<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L155-L172" data-highlighted="yes"><ol class="linenums"><li>request.agent.create(context, <span class="hljs-keyword">this</span>.downloadConfig).then((task: request.agent.Task) =&gt; {</li><li>  task.on(<span class="hljs-string">'completed'</span>, <span class="hljs-keyword">this</span>.completedCallback);</li><li>  task.on(<span class="hljs-string">'failed'</span>, <span class="hljs-keyword">this</span>.failedCallback);</li><li>  task.on(<span class="hljs-string">'pause'</span>, <span class="hljs-keyword">this</span>.pauseCallback);</li><li>  task.on(<span class="hljs-string">'resume'</span>, <span class="hljs-keyword">this</span>.resumeCallback);</li><li>  task.on(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>.progressCallback);</li><li>  task.on(<span class="hljs-string">'response'</span>, <span class="hljs-keyword">this</span>.responseCallback);</li><li>
</li><li>  task.start().then(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.downloadTask = task;</li><li>  }).<span class="hljs-keyword">catch</span>((err: Error) =&gt; {</li><li>    hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'task start error:'</span>, err);</li><li>  })</li><li>}).<span class="hljs-keyword">catch</span>((err: Error) =&gt; {</li><li>  hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'create error:'</span>, err);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L155-L172" target="_blank">FileDownloadItem.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L56-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> completedCallback = (progress: request.agent.Progress) =&gt; {</li><li>  <span class="hljs-keyword">this</span>.textState = $r(<span class="hljs-string">"app.string.download_completed"</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.sFileSize === -<span class="hljs-number">1</span>) {</li><li>    <span class="hljs-keyword">this</span>.sFileSize = <span class="hljs-keyword">this</span>.sCurrentDownloadSize</li><li>    <span class="hljs-keyword">this</span>.nCurrentDownloadSize = <span class="hljs-number">1</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.downloadCount--;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L56-L63" target="_blank">FileDownloadItem.ets</a></div></div></div></div> </li><li>启动下载任务。本例在每个FileDownloadItem中使用task.start()方法启动各自的下载任务。此外，start()方法也可以启动一个已失败或已停止的下载任务，从上次的进度开始续传。<div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L164-L168" data-highlighted="yes"><ol class="linenums"><li>task.<span class="hljs-title function_">start</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">downloadTask</span> = task;</li><li>}).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: <span class="hljs-built_in">Error</span></span>) =&gt;</span> {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'task start error:'</span>, err);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L164-L168" target="_blank">FileDownloadItem.ets</a></div></div></div></div> </li><li><p>管理下载任务。在每个FileDownloadItem中，根据下载任务的状态，使用task.pause()和task.resume()方法分别控制任务的暂停和恢复。</p> <div class="screenLinkPre"><div _ngcontent-kre-c106="" class="highlight-div"><div _ngcontent-kre-c106="" class="highlight-div-header"><div _ngcontent-kre-c106="" class="highlight-div-header-left"><div _ngcontent-kre-c106="" class="handle-button expand-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kre-c106="" class="highlight-div-header-right"><div _ngcontent-kre-c106="" class="handle-button ai-button"></div><div _ngcontent-kre-c106="" class="handle-button line-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kre-c106="" class="handle-button theme-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kre-c106="" class="handle-button copy-button"><div _ngcontent-kre-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kre-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L180-L229" data-highlighted="yes"><ol class="linenums"><li>pauseOrResumeDownload(): void {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downloadTask) {</li><li>    request.agent.show(<span class="hljs-keyword">this</span>.downloadTask.tid, (err: Error, taskInfo: request.agent.TaskInfo) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'agent show error:'</span>, err);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (taskInfo.progress.state === request.agent.State.PAUSED) {</li><li>        <span class="hljs-keyword">this</span>.resumeDownload();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.pauseDownload();</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li>pauseDownload(): void {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downloadTask) {</li><li>    request.agent.show(<span class="hljs-keyword">this</span>.downloadTask.tid, (err: Error, taskInfo: request.agent.TaskInfo) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'agent show error:'</span>, err);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downloadTask &amp;&amp; (taskInfo.progress.state === request.agent.State.WAITING || taskInfo.progress.state</li><li>        === request.agent.State.RUNNING || taskInfo.progress.state === request.agent.State.RETRYING)) {</li><li>        <span class="hljs-keyword">this</span>.downloadTask.pause().then(() =&gt; {</li><li>        }).<span class="hljs-keyword">catch</span>((err: Error) =&gt; {</li><li>          hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'task pause error:'</span>, err);</li><li>        });</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li>resumeDownload(): void {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downloadTask) {</li><li>    request.agent.show(<span class="hljs-keyword">this</span>.downloadTask.tid, (err: Error, taskInfo: request.agent.TaskInfo) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'agent show error:'</span>, err);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.downloadTask &amp;&amp; taskInfo.progress.state === request.agent.State.PAUSED) {</li><li>        <span class="hljs-keyword">this</span>.downloadTask.resume().then(() =&gt; {</li><li>        }).<span class="hljs-keyword">catch</span>((err: Error) =&gt; {</li><li>          hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'task resume error:'</span>, err);</li><li>        });</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/multi-file-download/blob/master/entry/src/main/ets/view/FileDownloadItem.ets#L180-L229" target="_blank">FileDownloadItem.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section85613785113">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section85613785113" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/upload-and-down-load" target="_blank">上传和下载</a></li><li><a href="https://gitee.com/harmonyos_samples/multi-file-download" target="_blank">多文件下载监听</a></li></ul> </div> </div> <div></div></div>