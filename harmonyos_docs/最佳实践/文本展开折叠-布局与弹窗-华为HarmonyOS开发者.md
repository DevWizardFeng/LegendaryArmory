<h1 _ngcontent-pyg-c119="" class="doc-title ng-star-inserted" title="文本展开折叠"> 文本展开折叠 </h1>

<div _ngcontent-pyg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section12457324132917">概述<i class="anchor-icon anchor-icon-link" anchorid="section12457324132917" tips="复制节点链接"></i></h2><p>列表中的博文、评论等复合型内容组件，在文本行数超过预设阈值时，触发“展开”“收起”的功能。内容收起时，如果有用“图片”展示“表情”的功能场景，由于图片出现的位置和大小都不固定，在收起展开时，截止到文字结尾的位置不好判断。</p> <p>本文将介绍解决这一问题的基本逻辑和解决方案，帮助开发者使用系统自带模块，更简洁的解决问题。</p> <p><span><img height="469.95550000000003" originheight="765" originwidth="866" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162904.47579894621196026428292969721634:50001231000000:2800:FED9800CDB5A4215E2E6E1BD9124C8E918F1EF35A7B50206B79BFDEE8FFA8FA1.png" title="点击放大" width="532"></span></p> </div> <div class="tiledSection"><h2 id="section1958815314316">纯文本展开折叠<i class="anchor-icon anchor-icon-link" anchorid="section1958815314316" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section81279576568" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section81279576568" tips="复制节点链接"></i></h3><p>在示例列表中显示纯文本展开和收起功能，文本与按钮的显示变化。</p> <ol><li>文本中只有文字。</li><li>超出2行要能显示"...展开"，展开后显示收起。</li></ol> </div> <p><span><img height="465.6899240000001" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162904.41934487336652220310224785110389:50001231000000:2800:3E0520F38BDE7D0280BE5A7D5F312C74968EBECFFF452F42B7A54C39671C64C9.png" title="点击放大" width="225.435"></span></p> <div class="tiledSection"><h3 id="section71514718615">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section71514718615" tips="复制节点链接"></i></h3><p>需要计算出“...”前最后一个文字的索引和显示行高，以确定“收起”“展开”按钮的位置，其原理如图所示：</p> <p><span><img height="534.5802" originheight="552" originwidth="412" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162904.18343266269350345277505377605834:50001231000000:2800:CD39B841D1C923794318F56ABD1DAC2599AB8789C390CE75F294F65B51B5A560.png" title="点击放大" width="399"></span></p> <p>计算文本高度，结合按钮和“...”的宽度，计算收起文本最后一个文字的坐标，换算为对应内容索引，截断显示相应的内容。</p> <p>分别添加“收起”“展开”按钮及交互，进行文本截断内容和全部内容展示的切换。</p> <p>本示例使用measureTextSize()方法判断文字的高度，API20新增<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-measureutils#getparagraphs20" target="_blank">getParagraphs20+</a>方法测算文本。getParagraphs()方法代码量更少，更直观的获取显示行数。</p> </div> <div class="tiledSection"><h3 id="section48661467713">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section48661467713" tips="复制节点链接"></i></h3><ol><li><span>计算原始文本高度 。</span><p></p><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-measureutils#measuretextsize12" target="_blank">measureTextSize()</a>方法来判断总体文字的高度。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/view/TextExpandView.ets#L60-L81" data-highlighted="yes"><ol class="linenums"><li>getIsExpanded() {</li><li>  let titleSize: SizeOptions = <span class="hljs-keyword">this</span>.uiContext.getMeasureUtils().measureTextSize({</li><li>    textContent: <span class="hljs-keyword">this</span>.textSectionAttribute.title, <span class="hljs-comment">//The text content is calculated</span></li><li>    lineHeight: <span class="hljs-keyword">this</span>.textSectionAttribute.lineHeight,</li><li>    constraintWidth: <span class="hljs-keyword">this</span>.textSectionAttribute.constraintWidth, <span class="hljs-comment">//The text layout width is calculated</span></li><li>    fontSize: <span class="hljs-keyword">this</span>.textSectionAttribute.fontSize <span class="hljs-comment">//The text font size is calculated</span></li><li>  });</li><li>  let height = <span class="hljs-keyword">this</span>.getUIContext().px2vp(Number(titleSize.height));</li><li>  <span class="hljs-keyword">if</span> (height &lt;= <span class="hljs-keyword">this</span>.textSectionAttribute.lineHeight * <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-keyword">this</span>.textModifier.needProcess = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.textModifier.title = <span class="hljs-keyword">this</span>.textSectionAttribute.title;</li><li>    <span class="hljs-keyword">return</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.textModifier.needProcess = <span class="hljs-literal">true</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.expanded) {</li><li>    <span class="hljs-keyword">this</span>.collapseText();</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.expandText();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/view/TextExpandView.ets#L60-L81" target="_blank">TextExpandView.ets</a></div></div></div></div> <p></p></li><li><span>计算文本收起高度（示例代码与步骤3同源）。</span><p></p><div class="p">使用measureTextSize()方法来判断两行文字的高度，当前为两行文字的高度。<div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> <span class="hljs-variable">minLinesTextSize</span>: <span class="hljs-title class_">SizeOptions</span> = <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getMeasureUtils</span>().<span class="hljs-title function_">measureTextSize</span>({</li><li>    <span class="hljs-variable">textContent</span>: <span class="hljs-title class_">text</span>,</li><li>    <span class="hljs-variable">fontSize</span>: <span class="hljs-title class_">fontSize</span>,</li><li>    <span class="hljs-variable">maxLines</span>: <span class="hljs-title class_">maxLines</span>,</li><li>    <span class="hljs-variable">wordBreak</span>: <span class="hljs-title class_">WordBreak</span>.<span class="hljs-title class_">BREAK_ALL</span>,</li><li>    <span class="hljs-variable">constraintWidth</span>: <span class="hljs-title class_">textWidth</span></li><li>  });</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">minHeight</span>: <span class="hljs-title class_">Length</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">minLinesTextSize</span>.<span class="hljs-variable">height</span>;</li></ol></pre></div></div> </div> <p></p></li><li><span>获取收起文本，显示收起展开按钮。</span><p></p><p>减少接收文字字符数。当接收文字高度小于指定行数高度时，使文字显示两行收起。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L33-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getShortText</span>(<span class="hljs-variable">textSectionAttribute</span>: <span class="hljs-title class_">TextSectionAttribute</span>, <span class="hljs-variable">lastSpan</span>: <span class="hljs-title class_">string</span>): <span class="hljs-title class_">string</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">text</span> = <span class="hljs-variable">TextUtils</span>.<span class="hljs-title function_">getStringFromResource</span>(<span class="hljs-variable">textSectionAttribute</span>.<span class="hljs-variable">title</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">minLinesTextSize</span>: <span class="hljs-title class_">SizeOptions</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getMeasureUtils</span>().<span class="hljs-title function_">measureTextSize</span>({</li><li>    <span class="hljs-variable">textContent</span>: <span class="hljs-title class_">text</span>,</li><li>    <span class="hljs-variable">fontSize</span>: <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">fontSize</span>,</li><li>    <span class="hljs-variable">maxLines</span>: <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">maxLines</span>,</li><li>    <span class="hljs-variable">wordBreak</span>: <span class="hljs-title class_">WordBreak</span>.<span class="hljs-title class_">BREAK_ALL</span>,</li><li>    <span class="hljs-variable">constraintWidth</span>: <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">constraintWidth</span></li><li>  });</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">minHeight</span>: <span class="hljs-title class_">Length</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">minLinesTextSize</span>?.<span class="hljs-variable">height</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">minHeight</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;</li><li>  }</li><li>  <span class="hljs-comment">// Use the dichotomy to find strings that are exactly two lines in length</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">textStr</span>: <span class="hljs-title class_">string</span>[] = <span class="hljs-variable">Array</span>.<span class="hljs-keyword">from</span>(<span class="hljs-variable">text</span>); <span class="hljs-comment">//Split the string to avoid special characters and inconsistent sizes</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">leftCursor</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rightCursor</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">textStr</span>.<span class="hljs-variable">length</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">cursor</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-variable">rightCursor</span> / <span class="hljs-number">2</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">tempTitle</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>    <span class="hljs-variable">tempTitle</span> = <span class="hljs-variable">text</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">cursor</span>) + <span class="hljs-variable">suffix</span> + <span class="hljs-variable">lastSpan</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">currentLinesTextSize</span>: <span class="hljs-title class_">SizeOptions</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getMeasureUtils</span>().<span class="hljs-title function_">measureTextSize</span>({</li><li>      <span class="hljs-variable">textContent</span>: <span class="hljs-title class_">tempTitle</span>,</li><li>      <span class="hljs-variable">fontSize</span>: <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">fontSize</span>,</li><li>      <span class="hljs-variable">wordBreak</span>: <span class="hljs-title class_">WordBreak</span>.<span class="hljs-title class_">BREAK_ALL</span>,</li><li>      <span class="hljs-variable">constraintWidth</span>: <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">constraintWidth</span></li><li>    });</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">currentLineHeight</span>: <span class="hljs-title class_">Length</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">currentLinesTextSize</span>?.<span class="hljs-variable">height</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">currentLineHeight</span> === <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">currentLineHeight</span> &gt; <span class="hljs-variable">minHeight</span>) {</li><li>      <span class="hljs-comment">// The current character has exceeded two lines, continue to look to the left</span></li><li>      <span class="hljs-variable">rightCursor</span> = <span class="hljs-variable">cursor</span>;</li><li>      <span class="hljs-variable">cursor</span> = <span class="hljs-variable">leftCursor</span> + <span class="hljs-variable">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable">cursor</span> - <span class="hljs-variable">leftCursor</span>) / <span class="hljs-number">2</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// The current character is less than two lines, it may be OK, but you still need to look to the right</span></li><li>      <span class="hljs-variable">leftCursor</span> = <span class="hljs-variable">cursor</span>;</li><li>      <span class="hljs-variable">cursor</span> += <span class="hljs-variable">Math</span>.<span class="hljs-title function_">floor</span>((<span class="hljs-variable">rightCursor</span> - <span class="hljs-variable">cursor</span>) / <span class="hljs-number">2</span>);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">rightCursor</span> - <span class="hljs-variable">leftCursor</span>) &lt;= <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-comment">// The two pointers basically coincide, which means that they have been found</span></li><li>      <span class="hljs-keyword">break</span>;</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">text</span>.<span class="hljs-title function_">substring</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">cursor</span>) + <span class="hljs-variable">suffix</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L33-L80" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section20807127171">富文本展开折叠<i class="anchor-icon anchor-icon-link" anchorid="section20807127171" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section343812401973" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section343812401973" tips="复制节点链接"></i></h3><p>在示例列表中显示富文本展开和收起功能，文本与按钮的显示变化。</p> <ol><li>文本中存在表情。</li><li>文本中文字存在不同颜色、字号。</li><li>超出3行要能显示"...展开"，展开后显示收起。</li><li>关键字有超链接功能。</li></ol> <p>当前展示内容需要针对整个文本做截断并最终显示...和"展开"字眼，例如图片中的文本就比较长，需要在"潮声与你"的位置截断。该场景由于文本中有图片和不同字号的限制，使得计算截断文本的位置比较困难。</p> <p><span><img height="459.52630500000004" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162904.84759861562646481791125496090276:50001231000000:2800:4A17FF033944E0CC175E52374E8A16D115B01A7E4F6163F52CE7956F49028D56.png" title="点击放大" width="222.44250000000002"></span></p> </div> <div class="tiledSection"><h3 id="section567012216911">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section567012216911" tips="复制节点链接"></i></h3><p>需要计算出“...”前最后一个文字的索引和显示行高，以确定“收起”“展开”按钮的位置，其原理如图所示：</p> <p><span><img height="627.5472" originheight="659" originwidth="419" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162904.69537434716140177224904385090883:50001231000000:2800:9C3647E81174FAC0E1961952EEAF0968696A7C6DB2828D672293386B07122D99.png" title="点击放大" width="399"></span></p> <p>使用排版，计算实际需要收起内容的高度，结合按钮和“...”的宽度，计算收起文本最后一个文字的坐标，换算为对应内容索引，截断显示相应的内容。</p> <p>分别添加“收起”“展开”按钮及交互，进行文本截断内容和全部内容展示的切换。</p> </div> <div class="tiledSection"><h3 id="section3926192817915">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section3926192817915" tips="复制节点链接"></i></h3><ol><li><span>引用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-text" target="_blank">graphics.text</a>解析文本、确定内容大小。</span><p></p><p>设置文本解析规则，解析字符串。例如，图片显示位置、大小、文本显示位置、文本颜色、文本字号。</p> <p></p></li><li><span>设置段落排版。</span><p></p><p>创建ParagraphBuilder，初始化文本样式，指定文本大小和文本颜色。注意文本大小这里是传的px，需要用fp2px转换一下（转换时需要考虑字体设置的最大缩放比例和系统字体缩放比例，即选择min(sysFontScale，maxCustomFontScale)）。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L113-L126" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">myTextStyle</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">TextStyle</span> = {</li><li>  <span class="hljs-variable">fontSize</span>: <span class="hljs-title class_">uiContext</span>?.<span class="hljs-title class_">fp2px</span>(<span class="hljs-title class_">fontSize</span>)</li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">myParagraphStyle</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">ParagraphStyle</span> = {</li><li>  <span class="hljs-variable">textStyle</span>: <span class="hljs-title class_">myTextStyle</span>,</li><li>  <span class="hljs-variable">align</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">TextAlign</span>.<span class="hljs-title class_">START</span>,</li><li>  <span class="hljs-variable">maxLines</span>: <span class="hljs-number">300</span>, <span class="hljs-comment">// Just specify a large enough number of rows</span></li><li>  <span class="hljs-variable">breakStrategy</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">BreakStrategy</span>.<span class="hljs-title class_">GREEDY</span>,</li><li>  <span class="hljs-variable">wordBreak</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">WordBreak</span>.<span class="hljs-title class_">BREAK_WORD</span></li><li>};</li><li>
</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">fontCollection</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">text</span>.<span class="hljs-title function_">FontCollection</span>();</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">paragraphGraphBuilder</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">text</span>.<span class="hljs-title function_">ParagraphBuilder</span>(<span class="hljs-variable">myParagraphStyle</span>, <span class="hljs-variable">fontCollection</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L113-L126" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p></li><li><span>添加占位符，指定样式。</span><p></p><p>根据第一步骤解析出来的内容，如果是图片的话，就用addPlaceholder()，添加一张图片占位符，需要指定这张图片的大小（单位px），旁边的文字排版方式，文字基线位置等信息。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L139-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">paragraphGraphBuilder</span>.<span class="hljs-title function_">addPlaceholder</span>({</li><li>  <span class="hljs-variable">width</span>: <span class="hljs-title class_">item</span>.<span class="hljs-title class_">imgWidth</span>,</li><li>  <span class="hljs-variable">height</span>: <span class="hljs-title class_">item</span>.<span class="hljs-title class_">imgHeight</span>,</li><li>  <span class="hljs-variable">align</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">PlaceholderAlignment</span>.<span class="hljs-title class_">BOTTOM_OF_ROW_BOX</span>,</li><li>  <span class="hljs-variable">baseline</span>: <span class="hljs-title class_">text</span>.<span class="hljs-title class_">TextBaseline</span>.<span class="hljs-title class_">IDEOGRAPHIC</span>,</li><li>  <span class="hljs-variable">baselineOffset</span>: <span class="hljs-number">0</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L139-L145" target="_blank">TextUtils.ets</a></div></div></div></div> <p>如果是文字的话，就使用addText()，添加一段文本，添加这段文本之前可以重新通过pushStyle()方法指定这段文本的字体大小和颜色。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L151-L154" data-highlighted="yes"><ol class="linenums"><li>paragraphGraphBuilder<span class="hljs-selector-class">.pushStyle</span>({</li><li>  fontSize: fontSize,</li><li>});</li><li>paragraphGraphBuilder<span class="hljs-selector-class">.addText</span>(item.content);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L151-L154" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p> <p>如果需要使用之前的文本样式，可以通过popStyle()把当前样式pop出去。</p> <p>上面添加的文字大小和图片占位符的大小要同Text控件展示的时候的大小一致，否则会导致计算不准确。</p> <p></p></li><li><span>预排版。</span><p></p><p>全部添加完成之后，使用paragraph的layoutSync()方法预先排版，传递的大小单位也为px。这个layoutSync()传递宽度要同展示的时候的Text文本宽度一致，否则计算出来的和展示的时候肯定不一致。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L164-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">let</span> paragraph = paragraphGraphBuilder.build();</li><li>paragraph.layoutSync(textMaxWidth);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L164-L165" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p></li><li><span>计算截断坐标。</span><p></p><p>计算三个点之前的最后一个文字的坐标。设这个字符变量为lastWord。经过paragraph的排版之后，就可以得到这段文本真实的渲染数据了。先通过paragraph.getLineCount()，计算出来一共排版了多少行，如果超过了自己要设定的行数，或者getLineCount()的行数和自己设定的maxLine一致，但是最后一行的宽度+之前计算出来的widthMore，超过了第四步骤设定的最大宽度，则说明需要截断。</p> <p>计算lastWord文字的Y坐标，通过getLineHeight()获取每一行的高度加起来，其中最后一行高度需要加一半的高度。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L195-L197" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">textSectionAttribute</span>.<span class="hljs-title class_">maxLines</span>; <span class="hljs-title class_">i</span>++) {</li><li>  <span class="hljs-variable">y</span> += <span class="hljs-variable">i</span> === <span class="hljs-variable">textSectionAttribute</span>.<span class="hljs-variable">maxLines</span> - <span class="hljs-number">1</span> ? <span class="hljs-variable">paragraph</span>.<span class="hljs-title function_">getLineHeight</span>(<span class="hljs-variable">i</span>) / <span class="hljs-number">2</span> : <span class="hljs-title class_">paragraph</span>.<span class="hljs-title class_">getLineHeight</span>(<span class="hljs-title class_">i</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L195-L197" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p></li><li><span>计算lastWord的X坐标。</span><p></p><div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L201-L206" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (paragraph.<span class="hljs-title function_">getLineWidth</span>(textSectionAttribute.<span class="hljs-property">maxLines</span> - <span class="hljs-number">1</span>) + <span class="hljs-title class_">Number</span>(widthMore) &gt;</li><li>textSectionAttribute.<span class="hljs-property">constraintWidth</span>) {</li><li>  x = textSectionAttribute.<span class="hljs-property">constraintWidth</span> - <span class="hljs-title class_">Number</span>(widthMore);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  x = paragraph.<span class="hljs-title function_">getLineWidth</span>(textSectionAttribute.<span class="hljs-property">maxLines</span> - <span class="hljs-number">1</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L201-L206" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p> <p></p></li><li><span>转换坐标对应索引。</span><p></p><p>计算lastWord的展示索引位置。拿到lastWord的x与y坐标之后，通过getGlyphPositionAtCoordinate()拿到这个坐标的文字所在段落的索引，这个就是最终文字展示的索引。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L210-L217" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// The conversion coordinates correspond to the index</span></li><li><span class="hljs-keyword">let</span> positionWithAffinity = paragraph.getGlyphPositionAtCoordinate(x, y);</li><li><span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>;</li><li><span class="hljs-keyword">if</span> (positionWithAffinity.affinity === text.Affinity.UPSTREAM) {</li><li>  index = positionWithAffinity.position;</li><li>} <span class="hljs-keyword">else</span> {</li><li>  index = positionWithAffinity.position + <span class="hljs-number">1</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/utils/TextUtils.ets#L210-L217" target="_blank">TextUtils.ets</a></div></div></div></div> <p></p></li><li><span>添加“展开”“收起”按钮。</span><p></p><p>显示展开按钮时使用上面获取的shortContentArray数组数据来渲染，完全展示的时候使用RichTextModel里的textArray数组数据来渲染。判断两种情况分别显示按钮。</p> <div class="screenLinkPre"><div _ngcontent-pyg-c106="" class="highlight-div"><div _ngcontent-pyg-c106="" class="highlight-div-header"><div _ngcontent-pyg-c106="" class="highlight-div-header-left"><div _ngcontent-pyg-c106="" class="handle-button expand-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pyg-c106="" class="highlight-div-header-right"><div _ngcontent-pyg-c106="" class="handle-button ai-button"></div><div _ngcontent-pyg-c106="" class="handle-button line-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pyg-c106="" class="handle-button theme-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pyg-c106="" class="handle-button copy-button"><div _ngcontent-pyg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pyg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/view/RichTextExpandView.ets#L106-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textModifier.needProcess &amp;&amp; !<span class="hljs-keyword">this</span>.textModifier.exceedOneLine) {</li><li>  Span(<span class="hljs-keyword">this</span>.lastSpanAttribute.content[<span class="hljs-number">0</span>])</li><li>    .fontColor(<span class="hljs-keyword">this</span>.lastSpanAttribute.color)</li><li>} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textModifier.exceedOneLine) {</li><li>  Span(<span class="hljs-keyword">this</span>.lastSpanAttribute.content[<span class="hljs-number">1</span>])</li><li>    .fontColor(<span class="hljs-keyword">this</span>.lastSpanAttribute.color)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/TextExpand/blob/master/entry/src/main/ets/view/RichTextExpandView.ets#L106-L112" target="_blank">RichTextExpandView.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section972726173412">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section972726173412" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/TextExpand" target="_blank">文本展开折叠开发实践</a></li></ul> </div> </div></div>