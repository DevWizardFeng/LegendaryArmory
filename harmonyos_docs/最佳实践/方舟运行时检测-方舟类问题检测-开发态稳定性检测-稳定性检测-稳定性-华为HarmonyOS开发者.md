<h1 _ngcontent-tki-c119="" class="doc-title ng-star-inserted" title="方舟运行时检测"> 方舟运行时检测 </h1>

<div _ngcontent-tki-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section75786272088">方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section75786272088" tips="复制节点链接"></i></h2><p>在JS运行时环境中，多线程的安全问题是一个重要的考虑因素。由于JavaScript本身是单线程的，对JS对象的任何操作都必须在创建该JS线程的原始线程上进行。如果违反了这一规则，就会导致多线程安全问题。以下是关于如何判断和处理这些问题的一些详细说明。</p> </div> <div class="tiledSection"><h3 id="section18515155816101" class="firsth2">原理介绍<i class="anchor-icon anchor-icon-link" anchorid="section18515155816101" tips="复制节点链接"></i></h3><ul><li>单线程执行<p>JavaScript是单线程执行的语言，这意味着它一次只能在一个线程上执行代码。任何JavaScript对象都只能在创建它们的线程上进行操作。</p> </li><li>N-API（Node-API）接口<p>N-API接口直接涉及到JavaScript对象的操作。绝大多数N-API接口（约95%）只能在创建这些对象的JavaScript线程上调用。</p> </li></ul> <ul><li>多线程检测机制<p>多线程检测机制会检测当前线程和正在使用的JS虚拟机环境（vm/env）中的JS线程ID是否一致。如果不一致，就表明虚拟机环境被跨线程使用，存在多线程安全问题。</p> </li></ul> </div> <div class="tiledSection"><h3 id="section19357830121120">常见多线程安全问题<i class="anchor-icon anchor-icon-link" anchorid="section19357830121120" tips="复制节点链接"></i></h3><ul><li>非JS线程使用N-API接口<p>非JavaScript线程尝试调用N-API接口，可能会导致未定义的行为或崩溃。</p> </li></ul> <ul><li>N-API接口使用其他线程的env<p>一个线程尝试使用另一个线程创建的env（JavaScript环境），这也会导致多线程安全问题。</p> </li></ul> <p><strong>如何判断是否发生了多线程安全问题</strong></p> <p>如果在运行时遇到以下致命错误信息，这意味着已经发生了多线程安全问题：</p> <div _ngcontent-tki-c106="" class="highlight-div"><div _ngcontent-tki-c106="" class="highlight-div-header"><div _ngcontent-tki-c106="" class="highlight-div-header-left"><div _ngcontent-tki-c106="" class="handle-button expand-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tki-c106="" class="highlight-div-header-right"><div _ngcontent-tki-c106="" class="handle-button ai-button"></div><div _ngcontent-tki-c106="" class="handle-button line-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tki-c106="" class="handle-button theme-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tki-c106="" class="handle-button copy-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tki-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Fatal</span>: <span class="hljs-title class_">ecma_vm</span> <span class="hljs-title class_">cannot</span> <span class="hljs-title class_">run</span> <span class="hljs-keyword">in</span> <span class="hljs-title class_">multi</span>-<span class="hljs-title class_">thread</span>! <span class="hljs-title class_">thread</span>:<span class="hljs-number">3096</span> <span class="hljs-title class_">currentThread</span>:<span class="hljs-number">3550</span></li></ol></pre></div></div> <p>当前线程号为3550，而使用的JavaScript线程是由3096线程创建的，这表明虚拟机环境（vm/env）被跨线程使用，从而导致了多线程安全问题。</p> </div> <div class="tiledSection"><h3 id="section18774142213155">使用约束<i class="anchor-icon anchor-icon-link" anchorid="section18774142213155" tips="复制节点链接"></i></h3><p>方舟多线程检测通过命令行参数开启，点击桌面图标无效。</p> </div> <div class="tiledSection"><h3 id="section7199344111510">启用方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section7199344111510" tips="复制节点链接"></i></h3><p>可通过以下两种方式启用方舟多线程检测。</p> <ul><li><strong>方式一</strong><p>点击<strong>Run &gt; Edit Configurations &gt;</strong> <strong>Diagnostics</strong>，勾选<strong>Multi Thread Check</strong>。</p> <p><span><img originheight="257" originwidth="689" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163503.60080571160078506520853687150969:50001231000000:2800:D09B70288AD1866ED69B2EF75FA2366DB4861E3545FF76D256AD4D3222B141B1.png" width="689" height="257"></span></p> </li></ul> <ul><li><strong>方式二</strong><p>通过命令行开启。</p> <div _ngcontent-tki-c106="" class="highlight-div"><div _ngcontent-tki-c106="" class="highlight-div-header"><div _ngcontent-tki-c106="" class="highlight-div-header-left"><div _ngcontent-tki-c106="" class="handle-button expand-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-tki-c106="" class="highlight-div-header-right"><div _ngcontent-tki-c106="" class="handle-button ai-button"></div><div _ngcontent-tki-c106="" class="handle-button line-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-tki-c106="" class="handle-button theme-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-tki-c106="" class="handle-button copy-button"><div _ngcontent-tki-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-tki-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li>aa start -<span class="hljs-selector-tag">a</span> {abilityName} -<span class="hljs-selector-tag">b</span> {bundleName} -R</li></ol></pre></div></div> </li></ul> </div> <div class="tiledSection"><h3 id="section145455198178">启用方舟多线程检测<i class="anchor-icon anchor-icon-link" anchorid="section145455198178" tips="复制节点链接"></i></h3><ol><li>运行或调试当前应用。</li><li>当程序出现多线程安全问题时，会弹出Crash log信息，点击信息中的链接即可跳转至引起多线程安全问题的代码处。</li></ol> </div> <div class="tiledSection"><h3 id="section163770361713">方舟异常检测码<i class="anchor-icon anchor-icon-link" anchorid="section163770361713" tips="复制节点链接"></i></h3><p>若fatal信息为Fatal: ecma_vm cannot run in multi-thread! thread:1804 currentThread:2057，则发生了多线程安全问题，意为：当前线程号为2057，而使用的js thread是1804创建出来的，跨线程使用VM。</p> <p><span><img height="232.88432432432435" originheight="504" originwidth="1991" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163503.08480936261573171488571887345406:50001231000000:2800:43B88371F11987A1A67A522381E872955BE4099D3BD8DFDAB45B85073C88BC31.png" title="点击放大" width="920"></span></p> </div> </div> <div></div></div>