<h1 _ngcontent-vim-c119="" class="doc-title ng-star-inserted" title="易错API的使用规范"> 易错API的使用规范 </h1>

<div _ngcontent-vim-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section85943212152">视效API<i class="anchor-icon anchor-icon-link" anchorid="section85943212152" tips="复制节点链接"></i></h2></div> <p>静态图片，建议使用EffectKit异步模糊；AdaptiveColor使用问题</p> <p><strong>【问题描述】</strong></p> <p>内外部多个应用在使用取色模糊时，AdaptiveColor参数选择了AVERAGE方式，导致出现帧率不达标问题。此参数已经标注在非DEFAULT方式下会产生耗时。典型 trace 如下：</p> <p><span><img originheight="631" originwidth="1675" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.13255835747359580590941175377257:50001231000000:2800:A97A471C7BD586069479C3BADD758A8119AE2E7FBAB06A7BA39464DA54912D7E.png" width="920" height="346.57910447761196"></span></p> <p><strong>【使用错误影响】</strong></p> <p>应用单帧处理时间过长，影响刷新帧率，导致动画卡顿。</p> <p><strong>【使用建议】</strong></p> <p>使用 AdaptiveColor.DEFAULT方式取色，或者参考 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit#colorpicker" target="_blank">EffectKit的ColorPicker</a> 方式进行异步取色。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-foreground-blur-style#adaptivecolor枚举说明" target="_blank">AdaptiveColor.DEFAULT</a>：不使用取色模糊。使用默认的颜色作为蒙版颜色。采用非DEFAULT方式较耗时。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit#colorpicker" target="_blank">EffectKit的ColorPicker</a>：取色类，用于从一张图像数据中获取它的主要颜色。</p> <div class="tiledSection"><h2 id="section1540714323166">媒体平台API<i class="anchor-icon anchor-icon-link" anchorid="section1540714323166" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section66752043102110" class="firsth2">播控<i class="anchor-icon anchor-icon-link" anchorid="section66752043102110" tips="复制节点链接"></i></h3></div> <p>1、回调泄漏问题</p> <p><strong>【问题描述】</strong></p> <p>应用在使用.on('xxx')注册回调后，使用匿名函数传入.off('xxx')注销回调。匿名函数传入的回调会被认为是新的回调函数，使得无法移除之前注册的回调，回调会越来越多。监听注册使用的回调callback需要保证合理释放，避免使用匿名函数无法管控生命周期。</p> <p><strong>【使用错误影响】</strong></p> <p>应用程序无响应</p> <p><strong>【使用建议】</strong></p> <p>如需删除回调，请先定义回调方法，然后传参</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsessioncontroller#onplaybackstatechange10" target="_blank">媒体会话管理on('playbackStateChange')</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsessioncontroller#offplaybackstatechange10" target="_blank">媒体会话管理off('playbackStateChange')</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>sessionController.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {</li><li>  <span class="hljs-title function_">callback</span>(state, <span class="hljs-string">'locale'</span>);</li><li>})</li><li>...</li><li>sessionController.<span class="hljs-title function_">off</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> {</li><li>  <span class="hljs-title function_">callback</span>(state, <span class="hljs-string">'locale'</span>);</li><li>})</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L23-L27" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> playStateCallback = (state: avSession.AVPlaybackState) =&gt; {</li><li>
</li><li>}</li><li>sessionController.<span class="hljs-keyword">on</span>(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-string">'all'</span>, <span class="hljs-keyword">this</span>.playStateCallback);</li><li>sessionController.off(<span class="hljs-string">'playbackStateChange'</span>, <span class="hljs-keyword">this</span>.playStateCallback);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L23-L27" target="_blank">playStateCallback.ets</a></div></div></div></div> <p></p> <p>2、打印日志过多问题</p> <p><strong>【问题描述】</strong></p> <p>日志打印量超过60MB</p> <p><strong>【使用建议】</strong></p> <p>减少频繁调用setAVPlaybackState和SetAVMetadata的场景</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#setavplaybackstate10" target="_blank">媒体会话管理setAVPlaybackState</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession#setavmetadata10" target="_blank">媒体会话管理setAVMetadata</a></p> <p></p> <p>3、投播时正确播放资源</p> <p><strong>【问题描述】</strong></p> <p>使用AVCastController进行资源播放。非同步调用接口时，需要在callback回调中启动播放。</p> <p><strong>【使用错误影响】</strong></p> <p>无法播放投屏内容</p> <p><strong>【使用建议】</strong></p> <p>使用AVCastController进行资源播放，非同步调用接口，需在callback回调中启动。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/distributed-playback-guide" target="_blank">投播组件开发指导</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">prepare</span>(playItem, <span class="hljs-function">() =&gt;</span> {</li><li>   ...</li><li>});</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L52-L59" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Preparing to play, this will not trigger actual playback, it will load and buffer</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">prepare</span>(playItem, <span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Preparation done'</span>);</li><li>  <span class="hljs-comment">// Start playback, truly triggering the playback on the other end. Please call start after Prepare is successful.</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">castController</span>?.<span class="hljs-title function_">start</span>(playItem, <span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'Playback started'</span>);</li><li>  });</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L52-L59" target="_blank">playStateCallback.ets</a></div></div></div></div> <p>4、正确设置播放状态和进度</p> <p><strong>【问题描述】</strong></p> <p>播放或暂停应用时，设置播放状态及当前进度。</p> <p><strong>【使用错误影响】</strong></p> <p>播放状态显示异常，包括进度回弹和进度显示错误。</p> <p><strong>【使用建议】</strong></p> <p>当应用的播放状态、进度或倍速发生变化时，使用setAVPlaybackState接口更新AVPlaybackState。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/basic-playback-control" target="_blank">基础播控</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.session?.<span class="hljs-keyword">on</span>(<span class="hljs-string">'pause'</span>, <span class="hljs-keyword">async</span> () =&gt; {</li><li>  <span class="hljs-comment">// 无实现</span></li><li>});</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L65-L77" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">session</span>?.<span class="hljs-title function_">on</span>(<span class="hljs-string">'pause'</span>, <span class="hljs-variable">async</span> () =&gt; {</li><li>  <span class="hljs-variable">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">on</span> <span class="hljs-variable">pause</span> , <span class="hljs-keyword">do</span> <span class="hljs-variable">pause</span> <span class="hljs-variable">task</span>`);</li><li>  <span class="hljs-comment">// Execute player pause</span></li><li>  <span class="hljs-comment">// Set the status and progress during pause</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">currentState</span> = {</li><li>    <span class="hljs-variable">state</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">PlaybackState</span>.<span class="hljs-title class_">PLAYBACK_STATE_PAUSE</span>,</li><li>    <span class="hljs-variable">position</span>: {</li><li>      <span class="hljs-variable">elapsedTime</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentTime</span>,</li><li>      <span class="hljs-variable">updateTime</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title class_">getTime</span>(),</li><li>    }</li><li>  };</li><li>  <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">session</span>?.<span class="hljs-title function_">setAVPlaybackState</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentState</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/playStateCallback.ets#L65-L77" target="_blank">playStateCallback.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section178871719112717">相机<i class="anchor-icon anchor-icon-link" anchorid="section178871719112717" tips="复制节点链接"></i></h3></div> <p>1、回调on('xxx')接口中，禁止添加（调用on）或者移除（调用off）回调操作</p> <p><strong>【问题描述】</strong></p> <p>框架侧的回调实现已经进行了加锁操作。如果应用在框架触发回调时移除或添加回调，会导致线程死锁。</p> <p><strong>【使用错误影响】</strong></p> <p>应用发生卡死</p> <p><strong>【使用建议】</strong></p> <p>如果需要对回调进行其他增减操作，应在其他线程中执行或在其他业务流程中处理。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videosession#onerror11" target="_blank">相机管理on('error')</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#oncamerastatus" target="_blank">相机管理on('cameraStatus')</a></p> <p>文档中所有的on接口不仅限于上述两个示例。</p> <p><strong>【典型案例】</strong></p> <p>当cameraStatus回调触发后，代码在off处发生卡死。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function">function <span class="hljs-title">callback</span>()</span> {</li><li>  cameraManager.off(<span class="hljs-string">'cameraStatus'</span>);</li><li>}</li><li>cameraManager.<span class="hljs-keyword">on</span>(<span class="hljs-string">'cameraStatus'</span>, callback);</li></ol></pre></div></div> <p></p> <p>2、CameraSession中，addInput接口的入参必须是一个已经调用了open的CameraInput。</p> <p><strong>【问题描述】</strong></p> <p>打开CameraInput 后，会获取对应设备的信息。如果未成功获取这些信息，将CameraInput添加到Session时会抛出异常。</p> <p><strong>【使用错误影响】</strong></p> <p>应用在调用接口时发生错误</p> <p><strong>【使用建议】</strong></p> <p>CameraInput打开成功后，添加到CameraSession中。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createcamerainput" target="_blank">相机管理CameraInput</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session" target="_blank">相机管理Session</a></p> <p><strong>【典型案例】</strong></p> <p>在执行到addInput时发生异常。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>cameraInput = cameraManager.<span class="hljs-built_in">createCameraInput</span>(camera);</li><li>session.<span class="hljs-built_in">beginConfig</span>();</li><li>session.<span class="hljs-built_in">addInput</span>(cameraInput); <span class="hljs-comment">// 接口抛出异常</span></li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L17-L20" data-highlighted="yes"><ol class="linenums"><li>cameraInput = cameraManager.createCameraInput(camera);</li><li><span class="hljs-keyword">await</span> cameraInput.<span class="hljs-built_in">open</span>();</li><li>session.beginConfig();</li><li>session.addInput(cameraInput);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L17-L20" target="_blank">camera.ets</a></div></div></div></div> <p></p> <p>3、CameraSession中，addOutput前需要先addInput。</p> <p><strong>【问题描述】</strong></p> <p>如果Session中没有Input信息，addOutput会抛出异常。</p> <p><strong>【使用错误影响】</strong></p> <p>应用在调用接口时发生错误</p> <p><strong>【使用建议】</strong></p> <p>Session添加Input后，再添加Output。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createcamerainput" target="_blank">相机管理CameraInput</a></p> <p>Output包括 PreviewOutput、PhotoOutput、VideoOutput、MetadataOutput。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">相机管理CameraOutput</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session" target="_blank">相机管理Session</a></p> <p><strong>【典型案例】</strong></p> <p>在执行到addOutput时，代码发生异常并抛出。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" data-highlighted="yes"><ol class="linenums"><li>previewOutput = cameraManager.createPreviewOutput(profile, surfaceId);</li><li>cameraInput = cameraManager.createCameraInput(camera);</li><li>await cameraInput.open();</li><li>session.beginConfig();</li><li>session.addOutput(previewOutput);</li><li>session.addInput(cameraInput);</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L31-L36" data-highlighted="yes"><ol class="linenums"><li>previewOutput = cameraManager.createPreviewOutput(profile, surfaceId);</li><li>cameraInput = cameraManager.createCameraInput(camera);</li><li>await cameraInput.open();</li><li>session.beginConfig();</li><li>session.addInput(cameraInput);</li><li>session.addOutput(previewOutput);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L31-L36" target="_blank">camera.ets</a></div></div></div></div> <p></p> <p>4、Session增减Input和Output的接口调用流程必须在beginConfig和commitConfig接口调用之间。</p> <p><strong>【问题描述】</strong></p> <p>如果Session中未调用beginConfig，调用addInput和addOutput将导致异常抛出。若Session未调用commitConfig，则无法调用后续的start接口。</p> <p><strong>【使用错误影响】</strong></p> <p>应用调用接口时出现错误</p> <p><strong>【使用建议】</strong></p> <p>Session调用beginConfig接口之后再添加Input和Output，最后记得调用commitConfig。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createcamerainput" target="_blank">相机管理CameraInput</a></p> <p>Output包括 PreviewOutput、PhotoOutput、VideoOutput 和 MetadataOutput。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">相机管理CameraOutput</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session" target="_blank">相机管理Session</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#beginconfig11" target="_blank">相机管理beginConfig</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11" target="_blank">相机管理commitConfig</a></p> <p><strong>【典型案例】</strong></p> <p>在执行到addInput时发生异常并抛出。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" data-highlighted="yes"><ol class="linenums"><li>previewOutput = cameraManager.createPreviewOutput(profile, surfaceId);</li><li>cameraInput = cameraManager.createCameraInput(camera);</li><li>await cameraInput.open();</li><li>session.addInput(cameraInput); </li><li>session.beginConfig();</li><li>session.addOutput(previewOutput);</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-makefile" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L47-L53" data-highlighted="yes"><ol class="linenums"><li>previewOutput = cameraManager.createPreviewOutput(profile, surfaceId);</li><li>cameraInput = cameraManager.createCameraInput(camera);</li><li>await cameraInput.open();</li><li>session.beginConfig();</li><li>session.addInput(cameraInput);</li><li>session.addOutput(previewOutput);</li><li>session.commitConfig();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L47-L53" target="_blank">camera.ets</a></div></div></div></div> <p></p> <p>5、Session的release，Input的close等返回Promise的操作如果在异步函数内调用，请确保调用了await保证时序正常。</p> <p><strong>【问题描述】</strong></p> <p>将异步函数当作同步函数调用会导致时序问题。</p> <p><strong>【使用错误影响】</strong></p> <p>应用出现异常。</p> <p><strong>【使用建议】</strong></p> <p>在异步函数中调用返回Promise的异步函数时，使用await确保调用顺序正确。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#release11" target="_blank">相机管理release</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-camerainput#close" target="_blank">相机管理close</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>async function <span class="hljs-built_in">onBackground</span>() {</li><li>  cameraInput<span class="hljs-selector-class">.close</span>();</li><li>  cameraSession<span class="hljs-selector-class">.release</span>();</li><li>}</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L62-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">onBackground</span>()</span> {</li><li>  <span class="hljs-keyword">await</span> cameraInput.close();</li><li>  <span class="hljs-keyword">await</span> cameraSession.release();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/camera.ets#L62-L65" target="_blank">camera.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1715713682713">音频<i class="anchor-icon anchor-icon-link" anchorid="section1715713682713" tips="复制节点链接"></i></h3></div> <p>1、多次调用裸指针的Release会触发UAF（use after free）。</p> <p><strong>【问题描述】</strong></p> <p>应用在使用OHAudioRenderer或OHAudioCapturer等OHAudio相关接口时，需要传递相关对象的裸指针给音频。调用对象的release方法后，框架会删除对象。此时，如果应用再次传递裸指针调用方法，音频接收到的指针只能进行判空，无法判断指针的有效性，导致UAF问题。</p> <p><strong>【使用错误影响】</strong></p> <p>出现地址越界导致的崩溃问题，造成客户端进程异常退出。</p> <p><strong>【使用建议】</strong></p> <p>在使用OHAudio时，调用Release方法后，不要再传递已失效的指针。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-recording" target="_blank">使用OHAudio开发音频录制功能(C/C++)</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback" target="_blank">使用OHAudio开发音频播放功能(C/C++)</a></p> <p></p> <p>2、使用OHAudio的应用仅注册部分回调，可能导致野指针崩溃。</p> <p><strong>【问题描述】</strong></p> <p>根据C语言的特性，结构体中的指针必须初始化后才能使用，可以使用正常值或nullptr进行初始化。音频提供了OH_AudioRenderer_Callbacks_Struct和OH_AudioCapturer_Callbacks_Struct等结构体，其中包含指针类型的方法。当应用注册这些结构体时，必须初始化所有元素，否则音频在发送回调时可能会因无法判断指针是否合法而出现异常。</p> <p><strong>【使用错误影响】</strong></p> <p>在框架回调应用时，如果需要回调的方法是用户未赋值的方法，可能会导致客户端进程异常退出。</p> <p><strong>【使用建议】</strong></p> <p>设置音频回调函数时，确保OH_AudioRenderer_Callbacks和OH_AudioCapturer_Callbacks的每个回调被初始化。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-recording" target="_blank">使用OHAudio开发音频录制功能(C/C++)</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback" target="_blank">使用OHAudio开发音频播放功能(C/C++)</a></p> <p></p> <p>3、OnWriteData回调排查</p> <p><strong>【问题描述】</strong></p> <p>开发者使用OHAudio的接口时，使用了OH_AudioStreamBuilder_SetRendererCallback设置了OH_AudioRenderer_OnWriteData作为写数据的回调函数。然而，由于网络或解码性能问题，应用在系统请求音频数据时，无法提供完整的数据块，而只能写入部分数据。例如，当系统请求10ms的数据时，应用只提供了6ms的数据。系统在拿到这段数据后，仍然按照10ms的数据播放，导致未写入的4ms数据不可控，表现为播放卡顿和杂音。</p> <p><strong>【使用错误影响】</strong></p> <p>播放过程中出现卡顿和杂音。</p> <p><strong>【使用建议】</strong></p> <ul><li>应用确认调用的接口类型及设置的回调函数。</li><li>当前系统有两种设置回调的接口，分别设置两种回调函数：<ol><li>通过 OH_AudioStreamBuilder_SetRendererCallback 设置 OH_AudioRenderer_OnWriteData （不支持返回值）</li><li>通过 OH_AudioStreamBuilder_SetRendererWriteDataCallback 设置 OH_AudioRenderer_OnWriteDataCallback（支持返回值）</li></ol> </li><li>应用需明确每次回调时，Buffer是否已写满。</li><li>可通过比较应用自身写入的数据长度是否与回调函数的参数length或者是audioDataSize相等</li></ul> <p><strong>【注意事项】</strong></p> <ul><li>应用需保证连续发送音频数据，避免数据断续导致听感卡顿。</li><li>应用需明确自身写入的数据长度能否填满系统回调的Buffer。如果无法填满，对于无返回值的回调函数，推荐应用暂时停止写入数据（不暂停音频流），阻塞回调函数（AudioRender其他操作前要解阻塞）或将Buffer置空，等待数据充足时再继续写入数据。需注意，如果Buffer置空，也会被统计到已写入的数据。如果使用支持返回值的回调函数，可返回INVALID，系统会暂不处理该段音频数据，再次向应用请求数据，等返回VALID后，系统继续播放。</li><li>应用避免在回调函数外访问回调Buffer，确保其数据不被异步修改。</li><li>应用需注意，不支持返回值的回调函数与支持返回值的回调函数的注册是相互覆盖的。如果需要使用支持返回值的回调函数，可将OH_AudioStreamBuilder_SetRendererWriteDataCallback接口的调用放在OH_AudioStreamBuilder_SetRendererCallback接口后面。</li><li>推荐使用OH_AudioStreamBuilder_SetRendererWriteDataCallback设置支持返回值的回调函数，处理异常帧或数据不足。</li></ul> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-ohaudio-for-playback" target="_blank">使用OHAudio开发音频播放功能(C/C++)</a></p> <p></p> <p>4、防止Offload流卡顿的自排查步骤</p> <p><strong>【问题描述】</strong></p> <p><strong>offload功能说明</strong></p> <ul><li>应用在播放流类型为MUSIC或AUDIOBOOK时，熄屏后会进入低功耗模式，调度间隔为7秒。</li><li>休眠结束唤醒后，应用需在200毫秒内提供至少1帧数据。</li><li>offload通路会请求应用数据，应用需保证数据充足。</li><li>应用数据写入后不立即播放，播放进度需通过框架接口获取。</li></ul> <p><strong>【使用建议】</strong></p> <p><strong>典型案例（应用自查）</strong></p> <p>Q1. 【息屏异常停流】当CPU休眠时，APP检测到解码阻塞或长时间未收到系统请求，会执行停流操作。</p> <p>A1. 使用offload通路的应用需申请长时任务；应用应感知休眠状态，保持正常运行。</p> <p>Q2. 【息屏异常停流】APP在CPU唤醒后的一段时间内，未能及时提供至少一帧数据。</p> <p>A2. APP需进行解码等操作的性能优化，确保CPU唤醒时及时提供数据。</p> <p>Q3. 【息屏卡顿杂音】APP在数据不足一帧时写入，导致出现卡顿和杂音。</p> <p>A3：根据情况排查。</p> <ul><li>若使用OH_AudioStreamBuilder_SetRendererCallback回调：<ul><li>需要应用阻塞直到数据准备充足，确保buffer写满</li></ul> </li><li>若使用OH_AudioStreamBuilder_SetRendererWriteDataCallback，可以选择两种方案：<ul><li>数据不足时，返回AUDIO_DATA_CALLBACK_RESULT_INVALID，框架会在短时间内再次请求数据</li><li>若需要写数据，确保buffer写满</li></ul> </li></ul> <p>Q4. 【未播完切歌】APP在一段数据写完后，切歌进入下一首，此时数据尚未播放完毕。</p> <p>A4. 通过框架接口OH_AudioRenderer_GetTimeStamp()获取框架侧播放的数据数量，以判断播放进度。控制调用频率，建议每200毫秒调用一次，避免影响系统性能。注意，调用OH_AudioRenderer_Flush()后，播放的数据数量会重置为0。</p> <p>PS: 针对案例3和4，应用可以添加维测：统计实际写入的数据数量p1，通过框架接口OH_AudioRenderer_GetTimeStamp()获取框架侧播放的数据数量p2。符合预期的场景：</p> <ul><li>在p1 - p2 约为休眠水线(目前约7s)时，进入休眠；</li><li>在p1 - p2 约为唤醒水线(目前约400ms)时，唤醒。</li></ul> <p>不符合预期的场景：</p> <ul><li>p1 - p2 为负值</li><li>p1 - p2 没达到休眠水线时，进入休眠；</li></ul> <div class="tiledSection"><h3 id="section19365512919">视频<i class="anchor-icon anchor-icon-link" anchorid="section19365512919" tips="复制节点链接"></i></h3></div> <p>AVImageGenerator或AVMetadataExtractor功能失效问题。</p> <p><strong>【问题描述】</strong></p> <p>设置同一个FD给AVImageGenerator和AVMetadataExtractor实例，导致AVImageGenerator或者AVMetadataExtractor功能失效。</p> <p><strong>【使用错误影响】</strong></p> <p>功能失效，导致数据读取异常</p> <p><strong>【使用建议】</strong></p> <p>即使是沙箱路径下的同一个文件，也建议打开两次，获取不同的文件描述符（Fd）分别传递给AVImageGenerator和AVMetadataExtractor对象。否则，这两个对象对同一个文件描述符进行操作，会导致读取数据异常，从而功能失效。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avimagegenerator" target="_blank">AVImageGenerator</a></p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>将资源句柄（fd）传递给 AVImageGenerator 实例后，请勿使用该句柄进行其他读写操作，包括传递给多个 AVPlayer、AVMetadataExtractor、AVImageGenerator 或 AVTranscoder。同一时间通过该句柄读写文件会导致视频缩略图数据异常。</p> </div></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/AVImageGenerator.ets#L20-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchFrame</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchMeta</span>()</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVImageGenerator"</span>)) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avImageGenerator</span>: media.<span class="hljs-property">AVImageGenerator</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVImageGenerator</span>()</li><li>    <span class="hljs-comment">// raw fd</span></li><li>    avImageGenerator.<span class="hljs-property">fdSrc</span> = fs.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootPath</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">testFilename</span>)</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">6</span>; i++) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`time real <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.diffTime[i]}</span>`</span>)</li><li>      <span class="hljs-keyword">let</span> pixelMap = <span class="hljs-keyword">await</span> avImageGenerator.<span class="hljs-title function_">fetchFrameByTime</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">diffTime</span>[i], <span class="hljs-variable language_">this</span>.<span class="hljs-property">seekOption</span>,</li><li>        { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMapWidth</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMapHeight</span> })</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span>.<span class="hljs-title function_">push</span>(pixelMap)</li><li>      <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelLcd</span> = pixelMap</li><li>        <span class="hljs-keyword">let</span> rate = pixelMap.<span class="hljs-title function_">getImageInfoSync</span>().<span class="hljs-property">size</span>.<span class="hljs-property">height</span> / pixelMap.<span class="hljs-title function_">getImageInfoSync</span>().<span class="hljs-property">size</span>.<span class="hljs-property">width</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">lcdHeight</span> =</li><li>          display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">width</span> / <span class="hljs-number">2</span> / display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityPixels</span> * rate</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imageInfo</span>: image.<span class="hljs-property">ImageInfo</span> = pixelMap.<span class="hljs-title function_">getImageInfoSync</span>()</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`colorFormat <span class="hljs-subst">${imageInfo.pixelFormat}</span> width <span class="hljs-subst">${imageInfo.size.width}</span> height <span class="hljs-subst">${imageInfo.size.height}</span> isHdr <span class="hljs-subst">${imageInfo.isHdr}</span>`</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchMeta</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">"SystemCapability.Multimedia.Media.AVMetadataExtractor"</span>)) {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`typeof <span class="hljs-subst">${<span class="hljs-keyword">typeof</span> media.createAVMetadataExtractor()}</span>`</span>)</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">avMetadataExtractor</span>: media.<span class="hljs-property">AVMetadataExtractor</span> = <span class="hljs-keyword">await</span> media.<span class="hljs-title function_">createAVMetadataExtractor</span>()</li><li>
</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span> = fs.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootPath</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">testFilename</span>).<span class="hljs-property">fd</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">fileSize</span>: <span class="hljs-built_in">number</span> = fs.<span class="hljs-title function_">statSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">rootPath</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">testFilename</span>).<span class="hljs-property">size</span>;</li><li>
</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">dataSrc</span>: media.<span class="hljs-property">AVDataSrcDescriptor</span> = {</li><li>      <span class="hljs-attr">fileSize</span>: fileSize,</li><li>      <span class="hljs-attr">callback</span>: <span class="hljs-function">(<span class="hljs-params">buffer, len, pos</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (buffer == <span class="hljs-literal">undefined</span> || len == <span class="hljs-literal">undefined</span> || pos == <span class="hljs-literal">undefined</span>) {</li><li>          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`dataSrc callback param invalid`</span>)</li><li>          <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span></li><li>        }</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">options</span>: <span class="hljs-title class_">ReadOptions</span> = {</li><li>          <span class="hljs-attr">offset</span>: pos,</li><li>          <span class="hljs-attr">length</span>: len</li><li>        }</li><li>        <span class="hljs-keyword">let</span> num = fs.<span class="hljs-title function_">readSync</span>(fd, buffer, options)</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'readAt end, num: '</span> + num)</li><li>        <span class="hljs-keyword">if</span> (num &gt; <span class="hljs-number">0</span> &amp;&amp; fileSize &gt;= pos) {</li><li>          <span class="hljs-keyword">return</span> num;</li><li>        }</li><li>        <span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;</li><li>      }</li><li>    }</li><li>
</li><li>
</li><li>    avMetadataExtractor.<span class="hljs-property">dataSrc</span> = dataSrc</li><li>
</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">metadata</span>: media.<span class="hljs-property">AVMetadata</span></li><li>
</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      metadata = <span class="hljs-keyword">await</span> avMetadataExtractor.<span class="hljs-title function_">fetchMetadata</span>()</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'error code '</span> + error.<span class="hljs-property">code</span>)</li><li>      <span class="hljs-keyword">return</span></li><li>    }</li><li>
</li><li>
</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`metadata <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(metadata)}</span>`</span>)</li><li>    <span class="hljs-keyword">if</span> (metadata.<span class="hljs-property">duration</span>) {</li><li>      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`fetchMetadata success duration <span class="hljs-subst">${metadata.duration}</span>`</span>)</li><li>      <span class="hljs-keyword">let</span> duration = <span class="hljs-built_in">parseInt</span>(metadata.<span class="hljs-property">duration</span>) * <span class="hljs-number">1000</span></li><li>      <span class="hljs-keyword">let</span> pick = duration / <span class="hljs-number">5</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffTime</span>[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffTime</span>[<span class="hljs-number">5</span>] = duration</li><li>      <span class="hljs-keyword">let</span> time = pick</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-number">5</span>; i++) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">diffTime</span>[i] = time</li><li>        time += pick</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (metadata.<span class="hljs-property">videoHeight</span> &amp;&amp; metadata.<span class="hljs-property">videoWidth</span>) {</li><li>      <span class="hljs-keyword">let</span> rate = <span class="hljs-title class_">Number</span>(metadata.<span class="hljs-property">videoHeight</span>) / <span class="hljs-title class_">Number</span>(metadata.<span class="hljs-property">videoWidth</span>)</li><li>      <span class="hljs-keyword">if</span> (metadata.<span class="hljs-property">videoOrientation</span> &amp;&amp; <span class="hljs-title class_">Number</span>(metadata.<span class="hljs-property">videoOrientation</span>) % <span class="hljs-number">180</span>) {</li><li>        rate = <span class="hljs-number">1</span> / rate;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoHeight</span> =</li><li>        display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">width</span> / <span class="hljs-number">6</span> / display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityPixels</span> * rate</li><li>    }</li><li>    <span class="hljs-keyword">await</span> avMetadataExtractor.<span class="hljs-title function_">release</span>()</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/AVImageGenerator.ets#L20-L112" target="_blank">AVImageGenerator.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1490013813013">ArkUI相关API<i class="anchor-icon anchor-icon-link" anchorid="section1490013813013" tips="复制节点链接"></i></h2></div> <p>1. Inspector接口在业务代码里使用</p> <p><strong>【问题描述】</strong></p> <p>在使用Inspector相关接口查询组件信息时，如果出现错误行为，可能会导致应用闪退。该接口设计初衷是用于调试，性能较低，不建议在业务代码中调用，以避免引起应用卡顿或闪退。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退。</p> <p><strong>【使用建议】</strong></p> <p>避免使用Inspector进行信息查询。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#getfilteredinspectortree12" target="_blank">getFilteredInspectorTre()</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#getfilteredinspectortreebyid12" target="_blank">getFilteredInspectorTreeById()</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id" target="_blank">组件标识</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-framenode#getinspectorinfo12" target="_blank">getInspectorInfo()</a></p> <p></p> <p>2、OH_NativeXComponent_RegisterCallback接口传参</p> <p><strong>【问题描述】</strong></p> <p>应用在使用OH_NativeXComponent_RegisterCallback接口传的回调函数必须保证在OnSurfaceDestroyed回调之前是有效的，该回调是XComponent生命周期结束后给应用的通知，一定会调用。如果提前释放该回调会导致uaf问题。</p> <p><strong>【使用错误影响】</strong></p> <p>应用程序意外终止运行。</p> <p><strong>【使用建议】</strong></p> <ul><li>在Native侧的OnSurfaceXXX回调中，nativewindow指针的生命周期在OnSurfaceDestroyed回调之后结束。因此，应用需要确保在此之后不再使用该指针，特别是在多线程场景中，以避免访问野指针的问题。</li><li>在OnSurfaceDestroyed回调触发前，不要释放该回调所在对象，否则会导致系统在调用该回调时出错。</li></ul> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-interface-xcomponent-h#oh_nativexcomponent_registercallback" target="_blank">OH_NativeXComponent_RegisterCallback</a></p> <p></p> <p>3、@ohos.measure和@ohos.font不推荐在UIAbility的生命周期中调用</p> <p><strong>【问题描述】</strong></p> <p>在UIAbility的生命周期中调用@ohos.measure和@ohos.font接口无法达到预期效果。下面的代码示例是在EntryAbility.ets的onCreate回调函数中使用这些接口。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onCreate</span>(<span class="hljs-variable">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-title class_">LaunchParam</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">width</span> = <span class="hljs-variable">MeasureText</span>.<span class="hljs-title function_">measureText</span>({ <span class="hljs-comment">// 建议使用 this.getUIContext().getMeasureUtils().measureText()接口</span></li><li>    <span class="hljs-variable">textContent</span>: <span class="hljs-string">"Hello World"</span>,</li><li>    <span class="hljs-variable">fontSize</span>: <span class="hljs-string">'50px'</span></li><li>  })</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0001</span>, <span class="hljs-string">"testTag"</span>, <span class="hljs-string">"Hello World, width: %{public}d"</span>, <span class="hljs-variable">width</span>);</li><li>  <span class="hljs-variable">font</span>.<span class="hljs-title function_">registerFont</span>({ <span class="hljs-comment">// 建议使用 this.getUIContext().getFont().registerFont()接口</span></li><li>    <span class="hljs-variable">familyName</span>: <span class="hljs-string">'contentFont'</span>,</li><li>    <span class="hljs-variable">familySrc</span>: $<span class="hljs-title class_">rawfile</span>('<span class="hljs-title class_">hwxw</span>.<span class="hljs-title class_">ttf</span>')</li><li>  })</li><li>}</li></ol></pre></div></div> <p><strong>【使用错误影响】</strong></p> <p>运行上述代码，编译会通过，但在运行时，width无法打印出有效结果，且注册的font也不生效。</p> <p><strong>【使用建议】</strong></p> <p>1、本模块功能依赖UI的执行上下文，不可在UI上下文不明确的地方使用。建议使用this.getUIContext().getMeasureUtils().measureText()和this.getUIContext().getFont().registerFont()调用。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-font" target="_blank">@ohos.font (注册自定义字体)</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-measure" target="_blank">@ohos.measure (文本计算)</a></p> <p></p> <p>4、在CustomdialogController方法中禁止动态赋值。</p> <p><strong>【问题描述】</strong></p> <p>在方法中动态声明并赋值。</p> <p><strong>【使用错误影响】</strong></p> <p>如果重复执行该方法，已打开的弹窗将无法关闭，且不会显示异常日志。</p> <p><strong>【使用建议】</strong></p> <p>在@component下定义并初始化</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-methods-custom-dialog-box" target="_blank">自定义弹窗 (CustomDialog)</a></p> <p></p> <p>5、在懒加载、list与web场景下手动控制CheckboxGroup的状况变量</p> <p><strong>【问题描述】</strong></p> <p>在懒加载、列表和Web场景下，需要手动控制CheckboxGroup的状态变量。</p> <p><strong>【使用错误影响】</strong></p> <p>使用CheckboxGroup依赖系统控制Checkbox时，可能会导致某些Checkbox无法被CheckboxGroup统一管理。为避免这种情况，建议确保所有Checkbox都正确绑定到CheckboxGroup，以实现统一管理。</p> <p><strong>【使用建议】</strong></p> <p>在懒加载、列表和Web场景下，需要手动控制CheckboxGroup的状态变量。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-checkboxgroup" target="_blank">CheckboxGroup</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Entry</span></li><li><span class="hljs-variable">@Component</span></li><li>struct CheckBoxPage {</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">fontColor</span>: string = <span class="hljs-string">'#182431'</span></li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">selectedFontColor</span>: string = <span class="hljs-string">'#007DFF'</span></li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">currentIndex</span>: number = <span class="hljs-number">0</span></li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">arr</span>: number[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>];</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">arr_more</span>: number[][] = []</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>      <span class="hljs-selector-tag">List</span>() {</li><li>        <span class="hljs-selector-tag">ForEach</span>(this.arr, (<span class="hljs-attribute">item</span>: number, itemIndex) =&gt; {</li><li>          <span class="hljs-selector-tag">ListItem</span>() {</li><li>            <span class="hljs-selector-tag">Row</span>() {</li><li>              <span class="hljs-selector-tag">Checkbox</span>({ name: itemIndex + "_" + itemIndex, group: 'checkboxGroupA' + 1 })</li><li>              <span class="hljs-comment">// Blank()</span></li><li>              <span class="hljs-selector-tag">Text</span>(item + <span class="hljs-string">"__"</span>)</li><li>                <span class="hljs-selector-class">.id</span>(<span class="hljs-string">'CheckBoxPageHelloWorld'</span>)</li><li>                <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">50</span>)</li><li>                <span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)</li><li>            }<span class="hljs-selector-class">.width</span>(<span class="hljs-string">"100%"</span>)</li><li>          }<span class="hljs-selector-class">.width</span>(<span class="hljs-string">"100%"</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">100</span>)</li><li>        })</li><li>      }<span class="hljs-selector-class">.id</span>(<span class="hljs-string">"list"</span>)</li><li>      <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'80%'</span>)</li><li>      <span class="hljs-selector-tag">CheckboxGroup</span>({ group: 'checkboxGroupA' + 1 })</li><li>        <span class="hljs-selector-class">.checkboxShape</span>(CheckBoxShape.ROUNDED_SQUARE)</li><li>        <span class="hljs-selector-class">.selectedColor</span>(<span class="hljs-string">'#007DFF'</span>)</li><li>        <span class="hljs-selector-class">.onChange</span>((<span class="hljs-attribute">itemName</span>: CheckboxGroupResult) =&gt; {</li><li>          <span class="hljs-selector-tag">console</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"checkbox group content"</span> + JSON.<span class="hljs-built_in">stringify</span>(itemName))</li><li>        })</li><li>        <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'20%'</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p></p> <p>6、UIExtensionComponent send&amp;sendSync 能力有效周期注意点</p> <p><strong>【问题描述】</strong></p> <p>UIExtensionComponent用于承载跨进程UI，提供send和sendSync方法，用于向提供方发送信息。这些方法只有在提供方进程启动并建立连接后才能生效。如果提供方断开连接或出现问题（如通过UIExtensionComponent的onError、onRelease和onTerminated回调检测到），这些方法将失效。</p> <p><strong>【使用错误影响】</strong></p> <p>send和sendSync失效</p> <p><strong>【使用建议】</strong></p> <p>监听UIExtensionProxy的on('asyncReceiverRegister')和on('syncReceiverRegister')状态，在回调之后使用。</p> <p>监听UIExtensionComponent的onError、onRelease和onTerminated状态。监听之后，组件将无法使用。</p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>bool isExtensionReady = <span class="hljs-literal">false</span>;</li><li><span class="hljs-title class_">UIExtensionComponent</span>({</li><li>    bundleName : <span class="hljs-string">"com.example.newdemo"</span>,</li><li>    <span class="hljs-attr">abilityName</span>: <span class="hljs-string">"UIExtensionProvider"</span>,</li><li>    <span class="hljs-attr">parameters</span>: {</li><li>        <span class="hljs-string">"ability.want.params.uiExtensionType"</span>: <span class="hljs-string">"dialog"</span></li><li>}})</li><li>.<span class="hljs-title function_">onRemoteReady</span>(<span class="hljs-function">(<span class="hljs-params">proxy</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onRemoteReady, for test'</span>)</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> = proxy</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"syncReceiverRegister"</span>, , <span class="hljs-function">(<span class="hljs-params">proxy1</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on invoke for test, type is asyncReceiverRegister"</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span> = <span class="hljs-literal">true</span>;</li><li>    });</li><li>    <span class="hljs-comment">//或者如下</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">"asyncReceiverRegister"</span>, <span class="hljs-function">(<span class="hljs-params">proxy1</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"on invoke for test, type is asyncReceiverRegister"</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span> = <span class="hljs-literal">true</span>;</li><li>    });</li><li>})</li><li>.<span class="hljs-title function_">onTerminated</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'onTerminated: code ='</span> + info.<span class="hljs-property">code</span> + <span class="hljs-string">', want = '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(info.<span class="hljs-property">want</span>));</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span> = <span class="hljs-literal">false</span>;</li><li>})</li><li>.<span class="hljs-title function_">onRelease</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span> = <span class="hljs-literal">false</span>;</li><li>})</li><li>.<span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">info</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span> = <span class="hljs-literal">false</span>;</li><li>})</li><li>
</li><li><span class="hljs-title class_">Button</span>(<span class="hljs-string">"点击向UIExtensionAbility发送数据"</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span> != <span class="hljs-literal">undefined</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">isExtensionReady</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>.<span class="hljs-title function_">send</span>({<span class="hljs-attr">data</span>: <span class="hljs-string">"你好1"</span>})</li><li>
</li><li>        <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> re = <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxy</span>.<span class="hljs-title function_">sendSync</span>({<span class="hljs-attr">data</span>: <span class="hljs-string">"你好2"</span>})</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"for test, re="</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(re));</li><li>        } <span class="hljs-keyword">catch</span> (err) {</li><li>            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`sendSync failed for test. errCode=<span class="hljs-subst">${err.code}</span>, msg=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>        }</li><li>    }</li><li>})</li></ol></pre></div></div> <p></p> <p>7、在使用多态配置按钮的按压效果和hover效果之前，需要先关闭按钮自身的按压和hover效果。</p> <p><strong>【问题描述】</strong></p> <p>Button组件配置多态样式前需禁用默认按压和悬停效果。</p> <p><strong>【使用错误影响】</strong></p> <p>按钮在按压或悬停时会闪烁或样式异常。</p> <p><strong>【使用建议】</strong></p> <p>关闭按压和hover效果，设置stateEffect(false)和hoverEffect(false)。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-polymorphic-style" target="_blank">多态样式</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-button" target="_blank">Button</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-variable">@Entry</span></li><li><span class="hljs-variable">@Component</span></li><li>struct StyleExample {</li><li>  <span class="hljs-variable">@Styles</span></li><li>  <span class="hljs-built_in">pressedStyles</span>(): void {</li><li>    <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">"#ED6F21"</span>)</li><li>  }</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-selector-tag">Flex</span>({ <span class="hljs-attribute">direction</span>: FlexDirection.Column, <span class="hljs-attribute">alignItems</span>: ItemAlign.Center }) {</li><li>      <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">"pressed"</span>)</li><li>        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">100</span>)</li><li>        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)</li><li>        <span class="hljs-selector-class">.stateStyles</span>({</li><li>          pressed: this.pressedStyles,</li><li>        })</li><li>    }</li><li>    .<span class="hljs-built_in">width</span>(<span class="hljs-number">350</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">300</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/StyleExample.ets#L2-L22" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// xxx.ets</span></li><li><span class="hljs-variable">@Entry</span></li><li><span class="hljs-variable">@Component</span></li><li>struct StyleExample {</li><li>  <span class="hljs-variable">@Styles</span></li><li>  <span class="hljs-built_in">pressedStyles</span>(): void {</li><li>    <span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">"#ED6F21"</span>)</li><li>  }</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-selector-tag">Flex</span>({ <span class="hljs-attribute">direction</span>: FlexDirection.Column, <span class="hljs-attribute">alignItems</span>: ItemAlign.Center }) {</li><li>      <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">"pressed"</span>)</li><li>        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">100</span>)</li><li>        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)</li><li>        <span class="hljs-selector-class">.stateEffect</span>(false)</li><li>        <span class="hljs-selector-class">.stateStyles</span>({</li><li>          pressed: this.pressedStyles,</li><li>        })</li><li>    }</li><li>    .<span class="hljs-built_in">width</span>(<span class="hljs-number">350</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">300</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/StyleExample.ets#L2-L22" target="_blank">StyleExample.ets</a></div></div></div></div> <p></p> <p>8、Image组件接口使用不规范</p> <p><strong>【问题描述】</strong></p> <p>使用image组件申请pixmap或直接使用OH_pixmap接口时，如果不设置编解码尺寸，单张图片可能占用数百MB甚至超过1GB的内存。多张图片申请后，可能会因系统限制导致应用闪退。</p> <p><strong>【使用错误影响】</strong></p> <p>应用会闪退</p> <p><strong>【使用建议】</strong></p> <p>使用Image组件时，建议通过autoSize或sourceSize降低编解码分辨率。</p> <p></p> <p>9、GetRectangleById接口可能存在组件不存在场景</p> <p><strong>【问题描述】</strong></p> <p>该接口使用了Inspector的内部接口。如果指定的Id对应的组件不存在，此时不会返回异常，入参ComponentInfo将使用全0的默认值。</p> <p><strong>【使用错误影响】</strong></p> <p>错误使用位置信息会导致应用异常</p> <p><strong>【使用建议】</strong></p> <p>判断入参ComponentInfo是否为全0的默认值</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-componentutils#getrectanglebyid" target="_blank">getRectangleById</a></p> <p><strong>【典型案例】</strong></p> <p>桌面返回时查找位置异常，导致返回动效和桌面显示异常。</p> <p><strong>【最佳实践】</strong></p> <p></p> <p>10、getInspectorByKey接口可能存在组件不存在场景，返回的是空字符串而不是空json对象。</p> <p><strong>【问题描述】</strong></p> <p>getInspectorByKey接口可能存在组件不存在场景，返回的是空字符串而不是空json对象</p> <p><strong>【使用错误影响】</strong></p> <p>应用错误地使用JSON判断空字符串，导致异常。</p> <p><strong>【使用建议】</strong></p> <p>应对接口进行空字符串判断。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-component-id#getinspectorbykey9" target="_blank">getInspectorByKey</a></p> <p></p> <p>11、不推荐在aboutToAppear、aboutToDisappear中调用动画。</p> <p><strong>【问题描述】</strong></p> <ul><li>如果在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttoappear" target="_blank">aboutToAppear</a>中调用动画，自定义组件内的build还未执行，内部组件还未创建，动画时机过早，动画属性没有初值无法对组件产生动画。</li><li>执行<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-custom-component-lifecycle#abouttodisappear" target="_blank">aboutToDisappear</a>时，组件即将销毁，不能在aboutToDisappear里面做动画。</li></ul> <p><strong>【使用建议】</strong></p> <p>不要在aboutToAppear和aboutToDisappear生命周期回调中调用以下动画接口：animateTo、animateToImmediately、keyframeAnimateTo。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-explicit-animation" target="_blank">显式动画 (animateTo)</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">widthSize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">250</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">heightSize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">100</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">opacitySize</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">myScale</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">1.0</span>;</li><li>  <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">animateToImmediately</span>({</li><li>      <span class="hljs-variable">delay</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>    }, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">opacitySize</span> = <span class="hljs-number">1</span></li><li>    })</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({</li><li>      <span class="hljs-variable">delay</span>: <span class="hljs-number">1000</span>,</li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>    }, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">widthSize</span> = <span class="hljs-number">150</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">heightSize</span> = <span class="hljs-number">60</span></li><li>    })</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">getUIContext</span>?.();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">keyframeAnimateTo</span>({ <span class="hljs-variable">iterations</span>: <span class="hljs-number">3</span> }, [</li><li>      {</li><li>        <span class="hljs-comment">// 第一段关键帧动画时长为800ms，scale属性做从1到1.5的动画</span></li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-number">800</span>,</li><li>        <span class="hljs-variable">event</span>: () =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">myScale</span> = <span class="hljs-number">1.5</span>;</li><li>        }</li><li>      },</li><li>      {</li><li>        <span class="hljs-comment">// 第二段关键帧动画时长为500ms，scale属性做从1.5到1的动画</span></li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-number">500</span>,</li><li>        <span class="hljs-variable">event</span>: () =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">myScale</span> = <span class="hljs-number">1</span>;</li><li>        }</li><li>      }</li><li>    ]);</li><li>  }</li><li>  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">animateToImmediately</span>({</li><li>      <span class="hljs-variable">delay</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>    }, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">opacitySize</span> = <span class="hljs-number">1</span></li><li>    })</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({</li><li>      <span class="hljs-variable">delay</span>: <span class="hljs-number">1000</span>,</li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>    }, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">widthSize</span> = <span class="hljs-number">150</span></li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">heightSize</span> = <span class="hljs-number">60</span></li><li>    })</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">getUIContext</span>?.();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">uiContext</span>.<span class="hljs-title function_">keyframeAnimateTo</span>({ <span class="hljs-variable">iterations</span>: <span class="hljs-number">3</span> }, [</li><li>      {</li><li>        <span class="hljs-comment">// 第一段关键帧动画时长为800ms，scale属性做从1到1.5的动画</span></li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-number">800</span>,</li><li>        <span class="hljs-variable">event</span>: () =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">myScale</span> = <span class="hljs-number">1.5</span>;</li><li>        }</li><li>      },</li><li>      {</li><li>        <span class="hljs-comment">// 第二段关键帧动画时长为500ms，scale属性做从1.5到1的动画</span></li><li>        <span class="hljs-variable">duration</span>: <span class="hljs-number">500</span>,</li><li>        <span class="hljs-variable">event</span>: () =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">myScale</span> = <span class="hljs-number">1</span>;</li><li>        }</li><li>      }</li><li>    ]);</li><li>  }</li></ol></pre></div></div> <p></p> <p>12、使用if/else来做数据保护时，不建议在动画闭包里操作数据，否则会crash。</p> <p><strong>【问题描述】</strong></p> <p>在动画过程中修改if/else分支，而该分支用于数据保护。继续使用该分支会导致数据访问异常，最终引发崩溃。</p> <p><strong>【使用错误影响】</strong></p> <p>应用会生成jscrash日志</p> <p><strong>【使用建议】</strong></p> <p>请参见“最佳实践”示例代码</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-rendering-control-ifelse" target="_blank">if/else：条件渲染</a></p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span> {</li><li>  str: string;</li><li>  <span class="hljs-keyword">constructor</span>(str: string) {</li><li>    <span class="hljs-keyword">this</span>.str = str;</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-meta">@State</span> data1: MyData|undefined = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>  <span class="hljs-meta">@State</span> data2: MyData|undefined = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>  build() {</li><li>    Column() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>        <span class="hljs-comment">// 如果在动画中增加/删除，会给Text增加默认转场</span></li><li>        <span class="hljs-comment">// 对于删除时，增加默认透明度转场后，会延长组件的生命周期，Text组件没有真正删除，而是等转场动画做完后才删除</span></li><li>        Text(<span class="hljs-keyword">this</span>.data1.str)</li><li>          .id(<span class="hljs-string">"1"</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data2) {</li><li>        <span class="hljs-comment">// 如果在动画中增加/删除，会给Text增加默认转场</span></li><li>        Text(<span class="hljs-keyword">this</span>.data2.str)</li><li>          .id(<span class="hljs-string">"2"</span>)</li><li>      }</li><li>      Button(<span class="hljs-string">"play with animation"</span>)</li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.getUIContext().animateTo({}, ()=&gt;{</li><li>            <span class="hljs-comment">// 在animateTo中修改if条件，在动画当中，会给if下的第一层组件默认转场</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>              <span class="hljs-keyword">this</span>.data1 = undefined;</li><li>              <span class="hljs-keyword">this</span>.data2 = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-keyword">this</span>.data1 = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>              <span class="hljs-keyword">this</span>.data2 = undefined;</li><li>            }</li><li>          })</li><li>        })</li><li>      Button(<span class="hljs-string">"play directly"</span>)</li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-comment">// 直接改if条件，不在动画当中，可以正常切换，也不会加默认转场</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>            <span class="hljs-keyword">this</span>.data1 = undefined;</li><li>            <span class="hljs-keyword">this</span>.data2 = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">this</span>.data1 = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>            <span class="hljs-keyword">this</span>.data2 = undefined;</li><li>          }</li><li>        })</li><li>    }.width(<span class="hljs-string">"100%"</span>)</li><li>    .padding(<span class="hljs-number">10</span>)</li><li>  }</li><li>}</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <p>方式1：给数据继续加判空的保护，即在使用data时再加一层判空，即"Text(this.data1?.str)"。</p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/animate1.ets#L2-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span> {</li><li>  str: string;</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(str: string) {</li><li>    <span class="hljs-keyword">this</span>.str = str;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-meta">@State</span> data1: MyData | undefined = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>  <span class="hljs-meta">@State</span> data2: MyData | undefined = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>
</li><li>  build() {</li><li>    Column() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>        <span class="hljs-comment">// If adding/deleting in the animation, it will add default transitions to the Text</span></li><li>        <span class="hljs-comment">// When deleting, increasing the default transparency transition will extend the lifecycle of the component. The Text component is not actually deleted, but is only deleted after the transition animation is completed</span></li><li>        <span class="hljs-comment">// Add an additional layer of null protection when using data, and only use the str in data1 if it exists</span></li><li>        Text(<span class="hljs-keyword">this</span>.data1?.str)</li><li>          .id(<span class="hljs-string">"1"</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data2) {</li><li>        <span class="hljs-comment">// If adding/deleting in the animation, it will add default transitions to the Text</span></li><li>        <span class="hljs-comment">// Add another layer of null protection when using data</span></li><li>        Text(<span class="hljs-keyword">this</span>.data2?.str)</li><li>          .id(<span class="hljs-string">"2"</span>)</li><li>      }</li><li>      Button(<span class="hljs-string">"play with animation"</span>)</li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.getUIContext().animateTo({}, () =&gt; {</li><li>            <span class="hljs-comment">// Modifying the if condition in animateTo will give default transitions to the first layer components under if in the animation</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>              <span class="hljs-keyword">this</span>.data1 = undefined;</li><li>              <span class="hljs-keyword">this</span>.data2 = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-keyword">this</span>.data1 = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>              <span class="hljs-keyword">this</span>.data2 = undefined;</li><li>            }</li><li>          })</li><li>        })</li><li>    }.width(<span class="hljs-string">"100%"</span>)</li><li>    .padding(<span class="hljs-number">10</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/animate1.ets#L2-L46" target="_blank">animate1.ets</a></div></div></div></div> <p>方式2：给if/else下要删除的组件添加transition(TransitionEffect.IDENTITY)属性，避免系统添加默认转场</p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/animate2.ets#L2-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyData</span> {</li><li>  str: string;</li><li>  <span class="hljs-keyword">constructor</span>(str: string) {</li><li>    <span class="hljs-keyword">this</span>.str = str;</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-meta">@State</span> data1: MyData|undefined = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>  <span class="hljs-meta">@State</span> data2: MyData|undefined = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>  build() {</li><li>    Column() {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>        <span class="hljs-comment">// Display a specified empty transition effect in the root component of IfElse to avoid default transition animations</span></li><li>        Text(<span class="hljs-keyword">this</span>.data1.str)</li><li>          .transition(TransitionEffect.IDENTITY)</li><li>          .id(<span class="hljs-string">"1"</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data2) {</li><li>        <span class="hljs-comment">// Display a specified empty transition effect in the root component of IfElse to avoid default transition animations</span></li><li>        Text(<span class="hljs-keyword">this</span>.data2.str)</li><li>          .transition(TransitionEffect.IDENTITY)</li><li>          .id(<span class="hljs-string">"2"</span>)</li><li>      }</li><li>      Button(<span class="hljs-string">"play with animation"</span>)</li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.getUIContext().animateTo({}, ()=&gt;{</li><li>            <span class="hljs-comment">// Modifying the if condition in animateTo will give default transitions to the first layer components under if in the animation</span></li><li>            <span class="hljs-comment">// But since the specified transition has already been displayed, no default transition will be added</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.data1) {</li><li>              <span class="hljs-keyword">this</span>.data1 = undefined;</li><li>              <span class="hljs-keyword">this</span>.data2 = new MyData(<span class="hljs-string">"branch 1"</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-keyword">this</span>.data1 = new MyData(<span class="hljs-string">"branch 0"</span>);</li><li>              <span class="hljs-keyword">this</span>.data2 = undefined;</li><li>            }</li><li>          })</li><li>        })</li><li>    }.width(<span class="hljs-string">"100%"</span>)</li><li>    .padding(<span class="hljs-number">10</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/ets/pages/animate2.ets#L2-L44" target="_blank">animate2.ets</a></div></div></div></div> <p></p> <p>13、滚动类组件当Scroller控制器未绑定容器组件或者容器组件被异常释放时，currentOffset的返回值为空。</p> <p><strong>【问题描述】</strong></p> <p>当Scroller控制器未绑定容器组件或者容器组件被异常释放时，currentOffset的返回值为空</p> <p><strong>【使用错误影响】</strong></p> <p>currentOffset的返回值为空，导致应用出现异常。</p> <p><strong>【使用建议】</strong></p> <p>使用该接口时，应判断this.scroller.currentOffset?.yOffset是否为空。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scroll#currentoffset" target="_blank">currentOffset</a></p> <p></p> <div class="tiledSection"><h2 id="section16618135443617">IPC相关API<i class="anchor-icon anchor-icon-link" anchorid="section16618135443617" tips="复制节点链接"></i></h2><p>1、使用IPC&amp;RPC通信时，调用writeString使用不规范</p> <p><strong>【问题描述】</strong></p> <p>业务在使用writeString时，某些特殊字符无法通过IPC传输，导致报错“检查参数错误”。</p> <p><strong>【使用错误影响】</strong></p> <p>调用IPC接口失败</p> <p><strong>【使用建议】</strong></p> <ul><li>使用writeString传递字符串时，长度不要超过40960字节。</li><li>如果超过上限，业务在做分段传递时需要考虑截断字符串时不要截出异常字符。</li></ul> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#writestring9" target="_blank">writeString</a></p> <p></p> <p>2、使用IPC&amp;RPC通信时，MessageSequence使用不规范</p> <p><strong>【问题描述】</strong></p> <p>在MessageSequence类中写入大量数据时，调用具体的write方法可能会失败，具体错误日志为：No enough capacity to write。</p> <p><strong>【使用错误影响】</strong></p> <p>调用IPC接口失败</p> <p><strong>【使用建议】</strong></p> <p>1、使用MessageSequence对象传递数据，写的总数据量不超过200KB。</p> <p>2、遇到大数据量传输时，同设备调用可以使用writeRawDataBuffer和writeAshmem，跨设备调用使用writeRawDataBuffer。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#messagesequence9" target="_blank">MessageSequence</a></p> <p></p> <p>3、rpc.MessageParcel 或rpc.MessageSequence 使用不规范</p> <p><strong>【问题描述】</strong></p> <p>业务TS应用客户端使用rpc.MessageParcel.create()或rpc.MessageSequence.create()创建的data和reply未调用其reclaim接口，导致资源无法释放。</p> <p><strong>【使用错误影响】</strong></p> <p>内存泄漏、文件描述符泄露、binder内存不足导致通信失败。</p> <p><strong>【使用建议】</strong></p> <p>客户端发消息结束后需调用data 和 reply 的 reclaim接口。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#messagesequence9" target="_blank">MessageSequence</a></p> <p><strong>【最佳实践】</strong></p> <p>达到parcel的上限200KB后，使用RawData传输超过200KB的数据。</p> <p></p> <p>4、创建Ashmem对象后，写入数据正常，但读取数据失败。</p> <p><strong>【问题描述】</strong></p> <p>创建Ashmem对象后，写数据正常读数据失败</p> <p><strong>【使用错误影响】</strong></p> <p>无法接收对端传输的数据。</p> <p>调用IPC接口时出现错误。</p> <p><strong>【使用建议】</strong></p> <p>1、在使用Ashmem去写数据时，先调用mapReadWriteAshmem方法，创建可读写的共享文件的映射，之后调用writeDataToAshmem方法写对应的数据。</p> <p>2、从Ashmem中去读取数据时，需要先调用mapReadWriteAshmem方法，创建可读写的共享文件的映射，之后调用readDataFromAshmem方法读对应的数据。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#ashmem8" target="_blank">Ashmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#mapreadwriteashmem9" target="_blank">mapReadWriteAshmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#writedatatoashmem11" target="_blank">writeDataToAshmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#readdatafromashmem11" target="_blank">readDataFromAshmem</a></p> <p></p> <p>5、使用Ashmem对像传递数据，Ashmem的内存未释放</p> <p><strong>【问题描述】</strong></p> <p>业务使用了Ashmem存储数据，读取完成后调用了closeAshmem方法以释放之前分配的共享内存，但似乎没有生效。</p> <p><strong>【使用错误影响】</strong></p> <p>内存无法释放，导致内存泄漏、FD泄露、binder内存不足通信失败。</p> <p><strong>【使用建议】</strong></p> <p>释放之前开辟的共享内存，第一步先调用unmapAshmem方法，删除前面创建出来的Ashmem对象的地址映射，第二步才是调用closeAshmem方法，关闭这个Ashmem对象。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#ashmem8" target="_blank">Ashmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#writedatatoashmem11" target="_blank">writeDataToAshmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#readdatafromashmem11" target="_blank">readDataFromAshmem</a></p> <p>MessageSequence类中的读写方法：</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#writeashmem9" target="_blank">writeAshmem</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#readashmem9" target="_blank">readAshmem</a></p> <p></p> <p>6、调用新接口传递ArrayBuffer数据时，读取数据对应不上</p> <p><strong>【问题描述】</strong></p> <p>上层业务使用writeArrayBuffer和readArrayBuffer方法传递ArrayBuffer数据时，读取数据不匹配。</p> <p><strong>【使用错误影响】</strong></p> <p>写入的数据和读取的数据有差异</p> <p><strong>【使用建议】</strong></p> <p>1、读写的第一个参数一定是ArrayBuffer类型，不能传具体的TypedArray，例如：Int16Array</p> <p>2、读写第二个参数是具体的typedArray类型枚举值，读和写的TypeCode值需要是对应的</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#writearraybuffer12" target="_blank">writeArrayBuffer</a></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#readarraybuffer12" target="_blank">readArrayBuffer</a></p> <p><strong>【典型案例】</strong></p> <p>具体创建的typedArray跟写时传递的类型枚举值TypeCode不匹配，报错read data from message sequence failed</p> <p><span><img originheight="360" originwidth="875" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.79964912819168462170894594633355:50001231000000:2800:E99B76A67B907F9FE9CEE377BCDB8660AAED6D821C9DD56BBA1A64B205952D81.png" width="875" height="360"></span></p> <p>字节不匹配，写入失败</p> <p><span><img originheight="57" originwidth="763" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.87649513046325118184149758785514:50001231000000:2800:EE8D4988B1B6EDC3F3B857209004550858CA1855A87FE6EE4CBE4E24B5BC9300.png" width="763" height="57"></span></p> <p></p> <p>7、onRemoteRequest函数报错，返回错误码4</p> <p><strong>【问题描述】</strong></p> <p>客户端发送信息给服务端，服务端处理时出现错误，错误日志为：OnJsRemoteRequest failed, ret:4, time:xxxxx。</p> <p><span><img originheight="42" originwidth="880" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.43272877185795852929128514100255:50001231000000:2800:F6A86925A94B38E3C92747D4B5E83E00D96F1FDCC6AED914C94905C8BFA9C6E9.png" width="880" height="42"></span></p> <p><strong>【使用错误影响】</strong></p> <p>服务端在处理接受的消息后，客户端无法拿到其回传的信息</p> <p><strong>【使用建议】</strong></p> <p>1、业务在onRemoteRequest或RemoteMessageRequest函数中，合理返回true或false。</p> <p>2、当上层业务返回false时，IPC内部会认为此次通信是失败的，会直接赋值为4，结束此次通信</p> <p></p> <p>8、使用IPC进行通信时，业务data和reply释放时机不对</p> <p><strong>【问题描述】</strong></p> <p>使用IPC进行通信时，业务data和reply释放时机不对，业务在调用readInt方法时调用失败</p> <p><strong>【使用错误影响】</strong></p> <p>方法调用失败，无法拿到业务回传的信息</p> <p><strong>【使用建议】</strong></p> <p>合理使用reclaim方法，确保在创建data和reply对象时不会出现问题。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-rpc#reclaim9" target="_blank">reclaim</a></p> <p><strong>【最佳实践】</strong></p> <p>sendMessageRequest(code: number, data: MessageSequence, reply: MessageSequence, options: MessageOption): Promise&lt;RequestResult&gt;</p> <p>在使用上述方法时，确保在promise的.finally回调中释放不再需要的对象，并且确保promise的.then或.catch回调中的逻辑先于释放对象的操作。</p> <p><span><img originheight="434" originwidth="923" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.23033301992984100779933295804089:50001231000000:2800:05F8B754BF6D72395E63E0760D929EE103A1AE4498B9697A516467F08A3FBBED.png" width="920" height="432.5893824485374"></span></p> <p>sendMessageRequest(code: number, data: MessageSequence, reply: MessageSequence, options: MessageOption, callback: AsyncCallback&lt;RequestResult&gt;): void</p> <p>在使用此方法时，必须在AsyncCallback回调中获取业务数据后才能释放。</p> <p><span><img originheight="389" originwidth="897" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.52141648593554746011190513493765:50001231000000:2800:C2755E269270F7AD4F388AEDDE842B3906405BB8F6FEB09B315BE1EB5046FA79.png" width="897" height="389"></span></p> </div> <div class="tiledSection"><h2 id="section1578374517400">图形API<i class="anchor-icon anchor-icon-link" anchorid="section1578374517400" tips="复制节点链接"></i></h2></div> <p>1、OH_NativeWindow_DestroyNativeWindow()使用问题</p> <p><strong>【问题描述】</strong></p> <p>由于对OH_NativeImage_AcquireNativeWindow()和OH_NativeWindow_DestroyNativeWindow()等接口理解不准确，导致重复释放。</p> <p><strong>【使用错误影响】</strong></p> <p>处理地址越界问题</p> <p><strong>【使用建议】</strong></p> <p>调用OH_NativeImage_Destroy时，无需调用OH_NativeWindow_DestroyNativeWindow进行释放。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-image-h" target="_blank">OH_NativeImage</a></p> <p></p> <p>2、OH_NativeWindow相关接口野指针crash问题</p> <p><strong>【问题描述】</strong></p> <p>通过Native层接口调用时出现的崩溃问题</p> <p><span><img height="110.3019217137467" originheight="226" originwidth="1885" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.10716524815602524311950434036676:50001231000000:2800:DC083D107A578C633333676BA1A9342742609A2F6E8A33BCA06840AA612221DA.png" title="点击放大" width="920"></span></p> <p><strong>【使用错误影响】</strong></p> <ul><li>当应用在xcomponent析构后，如果已经触发了OnSurfaceDestroyedCB回调接口，nativewindow的引用计数会减少1。当引用计数减少到0时，将触发nativewindow的析构。在nativewindow析构后，如果再通过nativewindow调用接口，将会触发野指针崩溃。</li><li>应用可能手动调用OH_NativeWindow_DestroyNativeWindow接口对nativewindow进行引用计数减1。如果nativewindow已经析构，再次调用该接口会导致崩溃。</li></ul> <p><strong>【使用建议】</strong></p> <ul><li>排查xcomponent组件释放后是否还通过nativewindow进行接口调用。</li><li>排查是否存在并发释放xcomponent组件和并发调用nativewindow接口。</li><li>排查应用是否调用了OH_NativeWindow_DestroyNativeWindow对nativewindow进行引用计数减1。</li></ul> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-external-window-h" target="_blank">NativeWindow</a></p> <p></p> <p>3、OH_NativeWindow相关接口空指针crash问题</p> <p><strong>【问题描述】</strong></p> <p>crash的栈顶在libsurface.z.so中。</p> <p><span><img originheight="620" originwidth="1410" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.02397459478381379762265313836678:50001231000000:2800:EF11D7FD9270AA68438D55D4E0202CD212FDC8D34737D14FA8D69F787D961179.png" width="920" height="404.53900709219863"></span></p> <p><strong>【使用错误影响】</strong></p> <p>1、在调用GetBufferHandleFromNative接口时访问sfbuffer，此时sfbuffer为空指针，原因是另一个线程并发地将sfbuffer置空，导致系统崩溃。</p> <p>2、另一个线程触发了nativewindow的析构流程。在析构流程中，会将buffer进行unreference操作，随后触发buffer的析构，最后将sfbuffer置空。</p> <p><span><img originheight="225" originwidth="847" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.13276737806799294025919647790635:50001231000000:2800:D8422E03C10162358C15E2ADE213E4F0D3FA41E51756FAB51CC1CCC26DBB07E0.png" width="847" height="225"></span></p> <p><span><img originheight="326" originwidth="728" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.55922218836887506983554099520210:50001231000000:2800:7579C674C649572AB05F82272E449A9234E587BE7A94277A745C63A9EE5434D9.png" width="728" height="326"></span></p> <p><span><img originheight="113" originwidth="703" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.02113044638090687236062653090414:50001231000000:2800:BA596E92A37643BE4F96FC6693A2DAC219AF1F983526E2B396C9F6B1FB6F940A.png" width="703" height="113"></span></p> <p><strong>【使用建议】</strong></p> <p>通过调用栈往下找，找到真正使用nativewindow的so，例如上面的调用栈就找libweb_engine.so</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-external-window-h" target="_blank">NativeWindow</a></p> <div class="tiledSection"><h2 id="section1219614634615">方舟运行时API<i class="anchor-icon anchor-icon-link" anchorid="section1219614634615" tips="复制节点链接"></i></h2><p>1、【use after free】napi_async_work使用不规范</p> <p><strong>【问题描述】</strong></p> <p>napi_async_work 使用不规范导致了 UAF 问题。涉及的接口主要包括 napi_create_async_work、napi_queue_async_work 和 napi_queue_async_work_with_qos、napi_delete_async_work。</p> <p><strong>【使用错误影响】</strong></p> <p>系统栈发生crash，问题溯源较为困难。</p> <p><strong>【使用建议】</strong></p> <p>在napi_create_async_work的第五个参数中设置回调函数，将napi_delete_async_work的工作放在该回调函数中执行。这可以确保在异步任务执行期间，上层开发者的内存问题不会导致系统栈报错，从而便于问题定位。</p> <p><strong>【典型案例】</strong></p> <p>打开某应用时发生闪退。</p> <p><span><img originheight="252" originwidth="1028" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163459.06088012242602201820892980182034:50001231000000:2800:F155D22941948DDB31E92F6C303029AE862E74A07F8FBF38F608A42F112530C8.png" width="920" height="225.5252918287938"></span></p> <p>此栈主要由native开发者使用napi_async_work变量时，因生命周期管理不当导致UAF问题。难点在于这些栈都是系统栈，无法追踪到具体的调用方。然而，该问题是必然出现的，因此使用memtracker压测后，崩溃栈如下：</p> <p><span><img height="193.55518531932873" originheight="393" originwidth="1868" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.03288441741974923964981441008989:50001231000000:2800:C58F1261D2E061104B013C21B88B5989BCB0EE7174E6BFD7E430C9A5D344DF97.png" title="点击放大" width="920"></span></p> <p>根据上面崩溃栈，发现是liblargelanguagemodel.z.so申请和释放的内存，看一下他们的代码</p> <p><span><img height="369.38559772078287" originheight="746" originwidth="1858" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.60750060751734059495813450999319:50001231000000:2800:B9DCD19F3B0DB8FE15AF17D32D47822EB756BA39059F23ED9A77DBBAF5AC4C81.png" title="点击放大" width="920"></span></p> <p>开发者使用智能指针管理AsyncWorkData这块内存。在将任务插入到异步任务队列后，智能指针被重置，导致在析构函数中调用napi_delete_async_work。这使得异步任务流程还未完成时，内存已被释放，从而产生了UAF问题：</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"napi/native_api.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"uv.h"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_DOMAIN 0X0202</span></li><li><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOG_TAG <span class="hljs-string">"MyTag"</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;hilog/log.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/eventfd.h&gt;</span></span></li><li><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span></span></li><li><span class="hljs-type">uv_loop_t</span> *loop;</li><li>napi_value jsCb;</li><li><span class="hljs-type">int</span> fd = <span class="hljs-number">-1</span>;</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Add</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span></span></li><li><span class="hljs-function"></span>{</li><li>    napi_value work_name;</li><li>    napi_async_work work;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"ohos"</span>, NAPI_AUTO_LENGTH, &amp;work_name);</li><li>    <span class="hljs-comment">/* 第四个参数是异步线程的work任务，第五个参数为主线程的回调 */</span></li><li>    <span class="hljs-built_in">napi_create_async_work</span>(env, <span class="hljs-literal">nullptr</span>, work_name, [](napi_env env, <span class="hljs-type">void</span>* data){</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in execute"</span>);</li><li>    }, [](napi_env env, napi_status status, <span class="hljs-type">void</span> *data){</li><li>        <span class="hljs-comment">/* 不关心具体实现 */</span></li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"ohos in complete"</span>);</li><li>        <span class="hljs-built_in">napi_delete_async_work</span>(env, (napi_async_work)data);</li><li>    }, <span class="hljs-literal">nullptr</span>, &amp;work);</li><li>    <span class="hljs-comment">/* 通过napi_queue_async_work触发异步任务执行 */</span></li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, work);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</li><li>}</li><li>
</li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span></span>{</li><li>    napi_property_descriptor desc[] = {{<span class="hljs-string">"add"</span>, <span class="hljs-literal">nullptr</span>, Add, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    <span class="hljs-built_in">napi_define_properties</span>(env, exports, <span class="hljs-built_in">sizeof</span>(desc) / <span class="hljs-built_in">sizeof</span>(desc[<span class="hljs-number">0</span>]), desc);</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li><li>
</li><li><span class="hljs-type">static</span> napi_module demoModule = {</li><li>    .nm_version = <span class="hljs-number">1</span>,</li><li>    .nm_flags = <span class="hljs-number">0</span>,</li><li>    .nm_filename = <span class="hljs-literal">nullptr</span>,</li><li>    .nm_register_func = Init,</li><li>    .nm_modname = <span class="hljs-string">"entry"</span>,</li><li>    .nm_priv = ((<span class="hljs-type">void</span> *)<span class="hljs-number">0</span>),</li><li>    .reserved = {<span class="hljs-number">0</span>},</li><li>};</li><li>
</li><li><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> __attribute__((constructor)) <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">RegisterEntryModule</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span></span>{</li><li>    <span class="hljs-built_in">napi_module_register</span>(&amp;demoModule);</li><li>}</li></ol></pre></div></div> <p>在napi_create_async_work的第五个参数中设置回调函数，将napi_delete_async_work的工作放在该回调函数中执行。这可以确保在异步任务执行期间，上层开发者的内存问题不会反映在系统栈中，从而避免问题难以定位。</p> <p></p> <p>2、【double free】开发者手动释放ArrayBuffer内存导致double free</p> <p><strong>【问题描述】</strong></p> <p>开发者通过napi_get_arraybuffer_info接口获取ArrayBuffer的data指针，然后直接手动free这个内存导致应用崩溃。ArrayBuffer的内存由虚拟机GC统一管理，禁止开发者手动释放。</p> <p>napi_create_arraybuffer、napi_create_sendable_arraybuffer、napi_get_arraybuffer_info、napi_create_buffer、napi_get_buffer_info、napi_get_typedarray_info 和 napi_get_dataview_info 等接口的使用方法类似。</p> <p><strong>【使用错误影响】</strong></p> <p>应用出现闪退</p> <p><strong>【使用建议】</strong></p> <p>禁止手动释放ArrayBuffer内存。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines#防止重复释放获取的buffer" target="_blank">防止重复释放获取的buffer</a></p> <p><strong>【典型案例】</strong></p> <p>安装某应用后，如果搁置一段时间，会被强制退出，崩溃栈如下：</p> <p><span><img height="239.47990636334626" originheight="480" originwidth="1844" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.66411579209907055625821494189686:50001231000000:2800:905D43AF248F7AE42632F2C712069D7EC5F1302CBEAFBCFD06C56A3B3E476892.png" title="点击放大" width="920"></span></p> <p>【案例分析】</p> <p>安装MemTracker地址越界检测工具后，发现问题是由于开发者手动释放了通过虚拟机创建的ArrayBuffer内存，而虚拟机在垃圾回收时再次尝试释放同一块内存，导致了double free。对于ArrayBuffer内存，应由虚拟机统一管理，无需开发者手动释放。如果开发者尝试手动释放这块内存，可能会引发double free问题。</p> <p><span><img originheight="331" originwidth="1597" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.31880307496798943738712898046142:50001231000000:2800:04590A50FC27937A82A713444444A0D5ED34379EC6846675AA09D6BAC0882DC1.png" width="920" height="190.68252974326862"></span></p> <p><strong>【最佳实践】</strong></p> <p>开发者不允许主动释放虚拟机管理的ArrayBuffer指针。</p> <p></p> <p>3、【memory leak】开发者使用uv_queue_work方法将任务抛到js线程上面执行的时候，对js线程的回调方法未加handle scope</p> <p><strong>【问题描述】</strong></p> <p>开发者使用uv_queue_work方法将任务提交到JS线程执行时，在JS回调中创建了JS对象，但未使用napi_handle_scope管理回调中创建的napi_value的生命周期，导致内存泄漏。</p> <p><strong>【使用错误影响】</strong></p> <p>内存泄漏</p> <p><strong>【使用建议】</strong></p> <p>当使用uv_queue_work方法将任务提交到JS线程执行时，需要在JS线程的回调方法中使用napi_handle_scope来管理回调方法创建的napi_value的生命周期。</p> <p><strong>【文档链接】</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/napi-guidelines#异步任务" target="_blank">异步任务</a></p> <p><strong>【最佳实践】</strong></p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L19-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">callbackTest</span>(<span class="hljs-variable">CallbackContext</span>* <span class="hljs-variable">context</span>)</li><li>{</li><li>    <span class="hljs-variable">uv_loop_s</span>* <span class="hljs-variable">loop</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-title function_">napi_get_uv_event_loop</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, &amp;<span class="hljs-title class_">loop</span>);</li><li>
</li><li>
</li><li>    <span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">uv_work_t</span>;</li><li>    <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">retData</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span> = (<span class="hljs-variable">void</span>*)<span class="hljs-variable">context</span>;</li><li>
</li><li>
</li><li>    <span class="hljs-title function_">uv_queue_work</span>(</li><li>        <span class="hljs-variable">loop</span>, <span class="hljs-variable">work</span>, [](<span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span>) {},</li><li>        <span class="hljs-comment">// using callback function back to JS thread</span></li><li>        [](<span class="hljs-variable">uv_work_t</span>* <span class="hljs-variable">work</span>, <span class="hljs-variable">int</span> <span class="hljs-variable">status</span>) {</li><li>            <span class="hljs-variable">CallbackContext</span>* <span class="hljs-variable">context</span> = (<span class="hljs-variable">CallbackContext</span>*)<span class="hljs-variable">work</span>-&gt;<span class="hljs-title class_">data</span>;</li><li>            <span class="hljs-variable">napi_handle_scope</span> <span class="hljs-variable">scope</span> = <span class="hljs-variable">nullptr</span>;</li><li>            <span class="hljs-title function_">napi_open_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, &amp;<span class="hljs-title class_">scope</span>); <span class="hljs-comment">// open handle scope，The lifecycle of the JS object created below is managed by this scope</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">scope</span> == <span class="hljs-variable">nullptr</span>) {</li><li>                <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">callback</span> = <span class="hljs-variable">nullptr</span>;</li><li>            <span class="hljs-title function_">napi_get_reference_value</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>, &amp;<span class="hljs-title class_">callback</span>);</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">retArg</span>;</li><li>            <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">retData</span>, &amp;<span class="hljs-title class_">retArg</span>);</li><li>            <span class="hljs-variable">napi_value</span> <span class="hljs-variable">ret</span>;</li><li>            <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">callback</span>, <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">retArg</span>, &amp;<span class="hljs-title class_">ret</span>);</li><li>            <span class="hljs-title function_">napi_delete_reference</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">callbackRef</span>);</li><li>            <span class="hljs-title function_">napi_close_handle_scope</span>(<span class="hljs-variable">context</span>-&gt;<span class="hljs-title class_">env</span>, <span class="hljs-variable">scope</span>); <span class="hljs-comment">// close handle scope，If the objects under this scope are not referenced by other objects, they will be released after GC</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">work</span> != <span class="hljs-variable">nullptr</span>) {</li><li>                <span class="hljs-variable">delete</span> <span class="hljs-variable">work</span>;</li><li>            }</li><li>            <span class="hljs-variable">delete</span> <span class="hljs-variable">context</span>;</li><li>        }</li><li>    );</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L19-L54" target="_blank">callbackTest.cpp</a></div></div></div></div> <p></p> <p>4、【multi-thread】开发者使用napi接口时，跨线程使用napi_env或napi_value引发多线程安全问题</p> <p><strong>【问题描述】</strong></p> <p>绝大多数napi接口在调用时要求线程安全。即：</p> <p>1. NAPI接口仅能在JS线程上使用。</p> <p>2. 使用napi接口的线程需要与napi_env对应的JS线程保持一致。</p> <p>3. 使用napi接口的线程必须与创建资源类型（如napi_value、napi_ref等）的JS线程一致。</p> <p>如果开发者使用以下任一方式，则存在多线程安全问题：</p> <p>1. 开发者在非JS线程中使用NAPI接口。</p> <p>2. 开发者在JS线程中使用napi接口，但不在napi_env对应的JS线程上。</p> <p>3. 开发者使用napi接口时，不在napi_value或napi_ref创建的JS线程上。</p> <p>以上指的是“绝大多数napi接口”。部分napi接口例外，无以上约束。涉及接口有： 1.napi_call_threadsafe_function/napi_call_threadsafe_function_with_priority/napi_acquire_threadsafe_function/napi_release_threadsafe_function/napi_get_threadsafe_function_context/napi_ref_threadsafe_function/napi_unref_threadsafe_function -- napi的线程安全函数。</p> <p>2. napi_get_uv_event_loop -- 获取env上的loop，不涉及上述限制。</p> <p>3. napi_get_node_version。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退</p> <p><strong>【使用建议】</strong></p> <p>请遵循线程安全的要求，并在开发过程中开启多线程检测开关，以便及时发现多线程安全问题。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>hdc shell param <span class="hljs-built_in">set</span> persist.ark.properties 0x107c</li><li>hdc shell reboot</li></ol></pre></div></div> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AddonData</span> {</li><li>    napi_async_work asyncWork = <span class="hljs-literal">nullptr</span>;</li><li>};</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AddExecuteCB</span><span class="hljs-params">(napi_env env, <span class="hljs-type">void</span> *data)</span> </span>{</li><li>    napi_value ret = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;ret); <span class="hljs-comment">// 在非js线程使用napi_create_object接口，存在多线程安全问题</span></li><li>}</li><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">AddCallbackCompleteCB</span><span class="hljs-params">(napi_env env, napi_status status, <span class="hljs-type">void</span> *data)</span> </span>{</li><li>
</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">AddonData</span> *addonData = (<span class="hljs-keyword">struct</span> AddonData *)<span class="hljs-built_in">malloc</span>(<span class="hljs-built_in">sizeof</span>(<span class="hljs-keyword">struct</span> AddonData));</li><li>    <span class="hljs-keyword">if</span> (addonData == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>    napi_value resourceName = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-built_in">napi_create_string_utf8</span>(env, <span class="hljs-string">"AsyncWorkTest"</span>, NAPI_AUTO_LENGTH, &amp;resourceName);</li><li>    <span class="hljs-built_in">napi_create_async_work</span>(env, <span class="hljs-literal">nullptr</span>, resourceName, AddExecuteCB, AddCallbackCompleteCB,</li><li>                                          (<span class="hljs-type">void</span> *)addonData, &amp;addonData-&gt;asyncWork);</li><li>    <span class="hljs-built_in">napi_queue_async_work</span>(env, addonData-&gt;asyncWork);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <p>打开多线程检测开关后，可拦截到第一现场。</p> <p>可通过命令整机打开多线程检测开关。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>hdc shell param <span class="hljs-built_in">set</span> persist.ark.properties 0x107c</li><li>hdc shell reboot</li></ol></pre></div></div> <p>也可在DevEco Studio中勾选多线程检测选项。</p> <p><span><img height="428.9409792558999" originheight="877" originwidth="1881" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.90452569796971819902193829434270:50001231000000:2800:59BBEC80CE531940B1E5D7BC95E7BBC08EE14B00DB09B3BCE6A1EFD269C8D95B.png" title="点击放大" width="920"></span></p> <p>5、【multi-thread】跨线程使用napi_add_env_cleanup_hook导致多线程安全问题</p> <p><strong>【问题描述】</strong></p> <p>同理接口有napi_remove_env_cleanup_hook。此系列接口并非线程安全，只允许在napi_env所对应的js线程上使用，多线程使用会存在多线程安全问题导致崩溃。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退</p> <p><strong>【使用建议】</strong></p> <p>只允许在napi_env对应的JS线程中调用napi_add_env_cleanup_hook和napi_remove_env_cleanup_hook，禁止跨线程调用。</p> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV_MAPERR</span>)@<span class="hljs-number">0x006b6b5b440fd5c8</span> </li><li><span class="hljs-variable">LastFatalMessage</span>:<span class="hljs-title class_">LabelServiceStub</span> <span class="hljs-title class_">construct</span></li><li><span class="hljs-variable">Fault</span> <span class="hljs-variable">thread</span> <span class="hljs-variable">info</span>:</li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">9138</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">OS_IPC_13_9138</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000069</span><span class="hljs-variable">ff0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">__hash_table</span>&lt;<span class="hljs-title class_">NativeEngine</span>*, <span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">hash</span>&lt;<span class="hljs-title class_">NativeEngine</span>*&gt;, <span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">equal_to</span>&lt;<span class="hljs-title class_">NativeEngine</span>*&gt;, <span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">allocator</span>&lt;<span class="hljs-title class_">NativeEngine</span>*&gt;&gt;::<span class="hljs-title class_">remove</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">__hash_const_iterator</span>&lt;<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">__hash_node</span>&lt;<span class="hljs-variable">NativeEngine</span>*, <span class="hljs-variable">void</span>*&gt;*&gt;)+<span class="hljs-number">112</span>)(<span class="hljs-number">1529322</span><span class="hljs-variable">f26fe2bfe6fc21fa2caae6e4d</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000006</span><span class="hljs-variable">a938</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-number">1529322</span><span class="hljs-variable">f26fe2bfe6fc21fa2caae6e4d</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000068170</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">NativeEngine</span>::<span class="hljs-title class_">RemoveCleanupHook</span>(<span class="hljs-title class_">void</span> (*)(<span class="hljs-variable">void</span>*), <span class="hljs-variable">void</span>*)+<span class="hljs-number">416</span>)(<span class="hljs-number">1529322</span><span class="hljs-variable">f26fe2bfe6fc21fa2caae6e4d</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000006</span><span class="hljs-variable">cbbc</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">napi_remove_env_cleanup_hook</span>+<span class="hljs-number">76</span>)(<span class="hljs-number">1529322</span><span class="hljs-variable">f26fe2bfe6fc21fa2caae6e4d</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000004460</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObject</span>::<span class="hljs-title class_">OnJsRemoteRequest</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-variable">CallbackParam</span>*)+<span class="hljs-number">796</span>)(<span class="hljs-variable">f9231ae5cbe6abf63dff4fda9df5a97b</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000441</span><span class="hljs-variable">a8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObject</span>::<span class="hljs-title class_">OnRemoteRequest</span>(<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;)+<span class="hljs-number">544</span>)(<span class="hljs-variable">f9231ae5cbe6abf63dff4fda9df5a97b</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000443e8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_single</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">IPCObjectStub</span>::<span class="hljs-title class_">SendRequestInner</span>(<span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;)+<span class="hljs-number">152</span>)(<span class="hljs-number">762</span><span class="hljs-variable">ec7ac78c9865d1985559fef9f42ac</span>)</li><li>#<span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000005</span><span class="hljs-variable">f508</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_single</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">GeneralServiceSendRequest</span>(<span class="hljs-title class_">binder_transaction_data</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;)+<span class="hljs-number">408</span>)(<span class="hljs-number">762</span><span class="hljs-variable">ec7ac78c9865d1985559fef9f42ac</span>)</li><li>#<span class="hljs-number">08</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000005</span><span class="hljs-variable">f66c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_single</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">TargetStubSendRequest</span>(<span class="hljs-title class_">binder_transaction_data</span> <span class="hljs-keyword">const</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageParcel</span>&amp;, <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">MessageOption</span>&amp;, <span class="hljs-title class_">unsigned</span> <span class="hljs-title class_">int</span>&amp;)+<span class="hljs-number">148</span>)(<span class="hljs-number">762</span><span class="hljs-variable">ec7ac78c9865d1985559fef9f42ac</span>)</li><li>#<span class="hljs-number">09</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000005</span><span class="hljs-variable">f92c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_single</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">BinderInvoker</span>::<span class="hljs-title class_">Transaction</span>(<span class="hljs-title class_">binder_transaction_data_secctx</span>&amp;)+<span class="hljs-number">644</span>)(<span class="hljs-number">762</span><span class="hljs-variable">ec7ac78c9865d1985559fef9f42ac</span>)</li></ol></pre></div></div> <p><strong>【最佳实践】</strong></p> <p>开发过程中可打开多线程安全检测开关。若存在napi_add_env_cleanup_hook或napi_remove_env_cleanup_hook的多线程问题，hilog会打印第一现场的调用栈。</p> <p><span><img height="211.16606137561163" originheight="572" originwidth="2492" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.16894394962019600926462986827696:50001231000000:2800:1E4559822044F4B3D0BB692F432BCB4FA3A343A64605F5779154761BF23CE71E.png" title="点击放大" width="920"></span></p> <p>6、开发者使用napi_add_env_cleanup_hook时，键值重复导致注册失败</p> <p><strong>【问题描述】</strong></p> <p>同理接口有napi_remove_env_cleanup_hook。开发者使用napi_add_env_cleanup_hook向env上注册回调时，该接口第三个入参args是作为map的key值，当开发者重复注册同一个args的回调时，后续注册动作将会失败，仅第一次注册才会成功。注册失败可能会引起后续业务上的功能/崩溃问题。</p> <p><strong>【使用错误影响】</strong></p> <p>功能问题/应用闪退。</p> <p><strong>【使用建议】</strong></p> <p>避免对同一args值注册不同回调。一次回调内完成所有动作。</p> <p><strong>【典型案例】</strong></p> <p>使用env作为参数调用AddCleanHook注册可能会失败。如果注册失败，将无法调用回调来清理map中的reference。这可能导致env的指针后续被复用，从而获取到一个已经被释放的napi_ref。</p> <p>修改方案：使用唯一的key</p> <p><span><img height="141.20064749592552" originheight="289" originwidth="1883" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.51596035162481113685425278738949:50001231000000:2800:516536BD3F0AB43DBD38585FBDB767FCE01FFA7F01CF4E95B561DEE88FB5146F.png" title="点击放大" width="920"></span></p> <p><strong>【最佳实践】</strong></p> <p>打开多线程检测开关后，hilog会打印注册失败的backtrace。</p> <p><span><img originheight="295" originwidth="1609" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.30604814307944344642875093766163:50001231000000:2800:F7CCA44DB78B3A4855A29F36F50AAAF6164212638E15FFFD5539A43EE8784A6F.png" width="920" height="168.67619639527655"></span></p> <p>7、【use after free】合理运用napi_handle_scope，避免超napi_value生命周期导致崩溃</p> <p><strong>【问题描述】</strong></p> <p>napi_value受scope管控，出scope后napi_value将失效，出scope后再使用napi_value会产生未定义行为。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退/应用行为异常</p> <p><strong>【使用建议】</strong></p> <p>可选方案（任选其一）：</p> <p>1. 使用napi_escapable_handle_scope，将napi_value逃逸出当前作用域，交由上层作用域管理。</p> <p>2. 使用napi_ref创建强引用，主动管理JS对象的生命周期。注意，需要主动调用napi_delete_reference以释放强引用。</p> <p><strong>【典型案例】</strong></p> <p><strong>案例一</strong>：napi_value超开发者自己声明的scope范围</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>static napi_value Test2(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info) {</li><li>    napi_handle_scope scope = nullptr;</li><li>    napi_value value1 = nullptr;</li><li>    napi_value value2 = nullptr;</li><li>    napi_value value3 = nullptr;</li><li>    napi_open_handle_scope(<span class="hljs-built_in">env</span>, &amp;scope);</li><li>    napi_create_object(<span class="hljs-built_in">env</span>, &amp;value1);</li><li>    napi_close_handle_scope(<span class="hljs-built_in">env</span>, scope);</li><li>    napi_create_string_utf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"const char *str"</span>, NAPI_AUTO_LENGTH, &amp;value2);</li><li>    napi_create_string_utf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"const char *str"</span>, NAPI_AUTO_LENGTH, &amp;value3);</li><li>    napi_valuetype <span class="hljs-built_in">type</span> = napi_null;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, value1, &amp;<span class="hljs-built_in">type</span>);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"xxx, %{public}d"</span>, <span class="hljs-built_in">type</span>);</li><li>
</li><li>    <span class="hljs-built_in">return</span> value1;</li><li>}</li></ol></pre></div></div> <p><span><img originheight="72" originwidth="715" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.12069516057691923314074164186268:50001231000000:2800:F0B982791915953B3EB78F866E5EE6352DEEE9D473217C594BF1C3F90496C48A.png" width="715" height="72"></span></p> <p>创建时是对象（obj），但超出作用域后再次使用时，类型变为字符串（string），导致行为异常。</p> <p><strong>案例二</strong>：napi_value超napi框架的scope范围</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" data-highlighted="yes"><ol class="linenums"><li>testNapi<span class="hljs-selector-class">.test3</span>(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);</li><li>testNapi<span class="hljs-selector-class">.test4</span>()<span class="hljs-selector-class">.length</span>;</li></ol></pre></div></div> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>napi_value objvalues = <span class="hljs-literal">nullptr</span>;</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test3</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-built_in">napi_create_object</span>(env, &amp;objvalues);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test4</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{ <span class="hljs-keyword">return</span> objvalues; }</li></ol></pre></div></div> <p><span><img originheight="436" originwidth="775" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.57870865246303701241125806284782:50001231000000:2800:7E8AC623BD56116B10995AD20B6D8DC3059FD420BEF5E0382BF340F4520CB146.png" width="775" height="436"></span></p> <p><strong>原因分析：</strong></p> <p>跨NAPI的native_value未使用napi_ref保存，超出NAPI调用框架的范围后，native_value失效。</p> <p>注：NAPI框架中的scope即napi_handle_scope，开发者可以通过napi_handle_scope管理napi_value的生命周期。框架层的scope嵌入在js调用native的整个流程中，在进入native方法前打开scope，在native方法结束后关闭scope。</p> <p><strong>【最佳实践】</strong></p> <p>1. 针对案例1，使用napi_escapable_handle_scope，并在close之前提前escape。</p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L58-L78" data-highlighted="yes"><ol class="linenums"><li>static napi_value Test2(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info) {</li><li>    napi_escapable_handle_scope scope = nullptr;</li><li>    napi_value value1 = nullptr;</li><li>    napi_value value2 = nullptr;</li><li>    napi_value value3 = nullptr;</li><li>    napi_value value4 = nullptr;</li><li>
</li><li>
</li><li>    napi_open_escapable_handle_scope(<span class="hljs-built_in">env</span>, &amp;scope);</li><li>    napi_create_object(<span class="hljs-built_in">env</span>, &amp;value1);</li><li>    napi_escape_handle(<span class="hljs-built_in">env</span>, scope, value1, &amp;value4);</li><li>    napi_close_escapable_handle_scope(<span class="hljs-built_in">env</span>, scope);</li><li>    napi_create_string_utf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"const char *str"</span>, NAPI_AUTO_LENGTH, &amp;value2);</li><li>    napi_create_string_utf8(<span class="hljs-built_in">env</span>, <span class="hljs-string">"const char *str"</span>, NAPI_AUTO_LENGTH, &amp;value3);</li><li>    napi_valuetype <span class="hljs-built_in">type</span> = napi_null;</li><li>    napi_typeof(<span class="hljs-built_in">env</span>, value4, &amp;<span class="hljs-built_in">type</span>);</li><li>    OH_LOG_INFO(LOG_APP, <span class="hljs-string">"xxx, %{public}d"</span>, <span class="hljs-built_in">type</span>);</li><li>
</li><li>
</li><li>    <span class="hljs-built_in">return</span> value1;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L58-L78" target="_blank">callbackTest.cpp</a></div></div></div></div> <p>以上代码，结果符合预期</p> <p><span><img originheight="56" originwidth="527" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.38235733191104420345480088838799:50001231000000:2800:3C6CB00DEF10CB63BE1D4872EF1E5D8E5F431FE9EA6EB266E587AA75AE29AF5C.png" width="527" height="56"></span></p> <p>2. 针对案例2，使用napi_ref保存强引用。</p> <div class="screenLinkPre"><div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L82-L95" data-highlighted="yes"><ol class="linenums"><li>napi_ref g_ref = nullptr;</li><li>static napi_value Test3(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info) {</li><li>    napi_value value;</li><li>    napi_create_object(<span class="hljs-built_in">env</span>, &amp;value);</li><li>    napi_create_reference(<span class="hljs-built_in">env</span>, value, 1, &amp;g_ref);</li><li>    <span class="hljs-built_in">return</span> nullptr;</li><li>}</li><li>
</li><li>static napi_value Test4(napi_env <span class="hljs-built_in">env</span>, napi_callback_info info) {</li><li>    napi_value result;</li><li>    napi_get_reference_value(<span class="hljs-built_in">env</span>, g_ref, &amp;result);</li><li>    napi_delete_reference(<span class="hljs-built_in">env</span>, g_ref);</li><li>    <span class="hljs-built_in">return</span> result;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ApiUsingStandards/entry/src/main/cpp/callbackTest.cpp#L82-L95" target="_blank">callbackTest.cpp</a></div></div></div></div> <p></p> <p>8、【use after free】开发者保存env指针，env释放后开发者继续使用，产生UAF导致崩溃</p> <p><strong>【问题描述】</strong></p> <p>开发者提前保存napi_env指针，js线程退出后地址被释放，再使用旧napi_env调用napi接口时崩溃。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退</p> <p><strong>【使用建议】</strong></p> <ul><li>减少保存env指针的行为，直接使用napi框架层透传的env更为安全。</li><li>若需保存env指针，可使用napi_add_env_cleanup_hook接口注册回调，在回调中处理env的退出。</li></ul> <p><strong>【典型案例】</strong></p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">2023</span>-<span class="hljs-number">07</span>-<span class="hljs-number">21</span> <span class="hljs-number">22</span>:<span class="hljs-number">42</span>:<span class="hljs-number">43.036</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">3952</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">20010086</span></li><li><span class="hljs-variable">Reason</span>:<span class="hljs-title class_">Signal</span>:<span class="hljs-title class_">SIGSEGV</span>(<span class="hljs-title class_">SEGV_MAPERR</span>)@<span class="hljs-number">0x0000000000000028</span> </li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">3997</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">PaEngineRunner1</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000022794</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">NativeEngineInterface</span>::<span class="hljs-title class_">ClearLastError</span>()+<span class="hljs-number">0</span>)(<span class="hljs-number">7</span><span class="hljs-variable">c5267e605f12e7abb774fca82e34826</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000001</span><span class="hljs-variable">c150</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">libace_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">napi_delete_reference</span>+<span class="hljs-number">44</span>)(<span class="hljs-number">7</span><span class="hljs-variable">c5267e605f12e7abb774fca82e34826</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002</span><span class="hljs-variable">cf74</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObject</span>::~<span class="hljs-title class_">NAPIRemoteObject</span>()+<span class="hljs-number">100</span>)(<span class="hljs-variable">e5ef129057d21508b210b1ea767c123e</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000002</span><span class="hljs-variable">d0e0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">virtual</span> <span class="hljs-variable">thunk</span> <span class="hljs-variable">to</span> <span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObject</span>::~<span class="hljs-title class_">NAPIRemoteObject</span>()+<span class="hljs-number">36</span>)(<span class="hljs-variable">e5ef129057d21508b210b1ea767c123e</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000208</span><span class="hljs-variable">b8</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libutils</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">RefBase</span>::<span class="hljs-title class_">DecStrongRef</span>(<span class="hljs-title class_">void</span> <span class="hljs-keyword">const</span>*)+<span class="hljs-number">184</span>)(<span class="hljs-number">764</span><span class="hljs-variable">d94f3f9f77923ad3529406319770b</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000003123</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObjectHolder</span>::~<span class="hljs-title class_">NAPIRemoteObjectHolder</span>()+<span class="hljs-number">92</span>)(<span class="hljs-variable">e5ef129057d21508b210b1ea767c123e</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000312</span><span class="hljs-variable">b4</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">chipset</span>-<span class="hljs-variable">pub</span>-<span class="hljs-variable">sdk</span>/<span class="hljs-variable">libipc_napi</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">OHOS</span>::<span class="hljs-title class_">NAPIRemoteObjectHolder</span>::~<span class="hljs-title class_">NAPIRemoteObjectHolder</span>()+<span class="hljs-number">16</span>)(<span class="hljs-variable">e5ef129057d21508b210b1ea767c123e</span>)</li><li>#<span class="hljs-number">07</span> <span class="hljs-variable">pc</span> <span class="hljs-number">0000000000026</span><span class="hljs-variable">b24</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libace_napi_ark</span>.<span class="hljs-variable">z</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">ArkNativeReference</span>::<span class="hljs-title class_">FinalizeCallback</span>()+<span class="hljs-number">36</span>)(<span class="hljs-number">6</span><span class="hljs-variable">b56b7e2cdfb750cbb348dbc6b3f65cd</span>)</li></ol></pre></div></div> <p>根据日志打印的env地址定位，发现env被释放后仍在使用。</p> <p><span><img originheight="303" originwidth="1622" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.35112134909829347664970538296150:50001231000000:2800:F14964A67B8B845647C00B9CB55B0D4979DE93378892BAA4F383658146941318.png" width="920" height="171.86189889025894"></span></p> <p>9、【use after free】开发者使用napi_get_reference_value时，napi_ref已被释放，导致UAF问题</p> <p><strong>【问题描述】</strong></p> <p>开发者在napi_ref已被释放的情况下使用napi_get_reference_value，导致UAF问题。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退</p> <p><strong>【使用建议】</strong></p> <p>若创建的napi_ref为强引用，开发者需要主动管理其生命周期，避免在调用napi_delete_reference后继续使用。</p> <p><strong>【典型案例】</strong></p> <p>napi_ref被释放后使用</p> <p><span><img height="202.29084028282597" originheight="407" originwidth="1851" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.96560678580277343297481423823850:50001231000000:2800:6CC8433E2B95CE5B24A31CE2E4E933BA227665E2BCF23BADAF5FE32498DB9801.png" title="点击放大" width="920"></span></p> <p>10、【buffer overflow】napi_get_value_string_utf8时，buffer长度不足导致越界问题</p> <p><strong>【问题描述】</strong></p> <p>开发者在napi同理，接口如napi_get_cb_info和napi_get_string_value_xxx有一个共同特点：需要开发者传入缓冲区及其对应的长度。如果开发者传入的缓冲区大小超过实际的缓冲区大小，就会发生越界问题。_ref已被释放的情况下使用napi_get_reference_value，导致UAF问题。同理，接口如napi_get_cb_info和napi_get_string_value_xxx有一个共同特点：需要开发者传入缓冲区及其对应的长度。如果开发者传入的缓冲区大小超过实际的缓冲区大小，就会发生越界问题。</p> <p><strong>【使用错误影响】</strong></p> <p>应用闪退</p> <p><strong>【使用建议】</strong></p> <p>1. 开发者需确保buffer容量充足，防止越界。</p> <p>2. 对于napi_get_value_string_xxx系列接口，可以传入NAPI_AUTO_LENGTH作为buffer长度，接口会自动计算buffer长度。</p> <p><strong>【典型案例】</strong></p> <p>argc的值超过argv数组的实际长度，导致数组越界。</p> <div _ngcontent-vim-c106="" class="highlight-div"><div _ngcontent-vim-c106="" class="highlight-div-header"><div _ngcontent-vim-c106="" class="highlight-div-header-left"><div _ngcontent-vim-c106="" class="handle-button expand-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vim-c106="" class="highlight-div-header-right"><div _ngcontent-vim-c106="" class="handle-button ai-button"></div><div _ngcontent-vim-c106="" class="handle-button line-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vim-c106="" class="handle-button theme-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vim-c106="" class="handle-button copy-button"><div _ngcontent-vim-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vim-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Test5</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc; <span class="hljs-comment">// 未初始化，argc可能是个随机的、很大的值</span></li><li>    napi_value argv[<span class="hljs-number">3</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, argv, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> argv[<span class="hljs-number">0</span>];</li><li>}</li></ol></pre></div></div> <p><span><img originheight="232" originwidth="1638" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163500.78384480267639343418271330654943:50001231000000:2800:E8D894A622CB114FFB37708C1BD53AA696DCDADF6DF53F94870B262F4191E633.png" width="920" height="130.3052503052503"></span></p> </div> <div class="tiledSection"><h2 id="section1078520389541">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1078520389541" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/ApiUsingStandards" target="_blank">易错API的使用规范</a></li></ul> </div> </div> <div></div></div>