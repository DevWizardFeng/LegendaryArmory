<h1 _ngcontent-knc-c119="" class="doc-title ng-star-inserted" title="横竖屏切换"> 横竖屏切换 </h1>

<div _ngcontent-knc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section98841331161710">概述<i class="anchor-icon anchor-icon-link" anchorid="section98841331161710" tips="复制节点链接"></i></h2><p>横竖屏切换功能实现应用内既支持竖屏显示也支持横屏显示的效果。在应用中，如果不同页面需要显示不同的方向，需要在应用逻辑中，动态修改窗口方向，来实现该效果，例如包含视频播放功能的应用，首页内容是使用竖屏方式，而视频详情页则采用横屏方式展示。</p> <p>本文主要介绍横竖屏功能的开发过程中需要关注的内容，包括如下部分：</p> <ul><li>窗口旋转策略的选择</li><li>常用应用类型的横竖屏开发</li><li>常见的横竖屏开发问题</li></ul> </div> <div class="tiledSection"><h2 id="section388473115175">窗口旋转说明<i class="anchor-icon anchor-icon-link" anchorid="section388473115175" tips="复制节点链接"></i></h2><p>目前HarmonyOS系统中的窗口旋转形态有以下四种，窗口的状态对应真机实际状态如下：</p> <div class="fignone"><span class="figcap"><b>图1 </b>窗口形态示意图</span></div> <p><span><img height="267.78087" originheight="570" originwidth="1316" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163016.37417022463855861579830788519151:50001231000000:2800:573A4A3498E966A4115D27D9A1EC594EAA6F56788CEE1BA86DFA1D6317D303B4.png" title="点击放大" width="598.5"></span></p> <p>设置窗口旋转策略的方式有以下两种：</p> <ul><li><strong>通过module.json5文件中“orientation”字段进行设置</strong>。</li><li><strong>在代码中通过调用窗口window的setPreferredOrientation方法进行设置。</strong></li></ul> <p>这两种方式触发设置旋转的时机不同，总的来说，module.json5文件中的字段在窗口启动时就会生效，对于启动时就需要设置横屏或者竖屏的应用，需要进行配置。而<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation</a>是在调用该方法时进行窗口方向的设置，用于在应用启动之后，还需要改变显示方向的场景。</p> </div> <div class="tiledSection"><h3 id="section1188593118171" class="firsth2">配置module.json5的orientation字段<i class="anchor-icon anchor-icon-link" anchorid="section1188593118171" tips="复制节点链接"></i></h3><p>此字段用于配置应用启动时的窗口显示状态。如果应用启动时需要以默认的横屏或竖屏方式显示，需要在此字段进行相应的配置。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/module.json5#L2-L60" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"abilities"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-string">"orientation"</span>: <span class="hljs-string">"portrait"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/module.json5#L2-L60" target="_blank">module.json5</a></div></div></div></div> <p>其支持的参数可以参考module.json5配置项中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file#abilities标签" target="_blank">orientation字段相关配置</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-e#orientation9" target="_blank">orientation字段</a>说明：</p> <p>根据应用的默认旋转行为进行配置：</p> <ul><li>如果应用是竖屏应用，建议配置portrait为默认旋转策略。</li><li>如果应用是横屏应用，例如，对于游戏类应用，启动时默认为横屏，存在以下两种情况：<p>一、仅支持横屏，建议配置landscape为默认旋转策略。</p> <p>二、支持在横屏和反向横屏中切换，建议设置为auto_rotation_landscape。</p> </li><li>如果应用为可旋转应用，建议应用配置auto_rotation_restricted为默认旋转策略。</li><li>如果一个应用，在直板机和折叠机折叠态是竖屏应用，在平板和折叠机展开态默认是可旋转应用，推荐配置follow_desktop为默认旋转策略。</li></ul> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>对于需要通过控制中心进行旋转锁定控制的情况，可以选择字段后方带有restricted字段的旋转策略。</p> <p>此字段表示旋转行为受到控制中心按钮控制：开关打开情况下，不随设备方向旋转，关闭情况下，则会发生跟随设备旋转。</p> </div></div></div> <p>以如下文件管理应用为例，在系统关闭了旋转锁定后，应用的页面都会随着手机旋转而发生展示上的切换，而打开时则不会发生旋转行为，此时就需要配置为auto_rotation_restricted。</p> <div class="fignone"><span class="figcap"><b>图2 </b>应用随系统旋转切换横竖屏</span><br><span><img height="294.2625" originheight="2160" originwidth="3840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.71341553483800659723726515610455:50001231000000:2800:1192FBCEFE925BA8AF4A1FC2FCA000E2A6415CBADD1730F54E2F7A22FCAD5FEE.jpg" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h3 id="section188583141719">调用窗口的setPreferredOrientation方法<i class="anchor-icon anchor-icon-link" anchorid="section188583141719" tips="复制节点链接"></i></h3><div class="p">对于需要进入应用后，修改应用窗口显示横竖屏状态的情况下，可以调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation</a>方法进行设置，典型场景如一些视频类应用、图片类应用等。<div class="fignone"><span class="figcap"><b>图3 </b>视频播窗横竖屏切换</span><br><span><img height="330.2656" originheight="543" originwidth="878" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.86027203239214786140967585491452:50001231000000:2800:73402127C73CE9DFE308ACD3DC52C051EA285D04B9AFC87E58327E9017062A76.png" title="点击放大" width="532"></span></div> </div> <p>此类应用在启动时默认为竖屏，而在视频播放页面可以显示为横屏，开发者需确保应用支持用户临时修改窗口方向。由于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation</a>方法调用的是窗口的显示方向，是整个应用窗口级别都发生了旋转，窗口将一直保持最后一次设置窗口方向的效果，即使发生页面跳转等行为窗口方向也不会发生变化。</p> </div> <div class="tiledSection"><h2 id="section208869314175">视频类应用横竖屏开发<i class="anchor-icon anchor-icon-link" anchorid="section208869314175" tips="复制节点链接"></i></h2><p>为了实现应用的横竖屏功能，需要从以下技术方面进行考虑：</p> <ol><li>设置窗口的旋转策略。</li><li>监听屏幕的窗口变化。</li><li>进行布局适配。</li></ol> </div> <div class="tiledSection"><h3 id="section58861731201715" class="firsth2">设置窗口的旋转策略<i class="anchor-icon anchor-icon-link" anchorid="section58861731201715" tips="复制节点链接"></i></h3><p>首先需要对应用启动时的旋转策略进行设置，具体可以参考<a href="/consumer/cn/doc/best-practices/bpta-landscape-and-portrait-development#section1188593118171">配置module.json5的Orientation字段</a>，这里以实现了一多开发为例，满足直板机和平板设备不同的策略，设置为follow_desktop，这个字段主要解决在不同设备上默认旋转策略不同的问题。</p> <p>在具体需要实现横竖屏切换的页面上，例如视频播放页面支持横屏，但是首页的内容是支持仅竖屏的，那么就需要在进入对应的页面时，采用window窗口提供的设置窗口方向的能力，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation</a>将窗口显示的方向修改为横屏、竖屏的状态。在使用时，需根据应用自身的旋转策略选择相应的参数，可以封装如下方法，进行旋转策略的设置。</p> <p>具体如下：通过this.getUIContext()?.getHostContext()拿到对应的UIAbilityContext，并通过context拿到对应的windowStage实例，然后通过windowStage.getMainWindowSync同步方法拿到对应的窗口实例win，然后调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation</a>方法设置窗口方向。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L18-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span>, settings } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">Logger</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/Logger'</span></li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span></li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'VideoPlayViewLogTag'</span>;</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">VideoPlayView</span> {</li><li>  <span class="hljs-keyword">private</span> context = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> windowClass = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>).<span class="hljs-property">windowStage</span>.<span class="hljs-title function_">getMainWindowSync</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">setOrientation</span>(<span class="hljs-params">orientation: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowClass</span>.<span class="hljs-title function_">setPreferredOrientation</span>(orientation).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setWindowOrientation: '</span> + orientation + <span class="hljs-string">' Succeeded.'</span>)</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'setWindowOrientation: '</span> + orientation + <span class="hljs-string">' Failed. Cause: '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err))</li><li>    })</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L18-L142" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>以视频播放为例，不仅可以通过系统控制横竖屏，也支持用户在系统锁定旋转的情况下，手动设置横屏状态，即需要满足以下条件：</p> <ol><li><strong>应用跟随传感器旋转。</strong></li><li><strong>受到控制中心的旋转锁定按钮控制。</strong></li><li><strong>支持用户在应用页面中临时调用设置方向的能力，例如点击全屏按钮进行切换。</strong></li></ol> <p>要实现以上效果，可以使用窗口的能力设置orientation的枚举类型进行相应的旋转，为了提供临时设置方向的能力，当用户手动点击全屏按钮时，需要手动触发横竖屏切换。如果此时关闭了旋转锁定，窗口需要能够跟随传感器旋转。因此，可以使用以下枚举中的能力，临时调用旋转，并让其后续支持跟随传感器。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>orientation部分参数列举</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.6.9.2.4.1.1" valign="top" width="30.093009300930092%"><p>orientation枚举值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.9.2.4.1.2" valign="top" width="6.840684068406841%"><p>枚举数值</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.6.9.2.4.1.3" valign="top" width="63.06630663066307%"><p>效果描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="30.093009300930092%"><p>USER_ROTATION_PORTRAIT</p> </td> <td class="cellrowborder" valign="top" width="6.840684068406841%"><p>13</p> </td> <td class="cellrowborder" valign="top" width="63.06630663066307%"><p>调用时临时旋转到竖屏，之后跟随传感器自动旋转，受控制中心的旋转开关控制，且可旋转方向受系统判定。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="30.093009300930092%"><p>USER_ROTATION_LANDSCAPE</p> </td> <td class="cellrowborder" valign="top" width="6.840684068406841%"><p>14</p> </td> <td class="cellrowborder" valign="top" width="63.06630663066307%"><p>调用时临时旋转到横屏，之后跟随传感器自动旋转，受控制中心的旋转开关控制，且可旋转方向受系统判定。</p> </td> </tr>  </tbody></table></div> </div> <p>分析旋转方向：一般情况下，视频播放应用的旋转方向不会旋转到反向竖屏（由UX需求决定），仅支持旋转到竖屏、横屏和反向横屏。点击切换按钮时，默认旋转到横屏状态，并支持跟随传感器旋转到反向横屏。</p> <div class="fignone"><span class="figcap"><b>图4 </b>窗口旋转状态示意图</span></div> <p><span><img height="329.80542" originheight="685" originwidth="1506" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.25899817979989489683925041588082:50001231000000:2800:7F952D28BAB153FF2D9BC8AFF29E6695BB0E4FF32D34842229E4D8A608D8F2AD.png" title="点击放大" width="699.2475000000001"></span></p> <p>在需要用户点击的地方，需要根据进入全屏和退出全屏分别执行相应的逻辑，需要使用的方向状态如下：</p> <p>设置为横屏时，对应窗口方向为横屏状态：this.setOrientation(window.Orientation.USER_ROTATION_LANDSCAPE)，例如进入播放页时，进行竖屏 -&gt; 横屏切换;</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L242-L261" data-highlighted="yes"><ol class="linenums"><li>Image($r(<span class="hljs-string">'app.media.icon_zoom_in'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .onClick(() =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isExpandedOrHalfFolded()) {</li><li>      <span class="hljs-keyword">this</span>.isLandscape = <span class="hljs-literal">true</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.setOrientation(window.Orientation.USER_ROTATION_LANDSCAPE)</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L242-L261" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>设置为竖屏时，对应窗口方向为竖屏状态：this.setOrientation(window.Orientation.USER_ROTATION_PORTRAIT)，例如在返回竖屏状态时，进行横屏 -&gt; 竖屏切换;</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L185-L204" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.icon_back'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setOrientation</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>.<span class="hljs-property">USER_ROTATION_PORTRAIT</span>)</li><li>      <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L185-L204" target="_blank">VideoPlayView.ets</a></div></div></div></div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>需要注意，调用setPreferredOrientation方法会改变窗口的显示方向。因此，如果在进入视频播放页时手动调用了旋转到横屏的方法，那么在退出页面时也必须手动调用该方法，以恢复窗口到竖屏状态。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section128891531121712">监听窗口变化<i class="anchor-icon anchor-icon-link" anchorid="section128891531121712" tips="复制节点链接"></i></h3></div> <p>当传感器变化或用户手动设置窗口方向时，窗口显示和尺寸会发生变化。此时，可以通过获取窗口的宽高并进行对比，判断当前是竖屏还是横屏状态，然后利用这些数据对布局进行适配。</p> <p>监听窗口尺寸的变化可以通过window.<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onwindowsizechange7" target="_blank">on('windowSizeChange')</a>进行实现。具体的措施如下，在需要进行横竖屏切换的页面进行以下窗口的监听，一般建议是在aboutToAppear中执行：</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L42-L117" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowClass</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">size</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    })</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`aboutToAppear err, error code: <span class="hljs-subst">${error.code}</span>, error message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L42-L117" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>并在aboutToDisappear中取消监听：</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L146-L153" data-highlighted="yes"><ol class="linenums"><li>aboutToDisappear(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.windowClass.off(<span class="hljs-string">'windowSizeChange'</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L146-L153" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>需要注意的是，当用户手动触发setOrientation设置为横屏状态时，即使当前手机处于垂直方向，窗口的状态也是横屏方向，即如下所示：</p> <div class="fignone"><span class="figcap"><b>图5 </b>临时设置窗口方向时，窗口宽高示意图</span></div> <p><span><img height="428.22382400000004" originheight="687" originwidth="1380" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.91453424759341538048965833142211:50001231000000:2800:262486191536E4C1EF88A6DC23C421C9B6F29A6B6302D319272A0AD23F7ED4C4.png" title="点击放大" width="850.8675000000001"></span></p> <p>此时，窗口的宽是竖屏状态下的高，高变为竖屏状态的宽。所以在监听窗口变化时，可以通过窗口的宽高大小关系来确定当前窗口的方向，并决定实际的横竖屏状态。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L50-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">windowClass</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">size</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> viewWidth = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(size.<span class="hljs-property">width</span>)</li><li>  <span class="hljs-keyword">let</span> viewHeight = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(size.<span class="hljs-property">height</span>)</li><li>  <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (viewWidth &gt; viewHeight) {</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L50-L97" target="_blank">VideoPlayView.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section148891431101714">进行布局适配<i class="anchor-icon anchor-icon-link" anchorid="section148891431101714" tips="复制节点链接"></i></h3><p>对于视频播放类应用，仅播放窗口需支持横竖屏切换，因此只需对视频播放组件进行横屏并全屏处理。所以可以利用UI状态更新的特点，来让播窗变为全屏，将播窗的尺寸定义为@State状态，并设置到Xcomponent组件上。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L28-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@State</span> <span class="hljs-attribute">xComponentWidth</span>: number = this.<span class="hljs-built_in">getUIContext</span>().<span class="hljs-built_in">px2vp</span>(display.<span class="hljs-built_in">getDefaultDisplaySync</span>().<span class="hljs-attribute">width</span>);</li><li><span class="hljs-variable">@State</span> <span class="hljs-attribute">xComponentHeight</span>: number = this.<span class="hljs-built_in">getUIContext</span>().<span class="hljs-built_in">px2vp</span>(display.<span class="hljs-built_in">getDefaultDisplaySync</span>().<span class="hljs-attribute">width</span> * this.aspect);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L28-L29" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>将状态变量与播窗绑定。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L160-L178" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">XComponent</span>({ <span class="hljs-variable">id</span>: <span class="hljs-string">'video_player_id'</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>, <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">xComponentController</span> })</li><li>  .<span class="hljs-title function_">onLoad</span>(() =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">xComponentWidth</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">xComponentHeight</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L160-L178" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>并且在之前监听窗口变化的回调中，对XComponentWidth和XComponentHeight进行动态修改，完成窗口变化时横屏和竖屏的视频窗口布局。需要注意的是，在横屏时，视频播放的宽高应该和窗口的宽高一样，并且需要进入全屏状态。而竖屏时，视频播放的宽应该等于窗口的宽，但是高度应该是按照播窗比例乘以窗口的宽进行设置，并退出全屏状态。</p> <div class="fignone"><span class="figcap"><b>图6 </b>旋转过程宽高变化示意图</span></div> <p><span><img height="348.096511" originheight="621" originwidth="1489" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.28358259262972769957363634954975:50001231000000:2800:A042AE133184EE7B85D901A3C4E4FD6A2C807235794AAA8A206FBCA04383118C.png" title="点击放大" width="809.4024890000001"></span></p> <p>具体实现如下，进入视频详情页面内需要监听窗口尺寸的变化，并根据当前状态，实现对横竖屏状态的监听。根据状态变化修改对应XComponent的宽高，实现全屏或者隐藏状态栏和导航条的逻辑。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>需要注意的是，对于视频全屏效果，建议采用沉浸式开发。沉浸式效果的实现，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-develop-apply-immersive-effects" target="_blank">开发应用沉浸式效果</a>。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L51-L98" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.windowClass.on(<span class="hljs-string">'windowSizeChange'</span>, (size) =&gt; {</li><li>  let viewWidth = <span class="hljs-keyword">this</span>.getUIContext().px2vp(size.width)</li><li>  let viewHeight = <span class="hljs-keyword">this</span>.getUIContext().px2vp(size.height)</li><li>  <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (viewWidth &gt; viewHeight) {</li><li>      <span class="hljs-keyword">if</span> (display.getFoldStatus() === display.FoldStatus.FOLD_STATUS_EXPANDED ||</li><li>        display.getFoldStatus() === display.FoldStatus.FOLD_STATUS_HALF_FOLDED) {</li><li>        <span class="hljs-keyword">this</span>.xComponentHeight = viewWidth * <span class="hljs-keyword">this</span>.aspect</li><li>        <span class="hljs-keyword">this</span>.xComponentWidth = viewWidth</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.xComponentWidth = viewHeight / <span class="hljs-keyword">this</span>.aspect</li><li>        <span class="hljs-keyword">this</span>.xComponentHeight = viewHeight</li><li>        <span class="hljs-keyword">this</span>.isLandscape = <span class="hljs-literal">true</span></li><li>      }</li><li>      <span class="hljs-keyword">this</span>.windowClass.setSpecificSystemBarEnabled(<span class="hljs-string">'navigationIndicator'</span>, <span class="hljs-literal">false</span>).<span class="hljs-keyword">catch</span>((error: BusinessError) =&gt; {</li><li>        Logger.error(TAG,</li><li>          `setSpecificSystemBarEnabled err, error code: ${error.code}, error message: ${error.message}`);</li><li>      })</li><li>      <span class="hljs-comment">// hide bottom navigation bar</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.xComponentHeight = viewWidth * <span class="hljs-keyword">this</span>.aspect</li><li>      <span class="hljs-keyword">this</span>.xComponentWidth = viewWidth</li><li>      <span class="hljs-keyword">this</span>.windowClass.setSpecificSystemBarEnabled(<span class="hljs-string">'navigationIndicator'</span>, <span class="hljs-literal">true</span>).<span class="hljs-keyword">catch</span>((error: BusinessError) =&gt; {</li><li>        Logger.error(TAG, `setSpecificSystemBarEnabled err, error code: ${error.code}, error message: ${error.message}`);</li><li>      })</li><li>      <span class="hljs-comment">// show bottom navigation bar</span></li><li>      <span class="hljs-keyword">this</span>.isLandscape = <span class="hljs-literal">false</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L51-L98" target="_blank">VideoPlayView.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>上述代码完成的是直板机上的旋转逻辑，在进入页面时进行窗口变化的监听，需要在退出页面时关闭监听功能。另外，对于在平板下，如果旋转行为仅触发页面旋转，不触发视频播窗的全屏，需要进行特殊处理。</p> </div></div></div> <p>所以这里还需要对旋转行为进行一个限制，只有在直板机设备上才能让发生旋转时，将播窗全屏，对应平板上，在某些特定情况下，不需要视频播窗全屏，而是直接将布局进行旋转。</p> <ul><li>可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-device-info" target="_blank">deviceInfo</a>设备类型进行判断。</li><li>采用响应式布局中<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-responsive-layout#section1532120147301" target="_blank">断点</a>的方式进行判断。</li></ul> </div> <div class="tiledSection"><h3 id="section102502044185919">锁定屏幕功能<i class="anchor-icon anchor-icon-link" anchorid="section102502044185919" tips="复制节点链接"></i></h3><p>某些视频应用支持屏幕锁定功能，在全屏状态下，实现对功能按钮的隐藏，并临时锁定屏幕的旋转，避免用户误触其他操作按钮。屏幕锁定后，应用可以在横屏和反向横屏之间翻转，不可由横屏旋转为竖屏，解锁后，如果当前屏幕处于竖屏，则应该恢复到竖屏显示。</p> <div class="fignone"><span class="figcap"><b>图7 </b>屏幕锁定功能</span></div> <p><span><img height="187.62270100000003" originheight="288" originwidth="1310" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.36918113223242890181473448412574:50001231000000:2800:1AD1C9B7369C8619EDA9DC6EBDB5821C155E0128F3B1516952DDBC42A773A367.png" title="点击放大" width="820.9425"></span></p> <p>实现上述功能可以考虑以下实现：</p> <ol><li>判断当前控制中心的开关状态，如果是已经锁定情况下，则不需要进行额外处理</li><li>锁定时设置旋转策略为AUTO_ROTATION_LANDSCAPE，即支持横屏和反向横屏旋转，不受控制中心控制</li><li>解锁时需要回到支持三向旋转，即支持横屏、竖屏、反向横屏，并受到控制中心控制</li></ol> <p>可以由上述推断功能实现得到如下代码：</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L210-L236" data-highlighted="yes"><ol class="linenums"><li>Image(<span class="hljs-keyword">this</span>.isVideoLock ? $r(<span class="hljs-string">'app.media.icon_lock'</span>) : $r(<span class="hljs-string">'app.media.icon_lock_open'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .onClick(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.isVideoLock = !<span class="hljs-keyword">this</span>.isVideoLock</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isVideoLock) {</li><li>      <span class="hljs-keyword">this</span>.setOrientation(window.Orientation.AUTO_ROTATION_LANDSCAPE)</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.setOrientation(window.Orientation.AUTO_ROTATION_UNSPECIFIED)</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L210-L236" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>对于需要在折叠屏状态下对旋转逻辑进行单独处理的情况，可以封装如下方法isExpandedOrHalfFolded()，来判断当前设备是否为折叠屏展开态，处于折叠屏展开态情况下，不会触发旋转逻辑。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L121-L131" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">isExpandedOrHalfFolded</span>(): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isExpandedOrHalfFolded</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    isExpandedOrHalfFolded = display.<span class="hljs-title function_">getFoldStatus</span>() === display.<span class="hljs-property">FoldStatus</span>.<span class="hljs-property">FOLD_STATUS_EXPANDED</span> ||</li><li>      display.<span class="hljs-title function_">getFoldStatus</span>() === display.<span class="hljs-property">FoldStatus</span>.<span class="hljs-property">FOLD_STATUS_HALF_FOLDED</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`isExpandedOrHalfFolded err, error code: <span class="hljs-subst">${error.code}</span>, error message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> isExpandedOrHalfFolded;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L121-L131" target="_blank">VideoPlayView.ets</a></div></div></div></div> </div> <p>当要对设备控制中心状态进行监听时，可以通过setting.registerKeyObserver监听控制中心变化，其中orientationLockState是当前设备控制中心的状态。当设备控制中心的状态为“0”时，即代表旋转功能被系统锁定，此时在处理锁定功能代码中不需要进行旋转逻辑的处理，因为在控制中心旋转开关关闭的情况下，屏幕的旋转行为会受到限制，所以首先要考虑对控制中心的旋转锁定状态进行判断，可以参考如下代码实现对设备控制中心的状态监听：</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L104-L109" data-highlighted="yes"><ol class="linenums"><li>settings.registerKeyObserver(<span class="hljs-keyword">this</span>.context, settings.general.ACCELEROMETER_ROTATION_STATUS,</li><li>  settings.domainName.DEVICE_SHARED, () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.orientationLockState =</li><li>      settings.getValueSync(<span class="hljs-keyword">this</span>.context, settings.general.ACCELEROMETER_ROTATION_STATUS,</li><li>        settings.domainName.DEVICE_SHARED)</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L104-L109" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p>当控制中心旋转开关未关闭时，可通过应用内锁定按钮进行逻辑判断。锁定状态下，调用setOrientation设置为Landscape，此时可以在横屏和反向横屏旋转；解锁后，恢复到三向（横屏、竖屏、反向横屏）旋转策略：</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L230-L234" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isVideoLock) {</li><li>  <span class="hljs-keyword">this</span>.setOrientation(window.Orientation.AUTO_ROTATION_LANDSCAPE)</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-keyword">this</span>.setOrientation(window.Orientation.AUTO_ROTATION_UNSPECIFIED)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L230-L234" target="_blank">VideoPlayView.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section5891203181716">游戏类应用横屏开发<i class="anchor-icon anchor-icon-link" anchorid="section5891203181716" tips="复制节点链接"></i></h2><p>对于游戏类应用，以横屏游戏居多，此类应用不需要在应用内进行开关控制，所以只需要在module.json5配置文件中进行相应的配置即可。一般有以下几种情况：</p> </div> <div class="tiledSection"><h3 id="section13891143161716" class="firsth2">默认仅为横屏<i class="anchor-icon anchor-icon-link" anchorid="section13891143161716" tips="复制节点链接"></i></h3><p>如果该应用默认为横屏状态，则需在module.json5中的“orientation”字段配置为landscape。</p> <div class="fignone"><span class="figcap"><b>图8 </b>应用仅支持横屏状态</span><br><span><img height="199.69152000000003" originheight="271" originwidth="555" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.58493512751470907521560295276723:50001231000000:2800:1BD793453D654AB81EF87FC0D5836E75C574EE26AAE2949760425A2975B93213.png" title="点击放大" width="408.975"></span></div> </div> <div class="tiledSection"><h3 id="section589111318178">支持横屏和反向横屏<i class="anchor-icon anchor-icon-link" anchorid="section589111318178" tips="复制节点链接"></i></h3><p>如果应用需要根据设备方向决定是横屏还是反向横屏，则可以在module.json5配置中将“orientation”设置为auto_rotation_landscape。</p> <div class="fignone"><span class="figcap"><b>图9 </b>应用支持横屏和反向横屏</span><p><span><img height="185.12097100000003" originheight="282" originwidth="1317" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163017.36035801034595402318751615118766:50001231000000:2800:31440EB99BDCCDB0E9007854A01D072E4884A014393859EA757F7D64A4C6773F.png" title="点击放大" width="809.97"></span></p> </div> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>如果需要跟随控制中心的旋转锁定，则可以选择配置为"auto_rotation_landscape_restricted"。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section1337894813426">支持竖屏切换横屏<i class="anchor-icon anchor-icon-link" anchorid="section1337894813426" tips="复制节点链接"></i></h3><p>此类适用于一些游戏大厅等应用，由于游戏大厅内，主页可能为竖屏，部分应用为横屏。从竖屏进入横屏时，需要调用设置窗口旋转的方法进行控制。具体案例可以参考视频播放的横竖屏切换。</p> </div> <div class="tiledSection"><h2 id="section1189243111172">性能优化<i class="anchor-icon anchor-icon-link" anchorid="section1189243111172" tips="复制节点链接"></i></h2><p>在窗口旋转时，屏幕尺寸变化会导致界面重新布局。为提高横竖屏切换的流畅度，需进行性能优化。</p> <p><strong>使用自定义组件冻结</strong></p> <p>旋转时，由于整窗一起旋转，会导致页面重新布局，但是实际上需要展示的可能只有播放内容，对于其他的组件可以使用自定义组件冻结功能，避免由于旋转导致的UI更新操作。例如视频播放底下的详情内容，可能是单独的组件。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L276-L289" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Component</span>({ freezeWhenInactive: true })</li><li>  <span class="hljs-comment">// Added custom component freezing function</span></li><li>struct VideoDetailView {</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    Scroll() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L276-L289" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p><strong>对图片使用autoResize</strong></p> <p>如果当前旋转页面存在一些图片，未经合理的裁剪，图片过大，可以对图片设置autoResize属性，使图片裁剪到合适的大小进行绘制。该属性的作用是将组件显示区域作为绘制的图源尺寸，可以减少内存占用，例如原图是1920*1080，但是显示区域是200*100，则在解码时会降低采样编码到200*100尺寸。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L293-L305" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Builder</span></li><li>function ImageItem(<span class="hljs-attribute">imageSrc</span>: ResourceStr) {</li><li>  <span class="hljs-built_in">Stack</span>({}) {</li><li>    <span class="hljs-built_in">Image</span>(imageSrc)</li><li>      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.autoResize</span>(true)<span class="hljs-comment">// Use auto_resize attributes on images</span></li><li>      <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">8</span>)</li><li>      <span class="hljs-selector-class">.objectFit</span>(ImageFit.Fill)</li><li>      <span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">1</span>AFFFFFF')</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L293-L305" target="_blank">VideoPlayView.ets</a></div></div></div></div> <p><strong>排查一些耗时操作</strong></p> <p></p> <p>排查当前页面是否存在冗余的OnAreaChange事件、blur模糊或linearGradient属性，这些属性较为耗时，应根据是否必须使用来决定是否进行优化。</p> </div> <div class="tiledSection"><h2 id="section28921531171715">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section28921531171715" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2892203111714" class="firsth2"><strong>Tabs栏中的视频横屏播放，无法隐藏Tabs栏</strong><i class="anchor-icon anchor-icon-link" anchorid="section2892203111714" tips="复制节点链接"></i></h3><p>对于首页中有部分视频可以直接播放，并且不会跳转至详情页播放的，需要支持直接在首页发生旋转，当前可以通过设置XComponent的宽高实现，但是会发现即使全屏后，Tabs栏并不会消失。而是会一起发生旋转并存在于页面上。解决方案如下：</p> <p>进入全屏时，隐藏Tabs，退出全屏时，展示Tabs栏。</p> <div class="screenLinkPre"><div _ngcontent-knc-c106="" class="highlight-div"><div _ngcontent-knc-c106="" class="highlight-div-header"><div _ngcontent-knc-c106="" class="highlight-div-header-left"><div _ngcontent-knc-c106="" class="handle-button expand-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-knc-c106="" class="highlight-div-header-right"><div _ngcontent-knc-c106="" class="handle-button ai-button"></div><div _ngcontent-knc-c106="" class="handle-button line-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-knc-c106="" class="handle-button theme-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-knc-c106="" class="handle-button copy-button"><div _ngcontent-knc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-knc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L309-L328" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>struct TabsView {</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">isLayoutFullScreen</span>: boolean = false</li><li>
</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-selector-tag">Tabs</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// Hide the height of the Tabs tab bar by whether the user needs to click to enter the full screen and hide it</span></li><li>    .<span class="hljs-built_in">barHeight</span>(this.isLayoutFullScreen ? <span class="hljs-number">0</span> : <span class="hljs-number">50</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle/blob/master/entry/src/main/ets/views/VideoPlayView.ets#L309-L328" target="_blank">VideoPlayView.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section19892531181713"><strong>如何解决直板机和平板上默认旋转行为不一致的问题?</strong><i class="anchor-icon anchor-icon-link" anchorid="section19892531181713" tips="复制节点链接"></i></h3><p>对于部分应用，在直板手机上默认是采用竖屏显示的策略，但是在平板或者折叠屏上，是需要支持自动旋转的，如果在Ability的生命周期中调用setPreferredOrientation，可能会出现在应用启动时，出现旋转动画的情况，所以可以将module.json5文件中的“orientation”字段设置为“follow_desktop”。</p> </div> <div class="tiledSection"><h3 id="section289353110179"><strong>通过调用window.getLastWindow的方式获取窗口实例出现延迟，如何解决？</strong><i class="anchor-icon anchor-icon-link" anchorid="section289353110179" tips="复制节点链接"></i></h3><p>由于getLastWindow底层原因，需要经过查找获取实例，一定程度上会有性能损耗，可能会出现已经发生横屏或者竖屏切换，状态栏还没切换的情况。对此类场景的同步要求较高情况下，可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-windowstage#getmainwindowsync9" target="_blank">windowStage.getMainWindowSync</a>的同步方式获取窗口实例。</p> </div> <div class="tiledSection"><h3 id="section124381124919"><strong>自动旋转和旋转锁定按钮的关系是什么？与Orientation字段的关系如何判断？</strong><i class="anchor-icon anchor-icon-link" anchorid="section124381124919" tips="复制节点链接"></i></h3><p>控制中心的旋转开关控制当前是否可以跟随屏幕旋转。当“旋转锁定”高亮时，表示锁定且不可旋转；当“旋转锁定”灰色时，表示解锁且可以旋转。</p> <p>例如想实现跟随控制中心的自动旋转，如果想旋转到横屏，竖屏，反向横屏，反向竖屏。则可以设置为AUTO_ROTATION_RESTRICTED。</p> <p>如果不想跟随控制中心的控制开关，那么只需要设置为AUTO_ROTATION，此时应用的旋转不受到控制中心的锁定控制。其他的旋转方式同理。</p> </div> <div class="tiledSection"><h2 id="section84566263207">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section84566263207" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/LandscapePortraitToggle" target="_blank">视频横竖屏开发</a></li></ul> </div> </div> <div></div></div>