<h1 _ngcontent-kmc-c119="" class="doc-title ng-star-inserted" title="水印添加"> 水印添加 </h1>

<div _ngcontent-kmc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section580010194206">概述<i class="anchor-icon anchor-icon-link" anchorid="section580010194206" tips="复制节点链接"></i></h2><p>在软件开发中，水印是一种在应用页面、图片或文档中嵌入的标记，它通常采用文字或图案的形式展现。水印通常有以下用途：</p> <ul><li>标识来源：可用于标识应用、各种文件的来源或作者，确保产权的归属。</li><li>版权保护：可携带版权保护信息，有效防止他人篡改、盗用、非法复制。</li><li>艺术效果：可作为一种艺术效果，为图片或应用增添独特的风格。</li></ul> <p>本文通过图文与代码结合的方式，对以下几种常见的水印添加场景进行讲解，旨在让开发者理解水印添加的基本原理以及掌握开发的流程与细节。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-add-watermark#section12388834480">页面上添加水印</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-add-watermark#section987311343125">图片上添加水印</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-add-watermark#section7418171112138">PDF文档添加水印</a></li></ul> </div> <div class="tiledSection"><h2 id="section12388834480">页面上添加水印<i class="anchor-icon anchor-icon-link" anchorid="section12388834480" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section34172451485" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section34172451485" tips="复制节点链接"></i></h3><p>某个页面背景上添加水印文字，实现效果图如下。</p> <p><span><img height="549.2235000000001" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163051.79346498347371514014631222455493:50001231000000:2800:00008927E2B90712E0D696C64ADB29531384869064B1DEBDFC7361985C0A48D9.png" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section724392794913">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section724392794913" tips="复制节点链接"></i></h3><p><strong>关键技术</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>提供画布组件，用于自定义绘制图形。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-canvasrenderingcontext2d" target="_blank">CanvasRenderingContext2D</a>对象在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>组件上进行绘制，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-canvasrenderingcontext2d#filltext" target="_blank">fillText()</a>方法用于绘制文本，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-canvasrenderingcontext2d#drawimage" target="_blank">drawImage()</a>方法用于图像绘制。</p> <p><strong>开发流程</strong></p> <ol><li>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>画布，在画布上绘制水印。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-stack" target="_blank">Stack</a>组件或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-overlay#overlay" target="_blank">浮层overlay</a>属性，将画布与UI页面组件融合显示。</li></ol> </div> <div class="tiledSection"><h3 id="section142235817498">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section142235817498" tips="复制节点链接"></i></h3><ol><li>封装水印组件<ol><li>创建Canvas组件，监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas#事件" target="_blank">Canvas.onReady</a>事件，该事件回调在Canvas组件初始化完成时或大小变化时执行，在回调中进行水印绘制draw()方法的执行。并通过设置Canvas组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-hit-test-behavior#hittestbehavior" target="_blank">hitTestBehavior</a>属性，使水印组件不影响其他组件的触摸测试，让页面能正常交互。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/component/Watermark.ets#L20-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">Watermark</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">settings</span>: <span class="hljs-title class_">RenderingContextSettings</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RenderingContextSettings</span>(<span class="hljs-literal">true</span>);</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">CanvasRenderingContext2D</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">CanvasRenderingContext2D</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">settings</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Canvas</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-title class_">HitTestMode</span>.<span class="hljs-property">Transparent</span>)</li><li>      .<span class="hljs-title function_">onReady</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">draw</span>())</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/component/Watermark.ets#L20-L65" target="_blank">Watermark.ets</a></div></div></div></div> </li><li>实现绘制水印draw()方法。绘制的起点默认为坐标轴的原点（画布的左上角），通过坐标轴的平移及旋转，实现在画布的不同位置、不同角度绘制水印。如果水印有一定旋转角度，想保证第一个水印能完整显示，需要对绘制的起点做平移，平移距离通过旋转角度及水印宽高计算。<ul><li>旋转角度大于0，由下图可知，水印沿x轴方向平移距离positionX = tan(θ) * 水印高度，即绘制起点为(positionX, 0)。<p><span><img height="397.70125500000006" originheight="932" originwidth="1125" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163051.94547782143627769332183820620522:50001231000000:2800:6B19E9B5C95C0DA562E38723844ED7557B8A19C5285C1DBAECFF0344999BBE30.png" title="点击放大" width="477.944145"></span></p> </li><li>旋转角度小于0，由下图可知，水印沿y轴方向平移距离positionY = tan(θ) * 水印宽度，即绘制起点为(0, positionY)。<p><span><img height="423.9375" originheight="950" originwidth="1172" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163051.57318619177050583886235328139896:50001231000000:2800:3DE93ACC4E7BD3883345BE6EB6B1B077208C8174C35BEF9F4111D7E3AB4A804D.png" title="点击放大" width="523.6875"></span></p> </li></ul> <p>最终通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-canvasrenderingcontext2d#filltext" target="_blank">CanvasRenderingContext2D.fillText()</a>方法进行水印文字的绘制。</p> <div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/component/Watermark.ets#L26-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Prop</span> watermarkWidth: number = <span class="hljs-number">120</span>;</li><li><span class="hljs-meta">@Prop</span> watermarkHeight: number = <span class="hljs-number">120</span>;</li><li><span class="hljs-meta">@Prop</span> watermarkText: string = <span class="hljs-keyword">this</span>.getWatermarkText();</li><li><span class="hljs-meta">@Prop</span> rotationAngle: number = -<span class="hljs-number">30</span>;</li><li><span class="hljs-meta">@Prop</span> fillColor: string | number | CanvasGradient | CanvasPattern = <span class="hljs-string">'#10000000'</span>;</li><li><span class="hljs-meta">@Prop</span> font: string = <span class="hljs-string">'16vp'</span>;</li><li>
</li><li>draw() {</li><li>  <span class="hljs-keyword">this</span>.context.fillStyle = <span class="hljs-keyword">this</span>.fillColor;</li><li>  <span class="hljs-keyword">this</span>.context.font = <span class="hljs-keyword">this</span>.font;</li><li>  <span class="hljs-keyword">const</span> colCount = Math.ceil(<span class="hljs-keyword">this</span>.context.width / <span class="hljs-keyword">this</span>.watermarkWidth);</li><li>  <span class="hljs-keyword">const</span> rowCount = Math.ceil(<span class="hljs-keyword">this</span>.context.height / <span class="hljs-keyword">this</span>.watermarkHeight);</li><li>  <span class="hljs-keyword">for</span> (let col = <span class="hljs-number">0</span>; col &lt;= colCount; col++) {</li><li>    let row = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (; row &lt;= rowCount; row++) {</li><li>      <span class="hljs-keyword">const</span> angle = <span class="hljs-keyword">this</span>.rotationAngle * Math.PI / <span class="hljs-number">180</span>;</li><li>      <span class="hljs-keyword">this</span>.context.rotate(angle);</li><li>      <span class="hljs-keyword">const</span> positionX = <span class="hljs-keyword">this</span>.rotationAngle &gt; <span class="hljs-number">0</span> ? <span class="hljs-keyword">this</span>.watermarkHeight * Math.tan(angle) : <span class="hljs-number">0</span>;</li><li>      <span class="hljs-keyword">const</span> positionY = <span class="hljs-keyword">this</span>.rotationAngle &gt; <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-keyword">this</span>.watermarkWidth * Math.tan(-angle);</li><li>      <span class="hljs-keyword">this</span>.context.fillText(<span class="hljs-keyword">this</span>.watermarkText, positionX, positionY);</li><li>      <span class="hljs-keyword">this</span>.context.rotate(-angle);</li><li>      <span class="hljs-keyword">this</span>.context.translate(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.watermarkHeight);</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.context.translate(<span class="hljs-number">0</span>, -<span class="hljs-keyword">this</span>.watermarkHeight * row);</li><li>    <span class="hljs-keyword">this</span>.context.translate(<span class="hljs-keyword">this</span>.watermarkWidth, <span class="hljs-number">0</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/component/Watermark.ets#L26-L52" target="_blank">Watermark.ets</a></div></div></div></div> </li></ol> </li><li>将水印组件与UI页面组件融合显示。<p>方式一：使用Stack将水印组件叠加在UI组件上层。</p> <div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkStackPage.ets#L28-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">Stack</span>({ alignContent: Alignment.Center }) {</li><li>  <span class="hljs-built_in">Column</span>() {</li><li>    <span class="hljs-built_in">Image</span>($r('app.media.empty'))</li><li>      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">110</span>)</li><li>      <span class="hljs-selector-class">.height</span>(<span class="hljs-number">88</span>)</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-built_in">Watermark</span>({ rotationAngle: <span class="hljs-number">20</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkStackPage.ets#L28-L42" target="_blank">WatermarkStackPage.ets</a></div></div></div></div> <p>方式二：设置UI组件的overlay属性，使水印组件作为UI组件的浮层显示。注意watermarkBuilder中嵌套了一层父元素Column，所以需要同时设置Column的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-hit-test-behavior#hittestbehavior" target="_blank">hitTestBehavior</a>属性，使浮层下方页面能正常交互。</p> <div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkOverlayPage.ets#L24-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Builder</span></li><li>watermarkBuilder() {</li><li>  <span class="hljs-built_in">Column</span>() {</li><li>    <span class="hljs-built_in">Watermark</span>()</li><li>  }</li><li>  <span class="hljs-selector-class">.hitTestBehavior</span>(HitTestMode.Transparent)</li><li>}</li><li>
</li><li><span class="hljs-built_in">build</span>() {</li><li>  <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-built_in">Column</span>() {</li><li>      <span class="hljs-built_in">Image</span>($r('app.media.empty'))</li><li>        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">110</span>)</li><li>        <span class="hljs-selector-class">.height</span>(<span class="hljs-number">88</span>)</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)</li><li>    <span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Center)</li><li>    <span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>    <span class="hljs-selector-class">.overlay</span>(this.watermarkBuilder())</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkOverlayPage.ets#L24-L60" target="_blank">WatermarkOverlayPage.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果需要多个页面或应用全局添加水印，可将上述方式二中的watermarkBuilder封装到一个单独的文件，export出一个全局的watermarkBuilder。在需要添加水印页面的根节点上添加.overlay绑定watermarkBuilder即可。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section987311343125">图片上添加水印<i class="anchor-icon anchor-icon-link" anchorid="section987311343125" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1873355320126" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1873355320126" tips="复制节点链接"></i></h3><p>保存的图片、拍照生成的图片等场景，需要添加水印。实现效果图如下。</p> <p><span><img height="549.332161" originheight="2245" originwidth="2349" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163051.25588673649923709496478016257261:50001231000000:2800:B8778A766B0E90ACC06E750C01A625D3A9161A9072A887EC93116EA4FDB4D85C.png" title="点击放大" width="574.5600000000001"></span></p> </div> <div class="tiledSection"><h3 id="section82425831212">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section82425831212" tips="复制节点链接"></i></h3><p><strong>关键技术</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-offscreencanvas" target="_blank">OffscreenCanvas</a>提供离屏画布，与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>使用场景区别在于是否需要将画布渲染在屏幕上。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d" target="_blank">OffscreenCanvasRenderingContext2D</a>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-offscreencanvas" target="_blank">OffscreenCanvas</a>上进行离屏绘制，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d#filltext" target="_blank">fillText()</a>方法用于绘制文本，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d#drawimage" target="_blank">drawImage()</a>方法用于图像绘制。</p> <p><strong>开发流程</strong></p> <ol><li>解析图片得到pixelMap数据。</li><li>创建与图片宽高一致的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-offscreencanvas" target="_blank">OffscreenCanvas</a>离屏画布。</li><li>将图片和水印依次绘制到离屏画布上。</li><li>获取离屏画布的pixelMap数据。</li><li>将pixelMap数据写入文件中。</li></ol> </div> <div class="tiledSection"><h3 id="section1396665139">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1396665139" tips="复制节点链接"></i></h3><ol><li>解析图片得到pixelMap数据。<ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getmediacontent9-1" target="_blank">resourceManager.getMediaContent()</a>方法获取图片内容，得到ArrayBuffer数据。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#imagecreateimagesource9-2" target="_blank">image.createImageSource(buf: ArrayBuffer)</a>方法创建图片源实例。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/SaveImagePage.ets#L41-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">async</span> <span class="hljs-title function_">getImagePixelMap</span>(<span class="hljs-variable">resource</span>: <span class="hljs-title class_">Resource</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ImagePixelMap</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">data</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getMediaContent</span>(<span class="hljs-variable">resource</span>.<span class="hljs-variable">id</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">Uint8Array</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">arrayBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">data</span>.<span class="hljs-variable">buffer</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-variable">data</span>.<span class="hljs-variable">byteOffset</span>, <span class="hljs-variable">data</span>.<span class="hljs-variable">byteLength</span> + <span class="hljs-variable">data</span>.<span class="hljs-variable">byteOffset</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">arrayBuffer</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">await</span> <span class="hljs-title function_">imageSource2PixelMap</span>(<span class="hljs-variable">imageSource</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/SaveImagePage.ets#L41-L46" target="_blank">SaveImagePage.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#getimageinfo-2" target="_blank">ImageSource.getImageInfo()</a>方法获取图片宽、高信息，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagesource#createpixelmap7" target="_blank">ImageSource.createPixelMap()</a>方法创建PixelMap对象。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L55-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-variable">async</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">imageSource2PixelMap</span>(<span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ImagePixelMap</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">imageInfo</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageInfo</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">getImageInfo</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">height</span> = <span class="hljs-variable">imageInfo</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">width</span> = <span class="hljs-variable">imageInfo</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">DecodingOptions</span> = {</li><li>    <span class="hljs-variable">editable</span>: <span class="hljs-keyword">true</span>,</li><li>    <span class="hljs-variable">desiredSize</span>: { <span class="hljs-variable">height</span>, <span class="hljs-variable">width</span> }</li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">PixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">options</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">result</span>: <span class="hljs-title class_">ImagePixelMap</span> = { <span class="hljs-variable">pixelMap</span>, <span class="hljs-variable">width</span>, <span class="hljs-variable">height</span> };</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">result</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L55-L66" target="_blank">Utils.ets</a></div></div></div></div> </li></ol> </li><li>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-offscreencanvas" target="_blank">OffscreenCanvas</a>离屏画布绘制图片及水印，得到融合水印后的pixelMap数据。<ol><li>创建与图片宽高一致的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-offscreencanvas" target="_blank">OffscreenCanvas</a>离屏画布，这里注意单位保持一致。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d#drawimage" target="_blank">OffscreenCanvasRenderingContext2D.drawImage()</a>将图片绘制到离屏画布上。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d#filltext" target="_blank">OffscreenCanvasRenderingContext2D.fillText()</a>将水印绘制在离屏画布的指定位置。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-offscreencanvasrenderingcontext2d#getpixelmap" target="_blank">OffscreenCanvasRenderingContext2D.getPixelMap()</a>以当前离屏画布指定区域内的像素创建PixelMap对象。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L69-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">addWatermark</span>(<span class="hljs-params"></span></li><li><span class="hljs-params">  imagePixelMap: ImagePixelMap,</span></li><li><span class="hljs-params">  text: <span class="hljs-built_in">string</span> = <span class="hljs-string">'watermark'</span>,</span></li><li><span class="hljs-params">  drawWatermark?: (OffscreenContext: OffscreenCanvasRenderingContext2D) =&gt; <span class="hljs-built_in">void</span></span></li><li><span class="hljs-params"></span>): image.<span class="hljs-property">PixelMap</span> {</li><li>  <span class="hljs-keyword">const</span> height = uiContext?.<span class="hljs-title function_">px2vp</span>(imagePixelMap.<span class="hljs-property">height</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">const</span> width = uiContext?.<span class="hljs-title function_">px2vp</span>(imagePixelMap.<span class="hljs-property">width</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">const</span> offScreenCanvas = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OffscreenCanvas</span>(width, height);</li><li>  <span class="hljs-keyword">const</span> offScreenContext = offScreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);</li><li>  offScreenContext.<span class="hljs-title function_">drawImage</span>(imagePixelMap.<span class="hljs-property">pixelMap</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);</li><li>  <span class="hljs-keyword">if</span> (drawWatermark) {</li><li>    <span class="hljs-title function_">drawWatermark</span>(offScreenContext);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">const</span> displayWidth = display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">width</span>;</li><li>    <span class="hljs-keyword">const</span> vpWidth = uiContext?.<span class="hljs-title function_">px2vp</span>(displayWidth) ?? displayWidth;</li><li>    <span class="hljs-keyword">const</span> imageScale = width / vpWidth;</li><li>    offScreenContext.<span class="hljs-property">textAlign</span> = <span class="hljs-string">'right'</span>;</li><li>    offScreenContext.<span class="hljs-property">fillStyle</span> = <span class="hljs-string">'#A2FFFFFF'</span>;</li><li>    offScreenContext.<span class="hljs-property">font</span> = <span class="hljs-number">12</span> * imageScale + <span class="hljs-string">'vp'</span>;</li><li>    <span class="hljs-keyword">const</span> padding = <span class="hljs-number">5</span> * imageScale;</li><li>    offScreenContext.<span class="hljs-title function_">fillText</span>(text, width - padding, height - padding);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> offScreenContext.<span class="hljs-title function_">getPixelMap</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L69-L92" target="_blank">Utils.ets</a></div></div></div></div> </li></ol> </li><li>将添加水印后得到的pixelMap数据写入文件中。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L27-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToFile</span>(<span class="hljs-params">pixelMap: image.PixelMap, context: Context</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> phAccessHelper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(context);</li><li>    <span class="hljs-keyword">const</span> filePath = <span class="hljs-keyword">await</span> phAccessHelper.<span class="hljs-title function_">createAsset</span>(photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>, <span class="hljs-string">'png'</span>);</li><li>    <span class="hljs-keyword">const</span> imagePacker = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>    <span class="hljs-keyword">const</span> imageBuffer = <span class="hljs-keyword">await</span> imagePacker.<span class="hljs-title function_">packToData</span>(pixelMap, {</li><li>      <span class="hljs-attr">format</span>: <span class="hljs-string">'image/png'</span>,</li><li>      <span class="hljs-attr">quality</span>: <span class="hljs-number">100</span></li><li>    });</li><li>    <span class="hljs-keyword">const</span> mode = fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>;</li><li>    fd = (<span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(filePath, mode)).<span class="hljs-property">fd</span>;</li><li>    <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">truncate</span>(fd);</li><li>    <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">write</span>(fd, imageBuffer);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'saveToFile error：'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(err) ?? <span class="hljs-string">''</span>);</li><li>  } <span class="hljs-keyword">finally</span> {</li><li>    <span class="hljs-keyword">if</span> (fd) {</li><li>      fileIo.<span class="hljs-title function_">close</span>(fd);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/constants/Utils.ets#L27-L47" target="_blank">Utils.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section7418171112138">PDF文档添加水印<i class="anchor-icon anchor-icon-link" anchorid="section7418171112138" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section101139267133" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section101139267133" tips="复制节点链接"></i></h3><p>在PDF预览页面点击添加水印按钮，生成带水印的PDF文档，并显示在预览页面中。</p> <p><span><img height="552.232891" originheight="2245" originwidth="2349" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163051.67077438710041258611236621306121:50001231000000:2800:0F649DF20F324CB2E224FD72CEE11F4EF6325D5DFD9CAA85C8B7EB3133FA4FA3.png" title="点击放大" width="577.4079290000001"></span></p> </div> <div class="tiledSection"><h3 id="section615615302137">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section615615302137" tips="复制节点链接"></i></h3><p><strong>关键技术</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice" target="_blank">pdfService</a>模块为应用提供统一管理PDF页面的页眉页脚、水印、背景、批注、书签的能力。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section2094113924815" target="_blank">pdfService.TextWatermarkInfo</a>类和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section1122165334818" target="_blank">pdfService.ImageWatermarkInfo</a>分别提供创建文本水印和图片水印的能力。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section1319183318231" target="_blank">pdfService.PdfDocument</a>类提供与文档相关能力，其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section206080386472" target="_blank">addWatermark()</a>方法用于添加水印。</p> <p><strong>开发流程</strong></p> <ol><li>将应用侧PDF文件写入沙箱中。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice" target="_blank">pdfService</a>模块相关API加载指定沙箱路径的PDF并添加水印。</li></ol> </div> <div class="tiledSection"><h3 id="section3228143311315">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section3228143311315" tips="复制节点链接"></i></h3><ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfilecontentsync10" target="_blank">getRawFileContentSync()</a>方法获取resource/rawfile目录下的PDF文件内容，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fs#writesync10" target="_blank">fs.writeSync()</a>方法写入沙箱中。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L54-L62" data-highlighted="yes"><ol class="linenums"><li>savePdfToSandbox(): string {</li><li>  <span class="hljs-keyword">const</span> filePath = <span class="hljs-keyword">this</span>.getPdfSandboxPath();</li><li>  fileIo.accessSync(filePath);</li><li>  <span class="hljs-keyword">const</span> content: Uint8Array = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()?.resourceManager.getRawFileContentSync(<span class="hljs-string">'watermark.pdf'</span>) <span class="hljs-keyword">as</span> Uint8Array;</li><li>  <span class="hljs-keyword">const</span> file = fileIo.openSync(filePath, fileIo.OpenMode.WRITE_ONLY | fileIo.OpenMode.CREATE | fileIo.OpenMode.TRUNC);</li><li>  fileIo.writeSync(file.fd, content.buffer);</li><li>  fileIo.closeSync(file.fd);</li><li>  <span class="hljs-keyword">return</span> filePath;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L54-L62" target="_blank">WatermarkPdfPage.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfviewmanage#section15202162183817" target="_blank">pdfViewManager.PdfController</a>控制器中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfviewmanage#section073321844615" target="_blank">loadDocument()</a>方法通过沙箱路径加载文件，显示到PDF预览组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfview-component" target="_blank">PdfView</a>中<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L29-L163" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-variable">controller</span>: <span class="hljs-title class_">pdfViewManager</span>.<span class="hljs-title class_">PdfController</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">pdfViewManager</span>.<span class="hljs-title function_">PdfController</span>();</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">filePath</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">savePdfToSandbox</span>();</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">controller</span>.<span class="hljs-title function_">loadDocument</span>(<span class="hljs-variable">filePath</span>);</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title function_">PdfView</span>({</li><li>        <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">controller</span>,</li><li>        <span class="hljs-variable">pageFit</span>: <span class="hljs-title class_">pdfService</span>.<span class="hljs-title class_">PageFit</span>.<span class="hljs-title class_">FIT_WIDTH</span></li><li>      })</li><li>        <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L29-L163" target="_blank">WatermarkPdfPage.ets</a></div></div></div></div> </li><li>通过文本水印类<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section2094113924815" target="_blank">pdfService.TextWatermarkInfo</a>创建水印对象，设置水印内容、字体、颜色、位置等相关属性；图片水印对象通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section1122165334818" target="_blank">pdfService.ImageWatermarkInfo</a>创建。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L71-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getWatermarkInfo</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">watermarkInfo</span>: pdfService.<span class="hljs-property">TextWatermarkInfo</span> = <span class="hljs-keyword">new</span> pdfService.<span class="hljs-title class_">TextWatermarkInfo</span>();</li><li>  watermarkInfo.<span class="hljs-property">watermarkType</span> = pdfService.<span class="hljs-property">WatermarkType</span>.<span class="hljs-property">WATERMARK_TEXT</span>;</li><li>  watermarkInfo.<span class="hljs-property">content</span> = <span class="hljs-string">'This is Watermark'</span>;</li><li>  watermarkInfo.<span class="hljs-property">textSize</span> = <span class="hljs-number">32</span>;</li><li>  watermarkInfo.<span class="hljs-property">textColor</span> = <span class="hljs-number">200</span>;</li><li>  watermarkInfo.<span class="hljs-property">rotation</span> = <span class="hljs-number">45</span>;</li><li>  watermarkInfo.<span class="hljs-property">opacity</span> = <span class="hljs-number">0.3</span>;</li><li>  <span class="hljs-keyword">return</span> watermarkInfo;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L71-L80" target="_blank">WatermarkPdfPage.ets</a></div></div></div></div> </li><li>通过PDF文档类<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section1319183318231" target="_blank">pdfService.PdfDocument</a>创建文档对象，使用文档对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section167288392229" target="_blank">loadDocument()</a>方法加载文档，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section206080386472" target="_blank">addWatermark()</a>方法添加水印、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/pdf-arkts-pdfservice#section660833016157" target="_blank">saveDocument()</a>方法将添加水印后的文档保存到沙箱中。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L84-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addWatermark</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> filePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPdfSandboxPath</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">pdfDocument</span>: pdfService.<span class="hljs-property">PdfDocument</span> = <span class="hljs-keyword">new</span> pdfService.<span class="hljs-title class_">PdfDocument</span>();</li><li>  pdfDocument.<span class="hljs-title function_">loadDocument</span>(filePath);</li><li>  pdfDocument.<span class="hljs-title function_">addWatermark</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getWatermarkInfo</span>(), <span class="hljs-number">0</span>, pdfDocument.<span class="hljs-title function_">getPageCount</span>(), <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);</li><li>  <span class="hljs-keyword">const</span> watermarkFilePath = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAddedWatermarkPdfSandboxPath</span>();</li><li>  pdfDocument.<span class="hljs-title function_">saveDocument</span>(watermarkFilePath);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showInPdfView</span>(watermarkFilePath);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L84-L92" target="_blank">WatermarkPdfPage.ets</a></div></div></div></div> </li><li>将沙箱中添加水印后的文档加载到PDF预览器中。<div class="screenLinkPre"><div _ngcontent-kmc-c106="" class="highlight-div"><div _ngcontent-kmc-c106="" class="highlight-div-header"><div _ngcontent-kmc-c106="" class="highlight-div-header-left"><div _ngcontent-kmc-c106="" class="handle-button expand-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-kmc-c106="" class="highlight-div-header-right"><div _ngcontent-kmc-c106="" class="handle-button ai-button"></div><div _ngcontent-kmc-c106="" class="handle-button line-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-kmc-c106="" class="handle-button theme-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-kmc-c106="" class="handle-button copy-button"><div _ngcontent-kmc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-kmc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L95-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">showInPdfView</span>(<span class="hljs-params">filePath: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">hasWatermark</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-comment">// release before reload avoid crash.</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">releaseDocument</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">loadDocument</span>(filePath);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">controller</span>.<span class="hljs-title function_">setPageFit</span>(pdfService.<span class="hljs-property">PageFit</span>.<span class="hljs-property">FIT_WIDTH</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/watermark/blob/master/entry/src/main/ets/pages/WatermarkPdfPage.ets#L95-L101" target="_blank">WatermarkPdfPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section20851175145112">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section20851175145112" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/watermark" target="_blank">水印添加能力</a></li></ul> </div> <p></p> </div> <div></div></div>