<h1 _ngcontent-gco-c119="" class="doc-title ng-star-inserted" title="渲染视频画面"> 渲染视频画面 </h1>

<div _ngcontent-gco-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section9389949122512">概述<i class="anchor-icon anchor-icon-link" anchorid="section9389949122512" tips="复制节点链接"></i></h2><p>渲染视频画面是将原始视频数据（如 YUV、RGB 等格式）转换为可在屏幕上显示的图像，并最终输出到显示设备（如手机屏幕）的过程。此过程是视频解码播放、视频直播、相机预览等场景中的关键环节，决定了画面视觉效果。</p> <p>本文以视频解码播放为场景案例，介绍了视频在解码后，如何将解码的视频数据渲染送显到设备屏幕上。目前，系统中提供了多种方式渲染视频画面，包括使用XComponent渲染视频画面、使用OpenGL渲染视频画面、使用Vulkan渲染视频画面。这三个方案的优点、缺点和适用场景如下表所示。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.4.1.5.1.1" valign="top" width="25%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.5.1.2" valign="top" width="25%"><p>优点</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.5.1.3" valign="top" width="25%"><p>缺点</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.4.1.5.1.4" valign="top" width="25%"><p>使用场景</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="25%"><p>使用XComponent渲染视频画面</p> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>开发门槛不高，可以通过XComponent的NativeWindow直接对接解码器。</li><li>解码后的YUV视频数据，无需额外进行处理，可以直接提交给XComponent进行渲染显示。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>定制化能力弱，无法满足复杂的开发场景。</li><li>性能优化的空间不多，在较为复杂或高规格的场景中，无法干预渲染流程，导致性能不高。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>该方案适用于简单的视频播放，不需要对视频画面做复杂的处理。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>使用OpenGL渲染视频画面</p> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>可以满足复杂的场景，根据开发者的需求定制化开发。</li><li>OpenGL是跨编程语言和跨平台的应用编程接口，便于应用的开发与迁移。</li><li>开发门槛适中，生态资料丰富。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>需要额外处理视频数据的格式，视频解码后的数据通常需要转化成RGBA的格式。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>该方案可以满足复杂的开发场景，开发者可以根据实际需求实现，如视频直播、视频弹幕等场景。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="25%"><p>使用Vulkan渲染视频画面</p> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>可细粒度控制渲染全流程，优化渲染链路以获得更高性能。</li><li>可适配复杂的场景。</li><li>Vulkan是跨编程语言和跨平台的应用编程接口，便于应用的开发与迁移。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><ul><li>需要额外处理视频数据的格式，视频解码后的数据通常需要转化成RGBA的格式。</li><li>开发门槛较高，需要手动管理内存、命令缓冲等，且需要开发的代码量大，出现问题难定位。</li></ul> </td> <td class="cellrowborder" valign="top" width="25%"><p>同上。</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section32801825103713">使用XComponent渲染视频画面<i class="anchor-icon anchor-icon-link" anchorid="section32801825103713" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section14975410133914" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section14975410133914" tips="复制节点链接"></i></h3><p>系统提供了AVPlayer、Video组件播放视频文件，其实现方式简单，但支持的文件格式有限。在播放其他格式（如rmvb格式）或有数字版权保护的视频时，AVPlayer、Video组件不能满足开发者的诉求。此时，开发者可以通过AVCodec将视频文件进行解码，然后将解码后的视频数据通过XComponent组件直接进行渲染送显即可。使用XComponent渲染视频画面是简单、常用的方式，开发者可以将解码的YUV视频数据传入给XComponent，无需关注YUV格式转化等问题。</p> </div> <div class="tiledSection"><h3 id="section69595155391">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section69595155391" tips="复制节点链接"></i></h3><p>在使用XComponent渲染视频画面的方案中，需要提前获取XComponent对应的NativeWindow对象，并在创建视频解码器时，将NativeWindow设置给视频解码器。其具体开发流程如下所示。</p> <ol><li>在XComponent创建时，通过回调函数OnSurfaceCreatedCB获取对应的NativeWindow对象。</li><li>初始化视频解码的环境，包括初始化解封装器、初始化解码器。</li><li>启动解码器、解码输入子线程、解码输出子线程。<p><span><img height="375.8048" originheight="1713" originwidth="2425" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.61819805103190418290338218737257:50001231000000:2800:CFBB24B009AB421552681BCDDE6B823511C04B977E05490AED5EDF46B8317916.jpg" title="点击放大" width="532"></span></p> </li><li>通过OnNeedInputBuffer获取可用的AVBuffer后，在解码输入子线程中，将解封装器读取视频数据填充到AVBuffer中，并提交给解码器进行解码。<p><span><img height="440.7354" originheight="1613" originwidth="1947" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.71538914266234696124179029849114:50001231000000:2800:D780FBBF7D492EBA95B1001B8FE3E03B40DB265A68D180DC2C2B14E15AC4473F.jpg" title="点击放大" width="532"></span></p> </li><li>通过OnNeedOutputBuffer获取解码的视频数据后，在解码输出子线程中，将解码后的视频数据提交给输出Surface（即XComponent的NativeWindow）。<p><span><img height="358.98030000000006" originheight="1413" originwidth="2094" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.87205824285580140985936587267021:50001231000000:2800:09A5ECE570AA276CD6F0D829FF721FF651E918A250C183ECFF733C40F98375BF.jpg" title="点击放大" width="532"></span></p> </li></ol> </div> <div class="tiledSection"><h3 id="section1624962093914">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1624962093914" tips="复制节点链接"></i></h3><ol><li>在XComponent创建时，通过回调函数OnSurfaceCreatedCB获取对应的NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L27-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceCreatedCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>)</li><li>{</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"OnSurfaceCreatedCB"</span>);</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">component</span> == <span class="hljs-variable">nullptr</span>) || (<span class="hljs-variable">window</span> == <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"onSurfaceCreatedCB: component or window is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">idStr</span>[<span class="hljs-variable">OH_XCOMPONENT_ID_LEN_MAX</span> + <span class="hljs-number">1</span>] = {<span class="hljs-string">'\0'</span>};</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">idSize</span> = <span class="hljs-variable">OH_XCOMPONENT_ID_LEN_MAX</span> + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">OH_NativeXComponent_GetXComponentId</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">idStr</span>, &amp;<span class="hljs-title class_">idSize</span>) != <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"OnSurfaceCreatedCB:Unable to get XComponent id"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">id</span>(<span class="hljs-title class_">idStr</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">GetInstance</span>(<span class="hljs-title class_">id</span>);</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">width</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">height</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">xSize</span> = <span class="hljs-title function_">OH_NativeXComponent_GetXComponentSize</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">window</span>, &amp;<span class="hljs-title class_">width</span>, &amp;<span class="hljs-title class_">height</span>);</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">xSize</span> != <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) || (<span class="hljs-variable">render</span> == <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"OnSurfaceCreatedCB: Unable to qet XComponent size"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OHNativeWindow</span> *&gt;(<span class="hljs-variable">window</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-variable">SET_BUFFER_GEOMETRY</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">width</span>),</li><li>                                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">height</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">id</span> == <span class="hljs-string">"OpenGL"</span>) {</li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">openGLRenderThread_</span>-&gt;<span class="hljs-title class_">UpdateNativeWindow</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-title class_">width</span>, <span class="hljs-title class_">height</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">id</span> == <span class="hljs-string">"Vulkan"</span>) {</li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">vulkanRenderThread_</span>-&gt;<span class="hljs-title class_">UpdateNativeWindow</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-title class_">width</span>, <span class="hljs-title class_">height</span>);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L27-L60" target="_blank">PluginRender.cpp</a></div></div></div></div> </li><li>初始化视频解码的环境。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L48-L80" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">Init</span>(<span class="hljs-title class_">SampleInfo</span> &amp;<span class="hljs-title class_">sampleInfo</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>    <span class="hljs-keyword">if</span>(<span class="hljs-variable">isStarted_</span> || (<span class="hljs-variable">demuxer_</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">videoDecoder_</span> != <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Already started."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">sampleInfo_</span> = <span class="hljs-variable">sampleInfo</span>;</li><li>
</li><li>    <span class="hljs-variable">videoDecoder_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">VideoDecoder</span>&gt;();</li><li>    <span class="hljs-variable">demuxer_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">Demuxer</span>&gt;();</li><li>    <span class="hljs-variable">isReleased_</span> = <span class="hljs-keyword">false</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">Create</span>(<span class="hljs-title class_">sampleInfo_</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Create demuxer failed"</span>);</li><li>        <span class="hljs-variable">doneCond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-title function_">StartRelease</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">CreateVideoDecoder</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Create video decoder failed"</span>);</li><li>        <span class="hljs-variable">doneCond_</span>.<span class="hljs-title function_">notify_all</span>();</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-title function_">StartRelease</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Succeed"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L48-L80" target="_blank">Player.cpp</a></div></div></div></div> <p>创建解封装器。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/Demuxer.cpp#L26-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Demuxer::Create</span><span class="hljs-params">(SampleInfo &amp;info)</span> </span>{</li><li>    source_ = <span class="hljs-built_in">OH_AVSource_CreateWithFD</span>(info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>    <span class="hljs-keyword">if</span> (source_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP,</li><li>                     <span class="hljs-string">"Create demuxer source failed, fd: %{public}d, offset: %{public}ld, file size: %{public}ld"</span>,</li><li>                     info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>    </li><li>    demuxer_ = <span class="hljs-built_in">OH_AVDemuxer_CreateWithSource</span>(source_);</li><li>    <span class="hljs-keyword">if</span> (demuxer_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Create demuxer failed"</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">auto</span> sourceFormat = std::<span class="hljs-built_in">shared_ptr</span>&lt;OH_AVFormat&gt;(<span class="hljs-built_in">OH_AVSource_GetSourceFormat</span>(source_), OH_AVFormat_Destroy);</li><li>    <span class="hljs-keyword">if</span> (sourceFormat == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Get source format failed"</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">GetTrackInfo</span>(sourceFormat, info);</li><li>    <span class="hljs-keyword">if</span> (ret != AVCODEC_SAMPLE_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Get video track info, ret: %{public}d"</span>, ret);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>    </li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/Demuxer.cpp#L26-L54" target="_blank">Demuxer.cpp</a></div></div></div></div> <p>创建视频解码器。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L30-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">CreateVideoDecoder</span>() {</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"video mime:%{public}s"</span>, <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">videoCodecMime</span>.<span class="hljs-title function_">c_str</span>());</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">Create</span>(<span class="hljs-title class_">sampleInfo_</span>.<span class="hljs-title class_">videoCodecMime</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Create video decoder failed, mime:%{public}s"</span>, <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">videoCodecMime</span>.<span class="hljs-title function_">c_str</span>());</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable">videoDecContext_</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">CodecUserData</span>;</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">Config</span>(<span class="hljs-title class_">sampleInfo_</span>, <span class="hljs-title class_">videoDecContext_</span>);</li><li>        <span class="hljs-keyword">if</span>(!(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>)) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Video Decoder config failed"</span>);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">ret</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L30-L44" target="_blank">Player.cpp</a></div></div></div></div> <p>设置视频解码器的Surface。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/VideoDecoder.cpp#L81-L119" data-highlighted="yes"><ol class="linenums"><li>int32_t VideoDecoder::Config(<span class="hljs-keyword">const</span> SampleInfo &amp;sampleInfo, CodecUserData *codecUserData) {</li><li>    <span class="hljs-keyword">if</span> (decoder_ == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Decoder is null"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (codecUserData == nullptr) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Invalid param: codecUserData"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>    </li><li>    int32_t ret = Configure(sampleInfo);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Configure failed"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (sampleInfo.window != nullptr) {</li><li>        <span class="hljs-type">int</span> ret = OH_VideoDecoder_SetSurface(decoder_, sampleInfo.window);</li><li>        <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>            OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Set surface failed, ret: %{public}d"</span>, ret);</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>        }</li><li>    }</li><li>    </li><li>    ret = SetCallback(codecUserData);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Set callback failed, ret: %{public}d"</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>    </li><li>    ret = OH_VideoDecoder_Prepare(decoder_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-built_in">AV_ERR_OK</span>) {</li><li>        OH_LOG_ERROR(LOG_APP, <span class="hljs-string">"Prepare failed, ret: %{public}d"</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/VideoDecoder.cpp#L81-L119" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li><li>启动解码器、解码输入子线程、解码输出子线程。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L84-L115" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Player::Start</span><span class="hljs-params">()</span> </span>{</li><li>    <span class="hljs-function">std::unique_lock&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(mutex_)</span></span>;</li><li>    <span class="hljs-type">int32_t</span> ret;</li><li>    <span class="hljs-keyword">if</span> (isStarted_ || demuxer_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Already started."</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>    </li><li>    <span class="hljs-keyword">if</span> (videoDecContext_) {</li><li>        ret = videoDecoder_-&gt;<span class="hljs-built_in">Start</span>();</li><li>        <span class="hljs-keyword">if</span> (ret != AVCODEC_SAMPLE_ERR_OK) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Video Decoder start failed"</span>);</li><li>            lock.<span class="hljs-built_in">unlock</span>();</li><li>            <span class="hljs-built_in">StartRelease</span>();</li><li>            <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>        }</li><li>        isStarted_ = <span class="hljs-literal">true</span>;</li><li>        videoDecInputThread_ = std::<span class="hljs-built_in">make_unique</span>&lt;std::thread&gt;(&amp;Player::VideoDecInputThread, <span class="hljs-keyword">this</span>);</li><li>        videoDecOutputThread_ = std::<span class="hljs-built_in">make_unique</span>&lt;std::thread&gt;(&amp;Player::VideoDecOutputThread, <span class="hljs-keyword">this</span>);</li><li>
</li><li>        <span class="hljs-keyword">if</span> (videoDecInputThread_ == <span class="hljs-literal">nullptr</span> || videoDecOutputThread_ == <span class="hljs-literal">nullptr</span>) {</li><li>            <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Create thread failed"</span>);</li><li>            lock.<span class="hljs-built_in">unlock</span>();</li><li>            <span class="hljs-built_in">StartRelease</span>();</li><li>            <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"Succeed"</span>);</li><li>    doneCond_.<span class="hljs-built_in">notify_all</span>();</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L84-L115" target="_blank">Player.cpp</a></div></div></div></div> </li><li>通过OnNeedInputBuffer获取可用的AVBuffer，将AVBuffer放到队列中，便于后续处理。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/SampleCallback.cpp#L32-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNeedInputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-title class_">uint32_t</span> <span class="hljs-title class_">index</span>, <span class="hljs-variable">OH_AVBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">userData</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    <span class="hljs-variable">CodecUserData</span> *<span class="hljs-variable">codecUserData</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">CodecUserData</span> *&gt;(<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputMutex</span>);</li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">emplace</span>(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">inputCond</span>.<span class="hljs-title class_">notify_all</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/SampleCallback.cpp#L32-L41" target="_blank">SampleCallback.cpp</a></div></div></div></div> <p>在解码输入子线程中，将解封装器读取视频数据填充到AVBuffer中，并提交给解码器进行解码。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L170-L208" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">VideoDecInputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder input thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;;</li><li>        }</li><li>        </li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>()) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">inputFrameCount</span>++;</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>
</li><li>        <span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">ReadSample</span>(<span class="hljs-variable">demuxer_</span>-&gt;<span class="hljs-title class_">GetVideoTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                             <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>
</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">PushInputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Push data failed, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L170-L208" target="_blank">Player.cpp</a></div></div></div></div> </li><li>在解码输出子线程中，将解码后的视频数据提交给输出Surface。通过OnNeedOutputBuffer获取解码的视频数据<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/SampleCallback.cpp#L45-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">SampleCallback</span>::<span class="hljs-title class_">OnNewOutputBuffer</span>(<span class="hljs-variable">OH_AVCodec</span> <span class="hljs-variable">*codec</span>, <span class="hljs-title class_">uint32_t</span> <span class="hljs-title class_">index</span>, <span class="hljs-variable">OH_AVBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-variable">void</span> <span class="hljs-variable">*userData</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">userData</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-variable">codec</span>;</li><li>    <span class="hljs-variable">CodecUserData</span> *<span class="hljs-variable">codecUserData</span> = <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">CodecUserData</span> *&gt;(<span class="hljs-variable">userData</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">emplace</span>(<span class="hljs-title class_">index</span>, <span class="hljs-title class_">buffer</span>);</li><li>    <span class="hljs-variable">codecUserData</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">notify_all</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/SampleCallback.cpp#L45-L54" target="_blank">SampleCallback.cpp</a></div></div></div></div> <p>在解码输出子线程中，将解码后的视频数据提交给输出Surface。Surface在已在解码器初始化配置，设置的是XComponent的NativeWindow对象。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L212-L254" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Player</span>::<span class="hljs-title class_">VideoDecOutputThread</span>() {</li><li>    <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameInterval</span> = <span class="hljs-variable">MICROSECOND</span> / <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span>;</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-variable">thread_local</span> <span class="hljs-variable">auto</span> <span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-variable">isStarted_</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>()) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>        <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>,<span class="hljs-string">"Out buffer count: %{public}u, size: %{public}d, flag: %{public}u, pts: %{public}ld"</span>,</li><li>                            <span class="hljs-variable">videoDecContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span>,</li><li>                            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>);</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>
</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder_</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>, <span class="hljs-keyword">true</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>            <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Decoder output thread out"</span>);</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_until</span>(<span class="hljs-variable">lastPushTime</span> <span class="hljs-variable">+ std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">microseconds</span>(<span class="hljs-title class_">sampleInfo_</span>.<span class="hljs-title class_">frameInterval</span>));</li><li>        <span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li>    }</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/player/src/Player.cpp#L212-L254" target="_blank">Player.cpp</a></div></div></div></div> <p>通过OH_VideoDecoder_RenderOutputBuffer通知解码器将视频数据提交给输出Surface。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/VideoDecoder.cpp#L153-L170" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">VideoDecoder::FreeOutputBuffer</span><span class="hljs-params">(<span class="hljs-type">uint32_t</span> bufferIndex, <span class="hljs-type">bool</span> render)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (decoder_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Decoder is null"</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = AVCODEC_SAMPLE_ERR_OK;</li><li>    <span class="hljs-keyword">if</span> (render) {</li><li>        ret = <span class="hljs-built_in">OH_VideoDecoder_RenderOutputBuffer</span>(decoder_, bufferIndex);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        ret = <span class="hljs-built_in">OH_VideoDecoder_FreeOutputBuffer</span>(decoder_, bufferIndex);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != AV_ERR_OK) {</li><li>        <span class="hljs-built_in">OH_LOG_ERROR</span>(LOG_APP, <span class="hljs-string">"Free output data failed"</span>);</li><li>        <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_ERROR;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/capbilities/src/VideoDecoder.cpp#L153-L170" target="_blank">VideoDecoder.cpp</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1965164016379">使用OpenGL渲染视频画面<i class="anchor-icon anchor-icon-link" anchorid="section1965164016379" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section768413433917" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section768413433917" tips="复制节点链接"></i></h3><p>OpenGL(Open Graphics Library)是一种跨语言、跨平台的应用程序编程接口（API），用于渲染2D和3D矢量图形。使用XComponent渲染视频画面的实现方案简单，支持的视频格式多，但对视频画面处理不够灵活，例如视频放大、旋转等操作。通过OpenGL，开发者可以根据需求定制实现各种图像处理功能，如视频旋转、视频弹幕等。</p> </div> <div class="tiledSection"><h3 id="section20689739153910">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section20689739153910" tips="复制节点链接"></i></h3><p>在使用OpenGL渲染视频画面中，需要使用NativeImage对接解码器和OpenGL。开发者需要通过OH_NativeImage_AcquireNativeWindow()获取NativeImage的NativeWindow对象，并将NativeImage的NativeWindow对象设置给解码器，以消费解码器生成的视频图像数据。然后，通过OH_NativeImage_UpdateSurfaceImage()将NativeImage获取到的视频图像缓存更新到Opengl相关的纹理中。最后，通过eglSwapBuffers将渲染的缓存提交给XComponent的NativeWindow对象。</p> <p>其具体实现如下所示。</p> <ol><li>启动渲染子线程，初始化OpenGL环境，包括获取显示设备、初始化EGL环境、创建OpenGL上下文等。</li><li>创建NativeImage对象，并根据NativeImage获取NativeWindow对象。</li><li>获取XComponent的NativeWindow对象，并根据XComponent的NativeWindow对象创建EGLSurface。<p><span><img height="457.74610000000007" originheight="2213" originwidth="2572" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.47724764536544645445892092415929:50001231000000:2800:E726E4BE7F7BCF99696C943380943F89D32C73C10EAC6DDE0BC95B6C9B1130F1.jpg" title="点击放大" width="532"></span></p> </li><li>初始化视频解码的环境，包括初始化解封装器、初始化配置解码器。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在初始化配置解码器时，与直接使用XComponent渲染的方案不同，解码器设置Surface的入参是NativeImage的NativeWindow对象，而不是XComponent的NativeWindow对象。</p> </div></div></div> </li><li>启动解码器、解码输入子线程、解码输出子线程。<p><span><img height="419.6815" originheight="1913" originwidth="2425" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.21952005677745430589035593532287:50001231000000:2800:B669C5A4DE569FE1D13F3370961CE78B3D0324FFF4853DE394CAB67B7CB47454.jpg" title="点击放大" width="532"></span></p> </li><li>通过OnNeedInputBuffer获取可用的AVBuffer后，在解码输入子线程中，将解封装器读取视频数据填充到AVBuffer中，并提交给解码器进行解码。</li><li>通过OnNeedOutputBuffer获取解码的视频数据后，在解码输出子线程中，将解码后的视频数据提交给输出Surface（当前Surface为NativeImage的NativeWindow对象）。<p><span><img height="337.40770000000003" originheight="1316" originwidth="2075" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.51249347351366574432634472943338:50001231000000:2800:FF1E84E21C2308E793942EAB055A425CE9D81799CA6E08FFE84CCEF44A44638C.jpg" title="点击放大" width="532"></span></p> </li><li>通过NativeImage，将视频图像缓存更新至OpenGL的纹理上。</li><li>通过eglSwapBuffers交换前后缓冲区的内容，并将渲染结果显示在屏幕。<p><span><img height="439.1394" originheight="2213" originwidth="2681" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.86810993843049841462536141692917:50001231000000:2800:3B22C15C1BF7C741400112336FC841D94D7D0474717EFA1D9A668CEEA3ADAA9C.jpg" title="点击放大" width="532"></span></p> </li></ol> </div> <div class="tiledSection"><h3 id="section569611430393">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section569611430393" tips="复制节点链接"></i></h3><ol><li>启动渲染子线程，初始化OpenGL环境。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L313-L349" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">OpenGLRenderThread</span>::<span class="hljs-title class_">ThreadMainLoop</span>()</li><li>{</li><li>    <span class="hljs-variable">threadId_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">get_id</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitRenderContext</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitNativeVsync</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">CreateNativeImage</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">running_</span>) {</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">wakeUpMutex_</span>);</li><li>            <span class="hljs-variable">wakeUpCond_</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-variable">lock</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> <span class="hljs-variable">wakeUp_</span> || <span class="hljs-variable">vSyncCnt_</span> &gt; <span class="hljs-number">0</span> || <span class="hljs-variable">availableFrameCnt_</span> &gt; <span class="hljs-number">0</span>; });</li><li>            <span class="hljs-variable">wakeUp_</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">vSyncCnt_</span>--;</li><li>            (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeVSync_RequestFrame</span>(<span class="hljs-variable">nativeVsync_</span>, &amp;<span class="hljs-title class_">OpenGLRenderThread</span>::<span class="hljs-title class_">OnVsync</span>, <span class="hljs-keyword">this</span>);</li><li>        }</li><li>        </li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">RenderTask</span>&gt; <span class="hljs-title class_">tasks</span>;</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">taskMutex_</span>);</li><li>            <span class="hljs-variable">tasks</span>.<span class="hljs-title function_">swap</span>(<span class="hljs-variable">tasks_</span>);</li><li>        }</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">auto</span> &amp;<span class="hljs-title class_">task</span> : <span class="hljs-title class_">tasks</span>) {</li><li>            <span class="hljs-title function_">task</span>(*<span class="hljs-variable">renderContext_</span>);</li><li>        }</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">availableFrameCnt_</span> &lt;= <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-title function_">DrawImage</span>();</li><li>        <span class="hljs-variable">availableFrameCnt_</span>--;</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L313-L349" target="_blank">OpenGLRenderThread.cpp</a></div></div></div></div> <p>初始化OpenGL环境，包括获取Display、EGL初始化、EGL上下文的创建等。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRender.cpp#L104-L161" data-highlighted="yes"><ol class="linenums"><li>bool OpenGLRender::Init()</li><li>{</li><li>    <span class="hljs-keyword">if</span> (IsEglContextReady()) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>
</li><li>    OH_LOG_Print(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>, <span class="hljs-string">"EglRenderContext::Init begin."</span>);</li><li>    eglDisplay_ = GetPlatformEglDisplay(EGL_PLATFORM_OHOS_KHR, EGL_DEFAULT_DISPLAY, NULL);</li><li>    <span class="hljs-keyword">if</span> (eglDisplay_ == EGL_NO_DISPLAY) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>,</li><li>                     <span class="hljs-string">"EglRenderContext::Init: failed to create eglDisplay, error: %{public}s."</span>, GetEglErrorString());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    EGLint major;</li><li>    EGLint minor;</li><li>    <span class="hljs-keyword">if</span> (eglInitialize(eglDisplay_, &amp;major, &amp;minor) == EGL_FALSE) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>,</li><li>                     <span class="hljs-string">"EglRenderContext::Init: Failed to initialize EGLDisplay, error: %{public}s."</span>,</li><li>                     GetEglErrorString());</li><li>    }</li><li>    SetupEglExtensions();</li><li>
</li><li>    <span class="hljs-keyword">if</span> (eglBindAPI(EGL_OPENGL_ES_API) == EGL_FALSE) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>,</li><li>                     <span class="hljs-string">"EglRenderContext::Init: Failed to bind OpenGL ES API, error: %{public}s."</span>, GetEglErrorString());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    EGLint count;</li><li>    EGLint configAttribs[] = { EGL_SURFACE_TYPE,</li><li>                               EGL_WINDOW_BIT,</li><li>                               EGL_RED_SIZE,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               EGL_GREEN_SIZE,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               EGL_BLUE_SIZE,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               EGL_ALPHA_SIZE,</li><li>                               <span class="hljs-number">8</span>,</li><li>                               EGL_RENDERABLE_TYPE,</li><li>                               EGL_OPENGL_ES3_BIT,</li><li>                               EGL_NONE };</li><li>    <span class="hljs-keyword">if</span> (eglChooseConfig(eglDisplay_, configAttribs, &amp;config_, <span class="hljs-number">1</span>, &amp;count) == EGL_FALSE) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>,</li><li>                     <span class="hljs-string">"EglRenderContext::Init: Failed to bind choose config, error: %{public}s."</span>, GetEglErrorString());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> EGLint contextAttribs[] = { EGL_CONTEXT_CLIENT_VERSION, <span class="hljs-number">2</span>, EGL_NONE };</li><li>    eglContext_ = eglCreateContext(eglDisplay_, config_, EGL_NO_CONTEXT, contextAttribs);</li><li>    <span class="hljs-keyword">if</span> (eglContext_ == EGL_NO_CONTEXT) {</li><li>        OH_LOG_Print(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>,</li><li>                     <span class="hljs-string">"EglRenderContext::Init: Failed to bind create context, error: %{public}s."</span>, GetEglErrorString());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    OH_LOG_Print(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"EglRenderContext"</span>, <span class="hljs-string">"EglRenderContext::Init end."</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRender.cpp#L104-L161" target="_blank">OpenGLRender.cpp</a></div></div></div></div> </li><li>创建NativeImage对象，然后根据OH_NativeImage_AcquireNativeWindow()获取NativeWindow对象，并注册NativeImage的回调方法。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L264-L293" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">OpenGLRenderThread::CreateNativeImage</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    nativeImage_ = <span class="hljs-built_in">OH_NativeImage_Create</span>(<span class="hljs-number">-1</span>, GL_TEXTURE_EXTERNAL_OES);</li><li>    <span class="hljs-keyword">if</span> (nativeImage_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"OH_NativeImage_Create failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;</li><li>    {</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(nativeImageSurfaceIdMutex_)</span></span>;</li><li>        nativeImageWindow_ = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(nativeImage_);</li><li>        ret = <span class="hljs-built_in">OH_NativeImage_GetSurfaceId</span>(nativeImage_, &amp;nativeImageSurfaceId_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_GetSurfaceId failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    nativeImageFrameAvailableListener_.context = <span class="hljs-keyword">this</span>;</li><li>    nativeImageFrameAvailableListener_.onFrameAvailable = &amp;OpenGLRenderThread::OnNativeImageFrameAvailable;</li><li>    ret = <span class="hljs-built_in">OH_NativeImage_SetOnFrameAvailableListener</span>(nativeImage_, nativeImageFrameAvailableListener_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_SetOnFrameAvailableListener failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L264-L293" target="_blank">OpenGLRenderThread.cpp</a></div></div></div></div> </li><li>在XComponent的回调函数OnSurfaceCreatedCB中，获取XComponent的NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L27-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-title function_">OnSurfaceCreatedCB</span>(<span class="hljs-variable">OH_NativeXComponent</span> *<span class="hljs-variable">component</span>, <span class="hljs-variable">void</span> *<span class="hljs-variable">window</span>)</li><li>{</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>, <span class="hljs-string">"OnSurfaceCreatedCB"</span>);</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">component</span> == <span class="hljs-variable">nullptr</span>) || (<span class="hljs-variable">window</span> == <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"onSurfaceCreatedCB: component or window is null"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">char</span> <span class="hljs-variable">idStr</span>[<span class="hljs-variable">OH_XCOMPONENT_ID_LEN_MAX</span> + <span class="hljs-number">1</span>] = {<span class="hljs-string">'\0'</span>};</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">idSize</span> = <span class="hljs-variable">OH_XCOMPONENT_ID_LEN_MAX</span> + <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">OH_NativeXComponent_GetXComponentId</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">idStr</span>, &amp;<span class="hljs-title class_">idSize</span>) != <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"OnSurfaceCreatedCB:Unable to get XComponent id"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">id</span>(<span class="hljs-title class_">idStr</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">render</span> = <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">GetInstance</span>(<span class="hljs-title class_">id</span>);</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">width</span>;</li><li>    <span class="hljs-variable">uint64_t</span> <span class="hljs-variable">height</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">xSize</span> = <span class="hljs-title function_">OH_NativeXComponent_GetXComponentSize</span>(<span class="hljs-variable">component</span>, <span class="hljs-variable">window</span>, &amp;<span class="hljs-title class_">width</span>, &amp;<span class="hljs-title class_">height</span>);</li><li>    <span class="hljs-keyword">if</span> ((<span class="hljs-variable">xSize</span> != <span class="hljs-variable">OH_NATIVEXCOMPONENT_RESULT_SUCCESS</span>) || (<span class="hljs-variable">render</span> == <span class="hljs-variable">nullptr</span>)) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"Callback"</span>,</li><li>                     <span class="hljs-string">"OnSurfaceCreatedCB: Unable to qet XComponent size"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OHNativeWindow</span> *&gt;(<span class="hljs-variable">window</span>);</li><li>    (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-variable">SET_BUFFER_GEOMETRY</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">width</span>),</li><li>                                                    <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">height</span>));</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">id</span> == <span class="hljs-string">"OpenGL"</span>) {</li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">openGLRenderThread_</span>-&gt;<span class="hljs-title class_">UpdateNativeWindow</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-title class_">width</span>, <span class="hljs-title class_">height</span>);</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(<span class="hljs-variable">id</span> == <span class="hljs-string">"Vulkan"</span>) {</li><li>        <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">vulkanRenderThread_</span>-&gt;<span class="hljs-title class_">UpdateNativeWindow</span>(<span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>, <span class="hljs-title class_">width</span>, <span class="hljs-title class_">height</span>);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L27-L60" target="_blank">PluginRender.cpp</a></div></div></div></div> <p>根据XComponent的NativeWindow对象，调用eglCreateWindowSurface()创建EGLSurface对象。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L129-L163" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">OpenGLRenderThread</span>::<span class="hljs-title class_">UpdateNativeWindow</span>(<span class="hljs-variable">void</span> <span class="hljs-variable">*window</span>, <span class="hljs-title class_">uint64_t</span> <span class="hljs-title class_">width</span>, <span class="hljs-title class_">uint64_t</span> <span class="hljs-title class_">height</span>)</li><li>{</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_DEBUG</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"UpdateNativeWindow."</span>);</li><li>    <span class="hljs-variable">auto</span> <span class="hljs-variable">nativeWindow</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">OHNativeWindow</span> *&gt;(<span class="hljs-variable">window</span>);</li><li>    <span class="hljs-title function_">PostTask</span>([<span class="hljs-keyword">this</span>, <span class="hljs-variable">nativeWindow</span>, <span class="hljs-variable">width</span>, <span class="hljs-variable">height</span>](<span class="hljs-variable">OpenGLRender</span> &amp;<span class="hljs-title class_">renderContext</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeWindow_</span> != <span class="hljs-variable">nativeWindow</span>) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeWindow_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>                (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeWindow_NativeObjectUnreference</span>(<span class="hljs-variable">nativeWindow_</span>);</li><li>            }</li><li>            <span class="hljs-variable">nativeWindow_</span> = <span class="hljs-variable">nativeWindow</span>;</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeWindow_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>                (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeWindow_NativeObjectReference</span>(<span class="hljs-variable">nativeWindow_</span>);</li><li>            }</li><li>
</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglSurface_</span> != <span class="hljs-variable">EGL_NO_SURFACE</span>) {</li><li>                <span class="hljs-variable">renderContext_</span>-&gt;<span class="hljs-title class_">DestroyEglSurface</span>(<span class="hljs-title class_">eglSurface_</span>);</li><li>                <span class="hljs-variable">eglSurface_</span> = <span class="hljs-variable">EGL_NO_SURFACE</span>;</li><li>                <span class="hljs-title function_">CleanGLResources</span>();</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeWindow_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>            (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeWindow_NativeWindowHandleOpt</span>(<span class="hljs-variable">nativeWindow_</span>, <span class="hljs-variable">SET_BUFFER_GEOMETRY</span>, <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">width</span>),</li><li>                                                        <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">int</span>&gt;(<span class="hljs-variable">height</span>));</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglSurface_</span> == <span class="hljs-variable">EGL_NO_SURFACE</span>) {</li><li>                <span class="hljs-variable">eglSurface_</span> = <span class="hljs-variable">renderContext_</span>-&gt;<span class="hljs-title class_">CreateEglSurface</span>(<span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">EGLNativeWindowType</span>&gt;(<span class="hljs-title class_">nativeWindow_</span>));</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">eglSurface_</span> == <span class="hljs-variable">EGL_NO_SURFACE</span>) {</li><li>                <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"xfl CreateEglSurface failed."</span>);</li><li>                <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-variable">renderContext_</span>-&gt;<span class="hljs-title class_">MakeCurrent</span>(<span class="hljs-title class_">eglSurface_</span>);</li><li>            <span class="hljs-title function_">CreateGLResources</span>();</li><li>        }</li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L129-L163" target="_blank">OpenGLRenderThread.cpp</a></div></div></div></div> </li><li>初始化视频解码的环境，包括初始化解封装器、初始化解码器。注意，解码器设置的是NativeImage的NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L154-L185" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">StartPlayer</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">SampleInfo</span> <span class="hljs-variable">sampleInfo</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">4</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFd</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileOffset</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileSize</span>);</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">length</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">char</span>* <span class="hljs-variable">buf</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">char</span>[<span class="hljs-variable">length</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">memset</span>(<span class="hljs-title class_">buf</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">buf</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">buf</span>;</li><li>    <span class="hljs-variable">PluginRender</span> *<span class="hljs-variable">render</span> = <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">GetInstance</span>(<span class="hljs-keyword">type</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">render</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> == <span class="hljs-string">"OpenGL"</span>) {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">openGLRenderThread_</span>-&gt;<span class="hljs-title class_">GetNativeImageWindow</span>();</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> == <span class="hljs-string">"Vulkan"</span>) {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">vulkanRenderThread_</span>-&gt;<span class="hljs-title class_">GetNativeImageWindow</span>();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Init</span>(<span class="hljs-title class_">sampleInfo</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L154-L185" target="_blank">PluginRender.cpp</a></div></div></div></div> </li><li>启动解码器、解码输入子线程、解码输出子线程。（代码与使用XComponent渲染一致）</li><li>通过OnNeedInputBuffer获取可用的AVBuffer后，在解码输入子线程中，将解封装器读取视频数据填充到AVBuffer中，并提交给解码器进行解码。（代码与使用XComponent渲染一致）</li><li>通过OnNeedOutputBuffer获取解码的视频数据后，在解码输出子线程中，将解码后的视频数据提交给输出Surface。（代码与使用XComponent渲染一致）</li><li>通过OH_NativeImage_AttachContext()绑定上下文，再通过OH_NativeImage_UpdateSurfaceImage()将视频图像缓存更新至OpenGL的纹理上。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L427-L473" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">OpenGLRenderThread::DrawImage</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-keyword">if</span> (nativeImageTexId_ == <span class="hljs-number">9999</span>) {</li><li>        <span class="hljs-built_in">glGenTextures</span>(<span class="hljs-number">1</span>, &amp;nativeImageTexId_);</li><li>        <span class="hljs-built_in">glBindTexture</span>(GL_TEXTURE_EXTERNAL_OES, nativeImageTexId_);</li><li>        <span class="hljs-comment">// set the texture wrapping parameters</span></li><li>        <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_EXTERNAL_OES, GL_TEXTURE_WRAP_S, GL_REPEAT);</li><li>        <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_EXTERNAL_OES, GL_TEXTURE_WRAP_T, GL_REPEAT);</li><li>        <span class="hljs-comment">// set texture filtering parameters</span></li><li>        <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_EXTERNAL_OES, GL_TEXTURE_MIN_FILTER, GL_LINEAR);</li><li>        <span class="hljs-built_in">glTexParameteri</span>(GL_TEXTURE_EXTERNAL_OES, GL_TEXTURE_MAG_FILTER, GL_LINEAR);</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"DrawImage."</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (eglSurface_ == EGL_NO_SURFACE) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_WARN, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"eglSurface_ is EGL_NO_SURFACE"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">OH_NativeImage_AttachContext</span>(nativeImage_, nativeImageTexId_);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_NativeImage_UpdateSurfaceImage</span>(nativeImage_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_UpdateSurfaceImage failed, ret: %{public}d, texId: %{public}d"</span>, ret,</li><li>                     nativeImageTexId_);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>, <span class="hljs-string">"OH_NativeImage_UpdateSurfaceImage succeed."</span>);</li><li>
</li><li>    OHNativeWindow *nativeWindow = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(nativeImage_);</li><li>    <span class="hljs-type">int32_t</span> transformTmp = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">int</span> code = NativeWindowOperation::GET_TRANSFORM;</li><li>    <span class="hljs-built_in">OH_NativeWindow_NativeWindowHandleOpt</span>(nativeWindow, code, &amp;transformTmp);</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_NativeImage_GetTransformMatrix</span>(nativeImage_, matrix_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"OpenGLRenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_GetTransformMatrix failed, ret: %{public}d"</span>, ret);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    transformTmp = <span class="hljs-number">2</span>;</li><li>    <span class="hljs-built_in">ComputeTransformByMatrix</span>(transformTmp, matrix_);</li><li>
</li><li>    <span class="hljs-built_in">DrawVideoImage</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRenderThread.cpp#L427-L473" target="_blank">OpenGLRenderThread.cpp</a></div></div></div></div> </li><li>通过eglSwapBuffers将渲染的缓存提交给XComponent的NativeWindow对象进行显示。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRender.cpp#L204-L215" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">OpenGLRender</span>::<span class="hljs-title class_">SwapBuffers</span>(<span class="hljs-title class_">EGLSurface</span> <span class="hljs-title class_">surface</span>) <span class="hljs-keyword">const</span></li><li>{</li><li>    <span class="hljs-variable">EGLBoolean</span> <span class="hljs-variable">ret</span> = <span class="hljs-title function_">eglSwapBuffers</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">surface</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> == <span class="hljs-variable">EGL_FALSE</span>) {</li><li>        <span class="hljs-variable">EGLint</span> <span class="hljs-variable">surfaceId</span> = -<span class="hljs-number">1</span>;</li><li>        <span class="hljs-title function_">eglQuerySurface</span>(<span class="hljs-variable">eglDisplay_</span>, <span class="hljs-variable">surface</span>, <span class="hljs-variable">EGL_CONFIG_ID</span>, &amp;<span class="hljs-title class_">surfaceId</span>);</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(</li><li>            <span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"EglRenderContext"</span>,</li><li>            <span class="hljs-string">"EglRenderContext::SwapBuffers: Failed to SwapBuffers on EGLSurface %{public}d, error is %{public}s."</span>,</li><li>            <span class="hljs-variable">surfaceId</span>, <span class="hljs-title function_">GetEglErrorString</span>());</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/OpenGLRender.cpp#L204-L215" target="_blank">OpenGLRender.cpp</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1051114312380">使用Vulkan渲染视频画面<i class="anchor-icon anchor-icon-link" anchorid="section1051114312380" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section98001551193918" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section98001551193918" tips="复制节点链接"></i></h3><p>Vulkan是一套用来做2D和3D渲染的图形应用程序接口，能够跨平台高效访问GPU。Vulkan提供了更细粒度的硬件控制，允许开发者更精细地管理资源和状态，从而提高性能和效率。相比之下，OpenGL的一些细节对开发者是隐藏的，在部分情况下会限制性能。在实际开发实现中，Vulkan的门槛远高于OpenGL，需要手动管理内存、渲染流程等。如果开发者对性能较高，且熟悉Vulkan，可以使用Vulkan渲染视频画面。</p> </div> <div class="tiledSection"><h3 id="section13512457193914">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section13512457193914" tips="复制节点链接"></i></h3><p>NativeImage是提供Surface关联OpenGL外部纹理的模块，表示图形队列的消费者端，有两种方式消费处理数据。第一种是将数据和OpenGL纹理对接，需在OpenGL环境下使用，此方式在使用OpenGL渲染视频画面中介绍过。另一种是开发者自行获取Buffer进行渲染处理，使用Vulkan渲染视频画面采用的是第二种方式。</p> <p>在将NativeImage的NativeWindow对象设置给解码器后，NativeImage成为了视频解码器的数据消费者。开发者可以使用OH_NativeImage_AcquireNativeWindowBuffer()从NativeImage获取NativeWindowBuffer对象，消费使用OHNativeWindowBuffer对象中的视频数据。然后，通过OH_NativeBuffer_FromNativeWindowBuffer()方法，将OHNativeWindowBuffer对象转化成NativeBuffer。最后，将NativeBuffer提交给Vulkan，Vulkan根据NativeBuffer创建ImageView对象用于后续的渲染。同时，需要注意的是，解码器解码后的图像格式通常是YUV的格式，开发者需要对数据格式进行转化，才能正常渲染显示。</p> <p>其具体实现如下所示。</p> <ol><li>启动渲染子线程，加载Vulkan的动态链接库。</li><li>创建NativeImage对象，并根据NativeImage获取NativeWindow对象。</li><li>获取XComponent的NativeWindow对象，并根据XComponent的NativeWindow对象创建Vulkan的Surface用于显示。<p><span><img height="415.5452" originheight="2009" originwidth="2572" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.76490379845058672861481213882557:50001231000000:2800:3D78229DE42F5B014223EB4C1DB01D48A73453605B0D201908CEB3FA40F0A637.jpg" title="点击放大" width="532"></span></p> </li><li>初始化视频解码的环境，包括初始化解封装器、初始化解码器。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在初始化配置解码器时，与直接使用XComponent渲染的方案不同，解码器设置Surface的入参是NativeImage的NativeWindow对象，而不是XComponent的NativeWindow对象。</p> </div></div></div> </li><li>启动解码器、解码输入子线程、解码输出子线程。</li><li>在解码输入子线程中，通过解封装器读取视频数据，并提交给解码器。</li><li>通过OnNeedOutputBuffer获取解码的视频数据后，在解码输出子线程中，将解码后的视频数据提交给输出Surface（当前Surface为NativeImage的NativeWindow对象）。</li><li>在NativeImage的回调onFrameAvailable()有可用数据后，通过OH_NativeImage_AcquireNativeWindowBuffer()获取视频数据，并通过OH_NativeBuffer_FromNativeWindowBuffer()转化为NativeBuffer的类型。</li><li>Vulkan根据NativeBuffer创建对应的ImageView用于采样，同时，创建对应格式的采样器，通过采样器将YUV格式的图像转化成RGBA的图像，最后，通过渲染管道进行显示。<p><span><img height="414.96000000000004" originheight="2106" originwidth="2700" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163031.21311076757762168844273957456175:50001231000000:2800:8A7E7CA569AF6B06CC92BC586EB593CC518CDEC12629D6DC4305B552FD87E511.jpg" title="点击放大" width="532"></span></p> </li></ol> </div> <div class="tiledSection"><h3 id="section9627315405">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section9627315405" tips="复制节点链接"></i></h3><ol><li>启动渲染子线程，加载Vulkan的动态链接库。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L175-L210" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRenderThread</span>::<span class="hljs-title class_">ThreadMainLoop</span>() {</li><li>    <span class="hljs-variable">threadId_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">get_id</span>();</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitRenderContext</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">InitNativeVsync</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">CreateNativeImage</span>()) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-variable">running_</span>) {</li><li>        {</li><li>            <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"Waiting for Vsync."</span>);</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">Lock</span>(<span class="hljs-title class_">wakeUpMutex_</span>);</li><li>            <span class="hljs-variable">wakeUpCond_</span>.<span class="hljs-title function_">wait</span>(<span class="hljs-variable">Lock</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> <span class="hljs-variable">wakeup_</span> || <span class="hljs-variable">vSyncCnt_</span> &gt; <span class="hljs-number">0</span> || <span class="hljs-variable">availableFrameCnt_</span> &gt; <span class="hljs-number">0</span>; });</li><li>            <span class="hljs-variable">wakeup_</span> = <span class="hljs-keyword">false</span>;</li><li>            <span class="hljs-variable">vSyncCnt_</span>--;</li><li>            (<span class="hljs-variable">void</span>)<span class="hljs-title function_">OH_NativeVSync_RequestFrame</span>(<span class="hljs-variable">nativeVsync_</span>, &amp;<span class="hljs-title class_">VulkanRenderThread</span>::<span class="hljs-title class_">OnVsync</span>, <span class="hljs-keyword">this</span>);</li><li>        }</li><li>
</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">VulkanRenderTask</span>&gt; <span class="hljs-title class_">tasks</span>;</li><li>        {</li><li>            <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">taskMutex_</span>);</li><li>            <span class="hljs-variable">tasks</span>.<span class="hljs-title function_">swap</span>(<span class="hljs-variable">tasks_</span>);</li><li>        }</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-variable">auto</span> &amp;<span class="hljs-title class_">task</span> : <span class="hljs-title class_">tasks</span>) {</li><li>            <span class="hljs-title function_">task</span>(*<span class="hljs-variable">vulkanRenderContext_</span>);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">availableFrameCnt_</span> &lt;= <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-keyword">continue</span>;</li><li>        }</li><li>        <span class="hljs-title function_">DrawImage</span>();</li><li>        <span class="hljs-variable">availableFrameCnt_</span>--;</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L175-L210" target="_blank">VulkanRenderThread.cpp</a></div></div></div></div> <p>动态加载libvulkan.so，并加载Vulkan基础函数的指针。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/utils/src/VulkanUtils.cpp#L149-L170" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Dynamically load Vulkan library and base function pointers</span></li><li><span class="hljs-variable">bool</span> <span class="hljs-title function_">LoadVulkanLibrary</span>() {</li><li>    <span class="hljs-comment">// Load vulkan library</span></li><li>    <span class="hljs-variable">constexpr</span> <span class="hljs-variable">char</span> *<span class="hljs-variable">path</span> = <span class="hljs-string">"libvulkan.so"</span>;</li><li>    <span class="hljs-title function_">dlerror</span>();</li><li>    <span class="hljs-variable">g_libVulkan</span> = <span class="hljs-title function_">dlopen</span>(<span class="hljs-variable">path</span>, <span class="hljs-variable">RTLD_NOW</span> | <span class="hljs-variable">RTLD_LOCAL</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">g_libVulkan</span>) {</li><li>        <span class="hljs-title function_">OH_LOG_ERROR</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"Failed to load vulkan Library, %{public}s"</span>, <span class="hljs-title function_">dlerror</span>());</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// // Load base function pointers</span></li><li>    <span class="hljs-variable">vkEnumerateInstanceExtensionProperties</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkEnumerateInstanceExtensionProperties</span>&gt;(</li><li>        <span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkEnumerateInstanceExtensionProperties"</span>));</li><li>    <span class="hljs-variable">vkEnumerateInstanceLayerProperties</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkEnumerateInstanceLayerProperties</span>&gt;(</li><li>        <span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkEnumerateInstanceLayerProperties"</span>));</li><li>    <span class="hljs-variable">vkCreateInstance</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkCreateInstance</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkCreateInstance"</span>));</li><li>    <span class="hljs-variable">vkGetInstanceProcAddr</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkGetInstanceProcAddr</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkGetInstanceProcAddr"</span>));</li><li>    <span class="hljs-variable">vkGetDeviceProcAddr</span> = <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">PFN_vkGetDeviceProcAddr</span>&gt;(<span class="hljs-title function_">dlsym</span>(<span class="hljs-variable">g_libVulkan</span>, <span class="hljs-string">"vkGetDeviceProcAddr"</span>));</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/utils/src/VulkanUtils.cpp#L149-L170" target="_blank">VulkanUtils.cpp</a></div></div></div></div> </li><li>创建NativeImage对象，并根据NativeImage获取NativeWindow对象。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L136-L163" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulkanRenderThread::CreateNativeImage</span><span class="hljs-params">()</span> </span>{</li><li>    nativeImage_ = <span class="hljs-built_in">OH_NativeImage_Create</span>(<span class="hljs-number">-1</span>, GL_TEXTURE_EXTERNAL_OES);</li><li>    <span class="hljs-keyword">if</span> (nativeImage_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"OH_NativeImage_Create failed."</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-number">0</span>;</li><li>    {</li><li>        <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">Lock</span><span class="hljs-params">(nativeImageSurfaceIdMutex_)</span></span>;</li><li>        nativeImageWindow_ = <span class="hljs-built_in">OH_NativeImage_AcquireNativeWindow</span>(nativeImage_);</li><li>        ret = <span class="hljs-built_in">OH_NativeImage_GetSurfaceId</span>(nativeImage_, &amp;nativeImageSurfaceId_);</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_GetSurfaceId failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>
</li><li>    nativeImageFrameAvailableListener_.context = <span class="hljs-keyword">this</span>;</li><li>    nativeImageFrameAvailableListener_.onFrameAvailable = &amp;VulkanRenderThread::OnNativeImageFrameAvailable;</li><li>    ret = <span class="hljs-built_in">OH_NativeImage_SetOnFrameAvailableListener</span>(nativeImage_, nativeImageFrameAvailableListener_);</li><li>    <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>,</li><li>                     <span class="hljs-string">"OH_NativeImage_SetonFrameAvailableListener failed, ret is %{public}d."</span>, ret);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L136-L163" target="_blank">VulkanRenderThread.cpp</a></div></div></div></div> </li><li>在获取XComponent的NativeWindow对象后，根据XComponent的NativeWindow对象创建Vulkan的Surface。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L61-L78" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">VulkanRenderThread::UpdateNativeWindow</span><span class="hljs-params">(<span class="hljs-type">void</span> *window, <span class="hljs-type">uint64_t</span> width, <span class="hljs-type">uint64_t</span> height)</span> </span>{</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_DEBUG, LOG_PRINT_DOMAIN, <span class="hljs-string">"RenderThread"</span>, <span class="hljs-string">"UpdateNativeWindow."</span>);</li><li>    <span class="hljs-keyword">auto</span> nativeWindow = <span class="hljs-built_in">reinterpret_cast</span>&lt;OHNativeWindow *&gt;(window);</li><li>    <span class="hljs-built_in">PostTask</span>([<span class="hljs-keyword">this</span>, nativeWindow, width, height](VulkanRender &amp;renderContext) {</li><li>        <span class="hljs-keyword">if</span> (nativeWindow_ != nativeWindow) {</li><li>            <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>                (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_NativeWindow_NativeObjectUnreference</span>(nativeWindow_);</li><li>            }</li><li>            nativeWindow_ = nativeWindow;</li><li>            <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>                (<span class="hljs-type">void</span>)<span class="hljs-built_in">OH_NativeWindow_NativeObjectReference</span>(nativeWindow_);</li><li>            }</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (nativeWindow_ != <span class="hljs-literal">nullptr</span>) {</li><li>            vulkanRenderContext_-&gt;<span class="hljs-built_in">SetupWindow</span>(nativeWindow_);</li><li>        }</li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L61-L78" target="_blank">VulkanRenderThread.cpp</a></div></div></div></div> <p>设置Vulkan的Surface，同时更新初始化Vulkan的上下文，包括Vulkan的实例、选择物理设备、加载Vulkan的方法等。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L45-L60" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRender</span>::<span class="hljs-title class_">SetupWindow</span>(<span class="hljs-variable">NativeWindow</span> <span class="hljs-variable">*nativeWindow</span>) {</li><li>    <span class="hljs-variable">nativeWindow_</span> = <span class="hljs-variable">nativeWindow</span>;</li><li>    <span class="hljs-title function_">CreateInstance</span>();</li><li>    <span class="hljs-variable">vkExample</span>::<span class="hljs-title class_">utils</span>::<span class="hljs-title class_">LoadVulkanFunctions</span>(<span class="hljs-title class_">instance</span>);</li><li>    <span class="hljs-title function_">CreateSurface</span>();</li><li>    <span class="hljs-title function_">PickPhysicalDevice</span>();</li><li>    <span class="hljs-title function_">CreateLogicalDevice</span>();</li><li>    <span class="hljs-variable">vkExample</span>::<span class="hljs-title class_">utils</span>::<span class="hljs-title class_">LoadVulkanFunctions</span>(<span class="hljs-title class_">device</span>);</li><li>
</li><li>    <span class="hljs-title function_">createSwapChain</span>();</li><li>    <span class="hljs-title function_">createRenderPass</span>();</li><li>    <span class="hljs-title function_">createFrameBuffersAndImages</span>();</li><li>    <span class="hljs-title function_">createVertexBuffer</span>();</li><li>    <span class="hljs-title function_">createUniformBuffer</span>();</li><li>    <span class="hljs-variable">deviceInfoInitialized</span> = <span class="hljs-keyword">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L45-L60" target="_blank">VulkanRender.cpp</a></div></div></div></div> <p>通过vkCreateSurfaceOHOS()创建Surface对象。</p> <div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L119-L131" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">VulkanRender::CreateSurface</span><span class="hljs-params">()</span> </span>{</li><li>    VkSurfaceCreateInfoOHOS surfaceCreateInfo{};</li><li>    surfaceCreateInfo.sType = VK_STRUCTURE_TYPE_SURFACE_CREATE_INFO_OHOS;</li><li>    <span class="hljs-keyword">if</span> (nativeWindow_ == <span class="hljs-literal">nullptr</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_INFO</span>(LOG_APP, <span class="hljs-string">"nativeWindow_ is nulptr.Failed to create surface !"</span>);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    surfaceCreateInfo.window = nativeWindow_;</li><li>    surfaceCreateInfo.flags = <span class="hljs-number">0</span>;</li><li>    surfaceCreateInfo.pNext = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">bool</span> res = <span class="hljs-built_in">CheckResult</span>(<span class="hljs-built_in">vkCreateSurfaceOHOS</span>(instance, &amp;surfaceCreateInfo, <span class="hljs-literal">nullptr</span>, &amp;surface));</li><li>    <span class="hljs-keyword">return</span> res;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L119-L131" target="_blank">VulkanRender.cpp</a></div></div></div></div> </li><li>初始化视频解码的环境，包括初始化解封装器、初始化解码器。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L154-L185" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">napi_value</span> <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">StartPlayer</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_callback_info</span> <span class="hljs-title class_">info</span>)</li><li>{</li><li>    <span class="hljs-variable">SampleInfo</span> <span class="hljs-variable">sampleInfo</span>;</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">4</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>[<span class="hljs-number">4</span>] = {<span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">0</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFd</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">1</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileOffset</span>);</li><li>    <span class="hljs-title function_">napi_get_value_int64</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">2</span>], &amp;<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-variable">inputFileSize</span>);</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">length</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable">napi_status</span> <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">char</span>* <span class="hljs-variable">buf</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">char</span>[<span class="hljs-variable">length</span> + <span class="hljs-number">1</span>];</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">memset</span>(<span class="hljs-title class_">buf</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-variable">status</span> = <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>[<span class="hljs-number">3</span>], <span class="hljs-variable">buf</span>, <span class="hljs-variable">length</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">length</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-keyword">type</span> = <span class="hljs-variable">buf</span>;</li><li>    <span class="hljs-variable">PluginRender</span> *<span class="hljs-variable">render</span> = <span class="hljs-variable">PluginRender</span>::<span class="hljs-title class_">GetInstance</span>(<span class="hljs-keyword">type</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">render</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> == <span class="hljs-string">"OpenGL"</span>) {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">openGLRenderThread_</span>-&gt;<span class="hljs-title class_">GetNativeImageWindow</span>();</li><li>        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> == <span class="hljs-string">"Vulkan"</span>) {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">vulkanRenderThread_</span>-&gt;<span class="hljs-title class_">GetNativeImageWindow</span>();</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">window</span> = <span class="hljs-variable">render</span>-&gt;<span class="hljs-title class_">nativeWindow</span>;</li><li>        }</li><li>    }</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Init</span>(<span class="hljs-title class_">sampleInfo</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>    }</li><li>    <span class="hljs-variable">Player</span>::<span class="hljs-title class_">GetInstance</span>().<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/PluginRender.cpp#L154-L185" target="_blank">PluginRender.cpp</a></div></div></div></div> </li><li>启动解码器、解码输入子线程、解码输出子线程。（代码与使用XComponent渲染一致）</li><li>在解码输入子线程中，通过解封装器读取视频数据，并提交给解码器。（代码与使用XComponent渲染一致）</li><li>在解码输出子线程中，将解码后的视频数据提交给输出Surface。（代码与使用XComponent渲染一致）</li><li>在NativeImage有可用数据后，通过OH_NativeImage_AcquireNativeWindowBuffer()获取视频数据，并通过OH_NativeBuffer_FromNativeWindowBuffer()转化为NativeBuffer的类型。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L286-L311" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRenderThread</span>::<span class="hljs-title class_">DrawImage</span>() {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"DrawImage."</span>);</li><li>    <span class="hljs-variable">int</span> <span class="hljs-variable">ret</span>;</li><li>    <span class="hljs-variable">OHNativeWindowBuffer</span> *<span class="hljs-variable">inBuffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">OH_NativeBuffer</span> *<span class="hljs-variable">nativeBuffer</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">fenceFd1</span> = -<span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_AcquireNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, &amp;<span class="hljs-title class_">inBuffer</span>, &amp;<span class="hljs-title class_">fenceFd1</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeWindow_NativeObjectReference</span>(<span class="hljs-variable">inBuffer</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeBuffer_FromNativeWindowBuffer</span>(<span class="hljs-variable">inBuffer</span>, &amp;<span class="hljs-title class_">nativeBuffer</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nativeBuffer</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_NativeWindow_NativeObjectUnreference</span>(<span class="hljs-variable">inBuffer</span>);</li><li>        <span class="hljs-title function_">OH_NativeImage_ReleaseNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">inBuffer</span>, -<span class="hljs-number">1</span>);</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"nativeBuffer is null."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-title function_">OH_NativeImage_GetTransformMatrix</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">matrix_</span>);</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">transformTmp</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">ComputeTransform</span>(<span class="hljs-variable">transformTmp</span>, <span class="hljs-variable">matrix_</span>);</li><li>    <span class="hljs-variable">vulkanRenderContext_</span>-&gt;<span class="hljs-title class_">hwBufferToTexture</span>(<span class="hljs-title class_">nativeBuffer</span>, <span class="hljs-title class_">matrix_</span>);</li><li>    <span class="hljs-variable">vulkanRenderContext_</span>-&gt;<span class="hljs-title class_">render</span>();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">lastInBuffer_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">OH_NativeWindow_NativeObjectUnreference</span>(<span class="hljs-variable">lastInBuffer_</span>);</li><li>        <span class="hljs-title function_">OH_NativeImage_ReleaseNativeWindowBuffer</span>(<span class="hljs-variable">nativeImage_</span>, <span class="hljs-variable">lastInBuffer_</span>, -<span class="hljs-number">1</span>);</li><li>    }</li><li>    <span class="hljs-variable">lastInBuffer_</span> = <span class="hljs-variable">inBuffer</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRenderThread.cpp#L286-L311" target="_blank">VulkanRenderThread.cpp</a></div></div></div></div> </li><li>Vulkan根据NativeBuffer创建对应的ImageView用于渲染显示，同时，创建对应格式的采样器，将YUV格式的图像转化成RGBA的图像，用于正确的渲染显示。<div class="screenLinkPre"><div _ngcontent-gco-c106="" class="highlight-div"><div _ngcontent-gco-c106="" class="highlight-div-header"><div _ngcontent-gco-c106="" class="highlight-div-header-left"><div _ngcontent-gco-c106="" class="handle-button expand-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gco-c106="" class="highlight-div-header-right"><div _ngcontent-gco-c106="" class="handle-button ai-button"></div><div _ngcontent-gco-c106="" class="handle-button line-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gco-c106="" class="handle-button theme-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gco-c106="" class="handle-button copy-button"><div _ngcontent-gco-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gco-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L796-L996" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">VulkanRender</span>::<span class="hljs-title class_">hwBufferToTexture</span>(<span class="hljs-variable">OH_NativeBuffer</span> <span class="hljs-variable">*buffer</span>, <span class="hljs-title class_">float</span> <span class="hljs-title class_">transformMatrix</span>[<span class="hljs-number">16</span>]) {</li><li>    <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_INFO</span>, <span class="hljs-number">0xFF00</span>, <span class="hljs-string">"VulkanRenderThread"</span>, <span class="hljs-string">"hwBufferToTexture."</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">deviceInfoInitialized</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">UniformBufferObject</span> <span class="hljs-variable">ubo</span>{};</li><li>    <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">ubo</span>.<span class="hljs-variable">mvp</span>, <span class="hljs-variable">transformMatrix</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">float</span>) * <span class="hljs-number">16</span>);</li><li>    <span class="hljs-title function_">memcpy</span>(<span class="hljs-variable">buffersInfo</span>.<span class="hljs-variable">uniformBufferMapped</span>, &amp;<span class="hljs-title class_">ubo</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">ubo</span>));</li><li>    <span class="hljs-variable">VkNativeBufferFormatPropertiesOHOS</span> <span class="hljs-variable">nbFormatProps</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_NATIVE_BUFFER_FORMAT_PROPERTIES_OHOS</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span></li><li>    };</li><li>    <span class="hljs-variable">VkNativeBufferPropertiesOHOS</span> <span class="hljs-variable">nbProps</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_NATIVE_BUFFER_PROPERTIES_OHOS</span>,</li><li>                                            .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">nbFormatProps</span>};</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkGetNativeBufferPropertiesOHOS</span>(<span class="hljs-variable">device</span>, <span class="hljs-variable">buffer</span>, &amp;<span class="hljs-title class_">nbProps</span>));</li><li>
</li><li>    <span class="hljs-variable">VkImportNativeBufferInfoOHOS</span> <span class="hljs-variable">importBufferInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMPORT_NATIVE_BUFFER_INFO_OHOS</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>,</li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">buffer</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkMemoryDedicatedAllocateInfo</span> <span class="hljs-variable">dedicatedAllocateInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_MEMORY_DEDICATED_ALLOCATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">importBufferInfo</span>,</li><li>        .<span class="hljs-variable">image</span> = <span class="hljs-variable">VK_NULL_HANDLE</span>, <span class="hljs-comment">// wiLl be set later</span></li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">VK_NULL_HANDLE</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkPhysicalDeviceMemoryProperties</span> <span class="hljs-variable">physicalDeviceMemProps</span>;</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">foundTypeIndex</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-title function_">vkGetPhysicalDeviceMemoryProperties</span>(<span class="hljs-variable">gpuDevice</span>, &amp;<span class="hljs-title class_">physicalDeviceMemProps</span>);</li><li>    <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">memTypeCnt</span> = <span class="hljs-variable">physicalDeviceMemProps</span>.<span class="hljs-variable">memoryTypeCount</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">uint32_t</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">memTypeCnt</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbProps</span>.<span class="hljs-variable">memoryTypeBits</span> &amp; (<span class="hljs-number">1</span> &lt;&lt; <span class="hljs-variable">i</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">VkPhysicalDeviceMemoryProperties</span> &amp;<span class="hljs-title class_">pdmp</span> = <span class="hljs-variable">physicalDeviceMemProps</span>;</li><li>            <span class="hljs-variable">uint32_t</span> <span class="hljs-variable">supportedFLags</span> = <span class="hljs-variable">pdmp</span>.<span class="hljs-variable">memoryTypes</span>[<span class="hljs-variable">i</span>].<span class="hljs-variable">propertyFlags</span> &amp; <span class="hljs-title class_">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>;</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">supportedFLags</span> == <span class="hljs-variable">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>) {</li><li>                <span class="hljs-variable">foundTypeIndex</span> = <span class="hljs-variable">i</span>;</li><li>                <span class="hljs-keyword">break</span>;</li><li>            }</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">VkMemoryAllocateInfo</span> <span class="hljs-variable">allocInfo</span>{</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_MEMORY_ALLOCATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">dedicatedAllocateInfo</span>,</li><li>        .<span class="hljs-variable">allocationSize</span> = <span class="hljs-variable">nbProps</span>.<span class="hljs-variable">allocationSize</span>,</li><li>        .<span class="hljs-variable">memoryTypeIndex</span> = <span class="hljs-number">0</span> <span class="hljs-comment">// Memory type assigned in the next step</span></li><li>    };</li><li>
</li><li>    <span class="hljs-title function_">mapMemoryTypeToIndex</span>(<span class="hljs-variable">nbProps</span>.<span class="hljs-variable">memoryTypeBits</span>, <span class="hljs-variable">VK_MEMORY_PROPERTY_DEVICE_LOCAL_BIT</span>, &amp;<span class="hljs-title class_">allocInfo</span>.<span class="hljs-variable">memoryTypeIndex</span>);</li><li>    <span class="hljs-variable">VkExternalFormatOHOS</span> <span class="hljs-variable">externalFormat</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_EXTERNAL_FORMAT_OHOS</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>;</li><li>    <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">externalFormat</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> == <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">externalFormat</span>.<span class="hljs-variable">externalFormat</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">externalFormat</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">VkExternalMemoryImageCreateInfo</span> <span class="hljs-variable">externalMemoryImageInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_EXTERNAL_MEMORY_IMAGE_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalFormat</span>,</li><li>        .<span class="hljs-variable">handleTypes</span> = <span class="hljs-variable">VK_EXTERNAL_MEMORY_HANDLE_TYPE_OHOS_NATIVE_BUFFER_BIT_OHOS</span>,</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkImageUsageFlags</span> <span class="hljs-variable">usageFlags</span> = <span class="hljs-variable">VK_IMAGE_USAGE_SAMPLED_BIT</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> != <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">usageFlags</span> = <span class="hljs-variable">usageFlags</span> | <span class="hljs-variable">VK_IMAGE_USAGE_TRANSFER_SRC_BIT</span> | <span class="hljs-variable">VK_IMAGE_USAGE_TRANSFER_DST_BIT</span> |</li><li>                     <span class="hljs-variable">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT</span> | <span class="hljs-variable">VK_IMAGE_USAGE_INPUT_ATTACHMENT_BIT</span>;</li><li>    }</li><li>    <span class="hljs-variable">OH_NativeBuffer_Config</span> <span class="hljs-variable">config</span>;</li><li>    <span class="hljs-title function_">OH_NativeBuffer_GetConfig</span>(<span class="hljs-variable">buffer</span>, &amp;<span class="hljs-title class_">config</span>);</li><li>    <span class="hljs-variable">VkImageCreateInfo</span> <span class="hljs-variable">image_create_info</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMAGE_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalMemoryImageInfo</span>,</li><li>        .<span class="hljs-variable">flags</span> = <span class="hljs-number">0</span>,</li><li>        .<span class="hljs-variable">imageType</span> = <span class="hljs-variable">VK_IMAGE_TYPE_2D</span>,</li><li>        .<span class="hljs-variable">format</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span>,</li><li>        .<span class="hljs-variable">extent</span> = {<span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span>&gt;(<span class="hljs-variable">config</span>.<span class="hljs-variable">width</span>), <span class="hljs-title class_">static_cast</span>&lt;<span class="hljs-title class_">uint32_t</span>&gt;(<span class="hljs-variable">config</span>.<span class="hljs-variable">height</span>), <span class="hljs-number">1</span>},</li><li>        .<span class="hljs-variable">mipLevels</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">arrayLayers</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">samples</span> = <span class="hljs-variable">VK_SAMPLE_COUNT_1_BIT</span>,</li><li>        .<span class="hljs-variable">tiling</span> = <span class="hljs-variable">VK_IMAGE_TILING_OPTIMAL</span>,</li><li>        .<span class="hljs-variable">usage</span> = <span class="hljs-variable">usageFlags</span>,</li><li>        .<span class="hljs-variable">sharingMode</span> = <span class="hljs-variable">VK_SHARING_MODE_EXCLUSIVE</span>,</li><li>        .<span class="hljs-variable">queueFamilyIndexCount</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">pQueueFamilyIndices</span> = &amp;<span class="hljs-title class_">queueFamilyIndex_</span>,</li><li>        <span class="hljs-comment">// VK_IMAGE_LAYOUT_UNDEFINED is mandatory when using external memory</span></li><li>        .<span class="hljs-variable">initialLayout</span> = <span class="hljs-variable">VK_IMAGE_LAYOUT_UNDEFINED</span></li><li>    };</li><li>
</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateImage</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">image_create_info</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureImage</span>));</li><li>    <span class="hljs-variable">dedicatedAllocateInfo</span>.<span class="hljs-variable">image</span> = <span class="hljs-variable">externalTextureImage</span>;</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkAllocateMemory</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">allocInfo</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureMemory</span>));</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkBindImageMemory</span>(<span class="hljs-variable">device</span>, <span class="hljs-variable">externalTextureImage</span>, <span class="hljs-variable">externalTextureMemory</span>, <span class="hljs-number">0</span>));</li><li>
</li><li>    <span class="hljs-variable">VkSamplerYcbcrConversionCreateInfo</span> <span class="hljs-variable">ycbcrCreateInfo</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_YCBCR_CONVERSION_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">ycbcrRange</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYcbcrRange</span>,</li><li>        .<span class="hljs-variable">components</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">samplerYcbcrConversionComponents</span>,</li><li>        .<span class="hljs-variable">xChromaOffset</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedXChromaOffset</span>,</li><li>        .<span class="hljs-variable">yChromaOffset</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYChromaOffset</span>,</li><li>        .<span class="hljs-variable">chromaFilter</span> = <span class="hljs-variable">VK_FILTER_LINEAR</span>,</li><li>        .<span class="hljs-variable">forceExplicitReconstruction</span> = <span class="hljs-keyword">false</span></li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span> == <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>) {</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">externalFormat</span>;</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">format</span> = <span class="hljs-variable">VK_FORMAT_UNDEFINED</span>;</li><li>        <span class="hljs-variable">ycbcrCreateInfo</span>.<span class="hljs-variable">ycbcrModel</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">suggestedYcbcrModel</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">CheckResult</span>(</li><li>        <span class="hljs-title function_">vkCreateSamplerYcbcrConversion</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">ycbcrCreateInfo</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">ycbcrConversion</span>));</li><li>
</li><li>    <span class="hljs-variable">VkSamplerYcbcrConversionInfo</span> <span class="hljs-variable">convInfoWrap</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_YCBCR_CONVERSION_INFO</span>,</li><li>        .<span class="hljs-variable">conversion</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">ycbcrConversion</span>,</li><li>        .<span class="hljs-variable">pNext</span> = <span class="hljs-variable">nullptr</span>,</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkImageViewCreateInfo</span> <span class="hljs-variable">view</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_IMAGE_VIEW_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">convInfoWrap</span>,</li><li>        .<span class="hljs-variable">flags</span> = <span class="hljs-number">0</span>,</li><li>        .<span class="hljs-variable">image</span> = <span class="hljs-variable">externalTextureImage</span>,</li><li>        .<span class="hljs-variable">viewType</span> = <span class="hljs-variable">VK_IMAGE_VIEW_TYPE_2D</span>,</li><li>        .<span class="hljs-variable">format</span> = <span class="hljs-variable">nbFormatProps</span>.<span class="hljs-variable">format</span>,</li><li>        .<span class="hljs-variable">components</span> =</li><li>            {</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span>,</li><li>                <span class="hljs-variable">VK_COMPONENT_SWIZZLE_IDENTITY</span></li><li>            },</li><li>        .<span class="hljs-variable">subresourceRange</span> = {<span class="hljs-variable">VK_IMAGE_ASPECT_COLOR_BIT</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>},</li><li>    };</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateImageView</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">view</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">view</span>));</li><li>
</li><li>    <span class="hljs-comment">// Create sampler</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">VkSamplerCreateInfo</span> <span class="hljs-variable">sampler</span> = {</li><li>        .<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_SAMPLER_CREATE_INFO</span>,</li><li>        .<span class="hljs-variable">pNext</span> = &amp;<span class="hljs-title class_">convInfoWrap</span>,</li><li>        .<span class="hljs-variable">magFilter</span> = <span class="hljs-variable">VK_FILTER_NEAREST</span>,</li><li>        .<span class="hljs-variable">minFilter</span> = <span class="hljs-variable">VK_FILTER_NEAREST</span>,</li><li>        .<span class="hljs-variable">mipmapMode</span> = <span class="hljs-variable">VK_SAMPLER_MIPMAP_MODE_NEAREST</span>,</li><li>        .<span class="hljs-variable">addressModeU</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">addressModeV</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">addressModeW</span> = <span class="hljs-variable">VK_SAMPLER_ADDRESS_MODE_CLAMP_TO_EDGE</span>,</li><li>        .<span class="hljs-variable">mipLodBias</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">compareEnable</span> = <span class="hljs-variable">VK_FALSE</span>,</li><li>        .<span class="hljs-variable">anisotropyEnable</span> = <span class="hljs-variable">VK_FALSE</span>,</li><li>        .<span class="hljs-variable">maxAnisotropy</span> = <span class="hljs-number">1</span>,</li><li>        .<span class="hljs-variable">compareOp</span> = <span class="hljs-variable">VK_COMPARE_OP_NEVER</span>,</li><li>        .<span class="hljs-variable">minLod</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">maxLod</span> = <span class="hljs-number">0.0</span><span class="hljs-variable">f</span>,</li><li>        .<span class="hljs-variable">borderColor</span> = <span class="hljs-variable">VK_BORDER_COLOR_FLOAT_OPAQUE_WHITE</span>,</li><li>        .<span class="hljs-variable">unnormalizedCoordinates</span> = <span class="hljs-variable">VK_FALSE</span></li><li>    };</li><li>    <span class="hljs-title function_">CheckResult</span>(<span class="hljs-title function_">vkCreateSampler</span>(<span class="hljs-variable">device</span>, &amp;<span class="hljs-title class_">sampler</span>, <span class="hljs-variable">nullptr</span>, &amp;<span class="hljs-title class_">externalTextureInfo</span>.<span class="hljs-variable">sampler</span>));</li><li>
</li><li>    <span class="hljs-title function_">createDescriptorSetLayout</span>();</li><li>    <span class="hljs-title function_">createDescriptorSet</span>();</li><li>
</li><li>    <span class="hljs-variable">VkDescriptorImageInfo</span> <span class="hljs-variable">imageInfo</span> = {</li><li>        .<span class="hljs-variable">sampler</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">sampler</span>,</li><li>        .<span class="hljs-variable">imageView</span> = <span class="hljs-variable">externalTextureInfo</span>.<span class="hljs-variable">view</span>,</li><li>        .<span class="hljs-variable">imageLayout</span> = <span class="hljs-variable">VK_IMAGE_LAYOUT_SHADER_READ_ONLY_OPTIMAL</span></li><li>    };</li><li>
</li><li>    <span class="hljs-variable">VkDescriptorBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = {</li><li>        .<span class="hljs-variable">buffer</span> = <span class="hljs-variable">buffersInfo</span>.<span class="hljs-variable">uniformBuf</span>, .<span class="hljs-variable">offset</span> = <span class="hljs-number">0</span>, .<span class="hljs-variable">range</span> = <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">UniformBufferObject</span>)};</li><li>    <span class="hljs-variable">VkWriteDescriptorSet</span> <span class="hljs-variable">bufferWrite</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET</span>,</li><li>                                        .<span class="hljs-variable">dstSet</span> = <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descSet</span>,</li><li>                                        .<span class="hljs-variable">dstBinding</span> = <span class="hljs-number">0</span>,</li><li>                                        .<span class="hljs-variable">dstArrayElement</span> = <span class="hljs-number">0</span>,</li><li>                                        .<span class="hljs-variable">descriptorCount</span> = <span class="hljs-number">1</span>,</li><li>                                        .<span class="hljs-variable">descriptorType</span> = <span class="hljs-variable">VK_DESCRIPTOR_TYPE_UNIFORM_BUFFER</span>,</li><li>                                        .<span class="hljs-variable">pImageInfo</span> = <span class="hljs-variable">nullptr</span>,</li><li>                                        .<span class="hljs-variable">pBufferInfo</span> = &amp;<span class="hljs-title class_">bufferInfo</span>,</li><li>                                        .<span class="hljs-variable">pTexelBufferView</span> = <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">VkWriteDescriptorSet</span> <span class="hljs-variable">imageWrite</span> = {.<span class="hljs-variable">sType</span> = <span class="hljs-variable">VK_STRUCTURE_TYPE_WRITE_DESCRIPTOR_SET</span>,</li><li>                                       .<span class="hljs-variable">dstSet</span> = <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descSet</span>,</li><li>                                       .<span class="hljs-variable">dstBinding</span> = <span class="hljs-number">1</span>,</li><li>                                       .<span class="hljs-variable">dstArrayElement</span> = <span class="hljs-number">0</span>,</li><li>                                       .<span class="hljs-variable">descriptorCount</span> = <span class="hljs-number">1</span>,</li><li>                                       .<span class="hljs-variable">descriptorType</span> = <span class="hljs-variable">VK_DESCRIPTOR_TYPE_COMBINED_IMAGE_SAMPLER</span>,</li><li>                                       .<span class="hljs-variable">pImageInfo</span> = &amp;<span class="hljs-title class_">imageInfo</span>,</li><li>                                       .<span class="hljs-variable">pBufferInfo</span> = <span class="hljs-variable">nullptr</span>,</li><li>                                       .<span class="hljs-variable">pTexelBufferView</span> = <span class="hljs-variable">nullptr</span>};</li><li>    <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>[<span class="hljs-number">0</span>] = <span class="hljs-variable">bufferWrite</span>;</li><li>    <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>[<span class="hljs-number">1</span>] = <span class="hljs-variable">imageWrite</span>;</li><li>    <span class="hljs-title function_">vkUpdateDescriptorSets</span>(<span class="hljs-variable">device</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">gfxPipelineInfo</span>.<span class="hljs-variable">descWrites</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-title function_">createGraphicsPipeline</span>();</li><li>    <span class="hljs-title function_">createOtherStaff</span>();</li><li>
</li><li>    <span class="hljs-title function_">recordCommandBuffer</span>();</li><li>    <span class="hljs-title function_">OH_LOG_INFO</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-string">"hwBufferToTexture end"</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/video-render/blob/master/entry/src/main/cpp/render/src/VulkanRender.cpp#L796-L996" target="_blank">VulkanRender.cpp</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section347482071312">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section347482071312" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/video-render" target="_blank">渲染视频数据</a></li></ul> </div> </div> <div></div></div>