<h1 _ngcontent-fys-c119="" class="doc-title ng-star-inserted" title="状态管理最佳实践"> 状态管理最佳实践 </h1>

<div _ngcontent-fys-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section198559428403">概述<i class="anchor-icon anchor-icon-link" anchorid="section198559428403" tips="复制节点链接"></i></h2><p>在声明式UI编程范式中，UI是应用程序状态的函数，应用程序状态的修改会更新相应的UI界面。ArkUI采用了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-mvvm" target="_blank">MVVM</a>模式，其中ViewModel将数据与视图绑定在一起，更新数据的时候直接更新视图。如下图所示：</p> <div class="fignone"><span class="figcap"><b>图1 </b>ArkUI的MVVM模式</span></div> <p><span><img height="96.38616400000001" originheight="440" originwidth="3214" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.38662726484394972746139856933464:50001231000000:2800:7212FE669A1811C4D2FCF9F095548D4300891207AA6E345CACF8EBDBBD0708FA.png" title="点击放大" width="657.3525000000001"></span></p> <p>ArkUI提供了一系列装饰器实现ViewModel的能力，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop" target="_blank">@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link" target="_blank">@Link</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume" target="_blank">@Provide</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage" target="_blank">LocalStorage</a>等。当自定义组件内变量被装饰器装饰时变为状态变量，状态变量的改变会引起UI的渲染刷新。</p> <p>在ArkUI的开发过程中，如果没有选择合适的装饰器或合理的控制状态更新范围，可能会导致以下问题：</p> <p>1. 状态和UI的不一致，如同一状态的界面元素展示的UI不同，或UI界面展示的不是最新的状态。</p> <p>2. 非必要的UI视图刷新，如只修改局部组件状态时导致组件所在页面的整体刷新。</p> <p>当用户与界面产生交互行为时，状态的修改是通过事件驱动处理的。事件的处理可以在应用的任何地方，如果没有进行适当的逻辑处理管理也会导致代码冗余和不利于维护。</p> <p>本文旨在从装饰器的选择、使用以及状态的逻辑处理管理方面解决以上问题，以实现更好的状态管理。</p> </div> <div class="tiledSection"><h2 id="section2592819104120">合理选择装饰器<i class="anchor-icon anchor-icon-link" anchorid="section2592819104120" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2674939304" class="firsth2">避免不必要的状态变量的使用<i class="anchor-icon anchor-icon-link" anchorid="section2674939304" tips="复制节点链接"></i></h3><p><strong>删除冗余的状态变量标记</strong></p> <p>状态变量的管理有一定的开销，应在合理场景使用，普通的变量用状态变量标记可能会导致性能劣化。</p> <p>反例1</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment.ets#L23-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Observed</span></li><li>class Translate {</li><li>  translateX: number = 20;</li><li>}</li><li>
</li><li><span class="hljs-variable">@Component</span></li><li>struct MyComponent {</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">translateObj</span>: Translate = new <span class="hljs-built_in">Translate</span>(); <span class="hljs-comment">// The variable translateObj is not associated with any UI component and should not be defined as a state variable</span></li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">buttonMsg</span>: string = <span class="hljs-string">'I am button'</span>; <span class="hljs-comment">// The variable buttonMsg is not associated with any UI component and should not be defined as a state variable</span></li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment.ets#L23-L34" target="_blank">segment.ets</a></div></div></div></div> <p>以上示例中变量translateObj，buttonMsg没有关联任何UI组件，没有关联任何UI组件的状态变量不应该定义为状态变量，否则读写状态变量都会影响性能。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hp-arkui-remove-redundant-state-var" target="_blank">@performance/hp-arkui-remove-redundant-state-var</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> <p>反例2</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment2.ets#L22-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Observed</span></li><li>class Translate {</li><li>  translateX: number = 20;</li><li>}</li><li>
</li><li><span class="hljs-variable">@Component</span></li><li>struct MyComponent {</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">translateObj</span>: Translate = new <span class="hljs-built_in">Translate</span>();</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">buttonMsg</span>: string = <span class="hljs-string">'I am button'</span>;</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>      <span class="hljs-selector-tag">Button</span>(this.buttonMsg) <span class="hljs-comment">// Here we just read the value of the variable buttonMsg, without any write operation.</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment2.ets#L22-L36" target="_blank">segment2.ets</a></div></div></div></div> <p>以上示例中变量buttonMsg仅有读取操作，没有修改操作，未修改过的状态变量不应定义为状态变量，否则读状态变量会影响性能。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-hp-arkui-remove-unchanged-state-var" target="_blank">@performance/hp-arkui-remove-unchanged-state-var</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> <p>正例</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment3.ets#L23-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Translate</span> {</li><li>  translateX: number = <span class="hljs-number">20</span>;</li><li>}</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct UnnecessaryState1 {</li><li>  <span class="hljs-meta">@State</span> translateObj: Translate = new Translate(); <span class="hljs-comment">// If there are both read and write operations and a Button component is associated with it, it is recommended to use state variables.</span></li><li>  buttonMsg = <span class="hljs-string">'I am button'</span>; <span class="hljs-comment">// Only read the value of the variable buttonMsg, without any write operations, just use the general variables directly</span></li><li>  build() {</li><li>    Column() {</li><li>      Button(<span class="hljs-keyword">this</span>.buttonMsg)</li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.getUIContext().animateTo({</li><li>            duration: <span class="hljs-number">50</span></li><li>          }, () =&gt; {</li><li>            <span class="hljs-keyword">this</span>.translateObj.translateX = (<span class="hljs-keyword">this</span>.translateObj.translateX + <span class="hljs-number">50</span>) % <span class="hljs-number">150</span>; <span class="hljs-comment">// Reassign value to variable translateObj when clicked.</span></li><li>          })</li><li>        })</li><li>    }</li><li>    .translate({</li><li>      x: <span class="hljs-keyword">this</span>.translateObj.translateX <span class="hljs-comment">// Retrieve the value in translateObj.</span></li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment3.ets#L23-L47" target="_blank">segment3.ets</a></div></div></div></div> <p>在代码中，buttonMsg变量因仅用于读取操作而被定义为普通成员变量，而translateObj变量则因需要根据用户事件改变其x值以驱动动画效果，故被定义为状态变量，并实时更新UI以显示动画。</p> <p><strong>建议使用临时变量替换状态变量</strong></p> <p>状态变量发生变化时，ArkUI会查询依赖该状态变量的组件并执行依赖该状态变量的组件的更新方法，完成组件渲染的行为。通过使用临时变量的计算代替直接操作状态变量，可以使ArkUI仅在最后一次状态变量变更时查询并渲染组件，减少不必要的行为，从而提高应用性能。状态变量行为可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state" target="_blank">@State装饰器：组件内状态</a>。</p> <p>反例</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment4.ets#L22-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// Define methods for changing state variables (multiple modifications of state variables)</span></li><li>  <span class="hljs-title function_">appendMsg</span>(<span class="hljs-params">newMsg: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += newMsg;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += <span class="hljs-string">';'</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> += <span class="hljs-string">'&lt;br/&gt;'</span>;</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Click Print Log'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMsg</span>(<span class="hljs-string">'Operational state variables'</span>); <span class="hljs-comment">// Calling encapsulated methods for changing state variables</span></li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span>})</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({  <span class="hljs-attr">top</span>: <span class="hljs-number">15</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment4.ets#L22-L47" target="_blank">segment4.ets</a></div></div></div></div> <p>正例</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment5.ets#L22-L49" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UnnecessaryState2</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// Define methods for changing state variables (intermediate variables are manipulated during method execution, state variables are modified only once)</span></li><li>  <span class="hljs-title function_">appendMsg</span>(<span class="hljs-params">newMsg: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>;</li><li>    message += newMsg;</li><li>    message += <span class="hljs-string">';'</span>;</li><li>    message += <span class="hljs-string">'&lt;br/&gt;'</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span> = message;</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Button</span>(<span class="hljs-string">'Click Print Log'</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">appendMsg</span>(<span class="hljs-string">'Manipulating Temporary Variables'</span>); <span class="hljs-comment">// Calling encapsulated methods for changing state variables</span></li><li>        })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'90%'</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">10</span> })</li><li>    }</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">Start</span>)</li><li>    .<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Center</span>)</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">top</span>: <span class="hljs-number">15</span> })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment5.ets#L22-L49" target="_blank">segment5.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section3584536184117">最小化状态共享范围<i class="anchor-icon anchor-icon-link" anchorid="section3584536184117" tips="复制节点链接"></i></h3><p>在没有强烈的业务需求下，尽可能按照状态需要共享的最小范围选择合适的装饰器。应用开发过程中，按照组件颗粒度，状态一般分为组件内独享的状态和组件间需要共享的状态。</p> <p><strong>组件内独享的状态</strong></p> <p>组件内独享的状态的生命周期和组件同步，状态的定义和更新都在组件内，组件销毁，状态也随即消失。常见于界面UI元素数据，比如当前按钮是否可用、文字是否高亮等。组件内独享的状态使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-state" target="_blank">@State装饰器</a>，被@State装饰器修饰后状态的修改只会触发当前组件实例的重新渲染。如下图主题列表上单个主题组件内使用@State修饰主题是否被选中的变量，当在界面点击主题时在组件内直接修改状态值。此时，只有当前主题的组件实例会重新渲染，其他主题组件不会重新渲染。</p> <div class="fignone"><span class="figcap"><b>图2 </b>HMOS世界App主题选择交互图</span><br><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.07509098265231005379574819807837:50001231000000:2800:EACBBA268286EE04EF385A82074E6B690666C41E52EDB3102FC3FC3DE27C3A58.png" title="点击放大" width="292.6"></span></div> <p><strong>组件间需要共享的状态</strong></p> <p>组件间需要共享的状态，按照共享范围从小到大依次有三种场景：父子组件间共享状态，不同子树上组件间共享状态和不同组件树间共享状态。</p> <ul><li>父子组件间共享状态：如下图，”父组件”和其子组件”子组件A”、”子组件B”共享状态loading。<div class="fignone"><span class="figcap"><b>图3 </b>父子组件间共享状态场景</span><br><span><img height="149.129176" originheight="919" originwidth="1256" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.59559285567728054364731361721930:50001231000000:2800:665974DE52592989D5E8A965C2A4E733522FFD3D4F5BF63605A8B814D1C1E5E9.jpg" title="点击放大" width="203.822234"></span></div> </li></ul> <ul><li>不同子树上组件间共享状态：如下图，祖先组件的左子树上”孙子组件AAA”和右子树上”孙子组件BAA”共享状态loading。<div class="fignone"><span class="figcap"><b>图4 </b>不同子树上组件间状态共享场景</span><br><span><img height="349.38235499999996" originheight="2375" originwidth="3031" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.44093352711146023718842465590617:50001231000000:2800:C21B98B70A58A144F507C0A5BCB2C83201E5674CCD675AE6762A1BA16D8273CB.jpg" title="点击放大" width="445.896465"></span></div> </li><li>不同组件树间共享状态：如下图，组件树A内”子组件AA”和组件树B内”孙子组件BAA”共享状态loading。<div class="fignone"><span class="figcap"><b>图5 </b>不同组件树间共享状态的场景</span><br><span><img height="279.4463" originheight="435" originwidth="680" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.67052040085156103449905374300768:50001231000000:2800:1939E8C81A775D2D6B5429629E8209E5FDA7F331B497B91AEF4236802C47BC57.png" title="点击放大" width="434.8967"></span></div> </li></ul> <p>对于上述三种场景，ArkUI提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop#父组件state到子组件prop简单数据类型同步" target="_blank">@State+@Prop</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link#简单类型和类对象类型的link" target="_blank">@State+@Link</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink" target="_blank">@State+@Observed+@ObjectLink</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-provide-and-consume" target="_blank">@Provide+@Consume</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage" target="_blank">AppStorage</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage" target="_blank">LocalStorage</a>六种装饰器组合以解决不同范围内的组件间状态共享。按照共享范围能力从小到大，各装饰器组合的共享范围能力和生命周期如下：</p> <ol><li>@State+@Prop、@State+@Link、@State+@Observed+@ObjectLink：三者的共享范围为从@State所在的组件开始，到@Prop/@Link/@ObjectLink所在组件的整条路径，路径上所有的中间组件通过@Prop/@Link/@ObjectLink都可以共享同一个状态。@State修饰的状态和其所属的自定义组件共享生命周期，在组件内定义时创建，组件销毁时被回收。@Link装饰的变量和其所属的自定义组件共享生命周期。@ObjectLink装饰的变量和其所属的自定义组件共享生命周期。</li><li>@Provide+@Consume：状态共享范围是以@Provide所在组件为祖先节点的整棵子树，子树上的任意后代组件通过@Consume都可以共享同一个状态。@Provide修饰的变量与其所属的组件绑定，在组件内定义时被创建，在组件销毁时被回收。</li><li>LocalStorage：共享范围为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uiability-overview" target="_blank">UIAbility</a>内以页面为单位的不同组件树间的共享。存储在LocalStorage中的状态的生命周期与LocalStorage绑定。LocalStorage的生命周期由应用程序决定，当应用释放最后一个指向LocalStorage的引用时，LocalStorage被垃圾回收。</li><li>AppStorage：共享范围是应用全局。AppStorage与应用的进程绑定，由UI框架在应用程序启动时创建，当应用进程终止，AppStorage被回收。</li></ol> <p>按照软件开发原则，应优先选择共享范围能力小的装饰器方案，减少不必要的参数层层传递，降低不同模块间的数据耦合，便于状态及时回收。建议选择装饰器的优先级为：@State+@Prop、@State+@Link、@State+@Observed+@ObjectLink &gt; @Provide+@Consume &gt; LocalStorage &gt; AppStorage。</p> </div> <div class="tiledSection"><h3 id="section1024883517476">减少不必要的参数层层传递<i class="anchor-icon anchor-icon-link" anchorid="section1024883517476" tips="复制节点链接"></i></h3><p>当按照上述优先级选择装饰器时，由于@State+@Prop、@State+@Link、@State+@Observed+@ObjectLink三种方案的实现方式是逐级向下传递状态，当共享状态的组件间层级相差较大时，会出现状态层层传递的现象。对于状态传递过程中途经的全部组件，都需要增加入参接收该状态再将状态传递给子组件。对于没有使用该状态的中间组件而言，这是“额外的消耗”，不利于代码的维护和拓展。尤其是当业务体系庞大时，需求变更容易出现“牵一发而动全身”的问题。</p> <p>以“<a href="https://gitee.com/harmonyos_samples/hmosworld" target="_blank">HMOS世界App</a>”中路由状态为例，其“探索”Tab和“我的”Tab界面组件如下：</p> <div class="fignone"><span class="figcap"><b>图6 </b>HMOS世界App界面组件示意图</span><br><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.90145346457773640893341145214308:50001231000000:2800:8AA7EE59AA4A23795D1994252E40D7CB9C89DCECBAB8E9AF9192C9FC19FD64FD.png" title="点击放大" width="292.6"></span></div> <p><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.65455351985711508214754251031817:50001231000000:2800:1A14896EE1248DD5C8F5DBB96136C7900E76ECC20E1BDF91D8A8EAC708A29FF9.png" title="点击放大" width="292.6"></span></p> <ul><li>“MainPage”是主页面，该页面有2个子组件“MineView”和“DiscoverView”。</li><li>“MineView”是“我的”Tab对应的内容视图组件，“CollectedResourceView”是该组件内展示收藏列表的视图组件，“ResourceListView”是“CollectedResourceView”的子组件。</li><li>“DiscoverView”是“探索”Tab对应的内容视图组件，“TechArticlesView”是该组件内展示文章列表的视图组件，“ArticleCardView”是列表上单个卡片视图组件，“ActionButtonView”是卡片上交互视图组件。</li></ul> <p>项目中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation" target="_blank">Navigation组件</a>管理路由，定义“appNavigationStack”变量表示应用当前的路由信息。现“DiscoverView”组件和“ResourceListView”组件需要共享路由信息状态。按照@State+@Prop层层传递的方案，当前各组件的设计如下：</p> <div class="fignone"><span class="figcap"><b>图7 </b>@State+@Prop当前组件设计图</span></div> <p><span><img height="379.040025" originheight="2669" originwidth="3231" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.90578495257207385958664527634601:50001231000000:2800:FE5D31E032E51D2ABCA320E8E073129613575B60245BD12CD9D5C1B8BB74F634.jpg" title="点击放大" width="458.85"></span></p> <p>可以看到，为了实现“ResourceListView”组件和“DiscoverView”组件共享状态，将状态定义在两者的最近公共祖先“MainPage”组件上。对公共祖先到两个需要共享路由状态的组件路径上的所有组件使用@Prop装饰器接收“appNavigationStack”参数，层层传递，直到两个需要共享状态的组件。</p> <p>若此时产品需要新增功能，该功能要求在“DiscoverView”组件的后代“ActionButtonView”组件上新增对路由信息的判断逻辑。此时开发者需修改上述各个组件设计如下图所示：</p> <div class="fignone"><span class="figcap"><b>图8 </b>@State+@Prop新增功能后组件设计图</span><br><span><img height="410.78247" originheight="2931" originwidth="3288" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162938.06682002604155684182987543810341:50001231000000:2800:1EA8F0B87D49B956BDCB94503AB45B1E29CCA028F4C6DBA6C8E572785C891B41.jpg" title="点击放大" width="460.845"></span></div> <p>可以看到，新功能的逻辑原本只是在“ActionButtonView”这一个组件中使用，开发者却需要修改从“DiscoverView”组件到“ActionButtonView”组件路径上3个组件的结构。若当业务后续再次变更为无需使用该状态时，也同样需要修改多个组件。这显然不是很好的实现方案。</p> <p>此时使用@Provide+@Consume方案更为合理。同样是“ResourceListView”组件和“DiscoverView”组件共享状态，此方案各组件设计如下：</p> <div class="fignone"><span class="figcap"><b>图9 </b>使用@Provide+@Consume方式当前各组件设计</span><br><span><img height="310.56856600000003" originheight="2138" originwidth="3200" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.62881704392402292865150890232450:50001231000000:2800:3C61467C0F21F1418C8E0E963CECA18F44A266F5EF088BE8D3BE18E92E4AF37E.jpg" title="点击放大" width="464.83500000000004"></span></div> <p>通过在最顶部组件“MainPage”中注入key值为“appNavigationStack”的路由信息状态，其后代组件均可以通过@Consume装饰器获取该状态值。当业务变动需要“DiscoverView”的后代“ActionButtonView”组件也共享路由信息时，此方案只需在组件“ActionButtonView”上使用@Consume装饰器直接获取路由信息状态，而无需修改其他组件。此时各组件设计如下：</p> <div class="fignone"><span class="figcap"><b>图10 </b>使用@Provide+@Consume方式业务变动后各组件设计</span><br><span><img height="369.60473900000005" originheight="2750" originwidth="3288" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.08350364210892007381818793939686:50001231000000:2800:12A958FCD7DEF715B4A7357C66DAC3A42BAAD5CE56C4CF8E34DAE5DE3C2E7178.jpg" title="点击放大" width="441.94437"></span></div> <p>因此当共享状态的组件间跨层级较深时，或共享的信息对于整个组件树是“全局”的存在时，选择@Provide+@Consume的装饰器组合代替层层传递的方式，能够提升代码的可维护性和可拓展性。</p> </div> <div class="tiledSection"><h3 id="section1619611428482">按照状态复杂度选择装饰器<i class="anchor-icon anchor-icon-link" anchorid="section1619611428482" tips="复制节点链接"></i></h3><p>对于上述具有相同优先级的装饰器选择方案@State+@Prop、@State+@Link和@State+@Observed+@ObjectLink。在选择方案时，需要结合具体的业务场景和状态数据结构的复杂度。这三种不同的装饰器组合方案在内存消耗、性能消耗和对数据类型的支持能力都不相同，如下：</p> <div class="fignone"><span class="figcap"><b>图11 </b>@State+@Prop、@State+@Link和@State+@Observed+@ObjectLink装饰器方案区别</span><p><span><img height="336.007875" originheight="2394" originwidth="5344" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.77169250320860881716833101442983:50001231000000:2800:118396F2AA3665E343EFE1163D8E6D71270FB664F95C2579C4C0113AEC63DD8F.jpg" title="点击放大" width="750.12"></span></p> </div> <ol><li>@State+@Prop组合方案：<ul><li>@Prop装饰器支持接收Object、class、string、number、boolean、enum类型，以及这些类型的数组。</li><li>@Prop装饰的变量是对父组件传入状态值的深拷贝，当@Prop装饰器装饰的变量为复杂Object、class或其类型数组时，会增加状态创建时间以及占用大量内存。</li><li>@Prop装饰的变量和父组件是单向绑定的关系。当父组件数据源发生变化时，接收该数据源的@Prop所在组件的实例会重新渲染。 当该组件内被@Prop装饰的变量被修改时，父组件数据源不会变化，父组件实例也不会重新渲染。</li></ul> </li><li>@State+@Link组合方案：<ul><li>@Link装饰器支持接收Object、class、string、number、boolean、enum类型，以及这些类型的数组。</li><li>@Link装饰器修饰的变量是对父组件传入状态的引用的拷贝，两者指向同一个地址。当状态是简单数据类型或简单Object类型时，@Link和@Prop在状态创建时间和内存的占用方面区别不大。当状态为复杂的Object、class或其类型数组时，@Link相较@Prop能明显减少状态创建时间和内存的占用。</li><li>@Link装饰器的变量和父组件是双向绑定的关系。当父组件数据源发生变化时，接收该数据源的@Link所在组件的实例会重新渲染。 当该组件内被@Link装饰的变量被修改时，父组件数据源会同步修改，父组件实例也会重新渲染。</li></ul> </li><li>@State+@Observed+@ObjectLink组合方案：<ul><li>@ObjectLink只支持接收被@Observed装饰的class实例及继承Date或者Array的class实例。</li><li>@ObjectLink装饰的变量是只读的，不支持对状态重新赋值。</li><li>@ObjectLink必须配合@Observed使用，它的设计是为了解决对嵌套类对象属性变化的监听，如需要观察对象数组中单个数据项的属性值变化，或嵌套对象的对象类型属性的子属性变化。</li></ul> </li></ol> <p>结合三个方案的特性，在选择时有如下建议：</p> <ul><li>需要观察嵌套类对象的深层属性变化的场景，选择@State+@Observed+@ObjectLink。</li><li>状态是复杂对象、类或其类型数组的场景，选择@State+@Link。</li><li>状态是简单数据类型时，使用@State+@Link和@State+@Prop均可。在功能层面上，依据@Prop单向绑定的特性，@State+@Prop适合用于非实时修改的场景，如编辑电话薄联系人信息时，展示编辑界面的子组件信息的修改要求不实时同步回父组件，需要等到编辑完成后点击“确认”按钮时才会以事件驱动的方式修改父组件的状态。依据@Link双向绑定的特性，@State+@Link适合用于实时修改的场景，如组件嵌套时的滚动条同步。</li></ul> </div> <div class="tiledSection"><h3 id="section1199519714916">总结<i class="anchor-icon anchor-icon-link" anchorid="section1199519714916" tips="复制节点链接"></i></h3><p>在实际开发中，合理选择装饰器主要包含以下三步：</p> <p>1.首先根据状态需要共享的范围大小，尽量选择共享能力小的装饰器方案，优先级依次为@State+@Prop、@State+@Link或@State+@Observed+@ObjectLink &gt; @Provide+@Consume &gt; LocalStorage &gt; AppStorage。</p> <p>2.当共享的状态的组件间层级相差较大时，为避免较差的代码可扩展性和可维护性，@Provide+@Consume的方案要优于层层传递的共享方案。</p> <p>3.对于具有相同优先级的@State+@Prop、@State+@Link或@State+@Observed+@ObjectLink 三个方案，应结合状态的复杂程度和装饰器各自的特性选择。</p> <p>实际开发中，应根据业务需求衡量优先级选择合适的装饰器，整体可参考如下建议：</p> <ol><li>@State+@Prop：适合状态结构简单，且共享状态的组件间层级相差不大的场景。或功能上要求子组件不实时同步修改给父组件的场景。</li><li>@State+@Link：适合状态结构复杂，且共享状态的组件间层级相差不大的场景。或功能上要求子组件对状态的修改实时同步给父组件的场景。</li><li>@State+@Observed+@ObjectLink：适合需要观察嵌套类对象的子属性变化的场景或对象数组的数据项属性变化的场景，如监听列表卡片上某个属性的变化。</li><li>@Provide+@Consume：适合用于对于整个组件树而言“全局”的状态，且该状态改动不频繁的状态共享场景，如共享界面的路由信息。</li><li>AppStorage：适合对于整个应用而言“全局”的变量或应用的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/thread-model-stage" target="_blank">主线程</a>内多个UIAbility实例间的状态共享，如用户信息。</li><li>LocalStorage：适合对于单个Ability而言“全局”的变量，主要用于不同页面间的状态共享场景。</li></ol> </div> <div class="tiledSection"><h2 id="section5929038204918">精细化拆分复杂状态<i class="anchor-icon anchor-icon-link" anchorid="section5929038204918" tips="复制节点链接"></i></h2><p>对于AppStorage的使用，由于其作用范围最广，开发者为了方便开发容易将各种状态存入其中以达到共享的目的，这通常会造成大量的性能损失。</p> <p>这是因为，在ArkUI中状态的修改刷新是粗颗粒的。使用装饰器修饰对象类型状态时，ArkUI能监听到对象本身值的变化以及对象的属性值的变化。当对象属性值发生变化后，ArkUI会以整个对象颗粒度通知所有使用了该状态的组件重新渲染，而不是按属性颗粒度大小通知使用了该变化属性的组件重新渲染。</p> <p>对AppStorage的使用，以“HMOS世界App”中共享用户信息和用户收藏信息为例，描述如何拆分状态存储。用户信息和用户收藏信息涉及的模块和界面展示如下：</p> <div class="fignone"><span class="figcap"><b>图12 </b>“HMOS世界App”中点赞高亮状态和用户信息组件视图</span><br><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.84116163056045562308791875440782:50001231000000:2800:BB70CAB0C5F37222D8FB4214608E01836CF8F31150E6D1976171242E866AAE24.png" title="点击放大" width="292.6"></span></div> <p><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.05516851928289185833227620204395:50001231000000:2800:5CD1D789018F392E506CB52454C72359883A1F7D2F42AC7B8137DABC94255AA6.png" title="点击放大" width="292.6"></span></p> <ul><li>“我的”模块顶部有展示用户信息的组件“UserInfoView”，底部有展示用户收藏列表，列表卡片上需要高亮展示用户是否点赞了当前文章。</li><li>“探索”模块首页展示技术文章列表，列表卡片上同样需要展示用户是否点赞了当前文章。</li><li>当两个模块中任一模块的卡片有点赞交互时，需要同步用户是否对文章点赞的状态给另一个模块。</li></ul> <p>当前项目中已经使用AppStorage存储用户信息UserData，UserData的数据结构和“UserInfoView”组件使用UserData状态展示用户信息的代码如下：</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment6.ets#L26-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Data structure of user information UserData</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserData</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">username</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">description</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Getting server-side user information in a business class</span></li><li>  <span class="hljs-title function_">getUserData</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">userAccountRepository</span>.<span class="hljs-title function_">getUserData</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">UserData</span>) =&gt; {</li><li>      <span class="hljs-comment">// 1.Storing user information data into AppStorage</span></li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'userData'</span>, <span class="hljs-variable">data</span>);</li><li>    });</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">// View component for displaying user information at the top of the “My” module</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">UserInfoView</span> {</li><li>  <span class="hljs-comment">// 2.Receive user information stored in AppStorage using @StorageLink decorator in UI</span></li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'userData'</span>) <span class="hljs-variable">userData</span>: <span class="hljs-title class_">UserData</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-comment">// 3.Display the user name in the userData.</span></li><li>          <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span> ? <span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span>.<span class="hljs-variable">username</span> : <span class="hljs-string">'default_login'</span>)</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment6.ets#L26-L70" target="_blank">segment6.ets</a></div></div></div></div> <p>现在“探索“模块和“我的“模块需要共享用户的收藏列表信息，只需要共享收藏的文章id数组即可。不同模块间的状态共享考虑将其也存储在AppStorage中，有如下两种存储方案：</p> <p>1. 收藏信息也是用户信息的一部分，将收藏信息作为用户信息userData的一个属性，存储在当前AppStorage里key值为“userData”的变量上。</p> <p>2. 收藏信息单独存入AppStorage中，不与用户信息userData绑定。</p> <p>第一种方案的代码实现如下：</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment7.ets#L42-L108" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserData</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">username</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">description</span>: <span class="hljs-title class_">string</span>;</li><li>
</li><li>  <span class="hljs-comment">// 1. Add a list of resources in the user's collection on the user information UserData id Information Type Definition</span></li><li>  <span class="hljs-variable">collectedIds</span>: <span class="hljs-title class_">string</span>[];</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Getting server-side user information in a business class</span></li><li>  <span class="hljs-title function_">getUserData</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">userAccountRepository</span>.<span class="hljs-title function_">getUserData</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">UserData</span>) =&gt; {</li><li>      <span class="hljs-comment">// 2.Storing user information data into AppStorage</span></li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'userData'</span>, <span class="hljs-variable">data</span>);</li><li>    })</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">// Article card component of the Explore module</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ArticleCardView</span> {</li><li>  <span class="hljs-comment">// 3.Get the user information object userData on the ExploreArticleList card with the @StorageLink decorator</span></li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'userData'</span>) <span class="hljs-variable">userData</span>: <span class="hljs-title class_">UserData</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">articleItem</span>: <span class="hljs-title class_">LearningResource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">LearningResource</span>();</li><li>
</li><li>  <span class="hljs-comment">// 4.Calculate whether the current article is favorite or not according to the favorite information array</span></li><li>  <span class="hljs-title function_">isCollected</span>(): <span class="hljs-title class_">boolean</span> {</li><li>    <span class="hljs-keyword">return</span> !!<span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span> &amp;&amp; <span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span>.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">some</span>((<span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">id</span> === <span class="hljs-keyword">this</span>.<span class="hljs-variable">articleItem</span>.<span class="hljs-variable">id</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// 7.Handling interface like interaction logic: when the userData state sub-property collectedIds received using the @StorageLink decorator is modified, the new value is synchronized to AppStorage</span></li><li>  <span class="hljs-title function_">handleCollected</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">index</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span>?.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">findIndex</span>((<span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">id</span> === <span class="hljs-keyword">this</span>.<span class="hljs-variable">articleItem</span>.<span class="hljs-variable">id</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span>?.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">resourceId</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">userData</span>?.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable">index</span>, <span class="hljs-number">1</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">ActionButtonView</span>({</li><li>      <span class="hljs-comment">// 5.Determine whether the favorite icon is highlighted according to whether the current article has been favorited by the user or not</span></li><li>      <span class="hljs-variable">imgResource</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isCollected</span>() ? $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">icon</span>') : $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">icon</span>'),</li><li>      <span class="hljs-variable">count</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">articleItem</span>.<span class="hljs-title class_">collectionCount</span>,</li><li>      <span class="hljs-variable">textWidth</span>: <span class="hljs-number">77</span></li><li>    })</li><li>      .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>        <span class="hljs-comment">// 6.When the user clicks on the favorites icon, the function that handles changes to the status of the favorites is called</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">handleCollected</span>();</li><li>      })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment7.ets#L42-L108" target="_blank">segment7.ets</a></div></div></div></div> <p>这种实现方案下，当用户在“UserInfoView ”组件上重新修改用户描述信息userData.description属性值时，属性值变化将同步回AppStorage中。ArkUI监听到AppStorage中key值为“userData”的值变化，随后通知所有使用了AppStorage中key值为“userData”的组件重新渲染。</p> <p>在上述界面中，“我的“模块中展示用户信息的组件“UserInfoView ”会重新渲染。由于“探索”模块的文章卡片组件ArticleCardView 通过@StorageLink装饰器绑定了AppStorage中key值为“userData”的变量，所有的文章卡片组件也都会重新渲染。而这些组件与用户描述信息无关，不应该被描述信息的修改变化影响，从而导致渲染刷新。</p> <p>改为使用上述第二种方案实现，代码如下：</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment8.ets#L60-L107" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-comment">// Getting user information in a business class</span></li><li>  <span class="hljs-title function_">getUserData</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">userAccountRepository</span>.<span class="hljs-title function_">getUserData</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">data</span>: <span class="hljs-title class_">UserData</span>) =&gt; {</li><li>      <span class="hljs-comment">//1.Separate storage of user collection information data in AppStorage</span></li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'collectedIds'</span>, <span class="hljs-variable">data</span>.<span class="hljs-variable">collectedIds</span>);</li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'userData'</span>, <span class="hljs-variable">data</span>);</li><li>    })</li><li>  }</li><li><span class="hljs-comment">// Article card component of the Explore module</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ArticleCardView</span> {</li><li>  <span class="hljs-comment">// 2.Getting collection information stored in AppStorage via @StorageLink decorator</span></li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'collectedIds'</span>) <span class="hljs-variable">collectedIds</span>: <span class="hljs-title class_">string</span>[] = [];</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">articleItem</span>: <span class="hljs-title class_">LearningResource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">LearningResource</span>();</li><li>  <span class="hljs-comment">// 3.Calculate whether the current article is favorite or not according to the favorite information array</span></li><li>  <span class="hljs-title function_">isCollected</span>(): <span class="hljs-title class_">boolean</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">some</span>((<span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">id</span> === <span class="hljs-keyword">this</span>.<span class="hljs-variable">articleItem</span>.<span class="hljs-variable">id</span>);</li><li>  }</li><li>  <span class="hljs-comment">// 6.Handling interface like interaction logic: when the state collectedIds received using the @StorageLink decorator are modified, the new values are synchronized to AppStorage</span></li><li>  <span class="hljs-title function_">handleCollected</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">index</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">findIndex</span>((<span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">id</span> === <span class="hljs-keyword">this</span>.<span class="hljs-variable">articleItem</span>.<span class="hljs-variable">id</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">index</span> === -<span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">resourceId</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">collectedIds</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable">index</span>, <span class="hljs-number">1</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-title function_">build</span>(){</li><li>    <span class="hljs-title function_">ActionButtonView</span>({</li><li>      <span class="hljs-comment">// 4.Determine whether the favorite icon is highlighted according to whether the current article has been favorited by the user or not</span></li><li>      <span class="hljs-variable">imgResource</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isCollected</span>() ? $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">icon</span>') : $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">icon</span>'),</li><li>      <span class="hljs-variable">count</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">articleItem</span>.<span class="hljs-title class_">collectionCount</span>,</li><li>      <span class="hljs-variable">textWidth</span>: <span class="hljs-number">77</span></li><li>    })</li><li>      .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>        <span class="hljs-comment">// 5.When the user clicks on the favorites icon, the function that handles changes to the status of the favorites is called</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">handleCollected</span>();</li><li>      })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment8.ets#L60-L107" target="_blank">segment8.ets</a></div></div></div></div> <p>在此方案中，由于文章卡片组件没有绑定AppStorage中key值为“userData”的变量，当用户编辑修改了用户描述userData.description的值时， 文章卡片组件不会重新渲染。</p> <p>并且，当用户点击文章卡片上的收藏按钮修改文章收藏状态时，变化同步回AppStorage中的key值为“collectedIds”的变量。ArkUI监听到AppStorage中key值为“collectedIds”的值变化，只会通知所有绑定了AppStorage中key值为“collectedIds”变量的组件重新渲染，不会造成“我的“模块用户信息组件“UserInfoView ”重新渲染。</p> <p>因此，从性能的角度考虑，在使用LocalStorage或AppStorage装饰器存储状态变量时需要合理设计状态的数据结构，避免无意义的渲染刷新。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>过分追求状态结构拆分可能在某些场景导致组件设计过度，不利于维护。此时，可以将对象或类上经常一起改变的几个属性聚合成一个新的对象或类模型，并使用@Observed装饰器修饰，再作为属性挂载到之前的对象或类上。通过此方法，当属性变化时ArkUI只会通知变化给新的对象或类，不会通知最上层的对象。这样既可以有效的减少无用渲染次数，又能使代码更好维护。</p> <p>如类ClassA上存在属性b、c、d。其中c和d经常一起发生变化，即当c的状态修改时同时也要修改d的状态。</p> <div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassA</span>{</li><li>  <span class="hljs-variable">b</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">c</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">d</span>: <span class="hljs-title class_">boolean</span>;</li><li>}</li></ol></pre></div></div> <p>此时，将c和d组合在一起做为新的类ClassE的属性并使用@Observed装饰器修饰。对于ClassA去掉c、d属性，新增属性e且其类型为ClassE，设计如下：</p> <div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassA</span>{</li><li>  <span class="hljs-variable">b</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">e</span>: <span class="hljs-title class_">ClassE</span>;</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Observed</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClassE</span>{</li><li>  <span class="hljs-variable">c</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">d</span>: <span class="hljs-title class_">boolean</span>;</li><li>}</li></ol></pre></div></div> <p>使用此方案，在AppStorage中存入数据结构为ClassA的变量。当ClassA实例的属性e中的属性c的值变化时，ArkUI框架会通知使用ClassE实例的组件重新渲染，不会通知所有使用AppStorage中ClassA实例的组件更新，即只使用了ClassA实例b属性的组件不会重新渲染。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section17423111515506">集中化状态修改逻辑<i class="anchor-icon anchor-icon-link" anchorid="section17423111515506" tips="复制节点链接"></i></h2><p>在使用@Link装饰器时，开发者可以直接在@Link装饰器接收状态的组件内部修改状态。当多个子组件修改状态的逻辑基本相同时，建议将状态的修改集中到单个函数中，以提升逻辑的可复用性、代码的可维护性和可测试性。</p> <p>如在“HMOS世界App”的探索模块首页上点击资讯卡片、文章卡片或顶部轮播图时，都会跳转到详情页，交互效果如下：</p> <div class="fignone"><span class="figcap"><b>图13 </b>“HMOS世界App”的探索模块首页上各组件跳转详情页交互</span><br><span><img height="605.2564" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.41110056335338174573440983089702:50001231000000:2800:E94F7848AED9BEA6BA2B117DC2522AFAAC5BC4B5D089A5B4D398A9DB399AF812.png" title="点击放大" width="292.6"></span></div> <p>上述的三个组件共享全局路由信息，当发生界面点击交互时，三个组件的逻辑均为根据设备信息修改路由状态实现跳转到详情页。将三个组件处理跳转的逻辑集中到父组件上处理。实现代码如下：</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment9.ets#L60-L143" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DiscoverView</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">jumpList</span> = () =&gt; {</li><li>  }</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">hotFeedList</span>: <span class="hljs-title class_">never</span>[] = [];</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">articlesDataSource</span>: <span class="hljs-title class_">never</span>[] = [];</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">discoverModel</span>: <span class="hljs-title class_">GeneratedTypeLiteralInterface_1</span> = { <span class="hljs-variable">swiperData</span>: [] };</li><li>  <span class="hljs-comment">// 1.Getting shared state related to jump logic</span></li><li>  @<span class="hljs-title function_">Consume</span>(<span class="hljs-string">'appPathStack'</span>) <span class="hljs-variable">appPathStack</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  @<span class="hljs-title function_">Consume</span>(<span class="hljs-string">'discoverPathStack'</span>) <span class="hljs-variable">discoverPathStack</span>: <span class="hljs-title class_">NavPathStack</span>;</li><li>  @<span class="hljs-title function_">StorageProp</span>(<span class="hljs-string">'currentBreakpoint'</span>) <span class="hljs-variable">currentBreakpoint</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'BreakpointTypeEnum.MD'</span>;</li><li>
</li><li>  <span class="hljs-comment">// 5.Centralize the jump processing logic of the 3 components in the parent component</span></li><li>  <span class="hljs-title function_">jumpDetail</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentBreakpoint</span> === <span class="hljs-string">'BreakpointTypeEnum.LG'</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">discoverPathStack</span>.<span class="hljs-title function_">pushPathByName</span>(<span class="hljs-string">'articleDetail'</span>, <span class="hljs-variable">item</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">appPathStack</span>.<span class="hljs-title function_">pushPathByName</span>(<span class="hljs-string">'articleDetail'</span>, <span class="hljs-variable">item</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">List</span>() {</li><li>        <span class="hljs-title function_">ListItem</span>() {</li><li>          <span class="hljs-title function_">BannerView</span>({</li><li>            <span class="hljs-variable">swiperData</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">discoverModel</span>.<span class="hljs-title class_">swiperData</span>,</li><li>            <span class="hljs-comment">// 2.The top rotator component passes in the parent component's logic handler function</span></li><li>            <span class="hljs-variable">handleClick</span>: (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-title function_">jumpDetail</span>(<span class="hljs-variable">item</span>)</li><li>          })</li><li>        }</li><li>        <span class="hljs-title function_">ListItem</span>() {</li><li>          <span class="hljs-title function_">Column</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SPACE_12</span> }) {</li><li>            <span class="hljs-title function_">HotFeedsView</span>({</li><li>              <span class="hljs-variable">hotFeedList</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">hotFeedList</span>,</li><li>              <span class="hljs-variable">showMore</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">jumpList</span>,</li><li>              <span class="hljs-comment">// 3.Information list component passes in the logic handler function of the parent component</span></li><li>              <span class="hljs-variable">handleClick</span>: (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-title function_">jumpDetail</span>(<span class="hljs-variable">item</span>)</li><li>            })</li><li>            <span class="hljs-title function_">TechArticlesView</span>({</li><li>              <span class="hljs-variable">articlesDataSource</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">articlesDataSource</span>,</li><li>              <span class="hljs-comment">// 4.Logic handler function passed to parent component by technical article component</span></li><li>              <span class="hljs-variable">handleClick</span>: (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-title function_">jumpDetail</span>(<span class="hljs-variable">item</span>)</li><li>            })</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">BannerView</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">swiperData</span>: <span class="hljs-title class_">LearningResource</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">swiperController</span>: <span class="hljs-title class_">SwiperController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">SwiperController</span>();</li><li>  <span class="hljs-comment">// 6.The rotatoire component receives the logic handler passed to it by the parent component.</span></li><li>  <span class="hljs-variable">handleClick</span>: (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; <span class="hljs-variable">void</span> = () =&gt; {</li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Swiper</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperController</span>) {</li><li>      <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">swiperData</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; {</li><li>        <span class="hljs-title function_">Row</span>() {</li><li>          <span class="hljs-comment">// $r('app.media.icon') needs to be replaced with the resource file required by the developer</span></li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.icon'</span>))</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-number">55</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">55</span>)</li><li>            <span class="hljs-comment">// Set the border radius to 5vp</span></li><li>            .<span class="hljs-title function_">borderRadius</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.float.component_radius'</span>))</li><li>            <span class="hljs-comment">//  7.When clicking on an image, call the received function to process the logic</span></li><li>            .<span class="hljs-title function_">onClick</span>(() =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-title function_">handleClick</span>(<span class="hljs-variable">item</span>))</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">LearningResource</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>)</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment9.ets#L60-L143" target="_blank">segment9.ets</a></div></div></div></div> <p>可以看到，通过将子组件的相似逻辑提升到父组件中集中处理，相同的逻辑代码只需要写一份。否则，上述代码需要在“BannerView ”、“HotFeedsView”、“TechArticlesView”三个组件各写一份跳转逻辑处理代码。当业务逻辑变动时，也只需修改单个函数“jumpDetail”。在开发中，除了界面逻辑可以集中在界面处理，业务逻辑也可以抽取成单个文件集中处理，解耦UI与数据便于逻辑复用。适当的对逻辑进行集中处理，能有效提升代码的可维护性和可复用性。</p> </div> <div class="tiledSection"><h2 id="section19081251381"><strong>使用监听和订阅精准控制组件刷新</strong><i class="anchor-icon anchor-icon-link" anchorid="section19081251381" tips="复制节点链接"></i></h2><p>多个组件依赖对象中的不同属性时，直接关联该对象会出现改变任一属性所有组件都刷新的现象，可以通过将类中的属性拆分组合成新类的方式精准控制组件刷新。</p> <p>在多个组件依赖同一个数据源并根据数据源变化刷新组件的情况下，直接关联数据源会导致每次数据源改变都刷新所有组件。为精准控制组件刷新，可以采取以下策略。</p> </div> <div class="tiledSection"><h3 id="section117631443131915" class="firsth2">使用 @Watch 装饰器监听数据源<i class="anchor-icon anchor-icon-link" anchorid="section117631443131915" tips="复制节点链接"></i></h3><p>在组件中使用@Watch装饰器监听数据源，当数据变化时执行业务逻辑，确保只有满足条件的组件进行刷新。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>建议开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-multi-associations-state-var-check" target="_blank">@performance/multiple-associations-state-var-check</a>规则。若扫描结果中出现该规则相关问题，可参考本章节提供的优化建议进行调整。</p> </div></div></div> <p><strong>反例</strong></p> <p>在下面的示例代码中，多个组件直接关联同一个数据源，但是未使用@Watch装饰器和Emitter事件驱动更新，导致了冗余的组件刷新。</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment10.ets#L23-L79" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// The subscript of the currently selected list item</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listData</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listData</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">List</span>() {</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listData</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">ListItem</span>() {</li><li>              <span class="hljs-title class_">ListItemComponent</span>({ <span class="hljs-attr">item</span>: item, <span class="hljs-attr">index</span>: index, <span class="hljs-attr">currentIndex</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span> })</li><li>            }</li><li>          })</li><li>        }</li><li>        .<span class="hljs-title function_">alignListItem</span>(<span class="hljs-title class_">ListItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li>
</li><li>
</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ListItemComponent</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// The subscript of the list item</span></li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-attr">currentIndex</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">sizeFont</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>;</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">isRender</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ListItemComponent <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.index}</span> Text is rendered`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">sizeFont</span>;</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isRender</span>())<span class="hljs-comment">// Dynamically set the color of the text according to the difference between the index and currentIndex of the current list item.</span></li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span>) &lt;= <span class="hljs-number">1</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment10.ets#L23-L79" target="_blank">segment10.ets</a></div></div></div></div> <p>上述示例中，每个ListItemComponent组件点击Text后会将当前点击的列表项下标index赋值给currentIndex，@Link装饰的状态变量currentIndex变化后，父组件Index和所有ListItemComponent组件中的Index值都会同步发生改变。然后，在所有ListItemComponent组件中，根据列表项下标index与currentIndex的差值的绝对值是否小于等于1来决定Text的颜色，如果满足条件，则文本显示为红色，否则显示为蓝色，下面是运行效果图。</p> <p><span><img height="352.1175" originheight="724" originwidth="1076" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.70155595743497131400945102539735:50001231000000:2800:4CA25563BCE8F3FE1B52535F3D5E7D3AFB8F56D6812A94C51A8DE8B4B5C20D48.gif" title="点击放大" width="523.6875"></span></p> <p>可以看到每次点击后即使其中部分Text组件的颜色并没有发生改变，所有的Text组件也都会刷新。这是由于ListItemComponent组件中的Text组件直接关联了currentIndex，而不是根据currentIndex计算得到的颜色。</p> <p>针对上述父子组件层级关系的场景，推荐使用状态装饰器@Watch监听数据源。当数据源改变时，在@Watch的监听回调中执行业务逻辑。组件关联回调的处理结果，而不是直接关联数据源。</p> <p><strong>正例</strong></p> <p>下面是对上述示例的优化，展示如何通过@Watch装饰器实现精准刷新。</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment11.ets#L23-L76" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UseWatchListener</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">currentIndex</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>; <span class="hljs-comment">// The subscript of the currently selected list item</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">listData</span>: <span class="hljs-built_in">string</span>[] = [];</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">listData</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${i}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">List</span>() {</li><li>          <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listData</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>            <span class="hljs-title class_">ListItem</span>() {</li><li>              <span class="hljs-title class_">ListItemComponent</span>({ <span class="hljs-attr">item</span>: item, <span class="hljs-attr">index</span>: index, <span class="hljs-attr">currentIndex</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span> })</li><li>            }</li><li>          })</li><li>        }</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>        .<span class="hljs-title function_">alignListItem</span>(<span class="hljs-title class_">ListItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ListItemComponent</span> {</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">item</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Prop</span> <span class="hljs-attr">index</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// The subscript of the list item</span></li><li>  <span class="hljs-meta">@Link</span> <span class="hljs-meta">@Watch</span>(<span class="hljs-string">'onCurrentIndexUpdate'</span>) <span class="hljs-attr">currentIndex</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span>) &lt;= <span class="hljs-number">1</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>;</li><li>  <span class="hljs-title function_">isRender</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">`ListItemComponent <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.index}</span> Text is rendered`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">50</span>;</li><li>  }</li><li>  <span class="hljs-title function_">onCurrentIndexUpdate</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// Dynamically modifies the value of color based on the difference between the index and currentIndex of the current list item.</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span> = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span>) &lt;= <span class="hljs-number">1</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-property">Blue</span>;</li><li>  }</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">item</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isRender</span>())</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">color</span>)</li><li>        .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">index</span>;</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment11.ets#L23-L76" target="_blank">segment11.ets</a></div></div></div></div> <p>上述代码中，ListItemComponent组件中的状态变量currentIndex使用@Watch装饰，Text组件直接关联新的状态变量color。当currentIndex发生变化时，会触发onCurrentIndexUpdate方法，在其中将表达式的运算结果赋值给状态变量color。只有color的值发生变化时，Text组件才会重新渲染，运行效果图如下：</p> <p><span><img height="353.115" originheight="722" originwidth="1069" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162939.67615781033225886139085215500237:50001231000000:2800:25B2AF2B07EA617BA5A99BDC75F861EF7B18A65FB6128FDA86DA9498AF076817.gif" title="点击放大" width="523.6875"></span></p> <p>被依赖的数据源仅在父子或兄弟关系的组件中传递时，可以参考上述示例，使用@State/@Link/@Watch装饰器进行状态管理，实现组件的精准刷新。</p> <p>当组件关系层级较多但都归属于同一个确定的组件树时，推荐使用@Provide/@Consume传递数据，使用@Watch装饰器监听数据变化，在监听回调中执行业务逻辑。</p> </div> <div class="tiledSection"><h3 id="section26916161205">使用自定义事件发布订阅<i class="anchor-icon anchor-icon-link" anchorid="section26916161205" tips="复制节点链接"></i></h3><p>当组件关系复杂或跨越层级过多时，推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-eventhub" target="_blank">EventHub</a>或者<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter" target="_blank">Emitter</a>自定义事件发布订阅的方式。当数据源改变时发布事件，依赖该数据源的组件通过订阅事件来获取数据源的改变，完成业务逻辑的处理，从而实现组件的精准刷新。</p> <p>下面通过部分示例代码介绍使用方式，ButtonComponent组件作为交互组件触发数据变更，ListItemComponent组件接收数据做相应的UI刷新。</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment12.ets#L17-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ButtonComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/ButtonComponent'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ListItemComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../components/ListItemComponent'</span>;</li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">UseEmitterPublish</span> {</li><li>  <span class="hljs-attr">listData</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>, <span class="hljs-string">'E'</span>, <span class="hljs-string">'F'</span>];</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">ButtonComponent</span>()</li><li>        }</li><li>      }</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-title class_">Column</span>() {</li><li>          <span class="hljs-title class_">List</span>() {</li><li>            <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">listData</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>              <span class="hljs-title class_">ListItemComponent</span>({ <span class="hljs-attr">myItem</span>: item, <span class="hljs-attr">index</span>: index })</li><li>            })</li><li>          }</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">alignListItem</span>(<span class="hljs-title class_">ListItemAlign</span>.<span class="hljs-property">Center</span>)</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment12.ets#L17-L44" target="_blank">segment12.ets</a></div></div></div></div> <p>由于ButtonComponent组件和ListItemComponent组件的组件关系较为复杂，因此在ButtonComponent组件中的Button回调中，可以使用emitter.emit发送事件，在ListItemComponent组件中订阅事件。在事件触发的回调中接收数据value，通过业务逻辑决定是否修改状态变量color，从而实现精准控制ListItemComponent组件中Text的刷新。</p> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment13.ets#L17-L39" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">emitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">CHANGE_COLOR_EVENT_ID</span> = <span class="hljs-number">1</span>;</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ButtonComponent</span> {</li><li>  <span class="hljs-variable">value</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">2</span>;</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Button</span>(`<span class="hljs-variable">下标是</span>${<span class="hljs-keyword">this</span>.<span class="hljs-variable">value</span>}<span class="hljs-variable">的倍数的组件文字变为红色</span>`)</li><li>      .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">event</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">InnerEvent</span> = {</li><li>          <span class="hljs-variable">eventId</span>: <span class="hljs-title class_">CHANGE_COLOR_EVENT_ID</span>,</li><li>          <span class="hljs-variable">priority</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">EventPriority</span>.<span class="hljs-title class_">LOW</span></li><li>        };</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">eventData</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">EventData</span> = {</li><li>          <span class="hljs-variable">data</span>: {</li><li>            <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">value</span></li><li>          }</li><li>        };</li><li>        <span class="hljs-comment">// Sends an event with eventId of CHANGE_COLOR_EVENT_ID and event content of eventData</span></li><li>        <span class="hljs-variable">emitter</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-variable">event</span>, <span class="hljs-variable">eventData</span>);</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">value</span>++;</li><li>      })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment13.ets#L17-L39" target="_blank">segment13.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-fys-c106="" class="highlight-div"><div _ngcontent-fys-c106="" class="highlight-div-header"><div _ngcontent-fys-c106="" class="highlight-div-header-left"><div _ngcontent-fys-c106="" class="handle-button expand-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-fys-c106="" class="highlight-div-header-right"><div _ngcontent-fys-c106="" class="handle-button ai-button"></div><div _ngcontent-fys-c106="" class="handle-button line-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-fys-c106="" class="handle-button theme-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-fys-c106="" class="handle-button copy-button"><div _ngcontent-fys-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-fys-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment14.ets#L17-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">emitter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">CHANGE_COLOR_EVENT_ID</span> = <span class="hljs-number">1</span>;</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ListItemComponent</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>;</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>;</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">myItem</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">event</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">InnerEvent</span> = {</li><li>      <span class="hljs-variable">eventId</span>: <span class="hljs-title class_">CHANGE_COLOR_EVENT_ID</span></li><li>    };</li><li>    <span class="hljs-comment">// Execute this callback after receiving an event with eventId of CHANGE_COLOR_EVENT_ID</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">callback</span> = (<span class="hljs-variable">eventData</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">EventData</span>): <span class="hljs-title class_">void</span> =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">eventData</span>.<span class="hljs-variable">data</span>?.<span class="hljs-variable">value</span> !== <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-keyword">this</span>.<span class="hljs-variable">index</span> % <span class="hljs-variable">eventData</span>.<span class="hljs-variable">data</span>?.<span class="hljs-variable">value</span> === <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span> = <span class="hljs-variable">Color</span>.<span class="hljs-variable">Red</span>;</li><li>      }</li><li>    };</li><li>    <span class="hljs-comment">// Subscribe to events with eventId of CHANGE_COLOR_EVENT_ID</span></li><li>    <span class="hljs-variable">emitter</span>.<span class="hljs-title function_">on</span>(<span class="hljs-variable">event</span>, <span class="hljs-variable">callback</span>);</li><li>  }</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">myItem</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span>)</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ArkUI/StateManagement/entry/src/main/ets/segment/segment14.ets#L17-L44" target="_blank">segment14.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section1199984435012">总结<i class="anchor-icon anchor-icon-link" anchorid="section1199984435012" tips="复制节点链接"></i></h2><p>状态管理是MVVM模式中十分复杂的问题，为解决其中状态和视图一致性、渲染性能体验、代码可复用性和可维护性四个问题，本文主要有以下建议点：</p> <ul><li>在选择装饰器时，应理解各个装饰器的特性和共享范围，结合实际开发场景的优先级，合理选择装饰器，以确保状态和视图的一致性。</li><li>在使用装饰器时，对装饰器修饰的复杂变量应进行合理拆分设计，以此减少非必要的组件渲染次数，获得更好的性能体验。</li><li>在代码开发过程中，对相似的逻辑处理，应考虑其复用性合理集中处理，以此有效提升代码的可维护性和可复用性。</li></ul> </div> </div></div>