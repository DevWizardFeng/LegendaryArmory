<h1 _ngcontent-ldw-c119="" class="doc-title ng-star-inserted" title="相机分段式拍照性能优化"> 相机分段式拍照性能优化 </h1>

<div _ngcontent-ldw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1329113339214">概述<i class="anchor-icon anchor-icon-link" anchorid="section1329113339214" tips="复制节点链接"></i></h2><p>相机拍照性能依赖算法处理的速度，而处理效果依赖算法的复杂度，算法复杂度越高的情况下会导致处理时间就越长。目前系统相机开发有两种相机拍照方案，分别是<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-deferred-capture" target="_blank">相机分段式拍照</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-shooting" target="_blank">相机单段式拍照</a>：</p> <ul><li><strong>分段式拍照</strong>是系统相机开发的重要功能之一，即相机拍照可输出低质量图用作缩略图，提升用户感知拍照速度，同时使用高质量图保证最后的成图质量达到系统相机的水平，既满足了图像处理算法的需求，又不会阻塞前台的拍照速度，构筑相机性能竞争力，提升了用户的体验。</li></ul> <ul><li><strong>单段式拍照</strong>是指在拍照过程中通过多帧融合以及多个底层算法处理之后返回一张高质量图片，这样导致Shot2See（用户点击拍照控件到在缩略图显示区域显示缩略图的过程）完成时延比较长。</li></ul> <p>分段式与单段式拍照的全质量图输出质量一致，但低质量模式下单段式更优。如果开发者不需要获取全质量图并且也不考虑Shot2See的完成时延，建议使用单段式拍照，否则的话，建议使用分段式拍照。本篇文章主要以相机Shot2See场景为例，来展示分段式拍照Shot2See的完成时延要低于单段式拍照。</p> <div class="fignone"><span class="figcap"><b>图1 </b><strong>分段式拍照流程示意图</strong></span><br><span><img height="493.25577000000004" originheight="444" originwidth="595" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163029.21213878498303647464390887087288:50001231000000:2800:710CAFF05628F6009E56A2E799600CB2A04C1B7F4F2ACB70DD49C08F1FF82964.png" title="点击放大" width="661.01931"></span></div> </div> <div class="tiledSection"><h2 id="section18796757151315">效果展示<i class="anchor-icon anchor-icon-link" anchorid="section18796757151315" tips="复制节点链接"></i></h2><div class="fignone"><span class="figcap"><b>图2 </b><strong>单段式拍照效果图</strong></span></div> <p><span><img height="363.26649100000003" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163029.94845684820828657558472917364372:50001231000000:2800:9ABEB0A629784C0AFA43070FFB353B182A94D98CAC4ED84B1B90EE83C9BE85FF.gif" width="179.55" class="notEnlarge"></span></p> <div class="fignone"><span class="figcap"><b>图3 </b><strong>分段式拍照效果图</strong></span></div> <p><span><img height="372.75777000000005" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163029.45983981577167249568081267873690:50001231000000:2800:3AB3B18E9DFD7CD363CEF9E0A30A478E162CAA674E03ADCC1CEA94E6ED01A392.gif" width="182.54250000000002" class="notEnlarge"></span></p> <p>从上述效果图中可以看出，分段式拍照从用户点击拍照控件到在缩略图显示区域显示缩略图的耗时比单段式拍照要短。</p> </div> <div class="tiledSection"><h2 id="section13264032919">性能对比分析方式<i class="anchor-icon anchor-icon-link" anchorid="section13264032919" tips="复制节点链接"></i></h2><p>静态校验：在相机类应用中，如果使用单段式拍照，拍照过程中该场景下仅会返回一张图片，将图片用作Shot2See后的缩略图则会导致Shot2See完成时延比较长。</p> <p>动态校验：开发者可以通过DevEco Studio中的Profiler工具去抓取Trace，获取到Trace之后，根据PhotoOutputNapi::Capture()和OnBufferAvailable()找到对应的Trace Marker，并通过两者之间的时间段来分析耗时，单段式拍照的时长为1900ms，而分段式拍照的时长为672.7ms。</p> <div class="fignone"><span class="figcap"><b>图4 </b><strong>单段式拍照性能数据图</strong></span></div> <p><span><img height="146.05794" originheight="193" originwidth="1081" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163029.21170380083925408439857113166299:50001231000000:2800:FFDF18E9465FA05D303979B869A13C8A9C626785AACACA11A6DA12F63EA99EEA.png" title="点击放大" width="713.2125000000001"></span></p> <div class="fignone"><span class="figcap"><b>图5 </b><strong>分段式拍照耗时数据</strong><strong>图</strong></span><br><span><img height="179.74045600000002" originheight="291" originwidth="1145" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163029.65962357331332534493994695261449:50001231000000:2800:A346A5073E5B75BC7BCD487582DC90A0AF673DF4871B9CD1DBC201C48AC4611B.png" title="点击放大" width="721.1925"></span></div> <p><strong>性能对比分析表</strong></p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.8.1.3.1.1" valign="top" width="50%"><p><strong>拍照实现方式</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.8.1.3.1.2" valign="top" width="50%"><p><strong>耗时(局限不同设备和场景，数据仅供参考)</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>单段式拍照</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>1900ms</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>分段式拍照</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>672.7ms</p> </td> </tr>  </tbody></table></div> </div> <p>优化思路：在需要加快Shot2See完成时延的场景下，使用相机框架开发的分段式拍照方案，加快阶段一照片生成的速度。</p> </div> <div class="tiledSection"><h2 id="section099811487293">场景示例<i class="anchor-icon anchor-icon-link" anchorid="section099811487293" tips="复制节点链接"></i></h2><p>下面以应用中相机Shot2See（拍照之后自动跳转到照片编辑界面）为例，通过单段式拍照和分段式拍照的性能功耗对比，来展示两者的性能差异。</p> <p><strong>单段式拍照：</strong></p> <p>单段式拍照使用了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#onphotoavailable11" target="_blank">on(type: 'photoAvailable', callback: AsyncCallback&lt;Photo&gt;): void</a>接口注册了高质量图的监听，默认不使能分段式拍照。具体操作步骤如下所示：</p> <p>1.相机媒体数据写入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent组件</a>中，用来显示图像效果。具体代码如下所示：</p> <div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">XComponent</span>({</li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-title class_">XComponentType</span>.<span class="hljs-title class_">SURFACE</span>,</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">mXComponentController</span>,</li><li>  <span class="hljs-variable">imageAIOptions</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">options</span></li><li>})</li><li>  .<span class="hljs-title function_">onLoad</span>(<span class="hljs-variable">async</span> () =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'onLoad is called'</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">mXComponentController</span>.<span class="hljs-title function_">getXComponentSurfaceId</span>();</li><li>    <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">setObject</span>(<span class="hljs-string">'cameraDeviceIndex'</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">defaultCameraDeviceIndex</span>);</li><li>    <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">setObject</span>(<span class="hljs-string">'xComponentSurfaceId'</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>);</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onLoad</span> <span class="hljs-variable">surfaceId</span>: ${<span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>}`);</li><li>    <span class="hljs-variable">await</span> <span class="hljs-variable">CameraService</span>.<span class="hljs-title function_">initCamera</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">surfaceId</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">defaultCameraDeviceIndex</span>);</li><li>  })</li><li>  .<span class="hljs-title function_">border</span>({</li><li>    <span class="hljs-variable">width</span>: {</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-title class_">Constants</span>.<span class="hljs-title class_">X_COMPONENT_BORDER_WIDTH</span>,</li><li>      <span class="hljs-variable">bottom</span>: <span class="hljs-title class_">Constants</span>.<span class="hljs-title class_">X_COMPONENT_BORDER_WIDTH</span></li><li>    },</li><li>    <span class="hljs-variable">color</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-title class_">Black</span></li><li>  })</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-number">523</span>)</li><li>  .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">75</span>, <span class="hljs-variable">bottom</span>: <span class="hljs-number">72</span> })</li></ol></pre></div></div> <p>2.initCamera函数完成一个相机生命周期初始化的过程。</p> <p>(1) <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-f#cameragetcameramanager" target="_blank">getCameraManager()</a>获取CameraMananger相机管理器类。</p> <p>(2) <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedcameras" target="_blank">getSupportedCameras()</a> 和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedoutputcapability11" target="_blank">getSupportedOutputCapability()</a>方法获取支持的camera设备以及设备能力集。</p> <p>(3) <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput12" target="_blank">createPreviewOutput()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createphotooutput11" target="_blank">createPhotoOutput()</a>方法创建预览输出和拍照输出对象。</p> <p>(4) CameraInput的open()方法打开相机输入。</p> <p>(5) onCameraStatusChange()函数创建CameraManager注册回调。</p> <p>(6) 最后调用sessionFlowFn()函数创建并开启Session。具体代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L124-L205" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Initialize Camera Functions</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> surfaceId - Surface ID</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> cameraDeviceIndex - Camera Device Index</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@returns</span> No return value</span></li><li><span class="hljs-comment"> */</span></li><li>async initCamera(surfaceId: string, cameraDeviceIndex: number): Promise&lt;void&gt; {</li><li>  Logger.debug(TAG, `initCamera cameraDeviceIndex: ${cameraDeviceIndex}`);</li><li>  <span class="hljs-keyword">this</span>.photoMode = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'photoMode'</span>);</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.photoMode) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    await <span class="hljs-keyword">this</span>.releaseCamera();</li><li>    <span class="hljs-comment">// Get Camera Manager Instance</span></li><li>    <span class="hljs-keyword">this</span>.cameraManager = <span class="hljs-keyword">this</span>.getCameraManagerFn();</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cameraManager === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'cameraManager is undefined'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Gets the camera device object that supports the specified</span></li><li>    <span class="hljs-keyword">this</span>.cameras = <span class="hljs-keyword">this</span>.getSupportedCamerasFn(<span class="hljs-keyword">this</span>.cameraManager);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cameras.length &lt; <span class="hljs-number">1</span> || <span class="hljs-keyword">this</span>.cameras.length &lt; cameraDeviceIndex + <span class="hljs-number">1</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.curCameraDevice = <span class="hljs-keyword">this</span>.cameras[cameraDeviceIndex];</li><li>    let isSupported = <span class="hljs-keyword">this</span>.isSupportedSceneMode(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.curCameraDevice);</li><li>    <span class="hljs-keyword">if</span> (!isSupported) {</li><li>      Logger.error(TAG, <span class="hljs-string">'The current scene mode is not supported.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    let cameraOutputCapability =</li><li>      <span class="hljs-keyword">this</span>.cameraManager.getSupportedOutputCapability(<span class="hljs-keyword">this</span>.curCameraDevice, <span class="hljs-keyword">this</span>.curSceneMode);</li><li>    let previewProfile = <span class="hljs-keyword">this</span>.getPreviewProfile(cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (previewProfile === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'The resolution of the current preview stream is not supported.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.previewProfileObj = previewProfile;</li><li>    <span class="hljs-comment">// Creates the previewOutput output object</span></li><li>    <span class="hljs-keyword">this</span>.previewOutput = <span class="hljs-keyword">this</span>.createPreviewOutputFn(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.previewProfileObj, surfaceId);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.previewOutput === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'Failed to create the preview stream.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Listening for preview events</span></li><li>    <span class="hljs-keyword">this</span>.previewOutputCallBack(<span class="hljs-keyword">this</span>.previewOutput);</li><li>    let photoProfile = <span class="hljs-keyword">this</span>.getPhotoProfile(cameraOutputCapability);</li><li>    <span class="hljs-keyword">if</span> (photoProfile === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'The resolution of the current photo stream is not supported.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.photoProfileObj = photoProfile;</li><li>    <span class="hljs-comment">// Creates a photoOutPut output object</span></li><li>    <span class="hljs-keyword">this</span>.photoOutput = <span class="hljs-keyword">this</span>.createPhotoOutputFn(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.photoProfileObj);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.photoOutput === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'Failed to create the photo stream.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Creates a cameraInput output object</span></li><li>    <span class="hljs-keyword">this</span>.cameraInput = <span class="hljs-keyword">this</span>.createCameraInputFn(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.curCameraDevice);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.cameraInput === undefined) {</li><li>      Logger.error(TAG, <span class="hljs-string">'Failed to create the camera input.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Turn on the camera</span></li><li>    let isOpenSuccess = await <span class="hljs-keyword">this</span>.cameraInputOpenFn(<span class="hljs-keyword">this</span>.cameraInput);</li><li>    <span class="hljs-keyword">if</span> (!isOpenSuccess) {</li><li>      Logger.error(TAG, <span class="hljs-string">'Failed to open the camera.'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Camera status callback</span></li><li>    <span class="hljs-keyword">this</span>.onCameraStatusChange(<span class="hljs-keyword">this</span>.cameraManager);</li><li>    <span class="hljs-comment">// Listens to CameraInput error events</span></li><li>    <span class="hljs-keyword">this</span>.onCameraInputChange(<span class="hljs-keyword">this</span>.cameraInput, <span class="hljs-keyword">this</span>.curCameraDevice);</li><li>    <span class="hljs-comment">// Session Process</span></li><li>    await <span class="hljs-keyword">this</span>.sessionFlowFn(<span class="hljs-keyword">this</span>.cameraManager, <span class="hljs-keyword">this</span>.cameraInput, <span class="hljs-keyword">this</span>.previewOutput, <span class="hljs-keyword">this</span>.photoOutput);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    let err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `initCamera fail: ${JSON.stringify(err)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L124-L205" target="_blank">CameraService.ets</a></div></div></div></div> <p>3.确定拍照输出流。通过cameraManager.createPhotoOutput()方法创建拍照输出流，参数为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameraoutputcapability" target="_blank">CameraOutputCapability</a>类中的photoProfiles属性。</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L351-L366" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Creates a photoOutPut output object</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">createPhotoOutputFn</span>(<span class="hljs-variable">cameraManager</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraManager</span>,</li><li>  <span class="hljs-variable">photoProfileObj</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Profile</span>): <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoOutput</span> | <span class="hljs-title class_">undefined</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">photoOutput</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoOutput</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">photoOutput</span> = <span class="hljs-variable">cameraManager</span>.<span class="hljs-title function_">createPhotoOutput</span>(<span class="hljs-variable">photoProfileObj</span>);</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">createPhotoOutputFn</span> <span class="hljs-variable">success</span>: ${<span class="hljs-variable">photoOutput</span>}`);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">photoOutput</span>;</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">createPhotoOutputFn</span> <span class="hljs-variable">failed</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L351-L366" target="_blank">CameraService.ets</a></div></div></div></div> <p>4.触发拍照。通过photoOutput类的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#capture" target="_blank">capture()</a>方法，执行拍照任务。该方法有两个参数，分别为拍照设置参数的setting以及回调函数，setting中可以设置照片的质量和旋转角度。具体代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L243-L255" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Trigger a photo taking based on the specified parameters</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">takePicture</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'takePicture start'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">cameraDeviceIndex</span> = <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title class_">getT</span>&lt;<span class="hljs-title class_">number</span>&gt;(<span class="hljs-string">'cameraDeviceIndex'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">photoSettings</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoCaptureSetting</span> = {</li><li>    <span class="hljs-variable">quality</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">QualityLevel</span>.<span class="hljs-title class_">QUALITY_LEVEL_HIGH</span>,</li><li>    <span class="hljs-variable">mirror</span>: <span class="hljs-title class_">cameraDeviceIndex</span> ? <span class="hljs-keyword">true</span> : <span class="hljs-keyword">false</span></li><li>  };</li><li>  <span class="hljs-variable">await</span> <span class="hljs-keyword">this</span>.<span class="hljs-variable">photoOutput</span>?.<span class="hljs-title function_">capture</span>(<span class="hljs-variable">photoSettings</span>);</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'takePicture end'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L243-L255" target="_blank">CameraService.ets</a></div></div></div></div> <p>5.设置拍照photoAvailable()的回调来获取Photo对象，点击拍照按钮，触发此回调函数，调用getComponent()方法根据图像的组件类型从图像中获取组件缓存ArrayBuffer，使用createImageSource()方法来创建图片源实例，最后通过createPixelMap()获取PixelMap对象。注意:如果已经注册了photoAssetAvailable()回调，并且在Session开始之后又注册了photoAvailable()回调，会导致流被重启。不建议开发者同时注册photoAvailable()和photoAssetAvailable()。</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L509-L533" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">photoOutput</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'photoAvailable'</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">photo</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Photo</span>) =&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'photoAvailable begin'</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">photoAvailable</span> <span class="hljs-variable">err</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">imageObj</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span> = <span class="hljs-variable">photo</span>.<span class="hljs-keyword">main</span>;</li><li>  <span class="hljs-variable">imageObj</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">component</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getComponent</span> <span class="hljs-variable">start</span>`);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getComponent</span> <span class="hljs-variable">err</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">buffer</span>);</li><li>    <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMap</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">createPixelMap</span> <span class="hljs-variable">err</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">handlePhotoAssetCb</span>(<span class="hljs-variable">pixelMap</span>);</li><li>    });</li><li>
</li><li>  });</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L509-L533" target="_blank">CameraService.ets</a></div></div></div></div> <p>以上代码中执行handleImageInfo()函数来对PixelMap进行全局存储并跳转到预览页面。具体代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/views/ModeComponent.ets#L44-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">handleSavePicture</span> = (<span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span> | <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>): <span class="hljs-title class_">void</span> =&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'handleSavePicture'</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setImageInfo</span>(<span class="hljs-variable">photoAsset</span>);</li><li>  <span class="hljs-variable">AppStorage</span>.<span class="hljs-title class_">set</span>&lt;<span class="hljs-title class_">boolean</span>&gt;(<span class="hljs-string">'isOpenEditPage'</span>, <span class="hljs-keyword">true</span>);</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'setImageInfo end'</span>);</li><li>}</li><li>
</li><li><span class="hljs-title function_">setImageInfo</span>(<span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span> | <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'setImageInfo'</span>);</li><li>  <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-title function_">setObject</span>(<span class="hljs-string">'photoAsset'</span>, <span class="hljs-variable">photoAsset</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/views/ModeComponent.ets#L44-L54" target="_blank">ModeComponent.ets</a></div></div></div></div> <p>6.进入到预览界面，通过GlobalContext.get().getT&lt;image.PixelMap&gt;('imageInfo')方法获取PixelMap信息，并通过Image组件进行渲染显示。</p> <p><strong>分段式拍照：</strong></p> <p>分段式拍照是应用下发拍照任务后，系统将分多阶段上报不同质量的图片。在一阶段，系统快速上报低质量图，应用通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#onphotoassetavailable12" target="_blank">on(type: 'photoAssetAvailable', callback: AsyncCallback&lt;photoAccessHelper.PhotoAsset&gt;): void</a>接口会收到一个PhotoAsset对象，通过该对象可调用媒体库接口，读取图片或落盘图片。在二阶段，分段式子服务会根据系统压力以及定制化场景进行调度，将后处理好的原图回传给媒体库，替换低质量图。具体操作步骤如下所示：</p> <p>由于分段式拍照和单段式拍照步骤1-步骤4相同，就不再进行赘述。</p> <p>5.设置拍照photoAssetAvailable()的回调来获取photoAsset，点击拍照按钮，触发此回调函数，然后执行handlePhotoAssetCb()函数来完成photoAsset全局的存储并跳转到预览页面。</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L498-L505" data-highlighted="yes"><ol class="linenums"><li>photoOutput.<span class="hljs-title function_">on</span>(<span class="hljs-string">'photoAssetAvailable'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError, photoAsset: photoAccessHelper.PhotoAsset</span>) =&gt;</span> {</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'photoAssetAvailable begin'</span>);</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`photoAssetAvailable err:<span class="hljs-subst">${err.code}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handlePhotoAssetCb</span>(photoAsset);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/mode/CameraService.ets#L498-L505" target="_blank">CameraService.ets</a></div></div></div></div> <p></p> <p>6.进入预览界面通过GlobalContext.get().getT&lt;image.PixelMap&gt;('imageInfo')方法获取PhotoAsset信息，执行requestImage函数中的photoAccessHelper.MediaAssetManager.requestImageData()方法根据不同的策略模式，请求图片资源数据，这里的请求策略为均衡模式BALANCE_MODE， 最后分段式子服务会根据系统压力以及定制化场景进行调度，将后处理好的原图回传给媒体库来替换低质量图。具体代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-ldw-c106="" class="highlight-div"><div _ngcontent-ldw-c106="" class="highlight-div-header"><div _ngcontent-ldw-c106="" class="highlight-div-header-left"><div _ngcontent-ldw-c106="" class="handle-button expand-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ldw-c106="" class="highlight-div-header-right"><div _ngcontent-ldw-c106="" class="handle-button ai-button"></div><div _ngcontent-ldw-c106="" class="handle-button line-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ldw-c106="" class="handle-button theme-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ldw-c106="" class="handle-button copy-button"><div _ngcontent-ldw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ldw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/pages/EditPage.ets#L42-L90" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">photoBufferCallback</span>: (<span class="hljs-variable">arrayBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span>) =&gt; <span class="hljs-variable">void</span> = (<span class="hljs-variable">arrayBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span>) =&gt; {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'photoBufferCallback is called'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">arrayBuffer</span>);</li><li>  <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMap</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">data</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">createPixelMap</span> <span class="hljs-variable">err</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'createPixelMap is called'</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">curPixelMap</span> = <span class="hljs-variable">data</span>;</li><li>  });</li><li>};</li><li>
</li><li><span class="hljs-title function_">requestImage</span>(<span class="hljs-variable">requestImageParams</span>: <span class="hljs-title class_">RequestImageParams</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDataHandler</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title class_">MediaAssetDataHandler</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt; {</li><li>      <span class="hljs-title function_">onDataPrepared</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">ArrayBuffer</span>, <span class="hljs-variable">map</span>: <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">string</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'onDataPrepared map'</span> + <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">map</span>));</li><li>        <span class="hljs-variable">requestImageParams</span>.<span class="hljs-title function_">callback</span>(<span class="hljs-variable">data</span>);</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'onDataPrepared end'</span>);</li><li>      }</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">requestOptions</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">RequestOptions</span> = {</li><li>      <span class="hljs-variable">deliveryMode</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">DeliveryMode</span>.<span class="hljs-title class_">BALANCE_MODE</span>,</li><li>    };</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">handler</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MediaDataHandler</span>();</li><li>    <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">MediaAssetManager</span>.<span class="hljs-title function_">requestImageData</span>(<span class="hljs-variable">requestImageParams</span>.<span class="hljs-variable">context</span>, <span class="hljs-variable">requestImageParams</span>.<span class="hljs-variable">photoAsset</span>,</li><li>      <span class="hljs-variable">requestOptions</span>, <span class="hljs-variable">handler</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-keyword">in</span> <span class="hljs-variable">requestImage</span>, <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">aboutToAppear</span>() {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'aboutToAppear begin'</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">photoMode</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">SUBSECTION_MODE</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">curPhotoAsset</span> = <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-variable">getT</span>&lt;<span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span>&gt;(<span class="hljs-string">'photoAsset'</span>);</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">photoUri</span> = <span class="hljs-variable">curPhotoAsset</span>.<span class="hljs-variable">uri</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">requestImageParams</span>: <span class="hljs-title class_">RequestImageParams</span> = {</li><li>      <span class="hljs-variable">context</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getUIContext</span>().<span class="hljs-title class_">getHostContext</span>(),</li><li>      <span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">curPhotoAsset</span>,</li><li>      <span class="hljs-variable">callback</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">photoBufferCallback</span></li><li>    };</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">requestImage</span>(<span class="hljs-variable">requestImageParams</span>);</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">aboutToAppear</span> <span class="hljs-variable">photoUri</span>: ${<span class="hljs-keyword">this</span>.<span class="hljs-variable">photoUri</span>}`);</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">photoMode</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">SINGLE_STAGE_MODE</span>) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">curPixelMap</span> = <span class="hljs-variable">GlobalContext</span>.<span class="hljs-title function_">get</span>().<span class="hljs-variable">getT</span>&lt;<span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>&gt;(<span class="hljs-string">'photoAsset'</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/SegmentedPhotograph/entry/src/main/ets/pages/EditPage.ets#L42-L90" target="_blank">EditPage.ets</a></div></div></div></div> <p>7.将步骤6获取的PixelMap对象数据通过Image组件进行渲染显示。</p> </div> <div class="tiledSection"><h2 id="section141651919113612">总结<i class="anchor-icon anchor-icon-link" anchorid="section141651919113612" tips="复制节点链接"></i></h2><p>通过分段式拍照，确保低质量图可接受的基础上，加快了Shot2See的完成时延，同时第二段保证了高质量照片不损失图片效果，达到与系统相机一致的拍照质量。</p> </div> <div class="tiledSection"><h2 id="section579014539290">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section579014539290" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/SegmentedPhotograph" target="_blank">实现相机分段式拍照功能</a></li></ul> </div> </div> <div></div></div>