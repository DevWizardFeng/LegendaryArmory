<h1 _ngcontent-nff-c119="" class="doc-title ng-star-inserted" title="相机预览花屏解决方案"> 相机预览花屏解决方案 </h1>

<div _ngcontent-nff-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section2474105741311">概述<i class="anchor-icon anchor-icon-link" anchorid="section2474105741311" tips="复制节点链接"></i></h2><p>开发者在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-kit" target="_blank">使用相机服务</a>时，如果仅用于预览流展示，通常使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件实现，如果需要获取每帧图像做二次处理(例如获取每帧图像完成二维码识别或人脸识别场景)，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>中imageArrival事件监听预览流每帧数据，解析图像内容。在解析图像内容时，如果未考虑stride，直接通过使用width*height读取图像内容去解析图像，会导致相机预览异常，从而出现相机预览花屏的现象。</p> <p>当开发者获取预览流每帧图像buffer后，若发现图片内容出现花屏堆叠状，出现相机预览花屏现象，此时需要排查解析每帧图像，当预览流图像stride与width不一致时，需要对stride进行无效像素的去除处理。</p> </div> <div class="tiledSection"><h2 id="section518523945816">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section518523945816" tips="复制节点链接"></i></h2><p>在计算机图形学和图像处理中，stride通常指的是在内存中存储多维数组（如图像或纹理）时，行与行之间的字节间隔，即每一行的起始地址与下一行的起始地址之间的距离，在本文中stride指的是图像的一行数据在内存中实际占用的字节数，出于内存对齐和提高读取效率的考虑，通常大于图像的宽度。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>stride在不同的平台底层上报的值不同，开发者需根据实际业务获取stride后做处理适配。在本文中通过预览流帧数据的返回值image.Component.rowStride获取stride。</p> </div></div></div> <p>如下图：在一个width为3，height为3，stride为4的图片上（例如定义了一个480*480分辨率的图像），实际分配内存并不是width*height即3*3（此处为定义的预览流分辨率的宽高比，即实际分配内存不是480*480），而是stride*height即4*3，这样实现了内存对齐，方便硬件处理。</p> <p></p> <div class="fignone"><span class="figcap"><b>图1 </b>需正确处理stride</span></div> <p><span><img height="288.27750000000003" originheight="415" originwidth="753" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.72627008209240306992283834768072:50001231000000:2800:7A49C8A5883B5C7ED40AD00EE2DF2175052D9C8E609B4C1222A82A2B542C4F71.png" title="点击放大" width="523.6875"></span></p> <p>如果开发者根据width和height数据去处理像素数据，即把0x00-0x09地址的数据当做像素去处理，就会出现解析了错误的像素数据的问题，并且使用了无效的像素0x03，0x07，会导致图片无法正常显示导致“相机花屏”现象。因此，要根据stride值处理预览数据流，去除无效的像素后送显，才能获取正确的预览流图像。</p> </div> <div class="tiledSection"><h2 id="section1998125825818">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section1998125825818" tips="复制节点链接"></i></h2><p>以一种高频的用户使用场景为例，应用需要定义一个1080*1080分辨率的预览流图像，此时的stride在相关平台的返回值为1088，此时需要对stride进行处理，处理无效像素后解析出正确的像素数据，避免出现预览流花屏。</p> <p>【反例】未处理stride：当开发者创建PixelMap解析buffer时，直接按照宽去读取每行数据，没有处理stride，此时若解析了无效像素数据并传给Image组件直接送显，可能会出现预览流花屏现象。</p> <p>以下为部分示例代码：</p> <ol><li>应用通过image.ImageReceiver注册imageArrival图像回调方法，获取每帧图像数据实例image.Image，应用通过定义一个width为1080*height为1080分辨率的预览流直接创建pixelMap，此时获取到的stride的值为1088，解析buffer时若直接按照宽去读取每行数据（使用了无效像素数据）并存储到全局变量stridePixel中，传给Image送显，会导致预览流花屏。<div class="screenLinkPre"><div _ngcontent-nff-c106="" class="highlight-div"><div _ngcontent-nff-c106="" class="highlight-div-header"><div _ngcontent-nff-c106="" class="highlight-div-header-left"><div _ngcontent-nff-c106="" class="handle-button expand-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nff-c106="" class="highlight-div-header-right"><div _ngcontent-nff-c106="" class="handle-button ai-button"></div><div _ngcontent-nff-c106="" class="handle-button line-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nff-c106="" class="handle-button theme-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nff-c106="" class="handle-button copy-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceThree.ets#L46-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable">receiver</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageReceiver</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, () =&gt; {</li><li>    <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">readNextImage</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">nextImage</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> || <span class="hljs-variable">nextImage</span> === <span class="hljs-variable">undefined</span>) {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">requestPermissionsFromUser</span> <span class="hljs-variable">call</span> <span class="hljs-variable">Failed</span>! <span class="hljs-variable">error</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">nextImage</span>) {</li><li>        <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">_err</span>, <span class="hljs-variable">component</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">width</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the width</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the height</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>            <span class="hljs-variable">size</span>: {</li><li>              <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>,</li><li>              <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span></li><li>            },</li><li>            <span class="hljs-comment">// Counter example:width does not pass the stride value,</span></li><li>            <span class="hljs-comment">// create PixelMap parsing buffer directly according to the width to read each line od data,</span></li><li>            <span class="hljs-comment">// may use invalid pixel data,resulting in preview flowScreen.</span></li><li>            <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span></li><li>          })</li><li>          <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'stridePixel'</span>, <span class="hljs-variable">pixelMap</span>);</li><li>          <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">release</span>();</li><li>        })</li><li>      }</li><li>    });</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceThree.ets#L46-L73" target="_blank">CameraServiceThree.ets</a></div></div></div></div> </li><li>在初始相机模块时，调用onImageArrival()，将未处理的width和height作为size，创建PixelMap，通过在Image中传入被@StorageLink修饰的变量stridePixel进行数据刷新，图片送显。<div class="screenLinkPre"><div _ngcontent-nff-c106="" class="highlight-div"><div _ngcontent-nff-c106="" class="highlight-div-header"><div _ngcontent-nff-c106="" class="highlight-div-header-left"><div _ngcontent-nff-c106="" class="handle-button expand-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nff-c106="" class="highlight-div-header-right"><div _ngcontent-nff-c106="" class="handle-button ai-button"></div><div _ngcontent-nff-c106="" class="handle-button line-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nff-c106="" class="handle-button theme-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nff-c106="" class="handle-button copy-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/pages/PageThree.ets#L27-L130" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>export struct PageThree {</li><li>  pathStack: NavPathStack = new NavPathStack();</li><li>  <span class="hljs-meta">@State</span> name: string = <span class="hljs-string">'pageOne'</span>;</li><li>  <span class="hljs-meta">@State</span> isShowStridePixel: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'stridePixel'</span>)</span> <span class="hljs-meta">@Watch(<span class="hljs-string">'onStridePixel'</span>)</span> stridePixel: image.PixelMap | undefined = undefined;</li><li>  <span class="hljs-meta">@State</span> imageWidth: number = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-meta">@State</span> imageHeight: number = <span class="hljs-number">1080</span>;</li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'previewRotation'</span>)</span> previewRotate: number = <span class="hljs-number">0</span>;</li><li>
</li><li>  onStridePixel(): void {</li><li>    <span class="hljs-keyword">this</span>.isShowStridePixel = <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  aboutToAppear(): void {</li><li>    CameraService.initCamera(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.getUIContext());</li><li>  }</li><li>
</li><li>  aboutToDisappear(): void {</li><li>    CameraService.releaseCamera();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  build() {</li><li>    NavDestination() {</li><li>      <span class="hljs-comment">// ...</span></li><li>      Column() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isShowStridePixel) {</li><li>          Image(<span class="hljs-keyword">this</span>.stridePixel)</li><li>            .width(<span class="hljs-keyword">this</span>.getUIContext().px2vp(<span class="hljs-keyword">this</span>.imageWidth))</li><li>            .height(<span class="hljs-keyword">this</span>.getUIContext().px2vp(<span class="hljs-keyword">this</span>.imageHeight))</li><li>            .margin({ top: <span class="hljs-number">150</span> })</li><li>            .rotate({</li><li>              z: <span class="hljs-number">0.5</span>,</li><li>              angle: <span class="hljs-keyword">this</span>.previewRotate</li><li>            })</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .justifyContent(FlexAlign.Center)</li><li>      .height(<span class="hljs-string">'90%'</span>)</li><li>      .width(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .backgroundColor(Color.White)</li><li>    .hideTitleBar(<span class="hljs-literal">true</span>)</li><li>    .onBackPressed(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.pathStack.pop();</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    })</li><li>    .onReady((context: NavDestinationContext) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.pathStack = context.pathStack;</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/pages/PageThree.ets#L27-L130" target="_blank">PageThree.ets</a></div></div></div></div> </li></ol> <p>【正例一】开发者使用width，height，stride三个值，处理相机预览流数据，处理stride方法一如下。</p> <p>分两种情况：</p> <ol><li>当stride和width相等时，按宽读取buffer不影响结果。</li><li>当stride和width不等时，将相机返回的预览流数据即component.byteBuffer的数据去除stride，拷贝得到新的dstArr数据进行数据处理，将处理后的dstArr数组buffer，通过width和height直接创建pixelMap, 并存储到全局变量stridePixel中，传给Image送显。<div class="screenLinkPre"><div _ngcontent-nff-c106="" class="highlight-div"><div _ngcontent-nff-c106="" class="highlight-div-header"><div _ngcontent-nff-c106="" class="highlight-div-header-left"><div _ngcontent-nff-c106="" class="handle-button expand-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nff-c106="" class="highlight-div-header-right"><div _ngcontent-nff-c106="" class="handle-button ai-button"></div><div _ngcontent-nff-c106="" class="handle-button line-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nff-c106="" class="handle-button theme-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nff-c106="" class="handle-button copy-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceOne.ets#L46-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable">receiver</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageReceiver</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">nextImage</span>) {</li><li>        <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>,</li><li>          <span class="hljs-variable">async</span> (<span class="hljs-variable">err</span>, <span class="hljs-variable">component</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">width</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the width</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the height</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">stride</span> = <span class="hljs-variable">component</span>.<span class="hljs-variable">rowStride</span>; <span class="hljs-comment">// Get stride by using component.rowStride</span></li><li>            <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">receiver</span> <span class="hljs-variable">getComponent</span> <span class="hljs-variable">width</span>:${<span class="hljs-variable">width</span>} <span class="hljs-variable">height</span>:${<span class="hljs-variable">height</span>} <span class="hljs-variable">stride</span>:${<span class="hljs-variable">stride</span>}`);</li><li>            <span class="hljs-comment">// Positive example: Case 1.stride and width are equal. Reading buffer by width does not affect the result.</span></li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">stride</span> === <span class="hljs-variable">width</span>) {</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>                <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>                <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>,</li><li>              })</li><li>              <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'stridePixel'</span>, <span class="hljs-variable">pixelMap</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-comment">// Positive example: Case 2.When width and stride are not equal，</span></li><li>              <span class="hljs-comment">// At this time, the camera returned preview stream data component.byteBuffer to remove stride,</span></li><li>              <span class="hljs-comment">// copy the new dstArr data, data processing to other do not support stride interface processing.</span></li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">dstBufferSize</span> = <span class="hljs-variable">width</span> * <span class="hljs-variable">height</span> * <span class="hljs-number">1.5</span>; <span class="hljs-comment">// Create a dstBufferSize space of width * height * 1.5. This is NV21 data format.</span></li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">dstArr</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">dstBufferSize</span>); <span class="hljs-comment">// Store the buffer after the stride is removed.</span></li><li>              <span class="hljs-comment">// For each line of data read, the camera supports an even width and height profile, which does not involve rounding.</span></li><li>              <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">height</span> * <span class="hljs-number">1.5</span>; <span class="hljs-title class_">j</span>++) { <span class="hljs-comment">// Loop each row of dstArr data.</span></li><li>                <span class="hljs-comment">// Copy the first width bytes of each line of data from component.byteBuffer into dstArr</span></li><li>                <span class="hljs-comment">// (remove invalid pixels and get exactly an eight-byte array space of width*height per line).</span></li><li>                <span class="hljs-keyword">const</span> <span class="hljs-variable">srcBuf</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">stride</span>,</li><li>                  <span class="hljs-variable">width</span>); <span class="hljs-comment">// The buffer returned by component.byteBuffer traverses each line, starting at the top, with width bytes cut off each line.</span></li><li>                <span class="hljs-variable">dstArr</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">srcBuf</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">width</span>); <span class="hljs-comment">// Store the width*height data in dstArr.</span></li><li>              }</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">dstArr</span>.<span class="hljs-variable">buffer</span>, {</li><li>                <span class="hljs-comment">// The processed dstArr array buffer creates pixelMap directly by width and height,</span></li><li>                <span class="hljs-comment">// and stores it in the global variable stridePixel and passes it to Image for display.</span></li><li>                <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>                <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>,</li><li>              })</li><li>              <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'stridePixel'</span>, <span class="hljs-variable">pixelMap</span>);</li><li>            }</li><li>            <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">release</span>();</li><li>          })</li><li>      }</li><li>    });</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceOne.ets#L46-L96" target="_blank">CameraServiceOne.ets</a></div></div></div></div> </li></ol> <p>【正例二】开发者使用width，height，stride三个值，处理相机预览流数据，处理stride方法二如下。</p> <p>分两种情况：</p> <ol><li>当stride和width相等时，与正例一情况一致，此处不再赘述。</li><li>当stride和width不等时，如果应用想使用byteBuffer预览流数据创建pixelMap直接显示，可以根据stride*height字节的大小先创建pixelMap，然后调用PixelMap的cropSync()方法裁剪掉多余的像素，从而正确处理stride，解决预览流花屏问题。<div class="screenLinkPre"><div _ngcontent-nff-c106="" class="highlight-div"><div _ngcontent-nff-c106="" class="highlight-div-header"><div _ngcontent-nff-c106="" class="highlight-div-header-left"><div _ngcontent-nff-c106="" class="handle-button expand-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nff-c106="" class="highlight-div-header-right"><div _ngcontent-nff-c106="" class="handle-button ai-button"></div><div _ngcontent-nff-c106="" class="handle-button line-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nff-c106="" class="handle-button theme-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nff-c106="" class="handle-button copy-button"><div _ngcontent-nff-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nff-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceTwo.ets#L46-L89" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable">receiver</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageReceiver</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, () =&gt; {</li><li>    <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">readNextImage</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">nextImage</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span>) =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">nextImage</span>) {</li><li>        <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">_err</span>, <span class="hljs-variable">component</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">width</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the width</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">height</span> = <span class="hljs-number">1080</span>; <span class="hljs-comment">// Application create preview stream resolution corresponding to the height</span></li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">stride</span> = <span class="hljs-variable">component</span>.<span class="hljs-variable">rowStride</span>; <span class="hljs-comment">// Get stride by using component.rowStride</span></li><li>          <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">receiver</span> <span class="hljs-variable">getComponent</span> <span class="hljs-variable">width</span>:${<span class="hljs-variable">width</span>} <span class="hljs-variable">height</span>:${<span class="hljs-variable">height</span>} <span class="hljs-variable">stride</span>:${<span class="hljs-variable">stride</span>}`);</li><li>          <span class="hljs-comment">// stride and width are equal. Reading buffer by width does not affect the result</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">stride</span> === <span class="hljs-variable">width</span>) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>              <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>              <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>,</li><li>            })</li><li>            <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'stridePixel'</span>, <span class="hljs-variable">pixelMap</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>              <span class="hljs-comment">// Positive example: 1. width transmission stride when creating PixelMap.</span></li><li>              <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">stride</span> },</li><li>              <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-number">8</span>,</li><li>            })</li><li>            <span class="hljs-comment">// 2. then call the cropSync method of PixelMap to crop out the excess pixels.</span></li><li>            <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">cropSync</span>({</li><li>              <span class="hljs-variable">size</span>: { <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span> },</li><li>              <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>              <span class="hljs-variable">y</span>: <span class="hljs-number">0</span></li><li>            }) <span class="hljs-comment">// Crop the image according to the size entered, starting with (0,0), crop the area of width*height bytes.</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelBefore</span>: <span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'stridePixel'</span>);</li><li>            <span class="hljs-variable">await</span> <span class="hljs-variable">pixelBefore</span>?.<span class="hljs-title function_">release</span>();</li><li>            <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'stridePixel'</span>, <span class="hljs-variable">pixelMap</span>);</li><li>          }</li><li>          <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">release</span>();</li><li>        })</li><li>      }</li><li>    });</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/DealStrideSolution/entry/src/main/ets/utils/CameraServiceTwo.ets#L46-L89" target="_blank">CameraServiceTwo.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section194901143142512">效果对比<i class="anchor-icon anchor-icon-link" anchorid="section194901143142512" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b></caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.1" valign="top" width="33.33333333333333%"><p>（反例）未处理stride</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.2" valign="top" width="33.33333333333333%"><p>（正例）处理stride的方案一</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.4.2.2.4.1.3" valign="top" width="33.33333333333333%"><p>（正例）处理stride的方案二</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p></p> <p><span><img height="576.2890000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.96666913939605075959345221422157:50001231000000:2800:222C8222B0EEE9C6D21063C53B16411CACEE20B2FA3174202F01206DEF7E3E53.gif" title="点击放大" width="280.28420000000006"></span></p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p></p> <p><span><img height="576.2890000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.69023619163858681016320722683451:50001231000000:2800:4B1A932855556C0A83089BB15CB5FA5D404C4284DE14DC29B186508DD0ABE757.gif" title="点击放大" width="280.28420000000006"></span></p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p></p> <p><span><img height="576.2890000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.36308993368750222781729975563951:50001231000000:2800:0D71C766ADBBA07EB283BB86060CC4CD1EA4CFEB42F116764A88946CAC242F3E.gif" title="点击放大" width="280.28420000000006"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section1951835416591">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section1951835416591" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section4758732152116" class="firsth2">如何获取相机预览流帧数据<i class="anchor-icon anchor-icon-link" anchorid="section4758732152116" tips="复制节点链接"></i></h3><p>通过ImageReceiver中imageArrival事件监听获取底层返回的图像数据，详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-dual-channel-preview#开发步骤" target="_blank">双路预览(ArkTS)</a>。</p> </div> <div class="tiledSection"><h3 id="section5738135744617">如何获取预览流图像的stride的值<i class="anchor-icon anchor-icon-link" anchorid="section5738135744617" tips="复制节点链接"></i></h3><p>可以通过预览流帧数据的返回值image.Component.rowStride获取stride。</p> </div> <div class="tiledSection"><h2 id="section15760874013">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section15760874013" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/DealStrideSolution" target="_blank">处理stride解决相机预览流花屏问题</a></li></ul> </div> </div> <div></div></div>