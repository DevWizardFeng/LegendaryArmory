<h1 _ngcontent-lxp-c119="" class="doc-title ng-star-inserted" title="碰一碰文件分享"> 碰一碰文件分享 </h1>

<div _ngcontent-lxp-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section4151632164419">概述<i class="anchor-icon anchor-icon-link" anchorid="section4151632164419" tips="复制节点链接"></i></h2><p>随着消费者终端设备不断增加，不同设备间进行文本分享（链接、文本等）和文件分享（图片、视频、文档等）已成为用户日常生活中不可或缺的需求。HarmonyOS通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-introduction" target="_blank">Share Kit（分享服务）</a>提供便捷的分享功能，其中“碰一碰”分享功能使用户能够轻松实现跨设备分享。本文将重点介绍应用如何实现碰一碰文件分享。</p> </div> <div class="tiledSection"><h2 id="section1576816129588">特性体验<i class="anchor-icon anchor-icon-link" anchorid="section1576816129588" tips="复制节点链接"></i></h2><p>目前HarmonyOS 6.0.0 Beta1及以上版本的手机和PC支持两种触碰形式：手机碰手机和手机碰PC。由于设备形态和操作系统的限制，这两种形式具有不同的特性和体验。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>手机与手机碰一碰对华为账号无要求，而手机与PC/2in1碰一碰则需登录同一华为账号方可进行分享。</p> </div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.1" valign="top" width="7.59075907590759%">&nbsp;&nbsp;</th> <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.2" valign="top" width="36.743674367436746%"><p>手机碰手机</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.4.1.4.1.3" valign="top" width="55.66556655665566%"><p>手机碰PC</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="7.59075907590759%"><p>手机发送</p> </td> <td class="cellrowborder" rowspan="2" valign="top" width="36.743674367436746%"><p>通过手机顶部的相碰触发，文件被设备接收，接收端将媒体文件存储到图库中，非媒体文件存储到文件管理器中。</p> <p><span><img height="296.47305744493605" originheight="1080" originwidth="1144" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163249.17750435929470499274322160591618:50001231000000:2800:2F9CAC16D63B8108ADF5A7DDFB630BBF05413C4BD1C2A96682B2A06A1F987D25.gif" title="点击放大" width="314.041804180418"></span></p> <p></p> </td> <td class="cellrowborder" valign="top" width="55.66556655665566%"><p>通过手机顶部与PC窗口的相碰触发，交互和设备约束详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-pc-phones-overview#section484625701614" target="_blank">手机pc碰一碰交互和设备约束</a>，文件应被窗口所属的应用接收，统一存储入沙箱文件中。</p> <p><span><img height="209.193338027136" originheight="1080" originwidth="2520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163250.80724516267926928675014371221490:50001231000000:2800:D149A725C1EB85110C2AD65A842FD2A43CF81BC0649BE09F3A52A7FF6C42814C.gif" title="点击放大" width="488.123212321232"></span></p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>手机接收</p> </td> <td class="cellrowborder" valign="top"><p>通过手机顶部与PC窗口的相碰触发，交互和设备约束详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-pc-phones-overview#section484625701614" target="_blank">手机pc碰一碰交互和设备约束</a>，文件被手机设备接收，接收端将媒体文件存储到图库中，非媒体文件存储到文件管理器中。</p> <p><span><img height="134.5878492115878" originheight="1080" originwidth="2520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163250.25343288877458778787289540358416:50001231000000:2800:8247650C53507D3DB6B98077232407C2B06B75EF621B3853A6DEBA987C2664BA.gif" title="点击放大" width="314.041804180418"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section910719516310">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section910719516310" tips="复制节点链接"></i></h2><p><span><img height="416.79540000000003" originheight="3444" originwidth="6594" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163250.79595390548095066363897106185778:50001231000000:2800:38ECB7496608A84DAFB791C1732E0D9504D787DCB090603D3FDC2A93F50FEE1A.png" title="点击放大" width="798"></span></p> <p>碰一碰文件分享基于华为分享服务，通过手机与手机碰一碰或手机与PC/2in1屏幕碰一碰实现文件的跨端传输。应用需实现监听方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share#section1215414133214" target="_blank">harmonyShare.on('knockShare')</a>，用户触发碰一碰后即可分享文件至对方设备。文件接收则由分享服务按照<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-access-one-step" target="_blank">规则</a>处理，存储于图库或文件管理中。</p> <p><span><img height="416.79540000000003" originheight="3444" originwidth="6594" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163250.91089028396492929045674821085538:50001231000000:2800:0771D9DCB240B3F10D6E18C2462BA786884D2E9D168E3062C150B2100F7A8B5D.png" title="点击放大" width="798"></span></p> <p>PC/2in1设备除了可以默认碰一碰将文件保存到文件管理中，应用还可以注册监听文件接收接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share#section1365282783615" target="_blank">harmonyShare.on('dataReceive')</a>方法，手机分享的文件将存储于应用沙箱目录下。详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-between-phones" target="_blank">手机与手机碰一碰分享</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-pc-phones" target="_blank">手机与PC/2in1碰一碰分享</a>。</p> </div> <div class="tiledSection"><h2 id="section143315975211">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section143315975211" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0997243321" class="firsth2">发起分享<i class="anchor-icon anchor-icon-link" anchorid="section0997243321" tips="复制节点链接"></i></h3><ol><li>分享数据构建<p>在分享数据时，分享发起方需要构建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-system-share#section20696483813" target="_blank">SharedRecord</a>。在文件分享的场景中，发起方在构造此参数时，必须传入uri和utd这两个属性。其中，uri属性仅在文件分享场景中为必填项，而在内容分享场景下content属性则为必填项，uri属性不需要传值。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>uri是指要分享的文件URI，而非文件路径，例如沙箱路径content.fileDir，应通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-file-fileuri#fileurigeturifrompath" target="_blank">fileUri.getUriFromPath()</a>获取其URI。</li><li>utd则是当前文件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uniform-data-type-list" target="_blank">标准化数据类型</a>，需要传入准确的值，以便系统匹配精确的目标应用，推荐使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-uniformtypedescriptor#uniformtypedescriptorgetuniformdatatypebyfilenameextension11" target="_blank">uniformTypeDescriptor.getUniformDataTypeByFilenameExtension()</a>方法，通过给定的文件后缀名查询标准化数据类型的ID，详情可见<a href="/consumer/cn/doc/best-practices/bpta-application-knock-file-share#section131364139197">不同类型分享数据构建</a>。</li></ul> </div></div></div> <div class="screenLinkPre"><div _ngcontent-lxp-c106="" class="highlight-div"><div _ngcontent-lxp-c106="" class="highlight-div-header"><div _ngcontent-lxp-c106="" class="highlight-div-header-left"><div _ngcontent-lxp-c106="" class="handle-button expand-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxp-c106="" class="highlight-div-header-right"><div _ngcontent-lxp-c106="" class="handle-button ai-button"></div><div _ngcontent-lxp-c106="" class="handle-button line-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxp-c106="" class="handle-button theme-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxp-c106="" class="handle-button copy-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L48-L85" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Knock listening callback.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param target After the Huawei Share event is triggered,</span></li><li><span class="hljs-comment"> * you can call back the parameters and share them across devices.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">immersiveCallback</span>(<span class="hljs-variable">target</span>: <span class="hljs-title class_">harmonyShare</span>.<span class="hljs-title class_">SharableTarget</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">fileShare</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'KnockFileShare_fileShare'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>[];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">videoDataList</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'KnockFileShare_videoDataList'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">FileData</span>[];</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">fileShare</span> || <span class="hljs-variable">fileShare</span>.<span class="hljs-variable">length</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">shareData</span>: <span class="hljs-title class_">systemShare</span>.<span class="hljs-title class_">SharedData</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">systemShare</span>.<span class="hljs-title function_">SharedData</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getShareRecord</span>(<span class="hljs-variable">videoDataList</span>[<span class="hljs-variable">fileShare</span>[<span class="hljs-number">0</span>]]));</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">1</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">fileShare</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-variable">shareData</span>.<span class="hljs-title function_">addRecord</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getShareRecord</span>(<span class="hljs-variable">videoDataList</span>[<span class="hljs-variable">fileShare</span>[<span class="hljs-variable">i</span>]]));</li><li>  }</li><li>  <span class="hljs-variable">target</span>.<span class="hljs-title function_">share</span>(<span class="hljs-variable">shareData</span>);</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Get shared data.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param data File data to be shared.</span></li><li><span class="hljs-comment"> * @returns systemShare.SharedRecord.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-title function_">getShareRecord</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">FileData</span>): <span class="hljs-title class_">systemShare</span>.<span class="hljs-title class_">SharedRecord</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">suffix</span> = <span class="hljs-string">'.'</span> + <span class="hljs-variable">data</span>.<span class="hljs-variable">url</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>();</li><li>  <span class="hljs-comment">// Obtain the UTD through the file extension.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">utd</span> = <span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-title function_">getUniformDataTypeByFilenameExtension</span>(<span class="hljs-variable">suffix</span>);</li><li>  <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'KnockFileShare'</span>, `<span class="hljs-variable">getShareRecord</span> <span class="hljs-variable">utd</span> ${<span class="hljs-variable">utd</span>}`)</li><li>  <span class="hljs-keyword">return</span> {</li><li>    <span class="hljs-variable">utd</span>: <span class="hljs-title class_">utd</span>,</li><li>    <span class="hljs-variable">uri</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">url</span>,</li><li>    <span class="hljs-variable">thumbnailUri</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">thumbnail</span>,</li><li>    <span class="hljs-variable">title</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">name</span>,</li><li>    <span class="hljs-variable">description</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">description</span></li><li>  };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L48-L85" target="_blank">KnockController.ets</a></div></div></div></div> </li><li>分享注册<p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share" target="_blank">华为分享</a>模块提供了碰一碰分享事件的监听方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share#section1215414133214" target="_blank">on('knockShare')</a>。在回调中调用this.immersiveCallback()方法，实现分享数据的构建，并通过sharableTarget.share()方法传输文件数据，完成碰一碰文件分享流程。</p> <p>分享模块也同样提供了取消监听的方法<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share#section18498201183311" target="_blank">off('knockShare')</a>，当应用不需要碰一碰分享文件或离开页面（包括应用退至后台等情况）时，应及时调用取消监听的方法，以避免资源浪费和异常触发。</p> <p>需要注意的是，PC端的碰一碰事件监听和取消监听需要传入窗口的ID，如immersiveListeningPC()和immersiveDisableListeningPC()方法所示。</p> <div class="screenLinkPre"><div _ngcontent-lxp-c106="" class="highlight-div"><div _ngcontent-lxp-c106="" class="highlight-div-header"><div _ngcontent-lxp-c106="" class="highlight-div-header-left"><div _ngcontent-lxp-c106="" class="handle-button expand-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxp-c106="" class="highlight-div-header-right"><div _ngcontent-lxp-c106="" class="handle-button ai-button"></div><div _ngcontent-lxp-c106="" class="handle-button line-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxp-c106="" class="handle-button theme-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxp-c106="" class="handle-button copy-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L89-L133" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  Add knock listening.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">immersiveListening</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Collaboration.HarmonyShare'</span>)) {</li><li>    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-function">(<span class="hljs-params">target: harmonyShare.SharableTarget</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">immersiveCallback</span>(target);</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  Add knock listening in 2in1 device type.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">immersiveListeningPC</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Collaboration.HarmonyShare'</span>)) {</li><li>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">mainWindowID</span>: <span class="hljs-built_in">number</span> = data.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">id</span>;</li><li>      harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, { <span class="hljs-attr">windowId</span>: mainWindowID }, <span class="hljs-function">(<span class="hljs-params">target: harmonyShare.SharableTarget</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">immersiveCallback</span>(target);</li><li>      });</li><li>    })</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  remove knock listening.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">immersiveDisableListening</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Collaboration.HarmonyShare'</span>)) {</li><li>    harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> *  remove knock listening.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">immersiveDisableListeningPC</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Collaboration.HarmonyShare'</span>)) {</li><li>    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">mainWindowID</span>: <span class="hljs-built_in">number</span> = data.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-property">id</span>;</li><li>      harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>, { <span class="hljs-attr">windowId</span>: mainWindowID });</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L89-L133" target="_blank">KnockController.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section10625131515238">接收文件<i class="anchor-icon anchor-icon-link" anchorid="section10625131515238" tips="复制节点链接"></i></h3></div> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share" target="_blank">华为分享</a>模块提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/share-harmony-share#section1365282783615" target="_blank">harmonyShare.on('dataReceive')</a>方法，用于实现应用沙箱接收文件的事件监听。请注意当前接口仅在2in1设备类型可以正常调用，其他设备类型会返回801错误码。</p> <p>PC/2in1应用可以通过监听harmonyShare.on('dataReceive')方法来实现应用沙箱接收文件。该方法需要传入当前应用的窗口ID，并且需要传入capabilities属性，以表示当前应用支持接收的文件标准化数据类型及其最大接收数量，该属性不能传入空数组。</p> <p>在dataReceive回调方法中，通过receiveTarget.receive()传入应用接收文件的沙箱路径。当应用接收到碰一碰分享的文件后，会触发onDataReceived回调，开发者可以通过回调参数shareData.getRecords()获取分享的数据，当碰一碰接收事件结束后，将响应onResult回调，通过参数resultCode判断分享接收事件是否成功。</p> <div class="screenLinkPre"><div _ngcontent-lxp-c106="" class="highlight-div"><div _ngcontent-lxp-c106="" class="highlight-div-header"><div _ngcontent-lxp-c106="" class="highlight-div-header-left"><div _ngcontent-lxp-c106="" class="handle-button expand-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lxp-c106="" class="highlight-div-header-right"><div _ngcontent-lxp-c106="" class="handle-button ai-button"></div><div _ngcontent-lxp-c106="" class="handle-button line-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lxp-c106="" class="handle-button theme-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lxp-c106="" class="handle-button copy-button"><div _ngcontent-lxp-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lxp-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/fengcreate/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L137-L205" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Add dataReceive listening in 2in1 device type.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">dataReceiveListeningPC</span>() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Collaboration.HarmonyShare'</span>)) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>).<span class="hljs-title function_">then</span>(((<span class="hljs-variable">data</span>) =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">mainWindowID</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">data</span>.<span class="hljs-title function_">getWindowProperties</span>().<span class="hljs-variable">id</span>;</li><li>    <span class="hljs-variable">harmonyShare</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'dataReceive'</span>, { <span class="hljs-variable">windowId</span>: <span class="hljs-title class_">mainWindowID</span>, <span class="hljs-variable">capabilities</span>: [</li><li>      {</li><li>        <span class="hljs-string">'utd'</span>: <span class="hljs-title class_">uniformTypeDescriptor</span>.<span class="hljs-title class_">UniformDataType</span>.<span class="hljs-title class_">MEDIA</span>,</li><li>        <span class="hljs-string">'maxSupportedCount'</span>: <span class="hljs-number">5</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">'utd'</span>: <span class="hljs-title class_">uniformTypeDescriptor</span>.<span class="hljs-title class_">UniformDataType</span>.<span class="hljs-title class_">FILE</span>,</li><li>        <span class="hljs-string">'maxSupportedCount'</span>: <span class="hljs-number">5</span></li><li>      }</li><li>    ] },</li><li>      (<span class="hljs-variable">receiveTarget</span>: <span class="hljs-title class_">harmonyShare</span>.<span class="hljs-title class_">ReceivableTarget</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// Process the received file data.</span></li><li>        <span class="hljs-variable">receiveTarget</span>.<span class="hljs-title function_">receive</span>(<span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span>), {</li><li>          <span class="hljs-variable">onDataReceived</span>: (<span class="hljs-variable">shareData</span>: <span class="hljs-title class_">systemShare</span>.<span class="hljs-title class_">SharedData</span>) =&gt; {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">shareRecords</span> = <span class="hljs-variable">shareData</span>.<span class="hljs-title function_">getRecords</span>();</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">videoDataList</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'KnockFileShare_videoDataList'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">FileData</span>[];</li><li>            <span class="hljs-variable">shareRecords</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-variable">async</span> (<span class="hljs-variable">record</span>: <span class="hljs-title class_">systemShare</span>.<span class="hljs-title class_">SharedRecord</span>) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (!<span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>) {</li><li>                <span class="hljs-keyword">return</span>;</li><li>              }</li><li>              <span class="hljs-comment">// Get video thumbnails.</span></li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">fileName</span> = <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'/'</span>).<span class="hljs-title function_">pop</span>()?.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>)[<span class="hljs-number">0</span>];</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">thumbPath</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">videoDataList</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">thumbnail</span>;</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'mp4'</span>) || <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'mkv'</span>)) {</li><li>                <span class="hljs-variable">thumbPath</span> = <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">lastIndexOf</span>(<span class="hljs-string">'.'</span>)) + <span class="hljs-string">'thumb.png'</span>;</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-variable">result</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">new</span> <span class="hljs-title function_">FileUtil</span>().<span class="hljs-title function_">getVideoThumbnail</span>(<span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>, <span class="hljs-variable">thumbPath</span>);</li><li>                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">result</span>) {</li><li>                  <span class="hljs-variable">thumbPath</span> = <span class="hljs-variable">videoDataList</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">thumbnail</span>;</li><li>                }</li><li>              } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'png'</span>) || <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'jpg'</span>) || <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>.<span class="hljs-title function_">endsWith</span>(<span class="hljs-string">'jpeg'</span>)) {</li><li>                <span class="hljs-variable">thumbPath</span> = <span class="hljs-variable">record</span>.<span class="hljs-variable">uri</span>;</li><li>              } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-variable">thumbPath</span> = <span class="hljs-variable">videoDataList</span>[<span class="hljs-number">0</span>].<span class="hljs-variable">thumbnail</span>;</li><li>              }</li><li>
</li><li>              <span class="hljs-variable">videoDataList</span>.<span class="hljs-title function_">push</span>({</li><li>                <span class="hljs-variable">url</span>: <span class="hljs-title class_">record</span>.<span class="hljs-title class_">uri</span>,</li><li>                <span class="hljs-variable">name</span>: <span class="hljs-title class_">fileName</span>,</li><li>                <span class="hljs-variable">description</span>: <span class="hljs-title class_">record</span>.<span class="hljs-title class_">description</span>,</li><li>                <span class="hljs-variable">thumbnail</span>: <span class="hljs-title class_">thumbPath</span>,</li><li>                <span class="hljs-variable">index</span>: <span class="hljs-title class_">videoDataList</span>.<span class="hljs-title class_">length</span></li><li>              });</li><li>            });</li><li>          },</li><li>          <span class="hljs-title function_">onResult</span>(<span class="hljs-variable">resultCode</span>: <span class="hljs-title class_">harmonyShare</span>.<span class="hljs-title class_">ShareResultCode</span>) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">resultCode</span> === <span class="hljs-variable">harmonyShare</span>.<span class="hljs-variable">ShareResultCode</span>.<span class="hljs-variable">SHARE_SUCCESS</span>) {</li><li>              <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'KnockFileShare'</span>, <span class="hljs-string">'receive file success'</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'KnockFileShare'</span>, <span class="hljs-string">'receive failed '</span> + <span class="hljs-variable">resultCode</span>);</li><li>            }</li><li>          }</li><li>        });</li><li>      });</li><li>  })).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'KnockFileShare'</span>, `<span class="hljs-variable">failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">obtain</span> <span class="hljs-variable">the</span> <span class="hljs-variable">window</span>. <span class="hljs-variable">cause</span> ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>} ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/fengcreate/KnockFileShare/blob/master/entry/src/main/ets/controller/KnockController.ets#L137-L205" target="_blank">KnockController.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1576453162420">系统拦截策略<i class="anchor-icon anchor-icon-link" anchorid="section1576453162420" tips="复制节点链接"></i></h2><p>碰一碰分享接收端接收数据时遵循统一规则，详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-access-one-step" target="_blank">目标设备接收分享数据一步直达体验</a>。</p> </div> <div class="tiledSection"><h2 id="section131364139197">不同类型分享数据构建<i class="anchor-icon anchor-icon-link" anchorid="section131364139197" tips="复制节点链接"></i></h2><p>碰一碰文件分享需要关注文件分享类型，在<a href="/consumer/cn/doc/best-practices/bpta-application-knock-file-share#section0997243321">发起分享</a>时作为参数传入，系统提供标准化数据类型解决跨设备传输中的数据类型模糊问题，通过统一的数据格式标识，接收端可精准识别文件属性。例如图片自动匹配图库应用接收，文档类文件定向唤起文件管理器，实现数据与处理程序的自动绑定。当传入的分享参数的utd为uniformTypeDescriptor.UniformDataType.IMAGE时，且文件确认为图片文件，接收端会默认将其存储在图库中。当传入的utd为uniformTypeDescriptor.UniformDataType.FILE时，文件会默认存储到文件管理中。系统中预置了一部分常用类型，更多类型可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/uniform-data-type-list" target="_blank">UTD预置列表</a>。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.3.1.5.1.1" valign="top" width="15.441544154415443%"><p><strong>后缀名</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.5.1.2" valign="top" width="20.482048204820483%"><p><strong>UTD-ID</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.5.1.3" valign="top" width="26.842684268426847%"><p><strong>MIMEType类型</strong></p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.3.1.5.1.4" valign="top" width="37.23372337233724%"><p><strong>说明</strong></p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.png</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>general.png</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>image/png</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>PNG图片类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.jpg，.jpeg，.jpe</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>general.jpeg</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>image/jpeg</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>JPEG图片类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.mp4，.mp4v，.mpeg4</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>general.mpeg-4</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>video/mp4，video/mp4v</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>MPEG-4视频类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.avi，.vfw</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>general.avi</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>video/avi，video/msvideo，video/x-msvideo</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>AVI视频类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.txt，.text</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>general.plain-text</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>text/plain</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>未指定编码的文本类型，无修饰的文本。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.doc</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>com.microsoft.word.doc</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>application/msword</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>Microsoft Word数据类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.xls</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>com.microsoft.excel.xls</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>application/vnd.ms-excel</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>Microsoft Excel数据类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>.ppt</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>com.microsoft.powerpoint.ppt</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>application/vnd.ms-powerpoint</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>Microsoft PowerPoint演示文稿类型。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.441544154415443%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="20.482048204820483%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="26.842684268426847%"><p>...</p> </td> <td class="cellrowborder" valign="top" width="37.23372337233724%"><p>...</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section3254442184414">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section3254442184414" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section6406182494612" class="firsth2">数据在分享过程中被丢弃或者提示无效的数据类型<i class="anchor-icon anchor-icon-link" anchorid="section6406182494612" tips="复制节点链接"></i></h3><p>分享服务支持内容分享和文件分享两种场景，但不支持两者混合分享。在混合分享时，数据可能会在分享过程中丢失或提示无效的数据类型。详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/share-faq-2" target="_blank">分享数据类型不支持</a>。</p> </div> <div class="tiledSection"><h2 id="section2500053172119">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section2500053172119" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/KnockFileShare" target="_blank">碰一碰文件分享</a></li></ul> </div> </div> <div></div></div>