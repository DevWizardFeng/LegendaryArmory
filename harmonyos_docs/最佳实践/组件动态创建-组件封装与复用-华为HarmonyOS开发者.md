<h1 _ngcontent-dxu-c119="" class="doc-title ng-star-inserted" title="组件动态创建"> 组件动态创建 </h1>

<div _ngcontent-dxu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section15392184711100">概述<i class="anchor-icon anchor-icon-link" anchorid="section15392184711100" tips="复制节点链接"></i></h2><p>为了解决页面、组件加载缓慢的问题，ArkUI框架提供了动态操作以实现组件预创建，并允许应用在运行时根据实际需要加载渲染相应的组件。动态操作包含动态创建组件（动态添加组件）、动态卸载组件（动态删除组件）等相关操作。动态创建组件指在非build生命周期中进行组件创建，即在build生命周期前提前创建组件。通过动态创建组件，不但可以节省组件创建的时间，提升用户体验，还可以将独立的逻辑进行封装，有助于应用模块化开发。动态卸载组件是对动态创建的组件进行卸载、删除。</p> </div> <div class="tiledSection"><h2 id="section1392174713107">组件预创建原理<i class="anchor-icon anchor-icon-link" anchorid="section1392174713107" tips="复制节点链接"></i></h2><p>在声明式范式中，组件仅在build环节中被创建，开发者无法在其他生命周期阶段进行组件的创建，从而引起页面加载慢等问题。与声明式范式不同，ArkUI框架提供的UI动态操作支持组件的预创建。组件预创建可以满足开发者在非build生命周期中进行组件创建，创建后的组件可以进行属性设置、布局计算等操作。之后在页面加载时进行使用，可以极大提升页面响应速度。</p> <p>如下图所示，利用组件预创建机制，可以利用动画执行过程空闲时间进行组件预创建和属性设置。在动画结束后，再进行属性和布局的更新，节省了组件创建的时间，从而加快了页面渲染。</p> <div class="fignone"><span class="figcap"><b>图1 </b>组件预创建原理图</span><br><span><img height="321.195" originheight="615" originwidth="1000" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162859.01929184172420595190480921432826:50001231000000:2800:24395FC1D695E280022AE9E5F18B82C51E1DF5616BBF191EE12E968230319D80.jpg" title="点击放大" width="523.6875"></span></div> </div> <div class="tiledSection"><h2 id="section5738955375">FrameNode自定义节点在动态布局场景下的优势<i class="anchor-icon anchor-icon-link" anchorid="section5738955375" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section125816188372" class="firsth2">减少自定义组件创建开销<i class="anchor-icon anchor-icon-link" anchorid="section125816188372" tips="复制节点链接"></i></h3><p>在采用声明式开发范式中，若使用ArkUI的自定义组件对节点树中的每个节点进行定义，往往会遇到节点创建效率低下的问题。</p> <p>这主要是因为每个节点在ArkTS引擎中都需要分配内存空间来存储应用程序的自定义组件和状态变量。在节点创建过程中，还必须执行组件ID、组件闭包以及状态变量之间的依赖关系收集等操作。</p> <p>相比之下，使用ArkUI的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-framenode" target="_blank">FrameNode</a>，可以避免创建自定义组件对象和状态变量对象，无需进行依赖收集，从而显著提升组件创建的速度。</p> </div> <div class="tiledSection"><h3 id="section4461163114376">组件更新更快<i class="anchor-icon anchor-icon-link" anchorid="section4461163114376" tips="复制节点链接"></i></h3><p>在动态布局类框架的更新场景中，通常存在一个由树形数据结构ViewModelA创建的UI组件树TreeA。当需要使用新的数据结构ViewModelB来更新TreeA时，尽管声明式开发范式可以实现数据驱动的自动更新，但这一过程中却伴随着大量的diff操作，如下图所示。对于ArkTS引擎而言，在对一个复杂组件树（深度超过30层，包含100至200个组件）执行diff算法时，几乎无法在120Hz的刷新率下保持满帧运行。然而，使用ArkUI的FrameNode扩展，框架能够自主掌控更新流程，实现高效的按需剪枝。特别是针对那些仅服务于少数特定业务的动态布局框架，利用这一扩展，可以实现快速的更新操作。</p> <p><span><img height="352.80843500000003" originheight="5300" originwidth="7867" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162859.92900380945583731653777404282141:50001231000000:2800:DB2DEE04562671EC4D1FCC59A7DE56CB2D77E2D75955BBDF197B987A0025BE86.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h3 id="section693854393714">直接操作组件树<i class="anchor-icon anchor-icon-link" anchorid="section693854393714" tips="复制节点链接"></i></h3><p>使用声明式开发范式还存在组件树结构更新操作困难的痛点，比如将组件树中的一个子树从当前子节点完整移到另一个子节点，使用声明式开发范式无法直接调整组件实例的结构关系，只能通过重新渲染整棵组件树的方式实现上述操作。而使用ArkUI的FrameNode扩展，则可以通过操作FrameNode来很方便的操控该子树，将其移植到另一个节点，这样只会进行局部渲染刷新，性能更优。</p> <p><span><img height="217.398874" originheight="4933" originwidth="11883" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162859.99112812981406329803683467209563:50001231000000:2800:F5EEAD752505A4C790A96F7B50B698B7888EF74DCF12239069D7B0E5853D884C.png" title="点击放大" width="523.6875"></span></p> </div> <div class="tiledSection"><h2 id="section153921947151012">组件动态添加、更新和删除：<i class="anchor-icon anchor-icon-link" anchorid="section153921947151012" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section499511288108" class="firsth2">动态添加组件<i class="anchor-icon anchor-icon-link" anchorid="section499511288108" tips="复制节点链接"></i></h3><p>动态添加组件包括以下步骤：</p> <ol><li><span>创建自定义节点。</span></li><li><span>实现<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>，用于自定义节点的创建、显示、更新等操作的管理，并负责将自定义节点挂载到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer#nodecontainer-1" target="_blank">NodeContainer</a>上。</span></li><li><span>实现NodeController的makeNode()方法，makeNode()会在NodeController实例绑定NodeContainer的时候进行回调，并将返回的节点挂载至NodeContainer。</span></li><li><span>使用NodeContainer显示自定义节点。</span></li></ol> </div> <ul><li>创建自定义节点<p>首先，准备好需要挂载的节点，代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment.ets#L2-L21" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BuilderNode</span>, <span class="hljs-title class_">FrameNode</span>, <span class="hljs-title class_">NodeController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">Params</span> {</li><li>  <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Hello World'</span>;</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = text;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Builder</span></li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">testBuilder</span>(<span class="hljs-params">params: Params</span>) {</li><li>  <span class="hljs-title class_">Column</span>() {</li><li>    <span class="hljs-title class_">Text</span>(params.<span class="hljs-property">text</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">50</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-title class_">FontWeight</span>.<span class="hljs-property">Bold</span>)</li><li>      .<span class="hljs-title function_">margin</span>({<span class="hljs-attr">bottom</span>: <span class="hljs-number">36</span>})</li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment.ets#L2-L21" target="_blank">segment.ets</a></div></div></div></div> </li></ul> <ul><li>实现NodeController<p>NodeController为抽象类，需要继承并实现NodeController，代码如下所示。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment.ets#L25-L38" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">textNode</span>: <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">message</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">message</span> = <span class="hljs-variable">message</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">null</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">null</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment.ets#L25-L38" target="_blank">segment.ets</a></div></div></div></div> </li></ul> <ul><li>实现NodeController的makeNode()方法<p>首先，使用构造函数创建BuilderNode实例。创建BuilderNode对象的时候必须要传入对应的UIContext对象。若BuilderNode作为RenderNode的子节点存在，要求设置RenderOptions的selfIdealSize属性。</p> <p>然后，使用BuilderNode的build()方法，构建组件树。方法build()需要传入两个参数，第一个参数为通过wrapBuilder()封装的全局@Builder方法。第二个参数为对应的@Builder方法所需的参数对象。若@Builder方法不带参数或者存在默认参数，则build()的第二个参数可以不设置。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment2.ets#L2-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> textNode: BuilderNode&lt;[Params]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> message: string = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(message: string) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.message = message;</li><li>  }</li><li>
</li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-comment">// Creating a BuilderNode instance</span></li><li>    <span class="hljs-keyword">this</span>.textNode = new BuilderNode(context);</li><li>    <span class="hljs-comment">// Set the selfIdealSize property</span></li><li>    <span class="hljs-comment">// this.textNode = new BuilderNode(context, {selfIdealSize: {width: 100, height :100}});</span></li><li>    <span class="hljs-comment">// Build the component tree using the build method</span></li><li>    <span class="hljs-keyword">this</span>.textNode.build(wrapBuilder&lt;[Params]&gt;(testBuilder), new Params(<span class="hljs-keyword">this</span>.message));</li><li>    <span class="hljs-comment">// Returns the node to be displayed</span></li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.textNode.getFrameNode();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment2.ets#L2-L41" target="_blank">segment2.ets</a></div></div></div></div> </li></ul> <ul><li>显示自定义节点<p><span>显示自定义节点依赖声明式渲染容器</span>NodeContainer<span>以及对应的控制类</span>NodeController<span>。</span></p> <p>NodeController的makeNode()方法返回的节点会显示在对应的NodeContainer中。由于makeNode()需要返回的为一个FrameNode，因此如果预期显示BuilderNode的时候需要调用对应的BuilderNode的getFrameNode()方法，获取其根节点，详细代码如上TextNodeController中所示。</p> <p><span>然后，在页面内新增声明式渲染容器</span><span>NodeContainer</span><span>，创建工具类</span><span>NodeController</span><span>。通过NodeController将MakeNode中返回的节点在声明式渲染容器中进行显示。</span></p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment3.ets#L2-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">@Entry</span></li><li><span class="hljs-keyword">@Component</span></li><li>struct Index {</li><li>  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">message</span>: string = <span class="hljs-string">"hello"</span>;</li><li>  private textNodeController: TextNodeController = new <span class="hljs-built_in">TextNodeController</span>(this.message);</li><li>
</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">Row</span>() {</li><li>      <span class="hljs-built_in">Column</span>() {</li><li>        <span class="hljs-built_in">NodeContainer</span>(this.textNodeController)</li><li>          <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>          <span class="hljs-selector-class">.height</span>(<span class="hljs-number">100</span>)</li><li>          <span class="hljs-selector-class">.backgroundColor</span>('#FFF0F0F0')</li><li>      }</li><li>      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>    }</li><li>    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment3.ets#L2-L63" target="_blank">segment3.ets</a></div></div></div></div> </li></ul> <p></p> <ul><li>更新自定义节点<p>更新自定义节点，可参考BuilderNode的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-buildernode#update" target="_blank">update()</a>方法。</p> </li></ul> <div class="tiledSection"><h3 id="section339374741011">动态删除组件<i class="anchor-icon anchor-icon-link" anchorid="section339374741011" tips="复制节点链接"></i></h3></div> <p>通过条件控制语句可以将NodeContainer节点进行移除或者显示。如示例代码，将this.isShow更改为false则将节点从界面上移除。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment4.ets#L2-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>          <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        }</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'isShow'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span> = <span class="hljs-literal">false</span>;</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment4.ets#L2-L70" target="_blank">segment4.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section739494711012">动态更新组件<i class="anchor-icon anchor-icon-link" anchorid="section739494711012" tips="复制节点链接"></i></h3><p>动态将NodeContainer上的节点替换，依赖于NodeController的makeNode()和rebuild()方法。rebuild方法会触发makeNode的回调，刷新NodeContainer上显示的节点；makeNode()方法返回的为null，则移除NodeContainer下挂载的节点。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment5.ets#L2-L52" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">TextNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> textNode: BuilderNode&lt;[Params]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> message: string = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(message: string) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.message = message;</li><li>  }</li><li>
</li><li>  makeNode(context: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-comment">// With the addition of null handling, the following code is executed only when the BuilderNode is created for the first time; when replacing a node, textNode is not null</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.textNode == <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">this</span>.textNode = new BuilderNode(context);</li><li>      <span class="hljs-keyword">this</span>.textNode.build(wrapBuilder&lt;[Params]&gt;(testBuilder), new Params(<span class="hljs-keyword">this</span>.message));</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.textNode.getFrameNode();</li><li>  }</li><li>
</li><li>  replaceBuilderNode(newNode: BuilderNode&lt;Object[]&gt;) {</li><li>    <span class="hljs-keyword">this</span>.textNode = newNode;</li><li>    <span class="hljs-comment">// The rebuild method re-calls the makeNode method.</span></li><li>    <span class="hljs-keyword">this</span>.rebuild();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment5.ets#L2-L52" target="_blank">segment5.ets</a></div></div></div></div> </div> <p>开发者可以根据实际情况创建新的节点，参考示例代码如下所示：</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment6.ets#L2-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hello"</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isShow</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">textNodeController</span>: <span class="hljs-title class_">TextNodeController</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TextNodeController</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">message</span>);</li><li>  <span class="hljs-comment">// private count = 0;</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isShow</span>) {</li><li>          <span class="hljs-title class_">NodeContainer</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>)</li><li>            .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>            .<span class="hljs-title function_">height</span>(<span class="hljs-number">100</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#FFF0F0F0'</span>)</li><li>        }</li><li>        <span class="hljs-title class_">Button</span>(<span class="hljs-string">'replaceNode'</span>)</li><li>          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">textNodeController</span>.<span class="hljs-title function_">replaceBuilderNode</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildNewNode</span>());</li><li>          })</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">buildNewNode</span>(): <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>    <span class="hljs-keyword">let</span> message = <span class="hljs-string">'newNode'</span>;</li><li>    <span class="hljs-keyword">let</span> textNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>&lt;[<span class="hljs-title class_">Params</span>]&gt;(uiContext);</li><li>    textNode.<span class="hljs-title function_">build</span>(wrapBuilder&lt;[<span class="hljs-title class_">Params</span>]&gt;(testBuilder), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Params</span>(message))</li><li>    <span class="hljs-keyword">return</span> textNode;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/segment/segment6.ets#L2-L83" target="_blank">segment6.ets</a></div></div></div></div> <p></p> <div class="tiledSection"><h3 id="section1839413474109">NodeController生命周期<i class="anchor-icon anchor-icon-link" anchorid="section1839413474109" tips="复制节点链接"></i></h3><p>NodeController用于控制和反馈对应的NodeContainer上的节点的行为，需要与NodeContainer一起使用。下面，对其常用生命周期函数进行说明。</p> <ul><li>makeNode()：必须要重写的方法，用于构建节点树、返回节点挂载在对应NodeContainer中。在对应NodeContainer创建绑定当前NodeController的时候调用、或者通过rebuild()方法调用刷新。</li><li><span>aboutToResize()：当controller对应的NodeContainer在Measure的时候进行回调，入参为节点的布局大小。</span></li><li>aboutToAppear()：<span>当controller对应的NodeContainer在onAppear()的时候进行回调。</span></li><li>aboutToDisappear()<span>：当controller对应的NodeContainer在onDisappear()的时候进行回调。</span></li><li>onTouchEvent()：当NodeController绑定的NodeContainer收到Touch事件时触发此回调。<div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/TestCode.ets#L4-L11" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeController</span> {</li><li>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">makeNode</span>(<span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-title class_">null</span>;</li><li>  <span class="hljs-variable">aboutToResize</span>?(<span class="hljs-variable">size</span>: <span class="hljs-title class_">Size</span>): <span class="hljs-title class_">void</span>;</li><li>  <span class="hljs-variable">aboutToAppear</span>?(): <span class="hljs-title class_">void</span>;</li><li>  <span class="hljs-variable">aboutToDisappear</span>?(): <span class="hljs-title class_">void</span>;</li><li>  <span class="hljs-keyword">abstract</span> <span class="hljs-title function_">rebuild</span>(): <span class="hljs-title class_">void</span>;</li><li>  <span class="hljs-variable">onTouchEvent</span>?(<span class="hljs-variable">event</span>: <span class="hljs-title class_">TouchEvent</span>): <span class="hljs-title class_">void</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/TestCode.ets#L4-L11" target="_blank">TestCode.ets</a></div></div></div></div> </li></ul> </div> <div class="tiledSection"><h2 id="section11387193514385">列表流广告组件实践案例<i class="anchor-icon anchor-icon-link" anchorid="section11387193514385" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section181346444417" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section181346444417" tips="复制节点链接"></i></h3><p>App广告有一种场景是列表流广告，即在应用的列表流中穿插展示广告条目，旨在将广告无缝融入用户的浏览体验中，使其看起来像是正常的内容（广告条目需要加标记区别展示），从而吸引用户的注意力并提高参与度，例如新闻列表中的广告条目、商品列表中的广告条目等。</p> <p>这种广告的布局和内容在开发阶段不确定（可能是图文、视频等形式中的一种），其通常是在运行阶段，依赖服务器下发的数据进行逻辑映射后，再执行布局的构建、内容的加载显示。所以在实际的开发中，应用需要使用动态创建组件的能力去实现该列表流广告。</p> <p><span><img height="552.7746000000001" originheight="2258" originwidth="1086" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162900.32004345567777486608304370643491:50001231000000:2800:2C6A7B867D91A66DF2A783E6E7523387BCE0469F244C9233D4A66EFE33CE7104.png" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section15419797443">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section15419797443" tips="复制节点链接"></i></h3><ol><li>使用列表数据构建List布局，根据数据类型分别执行对应逻辑，如果是广告类型，使用NodeContainer进行预占位。</li><li>当NodeContainer渲染时，发起请求获取广告信息等数据。解析数据明确广告类型后，构建具体的广告布局，比如图文布局、视频布局等。</li><li>布局构建完成后，返回rootNode实现组件上树，最后在容器中渲染显示。</li></ol> </div> <div class="tiledSection"><h3 id="section39874573295">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section39874573295" tips="复制节点链接"></i></h3><ol><li><span>加载列表数据：模拟从服务器端获取列表数据，分别生成列表数据对象和广告数据对象。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/MainPage.ets#L33-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt;= <span class="hljs-number">100</span>; i++) {</li><li>    <span class="hljs-keyword">let</span> id = i.<span class="hljs-title function_">toString</span>();</li><li>    <span class="hljs-comment">// In actual services, data is obtained from the cloud, a card list is generated,</span></li><li>    <span class="hljs-comment">// and the node where the advertisement is located is marked.</span></li><li>    <span class="hljs-keyword">if</span> (i % <span class="hljs-number">7</span> === <span class="hljs-number">6</span>) {</li><li>      <span class="hljs-comment">// Node where the advertisement is located</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">pushData</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CardData</span>(<span class="hljs-literal">true</span>, id));</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">idList</span>.<span class="hljs-title function_">add</span>(id);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>.<span class="hljs-title function_">pushData</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CardData</span>(<span class="hljs-literal">false</span>, id));</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/MainPage.ets#L33-L46" target="_blank">MainPage.ets</a></div></div></div></div> <p>示例代码中用CardData(true, id)表示广告数据对象。</p> <div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/model/CardData.ets#L19-L36" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CardData</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">mIsAdCard</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">isAdCard: <span class="hljs-built_in">boolean</span>, id: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">mIsAdCard</span> = isAdCard;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">id</span> = id;</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/model/CardData.ets#L19-L36" target="_blank">CardData.ets</a></div></div></div></div> <p></p></li><li><span>构建广告组件：封装广告组件AdComponent，它通过模拟获取的广告类型去判断，进一步构建图文广告组件，或视频广告组件。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdBuilder.ets#L20-L42" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">adBuilder</span>(<span class="hljs-variable">param</span>: <span class="hljs-title class_">AdParams</span>) {</li><li>  <span class="hljs-title function_">AdComponent</span>({ <span class="hljs-variable">params</span>: <span class="hljs-title class_">param</span> });</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AdComponent</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">params</span> ?: <span class="hljs-title class_">AdParams</span>;</li><li>  <span class="hljs-variable">closeAdDialogController</span>: <span class="hljs-title class_">CustomDialogController</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">CustomDialogController</span>({</li><li>    <span class="hljs-variable">builder</span>: <span class="hljs-title class_">CloseAdDialog</span>({</li><li>      <span class="hljs-variable">adId</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">params</span>!.<span class="hljs-title class_">id</span></li><li>    }),</li><li>    <span class="hljs-variable">backgroundBlurStyle</span>: <span class="hljs-title class_">BlurStyle</span>.<span class="hljs-title class_">COMPONENT_THICK</span>,</li><li>  });</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">params</span>!.<span class="hljs-variable">isVideo</span>) {</li><li>      <span class="hljs-title function_">videoAdBuilder</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">closeAdDialogController</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-title function_">picAdBuilder</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">closeAdDialogController</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdBuilder.ets#L20-L42" target="_blank">AdBuilder.ets</a></div></div></div></div> <p></p></li><li><span>广告占位节点逻辑：实现占位结点AdNodeController，它继承自NodeController，其中的initAd()方法通过this.adNode.build()接口将广告组件添加到rootNode上。当NodeContrainer进行绘制时，会调用makeNode()方法，将构建好的rootNode返回实现组件上树。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdController.ets#L24-L56" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AdNodeController</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  <span class="hljs-keyword">private</span> rootNode: FrameNode | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> adNode: BuilderNode&lt;[AdParams]&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">private</span> isRemove: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">private</span> uiContext ?: UIContext;</li><li>
</li><li>  makeNode(): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isRemove) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.rootNode != <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.rootNode;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// This function is user-defined and can be used as an initialization function.</span></li><li>  <span class="hljs-comment">// Initialize BuilderNode through UIContext, and then initialize the content</span></li><li>  <span class="hljs-comment">// in @Builder through the build interface in BuilderNode.</span></li><li>  initAd(uiContext: UIContext, id: string, adType: string) {</li><li>    <span class="hljs-keyword">this</span>.uiContext = uiContext;</li><li>    <span class="hljs-comment">// uiContext is required for creating a node.</span></li><li>    <span class="hljs-keyword">this</span>.rootNode = new FrameNode(<span class="hljs-keyword">this</span>.uiContext);</li><li>    <span class="hljs-comment">// uiContext is required for creating a node.</span></li><li>    <span class="hljs-keyword">this</span>.adNode = new BuilderNode(<span class="hljs-keyword">this</span>.uiContext);</li><li>    <span class="hljs-keyword">this</span>.adNode.build(wrapBuilder(adBuilder), { id: id, isVideo: adType === <span class="hljs-string">'video'</span> });</li><li>    <span class="hljs-keyword">this</span>.rootNode.getRenderNode()?.appendChild(<span class="hljs-keyword">this</span>.adNode.getFrameNode()?.getRenderNode());</li><li>  }</li><li>
</li><li>  remove() {</li><li>    <span class="hljs-keyword">this</span>.isRemove = <span class="hljs-literal">true</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdController.ets#L24-L56" target="_blank">AdController.ets</a></div></div></div></div> <p></p></li><li><span>加载广告布局：getAdNodeController()方法是通过queryAdById()模拟广告类型信息的获取，并在完成信息获取后构建相应的NodeController。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdController.ets#L60-L74" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Customizing the Interface for Obtaining the NodeController</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> getAdNodeController = (<span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">AdNodeController</span> | <span class="hljs-function"><span class="hljs-params">undefined</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">let</span> baseNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AdNodeController</span>();</li><li>  nodeMap.<span class="hljs-title function_">set</span>(id, baseNode);</li><li>  baseNode.<span class="hljs-title function_">initAd</span>(uiContext, id, <span class="hljs-title function_">queryAdById</span>(id));</li><li>  <span class="hljs-keyword">return</span> nodeMap.<span class="hljs-title function_">get</span>(id);</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">queryAdById</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>(id) % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'pic'</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">'video'</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdController.ets#L60-L74" target="_blank">AdController.ets</a></div></div></div></div> <p></p></li><li><span>列表及广告项布局：在ListItem布局逻辑中，需要判断该项是否广告节点：若是广告项，通过getAdNodeController()方法预埋NodeContainer容器占位；若不是，通过CardComponent()进行列表内容项的布局及渲染。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/MainPage.ets#L52-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">List</span>({ space: 3 }) {</li><li>  <span class="hljs-comment">// Iteratively generating a node tree</span></li><li>  <span class="hljs-selector-tag">LazyForEach</span>(this.data, (<span class="hljs-attribute">item</span>: CardData) =&gt; {</li><li>    <span class="hljs-selector-tag">ListItem</span>() {</li><li>      <span class="hljs-selector-tag">if</span> (item.<span class="hljs-built_in">isAdCard</span>()) {</li><li>        <span class="hljs-comment">// Creates a NodeContainer placeholder for an ad node. When the component is loaded,</span></li><li>        <span class="hljs-comment">// the corresponding ad card Controller is obtained.</span></li><li>        <span class="hljs-selector-tag">NodeContainer</span>(<span class="hljs-built_in">getAdNodeController</span>(this.<span class="hljs-built_in">getUIContext</span>(), item.<span class="hljs-built_in">getId</span>()))<span class="hljs-selector-class">.width</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.percent_100'</span>));</li><li>      } <span class="hljs-selector-tag">else</span> {</li><li>        <span class="hljs-selector-tag">CardComponent</span>({ cardData: item });</li><li>      }</li><li>    }</li><li>    .<span class="hljs-built_in">margin</span>({</li><li>      <span class="hljs-attribute">left</span>: $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.spacing_xxl'</span>),</li><li>      <span class="hljs-attribute">right</span>: $<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.spacing_xxl'</span>)</li><li>    })</li><li>  }, (<span class="hljs-attribute">item</span>: CardData) =&gt; item.<span class="hljs-built_in">getId</span>())</li><li>}</li><li><span class="hljs-selector-class">.width</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.percent_100'</span>))</li><li><span class="hljs-selector-class">.height</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.percent_100'</span>))</li><li><span class="hljs-selector-class">.cachedCount</span>(<span class="hljs-number">5</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/MainPage.ets#L52-L72" target="_blank">MainPage.ets</a></div></div></div></div> <p></p></li><li><span>关闭/屏蔽广告功能：广告组件需要提供关闭功能，当点击确认屏蔽按钮后，通过node.remove()通知AdNodeController标记该广告移除，设置this.isRemove为true，再通过node.rebuild()接口触发组件重绘，此时系统会再次执行makeNode接口，根据this.isRemove标记返回null结点，实现广告组件下树。</span><p></p><div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdBuilder.ets#L202-L210" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Button</span>($r(<span class="hljs-string">'app.string.text_dialog_shield'</span>))</li><li>  .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">node</span>: <span class="hljs-title class_">AdNodeController</span> | <span class="hljs-literal">undefined</span> = nodeMap.<span class="hljs-title function_">get</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">adId</span>);</li><li>    <span class="hljs-keyword">if</span> (node !== <span class="hljs-literal">undefined</span>) {</li><li>      node.<span class="hljs-title function_">remove</span>();</li><li>      node.<span class="hljs-title function_">rebuild</span>();</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">dialogController</span>.<span class="hljs-title function_">close</span>();</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/components/AdBuilder.ets#L202-L210" target="_blank">AdBuilder.ets</a></div></div></div></div> <p></p></li></ol> </div> <div class="tiledSection"><h2 id="section131735511156">动态生成页面实践案例<i class="anchor-icon anchor-icon-link" anchorid="section131735511156" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section644294615257" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section644294615257" tips="复制节点链接"></i></h3><p>下面使用视频首页刷新图片资源作为场景，来介绍如何使用ArkUI的FrameNode来实现动态布局。</p> </div> <div class="tiledSection"><h3 id="section1531619253396">ArkUI的声明式扩展使用<i class="anchor-icon anchor-icon-link" anchorid="section1531619253396" tips="复制节点链接"></i></h3><p>一个简化的动态布局类框架的DSL一般会使用JSON、XML等数据交换格式来描述UI，下面使用JSON为例进行说明。本案例相关核心字段含义如下表所示：</p> </div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.30.1.3.1.1" valign="top" width="50%"><p>标签</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.30.1.3.1.2" valign="top" width="50%"><p>含义</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>type</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>描述UI组件的类型，通常与原生组件存在一一对应的关系，也可能是封装的某种组件</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>content</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>文本，图片类组件的内容</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>css</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>描述UI组件的布局特性</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>children</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>当前组件的子组件</p> </td> </tr>  </tbody></table></div> </div> <ol><li>定义视频应用首页UI描述数据，在resources/rawfile目录下创建structure.json文件，内容如下。<div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"type"</span>: <span class="hljs-string">"Column"</span>,</li><li>  <span class="hljs-string">"css"</span>: {</li><li>    <span class="hljs-string">"width"</span>: <span class="hljs-string">"100%"</span></li><li>  },</li><li>  <span class="hljs-string">"children"</span>: [</li><li>    <span class="hljs-comment">// ...</span></li><li>  ]</li><li>}</li></ol></pre></div></div> </li><li>定义相应数据结构用于接收UI描述数据，代码示例如下。<div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/view/ImperativeView.ets#L23-L29" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">VM</span> {</li><li>  <span class="hljs-keyword">type</span>?: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">content</span>?: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">css</span>?: <span class="hljs-title class_">ESObject</span>;</li><li>  <span class="hljs-variable">children</span>?: <span class="hljs-title class_">VM</span>[];</li><li>  <span class="hljs-variable">id</span>?: <span class="hljs-title class_">string</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/view/ImperativeView.ets#L23-L29" target="_blank">ImperativeView.ets</a></div></div></div></div> </li><li>自定义DSL解析逻辑，且使用carouselNodes保存轮播图节点，方便后续操作节点更新，代码示例如下。<div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/view/ImperativeView.ets#L33-L140" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-attr">carouselNodes</span>: typeNode.<span class="hljs-property">Image</span>[] = [];</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">FrameNodeFactory</span>(<span class="hljs-params">vm: VM, context: UIContext</span>): <span class="hljs-title class_">FrameNode</span> | <span class="hljs-literal">null</span> {</li><li>  <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">type</span> === <span class="hljs-string">"Column"</span>) {</li><li>    <span class="hljs-keyword">let</span> node = typeNode.<span class="hljs-title function_">createNode</span>(context, <span class="hljs-string">"Column"</span>);</li><li>    <span class="hljs-title function_">setColumnNodeAttr</span>(node, vm.<span class="hljs-property">css</span>);</li><li>    vm.<span class="hljs-property">children</span>?.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">kid</span> =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> child = <span class="hljs-title class_">FrameNodeFactory</span>(kid, context);</li><li>      node.<span class="hljs-title function_">appendChild</span>(child);</li><li>    });</li><li>    <span class="hljs-keyword">return</span> node;</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">type</span> === <span class="hljs-string">"Row"</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">type</span> === <span class="hljs-string">"Swiper"</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">type</span> === <span class="hljs-string">"Image"</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (vm.<span class="hljs-property">type</span> === <span class="hljs-string">"Text"</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setColumnNodeAttr</span>(<span class="hljs-params">node: typeNode.Column, css: ESObject</span>) {</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">width</span>(css.<span class="hljs-property">width</span>);</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">height</span>(css.<span class="hljs-property">height</span>);</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">backgroundColor</span>(css.<span class="hljs-property">backgroundColor</span>);</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">End</span>);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (css.<span class="hljs-property">alignItems</span> === <span class="hljs-string">"HorizontalAlign.Start"</span>) {</li><li>    node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">alignItems</span>(<span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-property">Start</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (css.<span class="hljs-property">padding</span> !== <span class="hljs-literal">undefined</span>) {</li><li>    node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">padding</span>(css.<span class="hljs-property">padding</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (css.<span class="hljs-property">margin</span> !== <span class="hljs-literal">undefined</span>) {</li><li>    node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">margin</span>(css.<span class="hljs-property">margin</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">function</span> <span class="hljs-title function_">setRowNodeAttr</span>(<span class="hljs-params">node: typeNode.Row, css: ESObject</span>) {</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">width</span>(css.<span class="hljs-property">width</span>);</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">height</span>(css.<span class="hljs-property">height</span>);</li><li>  <span class="hljs-keyword">if</span> (css.<span class="hljs-property">padding</span> !== <span class="hljs-literal">undefined</span>) {</li><li>    node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">padding</span>(css.<span class="hljs-property">padding</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (css.<span class="hljs-property">margin</span> !== <span class="hljs-literal">undefined</span>) {</li><li>    node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">margin</span>(css.<span class="hljs-property">margin</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Padding</span>);</li><li>  }</li><li>  node.<span class="hljs-property">attribute</span>.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-title class_">FlexAlign</span>.<span class="hljs-property">SpaceBetween</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/view/ImperativeView.ets#L33-L140" target="_blank">ImperativeView.ets</a></div></div></div></div> </li><li>使用NodeContainer组件嵌套ArkUI的FrameNode扩展和ArkUI的声明式语法。<div class="screenLinkPre"><div _ngcontent-dxu-c106="" class="highlight-div"><div _ngcontent-dxu-c106="" class="highlight-div-header"><div _ngcontent-dxu-c106="" class="highlight-div-header-left"><div _ngcontent-dxu-c106="" class="handle-button expand-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dxu-c106="" class="highlight-div-header-right"><div _ngcontent-dxu-c106="" class="handle-button ai-button"></div><div _ngcontent-dxu-c106="" class="handle-button line-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dxu-c106="" class="handle-button theme-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dxu-c106="" class="handle-button copy-button"><div _ngcontent-dxu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dxu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/TestCode.ets#L16-L39" data-highlighted="yes"><ol class="linenums"><li>class ImperativeController extends NodeController {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-built_in">makeNode</span>(uiContext: UIContext): FrameNode | null {</li><li>    return <span class="hljs-built_in">frameNodeFactory</span>(data, uiContext);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">@Component</span></li><li>export struct ImperativePage {</li><li>  private controller: ImperativeController = new <span class="hljs-built_in">ImperativeController</span>();</li><li>
</li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">Column</span>() {</li><li>      <span class="hljs-built_in">NodeContainer</span>(this.controller)</li><li>    }</li><li>    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>    <span class="hljs-selector-class">.backgroundColor</span>(Color.Black)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DynamicComponent/blob/master/entry/src/main/ets/pages/TestCode.ets#L16-L39" target="_blank">TestCode.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section562912235112">性能对比<i class="anchor-icon anchor-icon-link" anchorid="section562912235112" tips="复制节点链接"></i></h3><p>以场景示例中的两种方案实现，通过DevEco Studio的Profile工具抓取Trace进行性能分析比对。</p> </div> <ol><li>以上示例场景在声明式开发范式下的完成时延为13.7ms（根据设备和场景不同，数据会有差异，本数据仅供参考），如下图所示。<p><span><img height="178.779265" originheight="749" originwidth="2194" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162900.44629967612543478831168313478295:50001231000000:2800:DE455017464AD57C0AE16A7CD421E4D71B1FBC58835EACBC45B39B772837078E.png" title="点击放大" width="523.6875"></span></p> </li><li>以上示例场景在FrameNode扩展模式下的完成时延为6.1ms（根据设备和场景不同，数据会有差异，本数据仅供参考），如下图所示。<p><span><img height="178.698002" originheight="749" originwidth="2195" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162900.61117725064290279454654145875685:50001231000000:2800:CF418016482E270782070897C6D8C6DE81903920EC2FB085957C1E28CC29EDBE.png" title="点击放大" width="523.6875"></span></p> </li></ol> <div class="tiledSection"><h2 id="section12684155814810">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section12684155814810" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/DynamicComponent" target="_blank">组件动态创建</a></li></ul> </div> </div></div>