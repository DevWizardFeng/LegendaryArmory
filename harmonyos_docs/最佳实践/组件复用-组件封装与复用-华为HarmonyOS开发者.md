<h1 _ngcontent-ruc-c119="" class="doc-title ng-star-inserted" title="组件复用"> 组件复用 </h1>

<div _ngcontent-ruc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section0601191953215">概述<i class="anchor-icon anchor-icon-link" anchorid="section0601191953215" tips="复制节点链接"></i></h2><p>组件复用是指自定义组件从组件树上移除后被放入缓存池，后续在创建相同类型的组件节点时，直接复用缓存池中的组件对象。</p> <p>在应用开发时，组件复用是优化UI性能，确保应用流畅的重要手段。合理使用可复用组件，一方面，可以避免频繁创建和销毁对象的过程，减少内存回收的频率；另一方面，复用缓存中的组件可以直接绑定数据进行显示，与创建新视图相比，降低了计算开销，提升了显示效率。</p> <p>常见的组件复用开发场景是长列表滑动：在应用展示大量数据的列表界面中，当用户快速地进行滑动操作，列表项反复创建销毁可能导致卡顿等性能问题。这种情况下，使用组件复用机制可以重用已经创建过的列表项视图，提高滑动的流畅度。</p> <p>本文介绍以下组件复用开发场景，帮助开发者更好地理解复用机制，进而优化应用性能。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-component-reuse#section142674274329">同一列表内的组件复用</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-component-reuse#section1032053073217">多个列表间的组件复用</a></li></ul> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>本文以列表相关场景为例介绍，但实际只要发生了自定义组件的销毁和再创建，都可以考虑使用组件复用。包括以下情形：</p> <ol><li>滑动场景下对子组件进行频繁创建和销毁。例如List、Grid、WaterFlow、Swiper等布局容器中的滑动。</li><li>界面中反复切换条件渲染的控制分支，且控制分支中的子组件树结构比较复杂。</li></ol> </div></div></div> </div> <div class="tiledSection"><h2 id="section142674274329">场景：同一列表内的组件复用<i class="anchor-icon anchor-icon-link" anchorid="section142674274329" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section71918917320" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section71918917320" tips="复制节点链接"></i></h3></div> <p>同一列表内的列表项组件复用是典型的应用开发场景。列表在滑动时，超出屏幕一定范围的列表项，被放入缓存池中，当新的列表项滑动进入屏幕范围内时，从缓存池中取出对象，绑定对应数据后呈现到列表界面中。</p> <p>在实际业务中，同一列表内可能呈现一种或多种不同结构的列表项，可以进一步划分以下子场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-component-reuse#section182174216314">列表项结构类型相同</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-component-reuse#section43301824133220">列表项结构类型不同</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-component-reuse#section11716134215321">列表项内子组件可拆分组合</a></li></ul> <p><span><img height="243.6161" originheight="517" originwidth="1129" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.26128789221191141733732047504995:50001231000000:2800:6E43BA878DC37CA5BE1BDDA34E6295A668F8AA376B8F2352D06748A72E879DE0.png" title="点击放大" width="532"></span></p> <div class="tiledSection"><h3 id="section164530373298">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section164530373298" tips="复制节点链接"></i></h3><p>ArkUI提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-reusable" target="_blank">@Reusable装饰器</a>以实现自定义组件的复用，其原理如图所示：</p> <p><span><img height="408.6691" originheight="782" originwidth="1018" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.89172343292762895374905477502031:50001231000000:2800:EEEA69989EBE102AAAD4C7104F3CEF15B5048EB8CA0D15020221B018154519A1.png" title="点击放大" width="532"></span></p> </div> <ol><li>标记了@Reusable的自定义组件listItem列表项，在滑动出屏幕一定范围后，从组件树上被移除，组件的对象实例被放入CustomNode虚拟结点（与自定义组件一一对应的自定义结点）。</li><li>在不断滑动过程中，列表的RecycleManager将这些CustomNode虚拟结点回收，根据复用标识<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-reuse-id" target="_blank">reuseId</a>分组，形成CachedRecycleNodes的集合，即视图对象的复用缓存池。</li><li>继续滑动，新的listItem需要在列表上显示时，RecycleManager优先从复用缓存池（CachedRecycleNodes集合）中查找对应reuseId的视图对象，然后将新的数据绑定到该视图，重用该节点并添加到组件树上。</li></ol> <div class="tiledSection"><h3 id="section17655725163014">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section17655725163014" tips="复制节点链接"></i></h3><ol><li>定义可复用组件：使用@Reusable装饰器修饰可复用的自定义组件。</li><li>实现复用回调：可复用组件需要实现aboutToReuse()生命周期回调。当组件从缓存中重新加入到节点树时，触发aboutToReuse()生命周期回调，组件的构造参数会传递进来，开发者根据需要在回调中处理数据刷新。</li><li>布局中使用可复用组件：设置reuseId划分组件的复用组别，以区分缓存池。未设置reuseId时，组件名会默认作为reuseId。<div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/pages/Index.ets#L19-L126" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">switch</span>) {</li><li>        <span class="hljs-comment">// 3.layout the component and set reuse id</span></li><li>        <span class="hljs-title class_">ReusableComponent</span>({ <span class="hljs-attr">text</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">typeStr</span> })</li><li>          .<span class="hljs-title function_">reuseId</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">typeStr</span>)</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-comment">// 1.add @Reusable to mark component</span></li><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">ReusableComponent</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span></li><li>
</li><li>  <span class="hljs-comment">// 2.update data in aboutToReuse</span></li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">text</span> = params.<span class="hljs-property">text</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/pages/Index.ets#L19-L126" target="_blank">Index.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ul><li>@Reusable修饰的组件需要布局在同一个父自定义组件（后文简称”父组件”）下才能实现缓存复用。</li><li>不建议在@Reusable修饰的组件中嵌套使用另一个@Reusable组件。</li></ul> <p>更多注意事项参考指南<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-reusable#限制条件" target="_blank">限制条件</a>。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section182174216314">列表项结构类型相同<i class="anchor-icon anchor-icon-link" anchorid="section182174216314" tips="复制节点链接"></i></h3></div> <p>这种场景下，列表中的每一项都是由相同类型的元素和布局构成，列表项组件可以作为复用逻辑的基本单位。</p> <p><span><img height="547.9733" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.00972998162229654151744182501902:50001231000000:2800:78398CE3F0287B7105125835B1A46D941A79B41035B82CD2CE653157F6F69961.png" title="点击放大" width="266"></span></p> <p>实现步骤：</p> <ol><li><span>将列表项封装为自定义组件ItemView，添加@Reusable修饰。</span></li><li><span>在ItemView组件内的aboutToReuse()方法中进行新数据绑定逻辑。</span></li><li><span>在列表的LazyForEach()中使用ItemView组件，设置reuseId。</span></li></ol> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/OneTypeItemPage.ets#L21-L111" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneTypeItemPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">List</span>() {</li><li>          <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; {</li><li>            <span class="hljs-comment">// layout the component, and set reuse id (or no set with using name as default id)</span></li><li>            <span class="hljs-title function_">ItemView</span>({ <span class="hljs-variable">title</span>: <span class="hljs-title class_">item</span>.<span class="hljs-title class_">title</span>, <span class="hljs-keyword">from</span>: <span class="hljs-title class_">item</span>.<span class="hljs-keyword">from</span>, <span class="hljs-variable">tail</span>: <span class="hljs-title class_">item</span>.<span class="hljs-title class_">tail</span> })</li><li>              .<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'item_id'</span>)</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// add @Reusable to mark component</span></li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ItemView</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">title</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-keyword">from</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">tail</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-comment">// update data in aboutToReuse method</span></li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">title</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">title</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">from</span> = <span class="hljs-variable">params</span>.<span class="hljs-keyword">from</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">tail</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">tail</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/OneTypeItemPage.ets#L21-L111" target="_blank">OneTypeItemPage.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section43301824133220">列表项结构类型不同<i class="anchor-icon anchor-icon-link" anchorid="section43301824133220" tips="复制节点链接"></i></h3></div> <p>这种场景下，列表中会有多种类型的列表项，如下图包含了文本、单图、多图等三种列表项，其布局、组成元素存在一定差异，可以将每种类型的列表项分别作为复用单位。</p> <p><span><img height="599.0187" originheight="709" originwidth="629" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.74645434664665867041234582163889:50001231000000:2800:3BAAFCFA3787B29293273444B72CBF4C5C8EB6ECB0E440E7E67E8307247C8C67.png" title="点击放大" width="532"></span></p> <p>在滑动的过程中，不同类型的列表项将分别回收进入各自的缓存池，当需要复用时，根据类型找到对应视图缓存进行显示。</p> <p>实现步骤：</p> <ol><li><span>将不同类型的列表项分别封装为自定义组件，添加@Reusable修饰。</span></li><li><span>在组件内的aboutToReuse()方法中进行新的数据绑定逻辑。</span></li><li><span>在列表的LazyForEach()中，根据业务逻辑进行if条件选择，布局相应类型的列表项组件，分别设置reuseId。</span></li></ol> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/MultiTypeItemPage.ets#L21-L211" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>export struct MultiTypeItemPage {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">NavDestination</span>() {</li><li>      <span class="hljs-selector-tag">Column</span>() {</li><li>        <span class="hljs-selector-tag">List</span>() {</li><li>          <span class="hljs-selector-tag">LazyForEach</span>(this.dataSource, (<span class="hljs-attribute">item</span>: ItemData) =&gt; {</li><li>            <span class="hljs-selector-tag">if</span> (item.type === <span class="hljs-number">0</span>) {</li><li>              <span class="hljs-selector-tag">TextTypeItemView</span>({ item: item })</li><li>                <span class="hljs-selector-class">.reuseId</span>(<span class="hljs-string">'text_item_id'</span>)</li><li>            } else if (item.type === <span class="hljs-number">1</span>) {</li><li>              <span class="hljs-selector-tag">ImageTypeItemView</span>({ item: item })</li><li>                <span class="hljs-selector-class">.reuseId</span>(<span class="hljs-string">'image_item_id'</span>)</li><li>            } else if (item.type === <span class="hljs-number">2</span>) {</li><li>              <span class="hljs-selector-tag">ThreeImageTypeItemView</span>({ item: item })</li><li>                <span class="hljs-selector-class">.reuseId</span>(<span class="hljs-string">'three_image_item_id'</span>)</li><li>            }</li><li>          }, (<span class="hljs-attribute">item</span>: ItemData) =&gt; item.id.<span class="hljs-built_in">toString</span>())</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-selector-tag">Reusable</span></li><li>@<span class="hljs-selector-tag">Component</span></li><li><span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">TextTypeItemView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>
</li><li><span class="hljs-variable">@Reusable</span></li><li><span class="hljs-variable">@Component</span></li><li>struct ImageTypeItemView {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li><span class="hljs-variable">@Reusable</span></li><li><span class="hljs-variable">@Component</span></li><li>struct ThreeImageTypeItemView {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/MultiTypeItemPage.ets#L21-L211" target="_blank">MultiTypeItemPage.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section11716134215321">列表项内子组件可拆分组合<i class="anchor-icon anchor-icon-link" anchorid="section11716134215321" tips="复制节点链接"></i></h3></div> <p>这种情况下，列表项也具有多种结构类型。通过观察可知，列表项内部子组件都是纵向分布排列，相同之处是顶部的文本标题、底部的发布时间，而不同之处是中间的区域部分：有单图、多图、视频三种情况。</p> <p><span><img height="435.6016" originheight="732" originwidth="894" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.08805373255725903372902310552852:50001231000000:2800:983E73A8970440AC4B0CAD641D250DE31A25482DD6F928C6591A1724CDB125FD.png" title="点击放大" width="532"></span></p> <p>因此，可以创建五种复用子组件，通过子组件的选择组合，实现不同类型的列表项。</p> <p><span><img height="318.5483" originheight="682" originwidth="1139" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.49076742422752473748169693912255:50001231000000:2800:3741834349107F2897CCF2B1172FE32D1F3B0556A2497BCFC642D96CAC54EF48.png" title="点击放大" width="532"></span></p> <p>实现步骤：</p> <ol><li><span>将单图、多图、视频、顶部标题、底部时间等分别封装为子组件，添加@Reusable修饰。</span></li><li><span>在组件内的aboutToReuse()方法中进行新的数据绑定逻辑。</span></li><li><span>通过组合子组件，实现三个不同的@Builder函数，与三种列表项一一对应。</span></li><li><span>在列表的LazyForEach()中，根据业务逻辑进行条件选择，分别调用相应类型的@Builder函数。</span></li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>为什么使用@Builder实现，而不直接使用自定义组件嵌套子组件？</p> <p>由于缓存池位于自定义组件上，嵌套子组件后会将缓存池分割，导致复用不生效。而使用@Builder可以使内部的自定义组件依然汇聚在同一个缓存池里，从而实现相互复用。</p> </div></div></div> <p>示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/ComposableItemPage.ets#L21-L207" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">ComposableItemPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  @<span class="hljs-title function_">Builder</span></li><li>  <span class="hljs-title function_">itemBuilderSingleImage</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) {</li><li>    <span class="hljs-title function_">TopView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'top_id'</span>)</li><li>    <span class="hljs-title function_">MiddleSingleImageView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'middle_image_id'</span>)</li><li>    <span class="hljs-title function_">BottomView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'bottom_id'</span>)</li><li>  }</li><li>
</li><li>  @<span class="hljs-title function_">Builder</span></li><li>  <span class="hljs-title function_">itemBuilderThreeImage</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) {</li><li>    <span class="hljs-title function_">TopView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'top_id'</span>)</li><li>    <span class="hljs-title function_">MiddleThreeImageView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'middle_three_image_id'</span>)</li><li>    <span class="hljs-title function_">BottomView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'bottom_id'</span>)</li><li>  }</li><li>
</li><li>  @<span class="hljs-title function_">Builder</span></li><li>  <span class="hljs-title function_">itemBuilderVideoImage</span>(<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) {</li><li>    <span class="hljs-title function_">TopView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'top_id'</span>)</li><li>    <span class="hljs-title function_">MiddleVideoView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'middle_video_id'</span>)</li><li>    <span class="hljs-title function_">BottomView</span>({ <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span> }).<span class="hljs-title function_">reuseId</span>(<span class="hljs-string">'bottom_id'</span>)</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NavDestination</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">List</span>() {</li><li>          <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; {</li><li>            <span class="hljs-title function_">ListItem</span>() {</li><li>              <span class="hljs-title function_">Column</span>() {</li><li>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">item</span>.<span class="hljs-keyword">type</span> === <span class="hljs-number">0</span>) {</li><li>                  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">itemBuilderSingleImage</span>(<span class="hljs-variable">item</span>)</li><li>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">item</span>.<span class="hljs-keyword">type</span> === <span class="hljs-number">1</span>) {</li><li>                  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">itemBuilderThreeImage</span>(<span class="hljs-variable">item</span>)</li><li>                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">item</span>.<span class="hljs-keyword">type</span> === <span class="hljs-number">2</span>) {</li><li>                  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">itemBuilderVideoImage</span>(<span class="hljs-variable">item</span>)</li><li>                }</li><li>              }</li><li>              <span class="hljs-comment">// ...</span></li><li>            }</li><li>          }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>.<span class="hljs-title function_">toString</span>())</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">TopView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">BottomView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MiddleSingleImageView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MiddleThreeImageView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MiddleVideoView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/ComposableItemPage.ets#L21-L207" target="_blank">ComposableItemPage.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1032053073217">场景：多个列表间的组件复用<i class="anchor-icon anchor-icon-link" anchorid="section1032053073217" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section11591195720427" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section11591195720427" tips="复制节点链接"></i></h3></div> <p>应用开发有这种场景：在不同的标题页面中展示数据，每一页面下实现了一个列表，这样在页面切换时，列表与列表之间如果存在结构相同的列表项，就有组件复用的优化可能。例如下图，News、Hot等页签下，绘制了类型相同的列表项。</p> <p><span><img height="482.9895" originheight="542" originwidth="597" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.29325864930052606256496533630023:50001231000000:2800:88197CA937F099099E1A490D50E980B84F963870076CF779E8F2D21C024B6B8A.png" title="点击放大" width="532"></span></p> <div class="tiledSection"><h3 id="section1547752116436">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1547752116436" tips="复制节点链接"></i></h3></div> <p>在ArkUI中，可以采用Swiper+List实现这种功能场景，其中Swiper中的每个页面都使用一个List列表呈现内容。从@Reusable的复用机制可知，复用缓存池需要在同一父组件中，而列表项Item的父组件是当前页面的列表List，当Swiper内的页面切换时，无法直接复用上一个页面的列表项。</p> <p>此时可以自定义一个全局的复用缓存池NodePool，利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode" target="_blank">BuilderNode</a>的节点复用能力，根据页面状态创建、回收、复用子组件，实现这种跨页面多个列表间的组件复用。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>为什么不使用Tabs+List，而是用Swiper+List组件实现？</p> <p>当前Tabs内容页不支持使用LazyForEach()，只能使用ForEach+TabContent。如果使用ForEach()，Tabs页面显示时会一次性将所有的TabContent创建，TabContent子页面切换时也不会执行aboutToDisappear()，无法回收组件，进而不存在复用优化的可能 。</p> </div></div></div> <p><span><img height="400.6625" originheight="784" originwidth="1041" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162901.73886968399993829334048879669048:50001231000000:2800:95790AFB4B00ED43E303877C1191EAE95B0670F6135F9DAEB8F5159DA1360779.png" title="点击放大" width="532"></span></p> <p>在需要布局自定义组件的位置，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-nodecontainer" target="_blank">NodeContainer</a>占位，然后继承<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-nodecontroller" target="_blank">NodeController</a>实现NodeItem结点类，其内部需要持有<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-user-defined-arktsnode-buildernode" target="_blank">BuilderNode</a>实例以实现结点的创建和复用，同时需要持有视图相应的数据对象以更新界面显示。</p> <ol><li>当NodeItem随着视图组件即将销毁时，在aboutToDisappear()中回收NodeItem到NodePool缓存池，存入type类型对应的集合中。</li><li>每次需要创建自定义组件时，优先根据type类型查找对应的NodeItem对象，若未找到则新建一个NodeItem。</li><li>视图组件随着NodeContainer的生命周期显示时，执行数据更新，完成组件的复用过程。</li></ol> <p>这种方式需要自行维护复用池，开发者也可以考虑使用同一原理实现的全局组件复用池三方库：<a href="https://ohpm.openharmony.cn/#/cn/detail/@hadss%2Fnodepool" target="_blank">nodepool</a>。</p> <div class="tiledSection"><h3 id="section5118172616279">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section5118172616279" tips="复制节点链接"></i></h3></div> <ol><li><span>实现列表项占位结点类NodeItem，继承NodeController实现makeNode()方法，根据node是否存在，执行创建或刷新数据的逻辑，并在aboutToDisappear()时回收组件结点。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L25-L61" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeItem</span> <span class="hljs-title">extends</span> <span class="hljs-title">NodeController</span> {</li><li>  <span class="hljs-keyword">public</span> builder: WrappedBuilder&lt;ESObject&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> node: BuilderNode&lt;ESObject&gt; | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">data</span>: ESObject = {};</li><li>  <span class="hljs-keyword">public</span> type: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">public</span> id: number = <span class="hljs-number">0</span>;</li><li>
</li><li>  aboutToDisappear(): void {</li><li>    <span class="hljs-comment">// recycle node into cache pool when UI disappear</span></li><li>    NodePool.getInstance().recycleNode(<span class="hljs-keyword">this</span>.type, <span class="hljs-keyword">this</span>);</li><li>  }</li><li>
</li><li>  update(<span class="hljs-keyword">data</span>: ESObject) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = <span class="hljs-keyword">data</span>;</li><li>    <span class="hljs-keyword">this</span>.node?.reuse(<span class="hljs-keyword">data</span>);</li><li>  }</li><li>
</li><li>  makeNode(uiContext: UIContext): FrameNode | <span class="hljs-literal">null</span> {</li><li>    <span class="hljs-comment">// build new node or update node in the cache</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.node) {</li><li>      <span class="hljs-keyword">this</span>.node = new BuilderNode(uiContext);</li><li>      <span class="hljs-keyword">this</span>.node.build(<span class="hljs-keyword">this</span>.builder, <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.update(<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.node.getFrameNode();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L25-L61" target="_blank">BuilderNodePool.ets</a></div></div></div></div> <p></p></li><li><span>使用单例模式实现复用缓存池NodePool工具类，在应用内统一管理组件的复用逻辑：实现取缓存getNode()方法，根据传入的type类型，获取对应的NodeItem，如果未找到，则新创建后绑定数据；实现缓存回收recycleNode()方法，根据type类型存入相应的集合中。</span><p></p><div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><ul><li>getNode()方法中，如果找到的NodeItem父结点不为空（说明未完全下树），需要继续遍历查找下一个有效的NodeItem对象。</li><li>recycleNode()方法中，需要对NodeItem对象属性重置，使节点内容还原，避免复用显示异常情况。</li></ul> </div></div></div> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L65-L153" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePool</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">instance</span>: <span class="hljs-title class_">NodePool</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">idGen</span>: <span class="hljs-built_in">number</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">nodePool</span>: <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">LinkedList</span>&lt;<span class="hljs-title class_">NodeItem</span>&gt;&gt;;</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">constructor</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">idGen</span> = <span class="hljs-number">0</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// single instance mode, managing the cache pool</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">NodePool</span>.<span class="hljs-property">instance</span>) {</li><li>      <span class="hljs-title class_">NodePool</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodePool</span>();</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title class_">NodePool</span>.<span class="hljs-property">instance</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getNextId</span>(): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">idGen</span> += <span class="hljs-number">1</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">idGen</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getNode</span>(<span class="hljs-attr">type</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">item</span>: <span class="hljs-title class_">ESObject</span>,</li><li>    <span class="hljs-attr">builder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;<span class="hljs-title class_">ESObject</span>&gt;): <span class="hljs-title class_">NodeItem</span> | <span class="hljs-literal">undefined</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">nodeItem</span>: <span class="hljs-title class_">NodeItem</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// get the cached node based on type</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)?.<span class="hljs-property">length</span>; i++) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">tmpItem</span>: <span class="hljs-title class_">NodeItem</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)?.<span class="hljs-title function_">get</span>(i);</li><li>          <span class="hljs-comment">// if the parent node is null, it means the node is reusable, so get it out</span></li><li>          <span class="hljs-keyword">if</span> (!tmpItem.<span class="hljs-property">node</span>?.<span class="hljs-title function_">getFrameNode</span>()?.<span class="hljs-title function_">getParent</span>()) {</li><li>            nodeItem = tmpItem;</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>)?.<span class="hljs-title function_">removeByIndex</span>(i);</li><li>            <span class="hljs-keyword">break</span>;</li><li>          }</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`failed code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!nodeItem) {</li><li>      <span class="hljs-comment">// No valid reusable node found, so create new one</span></li><li>      nodeItem = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeItem</span>();</li><li>      nodeItem.<span class="hljs-property">builder</span> = builder;</li><li>      nodeItem.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;</li><li>      nodeItem.<span class="hljs-property">data</span>.<span class="hljs-property">item</span> = item;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// update cached node</span></li><li>      nodeItem.<span class="hljs-property">data</span>.<span class="hljs-property">item</span> = item;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> nodeItem;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// cache the node based on type</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">recycleNode</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>, node: NodeItem</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">nodeArray</span>: <span class="hljs-title class_">LinkedList</span>&lt;<span class="hljs-title class_">NodeItem</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">get</span>(<span class="hljs-keyword">type</span>);</li><li>      <span class="hljs-keyword">if</span> (!nodeArray) {</li><li>        nodeArray = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>();</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">nodePool</span>.<span class="hljs-title function_">set</span>(<span class="hljs-keyword">type</span>, nodeArray);</li><li>      }</li><li>      <span class="hljs-comment">// reset data</span></li><li>      node.<span class="hljs-property">data</span>.<span class="hljs-property">item</span> = {};</li><li>      nodeArray.<span class="hljs-title function_">add</span>(node);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">let</span> err = e <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`failed code=<span class="hljs-subst">${err.code}</span>, message=<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L65-L153" target="_blank">BuilderNodePool.ets</a></div></div></div></div> <p></p> <p></p></li><li><span>将步骤1中的列表项占位结点包装成组件，在对应的生命周期中分别取缓存、回收、复用。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/DiffListItemNode.ets#L20-L44" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// The list item placeholder component with NodeContainer</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DiffListItemNode</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ItemData</span>(<span class="hljs-string">''</span>, <span class="hljs-number">0</span>);</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">itemHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">builder</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;<span class="hljs-title class_">ESObject</span>&gt; | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">nodeItem</span>: <span class="hljs-title class_">NodeItem</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">NodeItem</span>();</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeItem</span> = <span class="hljs-variable">NodePool</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getNode</span>(<span class="hljs-keyword">this</span>.<span class="hljs-keyword">type</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">builder</span>!)!;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToRecycle</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeItem</span>?.<span class="hljs-variable">node</span>?.<span class="hljs-title function_">recycle</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">ESObject</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeItem</span>?.<span class="hljs-variable">node</span>?.<span class="hljs-title function_">reuse</span>(<span class="hljs-variable">params</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">NodeContainer</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">nodeItem</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/DiffListItemNode.ets#L20-L44" target="_blank">DiffListItemNode.ets</a></div></div></div></div> <p></p></li><li><span>封装列表项的界面视图组件，使用listItemBuilder函数对外export该组件。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/DiffListItemView.ets#L19-L79" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// export the list item component</span></li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">listItemBuilder</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">ESObject</span>) {</li><li>  <span class="hljs-title function_">DiffListItemView</span>({</li><li>    <span class="hljs-variable">item</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">item</span></li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-comment">// The list item view component</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">DiffListItemView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">ESObject</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">item</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">item</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Row</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/DiffListItemView.ets#L19-L79" target="_blank">DiffListItemView.ets</a></div></div></div></div> <p></p></li><li><span>在列表的LazyForEach()中，将步骤4的实际列表项视图wrapBuilder后作为参数传递给步骤3封装的占位组件，实现复用组件的布局。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/TabContentView.ets#L26-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// wrapBuilder the list item view component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable">listItemWrapper</span>: <span class="hljs-title class_">WrappedBuilder</span>&lt;<span class="hljs-title class_">ESObject</span>&gt; = <span class="hljs-title class_">wrapBuilder</span>&lt;<span class="hljs-title class_">ESObject</span>&gt;(<span class="hljs-variable">listItemBuilder</span>);</li><li>
</li><li><span class="hljs-comment">// The list component in the swiper</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TabContentView</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">List</span>() {</li><li>      <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">dataSource</span>, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; {</li><li>        <span class="hljs-title function_">DiffListItemNode</span>({</li><li>          <span class="hljs-keyword">type</span>: <span class="hljs-title class_">REUSE_VIEW_TYPE_ITEM</span>,</li><li>          <span class="hljs-variable">item</span>: <span class="hljs-title class_">item</span>,</li><li>          <span class="hljs-variable">builder</span>: <span class="hljs-title class_">listItemWrapper</span></li><li>        })</li><li>      }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">ItemData</span>) =&gt; <span class="hljs-variable">item</span>.<span class="hljs-variable">id</span>.<span class="hljs-title function_">toString</span>())</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/view/TabContentView.ets#L26-L67" target="_blank">TabContentView.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection"><h3 id="section189665561976">使用onIdle()预创建组件<i class="anchor-icon anchor-icon-link" anchorid="section189665561976" tips="复制节点链接"></i></h3></div> <p>在当前场景下，首次进入页面可能耗时较高，因为在第一次进入时，自定义组件复用池中没有缓存可以复用，列表项都需要新创建。优化这个问题，可以考虑预创建组件，将组件对象提前放入复用缓存池中。</p> <p>当组件数量较多，集中预创建本身也耗时较长，容易导致主线程阻塞。ArkUI中提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-framecallback#onidle12" target="_blank">onIdle()接口</a>，会返回每一帧帧尾的空闲时间，可以将组件预创建分布到每一帧帧尾的空闲时间中执行，这样预创建过程就被平摊在多个周期里执行，避免集中运行的耗时影响，进而优化应用体验。</p> <p><span><img height="247.57950000000002" originheight="504" originwidth="1083" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162902.48626604166698737082813492175241:50001231000000:2800:1AB48ACC88E4236E923FBE32484CBE6A8D778296E24577E87F68241E30921773.png" title="点击放大" width="532"></span></p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>1. 需要根据业务准确预估组件预创建耗时，同时将业务逻辑颗粒度拆小，以便能够分到多个onIdle()时机中完成。例如，单个组件预创建耗时在2ms左右，帧尾空闲时间只有1ms，那么就不能在当前帧进行预创建，而是延迟到下一帧中执行。</p> <p>2. 需要合理控制自定义组件复用池中预创建的数量，否则内存占用较多，可能会影响性能。</p> </div></div></div> <ol><li><span>在NodePool工具类中实现预创建preBuild()方法：新建NodeItem实例，设置builder等属性，执行recycleNode()提前放入缓存池中。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L24-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodeItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">NodeController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">prebuild</span>(<span class="hljs-params">uiContext: UIContext</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BuilderNode</span>(uiContext);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">node</span>.<span class="hljs-title function_">build</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">builder</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NodePool</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">preBuild</span>(<span class="hljs-params"><span class="hljs-keyword">type</span>: <span class="hljs-built_in">string</span>, item: ESObject, builder: WrappedBuilder&lt;ESObject&gt;, uiContext: UIContext</span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">nodeItem</span>: <span class="hljs-title class_">NodeItem</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">NodeItem</span>();</li><li>      nodeItem.<span class="hljs-property">builder</span> = builder;</li><li>      nodeItem.<span class="hljs-property">data</span>.<span class="hljs-property">item</span> = item;</li><li>      nodeItem.<span class="hljs-property">type</span> = <span class="hljs-keyword">type</span>;</li><li>      nodeItem.<span class="hljs-title function_">prebuild</span>(uiContext);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">recycleNode</span>(<span class="hljs-keyword">type</span>, nodeItem);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/BuilderNodePool.ets#L24-L154" target="_blank">BuilderNodePool.ets</a></div></div></div></div> <p></p></li><li><span>继承FrameCallback实现帧回调类，在构造器中传入预创建的数据，并实现onIdle()接口。</span><p></p><ol><li>系统会通过onIdle()回调，将帧尾空闲时间通过参数idleTimeInNano传递出来，可根据单个组件的预创建耗时，设置预创建的剩余空闲时间上限（示例代码假设单个组件预创建耗时最长1ms=1000000ns）。</li><li>当剩余空闲时间足够创建组件时，在这一帧中进行组件预创建，并不断更新当前帧的剩余空闲时间。</li><li>若当前帧剩余空闲时间不足以创建组件，通过postFrameCallback()方法，将回调传递到下一帧，继续进行剩余组件的预创建。<div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/IdleCallback.ets#L24-L64" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdleCallback</span> <span class="hljs-title">extends</span> <span class="hljs-title">FrameCallback</span> {</li><li>  <span class="hljs-keyword">private</span> uiContext: UIContext;</li><li>  <span class="hljs-comment">// Pre build component index, start from 0</span></li><li>  <span class="hljs-keyword">private</span> todoCount: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> dataArray: ItemData[] = [];</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(context: UIContext, preBuildData: ItemData[]) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.uiContext = context;</li><li>    <span class="hljs-keyword">this</span>.dataArray = preBuildData;</li><li>  }</li><li>
</li><li>  onIdle(idleTimeInNano: number): void {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.todoCount &gt;= <span class="hljs-keyword">this</span>.dataArray.length) {</li><li>      <span class="hljs-comment">// All pre build completed</span></li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    let cur: number = systemDateTime.getTime(<span class="hljs-literal">true</span>);</li><li>    let timeLeft = idleTimeInNano;</li><li>    <span class="hljs-comment">// if the build time for a single component is 1000000 ns</span></li><li>    <span class="hljs-keyword">while</span> (timeLeft &gt;= <span class="hljs-number">1000000</span>) {</li><li>      hiTraceMeter.startTrace(<span class="hljs-string">'onIdle_prebuild'</span>, <span class="hljs-number">1</span>);</li><li>      <span class="hljs-comment">// prebuild the component</span></li><li>      NodePool.getInstance().preBuild(<span class="hljs-string">'reuse_type_'</span>, <span class="hljs-keyword">this</span>.dataArray[<span class="hljs-keyword">this</span>.todoCount], listItemWrapper, <span class="hljs-keyword">this</span>.uiContext);</li><li>      hiTraceMeter.finishTrace(<span class="hljs-string">'onIdle_prebuild'</span>, <span class="hljs-number">1</span>);</li><li>      <span class="hljs-comment">// update the idle time</span></li><li>      let now = systemDateTime.getTime(<span class="hljs-literal">true</span>);</li><li>      timeLeft = timeLeft - (now - cur);</li><li>      cur = now;</li><li>      <span class="hljs-keyword">this</span>.todoCount++;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.todoCount &gt;= <span class="hljs-keyword">this</span>.dataArray.length) {</li><li>        <span class="hljs-comment">// All pre build completed</span></li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.todoCount &lt; <span class="hljs-keyword">this</span>.dataArray.length) {</li><li>        <span class="hljs-comment">// Pre build not completed, proceed to the next frame</span></li><li>        <span class="hljs-keyword">this</span>.uiContext.postFrameCallback(<span class="hljs-keyword">this</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/utils/IdleCallback.ets#L24-L64" target="_blank">IdleCallback.ets</a></div></div></div></div> </li></ol> <p></p></li><li><span>在进入Swiper+List的页面之前，选择合适的时机执行context.postFrameCallback()，开启IdleCallback帧回调逻辑。</span><p></p><div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/Index.ets#L26-L86" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">Index</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dataArray</span>: <span class="hljs-title class_">ItemData</span>[] = [];</li><li>    <span class="hljs-variable">dataArray</span>.<span class="hljs-title function_">push</span>(...<span class="hljs-title function_">genMockItemData</span>(<span class="hljs-number">100</span>))</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">context</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>();</li><li>    <span class="hljs-variable">context</span>.<span class="hljs-title function_">postFrameCallback</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">IdleCallback</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">dataArray</span>));</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/component-reuse/blob/master/entry/src/main/ets/pages/Index.ets#L26-L86" target="_blank">Index.ets</a></div></div></div></div> <p></p></li></ol> <div class="tiledSection"><h2 id="section8616535133216">更多优化方法<i class="anchor-icon anchor-icon-link" anchorid="section8616535133216" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1035317458423" class="firsth2">使用attributeUpdater实现组件属性的部分刷新<i class="anchor-icon anchor-icon-link" anchorid="section1035317458423" tips="复制节点链接"></i></h3></div> <p>在可复用组件中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-attributeupdater" target="_blank">attributeUpdater</a>可以控制指定属性的刷新，避免不必要的重绘、减少渲染负载，从而提升应用性能。</p> <p>默认情况下，直接使用状态变量在aboutToReuse()中进行数据赋值，会导致组件全部属性刷新。实际需求中，可能只需要更新组件的部分属性。例如，当组件复用显示时，只希望设置文本的字体颜色，那么可以使用attributeUpdater在aboutToReuse()修改fontColor属性。</p> <p>反例：</p> <p>这里通过aboutToReuse()对fontColor状态变量更新，导致组件全部属性进行刷新，造成不必要的耗时。</p> <div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LessEmbeddedComponent</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">momentData</span>.<span class="hljs-title function_">getFriendMomentFromRawfile</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-string">'use nothing'</span>)</li><li>      <span class="hljs-title function_">List</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">ListConstants</span>.<span class="hljs-title class_">LIST_SPACE</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">momentData</span>, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; {</li><li>          <span class="hljs-title function_">ListItem</span>() {</li><li>            <span class="hljs-title function_">OneMomentNoModifier</span>({ <span class="hljs-variable">color</span>: <span class="hljs-title class_">moment</span>.<span class="hljs-title class_">color</span> })</li><li>              .<span class="hljs-title function_">onClick</span>(() =&gt; {</li><li>                <span class="hljs-variable">console</span>.<span class="hljs-title function_">log</span>(`<span class="hljs-variable">my</span> <span class="hljs-variable">id</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>}`)</li><li>              })</li><li>          }</li><li>        }, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; <span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">"100%"</span>)</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-number">5</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneMomentNoModifier</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">color</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span> | <span class="hljs-title class_">Resource</span> = <span class="hljs-string">""</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">color</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-string">'This is title'</span>)</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-string">'This is desc text'</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-variable">TextAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">fontStyle</span>(<span class="hljs-variable">FontStyle</span>.<span class="hljs-variable">Normal</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">13</span>)</li><li>        .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.6</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">10</span> })</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">30</span>)</li><li>        .<span class="hljs-title function_">clip</span>(<span class="hljs-keyword">false</span>)</li><li>        .<span class="hljs-title function_">backgroundBlurStyle</span>(<span class="hljs-variable">BlurStyle</span>.<span class="hljs-variable">NONE</span>)</li><li>        .<span class="hljs-title function_">foregroundBlurStyle</span>(<span class="hljs-variable">BlurStyle</span>.<span class="hljs-variable">NONE</span>)</li><li>        .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)</li><li>        .<span class="hljs-title function_">borderColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Pink</span>)</li><li>        .<span class="hljs-title function_">borderStyle</span>(<span class="hljs-variable">BorderStyle</span>.<span class="hljs-variable">Solid</span>)</li><li>        .<span class="hljs-title function_">alignRules</span>({</li><li>          <span class="hljs-string">'top'</span>: { <span class="hljs-string">'anchor'</span>: <span class="hljs-string">'__container__'</span>, <span class="hljs-string">'align'</span>: <span class="hljs-title class_">VerticalAlign</span>.<span class="hljs-title class_">Top</span> },</li><li>          <span class="hljs-string">'left'</span>: { <span class="hljs-string">'anchor'</span>: <span class="hljs-string">'image'</span>, <span class="hljs-string">'align'</span>: <span class="hljs-title class_">HorizontalAlign</span>.<span class="hljs-title class_">End</span> }</li><li>        })</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>正例：</p> <p>通过attributeUpdater对Text组件中的fontColor属性进行精准刷新，避免重绘Text中不需要更改的属性。</p> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/UpdaterComponent.ets#L24-L125" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyTextUpdater</span> <span class="hljs-variable">extends</span> <span class="hljs-title class_">AttributeUpdater</span>&lt;<span class="hljs-title class_">TextAttribute</span>&gt; {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-variable">color</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span> | <span class="hljs-title class_">Resource</span> | <span class="hljs-title class_">Color</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-variable">color</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span> | <span class="hljs-title class_">Resource</span> | <span class="hljs-title class_">Color</span>) {</li><li>    <span class="hljs-keyword">super</span>();</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span> = <span class="hljs-variable">color</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">initializeModifier</span>(<span class="hljs-variable">instance</span>: <span class="hljs-title class_">TextAttribute</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-variable">instance</span>.<span class="hljs-title function_">fontColor</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span>) <span class="hljs-comment">// Differentiated update</span></li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneMomentNoModifier</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">text</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">color</span>: <span class="hljs-title class_">string</span> | <span class="hljs-title class_">number</span> | <span class="hljs-title class_">Resource</span> | <span class="hljs-title class_">Color</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">textUpdater</span>: <span class="hljs-title class_">MyTextUpdater</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">textUpdater</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyTextUpdater</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">color</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">text</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">text</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">string</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">textUpdater</span>?.<span class="hljs-variable">attribute</span>?.<span class="hljs-title function_">fontColor</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">text</span>)</li><li>        .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">18</span>)</li><li>        .<span class="hljs-title function_">textAlign</span>(<span class="hljs-variable">TextAlign</span>.<span class="hljs-variable">Center</span>)</li><li>        .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">500</span>)</li><li>        .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">24</span>)</li><li>        .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>)</li><li>        .<span class="hljs-title function_">opacity</span>(<span class="hljs-number">0.6</span>)</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-string">'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'</span>)</li><li>          .<span class="hljs-title function_">attributeModifier</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">textUpdater</span>) <span class="hljs-comment">// Precise refresh</span></li><li>          .<span class="hljs-title function_">textAlign</span>(<span class="hljs-variable">TextAlign</span>.<span class="hljs-variable">Start</span>)</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-number">16</span>)</li><li>          .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">400</span>)</li><li>          .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">21</span>)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/UpdaterComponent.ets#L24-L125" target="_blank">UpdaterComponent.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section711438114319">使用@Link/@ObjectLink替代@Prop以减少深拷贝<i class="anchor-icon anchor-icon-link" anchorid="section711438114319" tips="复制节点链接"></i></h3></div> <p>在可复用组件中，建议使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link" target="_blank">@Link</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink" target="_blank">@ObjectLink</a>替代<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop" target="_blank">@Prop</a>。因为@Prop装饰变量时会进行深拷贝，增加了创建时间及内存消耗，而改用@Link/@ObjectLink，变量会共享同一地址。</p> <p>反例：</p> <div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">lessEmbeddedComponent</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">getFriendMomentFromRawfile</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">TopBar</span>()</li><li>      <span class="hljs-title function_">List</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">ListConstants</span>.<span class="hljs-title class_">LIST_SPACE</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">momentData</span>, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; {</li><li>          <span class="hljs-title function_">ListItem</span>() {</li><li>            <span class="hljs-title function_">OneMoment</span>({<span class="hljs-variable">moment</span>: <span class="hljs-title class_">moment</span>})</li><li>          }</li><li>        }, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; <span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-variable">Constants</span>.<span class="hljs-variable">CACHED_COUNT</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneMoment</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      ...</li><li>      <span class="hljs-title function_">Text</span>(`${<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">userName</span>}`)</li><li>      ...</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FriendMoment</span> {</li><li>  <span class="hljs-variable">id</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">userName</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">avatar</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">text</span>: <span class="hljs-title class_">string</span>;</li><li>  <span class="hljs-variable">size</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">image</span>?: <span class="hljs-title class_">string</span>;</li><li>}</li></ol></pre></div></div> <p>正例：</p> <p>将子组件moment变量@Prop改为@ObjectLink即可。</p> <p>父子组件之间的数据同步用了@ObjectLink来进行，子组件@ObjectLink包装类把当前this指针注册给父组件，会直接将父组件的数据同步给子组件，实现父子组件数据的双向同步，降低子组件创建时间和内存消耗。</p> <div class="tiledSection"><h3 id="section7441712174414">避免对@Link/@ObjectLink/@Prop等自动更新的状态变量，在aboutToReuse()中重复赋值<i class="anchor-icon anchor-icon-link" anchorid="section7441712174414" tips="复制节点链接"></i></h3></div> <p>如果可复用组件中使用了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-link" target="_blank">@Link</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-observed-and-objectlink" target="_blank">@ObjectLink</a>/<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-prop" target="_blank">@Prop</a>等自动同步父子组件数据的状态变量，则不需要在aboutToReuse()中对这些数据重复赋值。如果重新赋值这些变量，会导致组件的内容重新触发状态刷新，造成额外的计算更新耗时。</p> <p>反例：</p> <div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">OneMoment</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">moment</span>: <span class="hljs-title class_">FriendMoment</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moment</span>.<span class="hljs-property">id</span> = (params.<span class="hljs-property">moment</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">FriendMoment</span>).<span class="hljs-property">id</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moment</span>.<span class="hljs-property">userName</span> = (params.<span class="hljs-property">moment</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">FriendMoment</span>).<span class="hljs-property">userName</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moment</span>.<span class="hljs-property">avatar</span> = (params.<span class="hljs-property">moment</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">FriendMoment</span>).<span class="hljs-property">avatar</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moment</span>.<span class="hljs-property">text</span> = (params.<span class="hljs-property">moment</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">FriendMoment</span>).<span class="hljs-property">text</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">moment</span>.<span class="hljs-property">image</span> = (params.<span class="hljs-property">moment</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">FriendMoment</span>).<span class="hljs-property">image</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      ...</li><li>      <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.moment.userName}</span>`</span>)</li><li>      ...</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>正例：</p> <p>将aboutToReuse()中的赋值语句删除。</p> <p>@ObjectLink修饰的moment状态变量已包含自动刷新功能，不需要再重复赋值刷新。</p> <div class="tiledSection"><h3 id="section1239555818211">使用reuseId标记布局发生变化的组件<i class="anchor-icon anchor-icon-link" anchorid="section1239555818211" tips="复制节点链接"></i></h3><p>在同一段自定义组件代码中，如果使用if/else条件语句控制布局结构，会导致在不同逻辑分支中创建不同布局的组件，从而造成组件树结构的差异。此时可以使用reuseId来区分发生变化的分支逻辑，确保系统能够根据reuseId缓存各种结构的组件，提升复用性能。</p> <p>反例：</p> <p>组件通过if条件创建包含Image的Flex组件。不使用reuseId时，复用后根据if条件，可能会删除Flex或重新创建Flex，存在性能消耗。</p> <div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">AboutReuseId</span> {</li><li>  </li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">TopBar</span>()</li><li>      <span class="hljs-title function_">List</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">ListConstants</span>.<span class="hljs-title class_">LIST_SPACE</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">momentData</span>, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; {</li><li>          <span class="hljs-title function_">ListItem</span>() {</li><li>            <span class="hljs-title function_">OneMoment</span>({</li><li>              <span class="hljs-variable">moment</span>: <span class="hljs-title class_">moment</span>,</li><li>              <span class="hljs-variable">fontSize</span>: <span class="hljs-title class_">moment</span>.<span class="hljs-title class_">size</span></li><li>            })</li><li>          }</li><li>        }, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; <span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-variable">Constants</span>.<span class="hljs-variable">CACHED_COUNT</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneMoment</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      ...</li><li>      <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">text</span>)</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">image</span> !== <span class="hljs-string">''</span>) {</li><li>        <span class="hljs-title function_">Flex</span>({ <span class="hljs-variable">wrap</span>: <span class="hljs-title class_">FlexWrap</span>.<span class="hljs-title class_">Wrap</span> }) {</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">image</span>))</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">image</span>))</li><li>          <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">image</span>))</li><li>        }</li><li>      }</li><li>      ...</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>正例：</p> <p>根据分支逻辑设置不同的reuseId，缓存不同布局结构下的组件，省去重复执行if的删除或创建逻辑。</p> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/WithReuseId.ets#L20-L95" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Entry</span></li><li><span class="hljs-variable">@Component</span></li><li>struct WithReuseId {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>      <span class="hljs-selector-tag">List</span>({ space: this.LIST_SPACE }) {</li><li>        <span class="hljs-selector-tag">LazyForEach</span>(this.momentData, (<span class="hljs-attribute">moment</span>: FriendMoment) =&gt; {</li><li>          <span class="hljs-selector-tag">ListItem</span>() {</li><li>            <span class="hljs-selector-tag">OneMoment</span>({ moment: moment })<span class="hljs-comment">// ReusId is used to control component reuse</span></li><li>              <span class="hljs-selector-class">.reuseId</span>((moment.image !== <span class="hljs-string">''</span>) ? <span class="hljs-string">'withImage_id'</span> : <span class="hljs-string">'noImage_id'</span>)</li><li>          }</li><li>        }, (<span class="hljs-attribute">moment</span>: FriendMoment) =&gt; moment.id)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-selector-tag">Reusable</span></li><li>@<span class="hljs-selector-tag">Component</span></li><li><span class="hljs-selector-tag">export</span> <span class="hljs-selector-tag">struct</span> <span class="hljs-selector-tag">OneMoment</span> {</li><li>  <span class="hljs-variable">@ObjectLink</span> <span class="hljs-attribute">moment</span>: FriendMoment;</li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-selector-tag">if</span> (this.moment.image !== <span class="hljs-string">''</span>) {</li><li>        <span class="hljs-selector-tag">Flex</span>({ wrap: FlexWrap.Wrap }) {</li><li>          <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(this.moment.image))</li><li>            <span class="hljs-selector-class">.width</span>(Constants.LAYOUT_MAX)</li><li>            <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'27.5%'</span>)</li><li>            <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">16</span>)</li><li>          <span class="hljs-selector-tag">Image</span>($<span class="hljs-built_in">r</span>(this.moment.image))</li><li>            <span class="hljs-selector-class">.width</span>(Constants.LAYOUT_MAX)</li><li>            <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'27.5%'</span>)</li><li>            <span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">16</span>)</li><li>            <span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">top</span>: <span class="hljs-number">10</span> })</li><li>        }</li><li>        .<span class="hljs-built_in">width</span>(Constants.LAYOUT_MAX)</li><li>        .<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">top</span>: <span class="hljs-number">14</span> })</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/WithReuseId.ets#L20-L95" target="_blank">WithReuseId.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section1694217165418">避免使用函数方法作为复用组件的入参<i class="anchor-icon anchor-icon-link" anchorid="section1694217165418" tips="复制节点链接"></i></h3></div> <p>如果可复用组件的入参使用了函数方法，因每次复用都需要重新创建组件关联的数据对象，该函数会在每次复用时执行，造成性能问题。建议改为通过状态变量传递参数，从而减少重复执行入参中的函数所带来的性能消耗。</p> <p>反例：</p> <p>复用的子组件参数sum是通过模拟耗时函数countAndReturn()生成。该函数在每次组件复用时都执行，会造成性能问题，甚至导致列表滑动过程中的卡顿丢帧。</p> <div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">withFuncParam</span> {</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-title function_">getFriendMomentFromRawfile</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">countAndReturn</span>(): <span class="hljs-title class_">number</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">temp</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">index</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">index</span> &lt; <span class="hljs-number">100000</span>; <span class="hljs-title class_">index</span>++) {</li><li>      <span class="hljs-variable">temp</span> += <span class="hljs-variable">index</span>;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">temp</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">TopBar</span>()</li><li>      <span class="hljs-title function_">List</span>({ <span class="hljs-variable">space</span>: <span class="hljs-title class_">ListConstants</span>.<span class="hljs-title class_">LIST_SPACE</span> }) {</li><li>        <span class="hljs-title function_">LazyForEach</span>(<span class="hljs-variable">momentData</span>, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; {</li><li>          <span class="hljs-title function_">ListItem</span>() {</li><li>            <span class="hljs-title function_">OneMoment</span>({</li><li>              <span class="hljs-variable">moment</span>: <span class="hljs-title class_">moment</span>,</li><li>              <span class="hljs-variable">sum</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">countAndReturn</span>()</li><li>            })</li><li>          }</li><li>        }, (<span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>) =&gt; <span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>)</li><li>      }</li><li>      .<span class="hljs-title function_">cachedCount</span>(<span class="hljs-variable">Constants</span>.<span class="hljs-variable">CACHED_COUNT</span>)</li><li>    }</li><li>  }</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Reusable</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">OneMoment</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">moment</span>: <span class="hljs-title class_">FriendMoment</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">sum</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-variable">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">sum</span> = <span class="hljs-variable">params</span>.<span class="hljs-variable">sum</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      ...</li><li>      <span class="hljs-title function_">Text</span>(`${<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">userName</span>} （${<span class="hljs-keyword">this</span>.<span class="hljs-variable">moment</span>.<span class="hljs-variable">id</span>} / ${<span class="hljs-keyword">this</span>.<span class="hljs-variable">sum</span>}）`)</li><li>      ...</li><li>    }</li><li>  }</li><li>}</li></ol></pre></div></div> <p>正例：</p> <p>可以先将countAndReturn()计算放到页面初始时执行，将结果赋值给this.sum变量。在复用组件的参数传递时，通过this.sum来进行。</p> <div class="screenLinkPre"><div _ngcontent-ruc-c106="" class="highlight-div"><div _ngcontent-ruc-c106="" class="highlight-div-header"><div _ngcontent-ruc-c106="" class="highlight-div-header-left"><div _ngcontent-ruc-c106="" class="handle-button expand-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ruc-c106="" class="highlight-div-header-right"><div _ngcontent-ruc-c106="" class="handle-button ai-button"></div><div _ngcontent-ruc-c106="" class="handle-button line-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ruc-c106="" class="handle-button theme-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ruc-c106="" class="handle-button copy-button"><div _ngcontent-ruc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ruc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/WithFuncParam.ets#L20-L157" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">WithFuncParam</span> {</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">sum</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">MOCK_ASYNC_DEFAULT_NUM</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1000000</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">MOCK_ASYNC_TIME_OUT_NUM</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">2000</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">momentData</span>.<span class="hljs-title function_">getFriendMomentFromRawFile</span>();</li><li>    <span class="hljs-comment">// Execute the asynchronous function</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">countAndReturn</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">countAndReturn</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sleep</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">MOCK_ASYNC_DEFAULT_NUM</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">sleep</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {</li><li>      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'ok'</span>);</li><li>      }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">MOCK_ASYNC_TIME_OUT_NUM</span>)</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-title class_">List</span>({ <span class="hljs-attr">space</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">LIST_SPACE</span> }) {</li><li>        <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">momentData</span>, <span class="hljs-function">(<span class="hljs-params">moment: FriendMoment</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">ListItem</span>() {</li><li>            <span class="hljs-comment">// Parameters of subcomponents are transferred through status variables</span></li><li>            <span class="hljs-title class_">OneMoment</span>({</li><li>              <span class="hljs-attr">moment</span>: moment,</li><li>              <span class="hljs-attr">sum</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span></li><li>            })</li><li>          }</li><li>        }, <span class="hljs-function">(<span class="hljs-params">moment: FriendMoment</span>) =&gt;</span> moment.<span class="hljs-property">id</span>)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">OneMoment</span> {</li><li>  <span class="hljs-meta">@ObjectLink</span> <span class="hljs-attr">moment</span>: <span class="hljs-title class_">FriendMoment</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">sum</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">aboutToReuse</span>(<span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sum</span> = params.<span class="hljs-property">sum</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/ComponentReuse/entry/src/main/ets/view/WithFuncParam.ets#L20-L157" target="_blank">WithFuncParam.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section13507239143219">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section13507239143219" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section14488171012519" class="firsth2">如何检查组件复用是否生效<i class="anchor-icon anchor-icon-link" anchorid="section14488171012519" tips="复制节点链接"></i></h3><ul><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide-code-linter" target="_blank">Code Linter扫描工具</a>进行代码检查，重点关注<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ide_hp-arkui-use-reusable-component" target="_blank">@performance/hp-arkui-use-reusable-component</a>规则。</li><li>通过Profiler工具抓取Trace，搜索组件名称，根据BuildRecycle字段识别是否触发复用渲染。具体可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-optimization-overview#section1588117331934" target="_blank">通过Trace识别懒加载渲染流程</a>。</li><li>通过Profiler工具抓取Trace，识别是否发生丢帧，判断子组件创建的次数。具体分析过程可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-best-practices-long-list#section1069111015296" target="_blank">优化长列表-组件复用性能分析</a>。</li></ul> </div> <div class="tiledSection"><h2 id="section19165144443217">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section19165144443217" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/component-reuse/" target="_blank">实现组件复用</a></li></ul> </div> </div></div>