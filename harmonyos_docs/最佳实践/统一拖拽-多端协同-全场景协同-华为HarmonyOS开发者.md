<h1 _ngcontent-lgn-c119="" class="doc-title ng-star-inserted" title="统一拖拽"> 统一拖拽 </h1>

<div _ngcontent-lgn-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section17485416163911">概述<i class="anchor-icon anchor-icon-link" anchorid="section17485416163911" tips="复制节点链接"></i></h2><p>拖拽操作是一种直观且高效的数据传输方式，它允许用户通过手势（如用手指、鼠标或触控笔按住并移动）在应用程序之间及其内部进行数据传输。拖拽功能不仅操作便捷，还能与多种系统能力深度融合，从而拓展出更为广泛的应用场景。例如，跨设备拖拽功能使得用户能够在不同设备间无缝传输数据，而跨窗口拖拽则提高了多任务处理的灵活性。此外，基于拖拽操作还可以开发出更多创新性应用场景，如AI智能识别、水印添加等，这些创新性的功能统称为“统一拖拽”。</p> <p>拖拽过程中的数据传输基于统一数据管理框架（Unified Data Management Framework，UDMF）实现，UDMF为多对多跨应用数据共享场景提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel" target="_blank">标准化数据通路</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-uniformdatastruct" target="_blank">标准化数据结构</a>。统一数据对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#unifieddata" target="_blank">UnifiedData</a>提供了封装一组数据记录的方法，其中数据记录<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#unifiedrecord" target="_blank">UnifiedRecord</a>可为一条HTML记录、一条图片记录等。UnifiedRecord支持调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#addentry15" target="_blank">addEntry()</a>接口在当前数据记录中添加指定数据类型和内容的数据，通过此方法增加的数据类型和内容代表同一内容的不同表现形式。例如，对于一段文字，可以构造html和text两种样式的entry。通过这种方式，接收方能够按需选择接收。</p> <p>本文结合不同的场景，提供具体的示例方案，帮助开发者更好地理解和应用拖拽技术。</p> <p>通过设置组件的拖拽响应，可以自定义拖出数据、拖入数据和拖拽背板图，实现如下场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section197593813453">拖拽图像增加水印</a>：为拖拽的图像添加水印，水印内容为图像的拖拽时间。开发者可以在应用时根据需求自定义水印内容，例如标记拖拽图片的来源信息，为图像管理与溯源提供便利。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section350662014143">自定义拖拽背板图</a>：将拖拽过程中的背板图设置为自定义数据内容。开发者可根据个性化需求打造独特的拖拽视觉效果。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section4125035104613">AI识别拖拽内容</a>：通过在接收拖拽内容时增加AI识别功能，使得只能显示文字的组件可以接收图片拖拽并显示图片中的文字信息。开发者可以将此能力应用于拖拽识图搜索。</li></ul> </div> <p>对于文件的拖拽，可以分为在线文件拖拽和本地文件拖拽：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section17176101812472">在线文件拖拽保存</a>：拖拽在线的文件，落入方根据业务需要选择是否将文件下载到本地。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section722512624716">本地文件拖拽保存</a>：拖拽本地的文件，落入方调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#startdataloading15" target="_blank">startDataLoading()</a>接口获取数据，根据需要选择是否将文件保存到落入方沙箱路径。</li></ul> <p>对于图文混排内容的拖拽，可以使用Text组件、RichEditor组件呈现图文混排的内容，在拖拽时构造多条UnifiedRecord记录。在落入方接收多条Record记录。为了适配落入方不同的接收格式，可以为UnifiedRecord构造多条entry数据，在落入方根据需要解析出不同的entry数据。</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section164891641978">基于Text组件的图文混排拖拽</a>：基于Text组件呈现图文混排内容，落入方基于UDMF多Record接收数据。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section85351118482">基于RichEditor组件的图文混排拖拽</a>：基于RichEditor组件呈现图文混排内容，落入方基于UDMF多Record接收数据。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section5352104013812">基于UDMF多Entry的图文混排拖拽</a>：基于RichEditor组件呈现图文混排内容，拖出方手动构造UDMF多Entry数据，落入方基于UDMF多Record接收数据，并适配UDMF多Entry数据的接收。</li></ul> <p>将拖拽框架与系统的分屏能力、键鼠穿越能力、小艺及中转站结合，可以实现如下场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section35671536195312">分屏拖拽</a>：演示了分屏拖拽的功能，可以在分屏中打开两个不同的应用，实现跨应用拖拽。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section15501112385010">跨设备拖拽</a>：演示了基于键鼠穿越能力的跨设备拖拽，可以在平板和2in1设备中使用此功能以直观便捷地交换数据。</li><li><a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section1289155519508">拖入小艺和中转站</a>：演示了小艺和中转站与拖拽框架结合的能力，可以利用中转站暂存拖拽内容或进行跨设备拖拽，也可以利用小艺的AI对话式分析能力处理拖拽内容。</li></ul> <div class="tiledSection"><h2 id="section14546457589">开发流程<i class="anchor-icon anchor-icon-link" anchorid="section14546457589" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/design-guides/hmi-scenes-drag-0000001795410277#section1417334354817" target="_blank">拖拽的流程</a>可以分为三部分：发起拖拽、拖拽中和释放拖拽。其中，拖出方通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#draggable" target="_blank">draggable()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>等接口处理拖出数据，拖入方通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#allowdrop" target="_blank">allowDrop()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>等接口处理拖入数据，拖拽数据使用UDMF统一数据对象<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#unifieddata" target="_blank">UnifiedData</a>进行封装。</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>拖拽流程展示</caption><thead><tr><th align="center" class="cellrowborder" id="mcps1.3.8.3.2.4.1.1" valign="top" width="33.33333333333333%"><p>发起拖拽</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.8.3.2.4.1.2" valign="top" width="33.33333333333333%"><p>拖拽中</p> </th> <th align="center" class="cellrowborder" id="mcps1.3.8.3.2.4.1.3" valign="top" width="33.33333333333333%"><p>释放拖拽</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="550.3939" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163247.79025036312154164191901677140927:50001231000000:2800:028BA1D05209A778B43E7998D59CD2A8BEAF5F05098D2CE621A2B311871DDCCA.gif" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="550.3806000000001" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163247.00061902449061031500350931675949:50001231000000:2800:1F59D710715A9A52C17FC3D2422D2AD46E2A34B1B9F8F9560EA5FA77CEB808B6.gif" title="点击放大" width="266"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="550.3673" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163247.66337721529909570596289220666842:50001231000000:2800:9321137FAFC09CEE7B62751C2CB913F51EC7CDEAD8A265FE5B5BAD766E96943D.gif" title="点击放大" width="266"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section728425613423" class="firsth2">发起拖拽<i class="anchor-icon anchor-icon-link" anchorid="section728425613423" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop" target="_blank">默认支持拖出能力的组件</a>，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-search" target="_blank">Search</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-hyperlink" target="_blank">Hyperlink</a>等，在拖出时会使用组件的默认拖出响应。其中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-search" target="_blank">Search</a>组件默认拖拽内容为选中的文字，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-hyperlink" target="_blank">Hyperlink</a>组件默认拖拽内容为超链接地址。如果想自定义组件的拖拽内容，需要在组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中将自定义数据封装成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#unifieddata" target="_blank">UnifiedData</a>数据对象，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#setdata10" target="_blank">setData()</a>接口设置拖出数据。对于其他非默认组件或自定义组件，如果想实现其拖出功能，需要将组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#draggable" target="_blank">draggable()</a>属性设置为true，并自定义组件的拖拽内容。以RichEditor组件为例：</p> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L275-L316" data-highlighted="yes"><ol class="linenums"><li>RichEditor({ controller: <span class="hljs-keyword">this</span>.sourceController })</li><li><span class="hljs-comment">// ...</span></li><li>  .onDragStart((event) =&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> selection = <span class="hljs-keyword">this</span>.sourceController.getSelection();</li><li>      <span class="hljs-comment">// construct drag data</span></li><li>      <span class="hljs-keyword">this</span>.buildUnifiedRecords(selection);</li><li>      event.setData(<span class="hljs-keyword">this</span>.unifiedData);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      hilog.error(<span class="hljs-number">0x0000</span>, TAG, `%{<span class="hljs-keyword">public</span>}s`, err.code, err.message);</li><li>    }</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L275-L316" target="_blank">MultiEntry.ets</a></div></div></div></div> <p>可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中处理拖拽信息，例如为图片添加水印，详情见<a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section197593813453">拖拽图像增加水印</a>。</p> </div> <div class="tiledSection"><h3 id="section7384412992">拖拽中<i class="anchor-icon anchor-icon-link" anchorid="section7384412992" tips="复制节点链接"></i></h3><p>通过标准手势发起拖拽后，系统会默认将组件本身的截图作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-common-events-drag-event#拖拽背板图" target="_blank">拖拽背板图</a>。如果想自定义拖拽背板图，需要在组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>回调中设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragiteminfo" target="_blank">DragItemInfo</a>，传入自定义背板图。以Image组件为例，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L99-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.mount'</span>))</li><li><span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onDragStart</span>(() =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dragItemInfo</span>: <span class="hljs-title class_">DragItemInfo</span> = {</li><li>      <span class="hljs-variable">pixelMap</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">pixelMap</span>,</li><li>      <span class="hljs-variable">builder</span>: () =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">pixelMapBuilder</span>()</li><li>      },</li><li>    };</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">dragItemInfo</span>;</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L99-L142" target="_blank">Background.ets</a></div></div></div></div> <p>可以将拖拽背板图设置为自定义的图片或者文字，详情见<a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section350662014143">自定义拖拽背板图</a>。</p> </div> <div class="tiledSection"><h3 id="section91043366223">释放拖拽<i class="anchor-icon anchor-icon-link" anchorid="section91043366223" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">默认支持拖入能力的组件</a>，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-search" target="_blank">Search</a>组件等，将目标拖入组件区域内会使用默认拖入响应。如果想自定义组件的拖入响应，需要将组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#allowdrop" target="_blank">allowDrop()</a>属性设置为允许拖入的数据类型，并在其<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口中通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#getdata10" target="_blank">getData()</a>接口获取拖入数据后，读取其中的UnifiedRecord记录的集合。对于每条记录，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#gettypes12" target="_blank">getTypes()</a>方法获取其中包含的数据类型，取出所需要的数据。以Text组件获取拖拽文字为例：</p> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textInput/TextInput.ets#L77-L122" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">dropContent</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">allowDrop</span>([uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">TEXT</span>,</li><li>  uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">PLAIN_TEXT</span>])</li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-function">(<span class="hljs-params">event: DragEvent</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> dragData = event.<span class="hljs-title function_">getData</span>();</li><li>    <span class="hljs-keyword">let</span> records = dragData.<span class="hljs-title function_">getRecords</span>();</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> record <span class="hljs-keyword">of</span> records) {</li><li>      <span class="hljs-keyword">let</span> types = record.<span class="hljs-title function_">getTypes</span>();</li><li>      <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">includes</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">PLAIN_TEXT</span>)) {</li><li>        <span class="hljs-keyword">const</span> plainTextUds =</li><li>          record.<span class="hljs-title function_">getEntry</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">PLAIN_TEXT</span>) <span class="hljs-keyword">as</span> uniformDataStruct.<span class="hljs-property">PlainText</span>;</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">dropContent</span> = plainTextUds.<span class="hljs-property">textContent</span>;</li><li>        event.<span class="hljs-title function_">setResult</span>(<span class="hljs-title class_">DragResult</span>.<span class="hljs-property">DRAG_SUCCESSFUL</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textInput/TextInput.ets#L77-L122" target="_blank">TextInput.ets</a></div></div></div></div> <p>可以在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口中处理接收到的数据，例如将图片识别为文字以显示在只支持文字的组件上，详情见<a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section4125035104613">AI识别拖拽内容</a>。</p> </div> <div class="tiledSection"><h2 id="section197593813453">拖拽图像增加水印<i class="anchor-icon anchor-icon-link" anchorid="section197593813453" tips="复制节点链接"></i></h2><p>在拖拽过程中，可以自定义拖出响应，为拖拽图像增加水印，以标识图像的相关信息。下面以在图像中增加拖拽时间水印为例，介绍实现原理。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图1 </b>拖拽图片增加水印</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163247.78905915024196241333263163185484:50001231000000:2800:8EEE67D56023464BCB22B10913A38DAC921E86F5DB6202FB9052E5F900A060D8.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p>在拖出对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中获取图像信息，调用系统绘制能力<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-drawing" target="_blank">drawing</a>在图像上绘制水印，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#setdata10" target="_blank">setData()</a>接口将水印图像设置为拖拽数据。</p> <p><strong>开发步骤</strong></p> <ol><li>将拖出方Image组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#draggable" target="_blank">draggable()</a>属性设置为true。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L144-L157" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_ invoke__">Image</span>(<span class="hljs-variable">$rawfile</span>(<span class="hljs-string">'river.png'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_ invoke__">draggable</span>(<span class="hljs-literal">true</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L144-L157" target="_blank">Watermark.ets</a></div></div></div></div> </li><li>在拖出对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中，获取图像信息并将其转换成<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L145-L198" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Image</span>($<span class="hljs-title function_">rawfile</span>(<span class="hljs-string">'river.png'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onDragStart</span>((<span class="hljs-variable">event</span>: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">resourceMgr</span>: <span class="hljs-title class_">resourceManager</span>.<span class="hljs-title class_">ResourceManager</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">rawFileDescriptor</span> = <span class="hljs-variable">resourceMgr</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-string">'river.png'</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageSourceApi</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">rawFileDescriptor</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> = <span class="hljs-variable">imageSourceApi</span>.<span class="hljs-title function_">createPixelMapSync</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L145-L198" target="_blank">Watermark.ets</a></div></div></div></div> </li><li>将图片绘制到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>画布上，并获取拖拽时间作为水印绘制到画布上的指定位置，得到添加水印的图像。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L146-L199" data-highlighted="yes"><ol class="linenums"><li>Image($rawfile(<span class="hljs-string">'river.png'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .onDragStart((event: DragEvent) =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.time = <span class="hljs-keyword">this</span>.getTimeWatermark(systemDateTime.getTime(<span class="hljs-literal">false</span>));</li><li>    let markPixelMap: image.PixelMap = <span class="hljs-keyword">this</span>.addWaterMark(<span class="hljs-keyword">this</span>.time, pixelMap);</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L146-L199" target="_blank">Watermark.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L94-L135" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addWaterMark</span>(<span class="hljs-variable">watermark</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Graphics.Drawing'</span>)) {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `%{<span class="hljs-keyword">public</span>}<span class="hljs-variable">s</span>`, `<span class="hljs-variable">watermark</span> <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">supported</span>`);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-variable">pixelMap</span>;</li><li>    }</li><li>    <span class="hljs-variable">watermark</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.drag_time'</span>)) + <span class="hljs-variable">watermark</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageInfo</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Size</span> = <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">getImageInfoSync</span>().<span class="hljs-variable">size</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">imageInfo</span>.<span class="hljs-variable">width</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">imageInfo</span>.<span class="hljs-variable">height</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageScale</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">imageWidth</span> / <span class="hljs-variable">display</span>.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-variable">width</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">canvas</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Canvas</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Canvas</span>(<span class="hljs-variable">pixelMap</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">pen</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Pen</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Pen</span>();</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">brush</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Brush</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Brush</span>();</li><li>    <span class="hljs-variable">pen</span>.<span class="hljs-title function_">setColor</span>({</li><li>      <span class="hljs-variable">alpha</span>: <span class="hljs-number">102</span>,</li><li>      <span class="hljs-variable">red</span>: <span class="hljs-number">255</span>,</li><li>      <span class="hljs-variable">green</span>: <span class="hljs-number">255</span>,</li><li>      <span class="hljs-variable">blue</span>: <span class="hljs-number">255</span></li><li>    });</li><li>    <span class="hljs-variable">brush</span>.<span class="hljs-title function_">setColor</span>({</li><li>      <span class="hljs-variable">alpha</span>: <span class="hljs-number">102</span>,</li><li>      <span class="hljs-variable">red</span>: <span class="hljs-number">255</span>,</li><li>      <span class="hljs-variable">green</span>: <span class="hljs-number">255</span>,</li><li>      <span class="hljs-variable">blue</span>: <span class="hljs-number">255</span></li><li>    });</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">font</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Font</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Font</span>();</li><li>    <span class="hljs-variable">font</span>.<span class="hljs-title function_">setSize</span>(<span class="hljs-number">48</span> * <span class="hljs-variable">imageScale</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">textWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">font</span>.<span class="hljs-title function_">measureText</span>(<span class="hljs-variable">watermark</span>, <span class="hljs-variable">drawing</span>.<span class="hljs-variable">TextEncoding</span>.<span class="hljs-variable">TEXT_ENCODING_UTF8</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">textBlob</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">TextBlob</span> =</li><li>      <span class="hljs-variable">drawing</span>.<span class="hljs-variable">TextBlob</span>.<span class="hljs-title function_">makeFromString</span>(<span class="hljs-variable">watermark</span>, <span class="hljs-variable">font</span>, <span class="hljs-variable">drawing</span>.<span class="hljs-variable">TextEncoding</span>.<span class="hljs-variable">TEXT_ENCODING_UTF8</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachBrush</span>(<span class="hljs-variable">brush</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachPen</span>(<span class="hljs-variable">pen</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawTextBlob</span>(<span class="hljs-variable">textBlob</span>, <span class="hljs-variable">imageWidth</span> - <span class="hljs-number">24</span> * <span class="hljs-variable">imageScale</span> - <span class="hljs-variable">textWidth</span>, <span class="hljs-variable">imageHeight</span> - <span class="hljs-number">32</span> * <span class="hljs-variable">imageScale</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">detachBrush</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">detachPen</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'addWaterMark failed:'</span>, (<span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>).<span class="hljs-variable">message</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">pixelMap</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L94-L135" target="_blank">Watermark.ets</a></div></div></div></div> </li><li>将图像打包保存在文件中，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#setdata10" target="_blank">setData()</a>接口将水印图像设置为拖拽数据。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L147-L200" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Image</span>($<span class="hljs-title function_">rawfile</span>(<span class="hljs-string">'river.png'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onDragStart</span>((<span class="hljs-variable">event</span>: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">packOpts</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PackingOption</span> = { <span class="hljs-variable">format</span>: <span class="hljs-string">'image/png'</span>, <span class="hljs-variable">quality</span>: <span class="hljs-number">20</span> };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">file</span>: <span class="hljs-title class_">fs</span>.<span class="hljs-title class_">File</span> =</li><li>      <span class="hljs-variable">fs</span>.<span class="hljs-title function_">openSync</span>(`${<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span>}/<span class="hljs-variable">watermark</span>.<span class="hljs-variable">png</span>`, <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">CREATE</span> | <span class="hljs-variable">fs</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span>);</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imagePackerApi</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImagePacker</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImagePacker</span>();</li><li>    <span class="hljs-variable">imagePackerApi</span>.<span class="hljs-title function_">packToFile</span>(<span class="hljs-variable">markPixelMap</span>, <span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>, <span class="hljs-variable">packOpts</span>);</li><li>    <span class="hljs-variable">imagePackerApi</span>?.<span class="hljs-title function_">release</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imgData</span>: <span class="hljs-title class_">uniformDataStruct</span>.<span class="hljs-title class_">FileUri</span> = {</li><li>      <span class="hljs-variable">uniformDataType</span>: <span class="hljs-string">'general.file-uri'</span>,</li><li>      <span class="hljs-variable">oriUri</span>: <span class="hljs-title class_">fileUri</span>.<span class="hljs-title class_">getUriFromPath</span>(`${<span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">filesDir</span>}/<span class="hljs-variable">watermark</span>.<span class="hljs-variable">png</span>`),</li><li>      <span class="hljs-variable">fileType</span>: <span class="hljs-string">'general.image'</span></li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">unifiedRecord</span> =</li><li>      <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedRecord</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>, <span class="hljs-variable">imgData</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">unifiedData</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedData</span>(<span class="hljs-variable">unifiedRecord</span>);</li><li>    <span class="hljs-variable">event</span>.<span class="hljs-title function_">setData</span>(<span class="hljs-variable">unifiedData</span>);</li><li>    <span class="hljs-variable">fs</span>.<span class="hljs-title function_">closeSync</span>(<span class="hljs-variable">file</span>.<span class="hljs-variable">fd</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/watermark/Watermark.ets#L147-L200" target="_blank">Watermark.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section350662014143">自定义拖拽背板图<i class="anchor-icon anchor-icon-link" anchorid="section350662014143" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-common-events-drag-event#拖拽背板图" target="_blank">拖拽背板图</a>用于在拖拽过程中展示用户拖动的数据，可以自定义拖拽背板图。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图2 </b>自定义拖拽背板</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163247.60787608897445820881234962861944:50001231000000:2800:3D5D5B9D5FB7A3514605B39472A0B44AC288464BF885910129D6900EC4000BAB.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p>在拖出对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中，自定义<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>作为拖拽过程中的背板图。</p> <p><strong>开发步骤</strong></p> <ol><li>创建自定义组件。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L43-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Builder</span></li><li><span class="hljs-built_in">pixelMapBuilder</span>() {</li><li>  <span class="hljs-selector-tag">Column</span>() {</li><li>    <span class="hljs-selector-tag">Text</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.background_content'</span>))</li><li>      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-string">'16fp'</span>)</li><li>      <span class="hljs-selector-class">.margin</span>({</li><li>        <span class="hljs-attribute">left</span>: <span class="hljs-string">'16vp'</span>,</li><li>        <span class="hljs-attribute">right</span>: <span class="hljs-string">'16vp'</span>,</li><li>        <span class="hljs-attribute">top</span>: <span class="hljs-string">'8vp'</span>,</li><li>        <span class="hljs-attribute">bottom</span>: <span class="hljs-string">'8vp'</span></li><li>      })</li><li>  }</li><li>  .<span class="hljs-built_in">backgroundColor</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'sys.color.comp_background_primary'</span>))</li><li>  .<span class="hljs-built_in">borderRadius</span>(<span class="hljs-number">16</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L43-L57" target="_blank">Background.ets</a></div></div></div></div> </li><li>将自定义组件转换成PixelMap，作为拖拽过程中显示的图片。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L61-L71" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">getComponentSnapshot</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getComponentSnapshot</span>().<span class="hljs-title function_">createFromBuilder</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pixelMapBuilder</span>()</li><li>  }, <span class="hljs-function">(<span class="hljs-params">error: <span class="hljs-built_in">Error</span>, pixmap: image.PixelMap</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`%{public}s`</span>, error.<span class="hljs-property">message</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = pixmap;</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L61-L71" target="_blank">Background.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>由于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-types#custombuilder8" target="_blank">CustomBuilder</a>需要离线渲染之后才能使用，存在一定的性能开销和时延，因此推荐开发者优先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragiteminfo" target="_blank">DragItemInfo</a>中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>方式返回背板图。</p> </div></div></div> </li><li>在拖出对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#onpredrag12" target="_blank">onPreDrag()</a>接口中，预先创建背板图。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L93-L134" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'app.media.mount'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onPreDrag</span>(<span class="hljs-function">(<span class="hljs-params">status: PreDragStatus</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title class_">PreDragChange</span>(status);</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L93-L134" target="_blank">Background.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L75-L79" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">PreDragChange</span><span class="hljs-params">(preDragStatus: PreDragStatus)</span>: void {</span></li><li>  <span class="hljs-keyword">if</span> (preDragStatus == PreDragStatus.ACTION_DETECTING_STATUS) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-built_in">getComponentSnapshot</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L75-L79" target="_blank">Background.ets</a></div></div></div></div> </li><li>在拖出对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>接口中，将回调的PixelMap作为拖拽过程中的背板图。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L92-L135" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.mount'</span>))</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onDragStart</span>(() =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dragItemInfo</span>: <span class="hljs-title class_">DragItemInfo</span> = {</li><li>      <span class="hljs-variable">pixelMap</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">pixelMap</span>,</li><li>      <span class="hljs-variable">builder</span>: () =&gt; {</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">pixelMapBuilder</span>()</li><li>      },</li><li>    };</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">dragItemInfo</span>;</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/background/Background.ets#L92-L135" target="_blank">Background.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section4125035104613">AI识别拖拽内容<i class="anchor-icon anchor-icon-link" anchorid="section4125035104613" tips="复制节点链接"></i></h2><p>在拖拽过程中，可以自定义拖入响应，以识别拖拽内容并将其输出在释放区内。本章节以通过AI识别拖拽图像中的文字为例，介绍实现原理。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图3 </b>AI识别拖拽内容</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.13478874916459823123013776044386:50001231000000:2800:7E403E74A6C1EA824A3E43B45E0FECF89CA5284D9BF7B370F07ED767545E7935.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p>在拖入对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口中，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#getdata10" target="_blank">getData()</a>接口获取拖拽数据后，调用系统能力<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/core-vision-text-recognition-api" target="_blank">textRecognition（文字识别）</a>得到图像中的文字信息。</p> <p><strong>开发步骤</strong></p> <ol><li>在拖拽释放区域的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#allowdrop" target="_blank">allowDrop()</a>接口中设置允许拖入的数据类型为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-uniformtypedescriptor#uniformdatatype" target="_blank">uniformTypeDescriptor.UniformDataType.IMAGE</a>。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L78-L181" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">Column</span>() {</li><li>  Text(this.textContent)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-selector-class">.allowDrop</span>([uniformTypeDescriptor.UniformDataType.IMAGE])</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L78-L181" target="_blank">AIRecognition.ets</a></div></div></div></div> </li><li>在拖入对象的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口中，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#getdata10" target="_blank">getData()</a>接口获取拖拽数据。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L79-L182" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-keyword">async</span> (event?: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">dragData</span>: <span class="hljs-title class_">UnifiedData</span> = (event <span class="hljs-keyword">as</span> <span class="hljs-title class_">DragEvent</span>).<span class="hljs-title function_">getData</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">UnifiedData</span>;</li><li>    <span class="hljs-keyword">if</span> (dragData === <span class="hljs-literal">undefined</span>) {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`%{public}s`</span>, <span class="hljs-string">`ondrop undefined data`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">records</span>: unifiedDataChannel.<span class="hljs-property">UnifiedRecord</span>[] = dragData.<span class="hljs-title function_">getRecords</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDrop error, error code: <span class="hljs-subst">${err.code}</span>, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L79-L182" target="_blank">AIRecognition.ets</a></div></div></div></div> </li><li>将拖拽数据转换成颜色数据格式为BGRA_8888的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap" target="_blank">PixelMap</a>类型的视觉信息。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L80-L180" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">Text</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">textContent</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-variable">async</span> (<span class="hljs-variable">event</span>?: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">records</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">types</span> = <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getTypes</span>();</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>)) {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">fileUriUds</span> =</li><li>          <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">FileUri</span>;</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">typeDescriptor</span> = <span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-title function_">getTypeDescriptor</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">fileType</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeDescriptor</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">IMAGE</span>)) {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">resourceReg</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">RegExp</span>(<span class="hljs-string">'resource'</span>);</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">resourceReg</span>.<span class="hljs-title function_">test</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">oriUri</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">numberReg</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">RegExp</span>(<span class="hljs-string">'[0-9]+'</span>);</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">idArray</span> = <span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">oriUri</span>.<span class="hljs-keyword">match</span>(<span class="hljs-variable">numberReg</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">idArray</span> !== <span class="hljs-variable">null</span>) {</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">id</span> = <span class="hljs-variable">idArray</span>[<span class="hljs-number">0</span>];</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">drawableDescriptor</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getDrawableDescriptor</span>(<span class="hljs-title function_">Number</span>(<span class="hljs-variable">id</span>), <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMapInit</span> = <span class="hljs-variable">drawableDescriptor</span>.<span class="hljs-title function_">getPixelMap</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">image</span>.<span class="hljs-variable">PixelMap</span>;</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">imageHeight</span> = <span class="hljs-variable">pixelMapInit</span>.<span class="hljs-title function_">getImageInfoSync</span>().<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>;</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">imageWidth</span> = <span class="hljs-variable">pixelMapInit</span>.<span class="hljs-title function_">getImageInfoSync</span>().<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span>;</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">readBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">imageHeight</span> * <span class="hljs-variable">imageWidth</span> * <span class="hljs-number">4</span>);</li><li>              <span class="hljs-variable">pixelMapInit</span>.<span class="hljs-title function_">readPixelsToBufferSync</span>(<span class="hljs-variable">readBuffer</span>);</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">InitializationOptions</span> = {</li><li>                <span class="hljs-variable">editable</span>: <span class="hljs-keyword">true</span>,</li><li>                <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">imageHeight</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">imageWidth</span> },</li><li>                <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">pixelMapInit</span>.<span class="hljs-title class_">getImageInfoSync</span>().<span class="hljs-title class_">pixelFormat</span>,</li><li>                <span class="hljs-variable">pixelFormat</span>: <span class="hljs-number">3</span>,</li><li>                <span class="hljs-variable">alphaType</span>: <span class="hljs-title class_">pixelMapInit</span>.<span class="hljs-title class_">getImageInfoSync</span>().<span class="hljs-title class_">alphaType</span>,</li><li>                <span class="hljs-variable">scaleMode</span>: <span class="hljs-number">0</span></li><li>              };</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMapSync</span>(<span class="hljs-variable">readBuffer</span>, <span class="hljs-variable">opts</span>);</li><li>              <span class="hljs-comment">// ...</span></li><li>            }</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">startDataLoading</span> <span class="hljs-variable">errorCode</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">errorMessage</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L80-L180" target="_blank">AIRecognition.ets</a></div></div></div></div> </li><li>调用系统文字识别能力textRecognition获取拖拽数据中的文字信息。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L81-L178" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Text</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-keyword">async</span> (event?: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; records.<span class="hljs-property">length</span>; i++) {</li><li>      <span class="hljs-keyword">let</span> types = records[i].<span class="hljs-title function_">getTypes</span>();</li><li>      <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">includes</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">FILE_URI</span>)) {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">if</span> (typeDescriptor.<span class="hljs-title function_">belongsTo</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>)) {</li><li>          <span class="hljs-comment">// ...</span></li><li>          <span class="hljs-keyword">if</span> (resourceReg.<span class="hljs-title function_">test</span>(fileUriUds.<span class="hljs-property">oriUri</span>)) {</li><li>            <span class="hljs-comment">// ...</span></li><li>            <span class="hljs-keyword">if</span> (idArray !== <span class="hljs-literal">null</span>) {</li><li>              <span class="hljs-comment">// ...</span></li><li>              <span class="hljs-keyword">let</span> <span class="hljs-attr">visionInfo</span>: textRecognition.<span class="hljs-property">VisionInfo</span> = { <span class="hljs-attr">pixelMap</span>: pixelMap };</li><li>              <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> textRecognition.<span class="hljs-title function_">recognizeText</span>(visionInfo);</li><li>              <span class="hljs-keyword">let</span> recognitionString = data.<span class="hljs-property">value</span>;</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">textContent</span> = recognitionString;</li><li>            }</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`startDataLoading errorCode: <span class="hljs-subst">${err.code}</span>, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/aiRecognition/AIRecognition.ets#L81-L178" target="_blank">AIRecognition.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section181490456532">文件拖拽<i class="anchor-icon anchor-icon-link" anchorid="section181490456532" tips="复制节点链接"></i></h2><p>文件拖拽操作可分为在线文件拖拽和本地文件拖拽。</p> <p>在线文件拖拽时，拖出方需提供文件的下载地址，下载操作由落入方处理。若业务需求要求在拖出方完成下载，则需将下载与拖拽操作分开处理，确保文件在拖出前已完成下载，以避免拖出失败。</p> <p>对于本地文件的拖拽，建议构造FileUri类型的数据进行拖拽。在文件落入时，应通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#startdataloading15" target="_blank">startDataLoading()</a>接口获取数据，如需将文件保存在本地，可设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#datasyncoptions15" target="_blank">datasyncoptions</a>参数的destUri值，将文件保存至本地沙箱路径中。</p> </div> <div class="tiledSection"><h2 id="section17176101812472">在线文件拖拽保存<i class="anchor-icon anchor-icon-link" anchorid="section17176101812472" tips="复制节点链接"></i></h2><p>以在线图片为例，拖出放Image组件绑定了在线的图片资源。通过拖拽将图片移至目标区域展示，目标区域可选择是否将图片资源下载到本地。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图4 </b>在线图片拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.10441131743240315265327316791554:50001231000000:2800:FE227F03FD04E74AE1A6CC17E4502F1DCDA0FB773067B05255F3CFDF8FB73EB0.gif" title="点击放大" width="266"></span></div> <p><strong>使用说明</strong></p> <p>加载在线图片资源需在工程module.json5文件中添加网络权限。</p> <p><strong>实现原理</strong></p> <p>在落入方<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调中获取拖拽数据，得到访问图片的链接，同时根据业务需要选择是否将图片下载到本地。本示例模拟了需要下载的场景。</p> <p><strong>开发步骤：</strong></p> <ol><li>开启网络权限。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/module.json5#L63-L74" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.INTERNET"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:internet_reason"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>: <span class="hljs-string">"inuse"</span></li><li>    }</li><li>  }</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/module.json5#L63-L74" target="_blank">module.json5</a></div></div></div></div> </li><li>设置拖出方Image组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#draggable" target="_blank">draggable()</a>属性为true。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-rust" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L51-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_ invoke__">Image</span>(<span class="hljs-symbol">'https</span>:<span class="hljs-comment">//www-file.huawei.com/-/media/corp2020/home/banner/12/pura-x-1.jpg')</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_ invoke__">draggable</span>(<span class="hljs-literal">true</span>)</li><li>    <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L51-L67" target="_blank">OnlineImage.ets</a></div></div></div></div> </li><li>在落入方Image组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调中获取图片的uri，绑定到落入方组件上，触发UI刷新。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L82-L145" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetImage</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-function">(<span class="hljs-params">event?: DragEvent</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> dragData = event?.<span class="hljs-title function_">getData</span>() <span class="hljs-keyword">as</span> unifiedDataChannel.<span class="hljs-property">UnifiedData</span>;</li><li>    <span class="hljs-keyword">if</span> (dragData) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">records</span>: <span class="hljs-title class_">Array</span>&lt;unifiedDataChannel.<span class="hljs-property">UnifiedRecord</span>&gt; = dragData.<span class="hljs-title function_">getRecords</span>();</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; records.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">let</span> types = records[i].<span class="hljs-title function_">getTypes</span>();</li><li>        <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">includes</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">FILE_URI</span>)) {</li><li>          <span class="hljs-keyword">const</span> fileUriUds =</li><li>            records[i].<span class="hljs-title function_">getEntry</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">FILE_URI</span>) <span class="hljs-keyword">as</span> uniformDataStruct.<span class="hljs-property">FileUri</span>;</li><li>          <span class="hljs-keyword">let</span> typeDescriptor = uniformTypeDescriptor.<span class="hljs-title function_">getTypeDescriptor</span>(fileUriUds.<span class="hljs-property">fileType</span>);</li><li>          <span class="hljs-keyword">if</span> (typeDescriptor.<span class="hljs-title function_">belongsTo</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>)) {</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetImage</span> = fileUriUds.<span class="hljs-property">oriUri</span>;</li><li>            <span class="hljs-comment">// ...</span></li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L82-L145" target="_blank">OnlineImage.ets</a></div></div></div></div> </li><li>在落入方Image组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调里调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#导入模块" target="_blank">request</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestdownloadfile9" target="_blank">downloadFile()</a>方法下载图片资源。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L83-L146" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Image</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">targetImage</span>)</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>(<span class="hljs-function">(<span class="hljs-params">event?: DragEvent</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> dragData = event?.<span class="hljs-title function_">getData</span>() <span class="hljs-keyword">as</span> unifiedDataChannel.<span class="hljs-property">UnifiedData</span>;</li><li>    <span class="hljs-keyword">if</span> (dragData) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">records</span>: <span class="hljs-title class_">Array</span>&lt;unifiedDataChannel.<span class="hljs-property">UnifiedRecord</span>&gt; = dragData.<span class="hljs-title function_">getRecords</span>();</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; records.<span class="hljs-property">length</span>; i++) {</li><li>        <span class="hljs-keyword">let</span> types = records[i].<span class="hljs-title function_">getTypes</span>();</li><li>        <span class="hljs-keyword">if</span> (types.<span class="hljs-title function_">includes</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">FILE_URI</span>)) {</li><li>          <span class="hljs-comment">// ...</span></li><li>          <span class="hljs-keyword">if</span> (typeDescriptor.<span class="hljs-title function_">belongsTo</span>(uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>)) {</li><li>            <span class="hljs-comment">// ...</span></li><li>            request.<span class="hljs-title function_">downloadFile</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, {</li><li>              <span class="hljs-attr">url</span>: fileUriUds.<span class="hljs-property">oriUri</span>,</li><li>              <span class="hljs-attr">filePath</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/test.png'</span></li><li>            }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-keyword">const</span> file = fs.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/test.png'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span>);</li><li>              <span class="hljs-keyword">const</span> arrayBuffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">1024</span>);</li><li>              <span class="hljs-keyword">const</span> readLen = fs.<span class="hljs-title function_">readSync</span>(file.<span class="hljs-property">fd</span>, arrayBuffer);</li><li>              buffer.<span class="hljs-title function_">from</span>(arrayBuffer, <span class="hljs-number">0</span>, readLen);</li><li>              fs.<span class="hljs-title function_">closeSync</span>(file);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`%{public}s`</span>, error.<span class="hljs-property">code</span>, error.<span class="hljs-property">message</span>);</li><li>            })</li><li>          }</li><li>        }</li><li>      }</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/onlineimage/OnlineImage.ets#L83-L146" target="_blank">OnlineImage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section722512624716">本地文件拖拽保存<i class="anchor-icon anchor-icon-link" anchorid="section722512624716" tips="复制节点链接"></i></h2><p>本示例展示拖拽本地的文件，以$rawfile目录下的视频文件为例。</p> <p><strong>运行效果</strong></p> <div class="fignone"><span class="figcap"><b>图5 </b>本地视频拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.29693349259298762942838258865156:50001231000000:2800:0549CFC0E5FFC6FD00F2151D04700FBA6F732AFF4E4C0D8C99CA829D4AE981FA.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p>为了实现文件的拖拽，通常会构建一个<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-uniformdatastruct#fileuri15" target="_blank">uniformDataStruct.FileUri</a>类型的数据对象，传入文件的uri，并通过设置fileType属性来区分不同的文件类型。在接收方的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调函数中获取uri，进而访问该文件。建议使用UDMF的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#startdataloading15" target="_blank">startDataLoading()</a>接口获取文件，并展示获取进度。如果接收方需要将文件拷贝到本地，可以通过向参数<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#datasyncoptions15" target="_blank">datasyncoptions</a>传入destUri来指定目标路径，UDMF将会把文件拷贝至该路径。</p> <p><strong>实现步骤：</strong></p> <ol><li>设置拖出方Video组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-drag-drop#draggable" target="_blank">draggable()</a>属性为true。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L51-L95" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Video</span>({</li><li>  <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>('<span class="hljs-title class_">video</span>.<span class="hljs-title class_">mp4</span>'),</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">VideoController</span>()</li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">draggable</span>(<span class="hljs-keyword">true</span>)</li><li>    <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L51-L95" target="_blank">LocalVideo.ets</a></div></div></div></div> </li><li>在拖出视频的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>回调中，将视频文件复制到沙箱目录。构造<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-uniformdatastruct#fileuri15" target="_blank">uniformDataStruct.FileUri</a>类型的数据，将oriUri设置为沙箱路径下视频文件的uri。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L52-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Video</span>({</li><li>  <span class="hljs-variable">src</span>: $<span class="hljs-title class_">rawfile</span>('<span class="hljs-title class_">video</span>.<span class="hljs-title class_">mp4</span>'),</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">VideoController</span>()</li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onDragStart</span>((<span class="hljs-variable">event</span>: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-string">'video.mp4'</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">filePath</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span> + <span class="hljs-string">'/video.mp4'</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">dest</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">filePath</span>, <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">CREATE</span> | <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">bufferSize</span> = <span class="hljs-variable">data</span>.<span class="hljs-variable">length</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">buf</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">bufferSize</span>);</li><li>      <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">data</span>.<span class="hljs-variable">fd</span>, <span class="hljs-variable">buf</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">offset</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">bufferSize</span> });</li><li>      <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">writeSync</span>(<span class="hljs-variable">dest</span>.<span class="hljs-variable">fd</span>, <span class="hljs-variable">buf</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">bufferSize</span> });</li><li>      <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">close</span>(<span class="hljs-variable">dest</span>.<span class="hljs-variable">fd</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">closeRawFd</span>(<span class="hljs-string">'video.mp4'</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">originalVideoUri</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable">filePath</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">unifiedData</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedData</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">unifiedRecord</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedRecord</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">video</span>: <span class="hljs-title class_">uniformDataStruct</span>.<span class="hljs-title class_">FileUri</span> = {</li><li>        <span class="hljs-variable">uniformDataType</span>: <span class="hljs-string">'general.file-uri'</span>,</li><li>        <span class="hljs-variable">oriUri</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">originalVideoUri</span>,</li><li>        <span class="hljs-variable">fileType</span>: <span class="hljs-string">'general.video'</span></li><li>      }</li><li>      <span class="hljs-variable">unifiedRecord</span>.<span class="hljs-title function_">addEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">VIDEO</span>, <span class="hljs-variable">video</span>);</li><li>      <span class="hljs-variable">unifiedData</span>.<span class="hljs-title function_">addRecord</span>(<span class="hljs-variable">unifiedRecord</span>);</li><li>      <span class="hljs-variable">event</span>.<span class="hljs-title function_">setData</span>(<span class="hljs-variable">unifiedData</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `%{<span class="hljs-keyword">public</span>}<span class="hljs-variable">s</span>`, <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>, <span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>);</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L52-L93" target="_blank">LocalVideo.ets</a></div></div></div></div> </li><li>在拖入方Video组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调里调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#startdataloading15" target="_blank">startDataLoading()</a>接口获取拖拽的数据，提取uri并绑定到落入方Video组件上。同时由于设置了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#datasyncoptions15" target="_blank">datasyncoptions</a>中的destUri参数，UDMF会将视频保存到本地的沙箱路径中。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L111-L161" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">Video</span>({ <span class="hljs-variable">src</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetVideoUri</span>, <span class="hljs-variable">controller</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">VideoController</span>() })</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onDrop</span>((<span class="hljs-variable">event</span>?: <span class="hljs-title class_">DragEvent</span>) =&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">progressListener</span>: <span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">DataProgressListener</span> =</li><li>      (<span class="hljs-variable">_progress</span>: <span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">ProgressInfo</span>, <span class="hljs-variable">dragData</span>: <span class="hljs-title class_">UnifiedData</span> | <span class="hljs-title class_">null</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">dragData</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">records</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">UnifiedRecord</span>&gt; = <span class="hljs-variable">dragData</span>.<span class="hljs-title function_">getRecords</span>();</li><li>          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">records</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">types</span> = <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getTypes</span>();</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>)) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">fileUriUds</span> =</li><li>                <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">FileUri</span>;</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">typeDescriptor</span> = <span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-title function_">getTypeDescriptor</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">fileType</span>);</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeDescriptor</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">VIDEO</span>)) {</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetVideoUri</span> = <span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">oriUri</span>;</li><li>              }</li><li>            }</li><li>          }</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'dragData is undefined'</span>);</li><li>        }</li><li>      };</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">destUri</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">distributedFilesDir</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">DataSyncOptions</span> = {</li><li>      <span class="hljs-variable">destUri</span>: <span class="hljs-title class_">destUri</span>,</li><li>      <span class="hljs-variable">fileConflictOptions</span>: <span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">FileConflictOptions</span>.<span class="hljs-title class_">OVERWRITE</span>,</li><li>      <span class="hljs-variable">progressIndicator</span>: <span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">ProgressIndicator</span>.<span class="hljs-title class_">DEFAULT</span>,</li><li>      <span class="hljs-variable">dataProgressListener</span>: <span class="hljs-title class_">progressListener</span>,</li><li>    };</li><li>    (<span class="hljs-variable">event</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">DragEvent</span>).<span class="hljs-title function_">startDataLoading</span>(<span class="hljs-variable">options</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">err</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">startDataLoading</span> <span class="hljs-variable">errorCode</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">errorMessage</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}, { <span class="hljs-variable">disableDataPrefetch</span>: <span class="hljs-keyword">true</span> })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/localvideo/LocalVideo.ets#L111-L161" target="_blank">LocalVideo.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section173939184717">图文混排拖拽<i class="anchor-icon anchor-icon-link" anchorid="section173939184717" tips="复制节点链接"></i></h2><p>此场景涉及拖拽图片与文字混合的内容。对于轻量级的图文混排内容，可以通过向<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-text#接口" target="_blank">Text</a>组件中添加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-span#接口" target="_blank">Span</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-imagespan#接口" target="_blank">ImageSpan</a>子组件来实现。此外，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#接口" target="_blank">RichEditor</a>组件也可构建图文混排内容。如何选择适合的图文混排组件，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-arkui-23" target="_blank">如何选择图文混排方案</a>。</p> <p>在某些情况下，不同的接收方对同一内容支持的格式各不相同。此时，开发者可以自定义图文混排的拖拽内容，设置UDMF多Entry形式的拖拽数据，以适应不同的接收方。</p> </div> <div class="tiledSection"><h3 id="section164891641978" class="firsth2">基于Text组件的图文混排拖拽<i class="anchor-icon anchor-icon-link" anchorid="section164891641978" tips="复制节点链接"></i></h3><p><strong>运行效果如下所示</strong></p> <div class="fignone"><span class="figcap"><b>图6 </b>Text组件图文混排拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.26101582451300657853115751633483:50001231000000:2800:0093345D239953ED6C4D98911585652F454899FD98BC2FD9508C5AF4A36DD83D.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-text#接口" target="_blank">Text</a>组件默认具有拖出能力，在拖入区域中分别接收文本和图片对应的UnifiedRecord数据，绑定至拖入Text组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-span#接口" target="_blank">Span</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-imagespan#接口" target="_blank">ImageSpan</a>子组件上，实现较为简单，但是不支持交互式编辑，且拖入方组件需要预先和拖出方组件保持一致的样式，灵活性较差。</p> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/Text.ets#L87-L168" data-highlighted="yes"><ol class="linenums"><li>Column() {</li><li>  Text() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.onDrop(<span class="hljs-keyword">async</span> (<span class="hljs-keyword">event</span>?: DragEvent) =&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> dragData: UnifiedData = (<span class="hljs-keyword">event</span> <span class="hljs-keyword">as</span> DragEvent).getData() <span class="hljs-keyword">as</span> UnifiedData;</li><li>    <span class="hljs-keyword">if</span> (dragData !== undefined) {</li><li>      <span class="hljs-keyword">let</span> records: Array&lt;unifiedDataChannel.UnifiedRecord&gt; = dragData.getRecords();</li><li>      <span class="hljs-keyword">if</span> (records.length &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; records.length; i++) {</li><li>          <span class="hljs-keyword">let</span> types = records[i].getTypes();</li><li>          <span class="hljs-keyword">if</span> (types.includes(uniformTypeDescriptor.UniformDataType.FILE_URI)) {</li><li>            <span class="hljs-keyword">const</span> fileUriUds =</li><li>              records[i].getEntry(uniformTypeDescriptor.UniformDataType.FILE_URI) <span class="hljs-keyword">as</span> uniformDataStruct.FileUri;</li><li>            <span class="hljs-keyword">let</span> typeDescriptor = uniformTypeDescriptor.getTypeDescriptor(fileUriUds.fileType);</li><li>            <span class="hljs-keyword">if</span> (typeDescriptor.belongsTo(uniformTypeDescriptor.UniformDataType.IMAGE)) {</li><li>              <span class="hljs-keyword">this</span>.targetImage = fileUriUds.oriUri;</li><li>            }</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (types.includes(uniformTypeDescriptor.UniformDataType.PLAIN_TEXT)) {</li><li>            <span class="hljs-keyword">const</span> plainTextUds =</li><li>              records[i].getEntry(uniformTypeDescriptor.UniformDataType.PLAIN_TEXT) <span class="hljs-keyword">as</span> uniformDataStruct.PlainText;</li><li>            <span class="hljs-keyword">this</span>.targetTextContent = plainTextUds.textContent;</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (types.includes(uniformTypeDescriptor.UniformDataType.OPENHARMONY_PIXEL_MAP)) {</li><li>            <span class="hljs-keyword">const</span> pixelMapUds =</li><li>              records[i].getEntry(uniformTypeDescriptor.UniformDataType.OPENHARMONY_PIXEL_MAP) <span class="hljs-keyword">as</span> uniformDataStruct.PixelMap;</li><li>            <span class="hljs-keyword">this</span>.targetImage = pixelMapUds.pixelMap;</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">event</span>?.setResult(<span class="hljs-number">0</span>);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/Text.ets#L87-L168" target="_blank">Text.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section85351118482">基于RichEditor组件的图文混排拖拽<i class="anchor-icon anchor-icon-link" anchorid="section85351118482" tips="复制节点链接"></i></h3><p><strong>运行效果展示</strong></p> <div class="fignone"><span class="figcap"><b>图7 </b>RichEditor组件图文混排拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.22025485049727166894368359190818:50001231000000:2800:D58935D7982ADCBE8B35ED9B4656BB9B6EC6F27D692934564608F5C150AA0152.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <div class="p">RichEditor组件默认具备拖出的能力，并且支持交互式编辑，在拖出方不需要手动构造拖拽的数据，在拖入方通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">addImageSpan()</a>方法和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">addTextSpan()</a>方法动态地将图片和文字的内容添加到拖入方RichEditor组件上。通过这种方式，在拖入方声明RichEditor组件即可，接收到的图文内容可以动态地添加，使用起来更加方便灵活，代码开发较为简单，核心代码如下：<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/RichEditor.ets#L160-L177" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">RichEditor</span>({ <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetController</span> })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">allowDrop</span>([uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>,</li><li>    uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">OPENHARMONY_PIXEL_MAP</span>, uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">TEXT</span>,</li><li>    uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">PLAIN_TEXT</span>])</li><li>  .<span class="hljs-title function_">onDrop</span>(<span class="hljs-function">(<span class="hljs-params">event: DragEvent</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      event.<span class="hljs-title function_">setResult</span>(<span class="hljs-number">0</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">receiveDragData</span>(event);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`on drop error, errorCode: <span class="hljs-subst">${err.code}</span>, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/RichEditor.ets#L160-L177" target="_blank">RichEditor.ets</a></div></div></div></div> </div> </div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/RichEditor.ets#L54-L116" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">async</span> <span class="hljs-title function_">receiveDragData</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">DragEvent</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dragData</span>: <span class="hljs-title class_">UnifiedData</span> = (<span class="hljs-variable">event</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">DragEvent</span>).<span class="hljs-title function_">getData</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">UnifiedData</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">dragData</span> !== <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">records</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">UnifiedRecord</span>&gt; = <span class="hljs-variable">dragData</span>.<span class="hljs-title function_">getRecords</span>();</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">records</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">records</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">types</span> = <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getTypes</span>();</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">fileUriUds</span> =</li><li>              <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">FileUri</span>;</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">typeDescriptor</span> = <span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-title function_">getTypeDescriptor</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">fileType</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeDescriptor</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">IMAGE</span>)) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">oriUri</span>,</li><li>                {</li><li>                  <span class="hljs-variable">imageStyle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">imageStyle</span>,</li><li>                  <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>                })</li><li>            }</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">plainTextUds</span> =</li><li>              <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">PlainText</span>;</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController</span>.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">plainTextUds</span>.<span class="hljs-variable">textContent</span>,</li><li>              {</li><li>                <span class="hljs-variable">style</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">textStyle</span>,</li><li>                <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController</span>.<span class="hljs-title class_">getCaretOffset</span>(),</li><li>              })</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">OPENHARMONY_PIXEL_MAP</span>)) {</li><li>            <span class="hljs-keyword">const</span> <span class="hljs-variable">pixelMapUds</span> =</li><li>              <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">OPENHARMONY_PIXEL_MAP</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">PixelMap</span>;</li><li>            <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">pixelMapUds</span>.<span class="hljs-variable">pixelMap</span>,</li><li>              {</li><li>                <span class="hljs-variable">imageStyle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">imageStyle</span>,</li><li>                <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>              })</li><li>            <span class="hljs-keyword">continue</span>;</li><li>          }</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/RichEditor.ets#L54-L116" target="_blank">RichEditor.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用RichEditor组件时，需要在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调里手动调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#dragevent7" target="_blank">DragEvent</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#setdata10" target="_blank">setResult()</a>接口设置拖拽结果，否则会执行系统默认的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口导致文字落入两次。参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>接口。</p> </div></div></div> <div class="tiledSection"><h3 id="section5352104013812">基于UDMF多Entry的图文混排拖拽<i class="anchor-icon anchor-icon-link" anchorid="section5352104013812" tips="复制节点链接"></i></h3><p><strong>运行效果如下所示</strong></p> <div class="fignone"><span class="figcap"><b>图8 </b>多Entry图文混排拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163248.30241926257150082877295611393824:50001231000000:2800:744F9629382B5C92E4CE65C0F1E6FD8290B7DD24C2D33D533F81B14829BC9860.gif" title="点击放大" width="266"></span></div> <p><strong>实现原理</strong></p> <p>在拖出方手动构造多Entry数据进行拖拽，这种方式灵活性较高，但是由于需要用户手动去构造拖拽数据，因此代码开发更加复杂。</p> <p><strong>开发步骤</strong></p> <ol><li>在拖出方RichEditor组件的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondragstart" target="_blank">onDragStart()</a>回调中，根据选中的内容构造拖拽数据。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L266-L309" data-highlighted="yes"><ol class="linenums"><li>RichEditor({ controller: <span class="hljs-keyword">this</span>.sourceController })</li><li><span class="hljs-comment">// ...</span></li><li>  .onSelectionChange((value: RichEditorRange) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.selectedStartIndex = value.start <span class="hljs-keyword">as</span> number;</li><li>    <span class="hljs-keyword">this</span>.selectedEndIndex = value.end <span class="hljs-keyword">as</span> number;</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .onDragStart((event) =&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> selection = <span class="hljs-keyword">this</span>.sourceController.getSelection();</li><li>      <span class="hljs-comment">// construct drag data</span></li><li>      <span class="hljs-keyword">this</span>.buildUnifiedRecords(selection);</li><li>      event.setData(<span class="hljs-keyword">this</span>.unifiedData);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> BusinessError;</li><li>      hilog.error(<span class="hljs-number">0x0000</span>, TAG, `%{<span class="hljs-keyword">public</span>}s`, err.code, err.message);</li><li>    }</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L266-L309" target="_blank">MultiEntry.ets</a></div></div></div></div> </li><li>封装buildUnifiedRecords()函数，构造图片和文字内容的拖拽数据。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L65-L111" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">buildUnifiedRecords</span>(<span class="hljs-variable">selection</span>: <span class="hljs-title class_">RichEditorSelection</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">selection</span>.<span class="hljs-variable">spans</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-variable">async</span> (<span class="hljs-variable">item</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeof</span> (<span class="hljs-variable">item</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorImageSpanResult</span>)[<span class="hljs-string">'imageStyle'</span>] != <span class="hljs-string">'undefined'</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">originImageUri</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getOriginImageUri</span>();</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">imageData</span>: <span class="hljs-title class_">uniformDataStruct</span>.<span class="hljs-title class_">FileUri</span> = {</li><li>          <span class="hljs-variable">uniformDataType</span>: <span class="hljs-string">'general.file-uri'</span>,</li><li>          <span class="hljs-variable">oriUri</span>: <span class="hljs-title class_">originImageUri</span>,</li><li>          <span class="hljs-variable">fileType</span>: <span class="hljs-string">'general.image'</span></li><li>        }</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">unifiedRecord</span> =</li><li>          <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedRecord</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>, <span class="hljs-variable">imageData</span>);</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">createdPixelMap</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getOriginPixelMap</span>();</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">createdPixelMap</span>) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">uniformDataStruct</span>.<span class="hljs-title class_">PixelMap</span> = {</li><li>            <span class="hljs-variable">uniformDataType</span>: <span class="hljs-string">'openharmony.pixel-map'</span>,</li><li>            <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">createdPixelMap</span>,</li><li>          }</li><li>          <span class="hljs-variable">unifiedRecord</span>.<span class="hljs-title function_">addEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">OPENHARMONY_PIXEL_MAP</span>, <span class="hljs-variable">pixelMap</span>);</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">unifiedData</span>.<span class="hljs-title function_">addRecord</span>(<span class="hljs-variable">unifiedRecord</span>);</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeof</span> (<span class="hljs-variable">item</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorTextSpanResult</span>)[<span class="hljs-string">'value'</span>] != <span class="hljs-string">'undefined'</span>) {</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">selectedText</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getSelectedText</span>(<span class="hljs-variable">item</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorTextSpanResult</span>);</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">textData</span>: <span class="hljs-title class_">uniformDataStruct</span>.<span class="hljs-title class_">PlainText</span> = {</li><li>            <span class="hljs-variable">uniformDataType</span>: <span class="hljs-string">'general.plain-text'</span>,</li><li>            <span class="hljs-variable">textContent</span>: <span class="hljs-title class_">selectedText</span></li><li>          }</li><li>          <span class="hljs-keyword">const</span> <span class="hljs-variable">unifiedRecord</span> =</li><li>            <span class="hljs-variable">new</span> <span class="hljs-variable">unifiedDataChannel</span>.<span class="hljs-title function_">UnifiedRecord</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>, <span class="hljs-variable">textData</span>);</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">unifiedData</span>.<span class="hljs-title function_">addRecord</span>(<span class="hljs-variable">unifiedRecord</span>);</li><li>        }</li><li>      }</li><li>    })</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L65-L111" target="_blank">MultiEntry.ets</a></div></div></div></div> </li><li>封装getOriginImageUri()函数，getOriginPixelMap()函数，和getSelectedText()函数。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L115-L127" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getOriginImageUri</span>(): <span class="hljs-title class_">string</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getRawFdSync</span>(<span class="hljs-string">'river.png'</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">filePath</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">filesDir</span> + <span class="hljs-string">'/river.png'</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">dest</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-variable">filePath</span>, <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">CREATE</span> | <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">bufferSize</span> = <span class="hljs-variable">data</span>.<span class="hljs-variable">length</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">buf</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">bufferSize</span>);</li><li>  <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">readSync</span>(<span class="hljs-variable">data</span>.<span class="hljs-variable">fd</span>, <span class="hljs-variable">buf</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-title class_">data</span>.<span class="hljs-title class_">offset</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">bufferSize</span> });</li><li>  <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">writeSync</span>(<span class="hljs-variable">dest</span>.<span class="hljs-variable">fd</span>, <span class="hljs-variable">buf</span>, { <span class="hljs-variable">offset</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">length</span>: <span class="hljs-title class_">bufferSize</span> });</li><li>  <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">close</span>(<span class="hljs-variable">dest</span>.<span class="hljs-variable">fd</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">closeRawFd</span>(<span class="hljs-string">'river.png'</span>);</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">originImageUri</span> = <span class="hljs-variable">fileUri</span>.<span class="hljs-title function_">getUriFromPath</span>(<span class="hljs-variable">filePath</span>);</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">originImageUri</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L115-L127" target="_blank">MultiEntry.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L131-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getOriginPixelMap</span>(): <span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">undefined</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">data</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>.<span class="hljs-variable">resourceManager</span>.<span class="hljs-title function_">getRawFileContentSync</span>(<span class="hljs-string">'river.png'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">arrayBuffer</span> = <span class="hljs-variable">data</span>.<span class="hljs-variable">buffer</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">arrayBuffer</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">value</span> = <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">getImageInfoSync</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">DecodingOptions</span> = {</li><li>      <span class="hljs-variable">editable</span>: <span class="hljs-keyword">true</span>,</li><li>      <span class="hljs-variable">desiredSize</span>: {</li><li>        <span class="hljs-variable">height</span>: <span class="hljs-title class_">value</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">height</span>,</li><li>        <span class="hljs-variable">width</span>: <span class="hljs-title class_">value</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">width</span></li><li>      }</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelMap</span> = <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMapSync</span>(<span class="hljs-variable">opts</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">pixelMap</span>;</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L131-L154" target="_blank">MultiEntry.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L158-L172" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getSelectedText</span>(<span class="hljs-attr">item</span>: <span class="hljs-title class_">RichEditorTextSpanResult</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">textStart</span>: <span class="hljs-built_in">number</span> = item.<span class="hljs-property">spanPosition</span>.<span class="hljs-property">spanRange</span>[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-attr">textEnd</span>: <span class="hljs-built_in">number</span> = item.<span class="hljs-property">spanPosition</span>.<span class="hljs-property">spanRange</span>[<span class="hljs-number">1</span>];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">textSelected</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-keyword">if</span> (textStart &gt;= <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedStartIndex</span>) {</li><li>    <span class="hljs-keyword">const</span> begin = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(textEnd, <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedEndIndex</span>) - textStart;</li><li>    textSelected = item.<span class="hljs-property">value</span>.<span class="hljs-title function_">substring</span>(begin, end);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">const</span> begin = <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedStartIndex</span> - textStart;</li><li>    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">selectedEndIndex</span>, textEnd) - textStart;</li><li>    textSelected = item.<span class="hljs-property">value</span>.<span class="hljs-title function_">substring</span>(begin, end);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> textSelected;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L158-L172" target="_blank">MultiEntry.ets</a></div></div></div></div> </li><li>在落入方<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-events-drag-drop#ondrop" target="_blank">onDrop()</a>回调里获取拖拽数据，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#getentry15" target="_blank">getEntry()</a>接口读取所需要格式的数据。<div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L318-L329" data-highlighted="yes"><ol class="linenums"><li>RichEditor({ controller: <span class="hljs-keyword">this</span>.targetController1 })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .allowDrop([uniformTypeDescriptor.UniformDataType.OPENHARMONY_PIXEL_MAP,</li><li>    uniformTypeDescriptor.UniformDataType.PLAIN_TEXT, uniformTypeDescriptor.UniformDataType.TEXT])</li><li>  .onDrop((<span class="hljs-keyword">event</span>: DragEvent) =&gt; {</li><li>    <span class="hljs-keyword">event</span>.setResult(<span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">this</span>.receiveDragData(<span class="hljs-keyword">event</span>, DROP_AREA.PIXELMAP_AREA);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L318-L329" target="_blank">MultiEntry.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L342-L358" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title class_">RichEditor</span>({ <span class="hljs-attr">controller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">targetController2</span> })</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">allowDrop</span>([uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">PLAIN_TEXT</span>, uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">TEXT</span>,</li><li>    uniformTypeDescriptor.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>])</li><li>  .<span class="hljs-title function_">onDrop</span>(<span class="hljs-function">(<span class="hljs-params">event: DragEvent</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      event.<span class="hljs-title function_">setResult</span>(<span class="hljs-number">0</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">receiveDragData</span>(event, <span class="hljs-variable constant_">DROP_AREA</span>.<span class="hljs-property">URI_AREA</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`startDataLoading errorCode: <span class="hljs-subst">${err.code}</span>, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L342-L358" target="_blank">MultiEntry.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-lgn-c106="" class="highlight-div"><div _ngcontent-lgn-c106="" class="highlight-div-header"><div _ngcontent-lgn-c106="" class="highlight-div-header-left"><div _ngcontent-lgn-c106="" class="handle-button expand-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-lgn-c106="" class="highlight-div-header-right"><div _ngcontent-lgn-c106="" class="handle-button ai-button"></div><div _ngcontent-lgn-c106="" class="handle-button line-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-lgn-c106="" class="handle-button theme-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-lgn-c106="" class="handle-button copy-button"><div _ngcontent-lgn-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-lgn-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L176-L254" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">receiveDragData</span>(<span class="hljs-variable">event</span>: <span class="hljs-title class_">DragEvent</span>, <span class="hljs-variable">area</span>: <span class="hljs-title class_">DROP_AREA</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">dragData</span>: <span class="hljs-title class_">UnifiedData</span> = (<span class="hljs-variable">event</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">DragEvent</span>).<span class="hljs-title function_">getData</span>() <span class="hljs-keyword">as</span> <span class="hljs-variable">UnifiedData</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">dragData</span> !== <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">records</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">unifiedDataChannel</span>.<span class="hljs-title class_">UnifiedRecord</span>&gt; = <span class="hljs-variable">dragData</span>.<span class="hljs-title function_">getRecords</span>();</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">records</span>.<span class="hljs-variable">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">records</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-variable">types</span> = <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getTypes</span>();</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-variable">area</span> === <span class="hljs-variable">DROP_AREA</span>.<span class="hljs-variable">URI_AREA</span>) {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>)) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">fileUriUds</span> =</li><li>                <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">FILE_URI</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">FileUri</span>;</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">typeDescriptor</span> = <span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-title function_">getTypeDescriptor</span>(<span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">fileType</span>);</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable">typeDescriptor</span>.<span class="hljs-title function_">belongsTo</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">IMAGE</span>)) {</li><li>                <span class="hljs-keyword">let</span> <span class="hljs-variable">targetImage</span> = <span class="hljs-variable">fileUriUds</span>.<span class="hljs-variable">oriUri</span>;</li><li>                <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController2</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">targetImage</span>,</li><li>                  {</li><li>                    <span class="hljs-variable">imageStyle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">imageStyle</span>,</li><li>                    <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController2</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>                  })</li><li>              }</li><li>              <span class="hljs-keyword">continue</span></li><li>            }</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>)) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">plainTextUds</span> =</li><li>                <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">PlainText</span>;</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController2</span>.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">plainTextUds</span>.<span class="hljs-variable">textContent</span>,</li><li>                {</li><li>                  <span class="hljs-variable">style</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">textStyle</span>,</li><li>                  <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController2</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>                })</li><li>              <span class="hljs-keyword">continue</span>;</li><li>            }</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">OPENHARMONY_PIXEL_MAP</span>)) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">pixelMapUds</span> =</li><li>                <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">OPENHARMONY_PIXEL_MAP</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">PixelMap</span>;</li><li>              <span class="hljs-keyword">let</span> <span class="hljs-variable">targetImage</span> = <span class="hljs-variable">pixelMapUds</span>.<span class="hljs-variable">pixelMap</span>;</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController1</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">targetImage</span>,</li><li>                {</li><li>                  <span class="hljs-variable">imageStyle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">imageStyle</span>,</li><li>                  <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController1</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>                })</li><li>              <span class="hljs-keyword">continue</span>;</li><li>            }</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">types</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>)) {</li><li>              <span class="hljs-keyword">const</span> <span class="hljs-variable">plainTextUds</span> =</li><li>                <span class="hljs-variable">records</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">getEntry</span>(<span class="hljs-variable">uniformTypeDescriptor</span>.<span class="hljs-variable">UniformDataType</span>.<span class="hljs-variable">PLAIN_TEXT</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">uniformDataStruct</span>.<span class="hljs-variable">PlainText</span>;</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">targetController1</span>.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-variable">plainTextUds</span>.<span class="hljs-variable">textContent</span>,</li><li>                {</li><li>                  <span class="hljs-variable">style</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">textStyle</span>,</li><li>                  <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">targetController1</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>                })</li><li>              <span class="hljs-keyword">continue</span>;</li><li>            }</li><li>          }</li><li>        }</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable">event</span>.<span class="hljs-title function_">setResult</span>(<span class="hljs-variable">DragResult</span>.<span class="hljs-variable">DRAG_SUCCESSFUL</span>);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/DragFramework/blob/master/entry/src/main/ets/pages/textandimage/MultiEntry.ets#L176-L254" target="_blank">MultiEntry.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section35671536195312">分屏拖拽<i class="anchor-icon anchor-icon-link" anchorid="section35671536195312" tips="复制节点链接"></i></h2><p>将拖拽框架与系统的分屏能力结合，可以将数据从一个分屏页面拖拽到另一个分屏页面，实现跨应用拖拽或同应用跨页面拖拽。</p> <p><strong>使用说明</strong></p> <p>需要应用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multi-window-support#section2205081316" target="_blank">声明支持分屏</a>，并根据需求自定义拖拽响应。</p> <p><strong>运行效果如下图所示</strong></p> <div class="fignone"><span class="figcap"><b>图9 </b>分屏拖拽</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163249.85706644403151613185466538979886:50001231000000:2800:B84F1817D71D6B96B4E11B3F1AE30496A51C4C27E46E957AE06C4FA656B12738.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h2 id="section15501112385010">跨设备拖拽<i class="anchor-icon anchor-icon-link" anchorid="section15501112385010" tips="复制节点链接"></i></h2><p>将拖拽框架与系统的键鼠穿越能力结合，可以接入跨设备拖拽，实现在平板或2in1类型的任意两台设备之间拖拽数据。</p> <p><strong>使用说明</strong></p> <p>需要满足跨设备拖拽开发指导中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/distributed-drag-guide#section17575828642" target="_blank">使用限制条件</a>，并根据需求自定义拖拽响应。</p> <p><strong>结果展示</strong></p> <div class="fignone"><span class="figcap"><b>图10 </b>跨设备拖拽效果展示</span><br><span><img height="396.606" originheight="1080" originwidth="2173" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163249.38308497887151408646762826144130:50001231000000:2800:28754FA89C1A781FDC53DA9B3E91F6087BC9764AD35EF83360EED44E4F273B60.gif" title="点击放大" width="798"></span></div> </div> <div class="tiledSection"><h2 id="section1289155519508">拖入小艺和中转站<i class="anchor-icon anchor-icon-link" anchorid="section1289155519508" tips="复制节点链接"></i></h2><p>将数据拖入系统的中转站，可以实现跨应用数据拖拽和跨设备数据流转。将数据拖入小艺，可以利用系统的AI能力处理拖拽数据。小艺和中转站支持落入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-unifieddatachannel#unifiedrecord" target="_blank">标准化数据通路</a>中定义的数据类型，开发者需要在起拖时构造相应的数据。</p> <p><strong>使用限制</strong></p> <p>应用本身预置的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-categories-and-access#资源组目录" target="_blank">资源文件</a>（即应用在安装前的HAP包中已经存在的资源文件）不支持拖入小艺和中转站。</p> <p><strong>运行效果如下图所示</strong></p> <div class="fignone"><span class="figcap"><b>图11 </b>将数据拖入小艺</span><br><span><img height="550.3673" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163249.70735391857603386012209596992101:50001231000000:2800:D48BEBD0224DB9B08DD17F2B731B4FBFA5594EBA9CB315FE33848C88B8FF5505.gif" title="点击放大" width="266"></span></div> <div class="fignone"><span class="figcap"><b>图12 </b>将数据拖入中转站</span><br><span><img height="549.3033" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163249.86249374359860103224662040217182:50001231000000:2800:D30D70E090C37777CC91F415A752C6278771788E33ACA429F03260A85E05125B.gif" title="点击放大" width="266"></span></div> </div> <div class="tiledSection"><h2 id="section78708544413">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section78708544413" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section81705271913" class="firsth2">模拟器无法识别AI拖拽内容<i class="anchor-icon anchor-icon-link" anchorid="section81705271913" tips="复制节点链接"></i></h3><p>模拟器不支持<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/core-vision-text-recognition" target="_blank">textRecognition</a>接口的调用，建议使用真机进行调试，详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/core-vision-text-recognition#section2020122517405" target="_blank">通用文字识别约束与限制</a>。</p> </div> <div class="tiledSection"><h3 id="section6583172511411">拖拽的触发手势长按浮起与长按手势之间存在冲突<i class="anchor-icon anchor-icon-link" anchorid="section6583172511411" tips="复制节点链接"></i></h3><p>若组件既需要处理长按手势，又需要支持可拖拽能力（拖拽的触发为长按500ms并移动10vp)，则可通过 parallelGesture 实现多个手势事件的处理，而不产生冲突。详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-gesture-settings" target="_blank">绑定手势方法</a>。</p> </div> <div class="tiledSection"><h3 id="section69266412414">拖出的PixelMap落入时与拖出端存在色差<i class="anchor-icon anchor-icon-link" anchorid="section69266412414" tips="复制节点链接"></i></h3><p>拖出PixelMap时，需要设置当前PixelMap的编码格式，否则落入方不能确定该PixelMap的编码方式，按照默认行为处理可能出现存在色差的情况。PixelMap的默认编码格式是BGRA_8888，若拖出方未指定PixelMap的编码格式，则落入方按照RGBA格式解码即可。若拖出方有指定了PixelMap的编码格式，则落入方可以通过systemDefinedPixelMap.details，details['pixel-format'] 获取拖出方的编码格式，再以该格式解码即可。</p> </div> <div class="tiledSection"><h3 id="section886119521643">图文混排数据拖拽落位后与原拖出方排版格式有差异<i class="anchor-icon anchor-icon-link" anchorid="section886119521643" tips="复制节点链接"></i></h3><p>当前拖拽数据中图文混排数据可通过HTML实现，但拖拽落入方组件可能并非HTML格式，如RichEditor、RichText等。当前系统能力对各类富文本数据的格式转换能力较弱，不能保证排版样式一致。图文混排拖拽建议使用多Entry适配方案，参见<a href="/consumer/cn/doc/best-practices/bpta-unified-drag-and-drop#section5352104013812">基于UDMF多Entry的图文混排拖拽</a>。</p> </div> <div class="tiledSection"><h3 id="section5254441516">文字无法长按选中后再起拖<i class="anchor-icon anchor-icon-link" anchorid="section5254441516" tips="复制节点链接"></i></h3><p>文字若要长按选中后再起拖，需要设置copyOptions属性，否则无法触发长按选中逻辑。</p> </div> <div class="tiledSection"><h3 id="section684416171512">拖拽到文字某些"输入框"后不响应拖拽<i class="anchor-icon anchor-icon-link" anchorid="section684416171512" tips="复制节点链接"></i></h3><p>因ArkUI默认支持落入的组件包括Search、TextInput、TextArea、Video，若应用实现时输入框使用的是Text组件实现，则默认不可响应拖拽事件。若要实现对拖拽事件的响应，则应主动设置allowDrop属性、调用onDrop接口实现落入。</p> </div> <div class="tiledSection"><h3 id="section1567625181513">拖拽到小艺后显示不支持处理此类数据<i class="anchor-icon anchor-icon-link" anchorid="section1567625181513" tips="复制节点链接"></i></h3><p>该问题通常是由于拖拽数据源设置不当导致的问题，如拖拽文件时文件的uri为非法参数，则在落位获取数据时，UDMF不能正常读取数据，导致落位失败。在拖拽发起时候应正确设置拖拽数据，避免拖拽数据为空或拖拽数据非法，如无效uri等情况。</p> </div> <div class="tiledSection"><h3 id="section4171171861611">拖入区域显示绿色角标仍落位失败<i class="anchor-icon anchor-icon-link" anchorid="section4171171861611" tips="复制节点链接"></i></h3><p>显示绿色角标是因为落入方组件在allowDrop列表中刚设置了当前拖拽数据类型，标识支持该类数据的落入。但是具体是否能够成功落位取决于落入组件在onDrop逻辑中是否正确处理了拖拽数据，如未对数据做处理并刷新UI、读取数据失败等情况都有可能导致落位失败。落入方应用需明确在onDrop回调中是否对当前拖拽数据做处理并刷新UI，排查当前拖拽数据是否非法，如无效uri、无效在线地址等情况。</p> </div> <div class="tiledSection"><h2 id="section16109175091116">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section16109175091116" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/DragFramework" target="_blank">拖拽框架开发实践</a></li></ul> </div> </div> <div></div></div>