<h1 _ngcontent-toi-c119="" class="doc-title ng-star-inserted" title="网络信息查询与连接管理"> 网络信息查询与连接管理 </h1>

<div _ngcontent-toi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section5744202719320">概述<i class="anchor-icon anchor-icon-link" anchorid="section5744202719320" tips="复制节点链接"></i></h2><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/network-api" target="_blank">Network Kit</a>提供常用的网络信息查询与连接管理功能，包括获取网络类型、检查网络可用性、监听网络状态变化、查询Wi-Fi及蜂窝网络信息等。这些能力帮助开发者灵活应对复杂多变的网络环境，精准实现各类场景需求，显著提升用户的网络使用体验。</p> </div> <div class="tiledSection"><h2 id="section566113443416">连接到指定网络场景<i class="anchor-icon anchor-icon-link" anchorid="section566113443416" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section20401254102016" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section20401254102016" tips="复制节点链接"></i></h3><p>在特定业务场景中（如企业或校园内网），应用必须通过指定的网络连接到专用服务器以获取关键数据。若连接指定网络失败，将直接导致网络配置中断、身份认证受阻或核心资源无法访问，从而中断业务流程。</p> <p>本章将通过以下示例，介绍如何连接到指定的Wi-Fi。该示例具备以下功能：</p> <ul><li>判断设备是否已连接到指定的Wi-Fi</li><li>获取系统扫描的Wi-Fi列表</li><li>通过点击Wi-Fi列表连接到相应的Wi-Fi</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>连接到指定网络效果图</span><p><span><img height="553.5194" originheight="1080" originwidth="519" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.36076427549521812826821981085765:50001231000000:2800:EA7E3A558D9E44B307814576EBF2AA81C55BF66EB5B7C4E5C586D5017849CC02.gif" title="点击放大" width="266"></span></p> </div> </div> <div class="tiledSection"><h3 id="section19755162015216">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section19755162015216" tips="复制节点链接"></i></h3><p>连接到指定Wi-Fi场景主要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager" target="_blank">@ohos.wifiManager (WLAN)</a>模块结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection" target="_blank">@ohos.net.connection (网络连接管理)</a>模块相关API来实现。通过@ohos.wifiManager模块检查Wi-Fi是否启用，获取系统扫描的Wi-Fi列表，选中指定Wi-Fi后发起连接请求；通过@ohos.net.connection模块检测网络连通性，判断是否需要进行登录认证（如 Portal 认证）才能正常访问网络。流程图如下：</p> <p><span><img height="529.0341" originheight="742" originwidth="485" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.83990558736438669577826543986779:50001231000000:2800:D9B2707A87BB39588471C4A156324CB60D001464F6EEFCE0E800DE1111F01C63.png" title="点击放大" width="345.8"></span></p> </div> <div class="tiledSection"><h3 id="section12925522112114">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section12925522112114" tips="复制节点链接"></i></h3><ol><li>网络权限声明<p>在进行网络相关操作前，需在应用的module.json5配置文件中声明所需权限。涉及的权限包括：</p> <ul><li>ohos.permission.GET_NETWORK_INFO：用于获取网络信息，如默认网络、网络类型等。</li></ul> <ul><li>ohos.permission.GET_WIFI_INFO：用于获取Wi-Fi相关信息，如Wi-Fi是否打开、Wi-Fi列表等。</li></ul> <ul><li>ohos.permission.SET_WIFI_INFO：用于执行Wi-Fi连接操作。</li><li>ohos.permission.INTERNET：用于访问Internet网络。</li></ul> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/module.json5#L2-L134" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.INTERNET"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.GET_NETWORK_INFO"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.SET_WIFI_INFO"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.GET_WIFI_INFO"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      <span class="hljs-comment">// ...</span></li><li>    ]</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/module.json5#L2-L134" target="_blank">module.json5</a></div></div></div></div> </li><li>获取Wi-Fi信息，判断是否连接到指定Wi-Fi<p>先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetdefaultnetsync9" target="_blank">getDefaultNetSync()</a>接口判断默认网络是否连接，并通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetnetcapabilitiessync10" target="_blank">getNetCapabilitiesSync()</a>方法获取默认连接网络类型。若网络类型为Wi-Fi，则使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagergetlinkedinfosync18" target="_blank">getLinkedInfoSync()</a>方法获取当前连接的Wi-Fi信息，该信息包含SSID等内容。将获取到的SSID与指定Wi-Fi的SSID进行比对，若一致则表示已连接到指定Wi-Fi。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L50-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">checkNetwork</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Use the synchronization method to obtain the default activated data network handle (default network)</span></li><li>    <span class="hljs-keyword">let</span> netHandle = connection.<span class="hljs-title function_">getDefaultNetSync</span>();</li><li>    <span class="hljs-keyword">if</span> (netHandle.<span class="hljs-property">netId</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// If there is no network connected, the netid of the obtained netHandler is 0</span></li><li>      <span class="hljs-title function_">showToast</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, $r(<span class="hljs-string">'app.string.no_network_tips'</span>));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Obtain the capability information of the network corresponding to the netHandle</span></li><li>    <span class="hljs-keyword">let</span> netCapability = connection.<span class="hljs-title function_">getNetCapabilitiesSync</span>(netHandle);</li><li>    <span class="hljs-keyword">let</span> networkCap = netCapability.<span class="hljs-property">networkCap</span> || [];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">bearerTypes</span>: connection.<span class="hljs-property">NetBearType</span>[] = netCapability.<span class="hljs-property">bearerTypes</span>;</li><li>    <span class="hljs-keyword">let</span> isWifi = bearerTypes.<span class="hljs-title function_">includes</span>(connection.<span class="hljs-property">NetBearType</span>.<span class="hljs-property">BEARER_WIFI</span>);</li><li>    <span class="hljs-keyword">if</span> (!isWifi) {</li><li>      <span class="hljs-title function_">showToast</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, $r(<span class="hljs-string">'app.string.network_is_not_wifi'</span>));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// The network type is WIFI to get network connection information</span></li><li>    <span class="hljs-keyword">let</span> linkedInfo = wifiManager.<span class="hljs-title function_">getLinkedInfoSync</span>();</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">ssid</span>: <span class="hljs-built_in">string</span> = linkedInfo.<span class="hljs-property">ssid</span>;</li><li>    <span class="hljs-keyword">if</span> (ssid === <span class="hljs-variable constant_">TARGET_WIFI_SSID</span>) {</li><li>      <span class="hljs-comment">// Connected to the target wifi</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-title function_">showToast</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, $r(<span class="hljs-string">'app.string.not_connected_spec_wifi'</span>));</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`checkNetwork err, code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L50-L92" target="_blank">WifiConnector.ets</a></div></div></div></div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetnetcapabilitiessync10" target="_blank">getNetCapabilitiesSync()</a>方法获取网络能力信息对象，其networkCap属性包含网络的具体能力。若networkCap中包含connection.NetCap.NET_CAPABILITY_VALIDATED，则表示网络具备访问互联网的能力（即网络可用）；若networkCap中包含connection.NetCap.NET_CAPABILITY_PORTAL，则说明网络需要认证登录之后才能正常使用。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L72-L86" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (ssid === TARGET_WIFI_SSID) {</li><li>  <span class="hljs-comment">// Connected to the target wifi</span></li><li>  <span class="hljs-keyword">if</span> (networkCap.includes(connection.NetCap.NET_CAPABILITY_VALIDATED)) {</li><li>    showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.connected_to_spec_wifi'</span>));</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (networkCap.includes(connection.NetCap.NET_CAPABILITY_PORTAL)) {</li><li>    <span class="hljs-comment">// Login verification is required for the current network</span></li><li>    showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.network_need_auth'</span>));</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.result_network_unavailable'</span>));</li><li>  }</li><li>} <span class="hljs-keyword">else</span> {</li><li>  showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.not_connected_spec_wifi'</span>));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L72-L86" target="_blank">WifiConnector.ets</a></div></div></div></div> </li><li>获取系统扫描Wi-Fi列表<p>在获取Wi-Fi列表之前，需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanageriswifiactive9" target="_blank">isWifiActive()</a>方法判断Wi-Fi开关是否已打开。如果已打开，则通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagergetscaninfolist10" target="_blank">getScanInfoList()</a>方法获取系统扫描附近的Wi-Fi网络，并返回一个包含所有扫描到的Wi-Fi信息的数组。数组中的每个元素包含了Wi-Fi的SSID、加密类型、信号强度等详细信息。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L131-L149" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getScanList</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> isWifiActive = wifiManager.<span class="hljs-title function_">isWifiActive</span>();</li><li>    <span class="hljs-keyword">if</span> (!isWifiActive) {</li><li>      <span class="hljs-title function_">showToast</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">uiContext</span>, $r(<span class="hljs-string">'app.string.turn_on_wlan_tips'</span>));</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLinkedInfo</span>();</li><li>    <span class="hljs-keyword">let</span> temp = wifiManager.<span class="hljs-title function_">getScanInfoList</span>();</li><li>    <span class="hljs-keyword">if</span> (temp.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// Remove duplicate WiFi data</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">scanInfoList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">uniqueBySsid</span>(temp);</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getScanList length: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.scanInfoList.length}</span>`</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getScanList err, code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WifiConnector.ets#L131-L149" target="_blank">WifiConnector.ets</a></div></div></div></div> </li><li>连接到指定Wi-Fi<p>首先，创建一个包含要连接的Wi-Fi的SSID、密码及安全类型（如WPA2_PSK）等信息的Wi-Fi配置对象，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanageraddcandidateconfig9" target="_blank">addCandidateConfig()</a>方法，传入该配置对象以添加候选网络配置。然后，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagerconnecttocandidateconfig9" target="_blank">connectToCandidateConfig()</a>方法发起连接请求。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/component/WlanItem.ets#L30-L47" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">connectWifi</span>() {</li><li>  <span class="hljs-comment">// Add a candidate network</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">config</span>: <span class="hljs-title class_">wifiManager</span>.<span class="hljs-title class_">WifiDeviceConfig</span> = {</li><li>    <span class="hljs-variable">ssid</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ssid</span>,</li><li>    <span class="hljs-variable">preSharedKey</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">wifiPassword</span>,</li><li>    <span class="hljs-variable">securityType</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">securityType</span></li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">wifiManager</span>.<span class="hljs-title function_">addCandidateConfig</span>(<span class="hljs-variable">config</span>).<span class="hljs-title function_">then</span>(<span class="hljs-variable">result</span> =&gt; {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">addCandidateConfig</span> <span class="hljs-variable">success</span>, <span class="hljs-variable">networkId</span>: ${<span class="hljs-variable">result</span>}`);</li><li>      <span class="hljs-comment">// Connect to a certain wifi</span></li><li>      <span class="hljs-variable">wifiManager</span>.<span class="hljs-title function_">connectToCandidateConfig</span>(<span class="hljs-variable">result</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">connectWifi</span> <span class="hljs-variable">error</span>: ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/component/WlanItem.ets#L30-L47" target="_blank">WlanItem.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section0386613459">网络状态感知场景<i class="anchor-icon anchor-icon-link" anchorid="section0386613459" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section95631239132219" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section95631239132219" tips="复制节点链接"></i></h3><p>本章以网络视频播放场景为例，围绕网络状态感知展开，介绍如何在监听到网络状态变化后，动态调整视频播放行为，以优化播放体验。本章实现的网络视频播放优化体验如下：</p> <ul><li>当网络从Wi-Fi切换到蜂窝网络，及时暂停播放，并提醒用户已切换到蜂窝网络，以避免产生流量费用。</li><li>当网络从蜂窝切换到的Wi-Fi时，自动播放之前暂停的视频，让用户无需手动操作即可继续观看。</li></ul> <ul><li>当监听到弱网状态时，提示用户当前网络不佳。同时，系统可能会根据当前的网络质量情况切换网络。</li></ul> <ul><li>当监听到网络中断时，提示用户检查网络连接，以避免视频突然中断带来的不良体验。</li></ul> </div> <div class="tiledSection"><h3 id="section9563739102212">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section9563739102212" tips="复制节点链接"></i></h3><p>网络状态感知的实现方案以实时监测网络状态变化并联动视频播放业务的调整为核心，主要依赖于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection" target="_blank">@ohos.net.connection（网络连接管理）</a>模块和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality" target="_blank">netQuality（网络质量）</a>模块来实现。本章重点介绍网络视频播放时对网络状态变化的感知，视频播放的具体实现可参考<a href="/consumer/cn/doc/best-practices/bpta-common-network-query#section14109114818615">示例代码</a>章节。为避免网络波动影响播放流畅性，建议开发者进行缓存处理。</p> <p>网络状态的监听主要通过以下接口实现：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetcapabilitieschange" target="_blank">on('netCapabilitiesChange')</a>：订阅网络能力变化事件，当网络类型切换（如从Wi-Fi切换到蜂窝网络）、网络状态从无到有等，该事件将被触发。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetlost" target="_blank">on('netLost')</a>：订阅网络丢失事件，当网络严重中断或正常断开时触发该事件。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetunavailable" target="_blank">on('netUnavailable')</a>：订阅网络不可用事件，当网络不可用时触发该事件。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetavailable" target="_blank">on('netAvailable')</a>：订阅网络可用事件，当网络可用时触发该事件。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality#section132431252185419" target="_blank">netQuality.on( 'netSceneChange')</a>：订阅网络场景信息，如从正常网络进入到弱网环境。</li></ul> <p>以视频播放场景为例，网络状态感知体验如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><tbody><tr><td class="cellrowborder" rowspan="2" valign="top"><p>网络状态感知</p> </td> <td align="center" class="cellrowborder" colspan="2" valign="top"><p>网络类型变化</p> </td> <td align="center" class="cellrowborder" colspan="4" valign="top"><p>网络能力变化</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>Wi-Fi切蜂窝</p> </td> <td class="cellrowborder" valign="top"><p>蜂窝切换Wi-Fi</p> </td> <td class="cellrowborder" valign="top"><p>弱网场景</p> </td> <td class="cellrowborder" valign="top"><p>网络断开</p> </td> <td class="cellrowborder" valign="top"><p>网络不可用</p> </td> <td class="cellrowborder" valign="top"><p>网络可用</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="11.41%"><p>应用处理</p> </td> <td class="cellrowborder" valign="top" width="12.1%"><p>暂停播放，提示将使用流量播放</p> </td> <td class="cellrowborder" valign="top" width="11.709999999999999%"><p>正常播放</p> </td> <td class="cellrowborder" valign="top" width="18.39%"><p>弹窗提示网络不佳。（开发者可以提供切换视频清晰度播放的功能，在弱网场景下提示用户切换清晰度。）</p> </td> <td class="cellrowborder" valign="top" width="15.260000000000002%"><p>弹窗提示网络已断开，视频加载失败后展示错误页面</p> </td> <td class="cellrowborder" valign="top" width="18.23%"><p>弹窗提示网络不可用，视频加载失败后展示错误页面</p> </td> <td class="cellrowborder" valign="top" width="12.9%"><p>和网络类型变化规格一致</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section4563113910221">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section4563113910221" tips="复制节点链接"></i></h3><ol><li>订阅网络可用/不可用事件<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetavailable" target="_blank">on('netAvailable')</a>订阅网络可用事件通知，接收到网络可用通知时，检测当前网络是否具备访问Internet的能力。若网络能正常访问Internet且此前因网络问题导致播放失败，则重置播放器并继续播放视频。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L18-L18" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { connection } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkKit'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L18-L18" target="_blank">NetworkMonitor.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L78-L88" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create a NetConnection object</span></li><li><span class="hljs-keyword">this</span>.netCon = connection.createNetConnection();</li><li><span class="hljs-comment">// Subscribe to a network available event that triggers when the network is available</span></li><li><span class="hljs-keyword">this</span>.netCon.on(<span class="hljs-string">'netAvailable'</span>, (<span class="hljs-keyword">data</span>: connection.NetHandle) =&gt; {</li><li>  Logger.info(TAG, `on netAvailable, Succeeded to <span class="hljs-keyword">get</span> netAvailable: ${JSON.stringify(<span class="hljs-keyword">data</span>)}`);</li><li>  <span class="hljs-keyword">this</span>.isNetAvailable = NetworkUtil.isNetworkAvailable();</li><li>  <span class="hljs-keyword">this</span>.isCellular = NetworkUtil.isCellular();</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNetAvailable &amp;&amp; <span class="hljs-keyword">this</span>.isPlayError &amp;&amp; !<span class="hljs-keyword">this</span>.isCellular) {</li><li>    <span class="hljs-keyword">this</span>.controller.reset();</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L78-L88" target="_blank">NetworkMonitor.ets</a></div></div></div></div> <div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">isNetworkAvailable</span>(): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> netHandle = connection.<span class="hljs-title function_">getDefaultNetSync</span>();</li><li>    <span class="hljs-keyword">if</span> (netHandle.<span class="hljs-property">netId</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// If there is no network connected, the netid of the obtained netHandler is 0</span></li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> netCapability = connection.<span class="hljs-title function_">getNetCapabilitiesSync</span>(netHandle);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">networkCaps</span>: connection.<span class="hljs-property">NetCap</span>[] = netCapability.<span class="hljs-property">networkCap</span> || [];</li><li>    <span class="hljs-keyword">return</span> networkCaps.<span class="hljs-title function_">includes</span>(connection.<span class="hljs-property">NetCap</span>.<span class="hljs-property">NET_CAPABILITY_VALIDATED</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getNetworkType err, errCode: <span class="hljs-subst">${error.code}</span>, error mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetunavailable" target="_blank">on('netUnavailable')</a>订阅网络不可用事件通知，接收到网络不可用事件时，使用Toast弹窗提示用户网络不可用。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L92-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Subscribe to a network unavailability event that triggers when the network is unavailable</span></li><li><span class="hljs-keyword">this</span>.netCon.on(<span class="hljs-string">'netUnavailable'</span>, () =&gt; {</li><li>  Logger.info(TAG, <span class="hljs-string">'on netUnavailable, Succeeded to get unavailable net event'</span>);</li><li>  <span class="hljs-keyword">this</span>.isNetAvailable = <span class="hljs-literal">false</span>;</li><li>  showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.result_network_unavailable'</span>));</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L92-L97" target="_blank">NetworkMonitor.ets</a></div></div></div></div> </li><li>订阅网络能力变化事件<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetcapabilitieschange" target="_blank">on('netCapabilitiesChange')</a>方法可以订阅Wi-Fi和蜂窝网络切换的事件通知，当网络切换为蜂窝时暂停播放，否则继续播放视频。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L101-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Subscribe to network capability change events that trigger when network capability changes,</span></li><li><span class="hljs-comment">// such as from no network to network with network, or when switching from WIFI to cellular</span></li><li><span class="hljs-keyword">this</span>.netCon.on(<span class="hljs-string">'netCapabilitiesChange'</span>, (<span class="hljs-keyword">data</span>: connection.NetCapabilityInfo) =&gt; {</li><li>  Logger.info(TAG, `on netCapabilitiesChange, Succeeded to <span class="hljs-keyword">get</span> netCapabilitiesChange: ${JSON.stringify(<span class="hljs-keyword">data</span>)}`);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.netCap.bearerTypes.includes(connection.NetBearType.BEARER_CELLULAR)) {</li><li>    <span class="hljs-comment">// For cellular networks, pause playback</span></li><li>    <span class="hljs-keyword">this</span>.isCellular = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.isShowController = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.controller.pause();</li><li>    showToast(<span class="hljs-keyword">this</span>.getUIContext(), $r(<span class="hljs-string">'app.string.current_cellular_tips'</span>))</li><li>    <span class="hljs-keyword">this</span>.isShowGoOn = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.isCellular = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.isShowController = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.controller.start();</li><li>    <span class="hljs-keyword">this</span>.isShowGoOn = <span class="hljs-literal">false</span>;</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L101-L118" target="_blank">NetworkMonitor.ets</a></div></div></div></div> <p>从Wi-Fi切换为蜂窝网络效果图如下：</p> <p><span><img height="550.2343" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.25436604912314236721012770648116:50001231000000:2800:5ED18549D119A3BBC0C3105E1072CD31E10AB1C0350C239F9816B90C22A0BD6F.png" title="点击放大" width="266"></span></p> </li><li>订阅网络丢失事件<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#onnetlost" target="_blank">on('netLost')</a>方法可以订阅网络丢失的事件通知，使用Toast提示用户网络已断开。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L131-L138" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Subscribe to a network loss event, triggered when the network is severely interrupted or normally disconnected,</span></li><li><span class="hljs-comment">// and the network interruption pauses playback</span></li><li><span class="hljs-keyword">this</span>.netCon.on(<span class="hljs-string">'netLost'</span>, (<span class="hljs-keyword">data</span>: connection.NetHandle) =&gt; {</li><li>  Logger.info(TAG, `on netLost, Succeeded to <span class="hljs-keyword">get</span> netLost: ${JSON.stringify(<span class="hljs-keyword">data</span>)}`);</li><li>  <span class="hljs-keyword">this</span>.isNetAvailable = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">this</span>.isCellular = <span class="hljs-literal">false</span>;</li><li>  showToast(<span class="hljs-keyword">this</span>.uiContext, $r(<span class="hljs-string">'app.string.network_disconnect_tips'</span>));</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L131-L138" target="_blank">NetworkMonitor.ets</a></div></div></div></div> <p>网络断开时效果图：</p> <p><span><img height="550.2343" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.54649523928109688558953146119956:50001231000000:2800:C701C31CCFE7255E8535D00F834ACBF6F37C7B2901C06DA24E75B81DA9580137.png" title="点击放大" width="266"></span></p> <p>当网络断开时，将继续播放视频缓存；缓存播放完毕后，将触发Video组件的onError方法。若此时网络仍未连接，需提示用户检查网络。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L163-L199" data-highlighted="yes"><ol class="linenums"><li>Video({ src: <span class="hljs-keyword">this</span>.videoUrl, controller: <span class="hljs-keyword">this</span>.controller })</li><li><span class="hljs-comment">// ...</span></li><li>  .onError(() =&gt; {</li><li>    Logger.error(TAG, <span class="hljs-string">'Video onError'</span>);</li><li>    <span class="hljs-keyword">this</span>.lastTime = <span class="hljs-keyword">this</span>.currentTime;</li><li>    <span class="hljs-keyword">this</span>.isShowController = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.isPlayError = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.isPlaying = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.isNetAvailable = NetworkUtil.isNetworkAvailable();</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L163-L199" target="_blank">NetworkMonitor.ets</a></div></div></div></div> <p>播放错误时效果图</p> <p><span><img height="550.2343" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.54244378758908363139248234256692:50001231000000:2800:3EA9B9AE5BBCCF9B14C031BB1D1699A137496D22EEDBFB4361ECFA3E9C835C3C.png" title="点击放大" width="266"></span></p> </li><li>订阅网络状态变化通知<p>接下来需要调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#register" target="_blank">register()</a>接口，用来订阅指定的网络状态变化通知，该接口需在on()方法调用之后使用。例如，若指定的网络可用，将触发on('netAvailable')、on('netCapabilitiesChange')回调；若超时时间内网络不可用，将触发on('netUnavailable')回调。若断网，将触发on('netLost')回调。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L133-L137" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">netCon</span>.<span class="hljs-title function_">register</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`networkListen fail: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L133-L137" target="_blank">NetworkMonitor.ets</a></div></div></div></div> </li><li>订阅网络场景变化<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality#section132431252185419" target="_blank">netQuality.on('netSceneChange')</a>方法订阅网络场景变化通知，当网络为弱信号场景（weakSignal）或者拥塞场景（congestion）时，使用Toast弹窗提示用户当前网络不佳。建议开发者实现多种不同清晰度资源切换的功能，在此场景下，提示用户切换清晰度。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L21-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { netQuality } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.NetworkBoostKit'</span>;</li><li>  <span class="hljs-title function_">onNetSceneChange</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// Subscribe to network scene information</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      netQuality.<span class="hljs-title function_">on</span>(<span class="hljs-string">'netSceneChange'</span>, <span class="hljs-function">(<span class="hljs-params">list: netQuality.NetworkScene[]</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`on netSceneChange, Succeeded receive netSceneChange info: <span class="hljs-subst">${list.length}</span>`</span>);</li><li>        <span class="hljs-keyword">if</span> (list.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>          list.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">networkScene</span>) =&gt;</span> {</li><li>            <span class="hljs-keyword">if</span> (networkScene.<span class="hljs-property">scene</span> === <span class="hljs-string">'weakSignal'</span> || networkScene.<span class="hljs-property">scene</span> === <span class="hljs-string">'congestion'</span>) {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>.<span class="hljs-title function_">showToast</span>({ <span class="hljs-attr">message</span>: $r(<span class="hljs-string">'app.string.network_bad_tips'</span>) });</li><li>            }</li><li>          });</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`on netSceneChange err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L21-L73" target="_blank">NetworkMonitor.ets</a></div></div></div></div> </li><li>取消订阅网络变化/取消订阅场景变化通知<p>在退出页面时，通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#unregister" target="_blank">unregister()</a>取消订阅网络状态变化通知，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality#section32441952155417" target="_blank">netQuality.off('netSceneChange')</a>取消订阅场景变化。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L142-L156" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-comment">// Unsubscribe from network status changes</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">netCon</span>?.<span class="hljs-title function_">unregister</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`unregister failed, err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>    }</li><li>  });</li><li>  <span class="hljs-comment">// Unsubscribe from network scenario information</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    netQuality.<span class="hljs-title function_">off</span>(<span class="hljs-string">'netSceneChange'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`off netSceneChange err: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkMonitor.ets#L142-L156" target="_blank">NetworkMonitor.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1396311401557">获取Wi-Fi信息<i class="anchor-icon anchor-icon-link" anchorid="section1396311401557" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section86971144172216" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section86971144172216" tips="复制节点链接"></i></h3><p>在公司考勤中，有些企业使用基于WLAN定位的网络打卡方式。员工需连接公司指定Wi-Fi，应用获取Wi-Fi的MAC地址后方可打卡。本章将介绍如何获取该MAC地址。</p> <div class="fignone"><span class="figcap"><b>图2 </b>获取Wi-Fi MAC地址效果图</span></div> <p><span><img height="553.5194" originheight="1080" originwidth="519" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163026.51850480017949232212117721016731:50001231000000:2800:49C52E6845450FB83DE8DCE5C51D19CA6085445637F8BC94D79DC8D26F6A268E.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section469724472212">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section469724472212" tips="复制节点链接"></i></h3><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager" target="_blank">@ohos.geoLocationManager (位置服务)</a>模块的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetcurrentwifibssidforlocating14" target="_blank">getCurrentWifiBssidForLocating()</a>方法获取当前连接的Wi-Fi MAC地址（Bssid）。通过将获取的MAC地址与业务服务端保存的Wi-Fi MAC地址进行比对，判断打卡是否成功。关于业务服务端的实现逻辑需要开发者自己实现，本文不做介绍。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>需要注意的是，虽然@ohos.wifiManager的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagergetlinkedinfo9" target="_blank">getLinkedInfo()</a>也能获取当前连接Wi-Fi的MAC地址（Bssid），但需要申请ohos.permission.GET_WIFI_PEERS_MAC权限（仅系统应用可申请）才能返回真实地址，否则为随机地址，因此不推荐用于Wi-Fi打卡和其他需要真实MAC地址的场景。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section269719449224">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section269719449224" tips="复制节点链接"></i></h3><ol><li>检查WLAN连接状态<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanageriswifiactive9" target="_blank">wifiManager.isWifiActive()</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagerisconnected9" target="_blank">wifiManager.isConnected()</a>分别获取WLAN开关的状态和连接状态，确保已经连接了Wi-Fi网络。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L24-L91" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { wifiManager } from <span class="hljs-string">'@kit.ConnectivityKit'</span>;</li><li>  isWiFiConnected(): boolean {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">if</span> (!wifiManager.isWifiActive()) {</li><li>        showToast(<span class="hljs-keyword">this</span>.getUIContext(), $r(<span class="hljs-string">'app.string.turn_on_wlan_tips'</span>));</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">if</span> (wifiManager.isConnected()) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        showToast(<span class="hljs-keyword">this</span>.getUIContext(), $r(<span class="hljs-string">'app.string.wifi_not_connect_tips'</span>));</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `checkWifiStatus err, errCode: ${error.code}, error mesage: ${error.message}`);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L24-L91" target="_blank">WlanLocation.ets</a></div></div></div></div> </li><li>申请位置信息权限<p>获取当前连接Wi-Fi的MAC地址（Bssid）需要申请位置权限ohos.permission.LOCATION和ohos.permission.APPROXIMATELY_LOCATION，首先在module.json5中申明位置权限。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/module.json5#L3-L135" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      <span class="hljs-comment">// ...</span></li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.LOCATION"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      },</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.APPROXIMATELY_LOCATION"</span>,</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/module.json5#L3-L135" target="_blank">module.json5</a></div></div></div></div> <p>动态申请位置权限。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L17-L69" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { abilityAccessCtrl, bundleManager, <span class="hljs-title class_">Permissions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">requestPermissions</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">number</span>&gt; {</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">const</span> <span class="hljs-attr">permissions</span>: <span class="hljs-title class_">Permissions</span>[] = [<span class="hljs-string">'ohos.permission.LOCATION'</span>, <span class="hljs-string">'ohos.permission.APPROXIMATELY_LOCATION'</span>];</li><li>        <span class="hljs-keyword">const</span> accessManager = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>        <span class="hljs-keyword">const</span> bundleFlags = bundleManager.<span class="hljs-property">BundleFlag</span>.<span class="hljs-property">GET_BUNDLE_INFO_WITH_APPLICATION</span>;</li><li>        <span class="hljs-keyword">const</span> bundleInfo = bundleManager.<span class="hljs-title function_">getBundleInfoForSelfSync</span>(bundleFlags);</li><li>        <span class="hljs-keyword">const</span> grantStatus = accessManager.<span class="hljs-title function_">checkAccessTokenSync</span>(bundleInfo.<span class="hljs-property">appInfo</span>.<span class="hljs-property">accessTokenId</span>, permissions[<span class="hljs-number">0</span>]);</li><li>        <span class="hljs-keyword">if</span> (grantStatus === abilityAccessCtrl.<span class="hljs-property">GrantStatus</span>.<span class="hljs-property">PERMISSION_GRANTED</span>) {</li><li>          <span class="hljs-title function_">resolve</span>(<span class="hljs-number">0</span>);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        accessManager.<span class="hljs-title function_">requestPermissionsFromUser</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>(), permissions).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`request permissions result: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">grantStatus</span>: <span class="hljs-built_in">number</span>[] = data.<span class="hljs-property">authResults</span>;</li><li>          <span class="hljs-keyword">if</span> (grantStatus.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; grantStatus[<span class="hljs-number">0</span>] === <span class="hljs-number">0</span>) {</li><li>            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'request permissions granted'</span>);</li><li>            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">0</span>);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'request permissions denied'</span>);</li><li>            <span class="hljs-title function_">showToast</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>(), $r(<span class="hljs-string">'app.string.no_location_permission_tips'</span>));</li><li>            <span class="hljs-title function_">resolve</span>(-<span class="hljs-number">1</span>);</li><li>          }</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`request permissions exception, Catch error:<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>          <span class="hljs-title function_">reject</span>(error);</li><li>        })</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`requestPermissions err, errCode: <span class="hljs-subst">${error.code}</span>, error mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      }</li><li>    });</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L17-L69" target="_blank">WlanLocation.ets</a></div></div></div></div> </li><li>获取连接Wi-Fi的MAC地址<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-geolocationmanager#geolocationmanagergetcurrentwifibssidforlocating14" target="_blank">geoLocationManager.getCurrentWifiBssidForLocating()</a>方法获取Wi-Fi的MAC地址。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L21-L110" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { geoLocationManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LocationKit'</span>;</li><li>  <span class="hljs-title function_">getWiFiBssid</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isWiFiConnected</span>()) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">requestPermissions</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> {</li><li>        <span class="hljs-keyword">if</span> (result === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'request location permissions success'</span>);</li><li>          <span class="hljs-keyword">try</span> {</li><li>            <span class="hljs-keyword">let</span> <span class="hljs-attr">bssid</span>: <span class="hljs-built_in">string</span> = geoLocationManager.<span class="hljs-title function_">getCurrentWifiBssidForLocating</span>();</li><li>            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getCurrentWifiBssidForLocating wifi bssid success: <span class="hljs-subst">${bssid}</span>`</span>);</li><li>            <span class="hljs-variable language_">this</span>.<span class="hljs-property">macAddress</span> = bssid;</li><li>          } <span class="hljs-keyword">catch</span> (error) {</li><li>            <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getCurrentWifiBssidForLocatingerror: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>          }</li><li>        }</li><li>      });</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/WlanLocation.ets#L21-L110" target="_blank">WlanLocation.ets</a></div></div></div></div> </li></ol> <p></p> </div> <div class="tiledSection"><h2 id="section181131491167">网络故障诊断分析场景<i class="anchor-icon anchor-icon-link" anchorid="section181131491167" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section48811646182215" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section48811646182215" tips="复制节点链接"></i></h3><p>用户在使用应用的网络功能时，网络故障（如无法访问、加载缓慢、连接中断）是常见的问题。为了方便定位问题，需要获取路由、网络类型、代理、DNS、网关、运营商及信号强度、时延等信息。通过分析这些数据，可以判断问题出在设备、运营商还是服务器，从而采取相应措施恢复网络和应用的正常运行。</p> <p>本章将介绍一些常见网络信息的获取，主要包含以下信息：</p> <ul><li>网络类型</li><li>网络代理信息</li><li>路由信息</li><li>当前网络的IP地址</li><li>当前网络的DNS服务器</li><li>当前Wi-Fi信号强度</li><li>当前设备Wi-Fi MAC地址</li><li>蜂窝网络制式</li><li>蜂窝主卡的Radio是否打开</li><li>运营商名称</li><li>蜂窝网络是否处于漫游状态</li><li>蜂窝网络信号强度</li><li>网络时延</li></ul> <p><span><img height="553.413" originheight="1034" originwidth="497" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163027.38754437388739536085414905973233:50001231000000:2800:A80BFB5714A3EFACB678223050B89BB9D389323E88706C5DB041EF7A53736127.png" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section488194602211">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section488194602211" tips="复制节点链接"></i></h3><p>主要通过以下模块的相关API获取网络故障诊断场景所需的网络信息：</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection" target="_blank">@ohos.net.connection (网络连接管理)</a>：用于获取网络的基本信息，如网络类型、IP 地址、网关、DNS 服务器等。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetnetcapabilitiessync10" target="_blank">getNetCapabilitiesSync()</a>方法获取网络能力信息，包括网络类型、网络是否可用等；<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetconnectionpropertiessync10" target="_blank">getConnectionPropertiesSync()</a>方法获取网络配置信息，包括 IP、网关、DNS等</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager" target="_blank">@ohos.wifiManager (WLAN)</a>：获取Wi-Fi网络的信号强度、设备MAC地址等信息。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagergetlinkedinfosync18" target="_blank">getLinkedInfoSync()</a>方法获取当前连接Wi-Fi的信号强度（rssi属性）和MAC 地址（bssid属性）。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio" target="_blank">@ohos.telephony.radio (网络搜索)</a>：获取蜂窝网络的相关信息，如运营商名称、网络制式、信号强度、是否处于漫游状态以及主卡Radio是否打开等。例如，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radiogetoperatornamesync10" target="_blank">getOperatorNameSync()</a>方法获取运营商名称，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radiogetsignalinformationsync10" target="_blank">getSignalInformationSync()</a>方法获取信号强度信息和网络制式。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality" target="_blank">netQuality(网络质量)</a>：提供网络质量实时评估、网络场景识别以及弱信号预测等能力。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/networkboost-netquality#section13106021163" target="_blank">netQuality.on( 'netQosChange')</a>订阅网络质量信息，包含信号强度、下载速度、网络时延等。</li></ul> </div> <p>本章提供了网络故障诊断分析场景的检测项和规格，以下内容仅供参考，开发者可根据自身业务需求选择检测项并定义规格。</p> <ul><li>网络可用性是否可用：如果不可用，则检测结果为网络不可用。</li><li>网络是否连接：如果未连接，则检测结果为网络未连接。</li><li>网络信号强度：如果Wi-Fi低于-70dbm，蜂窝信号强度低于-100dbm，则检测结果为当前网络不佳。</li><li>时延：如果rttMs&gt;500ms，则检测结果为当前网络不佳。</li><li>下载速度：如果下载速度小于&lt;1MB/s，则检测结果为当前网络不佳。</li></ul> <p>以上检测项都未异常，则检测结果为网络正常。其中信号强度、时延和下载速度的获取，通过开启下载任务<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-request#requestagentcreate10-1" target="_blank">request.agent.create()</a>，取10秒的平均值。</p> <div class="tiledSection"><h3 id="section188817462224">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section188817462224" tips="复制节点链接"></i></h3><ol><li>获取网络连接信息<p>该步骤整合了通过@ohos.net.connection模块可获取的各类网络基础连接信息，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetnetcapabilitiessync10" target="_blank">getNetCapabilitiesSync()</a>方法获取网络类型和是否可用。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L89-L114" data-highlighted="yes"><ol class="linenums"><li>checkNetAvailable(): void {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    let netHandle = connection.getDefaultNetSync();</li><li>    <span class="hljs-keyword">if</span> (netHandle.netId === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// If there is no network connected, the netid of the obtained netHandler is 0</span></li><li>      <span class="hljs-keyword">this</span>.hasNetwork = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_not_connect'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.hasNetwork = <span class="hljs-literal">true</span>;</li><li>    let netCapability = connection.getNetCapabilitiesSync(netHandle);</li><li>    let bearerTypes: connection.NetBearType[] = netCapability.bearerTypes;</li><li>    let netCaps: connection.NetCap[] = netCapability.networkCap || [];</li><li>    <span class="hljs-keyword">this</span>.networkType = NetworkUtil.getNetworkTypeStr(bearerTypes[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">this</span>.isNetAvailable = netCaps.includes(connection.NetCap.NET_CAPABILITY_VALIDATED);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNetAvailable) {</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_available'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_unavailable'</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `getNetworkType err, errCode: ${error.code}, error mesage: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L89-L114" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetconnectionpropertiessync10" target="_blank">getConnectionPropertiesSync()</a>方法获取路由信息、IP信息、DNS服务信息，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-net-connection#connectiongetdefaulthttpproxy10-1" target="_blank">getDefaultHttpProxy()</a>方法获取代理信息。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L200-L227" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getConnectionInfo</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> netHandle = connection.<span class="hljs-title function_">getDefaultNetSync</span>();</li><li>    <span class="hljs-keyword">let</span> properties = connection.<span class="hljs-title function_">getConnectionPropertiesSync</span>(netHandle);</li><li>    <span class="hljs-comment">// route info</span></li><li>    <span class="hljs-keyword">let</span> routes = properties.<span class="hljs-property">routes</span> || [];</li><li>    <span class="hljs-comment">// ip address info</span></li><li>    <span class="hljs-keyword">let</span> addresses = properties.<span class="hljs-property">linkAddresses</span> || [];</li><li>    <span class="hljs-comment">// dns service info</span></li><li>    <span class="hljs-keyword">let</span> dnses = properties.<span class="hljs-property">dnses</span> || [];</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// get proxy info</span></li><li>    connection.<span class="hljs-title function_">getDefaultHttpProxy</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: connection.HttpProxy</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getDefaultHttpProxy success, data: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(data)}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">proxyInfo</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getDefaultHttpProxy err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getConnectionInfo err, code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L200-L227" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> </li><li>获取Wi-Fi信息<p>通过@ohos.wifiManager模块的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-wifimanager#wifimanagergetlinkedinfosync18" target="_blank">getLinkedInfoSync()</a>方法获取信号强度和MAC地址信息，这些信息对诊断Wi-Fi连接不稳定、信号弱等问题至关重要。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L231-L241" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getWifiInfo</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> linkInfo = wifiManager.<span class="hljs-title function_">getLinkedInfoSync</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wifiSignal</span> = <span class="hljs-string">`<span class="hljs-subst">${linkInfo.rssi}</span>dBm`</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">wifiMac</span> = linkInfo.<span class="hljs-property">macAddress</span>;</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getWifiRssi err, code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L231-L241" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> </li><li>获取蜂窝网络信息<p>通过@ohos.telephony.radio模块获取蜂窝网络相关信息。</p> <ul><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radiogetoperatornamesync10" target="_blank">radio.getOperatorNameSync()</a>方法获取运营商名称。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radioisradioon7-1" target="_blank">radio.isRadioOn()</a>方法检查蜂窝主卡的Radio是否开启。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radiogetnetworkstate-2" target="_blank">radio.getNetworkState()</a>方法判断蜂窝网络是否处于漫游状态。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-radio#radiogetsignalinformationsync10" target="_blank">radio.getSignalInformationSync()</a>方法获取蜂窝网络信号强度和网络制式。</li></ul> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L245-L268" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">getCellularInfo</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> primarySlotId = <span class="hljs-keyword">await</span> radio.<span class="hljs-title function_">getPrimarySlotId</span>();</li><li>    <span class="hljs-comment">// Get the carrier name</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">operatorName</span> = radio.<span class="hljs-title function_">getOperatorNameSync</span>(primarySlotId);</li><li>    <span class="hljs-comment">// Whether the radio on the cellular main card is turned on</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRadioOn</span> = <span class="hljs-keyword">await</span> radio.<span class="hljs-title function_">isRadioOn</span>(primarySlotId);</li><li>    <span class="hljs-keyword">let</span> networkState = <span class="hljs-keyword">await</span> radio.<span class="hljs-title function_">getNetworkState</span>(primarySlotId);</li><li>    <span class="hljs-comment">// Determine whether the cellular network is roaming</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isRoaming</span> = networkState.<span class="hljs-property">isRoaming</span> + <span class="hljs-string">''</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">signalInfos</span>: radio.<span class="hljs-property">SignalInformation</span>[] = radio.<span class="hljs-title function_">getSignalInformationSync</span>(primarySlotId);</li><li>    <span class="hljs-keyword">if</span> (signalInfos.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> signalInfo = signalInfos[<span class="hljs-number">0</span>];</li><li>      <span class="hljs-comment">// Get cellular network signal strength</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cellularSignal</span> = signalInfo.<span class="hljs-property">dBm</span> + <span class="hljs-string">'dBm'</span>;</li><li>      <span class="hljs-comment">// Get the cellular network standard</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">cellularType</span> = <span class="hljs-title class_">NetworkUtil</span>.<span class="hljs-title function_">getCellularTypeStr</span>(signalInfo.<span class="hljs-property">signalType</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getCellularInfo err, errCode: <span class="hljs-subst">${error.code}</span>, error mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L245-L268" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> </li><li>检测网络质量<p>首先判断网络是否连接和是否可用，如果未连接或者不可用，则显示网络未连接和网络不可用的结果。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L89-L114" data-highlighted="yes"><ol class="linenums"><li>checkNetAvailable(): void {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    let netHandle = connection.getDefaultNetSync();</li><li>    <span class="hljs-keyword">if</span> (netHandle.netId === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-comment">// If there is no network connected, the netid of the obtained netHandler is 0</span></li><li>      <span class="hljs-keyword">this</span>.hasNetwork = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_not_connect'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.hasNetwork = <span class="hljs-literal">true</span>;</li><li>    let netCapability = connection.getNetCapabilitiesSync(netHandle);</li><li>    let bearerTypes: connection.NetBearType[] = netCapability.bearerTypes;</li><li>    let netCaps: connection.NetCap[] = netCapability.networkCap || [];</li><li>    <span class="hljs-keyword">this</span>.networkType = NetworkUtil.getNetworkTypeStr(bearerTypes[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-keyword">this</span>.isNetAvailable = netCaps.includes(connection.NetCap.NET_CAPABILITY_VALIDATED);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isNetAvailable) {</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_available'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_unavailable'</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `getNetworkType err, errCode: ${error.code}, error mesage: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L89-L114" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> <p>如果有网络连接，则开启下载任务用于网络质量测试，下载任务持续时间为10秒。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L65-L85" data-highlighted="yes"><ol class="linenums"><li>queryNetworkInfo() {</li><li>  <span class="hljs-keyword">this</span>.checkNetAvailable();</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.hasNetwork) {</li><li>    <span class="hljs-keyword">this</span>.clearContent();</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.getConnectionInfo();</li><li>  <span class="hljs-keyword">this</span>.getWifiInfo();</li><li>  <span class="hljs-keyword">this</span>.getCellularInfo();</li><li>
</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeoutId === -<span class="hljs-number">1</span> &amp;&amp; TEST_DOWNLOAD_URL !== <span class="hljs-string">''</span>) {</li><li>    <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_is_checking'</span>);</li><li>    <span class="hljs-comment">// Start download file</span></li><li>    NetworkUtil.downloadFile(<span class="hljs-keyword">this</span>.context, TEST_DOWNLOAD_URL, <span class="hljs-keyword">this</span>.cachePath);</li><li>    <span class="hljs-keyword">this</span>.timeoutId = setTimeout(() =&gt; {</li><li>      <span class="hljs-comment">// Remove download task after 10 seconds</span></li><li>      NetworkUtil.removeTask();</li><li>      <span class="hljs-keyword">this</span>.timeoutId = -<span class="hljs-number">1</span>;</li><li>    }, <span class="hljs-number">10000</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L65-L85" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> <p>在下载任务期间，通过netQuality模块的on('netQosChange')接口实时监听网络质量变化，获取时延、下载速度等关键指标。并计算10秒内的平均下载速度、平均时延、Wi-Fi和蜂窝的平均信号强度。并根据这些指标和规格数据对比，获取检测结果，数据规格参考<a href="/consumer/cn/doc/best-practices/bpta-common-network-query#section488194602211">实现方案</a>小节。</p> <div class="screenLinkPre"><div _ngcontent-toi-c106="" class="highlight-div"><div _ngcontent-toi-c106="" class="highlight-div-header"><div _ngcontent-toi-c106="" class="highlight-div-header-left"><div _ngcontent-toi-c106="" class="handle-button expand-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-toi-c106="" class="highlight-div-header-right"><div _ngcontent-toi-c106="" class="handle-button ai-button"></div><div _ngcontent-toi-c106="" class="handle-button line-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-toi-c106="" class="handle-button theme-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-toi-c106="" class="handle-button copy-button"><div _ngcontent-toi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-toi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L136-L196" data-highlighted="yes"><ol class="linenums"><li>onQosChange(): void {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    netQuality.on(<span class="hljs-string">'netQosChange'</span>, (list: netQuality.NetworkQos[]) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (list.length &gt; <span class="hljs-number">0</span>) {</li><li>        list.forEach(async (qos) =&gt; {</li><li>          <span class="hljs-comment">// ...</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timeoutId !== -<span class="hljs-number">1</span> &amp;&amp; TEST_DOWNLOAD_URL !== <span class="hljs-string">''</span>) {</li><li>            let wifiRssi = NetworkUtil.getWifiSignalRssi();</li><li>            let cellularRssi = await NetworkUtil.getCellularSignalRssi();</li><li>            <span class="hljs-keyword">this</span>.totalSpeed += qos.linkDownRate;</li><li>            <span class="hljs-keyword">this</span>.totalRttMs += qos.rttMs;</li><li>            <span class="hljs-keyword">this</span>.totalWifiRssi += wifiRssi;</li><li>            <span class="hljs-keyword">this</span>.totalCellularRssi += cellularRssi;</li><li>            <span class="hljs-keyword">this</span>.rttMsTimes += <span class="hljs-number">1</span>;</li><li>          }</li><li>          <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.timeoutId === -<span class="hljs-number">1</span>) &amp;&amp; (<span class="hljs-keyword">this</span>.rttMsTimes !== <span class="hljs-number">0</span>) &amp;&amp; (TEST_DOWNLOAD_URL !== <span class="hljs-string">''</span>)) {</li><li>            <span class="hljs-comment">// Average download speed</span></li><li>            let avgSpeed = <span class="hljs-keyword">this</span>.totalSpeed / <span class="hljs-number">8</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span> / <span class="hljs-number">10</span>;</li><li>            <span class="hljs-comment">// Average latency</span></li><li>            let avgRttMs = <span class="hljs-keyword">this</span>.totalRttMs / <span class="hljs-keyword">this</span>.rttMsTimes;</li><li>            <span class="hljs-comment">// Average wifi signal strength</span></li><li>            let avgWifiRssi = <span class="hljs-keyword">this</span>.totalWifiRssi / <span class="hljs-keyword">this</span>.rttMsTimes;</li><li>            <span class="hljs-comment">// Average cellular signal strength</span></li><li>            let avgCellularRssi = <span class="hljs-keyword">this</span>.totalCellularRssi / <span class="hljs-keyword">this</span>.rttMsTimes;</li><li>            <span class="hljs-comment">// ...</span></li><li>            <span class="hljs-keyword">if</span> (avgSpeed &lt; <span class="hljs-number">1</span> || avgRttMs &gt; <span class="hljs-number">100</span>) {</li><li>              <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.network_bad_tips'</span>);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            <span class="hljs-comment">// The network is considered poor when the WiFi signal strength is below -70dBm</span></li><li>            <span class="hljs-comment">// or the cellular network signal strength is below -100dBm</span></li><li>            <span class="hljs-keyword">if</span> ((<span class="hljs-keyword">this</span>.networkType === <span class="hljs-string">'wifi'</span> &amp;&amp; avgWifiRssi &lt; -<span class="hljs-number">70</span>) ||</li><li>              (<span class="hljs-keyword">this</span>.networkType === <span class="hljs-string">'cellular'</span> &amp;&amp; avgCellularRssi &lt; -<span class="hljs-number">100</span>)) {</li><li>              <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.network_bad_tips'</span>);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-keyword">this</span>.checkResult = $r(<span class="hljs-string">'app.string.result_network_normal'</span>);</li><li>            }</li><li>          }</li><li>        });</li><li>      }</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `on netQosChange err, code: ${error.code}, message: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/network-query/blob/master/entry/src/main/ets/view/NetworkDiagnostics.ets#L136-L196" target="_blank">NetworkDiagnostics.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section14109114818615">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section14109114818615" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/network-query" target="_blank">实现常见网络信息查询</a></li></ul> </div> <p></p> </div> <div></div></div>