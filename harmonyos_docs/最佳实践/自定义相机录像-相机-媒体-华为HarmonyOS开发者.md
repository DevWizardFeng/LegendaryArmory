<h1 _ngcontent-rmq-c119="" class="doc-title ng-star-inserted" title="自定义相机录像"> 自定义相机录像 </h1>

<div _ngcontent-rmq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section6632684478">概述<i class="anchor-icon anchor-icon-link" anchorid="section6632684478" tips="复制节点链接"></i></h2></div> <p>本文面向于相机应用开发场景，在相机应用中实现了基础视频录制功能。内容涵盖相机设备的创建与调用、录像的启动与停止、以及输出处理的完整流程，有效满足三方应用在不同硬件平台上对录像功能的开发需求。</p> <div class="tiledSection"><h2 id="section91917117481">基础录像<i class="anchor-icon anchor-icon-link" anchorid="section91917117481" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19905810114911" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section19905810114911" tips="复制节点链接"></i></h3><p>录像功能是自定义相机应用的核心功能，提供实时预览和构图调整能力。通过点击界面上的录像按钮，用户即可开始视频录制。在录制过程中，相机应用会持续采集画面数据并将其保存为视频文件，用户可根据需要随时暂停或结束录制。</p> <p><span><img height="568.3090000000001" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163037.65397734753015597394988208511392:50001231000000:2800:8A932BFD30EF5142FE713EC592FB48594DCE4CDF6D8947AEDC01281FBF2AE2FC.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section797871114521">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section797871114521" tips="复制节点链接"></i></h3><p><span><img height="94.666752622154" originheight="162" originwidth="1574" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163037.55174975317687469352612018448041:50001231000000:2800:160CFBF6291A4010C2DF1C5D1FF3140C2DDE7EC3F7EA55EDE0291045A7EE526B.png" title="点击放大" width="920"></span></p> <p></p> <p><span><img height="720.9732802308802" originheight="1195" originwidth="1532" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163037.98407433280358420395644678066141:50001231000000:2800:89506B984F18D455A816FB2529A705E626F3A11E7349B81415406A67CDAAC916.png" title="点击放大" width="920"></span></p> <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-camera" target="_blank">Camera API参考</a>。</p> </div> <ol><li>申请相关权限<p>在开发相机应用时，需要先参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation" target="_blank">申请相关权限</a>。</p> </li><li>配置视频录制参数<ul><li>通过相册管理模块 PhotoAccessHelper 创建一个视频资源，以便后续写入录像文件。<div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L257-L266" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">CreateOptions</span> = {</li><li>  <span class="hljs-variable">title</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title class_">now</span>().<span class="hljs-title class_">toString</span>()</li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">videoAccessHelper</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAccessHelper</span> = <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title function_">getPhotoAccessHelper</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>);</li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">videoUri</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">videoAccessHelper</span>.<span class="hljs-title function_">createAsset</span>(<span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">PhotoType</span>.<span class="hljs-variable">VIDEO</span>, <span class="hljs-string">'mp4'</span>, <span class="hljs-variable">options</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">file</span> = <span class="hljs-variable">fileIo</span>.<span class="hljs-title function_">openSync</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">videoUri</span>, <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">READ_WRITE</span> | <span class="hljs-variable">fileIo</span>.<span class="hljs-variable">OpenMode</span>.<span class="hljs-variable">CREATE</span>);</li><li>} <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">createAsset</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L257-L266" target="_blank">VideoManager.ets</a></div></div></div></div> </li><li>动态生成视频录制的配置profile。<div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L270-L283" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">avProfile</span> = {</li><li>  <span class="hljs-variable">audioBitrate</span>: <span class="hljs-number">48000</span>, <span class="hljs-comment">// Audio bitrate (unit: bps), which affects audio quality</span></li><li>  <span class="hljs-variable">audioChannels</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// Stereo two-channel recording</span></li><li>  <span class="hljs-variable">audioCodec</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">CodecMimeType</span>.<span class="hljs-title class_">AUDIO_AAC</span>, <span class="hljs-comment">// The audio encoding format is AAC</span></li><li>  <span class="hljs-variable">audioSampleRate</span>: <span class="hljs-number">48000</span>, <span class="hljs-comment">// Audio sampling rate (unit: Hz), CD-quality sound</span></li><li>  <span class="hljs-variable">fileFormat</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">ContainerFormatType</span>.<span class="hljs-title class_">CFT_MPEG_4</span>, <span class="hljs-comment">// Container Format Configuration</span></li><li>  <span class="hljs-variable">videoBitrate</span>: <span class="hljs-number">32000000</span>, <span class="hljs-comment">// Video bitrate (unit: bps) determines video clarity</span></li><li>  <span class="hljs-comment">// Dynamic Selection of Video Encoding Format</span></li><li>  <span class="hljs-variable">videoCodec</span>: (<span class="hljs-keyword">this</span>.<span class="hljs-title class_">qualityLevel</span> === <span class="hljs-variable">QualityLevel</span>.<span class="hljs-variable">HIGHER</span> &amp;&amp; <span class="hljs-keyword">this</span>.<span class="hljs-variable">cameraPosition</span> === <span class="hljs-number">0</span>) ?</li><li>    <span class="hljs-variable">media</span>.<span class="hljs-variable">CodecMimeType</span>.<span class="hljs-variable">VIDEO_HEVC</span> : <span class="hljs-title class_">media</span>.<span class="hljs-title class_">CodecMimeType</span>.<span class="hljs-title class_">VIDEO_AVC</span>,</li><li>  <span class="hljs-variable">videoFrameWidth</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">videoProfile</span>?.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">width</span>, <span class="hljs-comment">// Obtain width from video configuration</span></li><li>  <span class="hljs-variable">videoFrameHeight</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">videoProfile</span>?.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">height</span>, <span class="hljs-comment">// Obtain height from video configuration</span></li><li>  <span class="hljs-variable">videoFrameRate</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">cameraPosition</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">60</span> : <span class="hljs-number">30</span>, <span class="hljs-comment">// Obtain rate from video configuration</span></li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L270-L283" target="_blank">VideoManager.ets</a></div></div></div></div> </li><li>音视频录制参数设置，包括采集源类型、编码方式、画质配置、保存路径等，为录制的启动和后续操作提供基础配置。<div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L287-L295" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">avConfig</span> = {</li><li>  <span class="hljs-variable">audioSourceType</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">AudioSourceType</span>.<span class="hljs-title class_">AUDIO_SOURCE_TYPE_CAMCORDER</span>,</li><li>  <span class="hljs-variable">videoSourceType</span>: <span class="hljs-title class_">media</span>.<span class="hljs-title class_">VideoSourceType</span>.<span class="hljs-title class_">VIDEO_SOURCE_TYPE_SURFACE_YUV</span>,</li><li>  <span class="hljs-variable">profile</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avProfile</span>,</li><li>  <span class="hljs-variable">url</span>: `<span class="hljs-title class_">fd</span>:<span class="hljs-comment">//${this.file?.fd}`,</span></li><li>  <span class="hljs-variable">metadata</span>: {</li><li>    <span class="hljs-variable">videoOrientation</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getCameraImageRotation</span>().<span class="hljs-title class_">toString</span>()</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L287-L295" target="_blank">VideoManager.ets</a></div></div></div></div> </li></ul> </li></ol><ol start="3"><li>获取Surface<p>系统提供的media接口可以创建一个录像AVRecorder实例，通过该实例的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#getinputsurface9-1" target="_blank">getInputSurface()</a>方法获取SurfaceId，用于后续录像输出流的关联，处理录像输出流的数据。</p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L209-L209" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">let</span> videoSurfaceId = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.avRecorder.getInputSurface();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L209-L209" target="_blank">VideoManager.ets</a></div></div></div></div> </li></ol><ol start="4"><li>创建录像输出流<p><span style="color: rgb(36,39,40);">通过</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameraoutputcapability" target="_blank">CameraOutputCapability</a><span style="color: rgb(36,39,40);">模块中的videoProfiles属性，可获取当前设备支持的录像输出流配置，根据设备能力和目标配置，选择合适的视频配置。在当前示例中，演示了根据不同相机位置、图片质量去设置不同的分辨率和帧率，最后通过</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createvideooutput" target="_blank">createVideoOutput()</a><span style="color: rgb(36,39,40);">方法创建录像输出流。</span></p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L203-L246" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">createVideoOutput</span>(<span class="hljs-params">cameraManager: camera.CameraManager|<span class="hljs-literal">undefined</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span> || <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>.<span class="hljs-property">state</span> !== <span class="hljs-title class_">AVRecorderState</span>.<span class="hljs-property">PREPARED</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> videoSurfaceId = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>.<span class="hljs-title function_">getInputSurface</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = cameraManager?.<span class="hljs-title function_">createVideoOutput</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">videoProfile</span>, videoSurfaceId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>,</li><li>      <span class="hljs-string">`Failed to create the output instance. error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">setVideoProfile</span>(<span class="hljs-params">cameraManager: camera.CameraManager|<span class="hljs-literal">undefined</span>, targetProfile: camera.Profile,</span></li><li><span class="hljs-params">  device: camera.CameraDevice</span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraPosition</span> = device.<span class="hljs-property">cameraPosition</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraOutputCap</span>: camera.<span class="hljs-property">CameraOutputCapability</span> | <span class="hljs-literal">undefined</span> =</li><li>    cameraManager?.<span class="hljs-title function_">getSupportedOutputCapability</span>(device,</li><li>      camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_VIDEO</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">videoProfilesArray</span>: camera.<span class="hljs-property">VideoProfile</span>[] | <span class="hljs-literal">undefined</span> = cameraOutputCap?.<span class="hljs-property">videoProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (videoProfilesArray?.<span class="hljs-property">length</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> displayRatio = targetProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / targetProfile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-keyword">const</span> profileWidth = targetProfile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>      <span class="hljs-keyword">const</span> videoProfile = videoProfilesArray</li><li>        .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(a.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth) - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(b.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth))</li><li>        .<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">pf</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">const</span> pfDisplayRatio = pf.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / pf.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(pfDisplayRatio - displayRatio) &lt;= <span class="hljs-title class_">CameraConstant</span>.<span class="hljs-property">PROFILE_DIFFERENCE</span> &amp;&amp;</li><li>            pf.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_YUV_420_SP</span>;</li><li>        });</li><li>      <span class="hljs-keyword">if</span> (!videoProfile) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Failed to get video profile'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">videoProfile</span> = videoProfile;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`Failed to createPhotoOutput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L203-L246" target="_blank">VideoManager.ets</a></div></div></div></div> </li></ol><ol start="5"><li><span style="color: rgb(36,39,40);">启动录像</span><p><span style="color: rgb(36,39,40);">先通过videoOutput的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#start-1" target="_blank">start()</a><span style="color: rgb(36,39,40);">方法启动录像输出流，再通过avRecorder的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#start9" target="_blank">start()</a><span style="color: rgb(36,39,40);">方法开始录像。</span><span style="color: rgb(36,39,40);">如需实现前置摄像头录像功能，</span>先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#ismirrorsupported15" target="_blank">isMirrorSupported()</a>方法判断设备是否支持镜像功能；如果支持且当前为前置摄像头，则调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#enablemirror15" target="_blank">enableMirror()</a>方法开启镜像效果。</p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L111-L127" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">start</span>(<span class="hljs-params">isFront: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-property">state</span> === <span class="hljs-title class_">AVRecorderState</span>.<span class="hljs-property">PREPARED</span>) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isSupportMirror</span>() &amp;&amp; isFront) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">enableMirror</span>(<span class="hljs-literal">true</span>)</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">start</span>();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">start</span>();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`Failed to start and catch error is  <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L111-L127" target="_blank">VideoManager.ets</a></div></div></div></div> </li></ol><ol start="6"><li><span style="color: rgb(36,39,40);">暂停录像</span><p><span style="color: rgb(36,39,40);">先通过avRecorder的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#pause9-1" target="_blank">pause()</a><span style="color: rgb(36,39,40);">方法暂停录像，再通过videoOutput的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#stop-1" target="_blank">stop()</a><span style="color: rgb(36,39,40);">方法停止录像输出流。</span></p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L150-L160" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">pause</span>()</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avRecorder?.state === AVRecorderState.STARTED) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.avRecorder.pause();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.output?.stop();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.info(TAG_LOG, `Failed to pause <span class="hljs-keyword">and</span> <span class="hljs-keyword">catch</span> error <span class="hljs-keyword">is</span>  ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L150-L160" target="_blank">VideoManager.ets</a></div></div></div></div> </li><li><span style="color: rgb(36,39,40);">恢复录像</span><p><span style="color: rgb(36,39,40);">先通过videoOutput的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#start-1" target="_blank">start()</a><span style="color: rgb(36,39,40);">方法启动录像输出流，再通过avRecorder的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#resume9-1" target="_blank">resume()</a><span style="color: rgb(36,39,40);">方法恢复录像。</span></p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L164-L174" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">resume</span>()</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avRecorder?.state === AVRecorderState.PAUSED) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.output?.start();</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.avRecorder.resume();</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.info(TAG_LOG, `Failed to resume <span class="hljs-keyword">and</span> <span class="hljs-keyword">catch</span> error <span class="hljs-keyword">is</span>  ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L164-L174" target="_blank">VideoManager.ets</a></div></div></div></div> </li><li>停止录像<p><span style="color: rgb(36,39,40);">先通过avRecorder的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#stop9-1" target="_blank">stop()</a><span style="color: rgb(36,39,40);">方法停止录像，再通过videoOutput的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#stop-1" target="_blank">stop()</a><span style="color: rgb(36,39,40);">方法停止录像输出流。</span></p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L131-L146" data-highlighted="yes"><ol class="linenums"><li>async stop() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.avRecorder?.state === AVRecorderState.STARTED</li><li>      || <span class="hljs-keyword">this</span>.avRecorder?.state === AVRecorderState.PAUSED) {</li><li>      await <span class="hljs-keyword">this</span>.avRecorder.stop();</li><li>      await <span class="hljs-keyword">this</span>.output?.stop();</li><li>      <span class="hljs-keyword">const</span> thumbnail = await <span class="hljs-keyword">this</span>.getVideoThumbnail();</li><li>      <span class="hljs-keyword">if</span> (thumbnail) {</li><li>        <span class="hljs-keyword">this</span>.callback(thumbnail, <span class="hljs-keyword">this</span>.videoUri);</li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.info(TAG_LOG, `Failed to stop and <span class="hljs-keyword">catch</span> error <span class="hljs-keyword">is</span>  ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L131-L146" target="_blank">VideoManager.ets</a></div></div></div></div> </li><li>释放资源<p><span style="color: rgb(36,39,40);">先通过avRecorder的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avrecorder#release9-1" target="_blank">release()</a><span style="color: rgb(36,39,40);">方法释放录像资源，再通过videoOutput的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameraoutput#release-1" target="_blank">release()</a><span style="color: rgb(36,39,40);">方法释放输出流。</span></p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L178-L191" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">release</span>();</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">release</span>();</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span> &amp;&amp; <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">close</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span>.<span class="hljs-property">fd</span>);</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`release failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'stateChange'</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">avRecorder</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">file</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L178-L191" target="_blank">VideoManager.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section2032234892514">视频防抖<i class="anchor-icon anchor-icon-link" anchorid="section2032234892514" tips="复制节点链接"></i></h2></div> <p>通过session中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-stabilization#setvideostabilizationmode11" target="_blank">setVideoStabilizationMode()</a>方法可以设置视频防抖模式，详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-stabilization#setvideostabilizationmode11" target="_blank">Stabilization</a>。</p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L397-L418" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setVideoStabilizationMode</span>(<span class="hljs-attr">session</span>: camera.<span class="hljs-property">VideoSession</span>): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">mode</span>: camera.<span class="hljs-property">VideoStabilizationMode</span> = camera.<span class="hljs-property">VideoStabilizationMode</span>.<span class="hljs-property">AUTO</span>;</li><li>  <span class="hljs-comment">// Check whether video stabilization is supported</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = session.<span class="hljs-title function_">isVideoStabilizationModeSupported</span>(mode);</li><li>    <span class="hljs-keyword">if</span> (!isSupported) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`videoStabilizationMode: <span class="hljs-subst">${mode}</span> is not support`</span>);</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`setVideoStabilizationMode: <span class="hljs-subst">${mode}</span>`</span>);</li><li>    <span class="hljs-comment">// Set video stabilization</span></li><li>    session.<span class="hljs-title function_">setVideoStabilizationMode</span>(mode);</li><li>    <span class="hljs-keyword">let</span> activeVideoStabilizationMode = session.<span class="hljs-title function_">getActiveVideoStabilizationMode</span>();</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`activeVideoStabilizationMode: <span class="hljs-subst">${activeVideoStabilizationMode}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> isSupported;</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>,</li><li>      <span class="hljs-string">`setVideoStabilizationMode failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L397-L418" target="_blank">VideoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section272314302615">设置录像旋转角度<i class="anchor-icon anchor-icon-link" anchorid="section272314302615" tips="复制节点链接"></i></h2></div> <p>录像的旋转角度与重力方向（即设备旋转角度）相关。<span style="color: rgb(36,39,40);">调用</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput" target="_blank">VideoOutput</a><span style="color: rgb(36,39,40);">类中的</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-videooutput#getvideorotation12" target="_blank">getVideoRotation()</a><span style="color: rgb(36,39,40);">可以获取到录像的旋转角度。</span>详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section12502114915275" target="_blank">适配相机旋转角度(ArkTS)</a> 。</p> <p>deviceDegree：设备旋转角度。获取方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817" target="_blank">计算设备旋转角度</a>。</p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L356-L366" data-highlighted="yes"><ol class="linenums"><li>getVideoRotation(deviceDegree: number): camera.ImageRotation {</li><li>  let videoRotation: camera.ImageRotation = <span class="hljs-keyword">this</span>.getCameraImageRotation();</li><li>  <span class="hljs-keyword">try</span> {</li><li>    videoRotation = <span class="hljs-keyword">this</span>.output!.getVideoRotation(deviceDegree);</li><li>    Logger.info(TAG_LOG, `Video rotation <span class="hljs-keyword">is</span>: ${videoRotation}`);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.info(TAG_LOG, `Failed to getVideoRotation and <span class="hljs-keyword">catch</span> error <span class="hljs-keyword">is</span>: ${error.message}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> videoRotation;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L356-L366" target="_blank">VideoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section13783165415295">HDR Vivid相机录像<i class="anchor-icon anchor-icon-link" anchorid="section13783165415295" tips="复制节点链接"></i></h2></div> <p>HDR Vivid是UWA认证的动态HDR视频标准，能够拍摄出层次更丰富、光影细节更鲜明的画面，显著提升画面质感。应用仅需接入媒体领域提供的API，即可集成HarmonyOS的HDR Vivid视频采集、转码和解码显示功能。与普通录像相比，HDR录像需要开启视频防抖，随后查询设备支持的色彩空间列表，最终通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace()</a>方法完成色彩空间设置。普通录像无需执行这些步骤。详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-hdr-recording" target="_blank">HDR Vivid相机录像(ArkTS)</a>。</p> <div class="screenLinkPre"><div _ngcontent-rmq-c106="" class="highlight-div"><div _ngcontent-rmq-c106="" class="highlight-div-header"><div _ngcontent-rmq-c106="" class="highlight-div-header-left"><div _ngcontent-rmq-c106="" class="handle-button expand-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-rmq-c106="" class="highlight-div-header-right"><div _ngcontent-rmq-c106="" class="handle-button ai-button"></div><div _ngcontent-rmq-c106="" class="handle-button line-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-rmq-c106="" class="handle-button theme-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-rmq-c106="" class="handle-button copy-button"><div _ngcontent-rmq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-rmq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L422-L453" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>): <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>[] = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">colorSpaces</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">The</span> <span class="hljs-variable">getSupportedColorSpaces</span> <span class="hljs-variable">call</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">colorSpaces</span>;</li><li>}</li><li>
</li><li><span class="hljs-title function_">setColorSpaceAfterCommitConfig</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">VideoSession</span>, <span class="hljs-variable">isHdr</span>: <span class="hljs-title class_">boolean</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> =</li><li>    <span class="hljs-variable">isHdr</span> ? <span class="hljs-variable">colorSpaceManager</span>.<span class="hljs-variable">ColorSpace</span>.<span class="hljs-variable">BT2020_HLG_LIMIT</span> : <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>.<span class="hljs-title class_">BT709_LIMIT</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>[] = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>(<span class="hljs-variable">session</span>);</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">colorSpaces</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">colorSpace</span>)) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">colorSpace</span>: ${<span class="hljs-variable">colorSpace</span>} <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">support</span>`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">setColorSpace</span>: ${<span class="hljs-variable">colorSpace</span>}`);</li><li>    <span class="hljs-variable">session</span>.<span class="hljs-title function_">setColorSpace</span>(<span class="hljs-variable">colorSpace</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">setColorSpace</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">activeColorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">activeColorSpace</span>: ${<span class="hljs-variable">activeColorSpace</span>}`);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">getActiveColorSpace</span> <span class="hljs-variable">Faild</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/VideoManager.ets#L422-L453" target="_blank">VideoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section841042445115">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section841042445115" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CustomCamera" target="_blank">自定义相机开发</a></li></ul> </div> </div> <div></div></div>