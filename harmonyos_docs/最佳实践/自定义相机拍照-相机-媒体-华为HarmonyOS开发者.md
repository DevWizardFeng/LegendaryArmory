<h1 _ngcontent-det-c119="" class="doc-title ng-star-inserted" title="自定义相机拍照"> 自定义相机拍照 </h1>

<div _ngcontent-det-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section8642194818111">概述<i class="anchor-icon anchor-icon-link" anchorid="section8642194818111" tips="复制节点链接"></i></h2></div> <p>拍照是相机的最重要功能之一，拍照模块依托于相机复杂的逻辑，为确保用户拍摄的照片质量，提供了对分辨率、闪光灯、焦距、照片质量及旋转角度等设置的调整选项。本文将以自定义相机为例，分别介绍基础拍照、参数配置、分段式拍照、HDR Vivid拍照以及动图拍摄等功能。通过多样化的拍摄方式，可以更好地满足用户的个性化需求。</p> <p>其中，分段式拍照、HDR Vivid拍照和动图拍摄，分别从效率、画质和内容三大核心方面对自定义相机进行了优化。用户可根据实际需求，在追求快速反馈、细节保留或动态记录时，灵活选择单一或多种功能组合使用，最大限度满足个性化拍摄场景，全面提升拍照体验。</p> <div class="tiledSection"><h2 id="section13863173819118">基础拍照<i class="anchor-icon anchor-icon-link" anchorid="section13863173819118" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section19905810114911" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section19905810114911" tips="复制节点链接"></i></h3><p>基础拍照功能是自定义相机应用的重要功能，用户在切换到拍照模式后可实时预览取景画面，并通过快门按钮快速拍摄照片，此外用户还可以设置不同的拍照参数，应用会将拍到的画面保存为图片。</p> </div> <p><span><img height="568.3090000000001" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.89946316394386112560847691528803:50001231000000:2800:107E4C01EBC530E274061D7E1973FEE8BC611697C4516B4CC611313A78852B45.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section797871114521">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section797871114521" tips="复制节点链接"></i></h3><p><span><img height="106.26575691937424" originheight="180" originwidth="1558" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.12656272338064989381085206613762:50001231000000:2800:6E153AA2E5D6BC4D23697965A83845D6746F75ADC95B0580AE807809BF338CC6.png" title="点击放大" width="920"></span></p> <p><span><img height="480.60198082346307" originheight="792" originwidth="1516" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.86584099566997093232649560864698:50001231000000:2800:C88CA9000BC09CE2F8F227995AD5A40E0D421307ACBB97A7F717809888D3C6D2.png" title="点击放大" width="920"></span></p> <p>详细的API说明请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-camera" target="_blank">Camera API参考</a>。</p> </div> <ol><li>申请相关权限<p>在开发相机应用时，需要先参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-preparation" target="_blank">申请相关权限</a>。</p> </li><li>创建拍照输出流<p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameraoutputcapability" target="_blank">CameraOutputCapability</a>类中的photoProfiles属性，能够获取设备当前支持的拍照输出流配置，根据业务场景选择合适的输出流配置。最终，可通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createphotooutput11" target="_blank">createPhotoOutput()</a>方法，并传入选定的输出流配置，完成拍照输出流的创建。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在profile的选择时需要注意：</p> <ul><li>必须确保宽高比与预览的<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-custom-camera-preview#li181871531143817">Surface</a>的宽高比一致，避免画面失真或裁剪，在此前提下根据业务需求和设备性能选择合适的分辨率大小即可。建议分辨率在1280×720 到 3840×2160之间，分辨率过低可能导致画面模糊，分辨率过高则可能带来资源浪费、功耗增加和内存占用过高等问题。</li><li>在处理拍照获取的buffer数据时，应确保相机格式与所选目标的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-camera-h#camera_format" target="_blank">format</a>严格一致，以避免因为格式不匹配而导致的画面异常。</li></ul> </div></div></div> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L68-L98" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Create photo output</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">createPhotoOutput</span>(<span class="hljs-params">cameraManager: camera.CameraManager|<span class="hljs-literal">undefined</span>, cameraDevice: camera.CameraDevice,</span></li><li><span class="hljs-params">  profile: camera.Profile</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">cameraPhotoOutput</span>: camera.<span class="hljs-property">PhotoOutput</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">const</span> cameraOutputCapability =</li><li>    cameraManager?.<span class="hljs-title function_">getSupportedOutputCapability</span>(cameraDevice, camera.<span class="hljs-property">SceneMode</span>.<span class="hljs-property">NORMAL_PHOTO</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">photoProfilesArray</span>: camera.<span class="hljs-property">Profile</span>[] | <span class="hljs-literal">undefined</span> = cameraOutputCapability?.<span class="hljs-property">photoProfiles</span>;</li><li>  <span class="hljs-keyword">if</span> (photoProfilesArray?.<span class="hljs-property">length</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> displayRatio = profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / profile.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-keyword">const</span> profileWidth = profile.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>      <span class="hljs-keyword">const</span> photoProfile = photoProfilesArray</li><li>        .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(a.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth) - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(b.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth))</li><li>        .<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">pf</span> =&gt;</span> {</li><li>          <span class="hljs-keyword">const</span> pfDisplayRatio = pf.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / pf.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>          <span class="hljs-keyword">return</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(pfDisplayRatio - displayRatio) &lt;= <span class="hljs-title class_">CameraConstant</span>.<span class="hljs-property">PROFILE_DIFFERENCE</span> &amp;&amp;</li><li>            pf.<span class="hljs-property">format</span> === camera.<span class="hljs-property">CameraFormat</span>.<span class="hljs-property">CAMERA_FORMAT_JPEG</span>;</li><li>        });</li><li>      <span class="hljs-keyword">if</span> (!photoProfile) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Failed to get photo profile'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      cameraPhotoOutput = cameraManager?.<span class="hljs-title function_">createPhotoOutput</span>(photoProfile);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`Failed to createPhotoOutput. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = cameraPhotoOutput;</li><li>  <span class="hljs-keyword">return</span> cameraPhotoOutput;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L68-L98" target="_blank">PhotoManager.ets</a></div></div></div></div> </li><li>设置拍照photoAvailable回调<div class="p">注册全质量图上报监听后，触发拍照操作即可通过回调接收图片数据。具体实现时，需通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#onphotoavailable11" target="_blank">photoOutput.on('photoAvailable')</a>接口监听buffer获取事件。完成回调设置后，调用photoOutput的capture()方法触发拍摄，此时拍照生成的buffer将回传至注册的回调中。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>buffer处理完成后需及时释放资源，若未正确释放可能导致后续拍摄无法获取。</p> </div></div></div> </div> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L157-L167" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set photo callback single</span></li><li><span class="hljs-title function_">setPhotoOutputCbSingle</span>(<span class="hljs-variable">photoOutput</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoOutput</span>, <span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>) {</li><li>  <span class="hljs-variable">photoOutput</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'photoAvailable'</span>, (<span class="hljs-variable">errCode</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">photo</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Photo</span>): <span class="hljs-title class_">void</span> =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">errCode</span> || <span class="hljs-variable">photo</span> === <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, <span class="hljs-string">'getPhoto failed'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">mediaLibSavePhotoSingle</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">photo</span>.<span class="hljs-keyword">main</span>)</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L157-L167" target="_blank">PhotoManager.ets</a></div></div></div></div> <p>通过相册管理模块photoAccessHelper将其保存至媒体库。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L171-L207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Save photo single</span></li><li><span class="hljs-title function_">mediaLibSavePhotoSingle</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-variable">imageObj</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span>) {</li><li>  <span class="hljs-variable">imageObj</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">errCode</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">component</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">errCode</span> || <span class="hljs-variable">component</span> === <span class="hljs-variable">undefined</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, <span class="hljs-string">'getComponent failed'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">component</span>.<span class="hljs-variable">byteBuffer</span>;</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">buffer</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, <span class="hljs-string">'byteBuffer is null'</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">photoType</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoType</span> = <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">PhotoType</span>.<span class="hljs-variable">IMAGE</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">extension</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'jpg'</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">CreateOptions</span> = {</li><li>      <span class="hljs-variable">title</span>: <span class="hljs-string">'testPhoto'</span></li><li>    }</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">assetChangeRequest</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">MediaAssetChangeRequest</span> =</li><li>        <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">MediaAssetChangeRequest</span>.<span class="hljs-title function_">createAssetRequest</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">photoType</span>, <span class="hljs-variable">extension</span>, <span class="hljs-variable">options</span>);</li><li>      <span class="hljs-variable">assetChangeRequest</span>.<span class="hljs-title function_">addResource</span>(<span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">ResourceType</span>.<span class="hljs-variable">IMAGE_RESOURCE</span>, <span class="hljs-variable">buffer</span>)</li><li>      <span class="hljs-variable">assetChangeRequest</span>.<span class="hljs-title function_">saveCameraPhoto</span>();</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">accessHelper</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAccessHelper</span> =</li><li>        <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title function_">getPhotoAccessHelper</span>(<span class="hljs-variable">context</span>);</li><li>      <span class="hljs-variable">await</span> <span class="hljs-variable">accessHelper</span>.<span class="hljs-title function_">applyChanges</span>(<span class="hljs-variable">assetChangeRequest</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">buffer</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">pixelmap</span> = <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMapSync</span>();</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">callback</span>(<span class="hljs-variable">pixelmap</span>, <span class="hljs-variable">assetChangeRequest</span>.<span class="hljs-title function_">getAsset</span>().<span class="hljs-variable">uri</span>);</li><li>      <span class="hljs-variable">accessHelper</span>.<span class="hljs-title function_">release</span>();</li><li>      <span class="hljs-variable">imageObj</span>.<span class="hljs-title function_">release</span>();</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>,</li><li>        `<span class="hljs-variable">mediaLibSavePhotoSingle</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L171-L207" target="_blank">PhotoManager.ets</a></div></div></div></div> </li><li>参数配置<p>通过配置相机参数可调节闪光灯、变焦、焦距等拍照功能。相关功能的实现主要依托<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photosession" target="_blank">PhotoSession</a>（普通拍照模式会话类）的接口方法完成。</p> <ol><li>设置闪光灯：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section9696119411">设置闪光灯</a>。</li><li>设置对焦模式：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section2356188242">实现点击对焦</a>。</li><li>设置焦点：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section2356188242">实现点击对焦</a>。</li><li>设置变焦比：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section1860863113213">设置相机焦距</a>。</li><li>设置拍照旋转角度<p>拍照的旋转角度与重力方向（即设备旋转角度）相关。调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput" target="_blank">PhotoOutput</a>类中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#getphotorotation12" target="_blank">getPhotoRotation()</a>可以获取到拍照的旋转角度。详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section959315464278" target="_blank">适配相机旋转角度(ArkTS)</a> 。</p> <p>deviceDegree：设备旋转角度。获取方式请见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-angle-adaptation#section2034473052817" target="_blank">计算设备旋转角度</a>。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L336-L346" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Get photo rotation</span></li><li><span class="hljs-title function_">getPhotoRotation</span>(<span class="hljs-variable">photoOutput</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoOutput</span>, <span class="hljs-variable">deviceDegree</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">ImageRotation</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">photoRotation</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">ImageRotation</span> = <span class="hljs-variable">camera</span>.<span class="hljs-variable">ImageRotation</span>.<span class="hljs-variable">ROTATION_0</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">photoRotation</span> = <span class="hljs-variable">photoOutput</span>.<span class="hljs-title function_">getPhotoRotation</span>(<span class="hljs-variable">deviceDegree</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">The</span> <span class="hljs-variable">photoOutput</span>.<span class="hljs-variable">getPhotoRotation</span> <span class="hljs-variable">call</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">photoRotation</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L336-L346" target="_blank">PhotoManager.ets</a></div></div></div></div> </li></ol> </li><li>触发拍照<p>通过photoOutput类的capture()方法，执行拍照任务。</p> <p>可以通过参数调整拍照的设置，例如调整拍照质量、拍照旋转角度、位置信息以及是否开启镜像等。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L350-L367" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Capture photo</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">capture</span>(<span class="hljs-params">isFront: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">const</span> degree = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPhotoDegree</span>();</li><li>  <span class="hljs-keyword">const</span> rotation = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPhotoRotation</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>!, degree);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">settings</span>: camera.<span class="hljs-property">PhotoCaptureSetting</span> = {</li><li>    <span class="hljs-attr">quality</span>: camera.<span class="hljs-property">QualityLevel</span>.<span class="hljs-property">QUALITY_LEVEL_HIGH</span>,</li><li>    rotation,</li><li>    <span class="hljs-attr">mirror</span>: isFront</li><li>  };</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">capture</span>(settings, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`Failed to capture the photo. error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Callback invoked to indicate the photo capture request success.'</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L350-L367" target="_blank">PhotoManager.ets</a></div></div></div></div> <p></p> </li><li>释放资源<p>调用CameraOutput类的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameraoutput#release" target="_blank">release()</a>方法，释放输出资源。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L434-L448" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Release photo</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`release failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isSingle</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'photoAvailable'</span>);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">off</span>(<span class="hljs-string">'photoAssetAvailable'</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L434-L448" target="_blank">PhotoManager.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h2 id="section91917117481">分段式拍照<i class="anchor-icon anchor-icon-link" anchorid="section91917117481" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1833612586159" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1833612586159" tips="复制节点链接"></i></h3><p>分段式拍照是一项能够显著提升用户体验的功能。应用程序可在第一阶段以较快速度获取预览级或经过初步处理的图片，优先展示给用户，从而有效减少等待时间，优化交互体验。随后，在后台或系统空闲时，再补充上传全质量照片，以满足后续处理或长期存档的需求。</p> </div> <p><span><img height="568.3090000000001" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.27758805576758401991674317463291:50001231000000:2800:4B1E3FDD75B799A1482D83215E0853F15D16E5473EE55A25F429798414B596DA.gif" title="点击放大" width="266"></span></p> <p></p> <p>分段式拍照是指在应用下发拍照任务后，系统按阶段上报不同质量的图片。在一阶段，系统快速上报低质量图，应用通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#onphotoassetavailable12" target="_blank">on('photoAssetAvailable')</a>接口会收到一个PhotoAsset对象，通过该对象可调用媒体库接口，读取图片或落盘图片。在二阶段，分段式子服务会根据系统压力以及定制化场景进行调度，将后处理好的原图回传给媒体库，替换低质量图。设置拍照photoAssetAvailable的回调来获取photoAsset。</p> <p><span><img height="119.58864755664757" originheight="204" originwidth="1569" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.10842107967414294334281855855046:50001231000000:2800:6A2F8B99B01AD7F18A91FCF9E4C1400517CAD62142F6653B57CAD70D386E3691.png" title="点击放大" width="920"></span></p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L102-L153" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Save camera photo</span></li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">mediaLibSavePhoto</span>(<span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span>,</li><li>  <span class="hljs-variable">phAccessHelper</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAccessHelper</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">assetChangeRequest</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">MediaAssetChangeRequest</span> =</li><li>      <span class="hljs-variable">new</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title function_">MediaAssetChangeRequest</span>(<span class="hljs-variable">photoAsset</span>);</li><li>    <span class="hljs-variable">assetChangeRequest</span>.<span class="hljs-title function_">saveCameraPhoto</span>();</li><li>    <span class="hljs-variable">await</span> <span class="hljs-variable">phAccessHelper</span>.<span class="hljs-title function_">applyChanges</span>(<span class="hljs-variable">assetChangeRequest</span>);</li><li>    <span class="hljs-variable">phAccessHelper</span>.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">apply</span> <span class="hljs-variable">saveCameraPhoto</span> <span class="hljs-variable">failed</span> <span class="hljs-variable">with</span> <span class="hljs-variable">error</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}, ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-variable">async</span> <span class="hljs-title function_">mediaLibRequestBuffer</span>(<span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span>, <span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>,</li><li>  <span class="hljs-variable">callback</span>: (<span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>, <span class="hljs-variable">url</span>: <span class="hljs-title class_">string</span>) =&gt; <span class="hljs-variable">void</span>) {</li><li>  <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaDataHandler</span> <span class="hljs-variable">implements</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title class_">MediaAssetDataHandler</span>&lt;<span class="hljs-title class_">ArrayBuffer</span>&gt; {</li><li>    <span class="hljs-title function_">onDataPrepared</span>(<span class="hljs-variable">data</span>: <span class="hljs-title class_">ArrayBuffer</span>) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">data</span> === <span class="hljs-variable">undefined</span>) {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, <span class="hljs-string">'Error occurred when preparing data'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">imageSource</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createImageSource</span>(<span class="hljs-variable">data</span>);</li><li>      <span class="hljs-variable">imageSource</span>.<span class="hljs-title function_">createPixelMap</span>().<span class="hljs-title function_">then</span>((<span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span>) =&gt; {</li><li>        <span class="hljs-title function_">callback</span>(<span class="hljs-variable">pixelMap</span>, <span class="hljs-variable">photoAsset</span>.<span class="hljs-variable">uri</span>);</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">createPixelMap</span> <span class="hljs-variable">err</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">requestOptions</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">RequestOptions</span> = {</li><li>    <span class="hljs-variable">deliveryMode</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">DeliveryMode</span>.<span class="hljs-title class_">FAST_MODE</span>,</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">handler</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MediaDataHandler</span>();</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">await</span> <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-variable">MediaAssetManager</span>.<span class="hljs-title function_">requestImageData</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">photoAsset</span>, <span class="hljs-variable">requestOptions</span>, <span class="hljs-variable">handler</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">requestImageData</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">setPhotoOutputCbDouble</span>(<span class="hljs-variable">cameraPhotoOutput</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoOutput</span>) {</li><li>  <span class="hljs-variable">cameraPhotoOutput</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'photoAssetAvailable'</span>,</li><li>    <span class="hljs-variable">async</span> (<span class="hljs-variable">_err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">photoAsset</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAsset</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; =&gt; {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">accessHelper</span>: <span class="hljs-title class_">photoAccessHelper</span>.<span class="hljs-title class_">PhotoAccessHelper</span> =</li><li>        <span class="hljs-variable">photoAccessHelper</span>.<span class="hljs-title function_">getPhotoAccessHelper</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">mediaLibSavePhoto</span>(<span class="hljs-variable">photoAsset</span>, <span class="hljs-variable">accessHelper</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">mediaLibRequestBuffer</span>(<span class="hljs-variable">photoAsset</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">callback</span>);</li><li>    });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L102-L153" target="_blank">PhotoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1787812459223">HDR Vivid相机拍照<i class="anchor-icon anchor-icon-link" anchorid="section1787812459223" tips="复制节点链接"></i></h2></div> <p>HDR Vivid是UWA认证的动态HDR视频标准，能够拍摄出层次更丰富、光影细节更鲜明的画面，显著提升画面质感。应用仅需接入媒体领域提供的API，即可集成HarmonyOS的HDR Vivid图片采集、转码和解码显示功能。与基础拍照相比，HDR拍照在提交会话配置前需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-colormanagement#setcolorspace12" target="_blank">setColorSpace()</a>方法进行色彩空间设置，而基础拍照则无需此步骤。详细请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-hdr-shooting" target="_blank">HDR Vivid相机拍照(ArkTS)</a>。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L232-L260" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set color space</span></li><li><span class="hljs-title function_">setColorSpaceBeforeCommitConfig</span>(<span class="hljs-variable">session</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">PhotoSession</span>, <span class="hljs-variable">isHdr</span>: <span class="hljs-title class_">boolean</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// The isHdr flag indicates whether HDR mode is enabled, with true representing the use of the DISPLAY_P3 color space.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> =</li><li>    <span class="hljs-variable">isHdr</span> ? <span class="hljs-variable">colorSpaceManager</span>.<span class="hljs-variable">ColorSpace</span>.<span class="hljs-variable">DISPLAY_P3</span> : <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>.<span class="hljs-title class_">SRGB</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">colorSpaces</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span>&gt; = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">colorSpaces</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getSupportedColorSpaces</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">The</span> <span class="hljs-variable">getSupportedColorSpaces</span> <span class="hljs-variable">call</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable">colorSpaces</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-variable">colorSpace</span>)) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">colorSpace</span>: ${<span class="hljs-variable">colorSpace</span>} <span class="hljs-keyword">is</span> <span class="hljs-variable">not</span> <span class="hljs-variable">support</span>`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">setColorSpace</span>: ${<span class="hljs-variable">colorSpace</span>}`);</li><li>    <span class="hljs-variable">session</span>.<span class="hljs-title function_">setColorSpace</span>(<span class="hljs-variable">colorSpace</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">setColorSpace</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">activeColorSpace</span>: <span class="hljs-title class_">colorSpaceManager</span>.<span class="hljs-title class_">ColorSpace</span> = <span class="hljs-variable">session</span>.<span class="hljs-title function_">getActiveColorSpace</span>();</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">activeColorSpace</span>: ${<span class="hljs-variable">activeColorSpace</span>}`);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">getActiveColorSpace</span> <span class="hljs-variable">Faild</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L232-L260" target="_blank">PhotoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1321581112233">拍摄动图<i class="anchor-icon anchor-icon-link" anchorid="section1321581112233" tips="复制节点链接"></i></h2></div> <p><span><img height="568.3090000000001" originheight="720" originwidth="337" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163036.72327027671090557964967903171136:50001231000000:2800:BD65EECD4639A6CF20B511DFB595935A4813288DBDAF99A076D7121FEEF15FF9.gif" title="点击放大" width="266"></span></p> <p>动图拍摄是一项能够记录照片前后短时动态画面的功能，为用户带来更具临场感与故事性的拍摄体验。在进行动图拍摄前，需首先通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#ismovingphotosupported12" target="_blank">isMovingPhotoSupported()</a>接口判断设备是否支持该功能。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L408-L418" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Check whether support moving photo or not</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">isMovingPhotoSupported</span>(<span class="hljs-attr">photoOutput</span>: camera.<span class="hljs-property">PhotoOutput</span>): <span class="hljs-built_in">boolean</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">isSupported</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    isSupported = photoOutput.<span class="hljs-title function_">isMovingPhotoSupported</span>();</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`The isMovingPhotoSupported call failed. error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> isSupported;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L408-L418" target="_blank">PhotoManager.ets</a></div></div></div></div> <p>若支持，则可通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-photooutput#enablemovingphoto12" target="_blank">enableMovingPhoto()</a>接口来开启或关闭动图拍摄模式。</p> <div class="screenLinkPre"><div _ngcontent-det-c106="" class="highlight-div"><div _ngcontent-det-c106="" class="highlight-div-header"><div _ngcontent-det-c106="" class="highlight-div-header-left"><div _ngcontent-det-c106="" class="handle-button expand-button"><div _ngcontent-det-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-det-c106="" class="highlight-div-header-right"><div _ngcontent-det-c106="" class="handle-button ai-button"></div><div _ngcontent-det-c106="" class="handle-button line-button"><div _ngcontent-det-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-det-c106="" class="handle-button theme-button"><div _ngcontent-det-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-det-c106="" class="handle-button copy-button"><div _ngcontent-det-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-det-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L422-L430" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Enable moving photo</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">enableMovingPhoto</span>(<span class="hljs-attr">enabled</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">enableMovingPhoto</span>(enabled);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`The enableMovingPhoto call failed. error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PhotoManager.ets#L422-L430" target="_blank">PhotoManager.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section841042445115">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section841042445115" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CustomCamera" target="_blank">自定义相机开发</a></li></ul> </div> </div> <div></div></div>