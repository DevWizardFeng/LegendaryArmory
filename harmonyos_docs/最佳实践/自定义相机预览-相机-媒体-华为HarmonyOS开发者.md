<h1 _ngcontent-dje-c119="" class="doc-title ng-star-inserted" title="自定义相机预览"> 自定义相机预览 </h1>

<div _ngcontent-dje-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1112145091613">概述<i class="anchor-icon anchor-icon-link" anchorid="section1112145091613" tips="复制节点链接"></i></h2><p>在移动设备普及的今天，相机已成为人们生活中不可或缺的工具。在移动端开发中，自定义相机具有极高的实用价值，开发者能够根据不同的应用场景和用户需求，定制独特的拍摄功能与交互体验。</p> <p>如果开发者仅需调用系统相机拍摄照片或录制视频，可直接使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-camerapicker" target="_blank">CameraPicker</a>。但构建高度自定义的相机应用或实现对相机数据流进行实时分析等复杂功能时，则需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/camera-api" target="_blank">Camera Kit</a>（相机服务）访问和操作相机硬件来实现。</p> <p>相机预览是相机镜头采集画面的实时展示，为后续的拍照、录像等操作提供基础。本文将对实现基础预览、预览画面的调整（如镜头切换、设置闪光灯、调焦、对焦等）、预览进阶功能（网格线、水平仪等）、获取预览帧数据四个章节进行讲解，提供自定义相机预览部分由基础到进阶的开发实践。</p> </div> <div class="tiledSection"><h2 id="section2032234892514">实现基础预览<i class="anchor-icon anchor-icon-link" anchorid="section2032234892514" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section05330496813" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section05330496813" tips="复制节点链接"></i></h3><p>基础预览是自定义相机核心的功能，用户打开相机应用后，首先看到的就是实时的预览画面，该功能为画面调整、拍摄等操作提供基础。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.47046159330300823492292669982707:50001231000000:2800:FC49764A41E544248E2F26BDE4499DD1A8FD566CD39177D4A4DD01AE73E4BA41.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section1838402234912">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1838402234912" tips="复制节点链接"></i></h3><p><strong>关键技术</strong></p> <ul><li>Surface：图像数据缓冲区的抽象概念。</li></ul> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>：用于满足开发者较为复杂的自定义渲染需求的渲染组件。为相机提供Surface，相机将预览流数据写入Surface，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>从Surface读取数据并显示。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/camera-api" target="_blank">Camera Kit</a>：用于相机设备管理，相机输出流管理以及相机会话管理。相机会话用于配置输入流和输出流，以及设置闪光灯、焦距等参数。</li></ul> <p><strong>开发流程</strong></p> <ol><li>申请权限。</li><li>获取相机设备，创建并启动相机输入流。</li><li>使用XComponent创建Surface，并获取surfaceId。</li><li>创建预览输出流。</li><li>配置相机会话Session并启动。</li></ol> <p><span><img height="588.8254627227124" originheight="1152" originwidth="1800" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163032.58922475339783288029706387189600:50001231000000:2800:755848E93484A1FD224152AA4397E2B5580DD578E243A1112B196F3CCFB74BA8.png" title="点击放大" width="920"></span></p> </div> <div class="tiledSection"><h3 id="section422717541386">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section422717541386" tips="复制节点链接"></i></h3><ol><li>在使用相机相关功能前，需要申请ohos.permission.CAMERA相机权限。申请权限分为以下两步。<p>在module.json5中配置该权限，更多相机权限参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/camera-preparation-V5#申请权限" target="_blank">相机开发准备</a>。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/module.json5#L37-L106" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.CAMERA"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:permission_CAMERA"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ]</li><li>    }</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li><li>]</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/module.json5#L37-L106" target="_blank">module.json5</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestpermissionsfromuser9" target="_blank">AtManager.requestPermissionsFromUser()</a>方法拉起弹窗请求用户授权，若用户拒绝则使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-abilityaccessctrl#requestpermissiononsetting12" target="_blank">requestPermissionOnSetting()</a>方法拉起权限设置弹窗，二次向用户申请授权。具体授权逻辑可根据业务自行调整，可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-permission-application" target="_blank">应用权限申请</a>。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/PermissionManager.ets#L22-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">PermissionManager</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-attr">atManager</span>: abilityAccessCtrl.<span class="hljs-property">AtManager</span> = abilityAccessCtrl.<span class="hljs-title function_">createAtManager</span>();</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">request</span>(<span class="hljs-params">permissions: Permissions[], context: Context</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PermissionManager</span>.<span class="hljs-property">atManager</span>.<span class="hljs-title function_">requestPermissionsFromUser</span>(context, permissions);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">grantStatus</span>: <span class="hljs-built_in">number</span>[] = data.<span class="hljs-property">authResults</span>;</li><li>      <span class="hljs-keyword">const</span> deniedPermissions = permissions.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> grantStatus[i] !== <span class="hljs-number">0</span>);</li><li>      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> permission <span class="hljs-keyword">of</span> deniedPermissions) {</li><li>        <span class="hljs-keyword">const</span> secondGrantStatus = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PermissionManager</span>.<span class="hljs-property">atManager</span>.<span class="hljs-title function_">requestPermissionOnSetting</span>(context, [permission]);</li><li>        <span class="hljs-keyword">if</span> (secondGrantStatus[<span class="hljs-number">0</span>] !== <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'permission denied'</span>);</li><li>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'permission denied'</span>);</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`request failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/PermissionManager.ets#L22-L42" target="_blank">PermissionManager.ets</a></div></div></div></div> </li><li>获取相机设备，创建并启动相机输入流。<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-f#cameragetcameramanager" target="_blank">camera.getCameraManager()</a>方法获取cameraManager实例。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-ini" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L35-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">this.cameraManager</span> = camera.getCameraManager(context)<span class="hljs-comment">;</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L35-L35" target="_blank">CameraManager.ets</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#getsupportedcameras" target="_blank">camera.getSupportedCameras()</a>方法获取相机设备列表。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraposition" target="_blank">camera.CameraPosition</a>类型获取对应的相机设备。CAMERA_POSITION_BACK表示后置镜头，CAMERA_POSITION_FRONT表示前置镜头。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L138-L150" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getCameraDevice</span>(<span class="hljs-params">cameraPosition: camera.CameraPosition</span>) {</li><li>  <span class="hljs-keyword">const</span> cameraDevices = <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraManager</span>?.<span class="hljs-title function_">getSupportedCameras</span>();</li><li>  <span class="hljs-keyword">if</span> (!cameraDevices) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get camera device. cameraPosition: <span class="hljs-subst">${cameraPosition}</span>}`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">const</span> device = cameraDevices?.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">device</span> =&gt;</span> device.<span class="hljs-property">cameraPosition</span> === cameraPosition) || cameraDevices[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">if</span> (!device) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to get camera device. cameraPosition: <span class="hljs-subst">${cameraPosition}</span>}`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> device;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L138-L150" target="_blank">CameraManager.ets</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createcamerainput" target="_blank">camera.createCameraInput()</a>方法创建该相机设备的输入流并打开相机。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L71-L72" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.cameraInput = <span class="hljs-keyword">this</span>.cameraManager?.createCameraInput(device);</li><li>await <span class="hljs-keyword">this</span>.cameraInput?.<span class="hljs-keyword">open</span>();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L71-L72" target="_blank">CameraManager.ets</a></div></div></div></div> </li><li id="li181871531143817">创建Surface。<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件渲染预览画面。指定其type属性为SURFACE。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#getxcomponentsurfaceid9" target="_blank">getXComponentSurfaceId()</a>方法获取surfaceId。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#setxcomponentsurfacerect12" target="_blank">setXComponentSurfaceRect()</a>方法设置surface的宽高属性为预览画面显示区域的宽高。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent#setxcomponentsurfacerotation12" target="_blank">setXComponentSurfaceRotation()</a>方法锁定surface在屏幕旋转时的方向。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>未设置surface宽高时其取值为XComponent组件宽高。建议显式设置surface宽高而不是依赖XComponent宽高，防止surface宽高不对导致画面畸变。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L137-L160" data-highlighted="yes"><ol class="linenums"><li>XComponent({</li><li>  type: XComponentType.SURFACE,</li><li>  controller: <span class="hljs-keyword">this</span>.previewVM.xComponentController</li><li>})</li><li>  .onLoad(async () =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.previewVM.surfaceId = <span class="hljs-keyword">this</span>.previewVM.xComponentController.getXComponentSurfaceId();</li><li>    <span class="hljs-keyword">this</span>.previewVM.setPreviewSize();</li><li>    <span class="hljs-keyword">this</span>.previewVM.xComponentController.setXComponentSurfaceRotation({ lock: <span class="hljs-literal">true</span> });</li><li>    <span class="hljs-comment">// ...</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L137-L160" target="_blank">PreviewScreenView.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L272-L280" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setPreviewSize</span>() {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">displaySize</span>: <span class="hljs-title class_">Size</span> = <span class="hljs-variable">WindowUtil</span>.<span class="hljs-title function_">getMaxDisplaySize</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getPreviewRatio</span>());</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">previewSize</span> = <span class="hljs-variable">displaySize</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">xComponentController</span>.<span class="hljs-title function_">setXComponentSurfaceRect</span>({</li><li>    <span class="hljs-variable">surfaceWidth</span>: <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">width</span>,</li><li>    <span class="hljs-variable">surfaceHeight</span>: <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">height</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L272-L280" target="_blank">PreviewViewModel.ets</a></div></div></div></div> </li><li id="li24730464385">创建预览输出流。<ol><li>选择对应的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#scenemode11" target="_blank">camera.SceneMode</a>。拍照模式下的预览选择SceneMode.NORMAL_PHOTO，录像模式下的预览选择SceneMode.NORMAL_VIDEO。</li><li>根据<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#scenemode11" target="_blank">camera.SceneMode</a>获取相机设备的输出能力。</li><li>在输出能力<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameraoutputcapability" target="_blank">CameraOutputCapability</a>类的previewProfiles属性中查找所需规格的预览输出能力previewProfile。在profile的选择上需要注意以下两点：<ul><li>分辨率选择。所选择分辨率要保证宽高比与surface的宽高比一致，避免画面产生畸变。同时根据业务需求和设备性能选择合适的分辨率大小，过小可能导致画面模糊，过大可能导致资源浪费，功耗和内存过高等风险。</li><li>format格式选择。开发者在选择format格式时需要与后续处理相机buffer数据的像素格式保持一致，避免画面产生异常。</li></ul> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createpreviewoutput" target="_blank">CameraManager.createPreviewOutput()</a>方法创建预览输出流。</li></ol> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L39-L64" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">createOutput</span>(<span class="hljs-params">config: CreateOutputConfig</span>) {</li><li>  <span class="hljs-keyword">const</span> cameraOutputCap = config.<span class="hljs-property">cameraManager</span>?.<span class="hljs-title function_">getSupportedOutputCapability</span>(config.<span class="hljs-property">device</span>, config.<span class="hljs-property">sceneMode</span>);</li><li>  <span class="hljs-keyword">const</span> displayRatio = config.<span class="hljs-property">profile</span>.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / config.<span class="hljs-property">profile</span>.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>  <span class="hljs-keyword">const</span> profileWidth = config.<span class="hljs-property">profile</span>.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>  <span class="hljs-keyword">const</span> previewProfile = cameraOutputCap?.<span class="hljs-property">previewProfiles</span></li><li>    .<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(a.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth) - <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(b.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> - profileWidth))</li><li>    .<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">pf</span> =&gt;</span> {</li><li>      <span class="hljs-keyword">const</span> pfDisplayRatio = pf.<span class="hljs-property">size</span>.<span class="hljs-property">width</span> / pf.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>      <span class="hljs-keyword">return</span> pf.<span class="hljs-property">format</span> === config.<span class="hljs-property">profile</span>.<span class="hljs-property">format</span></li><li>        &amp;&amp; <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(pfDisplayRatio - displayRatio) &lt;= <span class="hljs-title class_">CameraConstant</span>.<span class="hljs-property">PROFILE_DIFFERENCE</span>;</li><li>    });</li><li>  <span class="hljs-keyword">if</span> (!previewProfile) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Failed to get preview profile'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = config.<span class="hljs-property">cameraManager</span>?.<span class="hljs-title function_">createPreviewOutput</span>(previewProfile, config.<span class="hljs-property">surfaceId</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addOutputListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`createPreviewOutput failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L39-L64" target="_blank">PreviewManager.ets</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>以直板机后置相机为例，在设备自然方向下，相机的后置镜头安装角度为90度（不同设备的相机安装角度可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#cameradevice" target="_blank">CameraDevice.cameraOrientation</a>获取），屏幕旋转角度为0度。所以输出能力profile中的宽高与预览显示区域或surface的宽高比例是倒置的。例如在显示区域宽高为1080*1920，所需查找profile的宽高为1920*1080。横屏显示方向下，profile宽高与预览显示区域或surface的宽高比例保持一致。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L248-L268" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Get the camera's width, height, and format params.</span></li><li><span class="hljs-variable">getProfile</span>: (<span class="hljs-variable">cameraOrientation</span>: <span class="hljs-title class_">number</span>) =&gt; <span class="hljs-variable">camera</span>.<span class="hljs-variable">Profile</span> = <span class="hljs-variable">cameraOrientation</span> =&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">displaySize</span>: <span class="hljs-title class_">Size</span> = <span class="hljs-variable">WindowUtil</span>.<span class="hljs-title function_">getMaxDisplaySize</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getPreviewRatio</span>());</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">displayDefault</span>: <span class="hljs-title class_">display</span>.<span class="hljs-title class_">Display</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">displayDefault</span> = <span class="hljs-variable">display</span>.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getDefaultDisplaySync</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-comment">// Get actual rotation angle.</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">displayRotation</span> = (<span class="hljs-variable">displayDefault</span>?.<span class="hljs-variable">rotation</span> ?? <span class="hljs-number">0</span>) * <span class="hljs-number">90</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">isRevert</span> = (<span class="hljs-variable">cameraOrientation</span> + <span class="hljs-variable">displayRotation</span>) % <span class="hljs-number">180</span> !== <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">return</span> {</li><li>    <span class="hljs-variable">format</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraFormat</span>.<span class="hljs-title class_">CAMERA_FORMAT_YUV_420_SP</span>,</li><li>    <span class="hljs-variable">size</span>: {</li><li>      <span class="hljs-variable">height</span>: <span class="hljs-title class_">isRevert</span> ? <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">width</span> : <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">height</span>,</li><li>      <span class="hljs-variable">width</span>: <span class="hljs-title class_">isRevert</span> ? <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">height</span> : <span class="hljs-title class_">displaySize</span>.<span class="hljs-title class_">width</span></li><li>    }</li><li>  };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L248-L268" target="_blank">PreviewViewModel.ets</a></div></div></div></div> </li><li>配置并启动相机会话。<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameramanager#createsession11" target="_blank">CameraManager.createSession()</a>方法创建相机会话Session。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#beginconfig11" target="_blank">Session.beginConfig()</a>方法开始相机会话配置。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addinput11" target="_blank">Session.addInput()</a>方法和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#addoutput11" target="_blank">Session.addOutput()</a>方法分别将相机的输入流和预览输出流配置到相机会话中。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#commitconfig11-1" target="_blank">Session.commitConfig()</a>方法提交相机会话配置信息。</p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#start11-1" target="_blank">Session.start()</a>方法启动相机会话。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L75-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">const</span> session = <span class="hljs-keyword">this</span>.cameraManager?.createSession(sceneMode);</li><li>session?.beginConfig();</li><li>session?.addInput(<span class="hljs-keyword">this</span>.cameraInput);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> outputManager of <span class="hljs-keyword">this</span>.outputManagers) {</li><li>  <span class="hljs-keyword">if</span> (outputManager.isActive) {</li><li>    <span class="hljs-keyword">const</span> output = <span class="hljs-keyword">await</span> outputManager.createOutput(config);</li><li>    session?.addOutput(output);</li><li>  }</li><li>}</li><li><span class="hljs-keyword">await</span> session?.commitConfig();</li><li><span class="hljs-keyword">await</span> session?.start();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L75-L96" target="_blank">CameraManager.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/OutputManager.ets#L28-L33" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OutputManager</span> {</li><li>  <span class="hljs-variable">output</span>?: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraOutput</span>;</li><li>  <span class="hljs-variable">isActive</span>: <span class="hljs-title class_">boolean</span>;</li><li>  <span class="hljs-variable">createOutput</span>: (<span class="hljs-variable">config</span>: <span class="hljs-title class_">CreateOutputConfig</span>) =&gt; <span class="hljs-variable">Promise</span>&lt;<span class="hljs-title class_">camera</span>.<span class="hljs-title class_">CameraOutput</span> | <span class="hljs-title class_">undefined</span>&gt;;</li><li>  <span class="hljs-variable">release</span>: () =&gt; <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt;;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/OutputManager.ets#L28-L33" target="_blank">OutputManager.ets</a></div></div></div></div> </li><li>释放资源，注意释放的顺序。<p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-cameraoutput#release-1" target="_blank">CameraOutput.release()</a>方法释放预览输出流。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L97-L105" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`release failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = <span class="hljs-literal">undefined</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L97-L105" target="_blank">PreviewManager.ets</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-camerainput#close-1" target="_blank">CameraInput.close()</a>方法关闭相机，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-session#release11-1" target="_blank">Session.release()</a>方法释放相机会话资源。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L120-L134" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">stop</span>();</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> outputManager <span class="hljs-keyword">of</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">outputManagers</span>) {</li><li>      <span class="hljs-keyword">if</span> (outputManager.<span class="hljs-property">isActive</span>) {</li><li>        <span class="hljs-keyword">await</span> outputManager.<span class="hljs-title function_">release</span>();</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">cameraInput</span>?.<span class="hljs-title function_">close</span>();</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">release</span>();</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`release failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L120-L134" target="_blank">CameraManager.ets</a></div></div></div></div> </li><li>监听预览流状态。<p>注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#onframestart" target="_blank">frameStart</a>预览帧启动和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#onframeend" target="_blank">frameEnd</a>预览帧结束的事件，在事件回调中做对应的业务处理。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L73-L93" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addFrameStartEventListener</span>(<span class="hljs-params">output: camera.PreviewOutput</span>) {</li><li>  output.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameStart'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`FrameStart callback Error, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Preview frame started'</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onPreviewStart</span>();</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">addFrameEndEventListener</span>(<span class="hljs-params">output: camera.PreviewOutput</span>) {</li><li>  output.<span class="hljs-title function_">on</span>(<span class="hljs-string">'frameEnd'</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (err !== <span class="hljs-literal">undefined</span> &amp;&amp; err.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`FrameStart callback Error, errorMessage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Preview frame end'</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L73-L93" target="_blank">PreviewManager.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section338822552612">预览画面调整<i class="anchor-icon anchor-icon-link" anchorid="section338822552612" tips="复制节点链接"></i></h2><p>在基础预览功能之上，自定义相机通常需要具备调整预览画面的能力，包括前后置镜头的切换、调焦、对焦、切换闪光灯模式等核心功能。</p> </div> <div class="tiledSection"><h3 id="section97510491933" class="firsth2">切换前后置镜头<i class="anchor-icon anchor-icon-link" anchorid="section97510491933" tips="复制节点链接"></i></h3><p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.78014819742220570889930462229258:50001231000000:2800:2B1DA9AC79CE8C2DDC31752C669F1A0A6DCF791E7CCF046CF229179C4A1A8AE0.gif" title="点击放大" width="266"></span></p> <p>预览页面中用isFront属性标识前置还是后置镜头，根据isFront获取<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraposition" target="_blank">camera.CameraPosition</a>的值。关于折叠屏CameraPosition的选择可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-camera#section13854163154917" target="_blank">相机硬件差异</a>。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L43-L232" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">isFront</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">getCameraPosition</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFront</span></li><li>    ? camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_FRONT</span></li><li>    : camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_BACK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/viewmodels/PreviewViewModel.ets#L43-L232" target="_blank">PreviewViewModel.ets</a></div></div></div></div> <p>给切换镜头按钮绑定点击事件，在回调函数中先切换isFront属性的状态，获取新的CameraPosition，释放掉输入输出流等相机资源，再重新创建新镜头的输入输出流，并启动相机。参考<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section422717541386">实现基础预览</a>中的2、4、5步骤。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在本示例中，相机和基础预览的启动流程封装在自定义的CameraManager类的start()方法中，相机资源及输入输出流的释放封装在release()方法中。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/OperateButtonsView.ets#L220-L240" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li>toggleCameraPositionButton() {</li><li>  Image($r(<span class="hljs-string">'app.media.toggle_position'</span>))</li><li>    .width(<span class="hljs-number">48</span>)</li><li>    .height(<span class="hljs-number">48</span>)</li><li>    .onClick(async () =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">this</span>.previewVM.isFront = !<span class="hljs-keyword">this</span>.previewVM.isFront;</li><li>      <span class="hljs-keyword">const</span> cameraPosition = <span class="hljs-keyword">this</span>.previewVM.getCameraPosition();</li><li>      <span class="hljs-keyword">const</span> sceneMode = <span class="hljs-keyword">this</span>.previewVM.getSceneMode();</li><li>      await <span class="hljs-keyword">this</span>.previewVM.cameraManagerRelease();</li><li>      await <span class="hljs-keyword">this</span>.previewVM.cameraManagerStart(cameraPosition, sceneMode);</li><li>      <span class="hljs-comment">// ...</span></li><li>    })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/OperateButtonsView.ets#L220-L240" target="_blank">OperateButtonsView.ets</a></div></div></div></div> <p>实现前后置切换转场动效可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-animation" target="_blank">相机基础动效</a>。</p> </div> <div class="tiledSection"><h3 id="section1860863113213">设置相机焦距<i class="anchor-icon anchor-icon-link" anchorid="section1860863113213" tips="复制节点链接"></i></h3><p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.91741464171844702249473824300057:50001231000000:2800:B7B86DAB0F2B5BCBB5D9B3213C0D4B52FC3682526994B5A9346EF8A727D514CC.gif" title="点击放大" width="266"></span></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-zoomquery#getzoomratiorange11" target="_blank">getZoomRatioRange()</a>方法获取当前相机设备支持设置的焦距范围，根据业务需求在页面上生成相应焦距的按钮。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L154-L162" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getZoomRange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>!.<span class="hljs-title function_">getZoomRatioRange</span>();</li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getZoomRange failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span> [];</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L154-L162" target="_blank">CameraManager.ets</a></div></div></div></div> <p>在点击焦距按钮事件的回调函数中使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-zoom#setsmoothzoom11" target="_blank">setSmoothZoom()</a>方法平滑变焦到按钮对应的焦距。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L228-L235" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setSmoothZoom</span>(<span class="hljs-params">zoom: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setSmoothZoom</span>(zoom);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setSmoothZoom error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L228-L235" target="_blank">CameraManager.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section9696119411">设置闪光灯<i class="anchor-icon anchor-icon-link" anchorid="section9696119411" tips="复制节点链接"></i></h3><p><span><img height="549.1969" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.44003941195055829452855681404254:50001231000000:2800:4991E7B82747BD56AC34F6B4DD5CF04DF6D28757823A89F9C1CCD0D7847C7E12.gif" title="点击放大" width="266"></span></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-flash#setflashmode11" target="_blank">setFlashMode()</a>方法设置闪光灯模式，在设置前需使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-flashquery#isflashmodesupported11" target="_blank">isFlashModeSupported()</a>方法检测设备是否支持设置所选闪光灯模式。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L239-L251" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setFlashMode</span>(<span class="hljs-params">flashMode: camera.FlashMode</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> isSupported = <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">isFlashModeSupported</span>(flashMode);</li><li>    <span class="hljs-keyword">if</span> (!isSupported) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`setFlashMode error: flash mode <span class="hljs-subst">${flashMode}</span> is not supported`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setFlashMode</span>(flashMode);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setFlashMode error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L239-L251" target="_blank">CameraManager.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section2356188242">实现点击对焦<i class="anchor-icon anchor-icon-link" anchorid="section2356188242" tips="复制节点链接"></i></h3><p>点击预览区域，以点击处为焦点进行对焦，并显示对焦框。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.77780558732074416641934973468915:50001231000000:2800:754C2C43E53B2AFD3CCF99742138B82D52F74485618CB12B7E5AB752103180E4.gif" title="点击放大" width="266"></span></p> </div> <p>设置焦点<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-i#point" target="_blank">camera.Point</a>的坐标是以充电口在右侧时横向设备方向为基准，该坐标系左上角为{ 0，0 }，右下角为{ 1，1 }。</p> <p>设备自然方向上，触碰获取的坐标是以充电口在下方时的竖向方向为基准，因此需要进行坐标系的转换。</p> <p>设触碰点为{ x, y }，预览区域宽高为{ w, h }。</p> <ul><li>屏幕旋转角度为0：由下图可知，在焦点所处相机画面坐标系中，触碰点距原点在x轴方向的距离为y，在y轴方向的距离为w - x。由于该坐标系为0-1坐标系，所以实际焦点坐标为{ y / h, (w - x) / w }，即{ y / h, 1 - x / w }。</li></ul> <p><span><img height="570.9749850000001" originheight="1216" originwidth="1900" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.96857202191722915534768611299817:50001231000000:2800:EA51330C598E66B28B8C96173D7F134FD0441DCC21CE3B65A2DF8DFED1741964.png" title="点击放大" width="887.130615"></span></p> <p>同理，其他屏幕旋转方向上焦点坐标同可以计算出：</p> <ul><li>屏幕旋转角度为90：焦点坐标为{ 1 - x / w, 1 - y / h }。</li><li>屏幕旋转角度为180：焦点坐标为{ 1 - y / h, x / w }。</li><li>屏幕旋转角度为270：焦点坐标为{ x / w, y / h }。</li></ul> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L139-L158" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">calCameraPoint</span>(<span class="hljs-variable">eventX</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">eventY</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Point</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">displayDefault</span>: <span class="hljs-title class_">display</span>.<span class="hljs-title class_">Display</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">displayDefault</span> = <span class="hljs-variable">display</span>.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'calCameraPoint'</span>, `<span class="hljs-variable">calCameraPoint</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">displayRotation</span> = (<span class="hljs-variable">displayDefault</span>?.<span class="hljs-variable">rotation</span> ?? <span class="hljs-number">0</span>) * <span class="hljs-number">90</span>;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">displayRotation</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-keyword">return</span> { <span class="hljs-variable">x</span>: <span class="hljs-title class_">eventY</span> / <span class="hljs-variable">height</span>, <span class="hljs-variable">y</span>: <span class="hljs-number">1</span> - <span class="hljs-title class_">eventX</span> / <span class="hljs-variable">width</span> };</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">displayRotation</span> === <span class="hljs-number">90</span>) {</li><li>    <span class="hljs-keyword">return</span> { <span class="hljs-variable">x</span>: <span class="hljs-number">1</span> - <span class="hljs-title class_">eventX</span> / <span class="hljs-variable">width</span>, <span class="hljs-variable">y</span>: <span class="hljs-number">1</span> - <span class="hljs-title class_">eventY</span> / <span class="hljs-variable">height</span> };</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">displayRotation</span> === <span class="hljs-number">180</span>) {</li><li>    <span class="hljs-keyword">return</span> { <span class="hljs-variable">x</span>: <span class="hljs-number">1</span> - <span class="hljs-title class_">eventY</span> / <span class="hljs-variable">height</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">eventX</span> / <span class="hljs-variable">width</span> };</li><li>  }</li><li>  <span class="hljs-keyword">return</span> { <span class="hljs-variable">x</span>: <span class="hljs-title class_">eventX</span> / <span class="hljs-variable">width</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">eventY</span> / <span class="hljs-variable">height</span> };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L139-L158" target="_blank">CommonUtil.ets</a></div></div></div></div> <p>在相机会话启动后，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-focus#setfocusmode11" target="_blank">setFocusMode()</a>方法设置对焦模式为FOCUS_MODE_AUTO，以支持对焦点设置。在设置前需检测相机是否支持该对焦模式。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L166-L178" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setFocusMode</span>(<span class="hljs-params">focusMode: camera.FocusMode</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> isSupported = <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">isFocusModeSupported</span>(focusMode);</li><li>    <span class="hljs-keyword">if</span> (!isSupported) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`setFocusMode error: focus mode <span class="hljs-subst">${focusMode}</span> is not supported`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setFocusMode</span>(focusMode);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setFocusMode error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L166-L178" target="_blank">CameraManager.ets</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-focus#setfocuspoint11" target="_blank">setFoucusPoint()</a>方法实现点击对焦。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L182-L189" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setFocusPoint</span>(<span class="hljs-params">point: camera.Point</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setFocusPoint</span>(point);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setFocusPoint error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L182-L189" target="_blank">CameraManager.ets</a></div></div></div></div> <p>根据预览区域宽高、对焦框宽高以及触碰点的坐标计算对焦框相对预览区域的位置，注意不要超出预览区域的边界。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L64-L86" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// cal absolute position in parent area</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">getClampedChildPosition</span>(<span class="hljs-variable">childSize</span>: <span class="hljs-title class_">Size</span>, <span class="hljs-variable">parentSize</span>: <span class="hljs-title class_">Size</span>, <span class="hljs-variable">point</span>: <span class="hljs-title class_">Point</span>): <span class="hljs-title class_">Edges</span> {</li><li>  <span class="hljs-comment">// center point</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">left</span> = <span class="hljs-variable">point</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">childSize</span>.<span class="hljs-variable">width</span> / <span class="hljs-number">2</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">top</span> = <span class="hljs-variable">point</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">childSize</span>.<span class="hljs-variable">height</span> / <span class="hljs-number">2</span>;</li><li>  <span class="hljs-comment">// limit in left</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">left</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">left</span> = <span class="hljs-number">0</span>;</li><li>  }</li><li>  <span class="hljs-comment">// limit in right</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">left</span> + <span class="hljs-variable">childSize</span>.<span class="hljs-variable">width</span> &gt; <span class="hljs-variable">parentSize</span>.<span class="hljs-variable">width</span>) {</li><li>    <span class="hljs-variable">left</span> = <span class="hljs-variable">parentSize</span>.<span class="hljs-variable">width</span> - <span class="hljs-variable">childSize</span>.<span class="hljs-variable">width</span>;</li><li>  }</li><li>  <span class="hljs-comment">// limit in top</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">top</span> &lt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">top</span> = <span class="hljs-number">0</span>;</li><li>  }</li><li>  <span class="hljs-comment">// limit in bottom</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">top</span> + <span class="hljs-variable">childSize</span>.<span class="hljs-variable">height</span> &gt; <span class="hljs-variable">parentSize</span>.<span class="hljs-variable">height</span>) {</li><li>    <span class="hljs-variable">top</span> = <span class="hljs-variable">parentSize</span>.<span class="hljs-variable">height</span> - <span class="hljs-variable">childSize</span>.<span class="hljs-variable">height</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> { <span class="hljs-variable">left</span>, <span class="hljs-variable">top</span> };</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L64-L86" target="_blank">CommonUtil.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1850914516145">设置曝光区域中心点<i class="anchor-icon anchor-icon-link" anchorid="section1850914516145" tips="复制节点链接"></i></h3><p>点击预览区域，设置点击处为曝光中心点。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163033.23508008413030359669843861492023:50001231000000:2800:837B1C448A8CB8C5C0DAB641E48040B39F2BF9C0D66F690476E6E7089F7EE361.gif" title="点击放大" width="266"></span></p> <p>在相机会话启动后，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-autoexposure#setexposuremode11" target="_blank">setExposureMode()</a>方法设置曝光模式为EXPOSURE_MODE_AUTO，以支持曝光区域中心点设置。在设置前需检测相机是否支持该曝光模式。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L193-L205" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setExposureMode</span>(<span class="hljs-params">exposureMode: camera.ExposureMode</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">const</span> isSupported = <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">isExposureModeSupported</span>(exposureMode);</li><li>    <span class="hljs-keyword">if</span> (!isSupported) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`setExposureMode error: focus mode <span class="hljs-subst">${exposureMode}</span> is not supported`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setExposureMode</span>(exposureMode);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setExposureMode error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L193-L205" target="_blank">CameraManager.ets</a></div></div></div></div> <p>点击屏幕预览区域，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-autoexposure#setmeteringpoint11" target="_blank">setMeteringPoint()</a>方法设置曝光区域中心点。屏幕布局坐标和相机坐标之间的转换逻辑详见<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section2356188242">实现点击对焦</a>小节。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L209-L216" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setMeteringPoint</span>(<span class="hljs-params">point: camera.Point</span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">session</span>?.<span class="hljs-title function_">setMeteringPoint</span>(point);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'setMeteringPoint error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L209-L216" target="_blank">CameraManager.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section56481240219">设置预览帧率<i class="anchor-icon anchor-icon-link" anchorid="section56481240219" tips="复制节点链接"></i></h3><p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163034.30119642340980081852538572613719:50001231000000:2800:99450A21E6010B13B0CC01E1484293FC4FDF4C9EBFA3A10DF1BF4ED16150F136.gif" title="点击放大" width="266"></span></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getsupportedframerates12" target="_blank">PreivewOutput.getSupportedFrameRates()</a>方法获取预览流支持的帧率范围。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L109-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">getSupportedFrameRates</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">getSupportedFrameRates</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L109-L112" target="_blank">PreviewManager.ets</a></div></div></div></div> <p>在帧率切换按钮点击事件的回调函数中，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#setframerate12" target="_blank">PreviewOutput.setFrameRate()</a>方法对预览帧率进行动态调整。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L116-L123" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setFrameRate</span>(<span class="hljs-params">minFps: <span class="hljs-built_in">number</span>, maxFps: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>?.<span class="hljs-title function_">setFrameRate</span>(minFps, maxFps);</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'setFrameRate error '</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(e));</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/PreviewManager.ets#L116-L123" target="_blank">PreviewManager.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section42512411270">实现预览进阶功能<i class="anchor-icon anchor-icon-link" anchorid="section42512411270" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section91664343715" class="firsth2">实现手势缩放<i class="anchor-icon anchor-icon-link" anchorid="section91664343715" tips="复制节点链接"></i></h3><p>在预览画面进行手势捏合操作，预览画面焦距会随捏合手势进行对应缩放调整。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163034.55386927286794741769715578203351:50001231000000:2800:5E2233130E32C6DD32664EE367D39F820BD069CC2027F2F65A28F1906790D562.gif" title="点击放大" width="266"></span></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pinchgesture" target="_blank">PinchGesture()</a>接口给预览区域元素绑定捏合事件。</p> <p>在捏合手势识别成功onActionStart()事件的回调函数中，记录此次捏合前的焦距。在手势移动过程中onActionUpdate()事件的回调函数中，根据捏合前的焦距以及缩放比例计算出当前的焦距，注意限制在当前相机设备的焦距范围内。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L138-L181" data-highlighted="yes"><ol class="linenums"><li>XComponent({</li><li>  type: XComponentType.SURFACE,</li><li>  controller: <span class="hljs-keyword">this</span>.previewVM.xComponentController</li><li>})</li><li><span class="hljs-comment">// ...</span></li><li>  .gesture(</li><li>    <span class="hljs-comment">// Adjust focus with two fingers pinchGesture.</span></li><li>    PinchGesture({ fingers: <span class="hljs-number">2</span> })</li><li>      .onActionStart(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.originZoomBeforePinch = <span class="hljs-keyword">this</span>.previewVM.currentZoom;</li><li>        <span class="hljs-keyword">this</span>.isZoomPinching = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">this</span>.sleepTimer?.refresh();</li><li>      })</li><li>      .onActionUpdate((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.previewVM.isVideoMode() &amp;&amp; <span class="hljs-keyword">this</span>.previewVM.isStabilizationEnabled) {</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">const</span> targetZoom = <span class="hljs-keyword">this</span>.originZoomBeforePinch * event.scale;</li><li>        <span class="hljs-keyword">this</span>.previewVM.currentZoom = limitNumberInRange(targetZoom, <span class="hljs-keyword">this</span>.previewVM.zoomRange);</li><li>        <span class="hljs-keyword">this</span>.previewVM.setCameraZoomRatio();</li><li>      })</li><li>      .onActionEnd(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.isZoomPinching = <span class="hljs-literal">false</span>;</li><li>      })</li><li>  )</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L138-L181" target="_blank">PreviewScreenView.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section12881151312387">网格线<i class="anchor-icon anchor-icon-link" anchorid="section12881151312387" tips="复制节点链接"></i></h3><p>将相机预览画面划分为9个等比例区域（3×3宫格），为用户提供精准的构图参考框架。</p> <p><span><img height="551.7638000000001" originheight="2307" originwidth="1112" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163034.80649222774897149233623372679338:50001231000000:2800:BB8B06789B72F3355A43696A86140A6C87E2B9208B7DD4805F99842C7C48C535.png" title="点击放大" width="266"></span></p> <p>获取预览区域的宽高，通过行数和列数计算出每条网格线的起始坐标，在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-canvas-canvas" target="_blank">Canvas</a>上进行绘制。注意设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-hit-test-behavior#hittestbehavior" target="_blank">hitTestBehavior</a>属性为HitTestMode.Transparent，不影响下方预览区域的正常交互。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/components/GridLine.ets#L29-L59" data-highlighted="yes"><ol class="linenums"><li>draw() {</li><li>  <span class="hljs-keyword">const</span> ctx = <span class="hljs-keyword">this</span>.context;</li><li>  ctx.strokeStyle = <span class="hljs-keyword">this</span>.strokeStyle;</li><li>  ctx.lineWidth = <span class="hljs-keyword">this</span>.lineWidth;</li><li>  <span class="hljs-keyword">const</span> height = <span class="hljs-keyword">this</span>.context.height;</li><li>  <span class="hljs-keyword">const</span> width = <span class="hljs-keyword">this</span>.context.width;</li><li>  <span class="hljs-comment">// horizontal</span></li><li>  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-keyword">this</span>.cols; i++) {</li><li>    <span class="hljs-keyword">const</span> x = (width / <span class="hljs-keyword">this</span>.cols) * i;</li><li>    ctx.beginPath();</li><li>    ctx.moveTo(x, <span class="hljs-number">0</span>);</li><li>    ctx.lineTo(x, height);</li><li>    ctx.stroke();</li><li>  }</li><li>  <span class="hljs-comment">// vertical</span></li><li>  <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-keyword">this</span>.rows; i++) {</li><li>    <span class="hljs-keyword">const</span> y = (height / <span class="hljs-keyword">this</span>.rows) * i;</li><li>    ctx.beginPath();</li><li>    ctx.moveTo(<span class="hljs-number">0</span>, y);</li><li>    ctx.lineTo(width, y);</li><li>    ctx.stroke();</li><li>  }</li><li>}</li><li>
</li><li>build() {</li><li>  Canvas(<span class="hljs-keyword">this</span>.context)</li><li>    .width(<span class="hljs-string">'100%'</span>)</li><li>    .height(<span class="hljs-string">'100%'</span>)</li><li>    .hitTestBehavior(HitTestMode.Transparent)</li><li>    .onReady(() =&gt; <span class="hljs-keyword">this</span>.draw())</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/components/GridLine.ets#L29-L59" target="_blank">GridLine.ets</a></div></div></div></div> <p>用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-stack" target="_blank">Stack</a>组件将网格线组件堆叠在预览区域上层。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L133-L245" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-built_in">Stack</span>({</li><li>  alignContent: Alignment.Center</li><li>}) {</li><li>  <span class="hljs-built_in">XComponent</span>({</li><li>    type: XComponentType.SURFACE,</li><li>    controller: this.previewVM.xComponentController</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li><li>  if (this.previewVM.isGridLineVisible) {</li><li>    <span class="hljs-built_in">GridLine</span>()</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  if (this.isShowBlack) {</li><li>    <span class="hljs-built_in">Column</span>()</li><li>      <span class="hljs-selector-class">.id</span>('black')</li><li>      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')</li><li>      <span class="hljs-selector-class">.backgroundColor</span>(Color.Black)</li><li>      <span class="hljs-selector-class">.opacity</span>(this.flashBlackOpacity)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L133-L245" target="_blank">PreviewScreenView.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section41351228135313">水平仪<i class="anchor-icon anchor-icon-link" anchorid="section41351228135313" tips="复制节点链接"></i></h3><p>设备旋转过程中，水平仪指示线始终垂直于重力方向，当设备水平时（<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#li1828535618615">x轴</a>或<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#li143717461818">y轴</a>垂直于重力方向），水平仪指示线由虚线变为实线。</p> <p><span><img height="551.7638000000001" originheight="2307" originwidth="1112" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163034.22564528111072172452833282105702:50001231000000:2800:CA0F5FDAB8B8C424148107791716A8579C558B6C1C4278A04F6C13B3E44B2EE5.png" title="点击放大" width="266"></span></p> <p>水平仪的实现需要用到重力加速度传感器。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-sensor" target="_blank">sensor</a>模块获取重力加速度在x, y, z轴方向上的分量。以充电口在下的竖屏方向为基准，x, y, z轴的方向如下。</p> <ul><li id="li1828535618615">x轴：水平向右。</li><li id="li143717461818">y轴：垂直向上。</li><li>z轴：垂直于屏幕向外。</li></ul> <p>由下图可知，水平仪指示线与x轴的夹角用θ表示，若要指示线始终垂直重力方向，则tanθ = g(x) / -g(y)。</p> <p><span><img height="500.466764" originheight="765" originwidth="616" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163034.97955250097965253160960923504467:50001231000000:2800:86A68366FB7090FAB481379C8D4F58F15AA7E86C3DCC75DB853BBFE024A98915.png" title="点击放大" width="402.99"></span></p> <p>在module.json5中配置加速度传感器权限。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/module.json5#L38-L107" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  <span class="hljs-comment">// ...</span></li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.ACCELEROMETER"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:permission_SENSOR"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ]</li><li>    }</li><li>  }</li><li>]</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/module.json5#L38-L107" target="_blank">module.json5</a></div></div></div></div> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-sensor#sensoron" target="_blank">sensor.on()</a>方法订阅重力加速度传感器数据。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L72-L82" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Add a gravity sensor listener callback function.</span></li><li><span class="hljs-title function_">addGravityEventListener</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    sensor.<span class="hljs-title function_">on</span>(sensor.<span class="hljs-property">SensorId</span>.<span class="hljs-property">GRAVITY</span>, <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewVM</span>.<span class="hljs-property">acc</span> = data;</li><li>    }, { <span class="hljs-attr">interval</span>: <span class="hljs-number">100</span> * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> }); <span class="hljs-comment">// 100ms</span></li><li>  } <span class="hljs-keyword">catch</span> (exception) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`addGravityEventListener failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L72-L82" target="_blank">Index.ets</a></div></div></div></div> <p>计算指示线的旋转角度，以及设备是否水平。设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-hit-test-behavior#hittestbehavior" target="_blank">hitTestBehavior</a>属性为HitTestMode.Transparent，不影响下层预览区域的正常交互。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/components/LevelIndicator.ets#L24-L84" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Universal Camera Preview Level Component.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">LevelIndicator</span> {</li><li>  @<span class="hljs-title function_">Prop</span> <span class="hljs-variable">acc</span>: <span class="hljs-title class_">sensor</span>.<span class="hljs-title class_">AccelerometerResponse</span>;</li><li>
</li><li>  <span class="hljs-title function_">getRotate</span>() {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">displayDefault</span>: <span class="hljs-title class_">display</span>.<span class="hljs-title class_">Display</span> | <span class="hljs-title class_">null</span> = <span class="hljs-variable">null</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable">displayDefault</span> = <span class="hljs-variable">display</span>.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">exception</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getDefaultDisplaySync</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">exception</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">rotation</span> = (<span class="hljs-variable">displayDefault</span>?.<span class="hljs-variable">rotation</span> ?? <span class="hljs-number">0</span>) * <span class="hljs-number">90</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">rotation</span> === <span class="hljs-number">90</span> || <span class="hljs-variable">rotation</span> === <span class="hljs-number">270</span>) {</li><li>      <span class="hljs-keyword">return</span> -<span class="hljs-variable">Math</span>.<span class="hljs-title function_">atan2</span>(-<span class="hljs-keyword">this</span>.<span class="hljs-variable">acc</span>.<span class="hljs-variable">y</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">acc</span>.<span class="hljs-variable">x</span>) * (<span class="hljs-number">180</span> / <span class="hljs-variable">Math</span>.<span class="hljs-variable">PI</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> -<span class="hljs-variable">Math</span>.<span class="hljs-title function_">atan2</span>(-<span class="hljs-keyword">this</span>.<span class="hljs-variable">acc</span>.<span class="hljs-variable">x</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">acc</span>.<span class="hljs-variable">y</span>) * (<span class="hljs-number">180</span> / <span class="hljs-variable">Math</span>.<span class="hljs-variable">PI</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">isAlign</span>() {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getRotate</span>()) - <span class="hljs-number">0</span> &lt;= <span class="hljs-title class_">ANGLE_DIFFERENCE</span></li><li>      || <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">getRotate</span>()) - <span class="hljs-number">90</span>) &lt;= <span class="hljs-title class_">ANGLE_DIFFERENCE</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">Center</span> }) {</li><li>      <span class="hljs-title function_">Line</span>({</li><li>        <span class="hljs-variable">width</span>: <span class="hljs-number">200</span>,</li><li>        <span class="hljs-variable">height</span>: <span class="hljs-number">1</span></li><li>      })</li><li>      <span class="hljs-comment">// ...</span></li><li>        .<span class="hljs-title function_">strokeDashArray</span>([<span class="hljs-number">3</span>, <span class="hljs-keyword">this</span>.<span class="hljs-title function_">isAlign</span>() ? <span class="hljs-number">0</span> : <span class="hljs-number">3</span>])</li><li>        .<span class="hljs-title function_">opacity</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">isAlign</span>() ? <span class="hljs-number">1</span> : <span class="hljs-number">0.5</span>)</li><li>        .<span class="hljs-title function_">rotate</span>({ <span class="hljs-variable">angle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getRotate</span>(), <span class="hljs-variable">centerX</span>: <span class="hljs-string">'50%'</span>, <span class="hljs-variable">centerY</span>: <span class="hljs-string">'50%'</span> })</li><li>        .<span class="hljs-title function_">animation</span>({</li><li>          <span class="hljs-variable">curve</span>: <span class="hljs-title class_">curves</span>.<span class="hljs-title class_">springMotion</span>(<span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>),</li><li>          <span class="hljs-variable">iterations</span>: <span class="hljs-number">1</span>,</li><li>          <span class="hljs-variable">playMode</span>: <span class="hljs-title class_">PlayMode</span>.<span class="hljs-title class_">Normal</span></li><li>        })</li><li>      <span class="hljs-title function_">Circle</span>()</li><li>      <span class="hljs-comment">// ...</span></li><li>        .<span class="hljs-title function_">opacity</span>(<span class="hljs-keyword">this</span>.<span class="hljs-title function_">isAlign</span>() ? <span class="hljs-number">1</span> : <span class="hljs-number">0.5</span>)</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    .<span class="hljs-title function_">hitTestBehavior</span>(<span class="hljs-variable">HitTestMode</span>.<span class="hljs-variable">Transparent</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/components/LevelIndicator.ets#L24-L84" target="_blank">LevelIndicator.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section6713144213919">超时暂停预览<i class="anchor-icon anchor-icon-link" anchorid="section6713144213919" tips="复制节点链接"></i></h3><p>若相机在超过特定时间内未进行任何操作，则会暂停预览并显示遮罩。点击遮罩可重新启动预览，避免相机资源长时间浪费，从而降低功耗。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163035.94514138031945552040518474177783:50001231000000:2800:559A87741A50EFB4E82957440E956A159C200EBD12872004BCCD876545E4FBF9.gif" title="点击放大" width="266"></span></p> <p>实现带刷新方法的定时器类，初始化时传入计时结束的回调函数。需要重置计时时间，调用refresh()方法实现。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/RefreshableTimer.ets#L17-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">RefreshableTimer</span> {</li><li>  <span class="hljs-keyword">private</span> timerId?: number;</li><li>  <span class="hljs-keyword">private</span> readonly timeout: number;</li><li>  <span class="hljs-keyword">private</span> callback: () =&gt; void;</li><li>  <span class="hljs-keyword">private</span> isActive: boolean = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-keyword">constructor</span>(callback: () =&gt; void, timeout: number) {</li><li>    <span class="hljs-keyword">this</span>.callback = callback;</li><li>    <span class="hljs-keyword">this</span>.timeout = timeout;</li><li>  }</li><li>
</li><li>  start(): void {</li><li>    <span class="hljs-keyword">this</span>.timerId = setTimeout(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.callback();</li><li>      <span class="hljs-keyword">this</span>.isActive = <span class="hljs-literal">false</span>;</li><li>    }, <span class="hljs-keyword">this</span>.timeout);</li><li>    <span class="hljs-keyword">this</span>.isActive = <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  clear(): void {</li><li>    clearTimeout(<span class="hljs-keyword">this</span>.timerId);</li><li>    <span class="hljs-keyword">this</span>.timerId = undefined;</li><li>    <span class="hljs-keyword">this</span>.isActive = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  refresh(): void {</li><li>    <span class="hljs-keyword">this</span>.clear();</li><li>    <span class="hljs-keyword">this</span>.start();</li><li>  }</li><li>
</li><li>  isRunning(): boolean {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.isActive;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/RefreshableTimer.ets#L17-L50" target="_blank">RefreshableTimer.ets</a></div></div></div></div> <p>预览页面初始化时，启动定时器。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uicontext#getuiobserver11" target="_blank">UIObserver</a>监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-uiobserver#onwillclick12" target="_blank">willClick()</a>事件，30s内如果有操作，则重置定时器，直到30s内无任何操作，设置控制遮罩显隐的状态变量isSleeping为true，并释放相机资源。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L86-L98" data-highlighted="yes"><ol class="linenums"><li>initSleepTimer() {</li><li>  <span class="hljs-keyword">this</span>.sleepTimer = new RefreshableTimer(() =&gt; {</li><li>    <span class="hljs-keyword">this</span>.previewVM.openPreviewBlur();</li><li>    <span class="hljs-keyword">this</span>.isSleeping = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.previewVM.cameraManagerRelease();</li><li>  }, <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>);</li><li>  <span class="hljs-keyword">this</span>.sleepTimer.start();</li><li>  <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">this</span>.getUIContext().getUIObserver();</li><li>  observer.on(<span class="hljs-string">'willClick'</span>, () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.sleepTimer?.refresh();</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L86-L98" target="_blank">Index.ets</a></div></div></div></div> <p>点击遮罩，设置状态变量isSleeping为false并重新启动相机预览。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L159-L179" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Builder</span></li><li>wakeupMask() {</li><li>  Column() {</li><li>    Text($r(<span class="hljs-string">'app.string.wakeup_text'</span>))</li><li>      .fontColor(Color.White)</li><li>      .opacity(<span class="hljs-number">0.6</span>)</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  .onClick(async () =&gt; {</li><li>    <span class="hljs-keyword">this</span>.isSleeping = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-keyword">this</span>.sleepTimer?.refresh();</li><li>    await <span class="hljs-keyword">this</span>.startCamera();</li><li>    <span class="hljs-keyword">this</span>.previewVM.syncButtonSettings();</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L159-L179" target="_blank">Index.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section950183117">前后台切换<i class="anchor-icon anchor-icon-link" anchorid="section950183117" tips="复制节点链接"></i></h3><p>当相机应用在退后台之后由于安全策略会被强制断流。当从后台切换至前台时，需要重启相机设备的预览流、拍照流以及相机会话。</p> <p><span><img height="552.4554" originheight="1080" originwidth="520" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163035.88049393098479532076634931835901:50001231000000:2800:A95DEAF0FBBDC831571C7E88DB64E83344A9079EB37729ED4AFFBB5061CB1A0E.gif" title="点击放大" width="266"></span></p> <p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-applicationcontext#applicationcontextonapplicationstatechange10" target="_blank">ApplicationContext.on('applicationStateChange')</a>方法注册对当前应用前后台状态变化的监听。在切换至后台触发的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-applicationstatechangecallback#applicationstatechangecallbackonapplicationforeground" target="_blank">onApplicationBackground()</a>回调函数中释放相机相关资源。在切换至前台触发的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-applicationstatechangecallback#applicationstatechangecallbackonapplicationbackground" target="_blank">onApplicationForeground()</a>回调函数中重新启动相机及预览。</p> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L102-L125" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">registerApplicationStateChange</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">applicationContext</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'applicationStateChange'</span>, {</li><li>    <span class="hljs-attr">onApplicationForeground</span>: <span class="hljs-keyword">async</span> () =&gt; {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">startCamera</span>();</li><li>      <span class="hljs-comment">// ...</span></li><li>    },</li><li>    <span class="hljs-attr">onApplicationBackground</span>: <span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewVM</span>.<span class="hljs-title function_">cameraManagerRelease</span>();</li><li>    }</li><li>  })</li><li>}</li><li>
</li><li><span class="hljs-comment">// open camera and start session.</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">startCamera</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> cameraPosition = <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewVM</span>.<span class="hljs-title function_">getCameraPosition</span>();</li><li>  <span class="hljs-keyword">const</span> sceneMode = <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewVM</span>.<span class="hljs-title function_">getSceneMode</span>();</li><li>  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">previewVM</span>.<span class="hljs-title function_">cameraManagerStart</span>(cameraPosition, sceneMode);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L102-L125" target="_blank">Index.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section680417314342">预览人脸检测<i class="anchor-icon anchor-icon-link" anchorid="section680417314342" tips="复制节点链接"></i></h3><p>相机拍摄人像时，在预览画面上添加人脸检测框可以辅助对焦和构图。</p> <p><span><img height="549.7422" originheight="2258" originwidth="1092" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163035.77056847184532805981053755084120:50001231000000:2800:4F42895DF4E2CC189449D145CE547CD462DFA9149B7FDE51D3F2AA05C9DD2FBE.png" title="点击放大" width="266"></span></p> <p>相机的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-metadata" target="_blank">元数据</a>输出流携带了人脸检测信息，应用可配置元数据输出流并读取检测信息绘制检测框。相较于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/core-vision-face-detector" target="_blank">基于Core Vision Kit的人脸检测</a>能力，元数据输出流在相机预览时返回数据更快，性能更好，具体对比如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.33.5.1.5.1.1" valign="top" width="22.96%"><p>能力</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.33.5.1.5.1.2" valign="top" width="32.54%"><p>人脸检测能力</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.33.5.1.5.1.3" valign="top" width="22.8%"><p>支持的检测数据来源</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.33.5.1.5.1.4" valign="top" width="21.7%"><p>相机预览场景性能</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="22.96%"><p>基于相机元数据输出流的人脸检测</p> </td> <td class="cellrowborder" valign="top" width="32.54%"><p>人脸位置坐标</p> </td> <td class="cellrowborder" valign="top" width="22.8%"><p>相机预览画面</p> </td> <td class="cellrowborder" valign="top" width="21.7%"><p>检测结果返回快</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="22.96%"><p>基于Core Vision Kit的人脸检测</p> </td> <td class="cellrowborder" valign="top" width="32.54%"><p>人脸位置坐标、人脸五官位置、人脸朝向、人脸置信度</p> </td> <td class="cellrowborder" valign="top" width="22.8%"><p>图像pixelmap</p> </td> <td class="cellrowborder" valign="top" width="21.7%"><p>检测结果返回慢</p> </td> </tr>  </tbody></table></div> </div> <p>使用元数据输出流实现人脸检测开发步骤如下：</p> <ol><li>创建相机元数据输出流。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/MetadataManager.ets#L37-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">createOutput</span>(<span class="hljs-attr">config</span>: <span class="hljs-title class_">CreateOutputConfig</span>): <span class="hljs-title class_">Promise</span>&lt;camera.<span class="hljs-property">CameraOutput</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">const</span> cameraOutputCap = config.<span class="hljs-property">cameraManager</span>?.<span class="hljs-title function_">getSupportedOutputCapability</span>(config.<span class="hljs-property">device</span>, config.<span class="hljs-property">sceneMode</span>);</li><li>  <span class="hljs-keyword">if</span> (!cameraOutputCap) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">'Failed to get supported output capability.'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">metadataObjectTypes</span>: <span class="hljs-title class_">Array</span>&lt;camera.<span class="hljs-property">MetadataObjectType</span>&gt; = cameraOutputCap!.<span class="hljs-property">supportedMetadataObjectTypes</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span> = config.<span class="hljs-property">cameraManager</span>?.<span class="hljs-title function_">createMetadataOutput</span>(metadataObjectTypes);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addOutputListener</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG_LOG</span>, <span class="hljs-string">`Failed to createMetadataOutput, error code: <span class="hljs-subst">${error.code}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/MetadataManager.ets#L37-L53" target="_blank">MetadataManager.ets</a></div></div></div></div> </li><li>将元数据输出流添加到会话中。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L88-L95" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> outputManager of <span class="hljs-keyword">this</span>.outputManagers) {</li><li>  <span class="hljs-keyword">if</span> (outputManager.isActive) {</li><li>    <span class="hljs-keyword">const</span> output = <span class="hljs-keyword">await</span> outputManager.createOutput(config);</li><li>    session?.addOutput(output);</li><li>  }</li><li>}</li><li><span class="hljs-keyword">await</span> session?.commitConfig();</li><li><span class="hljs-keyword">await</span> session?.start();</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/CameraManager.ets#L88-L95" target="_blank">CameraManager.ets</a></div></div></div></div> </li><li>注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-metadataoutput#onmetadataobjectsavailable" target="_blank">on('metadataObjectsAvailable')</a>回调，监听元数据流中的人脸信息。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/dev/camera/src/main/ets/cameramanagers/MetadataManager.ets#L62-L75" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">addMetadataObjectsAvailableListener</span>(<span class="hljs-variable">metadataOutput</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">MetadataOutput</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">metadataOutput</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'metadataObjectsAvailable'</span>,</li><li>    (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">metadataObjectArr</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">camera</span>.<span class="hljs-title class_">MetadataObject</span>&gt;) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> &amp;&amp; <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span> !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG_LOG</span>, `<span class="hljs-variable">Metadata</span> <span class="hljs-variable">output</span> <span class="hljs-variable">on</span> <span class="hljs-variable">metadataObjectsAvailable</span> <span class="hljs-variable">error</span> <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}`);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">boxRectArr</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Rect</span>[] = [];</li><li>    <span class="hljs-variable">metadataObjectArr</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">obj</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">MetadataObject</span>)=&gt;{</li><li>      <span class="hljs-variable">boxRectArr</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">obj</span>.<span class="hljs-variable">boundingBox</span>);</li><li>    });</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">onMetadataObjectsAvailable</span>(<span class="hljs-variable">boxRectArr</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/dev/camera/src/main/ets/cameramanagers/MetadataManager.ets#L62-L75" target="_blank">MetadataManager.ets</a></div></div></div></div> </li><li>通过回调接口返回的归一化数据，计算检测框实际坐标。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>接口返回的坐标数据以预览画面左上角为原点，具体可参考<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#section2356188242">实现点击对焦</a>章节中的页面布局坐标系。</li><li>元数据输出流最多返回10个人脸检测框信息。</li></ul> </div></div></div> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L145-L155" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Face detection information listener callback.</span></li><li>onMetadataObjectsAvailable(faceBoxArr: camera.Rect[]) {</li><li>  faceBoxArr.forEach((value) =&gt; {</li><li>    <span class="hljs-comment">// Convert normalized coordinates to actual coordinates.</span></li><li>    value.topLeftX *= <span class="hljs-keyword">this</span>.previewVM.getPreviewWidth();</li><li>    value.topLeftY *= <span class="hljs-keyword">this</span>.previewVM.getPreviewHeight();</li><li>    value.width *= <span class="hljs-keyword">this</span>.previewVM.getPreviewWidth();</li><li>    value.height *= <span class="hljs-keyword">this</span>.previewVM.getPreviewHeight();</li><li>  })</li><li>  <span class="hljs-keyword">this</span>.previewVM.faceBoundingBoxArr = faceBoxArr;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/pages/Index.ets#L145-L155" target="_blank">Index.ets</a></div></div></div></div> </li><li>计算检测框各边的起点和终点位置坐标。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L90-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Calculate the coordinates of the face detection box.</span></li><li><span class="hljs-variable">export</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">calFaceBoxLinePoint</span>(<span class="hljs-variable">faceBoxRect</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Rect</span>): <span class="hljs-title class_">LinePoint</span>[] {</li><li>  <span class="hljs-comment">// The length of the sides of the box.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">lineLength</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">min</span>(<span class="hljs-variable">faceBoxRect</span>.<span class="hljs-variable">width</span>, <span class="hljs-variable">faceBoxRect</span>.<span class="hljs-variable">height</span>) * <span class="hljs-variable">FACE_BOX_LINE_RATIO</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">linePoints</span>: <span class="hljs-title class_">LinePoint</span>[] = [];</li><li>
</li><li>  <span class="hljs-comment">// The coordinates of the four vertices of the detection box.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">startPoints</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Point</span>[] = [</li><li>    { <span class="hljs-variable">x</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftX</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftY</span> },</li><li>    { <span class="hljs-variable">x</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftX</span> + <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">width</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftY</span> },</li><li>    { <span class="hljs-variable">x</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftX</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftY</span> + <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">height</span> },</li><li>    { <span class="hljs-variable">x</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftX</span> + <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">width</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftY</span> + <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">height</span> }];</li><li>
</li><li>  <span class="hljs-comment">// Calculate the relative coordinates of each edge.</span></li><li>  <span class="hljs-variable">startPoints</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">startPoint</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Point</span>) =&gt; {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">HorizontalLine</span>: <span class="hljs-title class_">LinePoint</span> = {</li><li>      <span class="hljs-variable">start</span>: <span class="hljs-title class_">startPoint</span>,</li><li>      <span class="hljs-variable">increment</span>: { <span class="hljs-variable">x</span>: <span class="hljs-title class_">startPoint</span>.<span class="hljs-title class_">x</span> &gt; <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftX</span> ? -<span class="hljs-title class_">lineLength</span> : <span class="hljs-title class_">lineLength</span>, <span class="hljs-variable">y</span>: <span class="hljs-number">0</span> }</li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">verticalLine</span>: <span class="hljs-title class_">LinePoint</span> = {</li><li>      <span class="hljs-variable">start</span>: <span class="hljs-title class_">startPoint</span>,</li><li>      <span class="hljs-variable">increment</span>: { <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">startPoint</span>.<span class="hljs-title class_">y</span> &gt; <span class="hljs-title class_">faceBoxRect</span>.<span class="hljs-title class_">topLeftY</span> ? -<span class="hljs-title class_">lineLength</span> : <span class="hljs-title class_">lineLength</span> }</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">linePoints</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">HorizontalLine</span>, <span class="hljs-variable">verticalLine</span>);</li><li>  });</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">linePoints</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/utils/CommonUtil.ets#L90-L118" target="_blank">CommonUtil.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-drawing-components-line" target="_blank">Line</a>组件，将人脸检测框绘制到预览画面中。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L117-L128" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-comment">// Face detection box component.</span></li><li><span class="hljs-title function_">faceBox</span>(<span class="hljs-variable">faceBoxRect</span>: <span class="hljs-title class_">camera</span>.<span class="hljs-title class_">Rect</span>) {</li><li>  <span class="hljs-title function_">ForEach</span>(<span class="hljs-title function_">calFaceBoxLinePoint</span>(<span class="hljs-variable">faceBoxRect</span>), (<span class="hljs-variable">linePoint</span>: <span class="hljs-title class_">LinePoint</span>) =&gt; {</li><li>    <span class="hljs-title function_">Line</span>()</li><li>      .<span class="hljs-title function_">startPoint</span>([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>])</li><li>      .<span class="hljs-title function_">endPoint</span>([<span class="hljs-variable">linePoint</span>.<span class="hljs-variable">increment</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">linePoint</span>.<span class="hljs-variable">increment</span>.<span class="hljs-variable">y</span>])</li><li>      .<span class="hljs-title function_">stroke</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-title class_">linePoint</span>.<span class="hljs-title class_">start</span>.<span class="hljs-title class_">x</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">linePoint</span>.<span class="hljs-title class_">start</span>.<span class="hljs-title class_">y</span> })</li><li>  }, (<span class="hljs-variable">linePoint</span>: <span class="hljs-title class_">LinePoint</span>) =&gt; <span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">linePoint</span>));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/entry/src/main/ets/views/PreviewScreenView.ets#L117-L128" target="_blank">PreviewScreenView.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section5677629154619">获取预览帧数据<i class="anchor-icon anchor-icon-link" anchorid="section5677629154619" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section819511370508" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section819511370508" tips="复制节点链接"></i></h3><p>在开发相机应用时，如果预览流仅用于展示，通常使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-xcomponent" target="_blank">XComponent</a>组件实现。若需要获取每帧的图像做二次处理（例如二维码识别或人脸识别等场景），则需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>监听预览流每帧数据，并创建第二路预览流，也称为双路预览。</p> </div> <div class="tiledSection"><h3 id="section62551341155014">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section62551341155014" tips="复制节点链接"></i></h3><p><strong>关键技术</strong></p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>用于创建Surface接收每帧的图像数据。</li><li>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>中的imageArrival事件监听预览流每帧数据，解析图像内容。</li></ul> <ul><li>判断图像宽度width与stride是否一致，不一致则进行裁剪（stride指图像的一行数据在内存中实际占用的字节数，为了内存对齐和提高读取效率的要求，通常大于图像的宽度）。可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-deal-stride-solution" target="_blank">相机预览花屏解决方案</a>。</li><li>屏幕处于不同的显示方向时，原始图像数据需旋转不同的角度，以确保图像在合适的方向显示。需考虑屏幕旋转角度、相机镜头安装角度，框架具体的实现机制可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section106421042912" target="_blank">屏幕旋转角度</a>。在实际开发中，推荐通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getpreviewrotation12" target="_blank">PreviewOutput.getPreviewRotation()</a>方法直接获取旋转角度。</li><li>对于前置镜头，还需要根据业务需求将数据进行水平镜像翻转，以模拟镜像效果。</li></ul> <p><strong>开发流程</strong></p> <ol><li>创建ImageReceiver。</li><li>获取SurfaceId。</li><li>创建第二路预览输出流PreviewOutput。</li><li>添加到Session。</li><li>监听帧到达事件。</li><li>处理并释放帧数据。</li></ol> <p><span><img height="750.653729" originheight="1400" originwidth="320" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163035.32520725088249609619622189999056:50001231000000:2800:B1DC592876E0449A38940172743A8B74642B8ADDB01E78F3C914E8F267EECB07.png" title="点击放大" width="171.57000000000002"></span></p> </div> <div class="tiledSection"><h3 id="section25951245185018">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section25951245185018" tips="复制节点链接"></i></h3><ol><li>创建<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>组件并获取surfaceId。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L75-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">init</span>(<span class="hljs-params">size: Size, format = image.ImageFormat.JPEG, capacity = <span class="hljs-number">8</span></span>) {</li><li>  <span class="hljs-keyword">const</span> receiver = image.<span class="hljs-title function_">createImageReceiver</span>(size, format, capacity);</li><li>  <span class="hljs-keyword">const</span> surfaceId = <span class="hljs-keyword">await</span> receiver.<span class="hljs-title function_">getReceivingSurfaceId</span>();</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onImageArrival</span>(receiver);</li><li>  <span class="hljs-keyword">return</span> surfaceId;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L75-L81" target="_blank">ImageReceiverManager.ets</a></div></div></div></div> </li><li>创建预览流并配置到相机会话Session中与实现基础预览一致。参考<a href="/consumer/cn/doc/best-practices/bpta-custom-camera-preview#li24730464385">创建预览输出流。</a></li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver#on9" target="_blank">ImageReceiver.on()</a>方法，注册imageArrival事件接收图像数据。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver#readnextimage9-1" target="_blank">ImageReceiver.read()</a>方法和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-image#getcomponent9-1" target="_blank">image.getComponent()</a>方法解析获取图像的Buffer。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L107-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onImageArrival</span>(<span class="hljs-variable">receiver</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">ImageReceiver</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'imageArrival'</span>, () =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'image arrival'</span>);</li><li>    <span class="hljs-variable">receiver</span>.<span class="hljs-title function_">readNextImage</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">nextImage</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Image</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> || <span class="hljs-variable">nextImage</span> === <span class="hljs-variable">undefined</span>) {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'readNextImage failed'</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">imgComponent</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span> || <span class="hljs-variable">imgComponent</span> === <span class="hljs-variable">undefined</span>) {</li><li>          <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'getComponent failed'</span>);</li><li>        }</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>) {</li><li>          <span class="hljs-comment">// ...</span></li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'byteBuffer is null'</span>);</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      });</li><li>    });</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L107-L165" target="_blank">ImageReceiverManager.ets</a></div></div></div></div> </li><li>根据stride和图像宽高对Buffer数据进行裁剪。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-f#imagecreatepixelmap8" target="_blank">image.createPixelMap()</a>方法创建pixelMap数据。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>注意在使用createPixelMap()方法处理Buffer数据时，传入的Buffer数据的像素格式<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-e#pixelmapformat7" target="_blank">(srcPixelFormat: PixelMapFormat)</a>要与获取预览输出流能力Profile中的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-e#cameraformat" target="_blank">(format: CameraFormat)</a>输出格式保持一致，防止出现图像数据显示异常。format格式之间的映射关系可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-dual-channel-preview#用于处理图像的第一路预览流" target="_blank">双路预览</a>。</p> </div></div></div> <div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L85-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">async</span> <span class="hljs-title function_">getPixelMap</span>(<span class="hljs-variable">imgComponent</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">height</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">stride</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">stride</span> === <span class="hljs-variable">width</span>) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>, {</li><li>      <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>      <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>,</li><li>    });</li><li>  }</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">dstBufferSize</span> = <span class="hljs-variable">width</span> * <span class="hljs-variable">height</span> * <span class="hljs-number">1.5</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">dstArr</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">dstBufferSize</span>);</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">j</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">j</span> &lt; <span class="hljs-title class_">height</span> * <span class="hljs-number">1.5</span>; <span class="hljs-title class_">j</span>++) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">srcBuf</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">Uint8Array</span>(<span class="hljs-variable">imgComponent</span>.<span class="hljs-variable">byteBuffer</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">stride</span>, <span class="hljs-variable">width</span>);</li><li>    <span class="hljs-variable">dstArr</span>.<span class="hljs-title function_">set</span>(<span class="hljs-variable">srcBuf</span>, <span class="hljs-variable">j</span> * <span class="hljs-variable">width</span>);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">await</span> <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMap</span>(<span class="hljs-variable">dstArr</span>.<span class="hljs-variable">buffer</span>, {</li><li>    <span class="hljs-variable">size</span>: { <span class="hljs-variable">height</span>: <span class="hljs-title class_">height</span>, <span class="hljs-variable">width</span>: <span class="hljs-title class_">width</span> },</li><li>    <span class="hljs-variable">srcPixelFormat</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMapFormat</span>.<span class="hljs-title class_">NV21</span>,</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L85-L103" target="_blank">ImageReceiverManager.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-camera-previewoutput#getpreviewrotation12" target="_blank">PreviewOutput.getPreviewRotation()</a>获取图像旋转角度，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#rotate9-1" target="_blank">PixelMap.rotate()</a>方法对图像数据进行旋转。在使用前置镜头时，存在水平镜像和垂直镜像的差异，为了统一翻转逻辑，在屏幕旋转角度为90度或270度时，需额外旋转180度将图像转正，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#flip9-1" target="_blank">PixelMap.flip()</a>方法将图像数据进行水平翻转，以达到镜像效果。参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/camera-rotation-term#section1926813511727" target="_blank">自绘制预览角度处理</a>。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L117-L160" data-highlighted="yes"><ol class="linenums"><li>nextImage.<span class="hljs-title function_">getComponent</span>(image.<span class="hljs-property">ComponentType</span>.<span class="hljs-property">JPEG</span>, <span class="hljs-keyword">async</span> (<span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-attr">imgComponent</span>: image.<span class="hljs-property">Component</span>) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (err || imgComponent === <span class="hljs-literal">undefined</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'getComponent failed'</span>);</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (imgComponent.<span class="hljs-property">byteBuffer</span>) {</li><li>    <span class="hljs-keyword">const</span> width = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">width</span>;</li><li>    <span class="hljs-keyword">const</span> height = nextImage.<span class="hljs-property">size</span>.<span class="hljs-property">height</span>;</li><li>    <span class="hljs-keyword">const</span> stride = imgComponent.<span class="hljs-property">rowStride</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getComponent with width:<span class="hljs-subst">${width}</span> height:<span class="hljs-subst">${height}</span> stride:<span class="hljs-subst">${stride}</span>`</span>);</li><li>    <span class="hljs-keyword">const</span> pixelMap = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getPixelMap</span>(imgComponent, width, height, stride);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">displayDefault</span>: display.<span class="hljs-property">Display</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      displayDefault = display.<span class="hljs-title function_">getDefaultDisplaySync</span>();</li><li>    } <span class="hljs-keyword">catch</span> (exception) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getDefaultDisplaySync failed, code is <span class="hljs-subst">${exception.code}</span>, message is <span class="hljs-subst">${exception.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">const</span> displayRotation = (displayDefault?.<span class="hljs-property">rotation</span> ?? <span class="hljs-number">0</span>) * camera.<span class="hljs-property">ImageRotation</span>.<span class="hljs-property">ROTATION_90</span>;</li><li>    <span class="hljs-keyword">const</span> rotation = <span class="hljs-variable language_">this</span>.<span class="hljs-property">output</span>!.<span class="hljs-title function_">getPreviewRotation</span>(displayRotation);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">position</span> === camera.<span class="hljs-property">CameraPosition</span>.<span class="hljs-property">CAMERA_POSITION_FRONT</span>) {</li><li>      <span class="hljs-keyword">if</span> (displayRotation === <span class="hljs-number">90</span> || displayRotation === <span class="hljs-number">270</span>) {</li><li>        <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">rotate</span>((rotation + <span class="hljs-number">180</span>) % <span class="hljs-number">360</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">rotate</span>(rotation);</li><li>      }</li><li>      <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">flip</span>(<span class="hljs-literal">true</span>, <span class="hljs-literal">false</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">await</span> pixelMap.<span class="hljs-title function_">rotate</span>(rotation);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callback</span>(pixelMap);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'byteBuffer is null'</span>);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L117-L160" target="_blank">ImageReceiverManager.ets</a></div></div></div></div> </li><li>对<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-imagereceiver" target="_blank">ImageReceiver</a>组件获取到的图像数据处理后，需要将对应的图像Buffer释放，以确保Surface的BufferQueue正常轮转，防止出现缓冲区溢出等问题。如果对Buffer进行异步操作，则需要在异步操作结束后，确保当前Buffer没有使用的情况下再释放该资源。<div class="screenLinkPre"><div _ngcontent-dje-c106="" class="highlight-div"><div _ngcontent-dje-c106="" class="highlight-div-header"><div _ngcontent-dje-c106="" class="highlight-div-header-left"><div _ngcontent-dje-c106="" class="handle-button expand-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dje-c106="" class="highlight-div-header-right"><div _ngcontent-dje-c106="" class="handle-button ai-button"></div><div _ngcontent-dje-c106="" class="handle-button line-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dje-c106="" class="handle-button theme-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dje-c106="" class="handle-button copy-button"><div _ngcontent-dje-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dje-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L116-L159" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">getComponent</span>(<span class="hljs-variable">image</span>.<span class="hljs-variable">ComponentType</span>.<span class="hljs-variable">JPEG</span>, <span class="hljs-variable">async</span> (<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>, <span class="hljs-variable">imgComponent</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Component</span>) =&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable">nextImage</span>.<span class="hljs-title function_">release</span>();</li><li>  <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'image process done'</span>);</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomCamera/blob/master/camera/src/main/ets/cameramanagers/ImageReceiverManager.ets#L116-L159" target="_blank">ImageReceiverManager.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section841042445115">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section841042445115" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CustomCamera" target="_blank">自定义相机开发</a></li></ul> </div> </div> <div></div></div>