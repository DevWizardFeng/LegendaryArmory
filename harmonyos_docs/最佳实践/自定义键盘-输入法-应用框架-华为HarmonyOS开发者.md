<h1 _ngcontent-pkv-c119="" class="doc-title ng-star-inserted" title="自定义键盘"> 自定义键盘 </h1>

<div _ngcontent-pkv-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1840215515206">概述<i class="anchor-icon anchor-icon-link" anchorid="section1840215515206" tips="复制节点链接"></i></h2><p>自定义键盘是一种简易的键盘替代系统默认键盘，允许用户根据实际业务场景和习惯偏好，调整键盘的布局和位置、添加额外的功能键，使输入更加便捷和舒适，从而提升整体的用户体验。同时自定义键盘也可以增强用户输入的安全性，避免敏感信息被截取或者泄露。</p> <p>本文将从以下几个方面介绍自定义键盘的实现和使用：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section2059651742117">自定义键盘的实现</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section20427115971010">自定义键盘和系统键盘的切换</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section3179730192019">自定义键盘的布局避让</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section193891441919">自定义键盘实现防截屏</a></li></ul> </div> <div class="tiledSection"><h2 id="section2059651742117">自定义键盘的实现<i class="anchor-icon anchor-icon-link" anchorid="section2059651742117" tips="复制节点链接"></i></h2><p>自定义键盘的实现包括以下几个步骤：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section131317262217">自定义键盘布局实现</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section147941149222">输入控件绑定自定义键盘布局</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section19880122132213">自定义键盘输入控制</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section15636163317224">自定义键盘光标控制</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-custom-keyboard#section173493918225">自定义键盘弹出与收起</a></li></ul> </div> <div class="tiledSection"><h3 id="section131317262217" class="firsth2">自定义键盘布局实现<i class="anchor-icon anchor-icon-link" anchorid="section131317262217" tips="复制节点链接"></i></h3><p>自定义键盘的布局以自定义组件的方式呈现，根据具体业务场景由开发者实现。自定义键盘的高度通过自定义组件根节点的height属性设置，宽度不可设置，默认为屏幕宽度。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/CustomKeyboard.ets#L22-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">@Component</span></li><li>export struct CustomKeyboard {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-selector-class">.height</span>($r('app.float.keyboard_total_height')) <span class="hljs-comment">// Set the total keyboard height by referencing the definition in the resource file.</span></li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/CustomKeyboard.ets#L22-L68" target="_blank">CustomKeyboard.ets</a></div></div></div></div> <p>以Grid方式实现数字键盘布局示例：</p> <div class="fignone"><span class="figcap"><b>图1 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163012.37920773381065447845879243385192:50001231000000:2800:545E7C9B458E99D696487FAC23D06BAF443D4FAC7920AA568D26D6C70D12BE12.gif" width="266" class="notEnlarge"></span><div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/NumberKeyboard.ets#L21-L58" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">NumberKeyboard</span> {</li><li>  <span class="hljs-meta">@Consume</span> <span class="hljs-attr">inputText</span>: <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-meta">@Consume</span> <span class="hljs-attr">keyboardController</span>: <span class="hljs-title class_">KeyboardController</span>;</li><li>  <span class="hljs-attr">layoutOptions</span>: <span class="hljs-title class_">GridLayoutOptions</span> = {</li><li>    <span class="hljs-attr">regularSize</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>],</li><li>    <span class="hljs-attr">irregularIndexes</span>: [<span class="hljs-number">14</span>, <span class="hljs-number">16</span>],</li><li>    <span class="hljs-attr">onGetIrregularSizeByIndex</span>: <span class="hljs-function">(<span class="hljs-params">index: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (index === <span class="hljs-number">14</span>) {</li><li>        <span class="hljs-keyword">return</span> [<span class="hljs-number">2</span>, <span class="hljs-number">1</span>];</li><li>      }</li><li>      <span class="hljs-keyword">return</span> [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>];</li><li>    }</li><li>  };</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Grid</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">layoutOptions</span>) {</li><li>      <span class="hljs-title class_">ForEach</span>(numberKeyboardData, <span class="hljs-function">(<span class="hljs-params">item: Menu</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">GridItem</span>() {</li><li>          <span class="hljs-title class_">Button</span>(item.<span class="hljs-property">text</span>, { <span class="hljs-attr">type</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-property">Normal</span> })</li><li>            .<span class="hljs-title function_">fontColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Black</span>)</li><li>            .<span class="hljs-title function_">backgroundColor</span>(item.<span class="hljs-property">backgroundColor</span>)</li><li>            .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-title class_">Constants</span>.<span class="hljs-property">KEYBOARD_BUTTON_RADIUS</span>)</li><li>            .<span class="hljs-title function_">fontSize</span>(<span class="hljs-title class_">Constants</span>.<span class="hljs-property">KEYBOARD_BUTTON_FONTSIZE_18</span>)</li><li>            .<span class="hljs-title function_">padding</span>(<span class="hljs-number">0</span>)</li><li>            .<span class="hljs-title function_">width</span>(item.<span class="hljs-property">width</span>)</li><li>            .<span class="hljs-title function_">height</span>(item.<span class="hljs-property">height</span>)</li><li>            .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputText</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyboardController</span>.<span class="hljs-title function_">onInput</span>(item.<span class="hljs-property">text</span>);</li><li>            })</li><li>        }</li><li>      }, <span class="hljs-function">(<span class="hljs-params">item: Menu</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item))</li><li>    }</li><li>    .<span class="hljs-title function_">columnsTemplate</span>(<span class="hljs-string">'1fr 1fr 1fr 1fr 1fr'</span>)</li><li>    .<span class="hljs-title function_">rowsGap</span>($r(<span class="hljs-string">'app.float.number_keyboard_grid_gap'</span>))</li><li>    .<span class="hljs-title function_">columnsGap</span>($r(<span class="hljs-string">'app.float.number_keyboard_grid_gap'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/NumberKeyboard.ets#L21-L58" target="_blank">NumberKeyboard.ets</a></div></div></div></div> </div> </div> <div class="tiledSection"><h3 id="section147941149222">输入控件绑定自定义键盘布局<i class="anchor-icon anchor-icon-link" anchorid="section147941149222" tips="复制节点链接"></i></h3><p>输入控件（TextArea、TextInput、RichEditor、Search）支持通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-textinput#customkeyboard10" target="_blank">customKeyboard</a>属性绑定自定义键盘布局。绑定自定义键盘后，输入控件获取焦点时，不会拉起系统键盘，而是加载指定的自定义键盘。本文后续以TextInput控件为例进行介绍。</p> <div class="fignone"><span class="figcap"><b>图2 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163012.05971259595046684045082397178278:50001231000000:2800:C2985184B05C2ACDC082F436D455B60031FC8521F9FFF358FF01C7C556531B62.gif" width="266" class="notEnlarge"></span></div> <p>代码示例如下：</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L52-L112" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>      <span class="hljs-selector-tag">TextInput</span>({</li><li>        placeholder: 'Bind Custom Keyboard',</li><li>        text: this.inputText,</li><li>        controller: this.textInputController</li><li>      })</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-selector-class">.customKeyboard</span>(this.isCustomKeyboardAttach ? this.<span class="hljs-built_in">customKeyboard</span>() : null)</li><li>          <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-variable">@Builder</span></li><li>  <span class="hljs-built_in">customKeyboard</span>() {</li><li>    <span class="hljs-selector-tag">CustomKeyboard</span>()</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L52-L112" target="_blank">TextInputComponent.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section1048163973916">监听键盘弹出与收起<i class="anchor-icon anchor-icon-link" anchorid="section1048163973916" tips="复制节点链接"></i></h3></div> <p>在输入组件内,使用@Link和@Watch('onChangeKeyboard')修饰isKeyboardShown；</p> <p>当键盘状态变化后,会调用onChangeKeyboard,此时要收起键盘,则执行和键盘控制器绑定的文字输入控制器的stopEditing。</p> <p></p> <div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span> export struct TextInputComponent {</li><li>  <span class="hljs-variable">@Link</span> <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onChangeKeyboard'</span>) <span class="hljs-attribute">isKeyboardShown</span>: boolean;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-selector-tag">onChangeKeyboard</span>() {     </li><li>    <span class="hljs-selector-tag">if</span> (this.isKeyboardShown === false) {       </li><li>       <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.textInputController</span><span class="hljs-selector-class">.stopEditing</span>();     </li><li>    }   </li><li>   }</li><li> <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre></div></div> <p>输入组件内有两个事件：</p> <p>onFocus代表获得焦点,用户点击输入组件的时候,输入组件会获得焦点从而弹出键盘,此时设定isKeyboardShown为true,表示弹起;</p> <div class="p">onBlur代表失去焦点,当输入组件失去焦点,会被调用, 此时设为isKeyboardShown为false,表示收起;<div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" data-highlighted="yes"><ol class="linenums"><li>   .<span class="hljs-title function_">onBlur</span>(<span class="hljs-function">() =&gt;</span> {           </li><li>     <span class="hljs-comment">// ...        </span></li><li>     <span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardShown</span> = <span class="hljs-literal">false</span>;</li><li>   })         </li><li>   .<span class="hljs-title function_">onFocus</span>(<span class="hljs-function">() =&gt;</span> {           </li><li>    <span class="hljs-comment">// ...         </span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardShown</span> = <span class="hljs-literal">true</span>;         </li><li>   })</li></ol></pre></div></div> </div> <div class="p">页面内的isKeyboardShown要和输入组件TextInputComponent 建立双向绑定,用来监听isKeyboardShown变化,响应键盘的弹出与收起.<div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">MainPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isKeyboardShown</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Navigation</span>() {</li><li>      <span class="hljs-title class_">Column</span>() {</li><li>       <span class="hljs-comment">// ...</span></li><li>      }</li><li>    }</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardShown</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isKeyboardShown</span> = <span class="hljs-literal">false</span>;</li><li>      }</li><li>    })</li><li>    .<span class="hljs-title function_">mode</span>(<span class="hljs-title class_">NavigationMode</span>.<span class="hljs-property">Stack</span>)</li><li>    .<span class="hljs-title function_">titleMode</span>(<span class="hljs-title class_">NavigationTitleMode</span>.<span class="hljs-property">Full</span>)</li><li>    .<span class="hljs-title function_">title</span>($r(<span class="hljs-string">'app.string.main_page_title'</span>))</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h2 id="section47543181519">在横竖屏切换时设置键盘高度<i class="anchor-icon anchor-icon-link" anchorid="section47543181519" tips="复制节点链接"></i></h2></div> <p>在键盘组件 CustomKeyboard.ets 引入方向检测与动态高度，在键盘组件内对应位置处理。</p> <div class="p">引入 @ohos.display ，新增 @State isLandscape 保存当前方向。<div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" data-highlighted="yes"><ol class="linenums"><li>  <span class="hljs-keyword">import</span> display <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos.display'</span>;</li><li>  <span class="hljs-meta">@State</span> <span class="hljs-attr">isLandscape</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li></ol></pre></div></div> </div> <p>在 aboutToAppear 注册监听器 display.on('change') ，在aboutToDisappear 注销监听器，方向变化时调用 updateOrientation(), 通过 display.getDefaultDisplaySync() 判断 width &gt; height 判定横屏。</p> <div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" data-highlighted="yes"><ol class="linenums"><li> aboutToAppear(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">this</span>.updateOrientation();</li><li>    <span class="hljs-keyword">try</span> {</li><li>      display.<span class="hljs-keyword">on</span>(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.onDisplayChange);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-comment">// ignore</span></li><li>    }</li><li>  }</li><li>
</li><li>  aboutToDisappear(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      display.off(<span class="hljs-string">'change'</span>, <span class="hljs-keyword">this</span>.onDisplayChange);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-comment">// ignore</span></li><li>    }</li><li>  }</li><li>
</li><li> <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">updateOrientation</span>()</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> d = display.getDefaultDisplaySync();</li><li>      <span class="hljs-keyword">this</span>.isLandscape = d.width &gt; d.height;</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-keyword">this</span>.isLandscape = <span class="hljs-literal">false</span>;</li><li>    }</li><li>  }</li></ol></pre></div></div> <p>重写 getKeyboardHeightVp() ，判断设备为平板的时候，按照平板的比例给予，横屏0.33，竖屏0.22的屏幕高度占比，手机的话固定为0.36的占比高度</p> <div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> getKeyboardHeightVp(): number | Resource {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> d = display.getDefaultDisplaySync();</li><li>      <span class="hljs-keyword">const</span> ui = <span class="hljs-keyword">this</span>.getUIContext();</li><li>      <span class="hljs-keyword">const</span> screenHeightVp = ui.px2vp(d.height);</li><li>      <span class="hljs-keyword">const</span> shortSideVp = ui.px2vp(Math.min(d.width, d.height));</li><li>      <span class="hljs-keyword">const</span> isLargeScreen = shortSideVp &gt;= <span class="hljs-number">600</span>; <span class="hljs-comment">// 近似判定平板/大屏</span></li><li>
</li><li>      <span class="hljs-comment">// 手机：竖屏横屏 36%(不支持横竖屏切换)</span></li><li>      <span class="hljs-comment">// 平板：竖屏 22%，横屏 33%（降低高度以适配大屏）</span></li><li>      <span class="hljs-keyword">const</span> ratio = isLargeScreen</li><li>          ? (<span class="hljs-keyword">this</span>.isLandscape ? <span class="hljs-number">0.33</span> : <span class="hljs-number">0.22</span>)</li><li>          :  <span class="hljs-number">0.36</span>;</li><li>
</li><li>      <span class="hljs-keyword">return</span> Math.floor(screenHeightVp * ratio);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-comment">// 显示信息不可用时的兜底，仍使用旧的资源高度</span></li><li>      <span class="hljs-keyword">return</span> $r(<span class="hljs-string">'app.float.keyboard_total_height'</span>);</li><li>    }</li><li>  }</li></ol></pre></div></div> <div class="p">修改组件高度，将键盘组件的 .height(...) 改为 .height(this.getKeyboardHeightVp()) 以采用动态计算值。<div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Component</span></li><li>export struct CustomKeyboard {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">Column</span>() {</li><li>     <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-built_in">height</span>(this.<span class="hljs-built_in">getKeyboardHeightVp</span>())</li><li>    .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-built_in">backgroundColor</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.color.keyboard_background_color'</span>))</li><li>  }</li><li>}</li></ol></pre></div></div> </div> <div class="tiledSection"><h3 id="section19880122132213" class="firsth2">自定义键盘输入控制<i class="anchor-icon anchor-icon-link" anchorid="section19880122132213" tips="复制节点链接"></i></h3><p>自定义键盘可以拦截手势事件，通过对状态变量的修改，实现文本的输入。</p> <div class="fignone"><span class="figcap"><b>图3 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.03309040092026625444043146520554:50001231000000:2800:D000F22EF343B20F42B513146D2511B481FC48230159A477FF7F52DE49875685.gif" width="266" class="notEnlarge"></span></div> <p>以英文键盘为例，监听EnglishButton的onClick事件，修改状态变量。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/EnglishKeyboard.ets#L65-L106" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li>struct EnglishButton {</li><li>  <span class="hljs-meta">@Consume</span> inputText: string;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  build() {</li><li>    Button({ type: ButtonType.Normal })</li><li>    <span class="hljs-comment">// ...</span></li><li>    .onClick(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.inputText = <span class="hljs-keyword">this</span>.keyboardController.onInput(<span class="hljs-keyword">this</span>.getEnglishText(<span class="hljs-keyword">this</span>.item));</li><li>    })</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/EnglishKeyboard.ets#L65-L106" target="_blank">EnglishKeyboard.ets</a></div></div></div></div> <p>通过对状态变量inputText的修改，实现文本输入。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L22-L113" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TextInputComponent</span> {</li><li>  @<span class="hljs-title function_">Provide</span> <span class="hljs-variable">inputText</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Column</span>() {</li><li>      <span class="hljs-title function_">TextInput</span>({</li><li>        <span class="hljs-variable">placeholder</span>: <span class="hljs-string">'Bind Custom Keyboard'</span>,</li><li>        <span class="hljs-variable">text</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">inputText</span>,</li><li>        <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">textInputController</span></li><li>      })</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L22-L113" target="_blank">TextInputComponent.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section15636163317224">自定义键盘光标控制<i class="anchor-icon anchor-icon-link" anchorid="section15636163317224" tips="复制节点链接"></i></h3><p>通过监听TextInput的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-textinput#ontextselectionchange10" target="_blank">onTextSelectionChange</a>生命周期，获取初始光标位置，文本输入后，调用TextInputController的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-textinput#caretposition8" target="_blank">caretPosition</a>方法，设置最终光标位置。</p> <div class="fignone"><span class="figcap"><b>图4 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.64521908379224434475625255059878:50001231000000:2800:8797021F8B63705D1A15409508C10D4BACC931B99DD78F7A3C6F9A604126DF33.gif" width="266" class="notEnlarge"></span></div> <p>获取光标位置：</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L55-L111" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">TextInput</span>({</li><li>  <span class="hljs-variable">placeholder</span>: <span class="hljs-string">'Bind Custom Keyboard'</span>,</li><li>  <span class="hljs-variable">text</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">inputText</span>,</li><li>  <span class="hljs-variable">controller</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">textInputController</span></li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onTextSelectionChange</span>((<span class="hljs-variable">start</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">end</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">keyboardController</span>.<span class="hljs-title function_">setCaretPosition</span>(<span class="hljs-variable">start</span>, <span class="hljs-variable">end</span>);</li><li>  })</li><li>    <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L55-L111" target="_blank">TextInputComponent.ets</a></div></div></div></div> <p>设置光标位置：</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L85-L90" data-highlighted="yes"><ol class="linenums"><li>onChange(value: string) {</li><li>  <span class="hljs-keyword">this</span>.text = value;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.keyboardType !== <span class="hljs-string">'System'</span>) {</li><li>    <span class="hljs-keyword">this</span>.textInputController?.caretPosition(<span class="hljs-keyword">this</span>.targetCaretPos);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L85-L90" target="_blank">KeyboardController.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section173493918225">自定义键盘弹出与收起<i class="anchor-icon anchor-icon-link" anchorid="section173493918225" tips="复制节点链接"></i></h3><p>通过对焦点进行控制，可以实现键盘的弹出和收起，参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-keyboard-layout-adapt#section117216355229" target="_blank">软键盘的弹出收起和监听</a>。</p> <p>开发者也可以通过TextInputController的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-textinput#stopediting10" target="_blank">stopEditing</a>方法控制键盘关闭，下面的自定义键盘示例中，点击确认按键关闭自定义键盘。</p> <div class="fignone"><span class="figcap"><b>图5 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.40372781926490224861501918546049:50001231000000:2800:884DCBE6D06187097E58FA00443BA2A83932D9CB3D704DDCC0395F214351113F.gif" width="266" class="notEnlarge"></span><div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L29-L76" data-highlighted="yes"><ol class="linenums"><li>onInput(<span class="hljs-keyword">value</span>: <span class="hljs-built_in">string</span> | Resource): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">value</span>.id) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">case</span> $r(<span class="hljs-string">'app.string.keyboardButton_finish'</span>).id:</li><li>      <span class="hljs-keyword">this</span>.textInputController?.stopEditing();</li><li>      <span class="hljs-keyword">break</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.text;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L29-L76" target="_blank">KeyboardController.ets</a></div></div></div></div> </div> </div> <div class="tiledSection"><h2 id="section20427115971010">自定义键盘和系统键盘的切换<i class="anchor-icon anchor-icon-link" anchorid="section20427115971010" tips="复制节点链接"></i></h2><p>当需要实现同一个输入框内可以切换自定义键盘和系统键盘时，可以通过如下方式实现：</p> <p>Tab栏点击“123”、“ABC”按钮，this.isCustomKeyboardAttach为true，TextInput绑定自定义键盘；点击“中文”按钮，this.isCustomKeyboardAttach为false，切换系统键盘。</p> <div class="fignone"><span class="figcap"><b>图6 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.26947654912018200908234930457404:50001231000000:2800:C47124E65447C20CEB1018630718777EDDA32487A1EB6A8DEEC123819972EB19.gif" width="266" class="notEnlarge"></span><div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L56-L72" data-highlighted="yes"><ol class="linenums"><li>TextInput({</li><li>  placeholder: <span class="hljs-string">'Bind Custom Keyboard'</span>,</li><li>  text: <span class="hljs-keyword">this</span>.inputText,</li><li>  controller: <span class="hljs-keyword">this</span>.textInputController</li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .customKeyboard(<span class="hljs-keyword">this</span>.isCustomKeyboardAttach ? <span class="hljs-keyword">this</span>.customKeyboard() : <span class="hljs-literal">null</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L56-L72" target="_blank">TextInputComponent.ets</a></div></div></div></div> </div> </div> <div class="tiledSection"><h2 id="section3179730192019">自定义键盘的布局避让<i class="anchor-icon anchor-icon-link" anchorid="section3179730192019" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section53495479270" class="firsth2">使用系统提供的自定义键盘避让功能<i class="anchor-icon anchor-icon-link" anchorid="section53495479270" tips="复制节点链接"></i></h3><p>为了确保输入框不被自定义键盘挡住，系统默认提供了输入框避让自定义键盘的能力。在TextInput组件的customKeyboard属性设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#keyboardoptions12" target="_blank">supportAvoidance</a>为true，开启系统提供的自定义键盘避让功能。键盘的避让机制和常见问题的解决方法，可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-keyboard-layout-adapt#section08221814182316" target="_blank">软键盘布局适配场景介绍</a>。</p> <div class="fignone"><span class="figcap"><b>图7 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.97554897663812419228698127015110:50001231000000:2800:A9665E5D1864B7CD39DAD6C014B206093FB241867D213EB870E3E97368CE7434.gif" width="266" class="notEnlarge"></span></div> </div> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L56-L72" data-highlighted="yes"><ol class="linenums"><li>TextInput({</li><li>  placeholder: <span class="hljs-string">'Bind Custom Keyboard'</span>,</li><li>  text: <span class="hljs-keyword">this</span>.inputText,</li><li>  controller: <span class="hljs-keyword">this</span>.textInputController</li><li>})</li><li>  <span class="hljs-comment">// ...</span></li><li>  .customKeyboard(<span class="hljs-keyword">this</span>.isCustomKeyboardAttach ? <span class="hljs-keyword">this</span>.customKeyboard() : <span class="hljs-literal">null</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/TextInputComponent.ets#L56-L72" target="_blank">TextInputComponent.ets</a></div></div></div></div> <p>系统默认的自定义键盘避让功能只能保证输入框不被遮挡，输入框下方的组件可能会被自定义键盘挡住，如上图中所示，输入框下方的tab栏被自定义键盘挡住。为解决这一问题，需要开发者自己实现自定义键盘的避让功能。</p> <div class="tiledSection"><h3 id="section196400361286">开发者自己实现自定义键盘的避让功能<i class="anchor-icon anchor-icon-link" anchorid="section196400361286" tips="复制节点链接"></i></h3><p>开发者需要监听自定义键盘根节点的onAreaChange生命周期，获取自定义键盘的高度，根据实际场景设置布局的避让。</p> <div class="fignone"><span class="figcap"><b>图8 </b></span><br><span><img height="544.5818" originheight="480" originwidth="232" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163013.76768626975334183191001933009564:50001231000000:2800:5F9164115D9D7292C6C484EA42546A9EA8B9B26E10C7BB345ADCD5B35615672C.gif" width="266" class="notEnlarge"></span></div> <p>监听自定义键盘布局的onAreaChange生命周期，通过newValue.height获取自定义键盘弹出时的高度，根据实际业务场景计算布局避让高度avoidHeight。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/CustomKeyboard.ets#L23-L69" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">CustomKeyboard</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Column</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">onAreaChange</span>(<span class="hljs-function">(<span class="hljs-params">oldValue: Area, newValue: Area</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">customKeyboardHeight</span> = <span class="hljs-title class_">Number</span>(newValue.<span class="hljs-property">height</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">avoidHeight</span>: <span class="hljs-built_in">number</span> = (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isCustomKeyboardAttach</span> ? <span class="hljs-variable language_">this</span>.<span class="hljs-property">customKeyboardHeight</span> : <span class="hljs-variable language_">this</span>.<span class="hljs-property">systemKeyboardHeight</span>)</li><li>        - <span class="hljs-variable language_">this</span>.<span class="hljs-property">bottomRectHeight</span>;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyboardController</span>.<span class="hljs-title function_">changeAvoidHeight</span>(avoidHeight);</li><li>    })</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/view/CustomKeyboard.ets#L23-L69" target="_blank">CustomKeyboard.ets</a></div></div></div></div> <p>通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-emitter" target="_blank">emitter</a>的方式，发送自定义键盘高度变化的通知。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L104-L114" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">changeAvoidHeight</span>(<span class="hljs-variable">value</span>: <span class="hljs-title class_">number</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">event</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">InnerEvent</span> = {</li><li>    <span class="hljs-variable">eventId</span>: <span class="hljs-title class_">Constants</span>.<span class="hljs-title class_">AVOID_EVENT_ID</span></li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">eventData</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">EventData</span> = {</li><li>    <span class="hljs-variable">data</span>: {</li><li>      <span class="hljs-string">'avoidHeight'</span>: <span class="hljs-title class_">value</span></li><li>    }</li><li>  };</li><li>  <span class="hljs-variable">emitter</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-variable">event</span>, <span class="hljs-variable">eventData</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/model/KeyboardController.ets#L104-L114" target="_blank">KeyboardController.ets</a></div></div></div></div> <p>接收到高度变化通知后，根据实际业务场景，设置页面的避让高度。</p> <div class="screenLinkPre"><div _ngcontent-pkv-c106="" class="highlight-div"><div _ngcontent-pkv-c106="" class="highlight-div-header"><div _ngcontent-pkv-c106="" class="highlight-div-header-left"><div _ngcontent-pkv-c106="" class="handle-button expand-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pkv-c106="" class="highlight-div-header-right"><div _ngcontent-pkv-c106="" class="handle-button ai-button"></div><div _ngcontent-pkv-c106="" class="handle-button line-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pkv-c106="" class="handle-button theme-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pkv-c106="" class="handle-button copy-button"><div _ngcontent-pkv-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pkv-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/pages/MainPage.ets#L21-L66" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainPage</span> {</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">bottomPadding</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">210</span>;</li><li>
</li><li>  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">event</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">InnerEvent</span> = {</li><li>      <span class="hljs-variable">eventId</span>: <span class="hljs-number">1</span></li><li>    }</li><li>    <span class="hljs-variable">emitter</span>.<span class="hljs-title function_">on</span>(<span class="hljs-variable">event</span>, (<span class="hljs-variable">eventData</span>: <span class="hljs-title class_">emitter</span>.<span class="hljs-title class_">EventData</span>) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable">eventData</span>.<span class="hljs-variable">data</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-variable">avoidHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">eventData</span>.<span class="hljs-variable">data</span>[<span class="hljs-string">'avoidHeight'</span>];</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">avoidHeight</span> === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">bottomPadding</span> = <span class="hljs-number">210</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">bottomPadding</span> = <span class="hljs-variable">avoidHeight</span>;</li><li>        }</li><li>      }</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Navigation</span>() {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">padding</span>({ <span class="hljs-variable">bottom</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">bottomPadding</span> })</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">mode</span>(<span class="hljs-variable">NavigationMode</span>.<span class="hljs-variable">Stack</span>)</li><li>    .<span class="hljs-title function_">titleMode</span>(<span class="hljs-variable">NavigationTitleMode</span>.<span class="hljs-variable">Full</span>)</li><li>    .<span class="hljs-title function_">title</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.main_page_title'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard/blob/master/entry/src/main/ets/pages/MainPage.ets#L21-L66" target="_blank">MainPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section193891441919">自定义键盘实现防截屏<i class="anchor-icon anchor-icon-link" anchorid="section193891441919" tips="复制节点链接"></i></h2><p>用户使用自定义键盘输入敏感信息时，可以设置禁止截屏，有效防止他人在未经许可的情况下获取用户的敏感信息，从而保护用户的隐私安全。具体实现参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-arkui-3" target="_blank">如何实现防截屏功能</a>。</p> </div> <div class="tiledSection"><h2 id="section1680905412256">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1680905412256" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CustomizeKeyboard" target="_blank">自定义键盘案例</a></li></ul> </div> </div> <div></div></div>