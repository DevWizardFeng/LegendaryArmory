<h1 _ngcontent-igg-c119="" class="doc-title ng-star-inserted" title="视频场景弹幕绘制低功耗规则"> 视频场景弹幕绘制低功耗规则 </h1>

<div _ngcontent-igg-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section103291628287">规则<i class="anchor-icon anchor-icon-link" anchorid="section103291628287" tips="复制节点链接"></i></h2></div> <ul><li>在视频播放弹幕场景中，弹幕的绘制方式可分为CPU渲染和GPU渲染两种方案。在相同渲染复杂度下，CPU渲染的计算负载显著高于GPU渲染，因此建议优先采用OpenGLES进行基于GPU硬件加速的渲染。</li></ul> <div class="tiledSection"><h2 id="section7181529165813">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section7181529165813" tips="复制节点链接"></i></h2><p>使用EGL/OpenGLES进行渲染，即硬件加速，通过GPU绘制。OpenGLES的接口使用方式请参见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-oh-nativexcomponent-native-xcomponent" target="_blank">OH_NativeXComponent Native XComponent</a>。</p> <p>XComponent组件作为一种渲染组件，可用于EGL/OpenGLES和媒体数据写入，通过使用XComponent持有的“<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/native-window-guidelines" target="_blank">NativeWindow</a>”来渲染画面，通常用于满足开发者较为复杂的自定义渲染需求，例如相机预览流的显示和游戏画面的渲染。其可通过指定type字段来实现不同的渲染方式，分别为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-appendix-enums#xcomponenttype10" target="_blank">XComponentType</a>.SURFACE和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-appendix-enums#xcomponenttype10" target="_blank">XComponentType</a>.TEXTURE。对于SURFACE类型，开发者将定制的绘制内容单独展示到屏幕上。对于TEXTURE类型，开发者将定制的绘制内容和XComponent组件的内容合成后展示到屏幕上。以下是EGL/OpenGLES的使用范例：</p> <div class="screenLinkPre"><div _ngcontent-igg-c106="" class="highlight-div"><div _ngcontent-igg-c106="" class="highlight-div-header"><div _ngcontent-igg-c106="" class="highlight-div-header-left"><div _ngcontent-igg-c106="" class="handle-button expand-button"><div _ngcontent-igg-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-igg-c106="" class="highlight-div-header-right"><div _ngcontent-igg-c106="" class="handle-button ai-button"></div><div _ngcontent-igg-c106="" class="handle-button line-button"><div _ngcontent-igg-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-igg-c106="" class="handle-button theme-button"><div _ngcontent-igg-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-igg-c106="" class="handle-button copy-button"><div _ngcontent-igg-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-igg-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/cpp/EGLCore.cpp#L46-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">EGLCore</span>::<span class="hljs-title class_">Draw</span>() {</li><li>    <span class="hljs-comment">// Determine the vertices of the quadrilateral to be drawn, expressed as a percentage of the drawing area</span></li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">GLfloat</span> <span class="hljs-variable">shapeVertices</span>[] = {<span class="hljs-variable">centerX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">centerY</span> / <span class="hljs-variable">height_</span>, <span class="hljs-variable">leftX</span> / <span class="hljs-variable">width_</span>,  <span class="hljs-variable">leftY</span> / <span class="hljs-variable">height_</span>,</li><li>                                     <span class="hljs-variable">rotateX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">rotateY</span> / <span class="hljs-variable">height_</span>, <span class="hljs-variable">rightX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">rightY</span> / <span class="hljs-variable">height_</span>};</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ExecuteDrawStar</span>(<span class="hljs-variable">position</span>, <span class="hljs-variable">DRAW_COLOR</span>, <span class="hljs-variable">shapeVertices</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">shapeVertices</span>))) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw star failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">GLfloat</span> <span class="hljs-variable">rad</span> = <span class="hljs-variable">M_PI</span> / <span class="hljs-number">180</span> * <span class="hljs-number">72</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-number">4</span>; ++<span class="hljs-title class_">i</span>) {</li><li>        <span class="hljs-comment">// Rotate the vertices of the other four quadrilaterals</span></li><li>        <span class="hljs-title function_">rotate2d</span>(<span class="hljs-variable">centerX</span>, <span class="hljs-variable">centerY</span>, &amp;<span class="hljs-title class_">rotateX</span>, &amp;<span class="hljs-title class_">rotateY</span>, <span class="hljs-variable">rad</span>);</li><li>        <span class="hljs-title function_">rotate2d</span>(<span class="hljs-variable">centerX</span>, <span class="hljs-variable">centerY</span>, &amp;<span class="hljs-title class_">leftX</span>, &amp;<span class="hljs-title class_">leftY</span>, <span class="hljs-variable">rad</span>);</li><li>        <span class="hljs-title function_">rotate2d</span>(<span class="hljs-variable">centerX</span>, <span class="hljs-variable">centerY</span>, &amp;<span class="hljs-title class_">rightX</span>, &amp;<span class="hljs-title class_">rightY</span>, <span class="hljs-variable">rad</span>);</li><li>
</li><li>        <span class="hljs-comment">// Determine the vertices of the quadrilateral to be drawn, expressed as a percentage of the drawing area</span></li><li>        <span class="hljs-keyword">const</span> <span class="hljs-variable">GLfloat</span> <span class="hljs-variable">shapeVertices</span>[] = {<span class="hljs-variable">centerX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">centerY</span> / <span class="hljs-variable">height_</span>, <span class="hljs-variable">leftX</span> / <span class="hljs-variable">width_</span>,  <span class="hljs-variable">leftY</span> / <span class="hljs-variable">height_</span>,</li><li>                                         <span class="hljs-variable">rotateX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">rotateY</span> / <span class="hljs-variable">height_</span>, <span class="hljs-variable">rightX</span> / <span class="hljs-variable">width_</span>, <span class="hljs-variable">rightY</span> / <span class="hljs-variable">height_</span>};</li><li>
</li><li>        <span class="hljs-comment">// Draw graphics</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">ExecuteDrawStar</span>(<span class="hljs-variable">position</span>, <span class="hljs-variable">DRAW_COLOR</span>, <span class="hljs-variable">shapeVertices</span>, <span class="hljs-title function_">sizeof</span>(<span class="hljs-variable">shapeVertices</span>))) {</li><li>            <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw execute draw star failed"</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// End drawing</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">FinishDraw</span>()) {</li><li>        <span class="hljs-title function_">OH_LOG_Print</span>(<span class="hljs-variable">LOG_APP</span>, <span class="hljs-variable">LOG_ERROR</span>, <span class="hljs-variable">LOG_PRINT_DOMAIN</span>, <span class="hljs-string">"EGLCore"</span>, <span class="hljs-string">"Draw FinishDraw failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">flag_</span> = <span class="hljs-keyword">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/cpp/EGLCore.cpp#L46-L81" target="_blank">EGLCore.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h2 id="section894815155911">调测验证<i class="anchor-icon anchor-icon-link" anchorid="section894815155911" tips="复制节点链接"></i></h2><p>抓取视频弹幕播放的systrace，三方应用调用RenderService进程进行弹幕绘制时，调用“H:RSDisplayRenderNodeDrawable Flush”函数，表示执行基于GPU硬件加速的渲染。</p> <p><span><img height="234.06936" originheight="415" originwidth="1084" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163445.82914261872644496645871225401895:50001231000000:2800:37CBEBBD1A2D1ADAB9FD6B74445B04F7D141DA06CC74D0CBD800133BD9647CFA.png" title="点击放大" width="611.4675000000001"></span></p> </div> <div class="tiledSection"><h2 id="section893964713405">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section893964713405" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/ndk-xcomponent" target="_blank">基于XComponent组件实现OpenGL图形绘制及YUV图像渲染功能</a></li></ul> </div> </div> <div></div></div>