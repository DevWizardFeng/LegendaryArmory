<h1 _ngcontent-vkl-c119="" class="doc-title ng-star-inserted" title="视频播放"> 视频播放 </h1>

<div _ngcontent-vkl-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section31226444581">概述<i class="anchor-icon anchor-icon-link" anchorid="section31226444581" tips="复制节点链接"></i></h2><p>本文适用于视频播放类应用的开发，针对市场上主流视频播放类应用的常见场景，介绍了如何基于HarmonyOS能力快速实现视频播放应用。</p> <p>从用户交互和音频流状态变更两个维度，指导开发者基于HarmonyOS提供的媒体和ArkUI等能力，实现视频前后台播放控制、播放形态切换、音频焦点切换、播放设备切换等场景，可以为视频播放应用提供灵活的交互体验和良好的观看效果。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在阅读本文之前，建议开发者先熟悉视频播放器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/video-playback" target="_blank">《AVPlayer实现》</a>，如果应用希望实现短视频播放功能，还需要参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-smooth-switching" target="_blank">《在线短视频流畅切换》</a>。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section194502434446">场景分析<i class="anchor-icon anchor-icon-link" anchorid="section194502434446" tips="复制节点链接"></i></h2></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.3.1.5.1.1" valign="top" width="10.4989501049895%"><p>场景名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.5.1.2" valign="top" width="27.817218278172184%"><p>子场景名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.5.1.3" valign="top" width="30.856914308569145%"><p>描述</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.3.1.5.1.4" valign="top" width="30.826917308269174%"><p>实现方案</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="8" valign="top" width="10.4989501049895%"><p>与用户交互</p> </td> <td class="cellrowborder" rowspan="3" valign="top" width="27.817218278172184%"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section56531643135417">播放进度控制</a></p> </td> <td class="cellrowborder" valign="top" width="30.856914308569145%"><p>进度条控制。</p> </td> <td class="cellrowborder" valign="top" width="30.826917308269174%"><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>实现进度条，在其onChange回调中触发进度调节。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>手势调节播放进度。</p> </td> <td class="cellrowborder" valign="top"><p>通过给组件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-gesture-settings#gesture" target="_blank">绑定手势识别</a>，来实现手势调节播放进度。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>显示进度条弹窗。</p> </td> <td class="cellrowborder" valign="top"><p>给进度条添加<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-popup" target="_blank">Popup弹窗</a>。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section15684157155512">播放形态切换</a></p> </td> <td class="cellrowborder" valign="top"><p>横竖屏切换。</p> </td> <td class="cellrowborder" valign="top"><p>基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-f#windowcreatewindow9" target="_blank">窗口能力</a>实现全屏播放。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>悬浮窗播放。</p> </td> <td class="cellrowborder" valign="top"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multi-window-layout-adapt" target="_blank">应用布局适配智慧多窗</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section070118277573">播控中心控制视频状态</a></p> </td> <td class="cellrowborder" valign="top"><p>应用响应播控中心通知，向播控中心同步视频信息状态。</p> </td> <td class="cellrowborder" valign="top"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-avsession-avsession" target="_blank">监听AVSession播放状态事件</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section1778613109412">视频后台播放</a></p> </td> <td class="cellrowborder" valign="top"><p>应用置于后台时可以继续播放。</p> </td> <td class="cellrowborder" valign="top"><p>基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-avsession-developer" target="_blank">AVSession Kit</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview" target="_blank">Background Tasks Kit</a>申请长时任务。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section1877775522017">滑动调节音量及亮度</a></p> </td> <td class="cellrowborder" valign="top"><p>视频全屏播放时，可以滑动屏幕调节音量及亮度。</p> </td> <td class="cellrowborder" valign="top"><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avvolumepanel" target="_blank">AVVolumePanel组件</a>控制音量，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>及<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setwindowbrightness9" target="_blank">setWindowBrightness()</a>方法控制亮度。</p> </td> </tr> <tr><td class="cellrowborder" rowspan="2" valign="top" width="10.4989501049895%"><p>音频流状态变更</p> </td> <td class="cellrowborder" valign="top" width="27.817218278172184%"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section89541936135617">多音频并发打断</a></p> </td> <td class="cellrowborder" valign="top" width="30.856914308569145%"><p>视频应用被其他应用的音频打断做出对应的行为。</p> </td> <td class="cellrowborder" valign="top" width="30.826917308269174%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiointerrupt9" target="_blank">AVPlayer监听音频打断事件</a>。</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p><a href="/consumer/cn/doc/best-practices/bpta-video-playback-development-practice#section9346952155612">播放设备切换</a></p> </td> <td class="cellrowborder" valign="top"><p>视频应用连接的播放设备状态发生变更时做出对应的行为。</p> </td> <td class="cellrowborder" valign="top"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiooutputdevicechangewithinfo11" target="_blank">AVPlayer监听设备音频流输出变化</a>。</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h2 id="section169581112135319">与用户交互<i class="anchor-icon anchor-icon-link" anchorid="section169581112135319" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section56531643135417" class="firsth2">播放进度控制<i class="anchor-icon anchor-icon-link" anchorid="section56531643135417" tips="复制节点链接"></i></h3><p><strong>进度条控制</strong></p> <p>进度条作为视频应用的一个基础能力，可以通过点击或拖动进度条来调节视频播放进度。采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>实现进度条功能，根据Slider组件属性设置进度条样式，并在其onChange()事件中触发视频播放器AVPlayer的seek()方法，实现视频进度的控制。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L456-L496" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Slider</span>({</li><li>  <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isSliderGesture</span> ? <span class="hljs-keyword">this</span>.<span class="hljs-title class_">panEndTime</span> : <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">currentTime</span>,</li><li>  <span class="hljs-variable">step</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_STEP</span>,</li><li>  <span class="hljs-variable">min</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_MIN</span>,</li><li>  <span class="hljs-variable">max</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">durationTime</span>,</li><li>  <span class="hljs-variable">style</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sliderStyle</span></li><li>})</li><li><span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">trackColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.color.white_opacity_1_color'</span>))<span class="hljs-comment">// Slide rail background color</span></li><li>  .<span class="hljs-title function_">showSteps</span>(<span class="hljs-keyword">false</span>)<span class="hljs-comment">// Whether to display step scale or not.</span></li><li>  .<span class="hljs-title function_">blockSize</span>({ <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blockSize</span>, <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blockSize</span> })<span class="hljs-comment">// Slider size</span></li><li>  .<span class="hljs-title function_">blockColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.color.background_primary'</span>))<span class="hljs-comment">// Slider color</span></li><li>  .<span class="hljs-title function_">trackThickness</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">trackThicknessSize</span>)<span class="hljs-comment">// Slide rail thickness</span></li><li>  .<span class="hljs-title function_">trackBorderRadius</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">TRACK_BORDER_RADIUS</span>)<span class="hljs-comment">// Radius of bottom fillet</span></li><li>  .<span class="hljs-title function_">selectedBorderRadius</span>(<span class="hljs-variable">CommonConstants</span>.<span class="hljs-variable">TRACK_BORDER_RADIUS</span>)<span class="hljs-comment">// Radius of fillet of sliding part</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onChange</span>((<span class="hljs-variable">value</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">mode</span>: <span class="hljs-title class_">SliderChangeMode</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">sliderOnchange</span>(<span class="hljs-variable">value</span>, <span class="hljs-variable">mode</span>); <span class="hljs-comment">// Progress bar change interface</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L456-L496" target="_blank">AVPlayer.ets</a></div></div></div></div> </div> <p><strong>手势调节播放进度</strong></p> <p>通常视频播放应用还可以支持手势滑动来调节播放的进度，可以给组件绑定手势识别，来实现在视频界面左右滑动调节视频播放进度的能力，手势类型选择<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>（平移手势）。</p> <ol><li>onActionStart()阶段使用本地变量记录当前视频播放的位置，并更新进度条状态变量，重新渲染UI界面；</li><li>onActionUpdate()阶段根据滑动的距离，计算滑动后视频应跳转的播放位置，并渲染UI界面进度条动效；</li><li>onActionEnd()阶段将最终计算出的播放位置传给AVPlayer控制器，调用AVPlayer的seek()方法让视频跳转到指定播放位置，并更新进度条状态变量，重新渲染UI界面。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L150-L366" data-highlighted="yes"><ol class="linenums"><li>build() {</li><li>  Stack({ alignContent: Alignment.BottomEnd }) {</li><li>    <span class="hljs-comment">// ...</span></li><li>          XComponent({</li><li>            id: <span class="hljs-string">'XComponent'</span>,</li><li>            type: XComponentType.SURFACE,</li><li>            controller: <span class="hljs-keyword">this</span>.xComponentController</li><li>          })<span class="hljs-comment">// ...</span></li><li>        }</li><li>
</li><li>        <span class="hljs-comment">// ...</span></li><li>  .gesture(</li><li>    PanGesture({ direction: PanDirection.Horizontal })</li><li>      .onActionStart((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.isSliderGesture = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-keyword">this</span>.panStartX = event.offsetX;</li><li>        <span class="hljs-keyword">this</span>.panStartTime = <span class="hljs-keyword">this</span>.avPlayerController.currentTime;</li><li>        <span class="hljs-keyword">this</span>.sliderOnchange(<span class="hljs-keyword">this</span>.panStartTime, SliderChangeMode.Begin);</li><li>      })</li><li>      .onActionUpdate((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-keyword">this</span>.isSliderGesture = <span class="hljs-literal">true</span>;</li><li>        let panTime: number =</li><li>          <span class="hljs-keyword">this</span>.panStartTime +</li><li>            (<span class="hljs-keyword">this</span>.panStartX + event.offsetX) / <span class="hljs-keyword">this</span>.slideWidth * <span class="hljs-keyword">this</span>.avPlayerController.durationTime;</li><li>        <span class="hljs-keyword">this</span>.panEndTime = Math.min(Math.max(<span class="hljs-number">0</span>, panTime), <span class="hljs-keyword">this</span>.avPlayerController.durationTime);</li><li>        <span class="hljs-keyword">this</span>.sliderOnchange(<span class="hljs-keyword">this</span>.panEndTime, SliderChangeMode.Moving);</li><li>      })</li><li>      .onActionEnd(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.sliderOnchange(<span class="hljs-keyword">this</span>.panEndTime, SliderChangeMode.End);</li><li>        <span class="hljs-keyword">this</span>.isSliderGesture = <span class="hljs-literal">false</span>;</li><li>      })</li><li>  )</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L150-L366" target="_blank">AVPlayer.ets</a></div></div></div></div> </li></ol> <p><strong>显示进度条弹窗</strong></p> <p>在正常浏览视频的过程中，应用会记录用户的浏览历史，当再次切换到原视频时，根据历史数据在进度条上以弹窗的形式显示相关信息。并且让弹窗跟随滑块位置移动，弹窗保留1秒后消失。同时历史数据的保留跟随视频组件的生命周期存亡。</p> <p>由于Slider自带的showTips无法对弹窗样式进行自定义，只支持圆形气泡，且无法自定义控制弹窗的显示时长和出现时机。所以我们通过创建一个和Slider滑块大小一致的透明Stack，并计算滑块在屏幕中的位置，将计算的位置数据同步设置给Stack，并给Stack绑定Popup弹窗跟随Slider滑块运动。</p> <p><span><img height="551.7638000000001" originheight="2258" originwidth="1088" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.54628516997606076057473777165155:50001231000000:2800:DE63360AD5E436B2FD537909776E8912EA6C8964BC18BAC029EAAF524FBAFE6B.png" title="点击放大" width="266"></span></p> <p><strong>关键代码：</strong></p> <p>通过给Slider组件绑定区域变化事件onAreaChange()，计算滑动位置信息。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L457-L495" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Slider</span>({</li><li>  <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">isSliderGesture</span> ? <span class="hljs-keyword">this</span>.<span class="hljs-title class_">panEndTime</span> : <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">currentTime</span>,</li><li>  <span class="hljs-variable">step</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_STEP</span>,</li><li>  <span class="hljs-variable">min</span>: <span class="hljs-title class_">CommonConstants</span>.<span class="hljs-title class_">SLIDER_MIN</span>,</li><li>  <span class="hljs-variable">max</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">avPlayerController</span>.<span class="hljs-title class_">durationTime</span>,</li><li>  <span class="hljs-variable">style</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sliderStyle</span></li><li>})</li><li><span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">blockSize</span>({ <span class="hljs-variable">width</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blockSize</span>, <span class="hljs-variable">height</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blockSize</span> })<span class="hljs-comment">// Slider size</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onAreaChange</span>(() =&gt; {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">videoSlider</span>: <span class="hljs-title class_">componentUtils</span>.<span class="hljs-title class_">ComponentInfo</span> =</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getComponentUtils</span>().<span class="hljs-title function_">getRectangleById</span>(<span class="hljs-string">'video_slider'</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">slideWidth</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable">videoSlider</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">width</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">offsetY</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable">videoSlider</span>.<span class="hljs-variable">localOffset</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">beginX</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(<span class="hljs-variable">videoSlider</span>.<span class="hljs-variable">localOffset</span>.<span class="hljs-variable">x</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">onAreaChange</span>  <span class="hljs-variable">failed</span>, <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  })</li><li>  .<span class="hljs-title function_">onChange</span>((<span class="hljs-variable">value</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">mode</span>: <span class="hljs-title class_">SliderChangeMode</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">sliderOnchange</span>(<span class="hljs-variable">value</span>, <span class="hljs-variable">mode</span>); <span class="hljs-comment">// Progress bar change interface</span></li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L457-L495" target="_blank">AVPlayer.ets</a></div></div></div></div> <p>Stack透明块大小、位置设置以及给Stack绑定Popup弹窗。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L506-L527" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set a transparent stack block with the same size as the Slider.</span></li><li><span class="hljs-title function_">Stack</span>() {</li><li>}</li><li>.<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.color.background_primary'</span>))</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">blockSize</span>)</li><li>.<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">blockSize</span>)</li><li>.<span class="hljs-title function_">borderRadius</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.float.font_size_20'</span>))</li><li>.<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isShowTips</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">None</span>)</li><li>.<span class="hljs-title function_">position</span>({ <span class="hljs-variable">x</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">tipsOffset</span>, <span class="hljs-variable">y</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">offsetY</span> })</li><li><span class="hljs-comment">//Bind the Popup to the Stack block and follow the Slider.</span></li><li>.<span class="hljs-title function_">bindPopup</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isShowTips</span>, {</li><li>  <span class="hljs-variable">builder</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">popupBuilder</span>,</li><li>  <span class="hljs-variable">placement</span>: <span class="hljs-title class_">Placement</span>.<span class="hljs-title class_">Top</span>,</li><li>  <span class="hljs-variable">mask</span>: <span class="hljs-keyword">false</span>,</li><li>  <span class="hljs-variable">arrowOffset</span>: <span class="hljs-number">0</span>,</li><li>  <span class="hljs-variable">popupColor</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">sys</span>.<span class="hljs-title class_">color</span>.<span class="hljs-title class_">background_primary</span>'),</li><li>  <span class="hljs-variable">backgroundBlurStyle</span>: <span class="hljs-title class_">BlurStyle</span>.<span class="hljs-title class_">BACKGROUND_ULTRA_THICK</span>,</li><li>  <span class="hljs-variable">enableArrow</span>: <span class="hljs-keyword">true</span>,</li><li>  <span class="hljs-variable">arrowPointPosition</span>: <span class="hljs-title class_">ArrowPointPosition</span>.<span class="hljs-title class_">CENTER</span>,</li><li>  <span class="hljs-variable">radius</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">blockSize</span>,</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L506-L527" target="_blank">AVPlayer.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section15684157155512">播放形态切换<i class="anchor-icon anchor-icon-link" anchorid="section15684157155512" tips="复制节点链接"></i></h3><p><strong>横竖屏切换</strong></p> <p>横竖屏切换是视频应用常见的功能，用户会根据自己喜好选择在横屏或竖屏模式下观看。</p> <p>设置窗口旋转策略有两种方式：</p> <ol><li>通过module.json5文件中“orientation”字段进行设置。</li><li>在代码中通过调用窗口window的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setpreferredorientation9" target="_blank">setPreferredOrientation()</a>方法进行设置。</li></ol> <p>这两种方式触发设置旋转的时机不同，module.json5文件中的字段在窗口启动时就会生效，对于应用启动时就需要设置横屏或者竖屏的应用，可以进行配置。而setPreferredOrientation()是在调用该方法时进行窗口方向的设置，用于在应用启动之后，还需要改变显示方向的场景。</p> <p>本示例主要介绍通过使用窗口的setPreferredOrientation()方法来实现应用的横竖屏切换能力，下面给出具体实现方案，更多详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-landscape-and-portrait-development" target="_blank">横竖屏开发实践</a>。</p> <ol><li>设置窗口旋转<p>当进入首页视频列表时，仅支持竖屏，要切换视频播放页面为横屏时，采用window窗口能力，通过setPreferredOrientation()将窗口显示的方向修改为横屏、竖屏的状态。在使用时，根据应用自身的旋转策略选择相应的参数。窗口显示方向类型枚举可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-e#orientation9" target="_blank">window.Orientation</a>。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L84-L98" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Select the corresponding parameters according to the rotation strategy of the application itself.</span></li><li><span class="hljs-title function_">setMainWindowOrientation</span>(<span class="hljs-attr">orientation</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Orientation</span>, callback?: <span class="hljs-title class_">Function</span>): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainWindowClass</span>.<span class="hljs-title function_">setPreferredOrientation</span>(orientation).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    callback?.();</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`Failed to set the <span class="hljs-subst">${orientation}</span> of main window. Code:<span class="hljs-subst">${err.code}</span>, message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L84-L98" target="_blank">WindowUtil.ets</a></div></div></div></div> </li><li>监听窗口变化<p>当用户手动设置窗口方向时，窗口的显示会发生变化，对应窗口的size也会发生改变，此时可以通过拿到窗口的宽高，并对宽高进行对比，判断当前显示是竖屏还是横屏状态，并利用该数据对布局进行适配。监听窗口尺寸的变化可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onwindowsizechange7" target="_blank">window.on('windowSizeChange')</a>进行实现。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L46-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Turn on window size monitoring in aboutToAppear</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">windowClass</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Window</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(context);</li><li>    <span class="hljs-keyword">await</span> windowClass.<span class="hljs-title function_">setWindowKeepScreenOn</span>(<span class="hljs-literal">true</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`aboutToAppear failed, err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>  <span class="hljs-comment">// Register window size monitoring</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">windowUtil</span>.<span class="hljs-title function_">registerOnWindowSizeChange</span>(<span class="hljs-function">(<span class="hljs-params">size</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (size.<span class="hljs-property">width</span> &gt; size.<span class="hljs-property">height</span>) {</li><li>      <span class="hljs-comment">// Horizontal screen logic</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFullLandscapeScreen</span> = <span class="hljs-literal">true</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// Vertical screen logic</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">isFullLandscapeScreen</span> = <span class="hljs-literal">false</span>;</li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L46-L65" target="_blank">IndexPage.ets</a></div></div></div></div> </li></ol> </div> <p><strong>悬浮窗播放</strong></p> <p>视频应用添加悬浮窗能力，可以让用户在观看视频时，临时处理另一个任务或短时间多任务并行使用，如边看视频边浏览网页等行为，更多可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/multi-window-layout-adapt" target="_blank">应用布局适配智慧多窗</a>。</p> <ol><li>声明支持悬浮窗<p>首先需要通过对module.json5配置文件中abilities标签下的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-bundlemanager#supportwindowmode" target="_blank">supportWindowMode</a>属性增加“floating”字段或使用缺省值以声明应用支持悬浮窗。</p> <p>因为本视频应用需要支持横向和竖向悬浮窗两种能力，所以还需对abilities标签下的preferMultiWindowOrientation属性设置为landscape_auto，来标识当前UIAbility组件多窗布局方向。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/module.json5#L42-L74" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"abilities"</span>: [</li><li>  {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"preferMultiWindowOrientation"</span>: <span class="hljs-string">"landscape_auto"</span>,</li><li>  }</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/module.json5#L42-L74" target="_blank">module.json5</a></div></div></div></div> </li><li>适配悬浮窗布局<p>由于应用从全屏进入悬浮窗后，应用的窗口尺寸会发生变化，所以应用需要根据不同的窗口尺寸调整自身布局。可以通过窗口的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onwindowsizechange7" target="_blank">on('windowSizeChange')</a>方法实现对窗口尺寸大小变化的监听。再根据窗口的尺寸变化，更新调整自身应用布局以实现适配。</p> <ol><li>在onWindowStageCreate()方法中，获取Window对象。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/entryability/EntryAbility.ets#L35-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onWindowStageCreate</span>(<span class="hljs-variable">windowStage</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">WindowStage</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/entryability/EntryAbility.ets#L35-L63" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>通过getWindowProperties()方法返回值中的windowRect获取窗口尺寸，写入AppStorage中用于UI侧窗口尺寸的首次初始化赋值。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L37-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">setWindowStage</span>(<span class="hljs-variable">windowStage</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">WindowStage</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'uiContext'</span>);</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowStage</span> = <span class="hljs-variable">windowStage</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">windowStage</span>.<span class="hljs-title function_">getMainWindow</span>((<span class="hljs-variable">err</span>, <span class="hljs-variable">windowClass</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">Window</span>) =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">mainWindowClass</span> = <span class="hljs-variable">windowClass</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-variable">properties</span>: <span class="hljs-title class_">window</span>.<span class="hljs-title class_">WindowProperties</span> = <span class="hljs-variable">windowClass</span>.<span class="hljs-title function_">getWindowProperties</span>(); <span class="hljs-comment">// Get window information</span></li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'deviceWidth'</span>, <span class="hljs-variable">properties</span>.<span class="hljs-variable">windowRect</span>.<span class="hljs-variable">width</span>); <span class="hljs-comment">// Set the window width</span></li><li>      <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'deviceHeight'</span>, <span class="hljs-variable">properties</span>.<span class="hljs-variable">windowRect</span>.<span class="hljs-variable">height</span>); <span class="hljs-comment">// Set the window height</span></li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setWindowStage</span> <span class="hljs-variable">getWindowProperties</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">Code</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L37-L70" target="_blank">WindowUtil.ets</a></div></div></div></div> </li><li>使用on('windowSizeChange')注册窗口尺寸变化时的监听，并写入AppStorage中供UI侧布局使用。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L138-L154" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">registerOnWindowSizeChange</span>(callback?: <span class="hljs-function">(<span class="hljs-params">size: <span class="hljs-variable language_">window</span>.Size</span>) =&gt;</span> <span class="hljs-keyword">void</span>): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">mainWindowClass</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">size</span>) =&gt;</span> {</li><li>    <span class="hljs-comment">//Because the real width of the application window is the screen width in the mobile phone, there is no need to change the width.</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'deviceHeight'</span>, size.<span class="hljs-property">height</span>);</li><li>    callback?.(size);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/utils/WindowUtil.ets#L138-L154" target="_blank">WindowUtil.ets</a></div></div></div></div> </li><li>UI侧通过@StorageProp绑定窗口尺寸后，AppStorage中属性key值对应的数据一旦改变，UI侧会同步修改。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L28-L250" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Entry</span></li><li><span class="hljs-variable">@Component</span></li><li>struct IndexPage {</li><li>  <span class="hljs-variable">@State</span> <span class="hljs-attribute">isFloatWindow</span>: boolean = false;</li><li>  <span class="hljs-variable">@StorageProp</span>(<span class="hljs-string">'deviceHeight'</span>) <span class="hljs-variable">@Watch</span>(<span class="hljs-string">'onWindowSizeChange'</span>) <span class="hljs-attribute">deviceHeight</span>: number =</li><li>    AppStorage.get&lt;number&gt;(<span class="hljs-string">'deviceHeight'</span>) || <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-selector-tag">onWindowSizeChange</span>(): <span class="hljs-selector-tag">void</span> {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L28-L250" target="_blank">IndexPage.ets</a></div></div></div></div> </li><li>@Watch用于对状态变量的监听，所以窗口尺寸发生变化时，会引起组件的重新渲染，开发者可以根据最新的窗口尺寸动态调整应用布局。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L232-L248" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Because the width and height of the floating window are the system default, the value of isFloatWindow (whether to display the floating window or not) is only processed according to the height of the window, which is used to control the display and concealment of the interface components.</span></li><li>onWindowSizeChange(): void {</li><li>  let deviceWidth: number = AppStorage.<span class="hljs-keyword">get</span>&lt;number&gt;(<span class="hljs-string">'deviceWidth'</span>) || <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// Judge whether it is a horizontal screen or a vertical screen suspension window.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFullLandscapeScreen &amp;&amp; Math.round((<span class="hljs-keyword">this</span>.deviceHeight / deviceWidth) * <span class="hljs-number">1000</span>) / <span class="hljs-number">1000</span> === <span class="hljs-number">0.563</span>) {</li><li>    <span class="hljs-keyword">this</span>.isFloatWindow = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFullScreen &amp;&amp;</li><li>    (Math.round((deviceWidth / <span class="hljs-keyword">this</span>.deviceHeight) * <span class="hljs-number">1000</span>) / <span class="hljs-number">1000</span> === <span class="hljs-number">0.563</span></li><li>      || Math.round((deviceWidth / <span class="hljs-keyword">this</span>.deviceHeight) * <span class="hljs-number">10</span>) / <span class="hljs-number">10</span> === <span class="hljs-number">0.6</span>)) {</li><li>    <span class="hljs-keyword">this</span>.isFloatWindow = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.isFloatWindow = <span class="hljs-literal">false</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/pages/IndexPage.ets#L232-L248" target="_blank">IndexPage.ets</a></div></div></div></div> </li></ol> </li></ol> <div class="tiledSection"><h3 id="section070118277573">播控中心控制视频状态<i class="anchor-icon anchor-icon-link" anchorid="section070118277573" tips="复制节点链接"></i></h3><p>用户除了在视频界面控制视频状态外，还可以通过给应用接入AVSession播控中心，使用户在播控中心也能看到当前播放视频的信息，并通过播控中心直接对视频进行快进、快退、拖动进度、播放暂停、切换、调节音量等操作。同时应用内的视频状态与信息也会与播控中心相互同步，避免了只有在视频界面才能控制视频状态的单一场景，更多详情可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-access-scene" target="_blank">应用接入AVSession场景介绍</a>。</p> </div> <ol><li>创建并激活媒体会话<p>在AvSessionController初始化时，通过createAVSession()创建AVSession实例并激活媒体会话，视频应用选择会话类型为video。开发者可根据应用的类型选择对应的会话。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionControllerPCode.ets#L17-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">Logger</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/Logger'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">TAG</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'AvSessionController'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AvSessionController</span> {</li><li>  <span class="hljs-keyword">private</span> avSession?: avSession.<span class="hljs-property">AVSession</span>;</li><li>  <span class="hljs-keyword">private</span> context?: common.<span class="hljs-property">UIAbilityContext</span>;</li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">initAvSession</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'context'</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`session create failed : context is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Create an AVSession with the session type set to' video'.</span></li><li>    avSession.<span class="hljs-title function_">createAVSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">"SHORT_AUDIO_SESSION"</span>, <span class="hljs-string">'video'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (avSession) =&gt; {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span> = avSession;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`session create successed : sessionId : <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.avSession.sessionId}</span>`</span>);</li><li>      <span class="hljs-comment">//Sets the UIAbility for being pulled up by the broadcast control center.</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setLaunchAbility</span>();</li><li>      <span class="hljs-comment">// Activate media session</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>.<span class="hljs-title function_">activate</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`avSession activate failed: err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`avSession activate failed: err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionControllerPCode.ets#L17-L51" target="_blank">AvSessionControllerPCode.ets</a></div></div></div></div> </li><li>设置媒体会话元数据<p>应用可以通过setAVMetadata()把会话的一些元数据信息设置给系统，从而在播控中心界面进行展示。如媒体ID（assetId）、标题（title）、播控中心显示的图片（mediaImage）、媒体时长（duration）等。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L81-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">setAVMetadata</span>(<span class="hljs-variable">curSource</span>: <span class="hljs-title class_">VideoData</span>, <span class="hljs-variable">duration</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">imagePixMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">ImageUtil</span>.<span class="hljs-title function_">getPixmapFromMedia</span>(<span class="hljs-variable">curSource</span>.<span class="hljs-variable">head</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">imagePixMap</span> === <span class="hljs-variable">undefined</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'SetAVMetadata Error, imagePixMap is undefined'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">metadata</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">AVMetadata</span> = {</li><li>      <span class="hljs-variable">assetId</span>: `${<span class="hljs-variable">curSource</span>.<span class="hljs-variable">index</span>}`, <span class="hljs-comment">// Media ID</span></li><li>      <span class="hljs-variable">title</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">resourceManager</span>.<span class="hljs-title class_">getStringSync</span>(<span class="hljs-title class_">curSource</span>.<span class="hljs-title class_">name</span>.<span class="hljs-title class_">id</span>), <span class="hljs-comment">// title</span></li><li>      <span class="hljs-variable">mediaImage</span>: <span class="hljs-title class_">imagePixMap</span>, <span class="hljs-comment">// Pixel data or picture path address of a picture.</span></li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-title class_">duration</span> <span class="hljs-comment">// Media duration, in ms</span></li><li>    };</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>.<span class="hljs-title function_">setAVMetadata</span>(<span class="hljs-variable">metadata</span>).<span class="hljs-title function_">then</span>(() =&gt; { <span class="hljs-comment">// Call the set session metadata interface</span></li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSessionMetadata</span> = <span class="hljs-variable">metadata</span>;</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">"SetAVMetadata successfully"</span>);</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">SetAVMetadata</span> <span class="hljs-variable">BusinessError</span>: <span class="hljs-title class_">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">setAVMetadata</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L81-L112" target="_blank">AvSessionController.ets</a></div></div></div></div> </li><li>设置用于被播控中心拉起的UIAbility<p>当用户操作媒体会话控制方的界面时，例如点击播控中心的卡片，可以拉起此处配置的UIAbility。将封装的WantAgent通过setLaunchAbility()配置给媒体会话，更多关于WantAgent的信息请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-wantagent" target="_blank">WantAgent</a>。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L116-L143" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setLaunchAbility</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>, <span class="hljs-comment">// Name of the application Bundle where the Ability to be started is located.</span></li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span> <span class="hljs-comment">// Ability name to be started</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITIES</span>, <span class="hljs-comment">// Action type, START_ABILITY indicates the Ability to open multiple pages.</span></li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>, <span class="hljs-comment">// A user-defined private value.</span></li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>] <span class="hljs-comment">// Action execution attribute, UPDATE_PRESENT_FLAG means replacing the extra data in the existing WantAgent with the extra data of the new WantAgent.</span></li><li>  };</li><li>  <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">agent</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSession</span>.<span class="hljs-title function_">setLaunchAbility</span>(<span class="hljs-variable">agent</span>).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">avSession</span> <span class="hljs-variable">setLaunchAbility</span> <span class="hljs-variable">failed</span>: <span class="hljs-title class_">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>      });</li><li>    }</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>: <span class="hljs-title class_">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L116-L143" target="_blank">AvSessionController.ets</a></div></div></div></div> </li><li>注册播控命令事件监听<p>便于响应用户通过播控中心下发的播控命令，比如播放、暂停、停止、快进、快退等。同时只有设置了相关的事件回调，播控中心上对应的按钮才会亮起，否则为置灰状态。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L124-L140" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> async setAvSessionListener(): Promise&lt;void&gt; {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avSessionController) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'play'</span>, () =&gt; <span class="hljs-keyword">this</span>.sessionPlayCallback());</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'pause'</span>, () =&gt; <span class="hljs-keyword">this</span>.sessionPauseCallback());</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'stop'</span>, () =&gt; <span class="hljs-keyword">this</span>.sessionStopCallback());</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'fastForward'</span>,</li><li>      (time?: number) =&gt; <span class="hljs-keyword">this</span>.sessionFastForwardCallback(time));</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'rewind'</span>, (time?: number) =&gt; <span class="hljs-keyword">this</span>.sessionRewindCallback(time));</li><li>    <span class="hljs-keyword">this</span>.avSessionController.getAvSession()?.on(<span class="hljs-string">'seek'</span>, (seekTime: number) =&gt; <span class="hljs-keyword">this</span>.sessionSeekCallback(seekTime));</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    Logger.error(TAG, `setAvSessionListener failed, code <span class="hljs-keyword">is</span> ${err.code}, message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L124-L140" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li><li>应用状态上报播控中心<p>当视频状态发生改变时，需要通过setAVPlaybackState()向播控中心上报视频状态，来达到播控中心与应用的状态同步，包括播放状态（state）、播放位置（position）、当前媒体播放时长（duration）等。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L285-L301" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">updateIsPlay</span>(<span class="hljs-variable">isPlay</span>: <span class="hljs-title class_">boolean</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">curIndex</span> !== <span class="hljs-keyword">this</span>.<span class="hljs-variable">curSource</span>.<span class="hljs-variable">index</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">isPlaying</span> = <span class="hljs-variable">isPlay</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">avSessionController</span>.<span class="hljs-title function_">setAvSessionPlayState</span>({</li><li>    <span class="hljs-variable">state</span>: <span class="hljs-title class_">isPlay</span> ? <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">PlaybackState</span>.<span class="hljs-title class_">PLAYBACK_STATE_PLAY</span> :</li><li>    <span class="hljs-variable">avSession</span>.<span class="hljs-variable">PlaybackState</span>.<span class="hljs-variable">PLAYBACK_STATE_PAUSE</span>, <span class="hljs-comment">//Playback status</span></li><li>    <span class="hljs-variable">position</span>: {</li><li>      <span class="hljs-comment">// Playback position</span></li><li>      <span class="hljs-variable">elapsedTime</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentTime</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// Elapsed time in milliseconds (ms)</span></li><li>      <span class="hljs-variable">updateTime</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title class_">getTime</span>() <span class="hljs-comment">// Update time, in ms</span></li><li>    },</li><li>    <span class="hljs-variable">duration</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">duration</span> <span class="hljs-comment">// The duration of the current media resource</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L285-L301" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section1778613109412">视频后台播放<i class="anchor-icon anchor-icon-link" anchorid="section1778613109412" tips="复制节点链接"></i></h3></div> <p>用户在观看视频时，会遇到退出视频应用至后台的情况。当应用退到后台时，应用进程很快就会被挂机，所以为满足视频可以在后台持续播放的能力，需要对视频应用申请长时任务，来防止应用进程挂起。同时配合AVSession播控能力，用户可以做到在后台直接与视频应用进行交互，达到更加灵活的体验效果。更多可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/background-task-overview" target="_blank">Background Tasks Kit</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>只有使用了媒体会话服务（AVSession）的音视频应用，才能申请长时任务实现后台播放。</p> </div></div></div> <p><strong>接入流程和关键代码</strong></p> <ol><li>申请后台运行权限和声明后台模式<p>在module.json5配置文件中申请ohos.permission.KEEP_BACKGROUND_RUNNING权限和配置后台模式audioPlayback。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/module.json5#L17-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:reason_background"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span></li><li>    }</li><li>  },</li><li>  <span class="hljs-comment">// ...</span></li><li>],</li><li><span class="hljs-string">"abilities"</span>: [</li><li>  {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-string">"backgroundModes"</span>: [</li><li>      <span class="hljs-string">"audioPlayback"</span></li><li>    ],</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/module.json5#L17-L73" target="_blank">module.json5</a></div></div></div></div> </li><li>创建后台管理类<p>通过获取到的UIAbility上下文和wantAgent模块下getWantAgent()方法获取WantAgent对象，使用BackgroundTasksKit的startBackgroundRunning()、stopBackgroundRunning()方法分别申请和取消后台运行任务，长时任务类型选择AUDIO_PLAYBACK，表示视频后台播放。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/utils/BackgroundTaskManager.ets#L16-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">common</span>, <span class="hljs-variable">wantAgent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">backgroundTaskManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BackgroundTasksKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> <span class="hljs-package">Logger</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./Logger'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">TAG</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'[BackgroundTaskManager]'</span>;</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Background task tool class.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundTaskManager</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">startContinuousTask</span>(<span class="hljs-variable">context</span>?: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">context</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>      <span class="hljs-variable">wants</span>: [</li><li>        {</li><li>          <span class="hljs-variable">bundleName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>          <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>        }</li><li>      ],</li><li>      <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITY</span>,</li><li>      <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>    };</li><li>
</li><li>    <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">wantAgentObj</span>) =&gt; {</li><li>      <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-variable">context</span>,</li><li>        <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-variable">BackgroundMode</span>.<span class="hljs-variable">AUDIO_PLAYBACK</span>, <span class="hljs-variable">wantAgentObj</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'startBackgroundRunning succeeded'</span>);</li><li>      }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>        <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">startBackgroundRunning</span> <span class="hljs-variable">failed</span> <span class="hljs-variable">Cause</span>:  ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>      });</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getWantAgent</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>:${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// cancel continuous task</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">stopContinuousTask</span>(<span class="hljs-variable">context</span>?: <span class="hljs-title class_">common</span>.<span class="hljs-title class_">UIAbilityContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">context</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable">backgroundTaskManager</span>.<span class="hljs-title function_">stopBackgroundRunning</span>(<span class="hljs-variable">context</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable">TAG</span>, <span class="hljs-string">'stopBackgroundRunning succeeded'</span>);</li><li>    }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">stopBackgroundRunning</span> <span class="hljs-variable">failed</span> <span class="hljs-variable">Cause</span>:  ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">err</span>)}`);</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/utils/BackgroundTaskManager.ets#L16-L66" target="_blank">BackgroundTaskManager.ets</a></div></div></div></div> </li><li>申请和销毁后台长时任务<p>在AVSession创建和释放时，分别申请和销毁后台长时任务。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L45-L182" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">initAvSession</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'context'</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    avSession.<span class="hljs-title function_">createAVSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">"SHORT_AUDIO_SESSION"</span>, <span class="hljs-string">'video'</span>).<span class="hljs-title function_">then</span>(<span class="hljs-keyword">async</span> (avSession) =&gt; {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span> = avSession;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`session create successed : sessionId : <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.avSession.sessionId}</span>`</span>);</li><li>      <span class="hljs-comment">// Apply for background long-term tasks</span></li><li>      <span class="hljs-title class_">BackgroundTaskManager</span>.<span class="hljs-title function_">startContinuousTask</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setLaunchAbility</span>();</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSession</span>.<span class="hljs-title function_">activate</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`avSession activate failed: err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      });</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`avSession activate failed: err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`createAVSession failed, err.code:<span class="hljs-subst">${err.code}</span>, err.message:<span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">unregisterSessionListener</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Destroy background long-term tasks</span></li><li>  <span class="hljs-title class_">BackgroundTaskManager</span>.<span class="hljs-title function_">stopContinuousTask</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvSessionController.ets#L45-L182" target="_blank">AvSessionController.ets</a></div></div></div></div> </li></ol> <div class="tiledSection"><h3 id="section1877775522017">滑动调节音量及亮度<i class="anchor-icon anchor-icon-link" anchorid="section1877775522017" tips="复制节点链接"></i></h3><p>在全屏播放视频的场景下，滑动调节音量及亮度是一项非常实用的功能，它允许用户在不离开视频播放界面的情况下，快速调整音量和亮度，展示音量及亮度大小，以获得更好的观影体验。该功能分为两部分，左侧滑动调整音量，右侧滑动调整亮度。</p> <p><strong>左侧滑动调节音量</strong></p> <p>在屏幕的左侧区域，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avvolumepanel" target="_blank">AVVolumePanel组件</a>显示系统音量面板，绑定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>滑动手势事件，设置滑动方向为竖直方向，当Pan手势在移动过程中，上滑增加或者下滑减少音量，实现控制系统音量的功能。</p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avvolumepanel" target="_blank">AVVolumePanel组件</a>设置音量面板；<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L207-L218" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">AVVolumePanel</span>({</li><li>    <span class="hljs-variable">volumeLevel</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">volume</span>,</li><li>    <span class="hljs-variable">volumeParameter</span>: {</li><li>      <span class="hljs-variable">position</span>: {</li><li>        <span class="hljs-variable">x</span>: <span class="hljs-number">150</span>,</li><li>        <span class="hljs-variable">y</span>: <span class="hljs-number">300</span></li><li>      }</li><li>    }</li><li>  })</li><li>}</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L207-L218" target="_blank">AVPlayer.ets</a></div></div></div></div> </li><li>绑定PanGesture滑动手势事件。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L279-L321" data-highlighted="yes"><ol class="linenums"><li>.gesture(</li><li>  PanGesture({ direction: PanDirection.Vertical })</li><li>    .onActionStart(() =&gt; {</li><li>    })</li><li>    .onActionUpdate((event: GestureEvent) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (event.fingerList[<span class="hljs-number">0</span>].globalX &gt; (CommonConstants.FULL_SCREEN_WIDTH / <span class="hljs-number">2</span>)) {</li><li>        <span class="hljs-comment">// On the right side of the screen relative to the X-axis coordinate in the upper left corner of the application window, adjust the brightness.</span></li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">true</span>;</li><li>        let curBrightness: number = <span class="hljs-keyword">this</span>.screenBrightness -</li><li>          <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.getUIContext().vp2px(<span class="hljs-keyword">this</span>.screenHeight);</li><li>        curBrightness = Math.max(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">1.0</span>, curBrightness));</li><li>        <span class="hljs-keyword">this</span>.screenBrightness = curBrightness;</li><li>        Logger.info(TAG, `<span class="hljs-keyword">this</span> brightness <span class="hljs-keyword">is</span>: ` + <span class="hljs-keyword">this</span>.screenBrightness);</li><li>
</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">this</span>.mainWin?.setWindowBrightness(<span class="hljs-keyword">this</span>.screenBrightness, (err) =&gt; {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              Logger.error(TAG, `Failed to <span class="hljs-keyword">set</span> the brightness. Cause: ${JSON.stringify(err)}`);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            Logger.info(TAG, `Succeeded <span class="hljs-keyword">in</span> setting the brightness.`);</li><li>          });</li><li>        } <span class="hljs-keyword">catch</span> (exception) {</li><li>          Logger.error(TAG, `Failed to <span class="hljs-keyword">set</span> the brightness.`);</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// On the left side of the screen relative to the X-axis coordinate in the upper left corner of the application window, adjust the volume.</span></li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>        let curVolume: number = <span class="hljs-keyword">this</span>.volume - <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.screenHeight;</li><li>        curVolume = curVolume &gt;= <span class="hljs-number">15.0</span> ? <span class="hljs-number">15.0</span> : curVolume;</li><li>        curVolume = curVolume &lt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">0.0</span> : curVolume;</li><li>        <span class="hljs-keyword">this</span>.volume = curVolume;</li><li>        Logger.info(TAG, `<span class="hljs-keyword">this</span> volume <span class="hljs-keyword">is</span>: ` + <span class="hljs-keyword">this</span>.volume);</li><li>      }</li><li>    })</li><li>    .onActionEnd(() =&gt; {</li><li>      setTimeout(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>      }, <span class="hljs-number">3000</span>)</li><li>    })</li><li>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L279-L321" target="_blank">AVPlayer.ets</a></div></div></div></div> </li></ol> <p><strong>右侧滑动调节亮度</strong></p> <p>在屏幕的右侧区域，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>设置一个亮度面板，绑定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>滑动手势事件，设置滑动方向为竖直方向，当Pan手势在移动过程中调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#setwindowbrightness9" target="_blank">setWindowBrightness</a>方法，实现上滑增加或者下滑减少亮度的功能。</p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-slider" target="_blank">Slider组件</a>设置亮度面板；<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L221-L257" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">Stack</span>() {</li><li>    <span class="hljs-title function_">Slider</span>({</li><li>      <span class="hljs-variable">value</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">screenBrightness</span>,</li><li>      <span class="hljs-variable">min</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">max</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-variable">step</span>: <span class="hljs-number">0.1</span>,</li><li>      <span class="hljs-variable">style</span>: <span class="hljs-title class_">SliderStyle</span>.<span class="hljs-title class_">NONE</span>,</li><li>      <span class="hljs-variable">direction</span>: <span class="hljs-title class_">Axis</span>.<span class="hljs-title class_">Vertical</span>,</li><li>      <span class="hljs-variable">reverse</span>: <span class="hljs-keyword">true</span></li><li>    })</li><li>      .<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">visible</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">Hidden</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">160</span>)</li><li>      .<span class="hljs-title function_">selectedColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span>)</li><li>      .<span class="hljs-title function_">trackColor</span>(<span class="hljs-variable">Color</span>.<span class="hljs-variable">Black</span>)</li><li>      .<span class="hljs-title function_">trackThickness</span>(<span class="hljs-number">40</span>)</li><li>
</li><li>    <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.sun_max_fill'</span>))</li><li>      .<span class="hljs-title function_">visibility</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">visible</span> ? <span class="hljs-variable">Visibility</span>.<span class="hljs-variable">Visible</span> : <span class="hljs-title class_">Visibility</span>.<span class="hljs-title class_">Hidden</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-number">120</span> })</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-number">20</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-number">20</span>)</li><li>  }</li><li>  .<span class="hljs-title function_">margin</span>({</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-number">0</span></li><li>  })</li><li>}</li><li>.<span class="hljs-title function_">alignItems</span>(<span class="hljs-variable">HorizontalAlign</span>.<span class="hljs-variable">End</span>)</li><li>.<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">Center</span>)</li><li>.<span class="hljs-title function_">padding</span>({</li><li>  <span class="hljs-variable">right</span>: <span class="hljs-number">30</span>,</li><li>  <span class="hljs-variable">bottom</span>: <span class="hljs-number">20</span></li><li>})</li><li>.<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>.<span class="hljs-title function_">width</span>(<span class="hljs-string">'50%'</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L221-L257" target="_blank">AVPlayer.ets</a></div></div></div></div> </li><li>绑定PanGesture滑动手势事件。<div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L280-L322" data-highlighted="yes"><ol class="linenums"><li>.gesture(</li><li>  PanGesture({ direction: PanDirection.Vertical })</li><li>    .onActionStart(() =&gt; {</li><li>    })</li><li>    .onActionUpdate((event: GestureEvent) =&gt; {</li><li>      <span class="hljs-keyword">if</span> (event.fingerList[<span class="hljs-number">0</span>].globalX &gt; (CommonConstants.FULL_SCREEN_WIDTH / <span class="hljs-number">2</span>)) {</li><li>        <span class="hljs-comment">// On the right side of the screen relative to the X-axis coordinate in the upper left corner of the application window, adjust the brightness.</span></li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">true</span>;</li><li>        let curBrightness: number = <span class="hljs-keyword">this</span>.screenBrightness -</li><li>          <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.getUIContext().vp2px(<span class="hljs-keyword">this</span>.screenHeight);</li><li>        curBrightness = Math.max(<span class="hljs-number">0</span>, Math.min(<span class="hljs-number">1.0</span>, curBrightness));</li><li>        <span class="hljs-keyword">this</span>.screenBrightness = curBrightness;</li><li>        Logger.info(TAG, `<span class="hljs-keyword">this</span> brightness <span class="hljs-keyword">is</span>: ` + <span class="hljs-keyword">this</span>.screenBrightness);</li><li>
</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">this</span>.mainWin?.setWindowBrightness(<span class="hljs-keyword">this</span>.screenBrightness, (err) =&gt; {</li><li>            <span class="hljs-keyword">if</span> (err) {</li><li>              Logger.error(TAG, `Failed to <span class="hljs-keyword">set</span> the brightness. Cause: ${JSON.stringify(err)}`);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            Logger.info(TAG, `Succeeded <span class="hljs-keyword">in</span> setting the brightness.`);</li><li>          });</li><li>        } <span class="hljs-keyword">catch</span> (exception) {</li><li>          Logger.error(TAG, `Failed to <span class="hljs-keyword">set</span> the brightness.`);</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// On the left side of the screen relative to the X-axis coordinate in the upper left corner of the application window, adjust the volume.</span></li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>        let curVolume: number = <span class="hljs-keyword">this</span>.volume - <span class="hljs-keyword">this</span>.getUIContext().vp2px(event.offsetY) / <span class="hljs-keyword">this</span>.screenHeight;</li><li>        curVolume = curVolume &gt;= <span class="hljs-number">15.0</span> ? <span class="hljs-number">15.0</span> : curVolume;</li><li>        curVolume = curVolume &lt;= <span class="hljs-number">0.0</span> ? <span class="hljs-number">0.0</span> : curVolume;</li><li>        <span class="hljs-keyword">this</span>.volume = curVolume;</li><li>        Logger.info(TAG, `<span class="hljs-keyword">this</span> volume <span class="hljs-keyword">is</span>: ` + <span class="hljs-keyword">this</span>.volume);</li><li>      }</li><li>    })</li><li>    .onActionEnd(() =&gt; {</li><li>      setTimeout(() =&gt; {</li><li>        <span class="hljs-keyword">this</span>.visible = <span class="hljs-literal">false</span>;</li><li>      }, <span class="hljs-number">3000</span>)</li><li>    })</li><li>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/entry/src/main/ets/view/AVPlayer.ets#L280-L322" target="_blank">AVPlayer.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section198743244560">音频流状态交互<i class="anchor-icon anchor-icon-link" anchorid="section198743244560" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section89541936135617" class="firsth2">多音频并发打断<i class="anchor-icon anchor-icon-link" anchorid="section89541936135617" tips="复制节点链接"></i></h3></div> <p>当多个音频流并发播放时，如果系统不加管控，会造成多音频流混音播放，容易让用户感到嘈杂，造成不好的用户体验。为了解决这个问题，系统预设了音频打断策略，对多音频播放的并发进行管控，只有持有音频焦点的音频流才可以正常播放，避免出现多个音频流无序并发播放的现象。当音频打断事件发生时，系统会根据预设策略，对音频流做出相应的操作，并向音频流状态变化的应用发送音频打断事件。更多详情可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency" target="_blank">处理音频焦点事件</a>。</p> <p>通过给AVPlayer设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiointerrupt9" target="_blank">on('audioInterrupt')</a>函数进行监听，当收到音频打断事件（InterruptEvent）时，应用根据其内容做出相应的处理策略。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1.如果使用了AVPlayer播放视频，audioRendererInfo会被默认设置成Movie，应用无需处理。</p> <p>2.使用on('audioInterrupt')监听音频打断时，要注意使用的视频资源必须有音频流，否则无法触发音频打断事件。</p> </div></div></div> <p><strong>音频打断状态图</strong></p> <p><span><img height="637.161105" originheight="734" originwidth="1002" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.43297505863931643427667185659746:50001231000000:2800:8E567D3BB822121BAEF36F2EF25D1DFF04A21F3C2537397F35541E3DDA64B7CF.jpg" title="点击放大" width="869.8230590000001"></span></p> <p>以下分别对四种打断场景进行说明：</p> <p><strong>先暂停后恢复场景</strong></p> <p>场景描述：视频正常播放中，当后播应用音频类型为闹钟/电话/铃声时，视频暂停播放，待后播应用音频结束后，视频恢复播放。</p> <ol><li>当后播应用响起时，视频应用会监听到音频打断类型为InterruptForceType.INTERRUPT_FORCE（强制打断），中断提示为InterruptHint.INTERRUPT_HINT_PAUSE（音频暂停）事件，此时系统内部会自动暂停视频播放，但AVPlayer播放器的状态不会自动变为暂停，应用需要主动调用AVPlayer的暂停接口来保证状态一致。</li><li>当后播应用音频结束后，视频应用会监听到打断类型为InterruptForceType.INTERRUPT_SHARE（共享打断），中断提示为InterruptHint.INTERRUPT_HINT_RESUME（音频恢复）事件，此时系统不会自动恢复视频播放，应用需要在相应的事件中主动调用AVPlayer的播放接口完成恢复。</li></ol> <p><strong>降低音量后恢复场景</strong></p> <p>场景描述：视频正常播放中，当后播应用音频类型为导航/TextReader控件朗读语音/语音助手类短语音时，视频会降低音量持续播放，待后播应用音频结束后，视频音量恢复。</p> <ol><li>当后播应用响起时，视频应用会监听到音频打断类型为InterruptForceType.INTERRUPT_FORCE（强制打断），中断提示为InterruptHint.INTERRUPT_HINT_DUCK（降低音量）事件，此时系统会自动降低视频音量并持续播放，应用无需处理，如果应用想实现自己的规则，可在相应的事件类型下进行处理。</li><li>当后播应用音频结束后，视频应用会监听到打断类型为InterruptForceType.INTERRUPT_FORCE（强制打断），中断提示为InterruptHint.INTERRUPT_HINT_UNDUCK（恢复音量）事件。此处系统会自动恢复视频音量，应用无需处理，如果应用想实现自己的规则，也可在相应的事件类型下进行处理。</li></ol> <p><strong>停止后不恢复场景</strong></p> <p>场景描述：视频正常播放中，当后播应用音频类型为音乐/视频/VOIP时，当前视频停止播放，且后播应用音频结束后，视频不会恢复。</p> <p>后播应用响起时，视频应用会监听到音频打断类型为InterruptForceType.INTERRUPT_FORCE（强制打断），中断提示为InterruptHint.INTERRUPT_HINT_STOP（音频结束）事件，此时系统内部会自动停止视频播放，但AVPlayer播放器状态不会自动改变，应用需要根据自身需求做出相应处理，如主动调用AVPlayer的暂停接口保证视频状态。</p> <p><strong>并发混音场景</strong></p> <p>场景描述：视频正常播放中，当后播应用音频类型为游戏/系统音效(锁屏/按键)时，视频会与后播应用并发播放。此场景为系统默认行为，应用无需适配。</p> <p><strong>关键代码：</strong></p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L144-L201" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> setInterruptCallback(): void {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.avPlayer) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.avPlayer.on(<span class="hljs-string">'audioInterrupt'</span>, async (interruptEvent: audio.InterruptEvent) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (interruptEvent.forceType === audio.InterruptForceType.INTERRUPT_FORCE) {</li><li>      <span class="hljs-comment">// INTERRUPT_FORCE: The audio-related processing has been executed by the system, so the application needs to update its status and make corresponding adjustments.</span></li><li>      switch (interruptEvent.hintType) {</li><li>        case audio.InterruptHint.INTERRUPT_HINT_PAUSE:</li><li>          <span class="hljs-comment">// This branch indicates that the system has paused the audio stream (temporarily lost focus). In order to keep the state consistent, the application needs to switch to the audio paused state.</span></li><li>          <span class="hljs-comment">// Temporary loss of focus: after other audio streams release the audio focus, this audio stream will receive the audio interruption event corresponding to resume, and then it can continue playing by itself.</span></li><li>          <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">           * Update play status</span></li><li><span class="hljs-comment">           * <span class="hljs-doctag">@param</span> isPlay is it playing</span></li><li><span class="hljs-comment">           * <span class="hljs-doctag">@returns</span> void</span></li><li><span class="hljs-comment">           */</span></li><li>          <span class="hljs-keyword">this</span>.updateIsPlay(<span class="hljs-literal">false</span>);</li><li>          <span class="hljs-keyword">this</span>.pauseVideo();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        case audio.InterruptHint.INTERRUPT_HINT_STOP:</li><li>          <span class="hljs-comment">// This branch indicates that the system has stopped the audio stream (permanently lost focus). In order to keep the state consistent, the application needs to switch to the audio pause state.</span></li><li>          <span class="hljs-comment">// Permanent loss of focus: no audio interruption events will be received in the future. If you want to resume playing, you need the user to trigger it actively.</span></li><li>          <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">           * Update play status</span></li><li><span class="hljs-comment">           * <span class="hljs-doctag">@param</span> isPlay is it playing</span></li><li><span class="hljs-comment">           * <span class="hljs-doctag">@returns</span> void</span></li><li><span class="hljs-comment">           */</span></li><li>          <span class="hljs-keyword">this</span>.updateIsPlay(<span class="hljs-literal">false</span>);</li><li>          <span class="hljs-keyword">this</span>.pauseVideo();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        case audio.InterruptHint.INTERRUPT_HINT_DUCK:</li><li>          <span class="hljs-comment">// This branch means that the system automatically reduces the volume of your video, and the application does not need to deal with it.</span></li><li>          <span class="hljs-comment">// If the application doesn't accept playing with reduced volume, you can choose other processing methods here, such as active pause.</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        case audio.InterruptHint.INTERRUPT_HINT_UNDUCK:</li><li>          <span class="hljs-comment">// This branch indicates that the system has restored the audio volume to normal, and the application does not need to handle it.</span></li><li>          <span class="hljs-keyword">break</span>;</li><li>        default:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptEvent.forceType === audio.InterruptForceType.INTERRUPT_SHARE) {</li><li>      <span class="hljs-comment">// INTERRUPT_SHARE: the application can choose to perform related operations or ignore audio interruption events.</span></li><li>      <span class="hljs-comment">//</span></li><li>      <span class="hljs-comment">// INTERRUPT_SHARE: the application can choose to perform related operations or ignore audio interruption events.</span></li><li>      switch (interruptEvent.hintType) {</li><li>        case audio.InterruptHint.INTERRUPT_HINT_RESUME:</li><li>          <span class="hljs-comment">// This branch indicates that the audio stream that has been paused after temporarily losing focus can continue to play at this time. It is suggested that the application continue to play and switch to the audio playback state.</span></li><li>          <span class="hljs-comment">// If the application doesn't want to continue playing at this time, it can ignore this audio interruption event and not handle it.</span></li><li>          <span class="hljs-comment">// Continue playing, where start () is actively executed, and the execution result of start () is recorded with the identifier variable started.</span></li><li>          <span class="hljs-keyword">this</span>.playVideo();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        default:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>  })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L144-L201" target="_blank">AvPlayerController.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section9346952155612">播放设备切换<i class="anchor-icon anchor-icon-link" anchorid="section9346952155612" tips="复制节点链接"></i></h3><p>当应用使用的播放设备状态发生改变时，需要根据不同的场景及时做出相应的处理，来保证视频状态与交互体验的一致，如：视频播放状态变化、目标设备切换、视频界面的更新等。</p> <p>实现方式通过对AVPlayer注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiooutputdevicechangewithinfo11" target="_blank">on('audioOutputDeviceChangeWithInfo')</a>监听事件，来感知播放设备的切换，并根据流设备的变更原因，实现对应的切换规则。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>1.如果没有对AVPlayer注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiooutputdevicechangewithinfo11" target="_blank">on('audioOutputDeviceChangeWithInfo')</a>监听，当识别到连接的播放设备时，音频流会自动切换到目标设备上。当播放设备断开时，播放器内部不会自动暂停。</p> <p>2.如果应用想实现自己的设备切换规则，可以注册<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#onaudiooutputdevicechangewithinfo11" target="_blank">on('audioOutputDeviceChangeWithInfo')</a>监听，交由应用自行处理业务逻辑。</p> </div></div></div> </div> <p>播放设备切换场景：</p> <ul><li>新播放设备连接<p>新设备上线时，系统会触发播放设备自动切换，无需应用主动处理。例如当手机使用扬声器播放视频时，连接到耳机后，会自动选择连接的耳机作为播放设备。</p> <p>新设备来连接时，应用通过注册的audioOutputDeviceChangeWithInfo监听事件，获取到播放设备变更的原因为AudioStreamDeviceChangeReason.REASON_NEW_DEVICE_AVAILABLE，同时系统会默认切换到新设备上继续播放。如果应用对改场景有特殊需求，可在回调中自行处理业务逻辑。</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L268-L272" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'audioOutputDeviceChangeWithInfo'</span>, <span class="hljs-function">(<span class="hljs-params">data: audio.AudioStreamDeviceChangeInfo</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (data.<span class="hljs-property">changeReason</span> === audio.<span class="hljs-property">AudioStreamDeviceChangeReason</span>.<span class="hljs-property">REASON_NEW_DEVICE_AVAILABLE</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Device connect: <span class="hljs-subst">${data.changeReason}</span>`</span>);</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L268-L272" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li></ul> <ul><li>旧播放设备断开<p>当正在使用的播放设备断开时，应用可以根据使用场景选择暂停视频播放。例如：当断开连接的耳机时，视频暂停。</p> <p>此时应用通过audioOutputDeviceChangeWithInfo监听事件，获取到设备变更原因为AudioStreamDeviceChangeReason.REASON_OLD_DEVICE_UNAVAILABLE，此处系统不会将播放器自动暂停，应用可以结合业务自行处理需求规则，如暂停视频播放。p</p> <div class="screenLinkPre"><div _ngcontent-vkl-c106="" class="highlight-div"><div _ngcontent-vkl-c106="" class="highlight-div-header"><div _ngcontent-vkl-c106="" class="highlight-div-header-left"><div _ngcontent-vkl-c106="" class="handle-button expand-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vkl-c106="" class="highlight-div-header-right"><div _ngcontent-vkl-c106="" class="handle-button ai-button"></div><div _ngcontent-vkl-c106="" class="handle-button line-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vkl-c106="" class="handle-button theme-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vkl-c106="" class="handle-button copy-button"><div _ngcontent-vkl-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vkl-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L275-L280" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">this</span>.avPlayer.on(<span class="hljs-string">'audioOutputDeviceChangeWithInfo'</span>, (<span class="hljs-keyword">data</span>: audio.AudioStreamDeviceChangeInfo) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.changeReason === audio.AudioStreamDeviceChangeReason.REASON_OLD_DEVICE_UNAVAILABLE) {</li><li>    Logger.info(TAG, `Device connect: ${<span class="hljs-keyword">data</span>.changeReason}`);</li><li>    <span class="hljs-keyword">this</span>.pauseVideo();</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/VideoPlayerSample/MediaService/src/main/ets/controller/AvPlayerController.ets#L275-L280" target="_blank">AvPlayerController.ets</a></div></div></div></div> </li></ul> <ul><li>用户强制选择设备<p>用户从界面选择切换音频流输出设备时，系统会自动选择新的设备播放，audioOutputDeviceChangeWithInfo监听事件获取到的变更原因为AudioStreamDeviceChangeReason.REASON_OVERRODE，应用结合业务自行处理。本篇示例未涉及该场景，只在此处进行说明，详情可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-output-device-change" target="_blank">响应音频流输出设备变更</a>。</p> </li></ul> <div class="tiledSection"><h2 id="section2011582865819">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section2011582865819" tips="复制节点链接"></i></h2></div> <ul><li><a href="https://gitee.com/harmonyos_samples/video-player" target="_blank">视频播放类应用</a></li></ul> </div> <div></div></div>