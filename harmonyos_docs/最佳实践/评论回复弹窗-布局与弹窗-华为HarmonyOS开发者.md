<h1 _ngcontent-nql-c119="" class="doc-title ng-star-inserted" title="评论回复弹窗"> 评论回复弹窗 </h1>

<div _ngcontent-nql-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section5506341244">概述<i class="anchor-icon anchor-icon-link" anchorid="section5506341244" tips="复制节点链接"></i></h2><p>评论回复模块在图文和视频应用中被广泛使用，包含编辑区域、好友列表、常用表情列表和表情面板（见下图），它允许用户进行输入文字、表情、@好友、选择图片等操作。该模块一般以弹窗的形式展现给用户，通常在图文、视频界面中直接弹出，或者在评论列表上层弹出，本文将从评论列表上层弹出这种相对复杂的场景出发，重点对以下几个方面进行介绍，为开发者提供评论回复弹窗模块开发的最佳实践。</p> <ul><li>弹窗组件的选型以及最终方案的实现</li><li>软键盘和表情面板切换的适配</li><li>编辑区域主要细节功能的实现</li></ul> <div class="fignone"><span class="figcap"><b>图1 </b>效果图</span></div> <p><span><img height="339.90504100000004" originheight="2259" originwidth="3504" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162914.76617341545369203093478737587758:50001231000000:2800:256B2033EBB2B356BE0C3CD94DD97734C0DA631983DAAEC9C383E2955FFBDD23.png" title="点击放大" width="524.821591"></span></p> <p>为方便阅读，下面表格对本文常出现的模块名称进行说明：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.7.1.3.1.1" valign="top" width="50%"><p>模块名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.7.1.3.1.2" valign="top" width="50%"><p>对应图1中序号</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>评论列表</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>1</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>好友列表</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>2</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>编辑区域</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>3</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>常用表情列表</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>4</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>软键盘</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>5</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>表情面板</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>6</p> </td> </tr>  </tbody></table></div> </div> <p>参考资料</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#页面显示类型" target="_blank">组件导航（Navigation）</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor" target="_blank">支持图文混排和文本交互式编辑的组件（RichEditor）</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-methods-custom-dialog-box" target="_blank">自定义弹窗（CustomDialog）</a></li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#bindsheet" target="_blank">半模态转场（.bindSheet）</a></li></ul> </div> <div class="tiledSection"><h2 id="section11282194042419">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section11282194042419" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17497161313110" class="firsth2">弹窗组件选型<i class="anchor-icon anchor-icon-link" anchorid="section17497161313110" tips="复制节点链接"></i></h3><p>通过对<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-methods-custom-dialog-box" target="_blank">CustomDialog自定义弹窗</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#bindsheet" target="_blank">bindSheet半模态弹窗</a>、<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#页面显示类型" target="_blank">Navigation Dialog</a>三种弹窗方案进行尝试，发现自定义弹窗和半模态弹窗有一定规格限制，会产生一些无法避免的问题，最终选用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#页面显示类型" target="_blank">Navigation Dialog</a>方案实现评论模块弹窗。以下对三种方案优劣势进行一个详细的说明。</p> <ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-methods-custom-dialog-box" target="_blank">CustomDialog自定义弹窗</a><p>方案优势：</p> <ol><li>现成封装好的组件，无需开发者实现弹窗相关的交互逻辑。</li><li>自定义弹窗默认避让软键盘，评论模块无需计算高度，调用时直接被软键盘抬起即可。</li></ol> <p>方案劣势：</p> <ol><li>由于自定义弹窗完全避让软键盘，且该行为无法配置。在点击表情按钮时，展示表情面板，此过程评论模块高度发生变化，到软键盘完全收起的过程中，表情面板仍然处于软键盘上方，评论模块会被短暂顶起。</li><li>软键盘动画不能自定义配置或获取，无法配合动画能力抵消顶起操作。</li></ol> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-promptaction#opencustomdialog12" target="_blank">PromptAction.openCustomDialog</a>与自定义弹窗呈现效果相同，不再赘述。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.75899399620972733802098984611099:50001231000000:2800:99C95B920E77186AC84837F3E8E7BC85C4404462EF4161C4CED5C0C7445CA1F8.gif" title="点击放大" width="266"></span></p> </li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition#bindsheet" target="_blank">bindSheet半模态弹窗</a><p>方案优势：</p> <ol><li>现成封装好的组件，无需开发者实现弹窗相关的交互逻辑。</li><li>可解决CustomDialog中评论模块被顶起的问题。</li></ol> <p>方案劣势：</p> <ol><li>设置高度自适应后，bindSheet内部的Scroll依然生效，在bindSheet内部可滚动。</li><li>设置dragBar为false时，bindSheet依然可以上下拖动，松手后回到原位，但此过程会暴露软键盘下方的表情面板区域。</li></ol> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.04282198602621944761676826803454:50001231000000:2800:D3E7AF40562BDEEF8834935454BF72FC6FADDA46C45B66FE013CA99F716A2A5E.gif" title="点击放大" width="266"></span></p> </li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-navigation-navigation#页面显示类型" target="_blank">Navigation Dialog</a><p>方案优势：</p> <ol><li>可解决上述两种方案中存在的问题。</li><li>基于Navigation路由形式，以进出路由栈的方式打开或关闭弹窗，可以实现弹窗与UI界面解耦。</li></ol> <p>方案劣势：</p> <ol><li>弹窗遮罩层以及点击遮罩关闭弹窗的逻辑需要手动实现。</li></ol> </li></ul> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>Navigation Dialog在z轴的层级较低，评论模块如果基于该方案实现，那么在其他使用了CustomDialog、bindSheet的弹窗模块（例如评论列表）中调用评论模块，评论模块会在其他弹窗模块下层，所以其他弹窗模块也需要一同改为Navigation Dialog实现，通过路由栈进行弹窗层级的控制。</p> </div></div></div> </div> <div class="tiledSection"><h3 id="section20274131520522">编辑区域组件及方法选型<i class="anchor-icon anchor-icon-link" anchorid="section20274131520522" tips="复制节点链接"></i></h3><p>编辑区域支持输入文字、表情、@好友等内容。目前支持图文混排和文本交互式编辑的组件，<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor" target="_blank">RichEditor</a>是不二的选择。针对添加表情，可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">RichEditorController.addImageSpan</a>方法实现。@好友可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">RichEditorController.addTextSpan</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addbuilderspan11" target="_blank">RichEditorController.addBuilderSpan</a>两种方法实现，通过以下对两种方法的分析对比，最终选择addBuilderSpan实现@好友功能。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>为了方便表述，下文对通过addTextSpan、addImageSpan、addBuilderSpan方法添加到编辑区域的内容分别命名为textSpan、imageSpan、builderSpan。</p> </div></div></div> <ul><li>使用addTextSpan实现@好友<ol><li>在textSpan前后通过软键盘输入的文字会自动与之合并成一个textSpan，而@好友具有特殊样式和逻辑，需要对前后文字进行分割，这些细节需要手动处理。</li><li>@好友作为一个整体，光标不能在中间点击，删除需要整体删除，使用textSpan需要手动处理这些细节。</li><li>获取编辑区域内容时，可以获取到textSpan中的文字（好友昵称），但是如果想获取到该好友的其他信息，仅用好友昵称去关联显然不是一种可靠的方案。</li></ol> </li><li>使用addBuilderSpan实现@好友<ol><li>builderSpan不会和前后文字合并。</li><li>builderSpan默认作为一个整体，对光标点击以及删除逻辑不需要另外处理。</li><li>获取编辑区域内容时，无法获取到builderSpan中的内容，需要手动对添加或删除的builderSpan信息进行维护，自己维护的同时自然也能与好友的其他信息进行关联。</li></ol> </li></ul> </div> <div class="tiledSection"><h2 id="section1896114453243">关键场景实现<i class="anchor-icon anchor-icon-link" anchorid="section1896114453243" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section219998399" class="firsth2">弹窗显示<i class="anchor-icon anchor-icon-link" anchorid="section219998399" tips="复制节点链接"></i></h3><p>在视频页面点击消息按钮，弹出评论列表页面弹窗。在评论列表页点击写评论按钮，弹出评论模块弹窗。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.76187575709535482162208689018544:50001231000000:2800:20930D69A46F740486F4F1FEAF35113FE6E1BBDA0A5D9BD7CD8017F86E51C77D.gif" title="点击放大" width="266"></span></p> <p>基于Navigation的弹窗方案，Navigation的mode属性需要设置为NavigationMode.Stack。弹窗需要全屏显示，Navigation则需要添加在最外层组件上。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/Home.ets#L88-L118" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/Home.ets</span></li><li><span class="hljs-built_in">build</span>() {</li><li>  <span class="hljs-built_in">Navigation</span>(this.navDialogPageInfos) {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-selector-class">.hideTitleBar</span>(true)</li><li>  <span class="hljs-selector-class">.mode</span>(NavigationMode.Stack)</li><li>  <span class="hljs-selector-class">.navDestination</span>(this.NavDialogPageMap)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/Home.ets#L88-L118" target="_blank">Home.ets</a></div></div></div></div> </div> <p>弹窗模块需要用NavDestination包裹，设置NavDestination的mode属性为NavDestinationMode.DIALOG弹窗类型，设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-expand-safe-area#expandsafearea" target="_blank">expandSafeArea</a>属性为[SafeAreaType.KEYBOARD]扩展安全区域，不避让软键盘，以解决<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-methods-custom-dialog-box" target="_blank">CustomDialog自定义弹窗</a>的问题。并在弹窗内容下层通过Stack添加遮罩，点击可关闭弹窗，考虑到多个弹窗模块要进行相同的处理，将弹窗模块封装为组件，评论列表和评论模块调用该组件则无需关注弹窗相关的交互，只需关注弹窗中需要展示的内容即可。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/NavigationDialog.ets#L16-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/NavigationDialog.ets</span></li><li><span class="hljs-variable">@Component</span></li><li>export struct NavigationDialog {</li><li>  <span class="hljs-variable">@Consume</span> <span class="hljs-attribute">navDialogPageInfos</span>: NavPathStack;</li><li>  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">alignContent</span>: Alignment = Alignment.Bottom;</li><li>  <span class="hljs-variable">@Prop</span> <span class="hljs-attribute">maskBackgroundColor</span>: ResourceColor</li><li>
</li><li>  <span class="hljs-variable">@Builder</span></li><li>  <span class="hljs-built_in">DefaultContentBuilder</span>() {}</li><li>
</li><li>  <span class="hljs-variable">@BuilderParam</span></li><li>  <span class="hljs-attribute">contentBuilderParam</span>: () =&gt; void = this.DefaultContentBuilder</li><li>
</li><li>  onClose = () =&gt; {</li><li>    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.navDialogPageInfos</span><span class="hljs-selector-class">.pop</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-selector-tag">build</span>() {</li><li>    <span class="hljs-selector-tag">NavDestination</span>() {</li><li>      <span class="hljs-selector-tag">Stack</span>() {</li><li>        <span class="hljs-selector-tag">Column</span>()</li><li>          <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'100%'</span>)</li><li>          <span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)</li><li>          <span class="hljs-selector-class">.backgroundColor</span>(this.maskBackgroundColor)</li><li>          <span class="hljs-selector-class">.onClick</span>(this.onClose)</li><li>        <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.contentBuilderParam</span>()</li><li>      }</li><li>      <span class="hljs-selector-class">.height</span>(<span class="hljs-string">'100%'</span>)</li><li>      <span class="hljs-selector-class">.alignContent</span>(this.alignContent)</li><li>    }</li><li>    <span class="hljs-selector-class">.mode</span>(NavDestinationMode.DIALOG)</li><li>    <span class="hljs-selector-class">.hideTitleBar</span>(true)</li><li>    <span class="hljs-selector-class">.expandSafeArea</span>([SafeAreaType.KEYBOARD])</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/NavigationDialog.ets#L16-L50" target="_blank">NavigationDialog.ets</a></div></div></div></div> <p>各个弹窗模块的弹出和关闭通过路由的进栈出栈控制，弹窗的层级关系通过路由进栈的顺序来控制。</p> <div class="tiledSection"><h3 id="section1591923118391">软键盘和表情面板切换适配<i class="anchor-icon anchor-icon-link" anchorid="section1591923118391" tips="复制节点链接"></i></h3><p>点击编辑区域表情按钮，软键盘切换为表情面板，表情按钮图标变成键盘图标。再次点击，表情面板切换回软键盘，按钮图标由键盘变回表情。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.94886052478473116176734200669279:50001231000000:2800:ED047CDC0B19F07893BDCD2EDF32463E8C3268B493B3FF8290CCA860D116C0F4.gif" title="点击放大" width="266"></span></p> <p>本文选择自定义键盘来控制软键盘和表情面板的切换。通过设置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#customkeyboard" target="_blank">RichEditor.customKeyboard</a>为表情面板组件的构建函数EmojiKeyboard，来展示表情面板，设置该属性为undefined，则展示默认软键盘。通过这种方式在软键盘与表情面板切换时也无需手动进行richEditor焦点的处理。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L299-L311" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li>RichEditor({ controller: <span class="hljs-keyword">this</span>.richEditorController })</li><li>  .customKeyboard(<span class="hljs-keyword">this</span>.isEmojiKeyboardVisible ? <span class="hljs-keyword">this</span>.EmojiKeyboard() : undefined)</li><li>  <span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L299-L311" target="_blank">CommentKeyboard.ets</a></div></div></div></div> </div> <p>为保证切换软键盘和表情面板时，评论模块整体高度不发生改变，则需要获取软键盘高度对表情面板高度进行计算和手动设置。有可能软键盘高度被手动更改，所以需要通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-window-window#onkeyboardheightchange7" target="_blank">keyboardHeightChange</a>事件对软键盘高度进行监听，当高度大于0时，更新记录软键盘高度的状态变量。注意在组件销毁前取消对应的监听事件。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L64-L100" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">win</span> =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">addKeyboardHeightListener</span>(win);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getLastWindow</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">win</span> =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">removeKeyboardHeightListener</span>(win);</li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">getResourceString</span>(<span class="hljs-attr">resource</span>: <span class="hljs-title class_">Resource</span>): <span class="hljs-built_in">string</span> {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getStringSync</span>(resource.<span class="hljs-property">id</span>);</li><li>}</li><li>
</li><li><span class="hljs-title function_">addKeyboardHeightListener</span>(<span class="hljs-params">win: <span class="hljs-variable language_">window</span>.Window</span>) {</li><li>  win.<span class="hljs-title function_">on</span>(<span class="hljs-string">'keyboardHeightChange'</span>, <span class="hljs-function"><span class="hljs-params">height</span> =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'keyboard height has changed'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(height));</li><li>    <span class="hljs-keyword">if</span> (height !== <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">keyboardHeight</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">px2vp</span>(height);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  });</li><li>}</li><li>
</li><li><span class="hljs-title function_">removeKeyboardHeightListener</span>(<span class="hljs-params">win: <span class="hljs-variable language_">window</span>.Window</span>) {</li><li>  win.<span class="hljs-title function_">off</span>(<span class="hljs-string">'keyboardHeightChange'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L64-L100" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>如图1效果图所示，对比软键盘显示界面和表情面板显示界面可知，表情面板的高度 = 常用表情列表的高度 + 软键盘的高度。由于弹窗不避让软键盘和自定义键盘，在切换到软键盘时，需要一个占位元素来将软键盘上方区域顶起，且高度为软键盘的高度。同理，切换到表情面板时，需要将占位元素的高度设置为表情面板的高度（即常用表情列表的高度 + 软键盘的高度）。</p> <p>评论弹窗模块高度适配代码：</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L401-L420" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li>build() {</li><li>  NavigationDialog({ maskBackgroundColor: <span class="hljs-string">'rgba(0, 0, 0, 0.1)'</span> }) {</li><li>    Column() {</li><li>      <span class="hljs-keyword">this</span>.AtFriendList()</li><li>      <span class="hljs-keyword">this</span>.ToolBar()</li><li>      Divider()</li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isEmojiKeyboardVisible) {</li><li>        <span class="hljs-keyword">this</span>.FrequentEmojiList()</li><li>      }</li><li>      Column()</li><li>        .height(</li><li>          <span class="hljs-keyword">this</span>.isEmojiKeyboardVisible ?</li><li>            <span class="hljs-keyword">this</span>.keyboardHeight + <span class="hljs-keyword">this</span>.frequentEmojiListHeight :</li><li>            <span class="hljs-keyword">this</span>.keyboardHeight</li><li>        )</li><li>    }</li><li>    .backgroundColor(Color.White)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L401-L420" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>表情面板高度适配代码：</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L330-L350" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-meta">@Builder</span></li><li>EmojiKeyboard() {</li><li>  Grid() {</li><li>    ForEach(<span class="hljs-keyword">this</span>.getEmojiIcons(), (icon: Resource) =&gt; {</li><li>      GridItem() {</li><li>        Image(icon)</li><li>          .width(<span class="hljs-number">45</span>)</li><li>          .onClick(() =&gt; { <span class="hljs-keyword">this</span>.onEmojiClick(icon) })</li><li>      }</li><li>    })</li><li>  }</li><li>  .width(<span class="hljs-string">'100%'</span>)</li><li>  .height(<span class="hljs-keyword">this</span>.keyboardHeight + <span class="hljs-keyword">this</span>.frequentEmojiListHeight)</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L330-L350" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section1318482323916">编辑区功能<i class="anchor-icon anchor-icon-link" anchorid="section1318482323916" tips="复制节点链接"></i></h3><p>编辑区通常包括输入文字、表情、@好友、选择图片功能，本节通过效果图展示结合代码讲解的方式对上述功能开发做相应介绍。</p> <ul><li>添加表情<p>在软键盘上方常用表情列表点击表情图片，或者切换到表情面板点击表情图片，会在编辑区域光标后方添加对应的表情内容。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.51908593093021238826816072139000:50001231000000:2800:9C7C6972DF8CBE4868E4FD6C8F6E4C4D331E6C4C3E8888FCFCB4B55D16251F78.gif" title="点击放大" width="266"></span></p> <p>在表情面板或常用表情列表中点击表情时可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">RichEditorController.addImageSpan</a>在编辑区域进行添加图片表情，注意需要设置offset属性为当前光标位置，当前光标的位置可通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getcaretoffset10" target="_blank">RichEditorController.getCaretOffset</a>获取。这样使得表情在当前光标后添加，否则默认在内容的最后方添加，后文类似的添加操作都遵循此规则。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L133-L142" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-variable">onEmojiClick</span>: (<span class="hljs-variable">icon</span>: <span class="hljs-title class_">Resource</span>) =&gt; <span class="hljs-variable">void</span> = <span class="hljs-variable">icon</span> =&gt; {</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>.<span class="hljs-title function_">addImageSpan</span>(<span class="hljs-variable">icon</span>, {</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">richEditorController</span>.<span class="hljs-title class_">getCaretOffset</span>(),</li><li>    <span class="hljs-variable">imageStyle</span>: { <span class="hljs-variable">size</span>: [<span class="hljs-number">20</span>, <span class="hljs-number">20</span>] }</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L133-L142" target="_blank">CommentKeyboard.ets</a></div></div></div></div> </li></ul> </div> <ul><li>@好友<p>点击编辑区域@按钮，或在软键盘输入@符号，会展示好友列表。点击好友列表中好友头像，会在编辑区域添加@好友内容。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.46428699430765993089349878136954:50001231000000:2800:5FA177EF6DD8B7B518DD828538C8A11CB7118ABF6589A3FC8FD06B284CC09FB1.gif" title="点击放大" width="266"></span></p> <p>点击@按钮时，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">RichEditorController.addTextSpan</a>添加@符号，并显示好友列表。同时需要监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#abouttoimeinput" target="_blank">RichEditor.aboutToIMEInput</a>事件 ，该事件在输入内容前触发回调，在回调中获取要输入的内容，如果输入的内容为@，则相当于点击了@按钮的效果，这样统一了点击@按钮和键盘输入@的逻辑，方便后续一些细节的处理。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L116-L121" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-attr">onAtButtonClick</span>: <span class="hljs-function">(<span class="hljs-params">event?: ClickEvent</span>) =&gt;</span> <span class="hljs-keyword">void</span> = <span class="hljs-function"><span class="hljs-params">event</span> =&gt;</span> {</li><li>  <span class="hljs-keyword">const</span> controller = <span class="hljs-variable language_">this</span>.<span class="hljs-property">richEditorController</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">isAtFriendListVisible</span> = <span class="hljs-literal">true</span>;</li><li>  controller.<span class="hljs-title function_">addTextSpan</span>(<span class="hljs-string">'@'</span>, { <span class="hljs-attr">offset</span>: controller.<span class="hljs-title function_">getCaretOffset</span>() });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L116-L121" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>在好友列表中点击好友头像时，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getspans" target="_blank">RichEditorController.getSpans</a>可以获取光标前一个span的内容，若光标前一个span是内容为@的textSpan，则先删除，然后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addbuilderspan11" target="_blank">RichEditorController.addBuilderSpan</a>将“@[好友昵称]”以指定的样式作为一个整体添加到编辑区域中。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L175-L200" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-variable">onAtFriendClick</span>: (<span class="hljs-variable">friend</span>: <span class="hljs-title class_">User</span>) =&gt; <span class="hljs-variable">void</span> = <span class="hljs-variable">friend</span> =&gt; {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">controller</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">offset</span> = <span class="hljs-variable">controller</span>.<span class="hljs-title function_">getCaretOffset</span>();</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">range</span>: <span class="hljs-title class_">RichEditorRange</span> = { <span class="hljs-variable">start</span>: <span class="hljs-title class_">offset</span> - <span class="hljs-number">1</span>, <span class="hljs-variable">end</span>: <span class="hljs-title class_">offset</span> };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">span</span> = <span class="hljs-variable">controller</span>.<span class="hljs-title function_">getSpans</span>(<span class="hljs-variable">range</span>);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">offset</span> !== <span class="hljs-number">0</span> &amp;&amp; (<span class="hljs-variable">span</span>[<span class="hljs-number">0</span>] <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorTextSpanResult</span>).<span class="hljs-variable">value</span> === <span class="hljs-string">'@'</span>) {</li><li>    <span class="hljs-variable">controller</span>.<span class="hljs-title function_">deleteSpans</span>(<span class="hljs-variable">range</span>);</li><li>  }</li><li>  <span class="hljs-variable">controller</span>.<span class="hljs-title function_">addBuilderSpan</span>(() =&gt; <span class="hljs-keyword">this</span>.<span class="hljs-title function_">AtSpan</span>(<span class="hljs-variable">friend</span>.<span class="hljs-variable">nickname</span>), {</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-title class_">controller</span>.<span class="hljs-title class_">getCaretOffset</span>()</li><li>  });</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-title function_">setBuilderSpans</span>(<span class="hljs-variable">controller</span>, <span class="hljs-variable">friend</span>);</li><li>}</li><li>
</li><li>@<span class="hljs-title function_">Builder</span></li><li><span class="hljs-title function_">AtSpan</span>(<span class="hljs-variable">nickname</span>: <span class="hljs-title class_">string</span>) {</li><li>  <span class="hljs-title function_">Text</span>(`@${<span class="hljs-variable">nickname</span>}`)</li><li>    .<span class="hljs-title function_">fontColor</span>(<span class="hljs-number">0xFF133667</span>)</li><li>    .<span class="hljs-title function_">maxLines</span>(<span class="hljs-number">1</span>)</li><li>    .<span class="hljs-title function_">textOverflow</span>({ <span class="hljs-variable">overflow</span>: <span class="hljs-title class_">TextOverflow</span>.<span class="hljs-title class_">Ellipsis</span> })</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L175-L200" target="_blank">CommentKeyboard.ets</a></div></div></div></div> </li></ul> <ul><li>删除内容<p>点击软键盘删除按钮，如果要编辑区域光标前删除的内容是builderSpan（@好友）且没有被选中，则进行选中，否则直接删除光标前的内容。选中内容会作为整体删除。</p> <p><span><img height="546.7763" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.11674733397200405956980379778367:50001231000000:2800:FA9633BE85240E4D185B71A0E6ECED7A1E10D7AA114293B3B6D3B8D31F5B4CAF.gif" title="点击放大" width="266"></span></p> <p>监听<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#abouttodelete" target="_blank">RichEditor.aboutToDelete</a>事件，可通过回调中返回false阻止编辑区域默认的删除行为。在第一次删除builderSpan（@好友）的时候，先使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#setselection11" target="_blank">RichEditorController.setSelection</a>对整体进行选中，再次点击删除键时选中内容在RichEditor中会默认被整体删除。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L227-L240" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li>aboutToDelete: (value: RichEditorDeleteValue) =&gt; boolean = value =&gt; {</li><li>  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">this</span>.richEditorController;</li><li>  <span class="hljs-keyword">const</span> span = value.richEditorDeleteSpans[<span class="hljs-number">0</span>];</li><li>  <span class="hljs-keyword">if</span> (span &amp;&amp; <span class="hljs-keyword">this</span>.isBuilderSpan(span)) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasSelection(controller)) {</li><li>      <span class="hljs-keyword">this</span>.deleteBuilderSpan();</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>    controller.setSelection(value.offset, value.offset + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L227-L240" target="_blank">CommentKeyboard.ets</a></div></div></div></div> </li></ul> <ul><li>内容获取与展示<p>在编辑区域输入文字、表情、@好友内容，点击发送按钮，获取编辑区域内容，并弹窗展示内容以及@好友中好友的相关信息。</p> <p><span><img height="460.23320000000007" originheight="2259" originwidth="2285" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162915.40689215282339330087038536192206:50001231000000:2800:8DAA53A7C8E438E699AE3F9C7F64C946237A52F82449BF2309557CB170285B4D.png" title="点击放大" width="465.5"></span></p> <p>可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#getspans" target="_blank">RichEditorController.getSpans</a>来获取编辑区域所有的内容，获取到的内容在getSpans方法的返回值中表现为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditortextspanresult" target="_blank">RichEditorTextSpanResult</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditorimagespanresult" target="_blank">RichEditorImageSpanResult</a>两种类型。上文中提到过文字、图片表情、@好友三种内容与这两种类型的对应关系如下表：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.5.1.1" valign="top" width="15.479999999999999%"><p>本文中的定义</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.5.1.2" valign="top" width="18.21%"><p>对应编辑区域内容</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.5.1.3" valign="top" width="36.059999999999995%"><p>添加方式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.5.1.4" valign="top" width="30.25%"><p>getSpans方法返回值中对应的类型</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="15.479999999999999%"><p>textSpan</p> </td> <td class="cellrowborder" valign="top" width="18.21%"><p>连续的文字</p> </td> <td class="cellrowborder" valign="top" width="36.059999999999995%"><p>键盘输入或<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addtextspan" target="_blank">RichEditorController.addTextSpan</a></p> </td> <td class="cellrowborder" valign="top" width="30.25%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditortextspanresult" target="_blank">RichEditorTextSpanResult</a></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.479999999999999%"><p>imageSpan</p> </td> <td class="cellrowborder" valign="top" width="18.21%"><p>图片表情</p> </td> <td class="cellrowborder" valign="top" width="36.059999999999995%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addimagespan" target="_blank">RichEditorController.addImageSpan</a></p> </td> <td class="cellrowborder" valign="top" width="30.25%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditorimagespanresult" target="_blank">RichEditorImageSpanResult</a></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="15.479999999999999%"><p>builderSpan</p> </td> <td class="cellrowborder" valign="top" width="18.21%"><p>@[好友昵称]</p> </td> <td class="cellrowborder" valign="top" width="36.059999999999995%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#addbuilderspan11" target="_blank">RichEditorController.addBuilderSpan</a></p> </td> <td class="cellrowborder" valign="top" width="30.25%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-richeditor#richeditorimagespanresult" target="_blank">RichEditorImageSpanResult</a></p> </td> </tr>  </tbody></table></div> </div> <p>textSpan可通过RichEditorTextSpanResult.value获取文字内容。imageSpan可通过RichEditorImageSpanResult.valueResourceStr获取图片资源。但是builderSpan在RichEditorImageSpanResult中获取不到任何相关的内容信息，所以在点击好友头像添加@好友内容时需要手动将这些builderSpan进行维护。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L176-L191" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li>onAtFriendClick: (<span class="hljs-keyword">friend</span>: User) =&gt; <span class="hljs-type">void</span> = <span class="hljs-keyword">friend</span> =&gt; {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-built_in">setBuilderSpans</span>(controller, <span class="hljs-keyword">friend</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L176-L191" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>实际开发中编辑区域不同类型的内容往往需要一种统一的数据结构来表达，方便传输和存储。该数据结构需要不仅能对编辑区域内容进行记录，也需要有携带一些额外信息的能力，比如携带@好友相关的用户信息。本文定义为RichEditorSpan。（实际开发中需要的属性字段根据需求灵活调整）。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L37-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RichEditorSpan</span> {</li><li>  <span class="hljs-variable">value</span>?: <span class="hljs-title class_">string</span></li><li>  <span class="hljs-variable">resourceValue</span>?: <span class="hljs-title class_">ResourceStr</span></li><li>  <span class="hljs-keyword">type</span>: <span class="hljs-string">'text'</span> | <span class="hljs-string">'image'</span> | <span class="hljs-string">'builder'</span></li><li>  <span class="hljs-variable">data</span>?: <span class="hljs-title class_">User</span> | <span class="hljs-title class_">ImageInfo</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L37-L43" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>使用RichEditorSpan[]类型的数组builderSpans来维护@好友时的builderSpan，需要注意的是要保证每个builderSpan在数组中的顺序要与实际内容中出现的顺序一致。在添加builderSpan时，通过计算当前光标位置前面builderSpan的个数，来确定添加到builderSpans数组中的位置，并把需要携带的好友信息放入data属性中。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L207-L223" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">setBuilderSpans</span>(<span class="hljs-variable">controller</span>: <span class="hljs-title class_">RichEditorController</span>, <span class="hljs-variable">friend</span>: <span class="hljs-title class_">User</span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">builderSpan</span>: <span class="hljs-title class_">RichEditorSpan</span> = {</li><li>    <span class="hljs-variable">value</span>: `@${<span class="hljs-variable">friend</span>.<span class="hljs-variable">nickname</span>}`,</li><li>    <span class="hljs-variable">data</span>: <span class="hljs-title class_">friend</span>,</li><li>    <span class="hljs-keyword">type</span>: <span class="hljs-string">'builder'</span></li><li>  };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">range</span>: <span class="hljs-title class_">RichEditorRange</span> = { <span class="hljs-variable">end</span>: <span class="hljs-title class_">controller</span>.<span class="hljs-title class_">getCaretOffset</span>() };</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">index</span> = <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getBuilderSpanCount</span>(<span class="hljs-variable">controller</span>, <span class="hljs-variable">range</span>) - <span class="hljs-number">1</span>;</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">builderSpans</span>.<span class="hljs-title function_">splice</span>(<span class="hljs-variable">index</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">builderSpan</span>);</li><li>}</li><li>
</li><li><span class="hljs-title function_">getBuilderSpanCount</span>(<span class="hljs-variable">controller</span>: <span class="hljs-title class_">RichEditorController</span>, <span class="hljs-variable">range</span>: <span class="hljs-title class_">RichEditorRange</span>) {</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">controller</span>.<span class="hljs-title function_">getSpans</span>(<span class="hljs-variable">range</span>).<span class="hljs-title function_">reduce</span>((<span class="hljs-variable">count</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">span</span>) =&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-title function_">isBuilderSpan</span>(<span class="hljs-variable">span</span>) ? <span class="hljs-variable">count</span> + <span class="hljs-number">1</span> : <span class="hljs-title class_">count</span>;</li><li>  }, <span class="hljs-number">0</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L207-L223" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>发送评论时，将获取到的内容用RichEditorSpan[]类型的数组richEditorSpans进行统一地表达。通过getSpans获取所有内容，如果是textSpan，通过value属性取出文字内容，设置RichEditorSpan.type为text，如果是imageSpan，通过valueResourceStr属性获取图片资源，设置RichEditorSpan.type为image。如果是builderSpan，按顺序从数组builderSpans中获取，并将他们按顺序添加到richEditorSpans中。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L146-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentKeyboard.ets</span></li><li><span class="hljs-variable">onSendComment</span>: () =&gt; <span class="hljs-variable">void</span> = () =&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">builderSpanIndex</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">richEditorSpan</span>: <span class="hljs-title class_">RichEditorSpan</span>;</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable">richEditorSpans</span>: <span class="hljs-title class_">RichEditorSpan</span>[] = [];</li><li>  <span class="hljs-keyword">this</span>.<span class="hljs-variable">richEditorController</span>.<span class="hljs-title function_">getSpans</span>().<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">span</span>, <span class="hljs-variable">index</span>) =&gt; {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">textSpan</span> = <span class="hljs-variable">span</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorTextSpanResult</span>;</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">imageSpan</span> = <span class="hljs-variable">span</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">RichEditorImageSpanResult</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">textSpan</span>.<span class="hljs-variable">value</span>) {</li><li>      <span class="hljs-variable">richEditorSpan</span> = { <span class="hljs-variable">value</span>: <span class="hljs-title class_">textSpan</span>.<span class="hljs-title class_">value</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">'text'</span> };</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-title function_">isBuilderSpan</span>(<span class="hljs-variable">span</span>)) {</li><li>      <span class="hljs-variable">richEditorSpan</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">builderSpans</span>[<span class="hljs-variable">builderSpanIndex</span>];</li><li>      <span class="hljs-variable">builderSpanIndex</span> += <span class="hljs-number">1</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">richEditorSpan</span> = { <span class="hljs-variable">resourceValue</span>: <span class="hljs-title class_">imageSpan</span>.<span class="hljs-title class_">valueResourceStr</span>, <span class="hljs-keyword">type</span>: <span class="hljs-string">'image'</span> };</li><li>    }</li><li>    <span class="hljs-variable">richEditorSpans</span>.<span class="hljs-title function_">push</span>(<span class="hljs-variable">richEditorSpan</span>);</li><li>  });</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentKeyboard.ets#L146-L169" target="_blank">CommentKeyboard.ets</a></div></div></div></div> <p>最终生成的richEditorSpans数据格式如下：</p> <div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>[</li><li>  {</li><li>    <span class="hljs-string">"value"</span>: <span class="hljs-string">"@朋友1"</span>,</li><li>    <span class="hljs-string">"data"</span>: {</li><li>      <span class="hljs-string">"id"</span>: <span class="hljs-string">"0"</span>,</li><li>      <span class="hljs-string">"avatar"</span>: {</li><li>        <span class="hljs-string">"id"</span>: <span class="hljs-number">16777268</span>,</li><li>        <span class="hljs-string">"type"</span>: <span class="hljs-number">20000</span>,</li><li>        <span class="hljs-string">"params"</span>: [],</li><li>        <span class="hljs-string">"bundleName"</span>: <span class="hljs-string">"com.example.commentreply"</span>,</li><li>        <span class="hljs-string">"moduleName"</span>: <span class="hljs-string">"default"</span></li><li>      },</li><li>      <span class="hljs-string">"nickname"</span>: <span class="hljs-string">"朋友1"</span></li><li>    },</li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"builder"</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-string">"value"</span>: <span class="hljs-string">"Hello"</span>,</li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"text"</span></li><li>  },</li><li>  {</li><li>    <span class="hljs-string">"resourceValue"</span>: <span class="hljs-string">"resource:///emoji_3.png"</span>,</li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"image"</span></li><li>  }</li><li>]</li></ol></pre></div></div> <p>当需要展示评论内容时，只需要对richEditorSpans进行遍历，根据type属性，分别对文字、表情、@好友进行展示逻辑的处理。具体展示形式开发者根据实际需求确定。</p> <div class="screenLinkPre"><div _ngcontent-nql-c106="" class="highlight-div"><div _ngcontent-nql-c106="" class="highlight-div-header"><div _ngcontent-nql-c106="" class="highlight-div-header-left"><div _ngcontent-nql-c106="" class="handle-button expand-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nql-c106="" class="highlight-div-header-right"><div _ngcontent-nql-c106="" class="handle-button ai-button"></div><div _ngcontent-nql-c106="" class="handle-button line-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nql-c106="" class="handle-button theme-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nql-c106="" class="handle-button copy-button"><div _ngcontent-nql-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nql-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentSendDialog.ets#L33-L54" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// features/home/src/main/ets/view/CommentSendDialog.ets</span></li><li><span class="hljs-title class_">Column</span>() {</li><li>  <span class="hljs-title class_">Text</span>($r(<span class="hljs-string">'app.string.send_title'</span>))</li><li>    .<span class="hljs-title function_">margin</span>({ <span class="hljs-attr">bottom</span>: <span class="hljs-number">20</span> })</li><li>  <span class="hljs-title class_">Flex</span>({ <span class="hljs-attr">wrap</span>: <span class="hljs-title class_">FlexWrap</span>.<span class="hljs-property">Wrap</span> }) {</li><li>    <span class="hljs-title class_">ForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getComment</span>(), <span class="hljs-function">(<span class="hljs-params">richEditorSpan: RichEditorSpan</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (richEditorSpan.<span class="hljs-property">type</span> === <span class="hljs-string">'text'</span>) {</li><li>        <span class="hljs-title class_">Text</span>(richEditorSpan.<span class="hljs-property">value</span>)</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (richEditorSpan.<span class="hljs-property">type</span> === <span class="hljs-string">'image'</span>) {</li><li>        <span class="hljs-title class_">Image</span>(richEditorSpan.<span class="hljs-property">resourceValue</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">20</span>)</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`<span class="hljs-subst">${richEditorSpan.value}</span>(`</span>)</li><li>          .<span class="hljs-title function_">fontColor</span>(<span class="hljs-number">0xFF133667</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">`id：<span class="hljs-subst">${(richEditorSpan.data <span class="hljs-keyword">as</span> User).id}</span>; avatar：`</span>)</li><li>        <span class="hljs-title class_">Image</span>((richEditorSpan.<span class="hljs-property">data</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">User</span>).<span class="hljs-property">avatar</span>)</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-number">20</span>)</li><li>        <span class="hljs-title class_">Text</span>(<span class="hljs-string">')'</span>)</li><li>      }</li><li>    }, <span class="hljs-function">(<span class="hljs-params">richEditorSpan: RichEditorSpan</span>) =&gt;</span> <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(richEditorSpan))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/CommentReply/blob/master/features/home/src/main/ets/view/CommentSendDialog.ets#L33-L54" target="_blank">CommentSendDialog.ets</a></div></div></div></div> </li><li>选择图片<p>点击图片按钮拉起系统相册，选择本地图片进行上传。该功能使用场景相对独立，本文不详细介绍。开发者需要进一步了解详情，可参考以下sample。</p> <ul><li><a href="https://gitee.com/harmonyos_samples/picker" target="_blank">选择并查看文档和媒体文件</a></li><li><a href="https://developer.huawei.com/consumer/cn/codelabsPortal/carddetails/tutorials_NEXT-FilesManger" target="_blank">文件管理</a></li><li><a href="https://gitee.com/harmonyos_samples/image-comment" target="_blank">发布图片评论</a></li></ul> </li></ul> <div class="tiledSection"><h2 id="section132141950152418">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section132141950152418" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/CommentReply" target="_blank">评论回复弹窗开发</a></li></ul> </div> </div> <div></div></div>