<h1 _ngcontent-pux-c119="" class="doc-title ng-star-inserted" title="资源泄漏类问题优化建议"> 资源泄漏类问题优化建议 </h1>

<div _ngcontent-pux-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section873193091314">内存泄漏问题优化建议<i class="anchor-icon anchor-icon-link" anchorid="section873193091314" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1133213292332" class="firsth2">优化建议1：使用定时器组件销毁时一定要调用clearTimeout和clearInterval，否则对象无法析构<i class="anchor-icon anchor-icon-link" anchorid="section1133213292332" tips="复制节点链接"></i></h3><p>定时器未清理导致组件一直没有析构。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/ets/pages/MemoryLeakDetection.ets#L43-L55" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">timer</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 正确声明类属性</span></li><li>
</li><li>  <span class="hljs-title function_">onInit</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateData</span>(); <span class="hljs-comment">// 通过this调用类方法</span></li><li>    }, <span class="hljs-number">1000</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 定时任务具体逻辑</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/ets/pages/MemoryLeakDetection.ets#L43-L55" target="_blank">MemoryLeakDetection.ets</a></div></div></div></div> <p><strong>优化建议：</strong></p> <p>使用定时器组件销毁时一定要调用clearTimeout和clearInterval，否则对象无法析构。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/ets/pages/MemoryLeakDetection2.ets#L16-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">test</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">timer</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 正确声明类属性</span></li><li>
</li><li>  <span class="hljs-title function_">onInit</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateData</span>(); <span class="hljs-comment">// 通过this调用类方法</span></li><li>    }, <span class="hljs-number">1000</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateData</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// 定时任务具体逻辑</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> !== <span class="hljs-literal">null</span>) {</li><li>      <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span>); <span class="hljs-comment">// 清理定时器</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">timer</span> = <span class="hljs-literal">null</span>;</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/ets/pages/MemoryLeakDetection2.ets#L16-L35" target="_blank">MemoryLeakDetection2.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section259075323419">优化建议2：异常分支需要关注释放申请的内存<i class="anchor-icon anchor-icon-link" anchorid="section259075323419" tips="复制节点链接"></i></h3></div> <p>申请堆内存但是没有在异常分支进行释放。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L35-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">InjectNativeLeak1</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* p = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(g_cmdLen + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">if</span> (!p) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> err = <span class="hljs-built_in">memset</span>(p, <span class="hljs-string">'a'</span>, g_cmdLen);</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-comment">// 异常分支退出未释放</span></li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(p);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L35-L48" target="_blank">resource_leak.cpp</a></div></div></div></div> <p><strong>优化建议：</strong></p> <p>在代码开发中需要特别注意以下场景：</p> <ol><li>同一函数内，异常分支未释放资源。</li><li>构造函数中申请资源，析构函数未释放资源。</li><li>资源申请释放有配对，但配对函数或变量不匹配。</li><li>指针地址偏移等原因导致申请的内存地址丢失。</li></ol> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L52-L65" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">InjectNativeLeak2</span><span class="hljs-params">()</span></span></li><li><span class="hljs-function"></span>{</li><li>    <span class="hljs-type">char</span>* p = (<span class="hljs-type">char</span>*)<span class="hljs-built_in">malloc</span>(g_cmdLen + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-keyword">if</span> (!p) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> err = <span class="hljs-built_in">memset</span>(p, <span class="hljs-string">'a'</span>, g_cmdLen);</li><li>    <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-built_in">free</span>(p);</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;</li><li>    }</li><li>    <span class="hljs-built_in">free</span>(p);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L52-L65" target="_blank">resource_leak.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section12687113513352">ashmem/ION泄漏问题优化建议<i class="anchor-icon anchor-icon-link" anchorid="section12687113513352" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section10221342366" class="firsth2">优化建议1：调用命名API接口，设定ashmem和ION的名字，与pixmap绑定，来提高这类内存泄漏的定位效率<i class="anchor-icon anchor-icon-link" anchorid="section10221342366" tips="复制节点链接"></i></h3></div> <p>未释放的共享内存映射。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L78-L87" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processWithLeak1</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> size)</span> </span>{</li><li>    <span class="hljs-type">void</span>* ptr = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">nullptr</span>, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">if</span> (ptr == MAP_FAILED) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 使用共享内存</span></li><li>    <span class="hljs-built_in">processData</span>(ptr);</li><li>    <span class="hljs-comment">// 忘记调用munmap(ptr, size);</span></li><li>    <span class="hljs-comment">// 每一次调用都会泄漏一块映射内存</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L78-L87" target="_blank">resource_leak.cpp</a></div></div></div></div> <p><strong>优化建议：</strong></p> <p>及时释放内存映射。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L91-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processWithLeak2</span><span class="hljs-params">(<span class="hljs-type">int</span> fd, <span class="hljs-type">size_t</span> size)</span> </span>{</li><li>    <span class="hljs-type">void</span>* ptr = <span class="hljs-built_in">mmap</span>(<span class="hljs-literal">nullptr</span>, size, PROT_READ | PROT_WRITE, MAP_SHARED, fd, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">if</span> (ptr == MAP_FAILED) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// 使用共享内存</span></li><li>    <span class="hljs-built_in">processData</span>(ptr);</li><li>    <span class="hljs-built_in">munmap</span>(ptr, size);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L91-L99" target="_blank">resource_leak.cpp</a></div></div></div></div> <p>针对ION和ashmem内存泄漏，开发者可以调用命名API接口，设定ashmem和ION的名字，与pixmap绑定，来提高这类内存泄漏的定位效率。</p> <p>提供的API接口使用方法可参考：</p> <p><span style="color: rgb(0,38,84);">JS层API：</span><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#setmemorynamesync13" target="_blank">setMemoryNameSync()</a></strong></p> <p>NATIVE层API：<strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_setmemoryname" target="_blank">OH_PixelmapNative_SetMemoryName()</a></strong></p> <p>建议Name按照窗口+组件+图片序号自定义，如果出现批量组件图片内存未释放，可快速定位。</p> <p><span style="color: rgb(0,38,84);">修改方法示例</span><strong><span style="color: rgb(0,38,84);">：</span></strong></p> <p><span><img height="204.4875" originheight="391" originwidth="999" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163452.58263948643357467104756345645557:50001231000000:2800:DF9C6E57C9D68CA19B3F2A4793C1D07AF2617CA14F72069080BF6826A1DA4657.png" title="点击放大" width="523.6875"></span></p> <p>ashmem日志结果示例展示：</p> <p><span><img height="195.51000000000002" originheight="370" originwidth="991" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163452.07923012357815425207071543049852:50001231000000:2800:07EBF0E4D61CC8DA96F6DECAFADC35A9DF37C475FD7E2544D3F0598CBD721EF2.png" title="点击放大" width="523.6875"></span></p> <p>ION日志结果示例展示：</p> <p><span><img height="146.63250000000002" originheight="278" originwidth="991" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163452.30213474201821660355100436474620:50001231000000:2800:1A33AD768B6073E5E2ED254B69CE983D006F6229930212BB0A3FFF973FC4A845.png" title="点击放大" width="523.6875"></span></p> <div class="tiledSection"><h2 id="section7375193133214">句柄泄漏问题优化建议<i class="anchor-icon anchor-icon-link" anchorid="section7375193133214" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section0221141523718" class="firsth2">优化建议1：函数各个异常分支及时增加关闭句柄的操作<i class="anchor-icon anchor-icon-link" anchorid="section0221141523718" tips="复制节点链接"></i></h3><p>代码打开文件句柄，但是没有释放造成句柄泄漏。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L111-L123" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InjectContinuingFileFdLeak1</span><span class="hljs-params">(std::string path)</span> </span>{</li><li>    <span class="hljs-type">mode_t</span> fileMode = <span class="hljs-number">0644</span>;</li><li>    <span class="hljs-type">int</span> fd = <span class="hljs-built_in">open</span>(path.<span class="hljs-built_in">c_str</span>(), O_CREAT | O_RDWR, fileMode);</li><li>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">CheckStatus</span>()) {</li><li>        <span class="hljs-comment">// 异常分支未关闭句柄</span></li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">close</span>(fd); <span class="hljs-comment">// 正常业务流程关闭句柄</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L111-L123" target="_blank">resource_leak.cpp</a></div></div></div></div> </div> <p>优化建议：在创建文件句柄的同时在函数出口（含函数各个异常分支）及时增加关闭句柄的操作，防止句柄未正常关闭导致的泄漏。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-lua" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L127-L139" data-highlighted="yes"><ol class="linenums"><li>void InjectContinuingFileFdLeak2(std::<span class="hljs-built_in">string</span> <span class="hljs-built_in">path</span>) {</li><li>    mode_t fileMode = <span class="hljs-number">0644</span>;</li><li>    int fd = <span class="hljs-built_in">open</span>(<span class="hljs-built_in">path</span>.c_str(), O_CREAT | O_RDWR, fileMode);</li><li>    <span class="hljs-keyword">if</span> (fd &lt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (!CheckStatus()) {</li><li>        <span class="hljs-built_in">close</span>(fd);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-built_in">close</span>(fd); // 正常业务流程关闭句柄</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L127-L139" target="_blank">resource_leak.cpp</a></div></div></div></div> <div class="tiledSection"><h2 id="section10137113593613">线程泄漏问题优化建议<i class="anchor-icon anchor-icon-link" anchorid="section10137113593613" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section319816122388" class="firsth2">优化建议1：严格控制线程生命周期<i class="anchor-icon anchor-icon-link" anchorid="section319816122388" tips="复制节点链接"></i></h3><p>未正确管理线程对象，无法知道线程何时结束，可能导致资源泄漏。</p> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L153-L161" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">riskyThreadFunction</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>{</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num; i++) { <span class="hljs-comment">// 创建 Num 个线程</span></li><li>        <span class="hljs-type">pthread_t</span> thread;</li><li>        <span class="hljs-built_in">pthread_create</span>(&amp;thread, <span class="hljs-literal">NULL</span>, LeadThreadFn, <span class="hljs-literal">NULL</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L153-L161" target="_blank">resource_leak.cpp</a></div></div></div></div> <p>优化建议：</p> <ol><li>严格控制线程的生命周期，尽量避免大量线程同时存在以及线程生命周期脱离控制的情况；</li><li>保证异常场景的线程安全，补充异常场景下的线程管理机制，推荐使用线程池来进行管理；</li><li>创建线程时为线程取名（默认继承父进程名，导致大量同名线程），便于出现线程泄漏后的快速定位；</li><li>pthread_create后需要调用pthread_join或者pthread_detach确保线程资源能回收掉。</li></ol> <div class="screenLinkPre"><div _ngcontent-pux-c106="" class="highlight-div"><div _ngcontent-pux-c106="" class="highlight-div-header"><div _ngcontent-pux-c106="" class="highlight-div-header-left"><div _ngcontent-pux-c106="" class="handle-button expand-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-pux-c106="" class="highlight-div-header-right"><div _ngcontent-pux-c106="" class="handle-button ai-button"></div><div _ngcontent-pux-c106="" class="handle-button line-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-pux-c106="" class="handle-button theme-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-pux-c106="" class="handle-button copy-button"><div _ngcontent-pux-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-pux-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L167-L187" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ThreadPool</span> { <span class="hljs-comment">// 线程池实现，支持线程生命周期管理和回收</span></li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">addTask</span><span class="hljs-params">(<span class="hljs-type">const</span> Task&amp; task)</span> </span>{</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;</li><li>    }</li><li>};</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safeThreadFunction</span><span class="hljs-params">(<span class="hljs-type">int</span> num)</span> </span>{</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num; i++) { <span class="hljs-comment">// 创建 Num 个线程</span></li><li>        Task task;</li><li>        <span class="hljs-type">bool</span> ret = ThreadPool::<span class="hljs-built_in">addTask</span>(task); <span class="hljs-comment">// 使用线程池管理线程</span></li><li>        <span class="hljs-keyword">if</span> (ret) {</li><li>            <span class="hljs-keyword">break</span>;</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/MemoryDetection/entry/src/main/cpp/resource_leak.cpp#L167-L187" target="_blank">resource_leak.cpp</a></div></div></div></div> </div> </div> <div></div></div>