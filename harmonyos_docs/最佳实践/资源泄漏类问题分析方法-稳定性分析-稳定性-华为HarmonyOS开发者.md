<h1 _ngcontent-gkc-c119="" class="doc-title ng-star-inserted" title="资源泄漏类问题分析方法"> 资源泄漏类问题分析方法 </h1>

<div _ngcontent-gkc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;">   <div>    <div class="tiledSection">     <h2 id="section1374105218220">概述<i class="anchor-icon anchor-icon-link" anchorid="section1374105218220" tips="复制节点链接"></i></h2>          <p>资源泄漏产生的原因是程序未正确释放已分配的资源（如内存、文件句柄等），导致资源被持续占用无法再利用。本章节会详细介绍资源泄漏问题的相关分析方法。</p>     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>资源泄漏日志获取方法与日志规格详见<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines" target="_blank">Resource Leak（资源泄漏）检测</a>。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h2 id="section728319329442">内存泄漏分析方法<i class="anchor-icon anchor-icon-link" anchorid="section728319329442" tips="复制节点链接"></i></h2>         </div>    <div class="tiledSection">     <h3 id="section1183695881312" class="firsth2">JS泄漏<i class="anchor-icon anchor-icon-link" anchorid="section1183695881312" tips="复制节点链接"></i></h3>         </div>    <p>应用侧声明的class、struct、enum，以及通过new创建的实例对象、build中声明的组件、lambda表达式创建的匿名函数，对应在ArkTS虚拟机中都会创建对应的内存对象，虚拟机会自动在函数对象中引用依赖上下文的闭包环境，从而产生隐式的一些引用关系，比较容易产生内存泄漏。</p>    <p>整体分析策略：</p>    <p><span><img height="401.9925" originheight="660" originwidth="858" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.34548351242666602879509807385239:50001231000000:2800:C907D0F567FC974F57718261DC5EA36DA730ED85BD96B0F97FA18C6CEE4BA1C4.png" title="点击放大" width="523.6875"></span></p>    <p><strong>开发态-JS泄漏分析方法（适用于开发过程中特定场景下调优）</strong></p>    <p>使用DevEco Studio Snapshot能力可抓取两次heapdump，请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V5/ide-snapshot-basic-operations-V5" target="_blank">Snapshot模板基本操作</a>，通过比较两次heapdump的对象delta进行分析：</p>    <p>Summary功能可以用来查看全量内存信息，Comparison可以用来进行两份内存快照对比。</p>    <p>如下：</p>    <ol>     <li>在profiler模块，在操作前后采集两次snapshot看一下delta（按照delta排序）；</li>     <li>找到和业务相关的对象；</li>     <li>展开业务代码根节点，通过Distance观察引用路径，值越小表示离GC Root的距离越近，展开节点依次找到最小的值，看一下这些业务对象个数是否符合当前这个页面的预期，是否存在循环引用或者闭包问题导致泄漏。      <ol>       <li>找到应用自己的包名的对象。</li>       <li>查看reference分组的每个对象。</li>       <li>展开这个对象，找到对象的成员，看每个成员的distance，找到其中最小的。</li>       <li>重复b和c步骤，直到找到distance为的1的为止，这个就是GC Root根节点。</li>      </ol></li>    </ol>    <p><span><img originheight="730" originwidth="1692" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.35578303095523898516310169051222:50001231000000:2800:6140899B9BF7E462D0A69137E968572829BAA174D1978EC0AD2B0ACB1EC0209F.png" width="920" height="396.92671394799055"></span>具体操作方法可见<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-js-memleak-detection">JS内存泄漏问题检测方法</a>。</p>    <p><strong>运维态-JS泄漏分析方法【适用于运维态自动采集获取日志】</strong></p>    <p>如果自动上报的只有1份heapdump，需要根据实际应用逻辑，按照Retained Size排序，看是否当前对象个数超过业务逻辑预期（比如X1000、X10000个对象的，明显是存在异常的），如果超过就根据该对象的引用关系查找泄漏点；</p>    <p>如下图，存在26个Note JSObject对象，与实际业务不符合，需要进一步查其引用关系判断是否泄漏：</p>    <div class="p">     <span><img originheight="468" originwidth="1822" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.24458905710309020565911885302818:50001231000000:2800:A90C0F23A95C54EB994017166CF1FF511F0785C93BBADA853F63D7855F80955F.png" width="920" height="236.31174533479694"></span>除以上方法外，JS泄漏分析方法还可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-arkts-js-memory-analysis">分析ArkTS/JS内存</a>。     <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">       <p>每次抓snapshot会触发1次GC，snapshot文件中展示的对象都是经过GC后因GC根可达无法释放的对象。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="section1658571616574">Native泄漏<i class="anchor-icon anchor-icon-link" anchorid="section1658571616574" tips="复制节点链接"></i></h3>          <p><strong>开发态-native内存泄漏分析方法</strong></p>     <p>对于开发过程中遇到的泄漏问题，开发者可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-native-memory-analysis">分析native内存</a>抓取维测并分析占用最大的内存块及其调用栈排查泄漏点。</p>     <p><strong>运维态-native内存泄漏分析方法</strong></p>    </div>    <ol>     <li>分析sample日志      <p>开发者可以通过分析采样日志[memleak-native-[process_name]-[pid]-sample.txt]，观察进程内存增长趋势，来确认内存泄漏情况。</p>      <p>如：某应用 PSS泄漏，根据TotalMem列可以看到进程内存一直持续增长，峰值内存TopPssMemory为3GB左右，观察Realtime一列带*的那一行为将共享内存去重后的进程pss内存使用情况：</p>      <p><span><img originheight="266" originwidth="1528" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.26810123628167792832474253730651:50001231000000:2800:EE03395E8E13848EC2FC1CA5DAA80A4C570E81F631E1E1433D9DA3301D5D1CBA.png" width="920" height="160.15706806282722"></span></p></li>     <li>分析smaps日志      <div class="p">       native泄漏有多种泄漏类型，具体可根据表格定位分析是哪一块泄漏，其中总PSS内存即sample文件的采样内存（可用最后一个）。        <div class="tablenoborder">        <div class="tbBox"><table class="layoutFixed idpTab">         <thead>          <tr>           <th align="left" class="cellrowborder" id="mcps1.3.18.2.1.1.1.4.1.1" valign="top" width="11.98989898989899%">            <p>泄漏类型</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.18.2.1.1.1.4.1.2" valign="top" width="49.54545454545454%">            <p>判定方法</p></th>           <th align="left" class="cellrowborder" id="mcps1.3.18.2.1.1.1.4.1.3" valign="top" width="38.46464646464647%">            <p>定位方法</p></th>          </tr>         </thead>                   <tbody><tr>           <td class="cellrowborder" valign="top" width="11.98989898989899%">            <p>虚拟机对象泄漏</p></td>           <td class="cellrowborder" valign="top" width="49.54545454545454%">            <p>搜索关键字“ArkTS”，PSS和SWAP PSS列的值加起来，如果超过总PSS内存的50%，则说明是虚拟机对象内存过大。</p></td>           <td class="cellrowborder" valign="top" width="38.46464646464647%">            <p>同<a href="/consumer/cn/doc/best-practices/bpta-stability-leak-way#section1183695881312">JS泄漏定位方法</a>。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="11.98989898989899%">            <p>堆内存泄漏</p></td>           <td class="cellrowborder" valign="top" width="49.54545454545454%">            <p>搜索关键字“jemalloc”，PSS和SWAP PSS列的值加起来，如果超过总PSS内存的50%，则说明是堆内存过大。</p></td>           <td class="cellrowborder" valign="top" width="38.46464646464647%">            <p>基于NMD和profiler分析。</p>            <p>堆内存泄漏有两种可能：</p>            <p>1、调用ArkUI的接口或者开发者的so，直接malloc申请的堆内存过大。</p>            <p>2、虚拟机对象持有堆内存引用，对象泄漏导致native内存过大。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="11.98989898989899%">            <p>ashmem泄漏</p></td>           <td class="cellrowborder" valign="top" width="49.54545454545454%">            <p>搜索关键字“/dev/ashmem”，如果超过总PSS内存的50%，则说明是ashmem内存过大。</p></td>           <td class="cellrowborder" valign="top" width="38.46464646464647%">            <p>同<a href="/consumer/cn/doc/best-practices/bpta-stability-leak-way#section2825227501">ashmem泄漏方法</a>。</p>            <p>1、开发者使用image组件、pixmap组件可能未释放。</p>            <p>2、开发者直接通过系统调用申请。</p></td>          </tr>          <tr>           <td class="cellrowborder" valign="top" width="11.98989898989899%">            <p>anon类型较大</p></td>           <td class="cellrowborder" valign="top" width="49.54545454545454%">            <p>单个anon类型占用内存较大。</p></td>           <td class="cellrowborder" valign="top" width="38.46464646464647%">            <p>怀疑mmap内存未释放，直接排查profiler栈，框选All Anonymous VM，筛选Created &amp; Existing，排查内存占用最多的部分。</p></td>          </tr>                 </tbody></table></div>       </div>      </div>      <p>对于堆内存泄漏，开发者可以基于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/performance-analysis-kit-terminology#nmd" target="_blank">NMD</a>（堆内存快照，判定泄漏时，堆内存布局的快照）和profiler分析：</p>      <p>“LOGGER_MEMCHECK_SAMPLE_NMD_INFO”与“LOGGER_MEMCHECK_DETIAL_INFO”中记录抓取进程native日志时内存的快照信息，主要关注其size和allocated两列，是否有比较突出的内存占用，日志格式如下。</p>      <p><span><img originheight="193" originwidth="350" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.11319953685458726069304295430379:50001231000000:2800:D095D32CC282BE1FF5E4EC184D35654DD10F6CF3EBAFBF25D306A419E49D3FAE.png" width="350" height="193"></span></p>      <p>如果有，假设size为a（如128），就去调用栈中查找size为a的内存申请，重点分析这行调用栈，极可能是泄漏点。</p>      <p>如果单次抓取的NMD信息无法确定具体的size，那么可以通过比较两次LOGGER_MEMCHECK_SAMPLE_NMD_INFO来判断5分钟内增长最大的size。</p>      <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">        <p><strong>Size：</strong>用户申请的内存经过对齐后的大小，jemalloc对齐size的分割是按照一个特定算法算的，8字节是最小单位，从第二个size开始，最小step是16，一个size到它的两倍size之间有4个分档。用户态传入的申请大小会向下对齐到离它最近的size中。</p>        <p><strong>Allocated：</strong>size申请的总内存。</p>       </div></div></div></li>     <li>分析profiler日志      <p>除了通过smaps日志对内存占用进行初步分析，开发者还可以通过对profiler进行解析来对泄漏问题作进一步分析，日志解析主要有以下两种方法</p>      <ul>       <li>开发者可以将获取到的profiler文件导入DevEco Studio Profiler插件中进行分析，导入后点击 会在界面展示进程的内存分配情况及其调用栈。按照如下步骤将解析结果展开，通过将Bytes/Count的结果与通过smaps日志分析出的size进行匹配，来排查可疑的泄漏点，并通过调用栈进一步确认泄漏位置。        <p><span><img height="374.56675102815564" originheight="901" originwidth="2213" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.07608443638839632353800608140575:50001231000000:2800:5E907963D6B4616ECC4996877BAD6AC662A0C80EF9976D28CD229A0C39617502.png" title="点击放大" width="920"></span></p></li>      </ul>      <ul>       <li>本地搭建<a href="https://gitcode.com/openharmony-sig/smartperf" target="_blank">Smartperf</a>环境，并导入profiler日志进行解析，框选All Heap，解析profiler，选择Created &amp; Existing，在搜索框中搜索通过NMD信息拿到初步怀疑内存块并通过调用栈确认泄漏点。        <p>假设NMD信息中，12582912字节的内存块内存占比最大，则搜索并排查该堆栈中对应12582912字节对应的调用栈如下：</p>        <p><span><img originheight="315" originwidth="2553" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163450.02650170196600293042752964640389:50001231000000:2800:BF47C37EB4F56909F0A73F3A8F398169CEE927B074F7A4D313CD706426295709.png" width="920" height="113.5135135135135"></span></p></li>      </ul></li>    </ol>    <div class="tiledSection">     <h3 id="section2825227501"><strong>ashmem泄漏</strong><i class="anchor-icon anchor-icon-link" anchorid="section2825227501" tips="复制节点链接"></i></h3>          <p>图片共享内存一般有以下几种命名方式：</p>     <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>/<span class="hljs-variable">dev</span>/<span class="hljs-variable">ashmem</span>/<span class="hljs-variable">PixelMap</span> <span class="hljs-variable">RawData</span>, <span class="hljs-variable">uniqueId</span>: <span class="hljs-title class_">xxxx_xx</span></li><li>/<span class="hljs-variable">dev</span>/<span class="hljs-variable">ashmem</span>/<span class="hljs-variable">JPEG</span> <span class="hljs-variable">RawData</span>, <span class="hljs-variable">uniqueId</span>: <span class="hljs-title class_">xxx_xxx</span></li><li>/<span class="hljs-variable">dev</span>/<span class="hljs-variable">ashmem</span>/<span class="hljs-variable">EXTRawData</span></li></ol></pre></div></div>     <p>这些内存都是由图片编解码框架提供的编解码工具申请的，申请代码如下：</p>     <p><span><img height="439.684966" originheight="541" originwidth="718" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.55002121495974935219843912080813:50001231000000:2800:44EE62C47F0D7826AF2BEBEAC12A2A13957FDB730A8A7A507AA2BC2253C9AD51.png" title="点击放大" width="583.5375"></span></p>     <p>解码框架本身没有问题，一旦完成解码，ashmem的所有权会转移给C++的PixelMap对象，如果是ashmem泄漏，基本上可以断定是C++层的PixelMap泄漏。</p>     <p>开发者首先排查是否存在如下可能：</p>     <ul>      <li>开发者的应用使用了JS层API（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#setmemorynamesync13" target="_blank">setMemoryNameSync()</a>），在native层创建并使用decode()解码获取PixelMap，但是可能存在申请未释放、把PixelMap缓存到应用生命周期的容器类中、引用计数多加等可能。</li>      <li>如果应用根本就没有使用 Node-API 实现C++代码，那么排查是否使用JS层的PixelMap，可能存在JS对象泄漏或者缓存太多导致PixelMap大量占用，可以使用 DevEco Studio抓取两次snapshot，分析对象的增量。</li>      <li><strong>【推荐】</strong>pixmap使用的ashmem内存，应用自定义绑定pixmap名字，当出现ashmem泄漏，快速根据ashmem块的名字锁定哪张图片存在问题，反推至对应的问题组件。</li>     </ul>     <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content">       <p><span style="color: rgb(0,38,84);">提供的API接口使用方法可参考：</span><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-image-pixelmap#setmemorynamesync13" target="_blank">@ohos.multimedia.image (图片处理).setMemoryNameSync</a> 和 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-pixelmap-native-h#oh_pixelmapnative_setmemoryname" target="_blank">OH_PixelmapNative_SetMemoryName()</a>。</p>      </div></div></div>    </div>    <div class="tiledSection">     <h3 id="section5493141412410"><strong>ION泄漏</strong><i class="anchor-icon anchor-icon-link" anchorid="section5493141412410" tips="复制节点链接"></i></h3>         </div>    <ol>     <li>对于ION泄漏，开发者可在ION泄漏维测日志[memleak-kernel-[module]-0-[timestamp].txt]中搜索“Total dmaheap size of”查看自身应用进程的ION内存占用量。      <p><span><img originheight="95" originwidth="600" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.53121838318995650105642544726220:50001231000000:2800:E0F13BB8E174A64E908248393ADAA6C4A7881B4FD767870EC58520222BEA96C1.png" width="600" height="95"></span></p></li>     <li>搜索magic这一列，magic相同表示属于用一块buffer，正常如下，应该是存在buffer流转，buffer被多个进程共享。      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>       <span class="hljs-variable">Process</span> <span class="hljs-variable">ID</span>           <span class="hljs-variable">fd</span>             <span class="hljs-variable">size</span>            <span class="hljs-variable">magic</span>         <span class="hljs-variable">buf</span>-&gt;<span class="hljs-title class_">pid</span>   <span class="hljs-title class_">buf</span>-&gt;<span class="hljs-title class_">task_comm</span></li><li><span class="hljs-variable">process1</span>              <span class="hljs-number">965</span>               <span class="hljs-number">41</span>          <span class="hljs-number">1048576</span>             <span class="hljs-number">6507</span>              <span class="hljs-number">965</span>       <span class="hljs-variable">process1</span></li><li><span class="hljs-variable">process5</span>              <span class="hljs-number">965</span>               <span class="hljs-number">43</span>          <span class="hljs-number">1048576</span>             <span class="hljs-number">6507</span>              <span class="hljs-number">965</span>       <span class="hljs-variable">process1</span></li><li><span class="hljs-variable">process6</span>              <span class="hljs-number">965</span>               <span class="hljs-number">44</span>          <span class="hljs-number">1048576</span>             <span class="hljs-number">6507</span>              <span class="hljs-number">965</span>       <span class="hljs-variable">process1</span></li></ol></pre></div></div></li>     <li>如果存在如下的大量只存在一个进程内部的buffer，高概率怀疑存在泄漏，大概率是一个进程已经释放了，但是另一个进程未释放。      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>       <span class="hljs-variable">Process</span> <span class="hljs-variable">ID</span>            <span class="hljs-variable">fd</span>             <span class="hljs-variable">size</span>            <span class="hljs-variable">magic</span>         <span class="hljs-variable">buf</span>-&gt;<span class="hljs-title class_">pid</span>   <span class="hljs-title class_">buf</span>-&gt;<span class="hljs-title class_">task_comm</span></li><li><span class="hljs-variable">process6</span>             <span class="hljs-number">39654</span>               <span class="hljs-number">604</span>          <span class="hljs-number">45441024</span>             <span class="hljs-number">5105</span>              <span class="hljs-number">1331</span>       <span class="hljs-variable">process1</span></li></ol></pre></div></div></li>     <li>目前因为采用了统一渲染机制，大部分ION内存都是在Render_service进程分配使用的，如果发现应用使用ION超标了，那么按照历史经验，高概率怀疑是PixelMap C++对象泄漏。      <p>开发者首先排查是否存在如下可能：</p>      <p><strong>step1：</strong>开发者的应用使用了Node-API在native层创建并使用decode()解码获取PixelMap，但是可能存在申请未释放、把PixelMap缓存到应用生命周期的容器类中、引用计数多加等可能。</p>      <p><strong>step2：</strong>如果应用根本就没有使用Node-API实现C++代码，那么排查是否使用JS层的PixelMap，可能存在JS对象泄漏或者缓存太多导致PixelMap大量占用，可使用IDE抓两次snapshot看一下对象的增量分析，操作方法见下图。</p>      <p><span><img originheight="302" originwidth="930" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.38426614661419514074584545532812:50001231000000:2800:66AA698BE6EABC744103015E14E10F0149C8F8C5934E538E3F1E02E7F2135AB2.png" width="920" height="298.752688172043"></span></p>      <p><strong>step3: </strong> <strong>【推荐】</strong>pixmap使用的ION内存，应用自定义绑定pixmap名字，当出现ION泄漏，快速根据ION的buffer名锁定哪张图片存在问题，反推至对应的问题组件。</p>      <p>如果上述两种情况都不存在，那么很有可能ArkUI组件内部实现存在PixelMap泄漏。</p></li>     <li>从HarmonyOS 6.0.0开始，如果应用未自行打标签，系统支持自动为ion内存打tag标签信息，可通过查看维测日志[memleak-kernel-[module]-0-[timestamp].txt]中进程的ion内存信息中的buf_name、leak_type等列定界可疑泄漏组件，组件分类如下：       <div class="tablenoborder">       <div class="tbBox"><table class="layoutFixed idpTab">                 <tbody><tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>组件/特性</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>buf_name</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>leak_type</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>Image</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>宽x高-url</p>           <p>覆盖如下三种图片路径：</p>           <p>本地 file://data/xxx/xxxxxx/xxx.png</p>           <p>网络 https://xxxx/xxxxx.png</p>           <p>资源 resource://xxxxxxx.png</p>           <p>示例：</p>           <p>72x72-resource://xxx.webp</p>           <p>72x72-https://xxx.png</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>pixelmap</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>XComponent</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>/</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>xc-type-id</p>           <p>注：type取s(surface)、t(texture)，id取xcomponent id</p>           <p>示例：</p>           <p>xc-s-393064299264xc-t-396425487424</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>Web特性-渲染合成</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>/</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>web-特性-组件id注：特性为surface和texture、组件id默认为内部的nodeid，外部三方应用不可设</p>           <p>示例：</p>           <p>web-surface-组件id</p>           <p>web-texture-组件id</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>Web特性-媒体</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>web-宽x高-特性</p>           <p>注：宽和高是图片的分辨率</p>           <p>示例：</p>           <p>web-1920x1280-heif</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>web-宽x高-特性</p>           <p>注：宽和高是图片的分辨率</p>           <p>示例：</p>           <p>web-1920x1280-heif</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>图片解码</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>原图-宽x高-解码后-宽x高-原图文件大小[B]-原图图片类型</p>           <p>注：B代表单位-字节</p>           <p>示例：</p>           <p>srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp</p>           <p>各字段含义解释：</p>           <p>srcImageSize-宽x高：原图分辨率 宽x高</p>           <p>pixelMapSize-宽x高：原图解码后的分辨率 宽x高</p>           <p>streamSize-文件大小：原图文件大小（单位：字节数）</p>           <p>mmitype-图片类型：原图图片类型（png/webp/jpg/...）</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>NULL</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>视频硬编解码</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>宽x高-协议类型-实例id</p>           <p>注：宽x高是指视频的分辨率，协议类型取值hevc、avc、vvc，实例id为内部生成</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>hw-video-编解码类型</p>           <p>注：编解码类型取值encoder、decoder</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>视频软编解码</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>宽x高-协议类型-实例id</p>           <p>注：宽x高是指视频的分辨率，协议类型取值hevc、avc，实例id为内部生成</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>sw-video-编解码类型</p>           <p>注：编解码类型取值encoder（手机不支持）、decoder</p></td>         </tr>         <tr>          <td class="cellrowborder" valign="top" width="33.95959595959596%">           <p>图形Surface</p></td>          <td class="cellrowborder" valign="top" width="32.707070707070706%">           <p>/</p></td>          <td class="cellrowborder" valign="top" width="33.333333333333336%">           <p>external</p>           <p>注1：应用C/C++代码若调用如下2个NDK API，则会自动被添加external标签</p>           <p>(1) OH_NativeWindow_NativeWindowRequestBuffer</p>           <p>(2) OH_NativeBuffer_Alloc</p>           <p>注2：如下接口务必配对使用，否则会造成内存泄漏</p>           <p>(1) OH_NativeWindow_NativeWindowRequestBuffer与OH_NativeWindow_NativeWindowFlushBuffer配对</p>           <p>当OH_NativeWindow_NativeWindowFlushBuffer执行失败，可在异常处理流程中使用OH_NativeWindow_NativeWindowAbortBuffer归还请求的Buffer到Buffer队列。</p>           <p>(2) OH_NativeBuffer_Alloc与OH_NativeBuffer_Unreference配对</p></td>         </tr>               </tbody></table></div>      </div>      <p>如果应用发生ion内存泄漏，开发者可以在泄漏日志中[memleak-kernel-[module]-0-[timestamp].txt]，查找导如下与进程相关维测信息：</p>      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-markdown" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</li><li>LOGGER<span class="hljs-emphasis">_MEMCHECK_</span>PROC<span class="hljs-emphasis">_INFO</span></li><li><span class="hljs-emphasis">MM_</span>DMABUF<span class="hljs-emphasis">_INFO</span></li><li><span class="hljs-emphasis">Process     pid     fd        size_</span>bytes  ino         exp<span class="hljs-emphasis">_pid    exp_</span>task<span class="hljs-emphasis">_comm    buf_</span>name                 exp<span class="hljs-emphasis">_name            buf_</span>type       leak<span class="hljs-emphasis">_type</span></li><li><span class="hljs-emphasis">process1    65141    246        278528        432510     42829        allocator_</span>host    65141                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li>process1    65141    247        266240        434225     42829        allocator<span class="hljs-emphasis">_host    65141                    mm_</span>heap<span class="hljs-emphasis">_helpers    NULL        NULL</span></li><li><span class="hljs-emphasis">process1    65141    248        274432        430933     42829        allocator_</span>host    65141                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li>process1    65141    264        14036992    432500     42829        allocator<span class="hljs-emphasis">_host    https://xxxx/xxxxx.png        mm_</span>heap<span class="hljs-emphasis">_helpers    pixelmap        pixelmap</span></li><li><span class="hljs-emphasis">process1    65141    266        14036992    426988     42829        allocator_</span>host    https://xxxx/xxxxx.png        mm<span class="hljs-emphasis">_heap_</span>helpers    pixelmap        pixelmap</li><li>process1    65141    268        14036992    430936     42829        allocator<span class="hljs-emphasis">_host    https://xxxx/xxxxx.png        mm_</span>heap<span class="hljs-emphasis">_helpers    pixelmap        pixelmap</span></li><li><span class="hljs-emphasis">process1    65141    258        4493312        432499     42829        allocator_</span>host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li>process1    65141    260        4493312        426987     42829        allocator<span class="hljs-emphasis">_host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm_</span>heap<span class="hljs-emphasis">_helpers    NULL        NULL</span></li><li><span class="hljs-emphasis">process1    65141    262        4493312        431689     42829        allocator_</span>host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li>process1    65141    254        4493312        430935     42829        allocator<span class="hljs-emphasis">_host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm_</span>heap<span class="hljs-emphasis">_helpers    NULL        NULL</span></li><li><span class="hljs-emphasis">process1    65141    256        4493312        431688     42829        allocator_</span>host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li>process1    65141    250        4493312        432498     42829        allocator<span class="hljs-emphasis">_host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm_</span>heap<span class="hljs-emphasis">_helpers    NULL        NULL</span></li><li><span class="hljs-emphasis">process1    65141    252        4493312        430934     42829        allocator_</span>host    srcImageSize-2160x2880-pixelMapSize-2160x2880-streamsize-761322-mimetype-webp                    mm<span class="hljs-emphasis">_heap_</span>helpers    NULL        NULL</li><li><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span> endl <span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span></li></ol></pre></div></div>      <p>开发者可以首先根据通过size_bytes的大小以及分布趋势初步排查出可疑的泄漏内存块：</p>      <ul>       <li>以下内存块的的单个buf较大，每个buf都占用14036992字节：        <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">process1</span>    <span class="hljs-number">65141</span>    <span class="hljs-number">264</span>        <span class="hljs-number">14036992</span>    <span class="hljs-number">432500</span>     <span class="hljs-number">42829</span>        <span class="hljs-variable">allocator_host</span>    <span class="hljs-variable">https</span>:<span class="hljs-comment">//xxxx/xxxxx.png        mm_heap_helpers    pixelmap        pixelmap</span></li><li><span class="hljs-variable">process1</span>    <span class="hljs-number">65141</span>    <span class="hljs-number">266</span>        <span class="hljs-number">14036992</span>    <span class="hljs-number">426988</span>     <span class="hljs-number">42829</span>        <span class="hljs-variable">allocator_host</span>    <span class="hljs-variable">https</span>:<span class="hljs-comment">//xxxx/xxxxx.png        mm_heap_helpers    pixelmap        pixelmap</span></li><li><span class="hljs-variable">process1</span>    <span class="hljs-number">65141</span>    <span class="hljs-number">268</span>        <span class="hljs-number">14036992</span>    <span class="hljs-number">430936</span>     <span class="hljs-number">42829</span>        <span class="hljs-variable">allocator_host</span>    <span class="hljs-variable">https</span>:<span class="hljs-comment">//xxxx/xxxxx.png        mm_heap_helpers    pixelmap        pixelmap</span></li></ol></pre></div></div></li>      </ul>      <p>开发者可根据其buf_name判断出该内存用于image组件显示图片，且可以根据图片名大致推断业务场景，并以此来排查泄漏点。</p>      <ul>       <li>以下内存块虽然单个不大，但是有重复申请嫌疑：        <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" data-highlighted="yes"><ol class="linenums"><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">258</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">432499</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">260</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">426987</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">262</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">431689</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">254</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">430935</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">256</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">431688</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">250</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">432498</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li><li>process1    <span class="hljs-number">65141</span>    <span class="hljs-number">252</span>        <span class="hljs-number">4493312</span>        <span class="hljs-number">430934</span>     <span class="hljs-number">42829</span>        allocator_host    srcImageSize<span class="hljs-number">-2160</span>x2880-pixelMapSize<span class="hljs-number">-2160</span>x2880-streamsize<span class="hljs-number">-761322</span>-mimetype-webp                    mm_heap_helpers    <span class="hljs-literal">NULL</span>        <span class="hljs-literal">NULL</span></li></ol></pre></div></div>        <p>开发者可根据bufname判断该内存用于图片解码组件，且图片尺寸为2160x2880，且可以根据buf_name推断业务场景为图片解码场景，并根据buf_name中提供的信息来排查泄漏点。</p></li>      </ul></li>    </ol>    <div class="tiledSection">     <h3 id="section10302163291714">gpu泄漏<i class="anchor-icon anchor-icon-link" anchorid="section10302163291714" tips="复制节点链接"></i></h3>         </div>    <ol>     <li>对于gpu泄漏，开发者可以在维测日志[memleak-kernel-[module]-0-[timestamp].txt]中搜索“used summary:”字段；      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ctx_247</span>       <span class="hljs-number">5264</span>       <span class="hljs-number">5058</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">200704</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">180224</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">131072</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_245</span>       <span class="hljs-number">5264</span>       <span class="hljs-number">5058</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_235</span>      <span class="hljs-number">63531</span>      <span class="hljs-number">61358</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">1079209984</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">131072</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">5595136</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">1695744</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">168</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_234</span>      <span class="hljs-number">63531</span>      <span class="hljs-number">61358</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_231</span>      <span class="hljs-number">59150</span>      <span class="hljs-number">58736</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">2289664</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">1732608</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">1695744</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">11</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_230</span>      <span class="hljs-number">59150</span>      <span class="hljs-number">58736</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_229</span>      <span class="hljs-number">58497</span>      <span class="hljs-number">58064</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">4366336</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">1777664</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">1695744</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">15</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_228</span>      <span class="hljs-number">58497</span>      <span class="hljs-number">58064</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_227</span>      <span class="hljs-number">58133</span>      <span class="hljs-number">57801</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">1769472</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">1724416</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">1695744</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">10</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">ctx_226</span>      <span class="hljs-number">58133</span>      <span class="hljs-number">57801</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">12288</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li></ol></pre></div></div></li>     <li>找到问题进程“com.huawei.hmos.xxx”的GPU内存信息打印；      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">ctx_235</span>      <span class="hljs-number">63531</span>      <span class="hljs-number">61358</span> <span class="hljs-variable">used</span> <span class="hljs-variable">summary</span>:<span class="hljs-number">1079209984</span> <span class="hljs-title class_">grow</span>:<span class="hljs-number">131072</span> <span class="hljs-title class_">driver</span>:<span class="hljs-number">5595136</span> <span class="hljs-title class_">kmd</span>:<span class="hljs-number">1695744</span> <span class="hljs-title class_">jit</span>:<span class="hljs-number">0</span> <span class="hljs-title class_">map</span>:<span class="hljs-number">168</span> <span class="hljs-number">0</span> <span class="hljs-number">0</span></li><li><span class="hljs-variable">com</span>.<span class="hljs-variable">huawei</span>.<span class="hljs-variable">hmos</span>.<span class="hljs-variable">xxx</span></li></ol></pre></div></div>      <p>used summary:为进程内存申请总量，第二行为问题进程名。</p></li>     <li>排查数据段中gpu内存的分布情况，观察内存占用异常的gpu内存类型，以及各大小内存申请分布状况：      <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">C</span>: <span class="hljs-title class_">vulkan</span> <span class="hljs-title class_">image</span> (<span class="hljs-title class_">Total</span> <span class="hljs-variable">memory</span>: <span class="hljs-number">1027194880</span>)</li><li> <span class="hljs-number">13</span>:                   <span class="hljs-number">87</span> / <span class="hljs-number">356352</span></li><li> <span class="hljs-number">15</span>:                   <span class="hljs-number">33</span> / <span class="hljs-number">540672</span></li><li> <span class="hljs-number">17</span>:                   <span class="hljs-number">20</span> / <span class="hljs-number">1409024</span></li><li> <span class="hljs-number">18</span>:                    <span class="hljs-number">5</span> / <span class="hljs-number">868352</span></li><li> <span class="hljs-number">19</span>:                   <span class="hljs-number">10</span> / <span class="hljs-number">3604480</span></li><li> <span class="hljs-number">20</span>:                    <span class="hljs-number">1</span> / <span class="hljs-number">589824</span></li><li> <span class="hljs-number">21</span>:                   <span class="hljs-number">10</span> / <span class="hljs-number">12255232</span></li><li> <span class="hljs-number">22</span>:                    <span class="hljs-number">9</span> / <span class="hljs-number">29097984</span></li><li> <span class="hljs-number">23</span>:                    <span class="hljs-number">9</span> / <span class="hljs-number">65753088</span></li><li> <span class="hljs-number">24</span>:                   <span class="hljs-number">23</span> / <span class="hljs-number">293847040</span></li><li> <span class="hljs-number">25</span>:                    <span class="hljs-number">5</span> / <span class="hljs-number">165888000</span></li><li> <span class="hljs-number">26</span>:                    <span class="hljs-number">9</span> / <span class="hljs-number">452984832</span></li></ol></pre></div></div>      <p>以vulkan image为例，vulkan主要用于纹理渲染等用途，从日志可见：2^23~2^24大小的图片，申请了23次，总占用293847040字节。开发者可以根据场景以及纹理申请大小排查泄漏点。</p></li>    </ol>    <div class="tiledSection">     <h3 id="section174311514174111">gpu_rs泄漏<i class="anchor-icon anchor-icon-link" anchorid="section174311514174111" tips="复制节点链接"></i></h3>          <ol>      <li>对于gpu_rs泄漏，开发者可以在维测日志[memleak-kernel-[module]-0-[timestamp].txt]中搜索“used summary:”字段，来查看renderservice的内存使用情况；       <p><span><img originheight="242" originwidth="871" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.97587288895408466270085430522420:50001231000000:2800:D4C94AE23EC8D35213D159C2E9831B377B4BAD44E95E6C78BC56F0D1FBB8CE4B.png" width="871" height="242"></span></p></li>      <li>找到render_service对应的GPU内存信息打印，gpu_rs上报的进程泄漏是通过render_service进行统一渲染的，因此需要分析render_service的GPU内存信息占用来排查问题；       <p><span><img originheight="77" originwidth="950" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.45778915812062088014154053585909:50001231000000:2800:9168D408BEF795A7A42E7566FD64F5C710366943B810B797ABD361AF6F9E4D21.png" width="920" height="74.56842105263158"></span></p></li>      <li>进一步查看rs gpu的内存占用发现vulkan image和vulkan buffer占用比较高，重点排查一下框选的两处维测信息。       <p><span><img originheight="405" originwidth="971" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163451.86067862898433380101576499249426:50001231000000:2800:61FB78F3CACCADFD18EC825BDC2F6C363E65BDB188732A8842C38C36CB8EF612.png" width="920" height="383.72811534500516"></span></p></li>     </ol>    </div>    <div class="tiledSection">     <h2 id="section9594173320417">句柄泄漏分析方法<i class="anchor-icon anchor-icon-link" anchorid="section9594173320417" tips="复制节点链接"></i></h2>          <p>系统侧检测到进程发生句柄泄漏后，会落盘句柄泄漏日志[[pid]_fd_leak.txt]以支撑开发者定位，详细分析方法如下：</p>     <ol>      <li>泄漏日志中的“leaked fd nums”字段记录了进程总句柄使用量，开发者可以通过句柄使用量来判断当前进程的泄漏严重程度（单进程句柄上限3w+）。       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-yaml" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-attr">leaked fd nums:</span> <span class="hljs-string">xxxxxx</span></li></ol></pre></div></div></li>      <li>句柄泄漏的详细信息中会分别按照<strong>文件名与文件路径</strong>聚类后，列出top10的类型与句柄个数。       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-swift" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-type">FdCount</span>    <span class="hljs-type">FileDescriptor</span></li><li>
</li><li><span class="hljs-operator">*****************************</span></li><li><span class="hljs-type">Leaked</span> fd <span class="hljs-type">Top</span> <span class="hljs-number">10</span>:</li><li><span class="hljs-number">1337</span>    ashmem</li><li><span class="hljs-number">259</span>    socket</li><li><span class="hljs-number">119</span>    dmabuf</li><li><span class="hljs-number">48</span>    eventfd</li><li><span class="hljs-number">42</span>    sync_file</li><li><span class="hljs-number">17</span>    eventpoll</li><li><span class="hljs-number">3</span>    <span class="hljs-regexp">/sys/</span>kernel<span class="hljs-regexp">/debug/</span>tracing<span class="hljs-operator">/</span>trace_marker</li><li><span class="hljs-number">3</span>    <span class="hljs-regexp">/dev/</span>null</li><li><span class="hljs-number">2</span>    <span class="hljs-regexp">/dev/</span>hvgr0</li><li>
</li><li><span class="hljs-type">Dir</span> <span class="hljs-type">Type</span> <span class="hljs-type">Top</span> <span class="hljs-number">10</span>:</li><li><span class="hljs-number">3</span>    <span class="hljs-regexp">/dev/</span>null</li><li><span class="hljs-number">3</span>    <span class="hljs-regexp">/sys/</span>kernel<span class="hljs-regexp">/debug/</span>tracing<span class="hljs-operator">/</span>trace_marker</li><li><span class="hljs-number">2</span>    <span class="hljs-regexp">/dev/</span>hvgr</li><li><span class="hljs-number">1</span>    <span class="hljs-regexp">/dev/</span>binder</li><li><span class="hljs-number">1</span>    <span class="hljs-regexp">/proc/</span></li></ol></pre></div></div></li>      <li>根据不同泄漏句柄类型，按照对应的分析方法<strong>初步分析</strong>，日志格式可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section1120134982114" target="_blank">句柄泄漏日志规格</a>。       <p><strong>文件句柄泄漏</strong></p>       <p>文件句柄泄漏，主要原因是：应用TS调用API间接打开了某个文件，或者C++代码直接调用open()接口，从日志内可以看到完整的文件的dentry信息，基于文件路径和文件名可以反推对应的使用场景，在哪里调用的，建议关注对应的对象或者fd的生命周期，及时释放防止并发场景下fd过载导致出现功能甚至稳定性异常。</p>       <p>如下日志，可以看到/data/storage/el1/bundle/entry.hap这个文件的fd有5663，且是一个hap，找到对应open的位置，发现是应用内不断open 这个文件，句柄未及时释放。</p>       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>Leaked fd Top 10:</li><li>5663    /data/storage/el1/bundle/entry.hap</li><li>125    ashmem</li><li>22    eventpoll</li><li>22    eventfd</li><li>16    pipe</li><li>13    socket</li><li>Top Dir Type 10:</li><li>5711  /data/storage/el...</li><li>4    /dev/urandom</li><li>3    /dev/null</li><li>2    /proc/</li><li>2    /dev/binder</li></ol></pre></div></div>       <p><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section328913422256" target="_blank">ashmem类型句柄</a>或</strong><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section328913422256" target="_blank">dmabuf类型句柄</a></strong></p>       <p>如果泄漏日志中top句柄报的是ashmem、dmabuf（ION），可按照ashmem、ION泄漏问题进行分析：</p>       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-markdown" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span><span class="hljs-strong">****</span>*</li><li>Leaked fd Top 10:</li><li>5000    dmabuf</li><li>3    /dev/pts/0</li><li>2    socket</li><li>1    /dev/dma<span class="hljs-emphasis">_heap/system_</span>heap</li><li>1    /dev/kmsg</li><li>1    eventpoll</li><li>1/log/updater/quickfix/log/...</li></ol></pre></div></div>       <p>分析方法可参考<a href="/consumer/cn/doc/best-practices/bpta-stability-leak-way#section2825227501">ashmem泄漏</a>和<a href="/consumer/cn/doc/best-practices/bpta-stability-leak-way#section5493141412410">ION泄漏</a>，判断是这两种句柄类型泄漏后同样会打印下述分析方法中的维测信息。</p>       <p><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section328913422256" target="_blank">socket类型句柄</a></strong></p>       <ol>        <li>由于打印的维测信息是整机的，因此首先在日志中根据进程pid或者进程名搜索，查看本应用所占用的socket句柄。</li>        <li>查看inode和对端进程，两方进程通信持有的inode相同，PeerTid一般就是对端进程的PID。</li>        <li>关注应用代码中是否使用socket()等接口创建socket句柄，排查其生命周期是否存在泄漏。</li>       </ol>       <p><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section328913422256" target="_blank">pipe类型句柄</a></strong></p>       <ol>        <li>由于打印的维测信息是整机的，因此首先在日志中根据进程pid或者进程名搜索，查看本应用所占用的pipe句柄。</li>        <li>关注应用代码中是否使用pipe()和pipe2()等接口创建pipe句柄，排查其生命周期是否存在泄漏。</li>       </ol>       <p><strong><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/resource-leak-guidelines#section328913422256" target="_blank">sync_file泄漏</a></strong></p>       <ol>        <li>由于打印的维测信息是整机的，因此首先在日志中根据进程pid或者进程名搜索，查看本应用所占用的sync句柄。</li>        <li>关注应用可能使用如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_o_h___native_image-V5#oh_nativeimage_acquirenativewindowbuffer" target="_blank">OH_NativeImage_AcquireNativeWindowBuffer()</a>接口，获取了sync_file句柄，需严格按照指导文档，如该接口文档明确表示，应用使用该接口需要和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references-V5/_o_h___native_image-V5#oh_nativeimage_releasenativewindowbuffer" target="_blank">OH_NativeImage_ReleaseNativeWindowBuffer()</a>接口配合使用，否则会存在内存泄漏。当fenceFd（即sync_file）使用完，用户需要将其关闭。</li>       </ol></li>      <li>基于初步分析结果，如果定位仍存在困难，建议开发者打开开发者选项-系统资源泄漏日志开关，基于流水日志分析场景复现。此时当判定句柄泄漏后，会hook该进程的pipe/open等系统调用10分钟，抓取调用栈，并基于相同调用栈聚类。如下每一行都是一个调用栈，调用顺序为从右到左，其中num后面的数字表示这个调用栈总共有多少个，bt后面为具体调用栈。具体栈信息可通过<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-app-crash-cpp-way#li186453444512">addr2line</a>解析到对应的函数。       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-bash" data-highlighted="yes"><ol class="linenums"><li>*****************************</li><li>LOGGER_MEMCHECK_FD_STACK_INFO</li><li>pid: 12326</li><li>get stack time: 2024/06/17 19:16:48</li><li>==============================FdTrack Stack==============================</li><li>Generated by HiviewDFX @OpenHarmony</li><li>==============================Sorted by num==============================</li><li>num 8272 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib/ld-musl-aarch64.so.1+0x148940] [/system/lib64/platformsdk/libuv.so+0x1ab30] [/system/lib64/platformsdk/libuv.so+0x1cbd0] [/system/lib64/module/file/libfs.z.so+0x17109c] [/system/lib64/module/file/libfs.z.so+0x170af4] [/system/lib64/module/file/libfs.z.so+0x1701c8] [/system/lib64/platformsdk/libace_napi.z.so+0x34828] </li><li>num 3968 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib64/platformsdk/libipc_core.z.so+0x4ac64] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x532d4] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x4f8fc] [/system/lib64/platformsdk/libipc_core.z.so+0x38420] [/system/lib64/platformsdk/libipc_core.z.so+0x4e99c] [/system/lib64/platformsdk/libipc_core.z.so+0x4eb34] [/system/lib64/platformsdk/libipc_core.z.so+0x4edc8] </li><li>num 3968 bt [/system/lib64/libfdleak_tracker.so+0x1fb58] [/system/lib/ld-musl-aarch64.so.1+0x1d3154] [/system/lib64/platformsdk/libipc_core.z.so+0x4ac64] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x532b0] [/system/lib64/platformsdk/libbackup_kit_inner.z.so+0x4f8fc] [/system/lib64/platformsdk/libipc_core.z.so+0x38420] [/system/lib64/platformsdk/libipc_core.z.so+0x4e99c] [/system/lib64/platformsdk/libipc_core.z.so+0x4eb34] [/system/lib64/platformsdk/libipc_core.z.so+0x4edc8] </li></ol></pre></div></div></li>     </ol>    </div>    <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content">      <ol>       <li>此处统计的是10分钟内全量申请句柄的调用栈，并没有将已经close的去掉；</li>       <li>栈信息只有在log版本直接存在，nolog版本若未开“开发者选项-系统资源泄漏日志”，则不抓取栈信息，如果发现不存在栈信息，可以打开开关抓取。</li>      </ol>     </div></div></div>    <div class="tiledSection">     <h2 id="section282262074411">线程泄漏分析方法<i class="anchor-icon anchor-icon-link" anchorid="section282262074411" tips="复制节点链接"></i></h2>          <p>检测到进程发生线程泄漏后，泄漏插件会落盘线程泄漏日志[[pid]_thread_leak.txt]以支撑开发者定位。</p>     <ol>      <li><span>泄漏日志中的“summary”字段记录了判定泄漏时进程内的线程个数，开发者可以通过当前线程数来判断当前进程的泄漏严重程度。</span>       <p></p>       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-css" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-selector-tag">summary</span>: XXXX</li></ol></pre></div></div>       <p></p></li>      <li><span>线程泄漏的详细信息中会按照线程名聚类，并列出top10的线程使用量、线程的启动时间等信息，支撑开发者识别定位。</span>       <p></p>       <ul>        <li>TOP10泄漏线程         <p>可初步定位泄漏时主要占用的线程名和对应的个数。</p>         <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python-repl" data-highlighted="yes"><ol class="linenums"><li>======================================================</li><li>tid    thread_name    start_time(jiffies)</li><li>221    process1    4688297</li><li>240    IPC_3_4318    3081382</li><li><span class="hljs-meta prompt_">...</span></li><li><span class="hljs-meta prompt_">...</span></li></ol></pre></div></div></li>       </ul>       <ul>        <li>线程启动信息         <div class="p">          线程的启动时间，用于和流水日志结合分析线程启动原因、场景等。          <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-python-repl" data-highlighted="yes"><ol class="linenums"><li>======================================================</li><li>tid    thread_name    start_time(jiffies)</li><li>221    process1    4688297</li><li>240    IPC_3_4318    3081382</li><li><span class="hljs-meta prompt_">...</span></li><li><span class="hljs-meta prompt_">...</span></li></ol></pre></div></div>         </div></li>       </ul>       <p></p></li>      <li><span>日志中包含采样时刻所有线程的线程快照，可基于快照信息判断线程当时所处的状态（如：等锁、__pthread_cond_timedwait表示线程正在等待唤醒等）。</span>       <p></p>       <div _ngcontent-gkc-c106="" class="highlight-div"><div _ngcontent-gkc-c106="" class="highlight-div-header"><div _ngcontent-gkc-c106="" class="highlight-div-header-left"><div _ngcontent-gkc-c106="" class="handle-button expand-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gkc-c106="" class="highlight-div-header-right"><div _ngcontent-gkc-c106="" class="handle-button ai-button"></div><div _ngcontent-gkc-c106="" class="handle-button line-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gkc-c106="" class="handle-button theme-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gkc-c106="" class="handle-button copy-button"><div _ngcontent-gkc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gkc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>======================================================</li><li><span class="hljs-variable">Result</span>: <span class="hljs-number">0</span> ( <span class="hljs-title class_">no</span> <span class="hljs-title class_">error</span> )</li><li><span class="hljs-variable">Timestamp</span>:<span class="hljs-number">2024</span>-<span class="hljs-number">06</span>-<span class="hljs-number">27</span> <span class="hljs-number">03</span>:<span class="hljs-number">45</span>:<span class="hljs-number">20.000</span></li><li><span class="hljs-variable">Pid</span>:<span class="hljs-number">41897</span></li><li><span class="hljs-variable">Uid</span>:<span class="hljs-number">1013</span></li><li><span class="hljs-variable">Process</span> <span class="hljs-variable">name</span>:<span class="hljs-title class_">process1</span></li><li><span class="hljs-variable">Tid</span>:<span class="hljs-number">1527</span>, <span class="hljs-variable">Name</span>:<span class="hljs-title class_">xxx</span></li><li>#<span class="hljs-number">00</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000001</span><span class="hljs-variable">b6464</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">__timedwait_cp</span>+<span class="hljs-number">192</span>)(<span class="hljs-number">98</span><span class="hljs-variable">dc7600a0fc62125e291b93ca336154</span>)</li><li>#<span class="hljs-number">01</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000001</span><span class="hljs-variable">b8468</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">__pthread_cond_timedwait</span>+<span class="hljs-number">188</span>)(<span class="hljs-number">98</span><span class="hljs-variable">dc7600a0fc62125e291b93ca336154</span>)</li><li>#<span class="hljs-number">02</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000000</span><span class="hljs-variable">c108c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">libc</span>++.<span class="hljs-title function_">so</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">condition_variable</span>::<span class="hljs-title class_">wait</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-variable">std</span>::<span class="hljs-variable">__h</span>::<span class="hljs-title class_">mutex</span>&gt;&amp;)+<span class="hljs-number">20</span>)(<span class="hljs-number">9</span><span class="hljs-variable">cbc937082b3d7412696099dd58f4f78242f9512</span>)</li><li>#<span class="hljs-number">03</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000024654</span><span class="hljs-variable">c</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">xxx</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">mindspore</span>::<span class="hljs-title class_">Worker</span>::<span class="hljs-title class_">WaitUntilActive</span>()+<span class="hljs-number">204</span>)(<span class="hljs-number">534</span><span class="hljs-variable">ce78b66262dc14658c35fa018662f</span>)</li><li>#<span class="hljs-number">04</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000023</span><span class="hljs-variable">da14</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">xxx</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">mindspore</span>::<span class="hljs-title class_">ActorWorker</span>::<span class="hljs-title class_">RunWithSpin</span>()+<span class="hljs-number">256</span>)(<span class="hljs-number">534</span><span class="hljs-variable">ce78b66262dc14658c35fa018662f</span>)</li><li>#<span class="hljs-number">05</span> <span class="hljs-variable">pc</span> <span class="hljs-number">000000000023</span><span class="hljs-variable">edb0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib64</span>/<span class="hljs-variable">platformsdk</span>/<span class="hljs-variable">xxx</span>.<span class="hljs-title function_">so</span>(<span class="hljs-variable">void</span>* <span class="hljs-variable">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">__thread_proxy</span>[<span class="hljs-title class_">abi</span>:<span class="hljs-title class_">v15004</span>]&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">tuple</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">unique_ptr</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">__thread_struct</span>, <span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">default_delete</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">__h</span>::<span class="hljs-title class_">__thread_struct</span>&gt;&gt;, <span class="hljs-title class_">void</span> (<span class="hljs-variable">mindspore</span>::<span class="hljs-variable">ActorWorker</span>::*)(), <span class="hljs-title class_">mindspore</span>::<span class="hljs-title class_">ActorWorker</span>*&gt;&gt;(<span class="hljs-variable">void</span>*)+<span class="hljs-number">60</span>)(<span class="hljs-number">534</span><span class="hljs-variable">ce78b66262dc14658c35fa018662f</span>)</li><li>#<span class="hljs-number">06</span> <span class="hljs-variable">pc</span> <span class="hljs-number">00000000001</span><span class="hljs-variable">baac0</span> /<span class="hljs-variable">system</span>/<span class="hljs-variable">lib</span>/<span class="hljs-variable">ld</span>-<span class="hljs-variable">musl</span>-<span class="hljs-variable">aarch64</span>.<span class="hljs-variable">so</span><span class="hljs-number">.1</span>(<span class="hljs-variable">start</span>+<span class="hljs-number">236</span>)(<span class="hljs-number">98</span><span class="hljs-variable">dc7600a0fc62125e291b93ca336154</span>)</li></ol></pre></div></div>       <p></p></li>     </ol>    </div>   </div>   <div></div></div>