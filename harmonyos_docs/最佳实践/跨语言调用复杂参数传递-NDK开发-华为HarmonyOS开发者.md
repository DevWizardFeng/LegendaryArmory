<h1 _ngcontent-gxa-c119="" class="doc-title ng-star-inserted" title="跨语言调用复杂参数传递"> 跨语言调用复杂参数传递 </h1>

<div _ngcontent-gxa-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1880095411114">概述<i class="anchor-icon anchor-icon-link" anchorid="section1880095411114" tips="复制节点链接"></i></h2><p>开发者为了提高程序运行效率，通常需要将一些运算量较大的内容放在C++环境中运行，因此经常需要进行ArkTS与C++之间的数据传递。本文以常见的五种数据类型：Array(uint8Array)、Object、HashMap、PixelMap、Class为例，向开发者介绍如何进行复杂参数的跨语言传递。</p> </div> <p>在开始介绍不同场景的开发流程之前，请注意，跨语言数据传递，需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/napi" target="_blank">Node-API</a>。因此，在新建项目后，请手动新建Native模块，方法如图所示:</p> <div class="fignone" id="fig08576372193"><a name="ZH-CN_TOPIC_0000002490707080__fig08576372193"></a><a name="fig08576372193"></a><span class="figcap"><b>图1 </b>新建Napi模块</span><br><span><img height="169.57500000000002" originheight="334" originwidth="1027" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.87519235888535781494976158673814:50001231000000:2800:766734D0A379D285B44B6BF09A1850C42A951A8A3713002119D0D3EDC0EA1E11.png" title="点击放大" width="523.6875"></span></div> <div class="tiledSection"><h2 id="section191511339373">场景案例<i class="anchor-icon anchor-icon-link" anchorid="section191511339373" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section9552193517193" class="firsth2">arrayBuffer类型数据交互<i class="anchor-icon anchor-icon-link" anchorid="section9552193517193" tips="复制节点链接"></i></h3><p>本章以简单的数组传递场景为例，在ArkTS侧输入一个Uint8Array数组，传递到C++侧，再构造另一个数组，并返回ArkTS侧。</p> <p>以此为例，介绍ArrayBuffer类型的数据如何相互传递使用。除数组外，string等连续数据类型也可参考本段。</p> <p><strong>实现原理</strong></p> <p>ArrayBuffer是一种用于表示通用的、固定长度的原始二进制数据缓冲区的对象。在C++侧接受该类型参数时一般会通过Node-API提供的函数（如napi_get_arraybuffer_info）获取到ArrayBuffer的数据指针和长度，从而可以访问和操作这些数据。</p> <p>从C++侧传递ArrayBuffer数据到ArkTS侧时，通常会在C++层创建出一个数据缓冲区（如std::vector&lt;uint8_t&gt;）并填充所需的数据。然后使用Node-API提供的函数（如napi_create_arraybuffer和napi_create_typedarray）在ArkTS侧创建一个新的ArrayBuffer对象，并将其与C++层的数据缓冲区关联起来。最后传递该对象到ArkTS侧。</p> <p><strong>开发步骤</strong></p> <ol><li>需要先在index.d.ts文件中，声明一个用于数据传递的函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L20-L20" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">uint8ArrayPassing</span>: <span class="hljs-function">(<span class="hljs-params">input: <span class="hljs-built_in">Uint8Array</span></span>) =&gt;</span> <span class="hljs-title class_">Uint8Array</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L20-L20" target="_blank">Index.d.ts</a></div></div></div></div> <div class="p">并在ArkTS文件中进行引用，如：<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/Uint8ArrayPage.ets#L17-L17" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">ParamPassing</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/Uint8ArrayPage.ets#L17-L17" target="_blank">Uint8ArrayPage.ets</a></div></div></div></div> </div> <p>使用时将Uint8Array类型的数据作为参数传入uint8ArrayPassing函数即可。</p> <div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/Uint8ArrayPage.ets#L49-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/Uint8ArrayPage.ets</span></li><li><span class="hljs-title function_">paramPassing</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">sendArray</span>: <span class="hljs-built_in">number</span>[] = [];</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">inputArray</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">inputField</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (inputField.<span class="hljs-property">inputStr</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Number</span>(inputField.<span class="hljs-property">inputStr</span>) &lt;= <span class="hljs-number">0xff</span>) {</li><li>          sendArray.<span class="hljs-title function_">push</span>(<span class="hljs-title class_">Number</span>(inputField.<span class="hljs-property">inputStr</span>));</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Invalid data type.'</span>);</li><li>        }</li><li>      }</li><li>    })</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">printStr</span> = <span class="hljs-string">`Array: [<span class="hljs-subst">${ParamPassing.uint8ArrayPassing(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Uint8Array</span>(sendArray))}</span>]`</span>;</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">printStr</span> = e?.<span class="hljs-property">message</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/Uint8ArrayPage.ets#L49-L66" target="_blank">Uint8ArrayPage.ets</a></div></div></div></div> </li><li>在C++工程中，定义数据传递函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L110-L115" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Uint8ArrayPassing</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    vector&lt;<span class="hljs-type">uint8_t</span>&gt; num_array = {};</li><li>    <span class="hljs-built_in">Uint8ArrayPassingTs2Napi</span>(env, info, num_array);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Uint8ArrayPassingNapi2Ts</span>(env, num_array);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L110-L115" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="p">其中uint8ArrayPassingTs2Napi与uint8ArrayPassingNapi2Ts分别负责数据从ArkTS至C++传递与反向传递。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L75-L106" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">Uint8ArrayPassingTs2Napi</span><span class="hljs-params">(napi_env env, napi_callback_info info, vector&lt;<span class="hljs-type">uint8_t</span>&gt; &amp;input_array)</span> </span>{</li><li>    <span class="hljs-comment">// Obtain parameters transmitted from the TS layer</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>    napi_value input_array_napi = args;</li><li>
</li><li>    <span class="hljs-comment">// Retrieve the input array typedarray and generate input_buffer</span></li><li>    napi_typedarray_type type;</li><li>    napi_value input_buffer;</li><li>    <span class="hljs-type">size_t</span> byte_offset;</li><li>    <span class="hljs-type">size_t</span> length;</li><li>    <span class="hljs-built_in">napi_get_typedarray_info</span>(env, input_array_napi, &amp;type, &amp;length, <span class="hljs-literal">NULL</span>, &amp;input_buffer, &amp;byte_offset);</li><li>
</li><li>    <span class="hljs-comment">// Retrieve array data</span></li><li>    <span class="hljs-type">void</span> *data;</li><li>    <span class="hljs-type">size_t</span> byte_length;</li><li>    <span class="hljs-built_in">napi_get_arraybuffer_info</span>(env, input_buffer, &amp;data, &amp;byte_length);</li><li>
</li><li>    <span class="hljs-keyword">if</span> (type == napi_uint8_array) {</li><li>        <span class="hljs-type">uint8_t</span> *data_bytes = (<span class="hljs-type">uint8_t</span> *)(data);</li><li>        <span class="hljs-type">int</span> num = length / <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint8_t</span>);</li><li>
</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num; i++) {</li><li>            input_array.<span class="hljs-built_in">push_back</span>(*((<span class="hljs-type">uint8_t</span> *)(data_bytes) + i));</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L75-L106" target="_blank">napi_init.cpp</a></div></div></div></div> </div> <p>在这段代码中，先用三个函数获取关键信息：</p> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>napi_get_typedarray_info：用于在Node-API模块中获得某个TypedArray的各种属性。</p> <p>napi_get_arraybuffer_info：获取ArrayBuffer的底层数据缓冲区和长度。</p> <p>之后，通过循环配合指针和偏移量，读取其中的数据，并将其存入inputArray中。</p> <div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L50-L71" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">Uint8ArrayPassingNapi2Ts</span><span class="hljs-params">(napi_env env, vector&lt;<span class="hljs-type">uint8_t</span>&gt; &amp;output_array)</span> </span>{</li><li>    <span class="hljs-comment">// Number of data</span></li><li>    <span class="hljs-type">int</span> num = output_array.<span class="hljs-built_in">size</span>();</li><li>
</li><li>    <span class="hljs-comment">// create output_buffer</span></li><li>    napi_value output_buffer;</li><li>    <span class="hljs-type">void</span> *output_ptr = <span class="hljs-literal">NULL</span>;</li><li>    <span class="hljs-built_in">napi_create_arraybuffer</span>(env, num * <span class="hljs-built_in">sizeof</span>(<span class="hljs-type">uint8_t</span>), &amp;output_ptr, &amp;output_buffer);</li><li>
</li><li>    <span class="hljs-comment">// output_array</span></li><li>    napi_value output_array_napi;</li><li>    <span class="hljs-built_in">napi_create_typedarray</span>(env, napi_uint8_array, num, output_buffer, <span class="hljs-number">0</span>, &amp;output_array_napi);</li><li>
</li><li>    <span class="hljs-comment">// Assign values to output_ptr and output_buffer</span></li><li>    <span class="hljs-type">uint8_t</span> *output_bytes = (<span class="hljs-type">uint8_t</span> *)output_ptr;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; num; i++) {</li><li>        output_bytes[i] = output_array[i];</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> output_array_napi;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L50-L71" target="_blank">napi_init.cpp</a></div></div></div></div> <p>在这段代码中，先用两个函数构建buffer和array：</p> <ul><li>napi_create_arraybuffer：负责构建buffer。</li><li>napi_create_typedarray：负责构建array。</li></ul> <p>之后，通过循环，将数据压入output_buffer，再返回output_array，即完成了uint8Array类型数据向ArkTS的传递。</p> </li><li>在Init函数中，实现ArkTS接口与C++接口的绑定和映射。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L362-L389" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    napi_property_descriptor desc[] = {</li><li>        {<span class="hljs-string">"uint8ArrayPassing"</span>, <span class="hljs-literal">nullptr</span>, uint8ArrayPassing, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>},</li><li>        <span class="hljs-comment">// ...</span></li><li>    };</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L362-L389" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.76515090883531876097956824640336:50001231000000:2800:24398A37E3FC503A01F1D46CC633313E8EC3011234602EABAE1EA796A60E8FFA.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section412816619212">object类型数据交互<i class="anchor-icon anchor-icon-link" anchorid="section412816619212" tips="复制节点链接"></i></h3><p>本章通过模拟一个“排号机”应用，向开发者介绍如何进行object数据类型的相互传递，以及如何解析、修改其中的数据。</p> <p><strong>实现原理</strong></p> <p>Object类是所有其他类型的基类。在C++侧接收该类型参数时一般会通过Node-API提供的函数（如napi_get_named_property）来获取object对象的某个属性，从而操作其属性值。</p> <p>从C++侧传递object类型到ArkTS侧时，可以利用Node-API封装好的接口（napi_create_object_with_named_properties）直接通过传递参数数组的方式构建出一个带有给定属性值的object类型对象。</p> <p><strong>开发步骤</strong></p> <ol><li>函数声明与调用，与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。<p>特别的，此处还需定义需要使用的object数据类型。</p> <div class="p">作为一个简单的“排号机”(比如医院中的)，需要年龄和姓名作为输入，并额外返回标志成人与否的布尔值和所排序号。因此，构造如下两种object，分别用于输入和输出。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/model/SampleObject.ts#L17-L28" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/model/SampleObject.ts</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">SampleInputObject</span> = {</li><li>  <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>;</li><li>}</li><li>
</li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">SampleOutputObject</span> = {</li><li>  <span class="hljs-variable">isAdult</span>: <span class="hljs-title class_">boolean</span>;</li><li>  <span class="hljs-variable">code</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">age</span>: <span class="hljs-title class_">number</span>;</li><li>  <span class="hljs-variable">name</span>: <span class="hljs-title class_">string</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/model/SampleObject.ts#L17-L28" target="_blank">SampleObject.ts</a></div></div></div></div> </div> </li><li>在C++工程中，定义数据传递函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L166-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li>static napi_value <span class="hljs-built_in">ObjectPassing</span>(napi_env env, napi_callback_info info) {</li><li>    return <span class="hljs-built_in">ObjectPassingNapi2Ts</span>(env, ObjectPassingTs2Napi(env, info));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L166-L169" target="_blank">napi_init.cpp</a></div></div></div></div> <div class="p">其中objectPassingTs2Napi与objectPassingNapi2Ts分别负责数据从ArkTS至C++传递与反向传递。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L119-L128" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">ObjectPassingTs2Napi</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// Obtain parameters transmitted from the TS layer</span></li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;args, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> args;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L119-L128" target="_blank">napi_init.cpp</a></div></div></div></div> </div> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L132-L162" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function">napi_value <span class="hljs-title">ObjectPassingNapi2Ts</span><span class="hljs-params">(napi_env env, napi_value inputObj)</span> </span>{</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> codeChild = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-type">static</span> <span class="hljs-type">int32_t</span> codeAdult = <span class="hljs-number">1</span>;</li><li>
</li><li>    napi_value input_age;</li><li>    napi_value input_name;</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, inputObj, <span class="hljs-string">"age"</span>, &amp;input_age);</li><li>    <span class="hljs-built_in">napi_get_named_property</span>(env, inputObj, <span class="hljs-string">"name"</span>, &amp;input_name);</li><li>
</li><li>    napi_value output_obj;</li><li>    napi_value output_is_adult;</li><li>    napi_value output_code;</li><li>    napi_value output_age = input_age;</li><li>    napi_value output_name = input_name;</li><li>    <span class="hljs-type">int32_t</span> age;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, input_age, &amp;age);</li><li>    <span class="hljs-built_in">napi_get_boolean</span>(env, age &gt;= <span class="hljs-number">18</span>, &amp;output_is_adult);</li><li>    <span class="hljs-keyword">if</span> (age &lt; <span class="hljs-number">18</span>) {</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, codeChild++, &amp;output_code);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">napi_create_int32</span>(env, codeAdult++, &amp;output_code);</li><li>    }</li><li>
</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *keysArray[] = {<span class="hljs-string">"isAdult"</span>, <span class="hljs-string">"code"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"name"</span>};</li><li>    <span class="hljs-type">const</span> napi_value outputArray[] = {output_is_adult, output_code, output_age, output_name};</li><li>
</li><li>    <span class="hljs-built_in">napi_create_object_with_named_properties</span>(env, &amp;output_obj, <span class="hljs-number">4</span>, keysArray, outputArray);</li><li>
</li><li>    <span class="hljs-keyword">return</span> output_obj;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L132-L162" target="_blank">napi_init.cpp</a></div></div></div></div> <p>napi_get_named_property：负责获取并储存inputObj中的属性。</p> <p>napi_get_value_int32：负责将获取到的inputAge属性解析为int32数据，并存入age中。</p> <p>napi_get_boolean：负责将需要返回的boolean属性写入对应的napi_value量中。</p> <p>napi_create_int32：负责将需要返回的int32属性写入对应的napi_value量中。</p> <p>napi_create_object_with_named_properties：负责构造需要返回的object。</p> </li><li>在DevEco Studio<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#fig08576372193">预生成</a>的Init函数中设置写好的数据传递函数。与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。</li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.99683065844222921521386871103060:50001231000000:2800:55157DA4C005096EF46C5C0A131E02F71696ACC248CBE38E7647CA5BE841A9B1.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section81062596218">hashMap类型数据交互<i class="anchor-icon anchor-icon-link" anchorid="section81062596218" tips="复制节点链接"></i></h3><p>本章通过模拟一个“积分累计”应用，每次输入对象的本次积分，并返回所有对象的累积积分。向开发者介绍如何进行hashMap数据类型的相互传递，以及如何解析、修改其中的数据。</p> <p><strong>实现原理</strong></p> <p>hashMap是一种基于哈希表的Map接口实现的数据结构。在C++侧接受该类型参数时，由于C++没有可以直接接收该类型参数的数据类型，所以一般采用两种方式进行传递。</p> <p>1.传递数组：分别将HashMap的key、value作为数组取出，然后将两个数组传递至C++侧并组装成Map进行数据处理。</p> <p>2.传递JSON：将HashMap转为Json字符串传递至C++侧，在C++侧通过反序列化的方式构造成Map类型数据进行处理。</p> <p>同样的，从C++侧传递Map类型到ArkTS侧时，需要将Map序列化成Json字符串传递到ArkTS，然后在ArkTS侧进行反序列化获取对应参数。</p> <p><strong>开发步骤</strong></p> <ol><li>函数声明与调用，与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。<p>此外，由于程序不支持直接传递hashMap类型，因此需要使用其他数据类型作为媒介。</p> <p>有两种主流方案：</p> <ol><li>通过JSON进行序列化和反序列化，以string类型为媒介；</li><li>将key和value拆成两个array，并以此为媒介。</li></ol> <p>本文以前者为例，后者可参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-ndk-67" target="_blank">如何实现ArkTS与C/C++的HashMap转换</a></p> <div class="p">同时，由于ArkTS中的JSON.stringify不支持直接将hashMap序列化，因此还需将hashMap先转换为Record，再序列化。方法如下：<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/HashMapPage.ets#L50-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-title function_">hashMap2Rec</span>(<span class="hljs-attr">map</span>: <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt;): <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-title class_">Rec</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = {}</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    map.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value: <span class="hljs-built_in">Object</span>, key: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// value may also be HashMap</span></li><li>      <span class="hljs-keyword">if</span> (value <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">HashMap</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">vRec</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">hashMap2Rec</span>(value);</li><li>        value = vRec;</li><li>      }</li><li>      <span class="hljs-title class_">Rec</span>[key] = value;</li><li>    })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`forEach fail. code = <span class="hljs-subst">${err.code}</span>, message = <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Rec</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/HashMapPage.ets#L50-L70" target="_blank">HashMapPage.ets</a></div></div></div></div> </div> <p>之后，将Record类型数据通过JSON.stringify序列化后即可传入C++侧。</p> </li><li>在C++工程中，定义数据传递函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L199-L201" data-highlighted="yes"><ol class="linenums"><li>static napi_value <span class="hljs-built_in">HashMapPassing</span>(napi_env env, napi_callback_info info) {</li><li>    return <span class="hljs-built_in">HashMapPassingNapi2Ts</span>(env, HashMapPassingTs2Napi(env, info));</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L199-L201" target="_blank">napi_init.cpp</a></div></div></div></div> <p>其中hashMapPassingNapi2Ts与hashMapPassingTs2Napi分别负责数据从ArkTS至C++传递与反向传递。同时，在C++侧，也需完成序列化和反序列化，本文采用nlohmann三方库完成此操作。</p> <div class="p">三方库获取：<a href="https://gitcode.net/openharmony/third_party_json" target="_blank">OpenHarmony / third_party_json · GitCode</a><div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L173-L181" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-title class_">map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">int</span>&gt; <span class="hljs-title function_">HashMapPassingTs2Napi</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, &amp;<span class="hljs-title class_">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nlohmann</span>::<span class="hljs-title class_">json</span>::<span class="hljs-title class_">parse</span>(<span class="hljs-title class_">Value2String</span>(<span class="hljs-title class_">env</span>, <span class="hljs-title class_">args</span>).<span class="hljs-title class_">c_str</span>());</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L173-L181" target="_blank">napi_init.cpp</a></div></div></div></div> </div> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>value2String：将napi_value数据解析为string的过程包装为一个函数，方便多次调用。</p> <p>nlohmann::json::parse：负责将string反序列化为map&lt;string, int&gt;类型数据。</p> <div class="p">其中，value2String函数需要开发者自己实现。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L24-L34" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">Value2String</span>(<span class="hljs-title class_">napi_env</span> <span class="hljs-title class_">env</span>, <span class="hljs-title class_">napi_value</span> <span class="hljs-title class_">value</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">string_size</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// Get string length</span></li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-number">0</span>, &amp;<span class="hljs-title class_">string_size</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">result_string</span>;</li><li>    <span class="hljs-variable">result_string</span>.<span class="hljs-title function_">resize</span>(<span class="hljs-variable">string_size</span> + <span class="hljs-number">1</span>);</li><li>    <span class="hljs-comment">// Convert to string based on length</span></li><li>    <span class="hljs-title function_">napi_get_value_string_utf8</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>, &amp;<span class="hljs-title class_">result_string</span>[<span class="hljs-number">0</span>], <span class="hljs-variable">string_size</span> + <span class="hljs-number">1</span>, &amp;<span class="hljs-title class_">string_size</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">result_string</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L24-L34" target="_blank">napi_init.cpp</a></div></div></div></div> </div> <div class="p">napi_get_value_string_utf8：负责将napi_value数据解析为string。<div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>此处stringSize需要+1，这是因为napi_value是一个C的结构体指针，C语言的字符串实际上是使用空字符 \0 结尾的一维字符数组。而napi_get_value_string_utf8返回的stringSize，其长度不含结尾的\0。为了保证写入valueString的内容包含结尾的\0，所以需要+1。</p> </div></div></div> </div> <div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L185-L195" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-variable">napi_value</span> <span class="hljs-title function_">HashMapPassingNapi2Ts</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-title class_">map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">int</span>&gt; <span class="hljs-variable">inputMap</span>) {</li><li>    <span class="hljs-keyword">static</span> <span class="hljs-title class_">map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">int</span>&gt; <span class="hljs-variable">points_table</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">map</span>&lt;<span class="hljs-title class_">string</span>, <span class="hljs-title class_">int</span>&gt;::<span class="hljs-title class_">iterator</span> <span class="hljs-title class_">iter</span>;</li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-variable">iter</span> = <span class="hljs-variable">inputMap</span>.<span class="hljs-title function_">begin</span>(); <span class="hljs-variable">iter</span> != <span class="hljs-variable">inputMap</span>.<span class="hljs-title function_">end</span>(); ++<span class="hljs-variable">iter</span>) {</li><li>        <span class="hljs-variable">points_table</span>[<span class="hljs-variable">iter</span>-&gt;<span class="hljs-title class_">first</span>] += <span class="hljs-variable">iter</span>-&gt;<span class="hljs-title class_">second</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-variable">string</span> <span class="hljs-variable">dump_string</span> = <span class="hljs-variable">nlohmann</span>::<span class="hljs-title class_">ordered_json</span>(<span class="hljs-title class_">points_table</span>).<span class="hljs-title class_">dump</span>();</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">String2value</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">dump_string</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L185-L195" target="_blank">napi_init.cpp</a></div></div></div></div> <p>nlohmann::ordered_json：负责将map序列化。</p> <p>dump：负责将序列化后的数据转换为string类型。</p> <p>string2value：将string转换为napi_value的过程包装为一个函数，方便多次调用。</p> <div class="p">其中，string2value也需要开发者自己实现。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L38-L46" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-keyword">static</span> napi_value <span class="hljs-title">String2value</span>(<span class="hljs-params">napi_env env, <span class="hljs-built_in">string</span> str</span>)</span> {</li><li>    <span class="hljs-built_in">int</span> length = str.length();</li><li>
</li><li>    napi_value output_string;</li><li>    napi_create_string_utf8(env, str.c_str(), length, &amp;output_string);</li><li>
</li><li>    <span class="hljs-keyword">return</span> output_string;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L38-L46" target="_blank">napi_init.cpp</a></div></div></div></div> </div> <p>napi_create_string_utf8：负责将string类型数据转换为napi_value类型。</p> </li><li>需在DevEco Studio<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#fig08576372193">预生成</a>的Init函数中设置写好的数据传递函数。与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。</li><li>将C++侧返回的string重新反序列化为hashMap。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/HashMapPage.ets#L87-L92" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/HashMapPage.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">receiveObj</span>: <span class="hljs-built_in">object</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(receiveStr);</li><li><span class="hljs-keyword">let</span> <span class="hljs-attr">receiveMap</span>: <span class="hljs-title class_">HashMap</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>();</li><li><span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(receiveObj).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">value: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>]</span>) =&gt;</span> {</li><li>  receiveMap.<span class="hljs-title function_">set</span>(value[<span class="hljs-number">0</span>], value[<span class="hljs-number">1</span>]);</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/HashMapPage.ets#L87-L92" target="_blank">HashMapPage.ets</a></div></div></div></div> <p>JSON.parse：此函数只能将string反序列化为object，因此还需额外一步将其转换为hashMap类型。</p> </li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.29521872101971900606640275394743:50001231000000:2800:3AE89DE824448B38FDD5A2D51D89762951D2E86127B666FF0C66018658428337.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section198219119221">pixelMap类型数据交互<i class="anchor-icon anchor-icon-link" anchorid="section198219119221" tips="复制节点链接"></i></h3><p>本章以图片处理应用为例，介绍如何进行pixelMap类型数据交互。</p> <p>除本文介绍的方法外，也可通过readPixelsToBuffer将其转换为Uint8Array类型，进行处理。此方案可以参考<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>，本文不作介绍。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在进行应用开发之前，开发者需要打开native工程的src/main/cpp/CMakeLists.txt，在target_link_libraries依赖中添加image的libpixelmap_ndk.z.so</p> <div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-swift" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/CMakeLists.txt#L20-L21" data-highlighted="yes"><ol class="linenums"><li># entry<span class="hljs-regexp">/src/</span>main<span class="hljs-regexp">/cpp/</span><span class="hljs-type">CMakeLists</span>.txt</li><li>target_link_libraries(entry <span class="hljs-type">PUBLIC</span> libace_napi.z.so libhilog_ndk.z.so libpixelmap_ndk.z.so)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/CMakeLists.txt#L20-L21" target="_blank">CMakeLists.txt</a></div></div></div></div> </div></div></div> <p><strong>实现原理</strong></p> <p>PixelMap是一种用于显示图像的数据结构。在C++侧接收该类型参数的时候，可以直接调用libpixelmap.so库中的函数直接通过ArkTS侧的pixelmap对象构造出Native侧的pixelmap类型对象（NativePixelMap），进而对其进行数据处理。</p> <p>由于pixelMap类似一个C++语言中的指针，通过上述操作之后更改了其指向的内容，因此在ArkTS侧通过设定延迟可以直接触发ArkTS侧的图像自渲染，从而实现ArkTS页面刷新，直接显示修改后的图像。</p> <p><strong>开发步骤</strong></p> <ol><li>函数声明与调用，与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。</li><li>在ArkTS侧，需要先完成图片的加载和pixelMap化。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L37-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/PixelMapPage.ets</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">loadPixelMap</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">let</span> resourceManager = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()!.<span class="hljs-property">resourceManager</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> imageArray = <span class="hljs-keyword">await</span> resourceManager.<span class="hljs-title function_">getMediaContent</span>($r(<span class="hljs-string">'app.media.SampleImage'</span>).<span class="hljs-property">id</span>);</li><li>    <span class="hljs-keyword">let</span> imageResource = image.<span class="hljs-title function_">createImageSource</span>(imageArray.<span class="hljs-property">buffer</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">opts</span>: image.<span class="hljs-property">DecodingOptions</span> = { <span class="hljs-attr">editable</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">desiredPixelFormat</span>: image.<span class="hljs-property">PixelMapFormat</span>.<span class="hljs-property">BGRA_8888</span> };</li><li>    imageResource.<span class="hljs-title function_">createPixelMap</span>(opts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">pixelMap</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">pixelMap</span> = pixelMap;</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loadComplete</span> = <span class="hljs-literal">true</span>;</li><li>    })</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">`getMediaContent fail. code = <span class="hljs-subst">${err.code}</span>, message = <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">loadPixelMap</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L37-L57" target="_blank">PixelMapPage.ets</a></div></div></div></div> <p>createPixelMap：负责将从imageResource加载的图片解码为pixelMap格式。</p> </li><li>在C++工程中，定义数据传递函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L205-L221" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">PixelMapPassing</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value ts_pixel_map;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, &amp;ts_pixel_map, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// Initialize the NativePixelMap object.</span></li><li>    <span class="hljs-comment">// NativePixelMap and ArkTSPixelMap share memory space.</span></li><li>    <span class="hljs-comment">// That is, modifications to NativePixelMap also affect ArkTSPixelMap.</span></li><li>    NativePixelMap *native_pixel_map = <span class="hljs-built_in">OH_PixelMap_InitNativePixelMap</span>(env, ts_pixel_map);</li><li>
</li><li>    <span class="hljs-type">float</span> opacity = <span class="hljs-number">0.5</span>;</li><li>    <span class="hljs-built_in">OH_PixelMap_SetOpacity</span>(native_pixel_map, opacity);</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L205-L221" target="_blank">napi_init.cpp</a></div></div></div></div> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>OH_PixelMap_InitNativePixelMap：负责初始化NativePixelMap对象。</p> <p>OH_PixelMap_SetOpacity：负责修改NativePixelMap中的不透明度。</p> <p>其他诸如旋转、缩放等操作可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/image-pixelmap-operation-native" target="_blank">位图操作（使用Image处理PixelMap数据）</a>。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>输入的TSPixelMap与生成的NativePixelMap共享内存空间，因此直接调用相关方法修改NativePixelMap对象，即可同步影响TSPixelMap对象。所以此处无需回传数据。</p> </div></div></div> </li><li>在Init函数中的设置流程与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>相同，不再赘述。</li><li>在ArkTS中令Image组件重新渲染。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L63-L70" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/PixelMapPage.ets</span></li><li>if (this.loadComplete) {</li><li>  <span class="hljs-built_in">Image</span>(this.pixelMap)</li><li>    <span class="hljs-selector-class">.height</span>(<span class="hljs-number">400</span>)</li><li>} else {</li><li>  <span class="hljs-built_in">Image</span>($r('app.media.loading'))</li><li>    <span class="hljs-selector-class">.height</span>(<span class="hljs-number">400</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L63-L70" target="_blank">PixelMapPage.ets</a></div></div></div></div> <div class="p">如上所示，通过更改this.loadComplete即可完成Image的重新渲染。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L76-L83" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/PixelMapPage.ets</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pixelMap) {</li><li>  <span class="hljs-keyword">this</span>.loadComplete = <span class="hljs-literal">false</span>;</li><li>  ParamPassing.pixelMapPassing(<span class="hljs-keyword">this</span>.pixelMap);</li><li>  <span class="hljs-comment">// Only modifying PixelMap cannot cause the system to re render,</span></li><li>  <span class="hljs-comment">// so this method is required to manually refresh the image component.</span></li><li>  setTimeout(() =&gt; <span class="hljs-keyword">this</span>.loadComplete = <span class="hljs-literal">true</span>, <span class="hljs-number">500</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/PixelMapPage.ets#L76-L83" target="_blank">PixelMapPage.ets</a></div></div></div></div> </div> <p>这是因为pixelMap类似一个C语言指针，只更改其指向的内容，其本身值未变，不会引发自动重渲染。此处设定的延迟也是为了确保重渲染可以触发。</p> </li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.51555629402751181551529872371532:50001231000000:2800:EFAFF6AE5D3451B970880AF30B07B1099E6174D58A0D65C71B97DB8506EA6A35.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section1521193811224">class类型数据，ArkTS传递至C++<i class="anchor-icon anchor-icon-link" anchorid="section1521193811224" tips="复制节点链接"></i></h3><p>本章以简单的计算器为例，介绍如何进行class类型数据交互。由于两侧传递方式差异较大，因此分为两章讲解。</p> <p>本章讲解ArkTS传递至C++。</p> <p><strong>实现原理</strong></p> <p>ArkTS语言中，class（类）是用于定义对象的模板，并拥有特有的属性和方法。在C++侧接收该类型时与object类型基本一致，一般会通过Node-API提供的函数（如napi_get_named_property）来获取class对象的某个属性，从而操作其属性值。</p> <p><strong>开发步骤</strong></p> <ol><li>在index.d.ts中声明需要传递的class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L30-L35" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/Index.d.ts</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">SampleClassTs2Napi</span> {</li><li>  <span class="hljs-variable">result</span>: <span class="hljs-title class_">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">add</span>(<span class="hljs-variable">a</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">b</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">string</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L30-L35" target="_blank">Index.d.ts</a></div></div></div></div> <div class="p">声明传递用的函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L52-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-attr">classPassingTs2Napi</span>: <span class="hljs-function">(<span class="hljs-params">input: SampleClassTs2Napi</span>) =&gt;</span> <span class="hljs-built_in">string</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L52-L53" target="_blank">Index.d.ts</a></div></div></div></div> </div> <div class="p">ArkTS文件中也需要对此进行引用，并实现上文声明的class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/ClassPage.ets#L17-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/ClassPage.ets</span></li><li><span class="hljs-keyword">import</span> <span class="hljs-title class_">ParamPassing</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'libentry.so'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">OutputArea</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../model/IOModel'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-attr">HINT_STRING</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'Calculation completed:\n'</span>;</li><li>
</li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleClassTs2Napi</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ParamPassing</span>.<span class="hljs-property">SampleClassTs2Napi</span> {</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-attr">result</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>
</li><li>  <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">result</span> = <span class="hljs-string">`<span class="hljs-subst">${a}</span> + <span class="hljs-subst">${b}</span> = <span class="hljs-subst">${a + b}</span>`</span>;</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable constant_">HINT_STRING</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/ClassPage.ets#L17-L30" target="_blank">ClassPage.ets</a></div></div></div></div> </div> </li><li>在C++工程中，定义数据传递函数。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L225-L252" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-variable">napi_value</span> <span class="hljs-title function_">ClassPassingTs2Napi</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">args</span>;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, &amp;<span class="hljs-title class_">args</span>, <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-comment">// Retrieve the method named "add" from the parameter object and store it in the "add" variable.</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">add</span>;</li><li>    <span class="hljs-title function_">napi_get_named_property</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>, <span class="hljs-string">"add"</span>, &amp;<span class="hljs-title class_">add</span>);</li><li>
</li><li>    <span class="hljs-comment">// Create parameter array</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">arr</span>[<span class="hljs-number">2</span>];</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">114</span>, &amp;<span class="hljs-title class_">arr</span>[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-title function_">napi_create_int32</span>(<span class="hljs-variable">env</span>, <span class="hljs-number">514</span>, &amp;<span class="hljs-title class_">arr</span>[<span class="hljs-number">1</span>]);</li><li>    <span class="hljs-comment">// Call the "add" method of the parameter object, pass this array as a parameter,</span></li><li>    <span class="hljs-comment">// and store the result in the funcResult variable.</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">func_result</span>;</li><li>    <span class="hljs-title function_">napi_call_function</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>, <span class="hljs-variable">add</span>, <span class="hljs-number">2</span>, <span class="hljs-variable">arr</span>, &amp;<span class="hljs-title class_">func_result</span>);</li><li>
</li><li>    <span class="hljs-comment">// Retrieve the property values named "result" from the parameter object</span></li><li>    <span class="hljs-comment">// using the napi_get_named_property function, and store them in the param_result variables.</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">param_result</span>;</li><li>    <span class="hljs-title function_">napi_get_named_property</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">args</span>, <span class="hljs-string">"result"</span>, &amp;<span class="hljs-title class_">param_result</span>);</li><li>
</li><li>    <span class="hljs-variable">string</span> <span class="hljs-variable">resultStr</span> = <span class="hljs-title function_">Value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">func_result</span>) + <span class="hljs-title function_">Value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">param_result</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-title function_">String2value</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">resultStr</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L225-L252" target="_blank">napi_init.cpp</a></div></div></div></div> <p>classPassingTs2Napi：负责将class从ArkTS传递至Napi，之后返回一个string作为结果。</p> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>napi_get_named_property：第一次调用，负责将方法名为"add"的方法存入变量add中。</p> <p>napi_create_int32：负责将入参解析为int32，并存入数组arr中。</p> <p>napi_call_function：负责在C++工程中调用从ArkTS传入的class的方法，需要使用上两步获得的入参数组arr和方法add。</p> <p>napi_get_named_property：第二次调用，负责将名为"result"的属性存入param_result中。</p> <p>value2String、string2value：负责napi_value与string类型之间的相互转换，实现方法详见<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section81062596218">hashMap类型数据交互</a>。</p> </li><li>需在DevEco Studio<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#fig08576372193">预生成</a>的Init函数中设置写好的数据传递函数。与<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section9552193517193">arrayBuffer类型数据交互</a>类同，此处不再赘述。</li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.14641784997657304121516717055353:50001231000000:2800:F4D1B6226B5E673F45713ED8E7CAA5176EE99621A0893E80A6F1E7AAD02E7A19.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h3 id="section136595212132">class类型数据，C++传递至ArkTS<i class="anchor-icon anchor-icon-link" anchorid="section136595212132" tips="复制节点链接"></i></h3><p>本章仍以简单的计算器为例，介绍class类型数据如何从C++传递至ArkTS。</p> <p><strong>实现原理</strong></p> <p>从C++侧传递class类型到ArkTS侧时，需要在C++侧对C++类方法进行Napi适配，然后在init函数中通过napi_define_class建立ArkTS类方法与C++侧方法的映射关系，然后将对应的class对象挂载到export上导出。注意：需要在index.d.ts文件中声明需要传递的class。</p> <p><strong>开发步骤</strong></p> <ol><li>需要在index.d.ts中声明需要传递的class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L39-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/cpp/types/libentry/Index.d.ts</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleClassNapi2Ts</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">_hintStr</span>: <span class="hljs-built_in">string</span>;</li><li>
</li><li>  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">hintStr: <span class="hljs-built_in">string</span></span>);</li><li>
</li><li>  <span class="hljs-title function_">times</span>(<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span>;</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">get</span> <span class="hljs-title function_">hintStr</span>();</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">set</span> <span class="hljs-title function_">hintStr</span>(<span class="hljs-params">value:<span class="hljs-built_in">string</span></span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/types/libentry/Index.d.ts#L39-L48" target="_blank">Index.d.ts</a></div></div></div></div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>此处需要使用get和set关键字定义访问器，不能直接引用、修改属性。</p> </div></div></div> </li><li>在ArkTS侧调用该class及其属性、方法。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/ClassPage.ets#L63-L66" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/pages/ClassPage.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">napiClass</span>: <span class="hljs-title class_">ParamPassing</span>.<span class="hljs-title class_">SampleClassNapi2Ts</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">ParamPassing</span>.<span class="hljs-title function_">SampleClassNapi2Ts</span>(<span class="hljs-variable">HINT_STRING</span>);</li><li><span class="hljs-variable">napiClass</span>.<span class="hljs-variable">hintStr</span> += <span class="hljs-string">'modify by ArkTS: \n'</span>;</li><li><span class="hljs-keyword">this</span>.<span class="hljs-variable">printStr</span> = <span class="hljs-variable">napiClass</span>.<span class="hljs-variable">hintStr</span> + <span class="hljs-variable">napiClass</span>.<span class="hljs-title function_">times</span>(<span class="hljs-number">6</span>, <span class="hljs-number">9</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/ets/pages/ClassPage.ets#L63-L66" target="_blank">ClassPage.ets</a></div></div></div></div> <p>在调用时，用法与其他寻常的ArkTS的class一样。无需特别注意。</p> </li><li>在C++工程中，定义对应的class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L256-L266" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">SampleClassNapi2Ts</span> {</li><li><span class="hljs-keyword">public</span>:</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">hint_str</span>;</li><li>    <span class="hljs-title function_">SampleClassNapi2Ts</span>(<span class="hljs-variable">string</span> <span class="hljs-variable">str</span>) { <span class="hljs-keyword">this</span>-&gt;<span class="hljs-title class_">hint_str</span> = <span class="hljs-variable">str</span>; };</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">string</span> <span class="hljs-title class_">times</span>(<span class="hljs-title class_">int</span> <span class="hljs-title class_">a</span>, <span class="hljs-title class_">int</span> <span class="hljs-title class_">b</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">ostringstream</span> <span class="hljs-title class_">ost</span>;</li><li>        <span class="hljs-variable">ost</span> &lt;&lt; <span class="hljs-variable">a</span> &lt;&lt; <span class="hljs-string">" × "</span> &lt;&lt; <span class="hljs-variable">b</span> &lt;&lt; <span class="hljs-string">" = "</span> &lt;&lt; <span class="hljs-variable">a</span> * <span class="hljs-variable">b</span>;</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">ost</span>.<span class="hljs-title function_">str</span>();</li><li>    };</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L256-L266" target="_blank">napi_init.cpp</a></div></div></div></div> <p>此处使用ostringstream输出流，以便完成字符串的构造。因此需要提前导入stream。</p> <p>同时，还需依次完成供ArkTS调用的访问器、构造函数和方法。</p> <ol><li>getHintStr，用于获取hintStr属性。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L298-L312" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">GetHintStr</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    napi_value ts_class_obj;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, &amp;ts_class_obj, <span class="hljs-literal">nullptr</span>);</li><li>
</li><li>    SampleClassNapi2Ts *c_class_obj;</li><li>    <span class="hljs-comment">// Retrieve and manipulate the C++object previously bound to jsThis using napi_unwrap</span></li><li>    <span class="hljs-built_in">napi_unwrap</span>(env, ts_class_obj, <span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">void</span> **&gt;(&amp;c_class_obj));</li><li>    <span class="hljs-keyword">if</span> (c_class_obj) {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">String2value</span>(env, c_class_obj-&gt;hint_str);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L298-L312" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol> <p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>napi_unwrap：负责解析ArkTS class中包装的C++ class，并使用指针c_class_obj进行储存。</p> <p>string2value：负责将obj-&gt;hintStr转换为napi_value，作为输出。此函数的实现方法详见<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section81062596218">hashMap类型数据交互</a>。</p> <p>ArkTS侧调用hintStr的值的时候，需要调用此函数，从而获得C++侧的hintStr的值。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>初始化阶段的访问器，napi_unwrap后获得的c_class_obj可能为空指针，所以必须验空。下同。</p> </div></div></div> <ol start="2"><li>setHintStr，用于设置hintStr属性。原理与getHintStr相通。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L316-L334" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">SetHintStr</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-comment">// Obtain parameters transmitted from the TS layer</span></li><li>    <span class="hljs-variable">size_t</span> <span class="hljs-variable">argc</span> = <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">value</span>;</li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">ts_class_obj</span>;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-title function_">napi_get_cb_info</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">info</span>, &amp;<span class="hljs-title class_">argc</span>, &amp;<span class="hljs-title class_">value</span>, &amp;<span class="hljs-title class_">ts_class_obj</span>, <span class="hljs-variable">nullptr</span>);</li><li>
</li><li>    <span class="hljs-variable">SampleClassNapi2Ts</span> *<span class="hljs-variable">c_class_obj</span>;</li><li>    <span class="hljs-comment">// Retrieve and manipulate the C++object previously bound to jsThis using napi_unwrap</span></li><li>    <span class="hljs-title function_">napi_unwrap</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">ts_class_obj</span>, <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-title class_">void</span> **&gt;(&amp;<span class="hljs-title class_">c_class_obj</span>));</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">c_class_obj</span>) {</li><li>        <span class="hljs-variable">c_class_obj</span>-&gt;<span class="hljs-title class_">hint_str</span> = <span class="hljs-title function_">Value2String</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">value</span>);</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">nullptr</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L316-L334" target="_blank">napi_init.cpp</a></div></div></div></div> </li></ol><ol start="3"><li>实现times方法，为加区分，此处命名为TSTimes。<p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>napi_unwrap：负责将传入的ArkTS class解包，获取与其绑定的C++ class，并使用指针c_class_obj进行储存。</p> <p>napi_get_value_int32：负责将入参解析为int32并存入value0/value1中。</p> <div class="p">string2Value：负责将string转换为napi_value数据。此函数的实现方法详见<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section81062596218">hashMap类型数据交互</a>。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L338-L355" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TSTimes</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">2</span>;</li><li>    napi_value args[<span class="hljs-number">2</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    napi_value ts_class_obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;ts_class_obj, <span class="hljs-literal">nullptr</span>);</li><li>    SampleClassNapi2Ts *c_class_obj = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-comment">// Convert ArkTS object to C++ object</span></li><li>    <span class="hljs-built_in">napi_unwrap</span>(env, ts_class_obj, (<span class="hljs-type">void</span> **)&amp;c_class_obj);</li><li>    <span class="hljs-comment">// Get parameters passed by ArkTS</span></li><li>    <span class="hljs-type">int</span> value0;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">0</span>], &amp;value0);</li><li>    <span class="hljs-type">int</span> value1;</li><li>    <span class="hljs-built_in">napi_get_value_int32</span>(env, args[<span class="hljs-number">1</span>], &amp;value1);</li><li>    string c_result = c_class_obj-&gt;<span class="hljs-built_in">times</span>(value0, value1);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">String2value</span>(env, c_result);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L338-L355" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li></ol><ol start="4"><li>TsConstructor，用于构造ArkTS class。<p>napi_get_cb_info：负责从ArkTS侧获取输入参数。</p> <p>value2String：负责将入参转换为string。此函数的实现方法详见<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#section81062596218">hashMap类型数据交互</a>。</p> <p>napi_set_named_property：负责对指定的object加入一个新属性，并指定属性名。ArkTS侧调用的时候，将使用此处指定的名称。</p> <div class="p">napi_wrap：负责将C++ class包装为ArkTS class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L270-L294" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">TsConstructor</span><span class="hljs-params">(napi_env env, napi_callback_info info)</span> </span>{</li><li>    <span class="hljs-comment">// Create Napi object</span></li><li>    napi_value ts_class_obj;</li><li>    <span class="hljs-type">size_t</span> argc = <span class="hljs-number">1</span>;</li><li>    napi_value args[<span class="hljs-number">1</span>] = {<span class="hljs-literal">nullptr</span>};</li><li>    <span class="hljs-comment">// Gets detailed information about the function call, such as input parameters.</span></li><li>    <span class="hljs-built_in">napi_get_cb_info</span>(env, info, &amp;argc, args, &amp;ts_class_obj, <span class="hljs-literal">nullptr</span>);</li><li>    string hint_str = <span class="hljs-built_in">Value2String</span>(env, args[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-comment">// Create C++ object</span></li><li>    SampleClassNapi2Ts *c_class_obj = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SampleClassNapi2Ts</span>(hint_str);</li><li>    <span class="hljs-comment">// Set the JS object hintStr attribute</span></li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, ts_class_obj, <span class="hljs-string">"hintStr"</span>, args[<span class="hljs-number">0</span>]);</li><li>    <span class="hljs-comment">// Binding JS objects with C++objects</span></li><li>    <span class="hljs-built_in">napi_wrap</span>(</li><li>        env, ts_class_obj, c_class_obj,</li><li>        <span class="hljs-comment">// Define callback function for recycling JS objects, used to destroy C++objects and prevent memory leaks</span></li><li>        [](napi_env env, <span class="hljs-type">void</span> *finalize_data, <span class="hljs-type">void</span> *finalize_hint) {</li><li>            SampleClassNapi2Ts *c_class_obj = (SampleClassNapi2Ts *)finalize_data;</li><li>            <span class="hljs-keyword">delete</span> c_class_obj;</li><li>            c_class_obj = <span class="hljs-literal">nullptr</span>;</li><li>        },</li><li>        <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);</li><li>    <span class="hljs-keyword">return</span> ts_class_obj;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L270-L294" target="_blank">napi_init.cpp</a></div></div></div></div> </div> </li></ol> </li><li>在Init函数中设置class。<div class="screenLinkPre"><div _ngcontent-gxa-c106="" class="highlight-div"><div _ngcontent-gxa-c106="" class="highlight-div-header"><div _ngcontent-gxa-c106="" class="highlight-div-header-left"><div _ngcontent-gxa-c106="" class="handle-button expand-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-gxa-c106="" class="highlight-div-header-right"><div _ngcontent-gxa-c106="" class="handle-button ai-button"></div><div _ngcontent-gxa-c106="" class="handle-button line-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-gxa-c106="" class="handle-button theme-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-gxa-c106="" class="handle-button copy-button"><div _ngcontent-gxa-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-gxa-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L359-L391" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry\src\main\cpp\napi_init.cpp</span></li><li><span class="hljs-function">EXTERN_C_START</span></li><li><span class="hljs-function"><span class="hljs-type">static</span> napi_value <span class="hljs-title">Init</span><span class="hljs-params">(napi_env env, napi_value exports)</span> </span>{</li><li>    <span class="hljs-comment">// ...</span></li><li>    napi_property_descriptor class_prop[] = {</li><li>        {<span class="hljs-string">"hintStr"</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, GetHintStr, SetHintStr, <span class="hljs-number">0</span>, napi_default, <span class="hljs-number">0</span>},</li><li>        {<span class="hljs-string">"times"</span>, <span class="hljs-literal">nullptr</span>, TSTimes, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>, napi_default, <span class="hljs-literal">nullptr</span>}};</li><li>    napi_value sample_class = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *class_name = <span class="hljs-string">"SampleClassNapi2Ts"</span>;</li><li>    <span class="hljs-comment">// Establish the association between ArkTS constructor and C++ methods</span></li><li>    <span class="hljs-built_in">napi_define_class</span>(env, class_name, <span class="hljs-built_in">sizeof</span>(class_name), TsConstructor, <span class="hljs-literal">nullptr</span>,</li><li>                      <span class="hljs-built_in">sizeof</span>(class_prop) / <span class="hljs-built_in">sizeof</span>(class_prop[<span class="hljs-number">0</span>]), class_prop, &amp;sample_class);</li><li>    <span class="hljs-built_in">napi_set_named_property</span>(env, exports, class_name, sample_class);</li><li>
</li><li>    <span class="hljs-keyword">return</span> exports;</li><li>}</li><li>EXTERN_C_END</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/ComplexTypePass/blob/master/entry/src/main/cpp/napi_init.cpp#L359-L391" target="_blank">napi_init.cpp</a></div></div></div></div> <p>需要先在DevEco Studio<a href="/consumer/cn/doc/best-practices/bpta-complex-type-pass#fig08576372193">预生成</a>的Init函数中，定义一个classProp，并写入class对应的访问器与方法</p> <p>并调用napi_define_class和napi_set_named_property完成ArkTS class 与C++ class的关联与设置。从而令ArkTS可以调用C++中的class。</p> </li></ol> </div> <p><strong>实现效果</strong></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163056.99281502106772511460257373452277:50001231000000:2800:D8FE6A6DB9B8A075B7C8EE4F24906B4D578397897A7BCC9816AA8E65C12A95A0.png" title="点击放大" width="266"></span></p> <div class="tiledSection"><h2 id="section147971528122310">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section147971528122310" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/ComplexTypePass" target="_blank">实现复杂参数的跨语言交互功能</a></li></ul> </div> </div></div>