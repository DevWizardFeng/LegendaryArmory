<h1 _ngcontent-ebe-c119="" class="doc-title ng-star-inserted" title="适配常见问题"> 适配常见问题 </h1>

<div _ngcontent-ebe-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section816313183312">HWASan napi int64转换时存在精度丢失<i class="anchor-icon anchor-icon-link" anchorid="section816313183312" tips="复制节点链接"></i></h2><p>由于TS语言的语法限制，Number类型的数字使用双精度浮点数表示，只能精确表示范围是[-(2^53 - 1), (2^53 - 1)]的数字，也就是54位二进制。一个64位的地址，有效寻址空间只有低40位。在未开启HWASan时，地址高24位为0，因此可以用Number来表示精确的地址。在开启HWASan后，会在地址的高8位打上随机Tag，最后的地址是一个高8位为Tag，低40位为真实地址的64位数，此时再使用双精度来存储该64位地址，会导致精度丢失，使低40位真实地址发生偏移，并由HWASan检测出地址越界的问题。</p> <p>Napi中，使用napi_create_int64来将一个64位数转换成TypeScript中的Number类型，精度丢失发生在这里；使用三方库aki进行隐式的转换，底层也调用该接口，因此也会存在精度丢失的情况；</p> <p>要避免这种情况，请在TS侧使用bigint存储超出Number精度的地址。需要配套更换Napi中的转换和接收接口为napi_create_bigint_int64和napi_get_value_bigint_int64，参考API文档。</p> </div> <div class="tiledSection"><h2 id="section099848173314">应用实现了一套类似HWASan的内存检查机制或使用tag作为类型标记来实现了name box机制，和HWASan产生冲突<i class="anchor-icon anchor-icon-link" anchorid="section099848173314" tips="复制节点链接"></i></h2><p>HWASan使用了地址的高8位来存储Tag，用于检测踩内存问题。应用自身实现的检查机制也在地址的高8位进行了标记和检查，导致2种方法产生了冲突，需要应用选择适配自身方案或者禁用HWASan。</p> </div> <div class="tiledSection"><h2 id="section48759510812">HWASan报告heap-buffer-overflow，发现栈难以定位且越界的size过大，如何解决？<i class="anchor-icon anchor-icon-link" anchorid="section48759510812" tips="复制节点链接"></i></h2><p>当HWASan上报类型为heap-buffer-overflow，分析overflow的堆栈后认为该堆栈踩内存概率比较小时，通常表现为size过大，基于日志和业务分析free和use对应的线程，查看该线程的ringbuffer打印。如下检查主线程为`use`的线程，日志中rb:(102300/102300)，表示ringbuffer设置为102300，且已满。</p> <div _ngcontent-ebe-c106="" class="highlight-div"><div _ngcontent-ebe-c106="" class="highlight-div-header"><div _ngcontent-ebe-c106="" class="highlight-div-header-left"><div _ngcontent-ebe-c106="" class="handle-button expand-button"><div _ngcontent-ebe-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ebe-c106="" class="highlight-div-header-right"><div _ngcontent-ebe-c106="" class="handle-button ai-button"></div><div _ngcontent-ebe-c106="" class="handle-button line-button"><div _ngcontent-ebe-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ebe-c106="" class="handle-button theme-button"><div _ngcontent-ebe-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ebe-c106="" class="handle-button copy-button"><div _ngcontent-ebe-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ebe-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// T0:线程ID, stack:栈内存范围, sz:栈大小, tls:线程本地存储范围, rb:ringbuffer状态, records:记录数, tid:系统线程ID</span></li><li><span class="hljs-variable">Thread</span>: <span class="hljs-title class_">T0</span> <span class="hljs-number">0x005a00002000</span> <span class="hljs-title class_">stack</span>: [<span class="hljs-number">0x007ed30ba000</span>,<span class="hljs-number">0x007ed38b9000</span>) <span class="hljs-variable">sz</span>: <span class="hljs-number">8384512</span> <span class="hljs-title class_">tls</span>: [<span class="hljs-number">0x0059d8b7df20</span>,<span class="hljs-number">0x0059d8b7e738</span>) <span class="hljs-variable">rb</span>:(<span class="hljs-number">102300</span>/<span class="hljs-number">102300</span>) <span class="hljs-title function_">records</span>(<span class="hljs-number">2033100</span>/<span class="hljs-variable">o</span>:<span class="hljs-number">0</span>) <span class="hljs-variable">tid</span>: <span class="hljs-number">668</span></li></ol></pre></div></div> <p>这种情况下可考虑对HWASan 参数进行调参，调参方法可参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-stability-hwasan-detection#section1496994494018">HWASan参数配置</a>，设置heap_quarantine_thread_max_count大于当前的个数（如上当前为102300）。</p> </div> </div> <div></div></div>