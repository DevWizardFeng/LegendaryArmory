<h1 _ngcontent-vhw-c119="" class="doc-title ng-star-inserted" title="锁屏沉浸实况窗"> 锁屏沉浸实况窗 </h1>

<div _ngcontent-vhw-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section12314152282615">概述<i class="anchor-icon anchor-icon-link" anchorid="section12314152282615" tips="复制节点链接"></i></h2><p>在实际应用开发中，实时信息的高效呈现始终是提升用户体验的关键。实况窗作为高效的交互组件，有助于用户聚焦并迅速查看、处理任务，具备时段性、时效性、变化性的特征。锁屏沉浸实况窗能够详细展示应用的实时活动状态，将重要信息呈现在锁屏界面上，使用户一目了然，无需解锁屏幕进入应用即可获取最新的活动状态，尤其适合于实时性要求高，需要用户及时了解状态的场景，如动态显示网约车位置的出行打车场景、实时更新外卖进度的即时配送场景、以及在锁屏界面呈现电子登机牌的航班场景等。通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/live-view-kit-guide" target="_blank">Live View Kit（实况窗服务）</a>协助开发者快速集成实况窗功能，能轻松实现锁屏沉浸式的展示效果。</p> <div class="fignone"><span class="figcap"><b>图1 </b>用户获取实时信息界面</span></div> <p><span><img height="320.0645" originheight="2215" originwidth="3621" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.56599428208786202449396782441122:50001231000000:2800:FF7CB812C389FBCBFA376439BFA5495A561BF9E98B3B2EEBAC071C3472249734.png" title="点击放大" width="522.69"></span></p> <p>当用户退出主界面操作后，可通过下拉通知栏或点击胶囊态实况窗快速获取导航概要；当设备进入锁屏状态时，将进一步展示沉浸式锁屏实况窗界面。这种设计可实现实时获取当前信息，既保证了核心业务流的持续可视化，又实现了用户注意力资源的智能分配。</p> <p>本文将以车道级导航锁屏沉浸实况窗开发实践为例，介绍锁屏沉浸实况窗的实现原理、开发流程，以及开发过程中常见的问题。</p> </div> <div class="tiledSection"><h3 id="section1981234184512" class="firsth2">开发准备<i class="anchor-icon anchor-icon-link" anchorid="section1981234184512" tips="复制节点链接"></i></h3><p><strong>图2 </strong>在锁屏页面点击实况窗打开锁屏沉浸实况窗</p> <p><span><img height="546.0847" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.42250388425114049364026517505177:50001231000000:2800:D6D20C40021B24809D8BF6C4BFB1FB82A87D5F3199B81E5FD652E1DAC13DDA79.gif" title="点击放大" width="266"></span></p> <p>锁屏沉浸实况窗的创建依赖于实况窗功能，用户需要点击实况窗展开完整锁屏沉浸实况窗卡片。因此创建锁屏沉浸实况窗的应用需要申请实况窗权限和锁屏沉浸实况窗权限，详情请参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/liveview-preparations" target="_blank">Live View Kit（实况窗服务）开发准备</a>。</p> </div> <div class="tiledSection"><h3 id="section430210710274">锁屏沉浸实况窗体验<i class="anchor-icon anchor-icon-link" anchorid="section430210710274" tips="复制节点链接"></i></h3><p>锁屏沉浸实况窗的核心功能在于实时展示关键信息和动态数据。通过高效实时更新机制，确保界面内容与最新状态即时同步，使用户能够随时获取最新资讯。这一功能不仅帮助用户高效掌握重要信息，还提升了应用的可信度和用户体验。在典型应用场景中，车道级导航可以即时更新车辆所在车道和导航信息，音乐应用则可通过更新歌曲信息和封面来提供当前播放的歌曲详情。</p> <p><strong>图3 </strong>车道级导航锁屏沉浸实况窗</p> <p><span><img height="546.0847" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163054.85924616180182164362832139197180:50001231000000:2800:3A714EF8C81A6396C26B030328E201714EE6984608C737551B03EE581F1EEE47.gif" title="点击放大" width="266"></span></p> <p>由于锁屏状态的特殊性，锁屏沉浸实况窗通常为被动更新，因此需要有合理的更新策略。以车道级导航为例，当用户的车辆所在车道发生变化时，应更新车道信息，并定期更新导航信息，以保持锁屏沉浸实况窗内容的新鲜感和实时性，确保用户能够持续获取信息并合理分配注意力资源。</p> </div> <div class="tiledSection"><h2 id="section41681823294">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section41681823294" tips="复制节点链接"></i></h2></div> <p><strong>图</strong><strong>4 锁屏沉浸实况窗架构图</strong></p> <p><span><img height="326.1825" originheight="2825" originwidth="4531" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.31220436165472811182677779599573:50001231000000:2800:F0BDD3C370DF77A23CD9F84744B0B364B8AF46374E753D33D5147EDE857D7FD8.png" title="点击放大" width="523.6875"></span></p> <p>锁屏沉浸实况窗的创建和更新依赖于<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/live-view-kit-guide" target="_blank">Live View Kit（实况窗服务）</a>，具体流程如下：</p> <ol><li>应用主进程创建实况窗：应用主进程通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/live-view-kit-guide" target="_blank">Live View Kit（实况窗服务）</a>创建实况窗。</li><li>关联实况窗和锁屏沉浸实况窗：在创建实况窗时，需在参数中传入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>名称，以便将实况窗与锁屏沉浸实况窗关联。此步骤需调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/live-view-kit-guide" target="_blank">Live View Kit（实况窗服务）</a>中的liveViewManager模块实现，具体实现方法请参阅<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/liveview-scenes" target="_blank">开发实况窗场景</a>。</li><li>应用主进程接收数据：应用主进程通过后台长时任务接收来自数据源的数据。</li><li>应用主进程发布公共事件传递数据源数据。</li><li>锁屏沉浸实况窗更新页面：<ol><li>锁屏沉浸实况窗订阅相应的公共事件，接收数据源的数据；</li><li>锁屏沉浸实况窗检测到数据更新后，进行页面的更新。</li></ol> </li></ol> <div class="tiledSection"><h2 id="section14892182585311">锁屏沉浸实况窗创建<i class="anchor-icon anchor-icon-link" anchorid="section14892182585311" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section12714132185317" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section12714132185317" tips="复制节点链接"></i></h3><p>通过LiveView对象与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>关联，并通过回调创建锁屏沉浸实况窗，以实现锁屏沉浸实况窗的展示。</p> </div> <div class="tiledSection"><h3 id="section1716125511813">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1716125511813" tips="复制节点链接"></i></h3><p>在创建实况窗时，需在LiveView对象中指定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>的名称，以便系统能够正确关联并渲染锁屏沉浸式实况窗。</p> <ol><li>将<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>的名称写入创建实况窗时创建的liveView对象中。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveViewUtil.ets#L19-L175" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">liveViewManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.LiveViewKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Construct live window request body.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">liveView</span>: <span class="hljs-title class_">liveViewManager</span>.<span class="hljs-title class_">LiveView</span> = {</li><li>      <span class="hljs-variable">id</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">sequence</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">sequence</span>,</li><li>      <span class="hljs-comment">// Application scenarios of the live window. NAVIGATION: Navigation.</span></li><li>      <span class="hljs-variable">event</span>: <span class="hljs-string">'NAVIGATION'</span>,</li><li>      <span class="hljs-variable">liveViewData</span>: {</li><li>        <span class="hljs-comment">// Live view capsule related parameters</span></li><li>        <span class="hljs-variable">capsule</span>: {</li><li>          <span class="hljs-keyword">type</span>: <span class="hljs-title class_">liveViewManager</span>.<span class="hljs-title class_">CapsuleType</span>.<span class="hljs-title class_">CAPSULE_TYPE_TEXT</span>,</li><li>          <span class="hljs-variable">status</span>: <span class="hljs-number">1</span>,</li><li>          <span class="hljs-variable">icon</span>: <span class="hljs-string">'turn_right_light_square.png'</span>,</li><li>          <span class="hljs-variable">backgroundColor</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getStringSync</span>($<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">live_view_background</span>').<span class="hljs-title class_">id</span>),</li><li>          <span class="hljs-variable">title</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getStringSync</span>($<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">live_view_title</span>').<span class="hljs-title class_">id</span>),</li><li>        },</li><li>        <span class="hljs-comment">// Live view card related parameters</span></li><li>        <span class="hljs-variable">primary</span>: {</li><li>          <span class="hljs-variable">title</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getStringSync</span>($<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">live_view_title</span>').<span class="hljs-title class_">id</span>),</li><li>          <span class="hljs-variable">content</span>: [{ <span class="hljs-variable">text</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">getStringSync</span>($<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">live_view_content</span>').<span class="hljs-title class_">id</span>) }],</li><li>          <span class="hljs-comment">// Add LiveViewLockScreenExtensionAbility name to build lock screen live view</span></li><li>          <span class="hljs-variable">liveViewLockScreenAbilityName</span>: <span class="hljs-string">'LiveViewExtAbility'</span>,</li><li>          <span class="hljs-variable">liveViewLockScreenAbilityParameters</span>: { <span class="hljs-variable">liveViewParameters</span>: <span class="hljs-string">''</span> },</li><li>          <span class="hljs-variable">keepTime</span>: <span class="hljs-number">0</span>,</li><li>          <span class="hljs-variable">clickAction</span>: <span class="hljs-title class_">await</span> <span class="hljs-title class_">LiveViewUtil</span>.<span class="hljs-title class_">buildWantAgent</span>()</li><li>        }</li><li>      }</li><li>    };</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveViewUtil.ets#L19-L175" target="_blank">LiveViewUtil.ets</a></div></div></div></div> </li><li>在应用module.json5中配置<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>的名称。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/module.json5#L39-L48" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"extensionAbilities"</span>: [</li><li>  {</li><li>    <span class="hljs-comment">// Keep it consistent with LiveViewLockScreenExtensionAbility name in live view instance</span></li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"LiveViewExtAbility"</span>,</li><li>    <span class="hljs-string">"type"</span>: <span class="hljs-string">"liveViewLockScreen"</span>,</li><li>    <span class="hljs-comment">// LiveViewLockScreenExtensionAbility location</span></li><li>    <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/liveview/LiveViewExtAbility.ets"</span>,</li><li>    <span class="hljs-string">"exported"</span>: <span class="hljs-keyword">false</span></li><li>  }</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/module.json5#L39-L48" target="_blank">module.json5</a></div></div></div></div> </li><li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>的onSessionCreate()方法中完成锁屏沉浸实况窗页面的创建。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L83-L141" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Core logic when creating UI session.</span></li><li><span class="hljs-title function_">onSessionCreate</span>(<span class="hljs-variable">_want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-variable">session</span>: <span class="hljs-title class_">UIExtensionContentSession</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable">session</span>.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'liveview/LockScreenPage'</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">error</span>) {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span> = <span class="hljs-variable">error</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, `<span class="hljs-variable">Session</span> <span class="hljs-variable">load</span> <span class="hljs-variable">content</span> <span class="hljs-variable">failed</span>. <span class="hljs-variable">code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L83-L141" target="_blank">LiveViewExtAbility.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section1067092916265">锁屏沉浸实况窗实时更新<i class="anchor-icon anchor-icon-link" anchorid="section1067092916265" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section66448427101" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section66448427101" tips="复制节点链接"></i></h3><p>在通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>生命周期回调创建锁屏沉浸实况窗后，为了满足用户及时获取信息更新的需求，该实况窗需要实时更新。本章节将介绍如何实现锁屏沉浸实况窗的数据实时更新。</p> <p><strong>图5 </strong>锁屏沉浸实况窗实时更新</p> <p><span><img height="546.0847" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.95857027359076254807403533568570:50001231000000:2800:27355C51F20B14FBD79DE306F98C90610C37D425302CED1887B0C0F20E86A92B.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section2566201617118">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2566201617118" tips="复制节点链接"></i></h3><p>沉浸式实况窗进程与应用主进程之间的数据通信需根据不同场景兼顾实时性和初始化需求。以下是不同场景下的推荐方案：</p> <ol><li>公共事件方案（适用于多数场景）：通过注册公共事件和监听公共事件的方式，实现锁屏沉浸实况窗进程与应用主进程间的数据通信。<ul><li>优点：实现简单，支持跨进程广播通信。</li><li>缺点：无法获取初始数据。</li></ul> </li><li>liveViewLockScreenAbilityParameters参数方案（适用于有初始化需求的场景）：将数据携带在liveview对象的liveViewLockScreenAbilityParameters中，锁屏沉浸实况窗启动时可通过want直接获取。<ul><li>优点：启动时可立即获取初始数据。</li><li>缺点：数据不可更新，更新需重启锁屏沉浸实况窗，可能导致闪屏。</li></ul> </li><li>文件共享方案（适用于大数据传输场景，谨慎使用）：应用主进程将数据保存至沙箱文件中，在沉浸实况进程中监听文件内容变动以获取数据。<ul><li>优点：适合大数据量传输，可持久化存储。</li><li>缺点：读写文件效率较低，锁屏沉浸实况窗进程无法直接获取沙箱路径，需由应用主进程通过其他方式传入沙箱路径。</li></ul> </li></ol> <p>综合考虑实现复杂度、性能表现和业务需求，在对初始数据无特殊要求的场景下，推荐开发者采用公共事件方案。该方案在实现难度和功能完整性之间取得了平衡，能够满足大多数场景下的通信需求。</p> <p>如果开发者对锁屏沉浸实况窗的初始数据有特殊要求，可以结合使用liveViewLockScreenAbilityParameters参数方案和公共事件方案：使用liveViewLockScreenAbilityParameters参数传入初始数据，通过注册和监听公共事件的方式进行后续数据更新。下文将以公共事件方案为例，介绍如何实现锁屏沉浸式实况窗的实时更新。</p> <p><strong>图6 </strong>锁屏沉浸实况窗实时更新时序图</p> <p><span><img height="332.1675" originheight="2081" originwidth="3275" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.76153425690880511469850918697778:50001231000000:2800:EE0A104223ADF1DB8618DF7CAA92BFEB4D772D4EDC9410A34E7FA8F6F493AE45.png" title="点击放大" width="523.6875"></span></p> <ol><li>申请后台长时任务，确保在后台能够发布公共事件以传递更新数据。<ul><li>在申请后台长时任务之前，需确认应用已在module.json5中声明后台运行权限。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/module.json5#L51-L62" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-string">"requestPermissions"</span>: [</li><li>  {</li><li>    <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.KEEP_BACKGROUND_RUNNING"</span>,</li><li>    <span class="hljs-string">"reason"</span>: <span class="hljs-string">"$string:reason_background"</span>,</li><li>    <span class="hljs-string">"usedScene"</span>: {</li><li>      <span class="hljs-string">"abilities"</span>: [</li><li>        <span class="hljs-string">"EntryAbility"</span></li><li>      ],</li><li>      <span class="hljs-string">"when"</span>: <span class="hljs-string">"always"</span></li><li>    }</li><li>  },</li><li>],</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/module.json5#L51-L62" target="_blank">module.json5</a></div></div></div></div> </li><li>应用创建长时任务，并声明长时任务类型。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L18-L178" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { backgroundTaskManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BackgroundTasksKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Internal method to manage background tasks</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">startContinuousRunningTask</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-comment">// Configure WantAgent for background operation</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">wantAgentInfo</span>: wantAgent.<span class="hljs-property">WantAgentInfo</span> = {</li><li>      <span class="hljs-attr">wants</span>: [</li><li>        {</li><li>          <span class="hljs-attr">bundleName</span>: <span class="hljs-string">'com.example.mapliveviewsample'</span>,</li><li>          <span class="hljs-attr">abilityName</span>: <span class="hljs-string">'EntryAbility'</span></li><li>        }</li><li>      ],</li><li>      <span class="hljs-attr">actionType</span>: wantAgent.<span class="hljs-property">OperationType</span>.<span class="hljs-property">START_ABILITY</span>,</li><li>      <span class="hljs-attr">requestCode</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">actionFlags</span>: [wantAgent.<span class="hljs-property">WantAgentFlags</span>.<span class="hljs-property">UPDATE_PRESENT_FLAG</span>]</li><li>    };</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Acquire WantAgent for background operations</span></li><li>      wantAgent.<span class="hljs-title function_">getWantAgent</span>(wantAgentInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">wantAgentObj: WantAgent</span>) =&gt;</span> {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Operation startBackgroundRunning begin.'</span>);</li><li>          <span class="hljs-comment">// Required background resource types</span></li><li>          <span class="hljs-keyword">const</span> <span class="hljs-attr">list</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'location'</span>];</li><li>          <span class="hljs-comment">// Request background running permission</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.ResourceSchedule.BackgroundTaskManager.ContinuousTask'</span>)) {</li><li>            backgroundTaskManager.<span class="hljs-title function_">startBackgroundRunning</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, list, wantAgentObj).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Operation startBackgroundRunning succeeded.'</span>);</li><li>            }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>              hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                <span class="hljs-string">`Failed to Operation startBackgroundRunning. code is <span class="hljs-subst">${error.code}</span> message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>            });</li><li>          }</li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>            <span class="hljs-string">`Failed to Operation startBackgroundRunning. code is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span> message is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>        }</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>        <span class="hljs-string">`Failed to Operation getWantAgent. code is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span> message is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L18-L178" target="_blank">LiveView.ets</a></div></div></div></div> </li></ul> </li><li>发布公共事件传递更新数据到锁屏沉浸实况窗。<p>应用在主页面中通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-commoneventmanager#commoneventmanagerpublish" target="_blank">commonEventManager.publish()</a>接口发布公共事件'live_view_lock_screen'，并在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-commonevent-commoneventpublishdata" target="_blank">CommonEventPublishData</a>的parameters属性中附带锁屏沉浸实况窗的创建和更新数据。</p> <div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L21-L91" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BusinessError</span>, <span class="hljs-variable">commonEventManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>            <span class="hljs-comment">// Prepare common event data</span></li><li>            <span class="hljs-keyword">let</span> <span class="hljs-variable">options</span>: <span class="hljs-title class_">commonEventManager</span>.<span class="hljs-title class_">CommonEventPublishData</span> = {</li><li>              <span class="hljs-variable">data</span>: <span class="hljs-string">'data'</span>,</li><li>              <span class="hljs-variable">bundleName</span>: <span class="hljs-string">'com.example.mapliveviewsample'</span>,</li><li>              <span class="hljs-variable">parameters</span>: {</li><li>                <span class="hljs-string">'laneData'</span>: <span class="hljs-title class_">routeData</span>.<span class="hljs-title class_">laneData</span></li><li>              }</li><li>            };</li><li>            <span class="hljs-comment">// Publish system event for lock screen updates</span></li><li>            <span class="hljs-variable">commonEventManager</span>.<span class="hljs-title function_">publish</span>(<span class="hljs-string">'live_view_lock_screen'</span>, <span class="hljs-variable">options</span>, (<span class="hljs-variable">error</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-variable">error</span>) {</li><li>                <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>                  `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">publish</span> <span class="hljs-variable">commonEvent</span>. <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>} <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>              } <span class="hljs-keyword">else</span> {</li><li>                <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in publishing commonEvent.'</span>)</li><li>              }</li><li>            });</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L21-L91" target="_blank">LiveView.ets</a></div></div></div></div> </li><li>订阅公共事件更新锁屏沉浸实况窗。<p>锁屏沉浸实况窗进程在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>中，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-commoneventmanager#commoneventmanagercreatesubscriber" target="_blank">commonEventManager.createSubscriber()</a>接口创建主页面创建的公共事件'live_view_lock_screen'的订阅者，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-appstorage" target="_blank">AppStorage（应用全局的UI状态存储）</a>将主页面传递的数据传入LockScreenPage.ets，以实现锁屏沉浸实况窗的创建和更新。</p> <div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L23-L131" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { BusinessError, commonEventManager } from <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-comment">// Initialize event subscription.</span></li><li>    let subscribeInfo: commonEventManager.CommonEventSubscribeInfo = {</li><li>      events: [<span class="hljs-string">'live_view_lock_screen'</span>],</li><li>      publisherBundleName: <span class="hljs-string">'com.example.mapliveviewsample'</span>,</li><li>      priority: <span class="hljs-number">0</span></li><li>    };</li><li>    commonEventManager.createSubscriber(subscribeInfo,</li><li>      (error: BusinessError, <span class="hljs-keyword">data</span>: commonEventManager.CommonEventSubscriber) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (error) {</li><li>          hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'%{public}s'</span>,</li><li>            `Failed to create subscriber. code <span class="hljs-keyword">is</span> ${error.code} message <span class="hljs-keyword">is</span> ${error.message}.`);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-keyword">this</span>.subscriber = <span class="hljs-keyword">data</span>;</li><li>        hilog.info(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in creating subscriber.'</span>);</li><li>        <span class="hljs-comment">// Event handling logic.</span></li><li>        commonEventManager.subscribe(<span class="hljs-keyword">this</span>.subscriber,</li><li>          async (error: BusinessError, <span class="hljs-keyword">data</span>: commonEventManager.CommonEventData) =&gt; {</li><li>            <span class="hljs-keyword">if</span> (error) {</li><li>              hilog.error(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'%{public}s'</span>,</li><li>                `Failed to subscribe commonEvent. code <span class="hljs-keyword">is</span> ${error.code} message <span class="hljs-keyword">is</span> ${error.message}.`);</li><li>              <span class="hljs-keyword">return</span>;</li><li>            }</li><li>            hilog.info(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in subscribe commonEvent success.'</span>);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">data</span>.parameters) {</li><li>              let laneData = <span class="hljs-keyword">data</span>.parameters[<span class="hljs-string">'laneData'</span>] <span class="hljs-keyword">as</span> LaneData;</li><li>              AppStorage.setOrCreate(<span class="hljs-string">'laneData'</span>, laneData);</li><li>              hilog.info(<span class="hljs-number">0x0000</span>, TAG, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in receive commonEvent.'</span>);</li><li>            }</li><li>          });</li><li>      })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L23-L131" target="_blank">LiveViewExtAbility.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section13961114613246">锁屏沉浸实况窗结束<i class="anchor-icon anchor-icon-link" anchorid="section13961114613246" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1996244616243" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section1996244616243" tips="复制节点链接"></i></h3><p>当用户实时获取信息的需求结束时，应用应及时关闭实况窗及锁屏沉浸实况窗，以优化设备性能和电池续航，避免不必要功耗问题。</p> </div> <div class="tiledSection"><h3 id="section996214464246">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section996214464246" tips="复制节点链接"></i></h3><p>为确保结束锁屏沉浸实况窗时可以完整释放系统资源，结束流程需按以下顺序执行：</p> <ol><li>停止数据源接收：关闭数据输入通道，停止数据采集。本开发实践为结束定时器任务，停止更新车道数据。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L107-L112" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Clear periodic updates</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">updateInterval</span> !== <span class="hljs-literal">undefined</span>) {</li><li>  <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">updateInterval</span>);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">updateInterval</span> = <span class="hljs-literal">undefined</span>;</li><li>  hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Timer has been cleared'</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L107-L112" target="_blank">LiveView.ets</a></div></div></div></div> </li><li>结束界面更新：停止实况窗和沉浸实况窗的内容更新与展示。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveViewUtil.ets#L74-L89" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Close live view.</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">closeLiveView</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Ensure that the sequence is greater than the current live window page.</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">sequence</span>++;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultLiveView</span> = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createPrimaryLiveView</span>();</li><li>  <span class="hljs-keyword">await</span> liveViewManager.<span class="hljs-title function_">stopLiveView</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultLiveView</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">sequence</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">defaultLiveView</span> = <span class="hljs-literal">undefined</span>;</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Succeeded in stopping liveView, result: %{public}'</span>);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>      <span class="hljs-string">`Failed to stop liveView. Cause code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  });</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveViewUtil.ets#L74-L89" target="_blank">LiveViewUtil.ets</a></div></div></div></div> </li><li>清理后台任务：结束关联的后台长时运行任务。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L119-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Stop background tasks</span></li><li><span class="hljs-keyword">try</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.ResourceSchedule.BackgroundTaskManager.ContinuousTask'</span>)) {</li><li>    backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Operation stopBackgroundRunning succeeded'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>        <span class="hljs-string">`Operation stopBackgroundRunning failed. code is <span class="hljs-subst">${error.code}</span> message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    });</li><li>  }</li><li>} <span class="hljs-keyword">catch</span> (error) {</li><li>  hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>    <span class="hljs-string">`Operation stopBackgroundRunning failed. code is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).code}</span> message is <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L119-L132" target="_blank">LiveView.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section3909181512141">锁屏沉浸实况窗多设备适配<i class="anchor-icon anchor-icon-link" anchorid="section3909181512141" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section17976425141614" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section17976425141614" tips="复制节点链接"></i></h3><p><strong>图7 </strong>手机折叠态和展开态锁屏沉浸实况窗对比图</p> <p><span><img height="348.1275" originheight="2052" originwidth="3084" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163055.50486241757256189132623608592007:50001231000000:2800:2047B48B73FD6FBF277A3B4A6A4A72FB30F73740CFBD21C767DF6769221C6F69.png" title="点击放大" width="522.69"></span></p> <p>为了适配不同尺寸的实况卡片和多样化的设备形态，沉浸式实况展示应采用自适应的多断点布局方案，以确保在各种产品上能够实现自适应布局。可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-responsive-layout#section1532120147301" target="_blank">断点</a>。</p> <p>锁屏沉浸实况窗在不同设备形态上的布局存在差异，主要体现在手机折叠态与展开态两种显示模式中。在手机展开状态下，锁屏沉浸实况窗的高宽比会减少，页面变得更宽。然而，无论是在哪种形态下，横断点都属于sm断点（<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-multi-device-responsive-layout#section186821126131515" target="_blank">断点的定义</a>），因此需要使用基于高宽比的纵断点进行区分，以实现多适配。</p> </div> <div class="tiledSection"><h3 id="section1417519411517">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1417519411517" tips="复制节点链接"></i></h3><ol><li>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/liveview-lock-screen-ability" target="_blank">LiveViewLockScreenExtensionAbility</a>中注册页面布局变化的监听器。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L17-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIExtensionContentSession</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { display, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Window size listener.</span></li><li>      <span class="hljs-keyword">const</span> extensionWindow = session.<span class="hljs-title function_">getUIExtensionWindowProxy</span>();</li><li>      extensionWindow.<span class="hljs-title function_">on</span>(<span class="hljs-string">'windowSizeChange'</span>, <span class="hljs-function">(<span class="hljs-params">windowSize: <span class="hljs-variable language_">window</span>.Size</span>) =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateBreakPoint</span>(windowSize);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">err</span>: <span class="hljs-title class_">BusinessError</span> = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Session update break point failed. code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L17-L97" target="_blank">LiveViewExtAbility.ets</a></div></div></div></div> </li><li>当检测到锁屏沉浸实况窗布局发生变化时，触发纵向断点的重新计算。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L19-L63" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { display, <span class="hljs-variable language_">window</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Distinguish page layout using vertical breakpoints.</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateBreakPoint</span>(<span class="hljs-attr">windowSize</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">Size</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">windowWidthVp</span>: <span class="hljs-built_in">number</span> = windowSize.<span class="hljs-property">width</span> / display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityPixels</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">windowHeightVp</span>: <span class="hljs-built_in">number</span> = windowSize.<span class="hljs-property">height</span> / display.<span class="hljs-title function_">getDefaultDisplaySync</span>().<span class="hljs-property">densityPixels</span>;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">windowRatio</span>: <span class="hljs-built_in">number</span> = windowWidthVp / windowHeightVp;</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">verticalBreakpoint</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">Constants</span>.<span class="hljs-property">BREAK_POINT_SM</span>;</li><li>      <span class="hljs-comment">// Vertical breakpoints are distinguished by aspect ratio.</span></li><li>      <span class="hljs-keyword">if</span> (windowRatio &lt; <span class="hljs-number">0.8</span>) {</li><li>        verticalBreakpoint = <span class="hljs-title class_">Constants</span>.<span class="hljs-property">BREAK_POINT_SM</span>;</li><li>      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (windowRatio &gt; <span class="hljs-number">1.2</span>) {</li><li>        verticalBreakpoint = <span class="hljs-title class_">Constants</span>.<span class="hljs-property">BREAK_POINT_LG</span>;</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        verticalBreakpoint = <span class="hljs-title class_">Constants</span>.<span class="hljs-property">BREAK_POINT_MD</span>;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">verticalBreakpoint</span> !== verticalBreakpoint) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">verticalBreakpoint</span> = verticalBreakpoint;</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'verticalBreakpoint'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">verticalBreakpoint</span>);</li><li>      }</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateBreakpoint <span class="hljs-subst">${verticalBreakpoint}</span>`</span>);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateBreakpoint catch err:`</span>, (error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>).<span class="hljs-property">message</span>);</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LiveViewExtAbility.ets#L19-L63" target="_blank">LiveViewExtAbility.ets</a></div></div></div></div> </li><li>在 LockScreenPage中采用纵向断点监听机制，根据窗口大小动态切换布局样式。<div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LockScreenPage.ets#L22-L54" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'verticalBreakpoint'</span>) <span class="hljs-variable">verticalBreakpoint</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_SM</span>;</li><li>@<span class="hljs-title function_">StorageProp</span>(<span class="hljs-string">'laneData'</span>) <span class="hljs-variable">laneData</span>: <span class="hljs-title class_">LaneData</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">undefined</span>;</li><li>
</li><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">Top</span> }) {</li><li>    <span class="hljs-title function_">Image</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? $<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.ic_lock'</span>) : $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">media</span>.<span class="hljs-title class_">ic_lock_md</span>'))</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>
</li><li>    <span class="hljs-title function_">Row</span>() {</li><li>      <span class="hljs-title function_">Stack</span>() {</li><li>        <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.ic_light'</span>))</li><li>          .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">73.5</span> : <span class="hljs-number">106</span>)</li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">36</span> : <span class="hljs-number">52</span>)</li><li>        <span class="hljs-title function_">Text</span>(<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">laneData</span>?.<span class="hljs-variable">lightTime</span> ?? <span class="hljs-number">90</span>))</li><li>          .<span class="hljs-title function_">fontColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.color.white'</span>))</li><li>          .<span class="hljs-title function_">fontSize</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">24</span> : <span class="hljs-number">30</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">right</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">8</span> : <span class="hljs-number">16</span> })</li><li>      }</li><li>      .<span class="hljs-title function_">alignContent</span>(<span class="hljs-variable">Alignment</span>.<span class="hljs-variable">End</span>)</li><li>    }</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">73.5</span> : <span class="hljs-number">106</span>)</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">36</span> : <span class="hljs-number">52</span>)</li><li>    .<span class="hljs-title function_">position</span>({</li><li>      <span class="hljs-comment">// Layout based on vertical breakpoint.</span></li><li>      <span class="hljs-variable">right</span>: <span class="hljs-number">20</span>,</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">verticalBreakpoint</span> === <span class="hljs-variable">Constants</span>.<span class="hljs-variable">BREAK_POINT_MD</span> ? <span class="hljs-number">32</span> : <span class="hljs-number">25</span></li><li>    })</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">alignContent</span>(<span class="hljs-variable">Alignment</span>.<span class="hljs-variable">Center</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/liveview/LockScreenPage.ets#L22-L54" target="_blank">LockScreenPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section56732085577">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section56732085577" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section7743517705" class="firsth2">应用接入锁屏沉浸实况窗后存在功耗上升现象<i class="anchor-icon anchor-icon-link" anchorid="section7743517705" tips="复制节点链接"></i></h3></div> <p>当应用接入锁屏沉浸实况窗后，因需实时更新锁屏沉浸实况窗页面，可能会导致功耗上升。其优化策略是采用智能后台更新机制，仅在应用进入后台时触发实况窗的刷新及数据同步。可使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-appmanager#appmanagergetrunningprocessinformation" target="_blank">appManager.getRunningProcessInformation()</a>接口来获取当前应用运行进程的相关信息，并通过返回的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-inner-application-processinformation" target="_blank">ProcessInformation</a>模块中的state来判断当前进程的运行状态。</p> <div class="screenLinkPre"><div _ngcontent-vhw-c106="" class="highlight-div"><div _ngcontent-vhw-c106="" class="highlight-div-header"><div _ngcontent-vhw-c106="" class="highlight-div-header-left"><div _ngcontent-vhw-c106="" class="handle-button expand-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-vhw-c106="" class="highlight-div-header-right"><div _ngcontent-vhw-c106="" class="handle-button ai-button"></div><div _ngcontent-vhw-c106="" class="handle-button line-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-vhw-c106="" class="handle-button theme-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-vhw-c106="" class="handle-button copy-button"><div _ngcontent-vhw-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-vhw-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L62-L99" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Set up periodic state checking</span></li><li><span class="hljs-variable language_">this</span>.<span class="hljs-property">updateInterval</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {</li><li>  <span class="hljs-comment">// Monitor application state changes</span></li><li>  appManager.<span class="hljs-title function_">getRunningProcessInformation</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data: <span class="hljs-built_in">Array</span>&lt;appManager.ProcessInformation&gt;</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Success to getRunningProcessInformation'</span>);</li><li>    <span class="hljs-comment">// Handle background state</span></li><li>    <span class="hljs-keyword">if</span> (data[<span class="hljs-number">0</span>].<span class="hljs-property">state</span> === appManager.<span class="hljs-property">ProcessState</span>.<span class="hljs-property">STATE_BACKGROUND</span>) {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'%{public}s'</span>,</li><li>      <span class="hljs-string">`Failed to getRunningProcessInformation. code is <span class="hljs-subst">${error.code}</span> message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  });</li><li>}, <span class="hljs-number">1000</span>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen/blob/master/entry/src/main/ets/utils/LiveView.ets#L62-L99" target="_blank">LiveView.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section1470214387273">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1470214387273" tips="复制节点链接"></i></h2></div> <ul><li><a href="https://gitee.com/harmonyos_samples/LiveViewLockScreen" target="_blank">锁屏沉浸实况窗</a></li></ul> </div> <div></div></div>