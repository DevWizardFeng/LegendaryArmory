<h1 _ngcontent-bda-c119="" class="doc-title ng-star-inserted" title="长截图"> 长截图 </h1>

<div _ngcontent-bda-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section95657911319">概述<i class="anchor-icon anchor-icon-link" anchorid="section95657911319" tips="复制节点链接"></i></h2><p>在移动应用中，标准的截图方法仅能捕捉当前屏幕显示的内容，对于超出屏幕可视区域的长页面或文档而言，这种方式显得不够便捷。当用户截图分享和保存（如聊天记录、网页文章、活动海报等）的内容较长的时候，需要用户多次截图来保证内容完整性。为了解决这一问题，本文将介绍长截图功能，使用户能够一键截取整个页面的长图，更轻松地分享和保存信息。</p> <p>长截图功能适用于支持滚动的UI组件，比如List组件、Scroll组件、Web组件等。本文将以List组件和Web组件为例来介绍长截图功能的开发，分别通过控制器<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scroll#scroller" target="_blank">Scroller</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">WebviewController</a>，结合UIContext的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-uicontext-componentsnapshot#get12-1" target="_blank">getComponentSnapshot().get()</a>方法，实现长截图功能。</p> </div> <div class="tiledSection"><h2 id="section11021434163116">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section11021434163116" tips="复制节点链接"></i></h2><p>List组件和Web组件实现长截图功能的原理相同，均可以通过模拟用户滚动行为，然后使用getComponentSnapshot().get()方法逐步截取不同位置的画面，将这些画面通过拼接得到长截图。Web组件通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller" target="_blank">WebviewController</a>的相关API控制组件滚动，List组件通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-scroll#scroller" target="_blank">Scroller</a>的相关API控制组件滚动。</p> <p>长截图拼接原理如下，将每次滚动新进入屏幕的内容裁剪后，拼接到之前的屏幕截图，依次类推。</p> <div class="fignone"><span class="figcap"><b>图1 </b>长截图拼接原理图</span><br><span><img height="550.237891" originheight="960" originwidth="1300" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.99887753392065131450588061956579:50001231000000:2800:A3F85945227885361CD63DB3ED88D898B448F328B87872F5F2A2853CEE7B34E9.png" title="点击放大" width="745.1325"></span></div> <p>长截图主要流程如下：</p> <div class="fignone"><span class="figcap"><b>图2 </b>滚动长截图流程</span><p><span><img height="609.28098" originheight="816" originwidth="440" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.03115757559183699266947200019848:50001231000000:2800:38862362926B88E97DF78040CE4941829ED05E1BAC36B7B754A53607EEC3BC13.png" title="点击放大" width="335.16"></span></p> </div> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在长截图的拼接过程中，所有截图会被暂时缓存到内存中。对于无限滚动或数据量较大的场景，应当限制单张截图的高度，以防止过高的内存占用影响应用性能。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section1398314519326">滚动组件长截图<i class="anchor-icon anchor-icon-link" anchorid="section1398314519326" tips="复制节点链接"></i></h2><p>List、Scroll、Grid、WaterFlow等滚动组件均是通过Scroller来控制组件滚动，本章将以List组件为例来介绍滚动组件长截图的实现。下面介绍了滚动组件两种常见的长截图场景，一键截图和滚动截图。</p> </div> <div class="tiledSection"><h3 id="section883513366346" class="firsth2">一键截图<i class="anchor-icon anchor-icon-link" anchorid="section883513366346" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>一键截图将组件数据从顶部截取到底部，在截图过程中用户看不到界面的滚动，实现无感知滚动截图。这种方案一般用于分享截图、保存数据量较少的场景。</p> <p><strong>实现效果</strong></p> <p>点击“一键截图”，会生成整个列表的长截图。</p> <p></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.95141750115870302327498874152675:50001231000000:2800:81BBB0BD95901448CA7FF28545E92914B26E4BB44CA588F45F906656A80B5936.gif" title="点击放大" width="266"></span></p> <p><strong>开发流程</strong></p> <ol><li>给List绑定滚动控制器，添加监听事件。<p>1.1 为List滚动组件绑定Scroller控制器，以控制其滚动行为，并给List组件绑定自定义的id。</p> <p>1.2 通过onDidScroll()方法实时监听并获取滚动偏移量，确保截图拼接位置的准确性。</p> <p>1.3 同时，利用onAreaChange()事件获取List组件的尺寸，以便精确计算截图区域的大小。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L29-L339" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/ScrollSnapshot.ets</span></li><li><span class="hljs-meta">@Component</span></li><li>export struct ScrollSnapshot {</li><li>  <span class="hljs-comment">// Scroll controller</span></li><li>  <span class="hljs-keyword">private</span> scroller: Scroller = new Scroller();</li><li>  <span class="hljs-keyword">private</span> listComponentWidth: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> listComponentHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The current offset of the List component</span></li><li>  <span class="hljs-keyword">private</span> curYOffset: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> scrollHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  build() {</li><li>    <span class="hljs-comment">// ...</span></li><li>        Stack() {</li><li>          <span class="hljs-comment">// ...</span></li><li>          List({</li><li>            space: <span class="hljs-number">12</span>,</li><li>            scroller: <span class="hljs-keyword">this</span>.scroller</li><li>          })</li><li>          <span class="hljs-comment">// ...</span></li><li>          .id(LIST_ID)</li><li>          .onDidScroll(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.curYOffset = <span class="hljs-keyword">this</span>.scroller.currentOffset().yOffset;</li><li>          })</li><li>          .onAreaChange((oldValue, newValue) =&gt; {</li><li>            <span class="hljs-keyword">this</span>.listComponentWidth = newValue.width <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.listComponentHeight = newValue.height <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.scrollHeight = <span class="hljs-keyword">this</span>.listComponentHeight;</li><li>          })</li><li>          .onClick(() =&gt; {</li><li>            <span class="hljs-comment">// Click on the list to stop scrolling</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isEnableScroll) {</li><li>              <span class="hljs-keyword">this</span>.scroller.scrollBy(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>              <span class="hljs-keyword">this</span>.isClickStop = <span class="hljs-literal">true</span>;</li><li>            }</li><li>          })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .layoutWeight(<span class="hljs-number">1</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">16</span></li><li>        })</li><li>        .bindContentCover($$<span class="hljs-keyword">this</span>.isShowPreview, <span class="hljs-keyword">this</span>.previewWindowComponent(),</li><li>          {</li><li>            modalTransition: ModalTransition.NONE,</li><li>            onWillDismiss: (action: DismissContentCoverAction) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (action.reason === DismissReason.PRESS_BACK) {</li><li>                Logger.info(<span class="hljs-string">'BindContentCover dismiss reason is back pressed'</span>);</li><li>              }</li><li>            }</li><li>          })</li><li>
</li><li>        Row({ space: <span class="hljs-number">12</span> }) {</li><li>          Button($r(<span class="hljs-string">'app.string.one_click_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-keyword">this</span>.onceSnapshot();</li><li>            })</li><li>          Button($r(<span class="hljs-string">'app.string.scroll_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-comment">// Prevent users from clicking the button during the screenshot process,</span></li><li>              <span class="hljs-comment">// and the method is repeatedly called, resulting in an exception</span></li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scrollYOffsets.length === <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-keyword">this</span>.scrollSnapshot();</li><li>              }</li><li>            })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          bottom: (AppStorage.<span class="hljs-keyword">get</span>&lt;number&gt;(<span class="hljs-string">'naviIndicatorHeight'</span>) ?? <span class="hljs-number">0</span>) + <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">12</span></li><li>        })</li><li>      }</li><li>    }</li><li>    .title($r(<span class="hljs-string">'app.string.title_scroll_snapshot'</span>))</li><li>    .backgroundColor($r(<span class="hljs-string">'sys.color.background_secondary'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L29-L339" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> </li><li>给List添加遮罩图，初始化滚动位置。<p>“一键截图”功能确保在滚动截图过程中用户不会察觉到页面的滚动。通过截取当前屏幕生成遮罩图覆盖列表，并记录此时的滚动偏移量（yOffsetBefore），便于后续完成滚动截图之后，恢复到之前记录的偏移量，使用户无感知页面变化。</p> <p>为保证截图的完整性，设置完遮罩图后，同样利用scrollTo()方法将列表暂时滚至顶部，确保截图从最顶端开始。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L30-L340" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/ScrollSnapshot.ets</span></li><li><span class="hljs-meta">@Component</span></li><li>export struct ScrollSnapshot {</li><li>  <span class="hljs-comment">// Scroll controller</span></li><li>  <span class="hljs-keyword">private</span> scroller: Scroller = new Scroller();</li><li>  <span class="hljs-keyword">private</span> listComponentWidth: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> listComponentHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The current offset of the List component</span></li><li>  <span class="hljs-keyword">private</span> curYOffset: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> scrollHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The component is overwritten during the screenshot process</span></li><li>  <span class="hljs-meta">@State</span> componentMaskImage: PixelMap | undefined = undefined;</li><li>  <span class="hljs-comment">// The location of the component before backing up the screenshot</span></li><li>  <span class="hljs-keyword">private</span> yOffsetBefore: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * One-click screenshot</span></li><li><span class="hljs-comment">   */</span></li><li>  async onceSnapshot() {</li><li>    await <span class="hljs-keyword">this</span>.beforeSnapshot();</li><li>    await <span class="hljs-keyword">this</span>.snapAndMerge();</li><li>    await <span class="hljs-keyword">this</span>.afterSnapshot();</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Scroll through the screenshots</span></li><li><span class="hljs-comment">   */</span></li><li>  async scrollSnapshot() {</li><li>    <span class="hljs-comment">// The settings list cannot be manually scrolled during the screenshot process</span></li><li>    <span class="hljs-comment">// to avoid interference with the screenshot</span></li><li>    <span class="hljs-keyword">this</span>.isEnableScroll = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// Saves the current location of the component for recovery</span></li><li>    <span class="hljs-keyword">this</span>.yOffsetBefore = <span class="hljs-keyword">this</span>.curYOffset;</li><li>    <span class="hljs-comment">// Set the prompt pop-up to be centered</span></li><li>    await <span class="hljs-keyword">this</span>.scrollSnapAndMerge();</li><li>    <span class="hljs-comment">// Open the prompt pop-up window</span></li><li>    <span class="hljs-keyword">this</span>.isShowPreview = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-comment">// Initial variable after stitching</span></li><li>    await <span class="hljs-keyword">this</span>.afterGeneratorImage();</li><li>    <span class="hljs-keyword">this</span>.isEnableScroll = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.isClickStop = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * One click screenshot loop traversal screenshot and merge</span></li><li><span class="hljs-comment">   */</span></li><li>  async snapAndMerge() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset);</li><li>      <span class="hljs-comment">// Call the component screenshot interface to obtain the current screenshot</span></li><li>      <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>      let area: image.PositionArea =</li><li>        await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>          <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>      <span class="hljs-comment">// Determine whether the bottom has been reached during the loop process</span></li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd()) {</li><li>        CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">200</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>        await CommonUtils.sleep(<span class="hljs-number">200</span>)</li><li>        await <span class="hljs-keyword">this</span>.snapAndMerge();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.mergedImage =</li><li>          await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>            <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>],<span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `snapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Rolling screenshots, looping through screenshots, and merge them</span></li><li><span class="hljs-comment">   */</span></li><li>  async scrollSnapAndMerge() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Record an array of scrolls</span></li><li>      <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset - <span class="hljs-keyword">this</span>.yOffsetBefore);</li><li>      <span class="hljs-comment">// Call the API for taking screenshots to obtain the current screenshots</span></li><li>      <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>      let area: image.PositionArea =</li><li>        await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>          <span class="hljs-keyword">this</span>.listComponentHeight)</li><li>      <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>
</li><li>      <span class="hljs-comment">// During the loop, it is determined whether the bottom is reached, and the user does not stop taking screenshots</span></li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd() &amp;&amp; !<span class="hljs-keyword">this</span>.isClickStop) {</li><li>        <span class="hljs-comment">// Scroll to the next page without scrolling to the end</span></li><li>        CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">1000</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>        await CommonUtils.sleep(<span class="hljs-number">1500</span>);</li><li>        await <span class="hljs-keyword">this</span>.scrollSnapAndMerge();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// After scrolling to the bottom, the buffer obtained by each round of scrolling is spliced</span></li><li>        <span class="hljs-comment">// to generate a long screenshot</span></li><li>        <span class="hljs-keyword">this</span>.mergedImage =</li><li>          await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>            <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>], <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `scrollSnapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  async beforeSnapshot() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.yOffsetBefore = <span class="hljs-keyword">this</span>.curYOffset;</li><li>      <span class="hljs-comment">// Take a screenshot of the loaded List component as a cover image for the List component</span></li><li>      <span class="hljs-keyword">this</span>.componentMaskImage = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-keyword">this</span>.scroller.scrollTo({</li><li>        xOffset: <span class="hljs-number">0</span>,</li><li>        yOffset: <span class="hljs-number">0</span>,</li><li>        animation:</li><li>        {</li><li>          duration: <span class="hljs-number">200</span></li><li>        }</li><li>      });</li><li>      <span class="hljs-comment">// ...</span></li><li>      await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `beforeSnapshot err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>  async afterSnapshot() {</li><li>    <span class="hljs-keyword">this</span>.scroller.scrollTo({</li><li>      xOffset: <span class="hljs-number">0</span>,</li><li>      yOffset: <span class="hljs-keyword">this</span>.yOffsetBefore,</li><li>      animation: {</li><li>        duration: <span class="hljs-number">200</span></li><li>      }</li><li>    });</li><li>    await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>  }</li><li>
</li><li>
</li><li>  async afterGeneratorImage() {</li><li>    <span class="hljs-comment">// Delay for transition animation</span></li><li>    await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>    <span class="hljs-keyword">this</span>.componentMaskImage = undefined;</li><li>    <span class="hljs-keyword">this</span>.scrollYOffsets.length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">this</span>.areaArray.length = <span class="hljs-number">0</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  previewWindowComponent() {</li><li>    Column() {</li><li>      SnapshotPreview({</li><li>        mergedImage: $mergedImage,</li><li>        isShowPreview: $isShowPreview</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  build() {</li><li>    <span class="hljs-comment">// ...</span></li><li>        Stack() {</li><li>          <span class="hljs-comment">//  The masking layer of the screenshot process prevents users from noticing the screen swiping quickly</span></li><li>          <span class="hljs-comment">//  and improves the user experience</span></li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.componentMaskImage) {</li><li>            Image(<span class="hljs-keyword">this</span>.componentMaskImage)</li><li>            <span class="hljs-comment">// ...</span></li><li>          }</li><li>          List({</li><li>            space: <span class="hljs-number">12</span>,</li><li>            scroller: <span class="hljs-keyword">this</span>.scroller</li><li>          })</li><li>          <span class="hljs-comment">// ...</span></li><li>          .id(LIST_ID)</li><li>          .onDidScroll(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.curYOffset = <span class="hljs-keyword">this</span>.scroller.currentOffset().yOffset;</li><li>          })</li><li>          .onAreaChange((oldValue, newValue) =&gt; {</li><li>            <span class="hljs-keyword">this</span>.listComponentWidth = newValue.width <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.listComponentHeight = newValue.height <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.scrollHeight = <span class="hljs-keyword">this</span>.listComponentHeight;</li><li>          })</li><li>          .onClick(() =&gt; {</li><li>            <span class="hljs-comment">// Click on the list to stop scrolling</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isEnableScroll) {</li><li>              <span class="hljs-keyword">this</span>.scroller.scrollBy(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>              <span class="hljs-keyword">this</span>.isClickStop = <span class="hljs-literal">true</span>;</li><li>            }</li><li>          })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .layoutWeight(<span class="hljs-number">1</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">16</span></li><li>        })</li><li>        .bindContentCover($$<span class="hljs-keyword">this</span>.isShowPreview, <span class="hljs-keyword">this</span>.previewWindowComponent(),</li><li>          {</li><li>            modalTransition: ModalTransition.NONE,</li><li>            onWillDismiss: (action: DismissContentCoverAction) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (action.reason === DismissReason.PRESS_BACK) {</li><li>                Logger.info(<span class="hljs-string">'BindContentCover dismiss reason is back pressed'</span>);</li><li>              }</li><li>            }</li><li>          })</li><li>
</li><li>        Row({ space: <span class="hljs-number">12</span> }) {</li><li>          Button($r(<span class="hljs-string">'app.string.one_click_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-keyword">this</span>.onceSnapshot();</li><li>            })</li><li>          Button($r(<span class="hljs-string">'app.string.scroll_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-comment">// Prevent users from clicking the button during the screenshot process,</span></li><li>              <span class="hljs-comment">// and the method is repeatedly called, resulting in an exception</span></li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scrollYOffsets.length === <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-keyword">this</span>.scrollSnapshot();</li><li>              }</li><li>            })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          bottom: (AppStorage.<span class="hljs-keyword">get</span>&lt;number&gt;(<span class="hljs-string">'naviIndicatorHeight'</span>) ?? <span class="hljs-number">0</span>) + <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">12</span></li><li>        })</li><li>      }</li><li>    }</li><li>    .title($r(<span class="hljs-string">'app.string.title_scroll_snapshot'</span>))</li><li>    .backgroundColor($r(<span class="hljs-string">'sys.color.background_secondary'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L30-L340" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> </li><li>循环滚动截图，裁剪和缓存截图数据。<p>3.1 记录每次滚动的位置到数组scrollYOffsets中，并使用componentSnapshot.get(LIST_ID) 方法获取当前画面的截图。</p> <p>3.2 如果非首次截图，则使用crop方法截取从底部滚动进来的区域，然后调用pixmap.readPixelsSync(area)方法将截图数据读取到缓冲区域area中，并将area通过集合进行保存，用于后续截图拼接。</p> <p>3.3 如果页面没有滚动到底部，继续滚动，继续递归调用snapAndMerge()方法进行截图；如果到达底部，则调用mergeImage()方法拼接所有收集到的图像片段，生成完整的长截图；同时还需限制截图的高度，以防过大的截图占用过多内存，影响应用性能，例如这里设置截长截图高度不超过5000。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L104-L132" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * One click screenshot loop traversal screenshot and merge</span></li><li><span class="hljs-comment"> */</span></li><li>async snapAndMerge() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset);</li><li>    <span class="hljs-comment">// Call the component screenshot interface to obtain the current screenshot</span></li><li>    <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>    <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>    let area: image.PositionArea =</li><li>      await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>        <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>    <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>    <span class="hljs-comment">// Determine whether the bottom has been reached during the loop process</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd()) {</li><li>      CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">200</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>      await CommonUtils.sleep(<span class="hljs-number">200</span>)</li><li>      await <span class="hljs-keyword">this</span>.snapAndMerge();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.mergedImage =</li><li>        await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>          <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>],<span class="hljs-keyword">this</span>.listComponentHeight);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `snapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L104-L132" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/ImageUtils.ets#L23-L97" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Read the screenshot PixelMap object into the buffer area</span></li><li><span class="hljs-comment"> * @param {PixelMap} pixelMap - Screenshot PixelMap</span></li><li><span class="hljs-comment"> * @param {number[]} scrollYOffsets - Component scrolls an array of y-axis offsets</span></li><li><span class="hljs-comment"> * @param {number} listWidth - List component width</span></li><li><span class="hljs-comment"> * @param {number} listHeight - List component height</span></li><li><span class="hljs-comment"> * @returns {image.PositionArea} Picture buffer area</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">getSnapshotArea</span>(<span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-variable">pixelMap</span>: <span class="hljs-title class_">PixelMap</span>, <span class="hljs-variable">scrollYOffsets</span>: <span class="hljs-title class_">number</span>[], <span class="hljs-variable">listWidth</span>: <span class="hljs-title class_">number</span>,</li><li>  <span class="hljs-variable">listHeight</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">image</span>.<span class="hljs-title class_">PositionArea</span>&gt; {</li><li>  <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">stride</span> = <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">getBytesNumberPerRow</span>();</li><li>  <span class="hljs-comment">// Get the total number of bytes of image pixels.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">bytesNumber</span> = <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">getPixelBytesNumber</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">ArrayBuffer</span>(<span class="hljs-variable">bytesNumber</span>);</li><li>  <span class="hljs-comment">//     Region size, read based on region.   PositionArea represents the data within the specified area of the image.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">len</span> = <span class="hljs-variable">scrollYOffsets</span>.<span class="hljs-variable">length</span>;</li><li>
</li><li>  <span class="hljs-comment">// Except for the first screenshot, you don't need to crop it, and you need to crop the new parts</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">scrollYOffsets</span>.<span class="hljs-variable">length</span> &gt;= <span class="hljs-number">2</span>) {</li><li>    <span class="hljs-comment">// Realistic roll distance</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">realScrollHeight</span> = <span class="hljs-variable">scrollYOffsets</span>[<span class="hljs-variable">len</span>-<span class="hljs-number">1</span>] - <span class="hljs-variable">scrollYOffsets</span>[<span class="hljs-variable">len</span>-<span class="hljs-number">2</span>];</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">listHeight</span> - <span class="hljs-variable">realScrollHeight</span> &gt; <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">cropRegion</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">Region</span> = {</li><li>        <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-variable">y</span>: <span class="hljs-title class_">uiContext</span>.<span class="hljs-title class_">vp2px</span>(<span class="hljs-variable">listHeight</span> <span class="hljs-variable">- realScrollHeight</span>),</li><li>        <span class="hljs-variable">size</span>: {</li><li>          <span class="hljs-variable">height</span>: <span class="hljs-title class_">uiContext</span>.<span class="hljs-title class_">vp2px</span>(<span class="hljs-title class_">realScrollHeight</span>),</li><li>          <span class="hljs-variable">width</span>: <span class="hljs-title class_">uiContext</span>.<span class="hljs-title class_">vp2px</span>(<span class="hljs-title class_">listWidth</span>)</li><li>        }</li><li>      };</li><li>      <span class="hljs-comment">// Crop roll area</span></li><li>      <span class="hljs-variable">await</span> <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">crop</span>(<span class="hljs-variable">cropRegion</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">area</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PositionArea</span> = {</li><li>    <span class="hljs-variable">pixels</span>: <span class="hljs-title class_">buffer</span>,</li><li>    <span class="hljs-variable">offset</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">stride</span>: <span class="hljs-title class_">stride</span>,</li><li>    <span class="hljs-variable">region</span>: {</li><li>      <span class="hljs-variable">size</span>: {</li><li>        <span class="hljs-variable">width</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-variable">height</span>: <span class="hljs-number">0</span></li><li>      },</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-number">0</span></li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imgInfo</span> = <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">getImageInfoSync</span>();</li><li>    <span class="hljs-comment">// Region size, read based on region. PositionArea represents the data within the specified area of the image.</span></li><li>    <span class="hljs-variable">area</span> = {</li><li>      <span class="hljs-variable">pixels</span>: <span class="hljs-title class_">buffer</span>,</li><li>      <span class="hljs-variable">offset</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">stride</span>: <span class="hljs-title class_">stride</span>,</li><li>      <span class="hljs-variable">region</span>: {</li><li>        <span class="hljs-variable">size</span>: {</li><li>          <span class="hljs-variable">width</span>: <span class="hljs-title class_">imgInfo</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">width</span>,</li><li>          <span class="hljs-variable">height</span>: <span class="hljs-title class_">imgInfo</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">height</span></li><li>        },</li><li>        <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-variable">y</span>: <span class="hljs-number">0</span></li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// Write data to a specified area</span></li><li>    <span class="hljs-variable">pixelMap</span>.<span class="hljs-title function_">readPixelsSync</span>(<span class="hljs-variable">area</span>);</li><li>  } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">error</span> = <span class="hljs-variable">err</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>    <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">getSnapshotArea</span> <span class="hljs-variable">err</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">area</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/ImageUtils.ets#L23-L97" target="_blank">ImageUtils.ets</a></div></div></div></div> </li><li>拼接截图片段。<p>使用image.createPixelMapSync()方法创建长截图longPixelMap，并遍历之前保存的图像片段数据 (this.areaArray)，构建image.PositionArea对象area，然后调用longPixelMap.writePixelsSync(area) 方法将这些片段逐个写入到正确的位置，从而拼接成一个完整的长截图。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/ImageUtils.ets#L117-L165" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Merge image area array into long screenshots</span></li><li><span class="hljs-comment"> * @param {image.PositionArea[]} areaArray - screenshot area</span></li><li><span class="hljs-comment"> * @param {number} lastOffsetY - The offset Y of the last screenshot</span></li><li><span class="hljs-comment"> * @param {number} listWidth - List component width</span></li><li><span class="hljs-comment"> * @param {number} listHeight - List component height</span></li><li><span class="hljs-comment"> * @returns {PixelMap} Long image after merge</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">static</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">mergeImage</span>(<span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span>, <span class="hljs-variable">areaArray</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PositionArea</span>[], <span class="hljs-variable">lastOffsetY</span>: <span class="hljs-title class_">number</span>,</li><li>  <span class="hljs-variable">listHeight</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">PixelMap</span>&gt; {</li><li>  <span class="hljs-comment">// Create a long screenshot PixelMap</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">opts</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">InitializationOptions</span> = {</li><li>    <span class="hljs-variable">editable</span>: <span class="hljs-keyword">true</span>,</li><li>    <span class="hljs-variable">pixelFormat</span>: <span class="hljs-number">4</span>,</li><li>    <span class="hljs-variable">size</span>: {</li><li>      <span class="hljs-comment">// You need to ensure that the width of the PixelMap is greater than the width of the area</span></li><li>      <span class="hljs-variable">width</span>:  <span class="hljs-title class_">ImageUtils</span>.<span class="hljs-title class_">getMaxAreaWidth</span>(<span class="hljs-title class_">areaArray</span>),</li><li>      <span class="hljs-variable">height</span>: <span class="hljs-title class_">uiContext</span>.<span class="hljs-title class_">vp2px</span>(<span class="hljs-variable">lastOffsetY</span> <span class="hljs-variable">+ listHeight</span>)</li><li>    }</li><li>  };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">longPixelMap</span> = <span class="hljs-variable">image</span>.<span class="hljs-title function_">createPixelMapSync</span>(<span class="hljs-variable">opts</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">imgPosition</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>
</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">areaArray</span>.<span class="hljs-title class_">length</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">readArea</span> = <span class="hljs-variable">areaArray</span>[<span class="hljs-variable">i</span>];</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">area</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PositionArea</span> = {</li><li>      <span class="hljs-variable">pixels</span>: <span class="hljs-title class_">readArea</span>.<span class="hljs-title class_">pixels</span>,</li><li>      <span class="hljs-variable">offset</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">stride</span>: <span class="hljs-title class_">readArea</span>.<span class="hljs-title class_">stride</span>,</li><li>      <span class="hljs-variable">region</span>: {</li><li>        <span class="hljs-variable">size</span>: {</li><li>          <span class="hljs-variable">width</span>: <span class="hljs-title class_">readArea</span>.<span class="hljs-title class_">region</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">width</span>,</li><li>          <span class="hljs-variable">height</span>: <span class="hljs-title class_">readArea</span>.<span class="hljs-title class_">region</span>.<span class="hljs-title class_">size</span>.<span class="hljs-title class_">height</span></li><li>        },</li><li>        <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>        <span class="hljs-variable">y</span>: <span class="hljs-title class_">imgPosition</span></li><li>      }</li><li>    }</li><li>    <span class="hljs-variable">imgPosition</span> += <span class="hljs-variable">readArea</span>.<span class="hljs-variable">region</span>.<span class="hljs-variable">size</span>.<span class="hljs-variable">height</span>;</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable">longPixelMap</span>.<span class="hljs-title function_">writePixelsSync</span>(<span class="hljs-variable">area</span>);</li><li>    } <span class="hljs-keyword">catch</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-variable">error</span> = <span class="hljs-variable">err</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">BusinessError</span>;</li><li>      <span class="hljs-variable">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable">TAG</span>, `<span class="hljs-variable">writePixelsSync</span> <span class="hljs-variable">err</span>, <span class="hljs-variable">code</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">error</span>.<span class="hljs-variable">message</span>}`);</li><li>    }</li><li>  }</li><li>  <span class="hljs-keyword">return</span> <span class="hljs-variable">longPixelMap</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/ImageUtils.ets#L117-L165" target="_blank">ImageUtils.ets</a></div></div></div></div> </li><li>恢复到截图前的状态，滚动到截图前的位置。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L197-L207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">afterSnapshot</span>()</span> {</li><li>  <span class="hljs-keyword">this</span>.scroller.scrollTo({</li><li>    xOffset: <span class="hljs-number">0</span>,</li><li>    yOffset: <span class="hljs-keyword">this</span>.yOffsetBefore,</li><li>    animation: {</li><li>      duration: <span class="hljs-number">200</span></li><li>    }</li><li>  });</li><li>  <span class="hljs-keyword">await</span> CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L197-L207" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> </li><li>使用安全控件SaveButton保存截图相册。<p>通过安全控件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-security-components-savebutton" target="_blank">SaveButton</a>结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-photoaccesshelper" target="_blank">photoAccessHelper</a>模块保存截图到相册。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/SnapshotPreview.ets#L132-L147" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">SaveButton</span>({</li><li>  <span class="hljs-variable">icon</span>: <span class="hljs-title class_">SaveIconStyle</span>.<span class="hljs-title class_">FULL_FILLED</span>,</li><li>  <span class="hljs-variable">text</span>: <span class="hljs-title class_">SaveDescription</span>.<span class="hljs-title class_">SAVE_IMAGE</span>,</li><li>  <span class="hljs-variable">buttonType</span>: <span class="hljs-title class_">ButtonType</span>.<span class="hljs-title class_">Capsule</span></li><li>})</li><li><span class="hljs-comment">// ...</span></li><li>  .<span class="hljs-title function_">onClick</span>((<span class="hljs-variable">event</span>, <span class="hljs-variable">result</span>) =&gt; {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">saveSnapshot</span>(<span class="hljs-variable">result</span>);</li><li>  })</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/SnapshotPreview.ets#L132-L147" target="_blank">SnapshotPreview.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/SnapshotPreview.ets#L46-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Save the picture to the album</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> {<span class="hljs-type">SaveButtonOnClickResult</span>} <span class="hljs-variable">result</span> - The security control returns the result</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">saveSnapshot</span>(<span class="hljs-attr">result</span>: <span class="hljs-title class_">SaveButtonOnClickResult</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (result === <span class="hljs-title class_">SaveButtonOnClickResult</span>.<span class="hljs-property">SUCCESS</span>) {</li><li>      <span class="hljs-keyword">const</span> helper = photoAccessHelper.<span class="hljs-title function_">getPhotoAccessHelper</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-keyword">const</span> uri = <span class="hljs-keyword">await</span> helper.<span class="hljs-title function_">createAsset</span>(photoAccessHelper.<span class="hljs-property">PhotoType</span>.<span class="hljs-property">IMAGE</span>, <span class="hljs-string">'png'</span>);</li><li>      <span class="hljs-comment">// Open the file with a URI to write content continuously</span></li><li>      <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">await</span> fileIo.<span class="hljs-title function_">open</span>(uri, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">imagePackerApi</span>: image.<span class="hljs-property">ImagePacker</span> = image.<span class="hljs-title function_">createImagePacker</span>();</li><li>      <span class="hljs-keyword">const</span> <span class="hljs-attr">packOpts</span>: image.<span class="hljs-property">PackingOption</span> = {</li><li>        <span class="hljs-attr">format</span>: <span class="hljs-string">'image/png'</span>,</li><li>        <span class="hljs-attr">quality</span>: <span class="hljs-number">100</span>,</li><li>      };</li><li>      imagePackerApi.<span class="hljs-title function_">packToData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">mergedImage</span>, packOpts).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {</li><li>        fileIo.<span class="hljs-title function_">writeSync</span>(file.<span class="hljs-property">fd</span>, data);</li><li>        fileIo.<span class="hljs-title function_">closeSync</span>(file.<span class="hljs-property">fd</span>);</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Succeeded in packToFile`</span>);</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>          <span class="hljs-attr">message</span>: $r(<span class="hljs-string">'app.string.save_album_success'</span>),</li><li>          <span class="hljs-attr">duration</span>: <span class="hljs-number">1800</span></li><li>        })</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Failed to packToFile. Error code is <span class="hljs-subst">${error.code}</span>, message is <span class="hljs-subst">${error.message}</span>`</span>);</li><li>      });</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`saveSnapshot err, errCode: <span class="hljs-subst">${error.code}</span>, error message: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/SnapshotPreview.ets#L46-L81" target="_blank">SnapshotPreview.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section1620635153411">滚动截图<i class="anchor-icon anchor-icon-link" anchorid="section1620635153411" tips="复制节点链接"></i></h3><p><strong>场景描述</strong></p> <p>此方案允许用户控制长截图的起止位置，增加了使用的灵活性。它适用于大数据量场景，方便用户选择性保存滚动组件中的特定数据。</p> <p><strong>实现效果</strong></p> <p>点击“滚动截图”按钮后，列表将自动滚动。点击列表中的任意条目时，滚动会立即停止，并开始截取从滚动开始到停止这段时间内的数据截图。</p> <p></p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.30320827145868240234108016424644:50001231000000:2800:D0748B04C10A853914A059C86A66E8E23854440DA8751F3165FD2CD08F285F38.gif" title="点击放大" width="266"></span></p> <p><strong>功能实现</strong></p> <p>“滚动截图”功能的实现流程与前述的“一键截图”一样，因此这里不再重复详述整个过程，而仅聚焦于其中的几个关键差异点，例如滚动的控制和偏移量的记录，分别如下面1和2所描述。</p> <ol><li>在截图滚动的过程中，为了防止用户手动滚动对截图产生干扰，应禁用列表的手动滚动功能。可以通过设置List组件的enableScrollInteraction属性来控制是否允许手动滚动。<p>当准备开始截图时，将isEnableScroll设置为false以禁用滚动交互。而当用户点击列表项以确定截图结束位置时，使用scroller.scrollBy(0, 0)方法确保列表立即停止滑动。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L31-L338" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/view/ScrollSnapshot.ets</span></li><li><span class="hljs-meta">@Component</span></li><li>export struct ScrollSnapshot {</li><li>  <span class="hljs-comment">// Scroll controller</span></li><li>  <span class="hljs-keyword">private</span> scroller: Scroller = new Scroller();</li><li>  <span class="hljs-keyword">private</span> listComponentWidth: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> listComponentHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The current offset of the List component</span></li><li>  <span class="hljs-keyword">private</span> curYOffset: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">private</span> scrollHeight: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// The component is overwritten during the screenshot process</span></li><li>  <span class="hljs-meta">@State</span> componentMaskImage: PixelMap | undefined = undefined;</li><li>  <span class="hljs-comment">// The location of the component before backing up the screenshot</span></li><li>  <span class="hljs-keyword">private</span> yOffsetBefore: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// is click to stop scroll</span></li><li>  <span class="hljs-keyword">private</span> isClickStop: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@State</span> isEnableScroll: boolean = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Scroll through the screenshots</span></li><li><span class="hljs-comment">   */</span></li><li>  async scrollSnapshot() {</li><li>    <span class="hljs-comment">// The settings list cannot be manually scrolled during the screenshot process</span></li><li>    <span class="hljs-comment">// to avoid interference with the screenshot</span></li><li>    <span class="hljs-keyword">this</span>.isEnableScroll = <span class="hljs-literal">false</span>;</li><li>    <span class="hljs-comment">// Saves the current location of the component for recovery</span></li><li>    <span class="hljs-keyword">this</span>.yOffsetBefore = <span class="hljs-keyword">this</span>.curYOffset;</li><li>    <span class="hljs-comment">// Set the prompt pop-up to be centered</span></li><li>    await <span class="hljs-keyword">this</span>.scrollSnapAndMerge();</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">this</span>.isEnableScroll = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-keyword">this</span>.isClickStop = <span class="hljs-literal">false</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * One click screenshot loop traversal screenshot and merge</span></li><li><span class="hljs-comment">   */</span></li><li>  async snapAndMerge() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset);</li><li>      <span class="hljs-comment">// Call the component screenshot interface to obtain the current screenshot</span></li><li>      <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>      let area: image.PositionArea =</li><li>        await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>          <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>      <span class="hljs-comment">// Determine whether the bottom has been reached during the loop process</span></li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd()) {</li><li>        CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">200</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>        await CommonUtils.sleep(<span class="hljs-number">200</span>)</li><li>        await <span class="hljs-keyword">this</span>.snapAndMerge();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.mergedImage =</li><li>          await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>            <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>],<span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `snapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Rolling screenshots, looping through screenshots, and merge them</span></li><li><span class="hljs-comment">   */</span></li><li>  async scrollSnapAndMerge() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Record an array of scrolls</span></li><li>      <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset - <span class="hljs-keyword">this</span>.yOffsetBefore);</li><li>      <span class="hljs-comment">// Call the API for taking screenshots to obtain the current screenshots</span></li><li>      <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>      let area: image.PositionArea =</li><li>        await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>          <span class="hljs-keyword">this</span>.listComponentHeight)</li><li>      <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>
</li><li>      <span class="hljs-comment">// During the loop, it is determined whether the bottom is reached, and the user does not stop taking screenshots</span></li><li>      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd() &amp;&amp; !<span class="hljs-keyword">this</span>.isClickStop) {</li><li>        <span class="hljs-comment">// Scroll to the next page without scrolling to the end</span></li><li>        CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">1000</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>        await CommonUtils.sleep(<span class="hljs-number">1500</span>);</li><li>        await <span class="hljs-keyword">this</span>.scrollSnapAndMerge();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// After scrolling to the bottom, the buffer obtained by each round of scrolling is spliced</span></li><li>        <span class="hljs-comment">// to generate a long screenshot</span></li><li>        <span class="hljs-keyword">this</span>.mergedImage =</li><li>          await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>            <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>], <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `scrollSnapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  async beforeSnapshot() {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.yOffsetBefore = <span class="hljs-keyword">this</span>.curYOffset;</li><li>      <span class="hljs-comment">// Take a screenshot of the loaded List component as a cover image for the List component</span></li><li>      <span class="hljs-keyword">this</span>.componentMaskImage = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>      <span class="hljs-keyword">this</span>.scroller.scrollTo({</li><li>        xOffset: <span class="hljs-number">0</span>,</li><li>        yOffset: <span class="hljs-number">0</span>,</li><li>        animation:</li><li>        {</li><li>          duration: <span class="hljs-number">200</span></li><li>        }</li><li>      });</li><li>      <span class="hljs-keyword">this</span>.isShowPreview = <span class="hljs-literal">true</span>;</li><li>      <span class="hljs-comment">// Delay ensures that the scroll has reached the top</span></li><li>      await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>      Logger.error(TAG, `beforeSnapshot err, errCode: ${error.code}, error message: ${error.message}`);</li><li>    }</li><li>  }</li><li>
</li><li>  async afterSnapshot() {</li><li>    <span class="hljs-keyword">this</span>.scroller.scrollTo({</li><li>      xOffset: <span class="hljs-number">0</span>,</li><li>      yOffset: <span class="hljs-keyword">this</span>.yOffsetBefore,</li><li>      animation: {</li><li>        duration: <span class="hljs-number">200</span></li><li>      }</li><li>    });</li><li>    await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>  }</li><li>
</li><li>
</li><li>  async afterGeneratorImage() {</li><li>    <span class="hljs-comment">// Delay for transition animation</span></li><li>    await CommonUtils.sleep(<span class="hljs-number">200</span>);</li><li>    <span class="hljs-keyword">this</span>.componentMaskImage = undefined;</li><li>    <span class="hljs-keyword">this</span>.scrollYOffsets.length = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">this</span>.areaArray.length = <span class="hljs-number">0</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  previewWindowComponent() {</li><li>    Column() {</li><li>      SnapshotPreview({</li><li>        mergedImage: $mergedImage,</li><li>        isShowPreview: $isShowPreview</li><li>      })</li><li>    }</li><li>  }</li><li>
</li><li>  build() {</li><li>    <span class="hljs-comment">// ...</span></li><li>          List({</li><li>            space: <span class="hljs-number">12</span>,</li><li>            scroller: <span class="hljs-keyword">this</span>.scroller</li><li>          })</li><li>          <span class="hljs-comment">// ...</span></li><li>          .id(LIST_ID)</li><li>          .onDidScroll(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.curYOffset = <span class="hljs-keyword">this</span>.scroller.currentOffset().yOffset;</li><li>          })</li><li>          .onAreaChange((oldValue, newValue) =&gt; {</li><li>            <span class="hljs-keyword">this</span>.listComponentWidth = newValue.width <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.listComponentHeight = newValue.height <span class="hljs-keyword">as</span> number;</li><li>            <span class="hljs-keyword">this</span>.scrollHeight = <span class="hljs-keyword">this</span>.listComponentHeight;</li><li>          })</li><li>          .onClick(() =&gt; {</li><li>            <span class="hljs-comment">// Click on the list to stop scrolling</span></li><li>            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isEnableScroll) {</li><li>              <span class="hljs-keyword">this</span>.scroller.scrollBy(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);</li><li>              <span class="hljs-keyword">this</span>.isClickStop = <span class="hljs-literal">true</span>;</li><li>            }</li><li>          })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .layoutWeight(<span class="hljs-number">1</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">16</span></li><li>        })</li><li>        .bindContentCover($$<span class="hljs-keyword">this</span>.isShowPreview, <span class="hljs-keyword">this</span>.previewWindowComponent(),</li><li>          {</li><li>            modalTransition: ModalTransition.NONE,</li><li>            onWillDismiss: (action: DismissContentCoverAction) =&gt; {</li><li>              <span class="hljs-keyword">if</span> (action.reason === DismissReason.PRESS_BACK) {</li><li>                Logger.info(<span class="hljs-string">'BindContentCover dismiss reason is back pressed'</span>);</li><li>              }</li><li>            }</li><li>          })</li><li>
</li><li>        Row({ space: <span class="hljs-number">12</span> }) {</li><li>          Button($r(<span class="hljs-string">'app.string.one_click_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-keyword">this</span>.onceSnapshot();</li><li>            })</li><li>          Button($r(<span class="hljs-string">'app.string.scroll_snapshot'</span>))</li><li>            .layoutWeight(<span class="hljs-number">1</span>)</li><li>            .onClick(() =&gt; {</li><li>              <span class="hljs-comment">// Prevent users from clicking the button during the screenshot process,</span></li><li>              <span class="hljs-comment">// and the method is repeatedly called, resulting in an exception</span></li><li>              <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.scrollYOffsets.length === <span class="hljs-number">0</span>) {</li><li>                <span class="hljs-keyword">this</span>.scrollSnapshot();</li><li>              }</li><li>            })</li><li>        }</li><li>        .width(<span class="hljs-string">'100%'</span>)</li><li>        .padding({</li><li>          left: <span class="hljs-number">16</span>,</li><li>          right: <span class="hljs-number">16</span>,</li><li>          bottom: (AppStorage.<span class="hljs-keyword">get</span>&lt;number&gt;(<span class="hljs-string">'naviIndicatorHeight'</span>) ?? <span class="hljs-number">0</span>) + <span class="hljs-number">16</span>,</li><li>          top: <span class="hljs-number">12</span></li><li>        })</li><li>      }</li><li>    }</li><li>    .title($r(<span class="hljs-string">'app.string.title_scroll_snapshot'</span>))</li><li>    .backgroundColor($r(<span class="hljs-string">'sys.color.background_secondary'</span>))</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L31-L338" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> </li><li>“滚动截图”功能依据当前坐标启动截图过程，因此在记录滚动偏移量时，通过 this.curYOffset - this.yOffsetBefore 来计算相对于初始位置的变化。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L136-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Rolling screenshots, looping through screenshots, and merge them</span></li><li><span class="hljs-comment"> */</span></li><li>async scrollSnapAndMerge() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-comment">// Record an array of scrolls</span></li><li>    <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset - <span class="hljs-keyword">this</span>.yOffsetBefore);</li><li>    <span class="hljs-comment">// Call the API for taking screenshots to obtain the current screenshots</span></li><li>    <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(LIST_ID);</li><li>    <span class="hljs-comment">// Gets the number of bytes per line of image pixels.</span></li><li>    let area: image.PositionArea =</li><li>      await ImageUtils.getSnapshotArea(<span class="hljs-keyword">this</span>.getUIContext(), pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.listComponentWidth,</li><li>        <span class="hljs-keyword">this</span>.listComponentHeight)</li><li>    <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>
</li><li>    <span class="hljs-comment">// During the loop, it is determined whether the bottom is reached, and the user does not stop taking screenshots</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.scroller.isAtEnd() &amp;&amp; !<span class="hljs-keyword">this</span>.isClickStop) {</li><li>      <span class="hljs-comment">// Scroll to the next page without scrolling to the end</span></li><li>      CommonUtils.scrollAnimation(<span class="hljs-keyword">this</span>.scroller, <span class="hljs-number">1000</span>, <span class="hljs-keyword">this</span>.scrollHeight);</li><li>      await CommonUtils.sleep(<span class="hljs-number">1500</span>);</li><li>      await <span class="hljs-keyword">this</span>.scrollSnapAndMerge();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// After scrolling to the bottom, the buffer obtained by each round of scrolling is spliced</span></li><li>      <span class="hljs-comment">// to generate a long screenshot</span></li><li>      <span class="hljs-keyword">this</span>.mergedImage =</li><li>        await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.getUIContext(), <span class="hljs-keyword">this</span>.areaArray,</li><li>          <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>], <span class="hljs-keyword">this</span>.listComponentHeight);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `scrollSnapAndMerge err, errCode: ${error.code}, error message: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/ScrollSnapshot.ets#L136-L169" target="_blank">ScrollSnapshot.ets</a></div></div></div></div> </li><li>与“一键截图”不同，“滚动截图”在执行过程中不使用遮罩层，用户能够直接看到列表的滚动效果。为了确保流畅的视觉体验，在调用 scroller.scrollTo 进行滚动时，添加了动画效果，使得滚动更加自然和顺滑。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/CommonUtils.ets#L22-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-title function_">scrollAnimation</span>(<span class="hljs-variable">scroller</span>: <span class="hljs-title class_">Scroller</span>, <span class="hljs-variable">duration</span>: <span class="hljs-title class_">number</span>, <span class="hljs-variable">scrollHeight</span>: <span class="hljs-title class_">number</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">scroller</span>.<span class="hljs-title function_">scrollTo</span>({</li><li>    <span class="hljs-variable">xOffset</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">yOffset</span>: (<span class="hljs-title class_">scroller</span>.<span class="hljs-title class_">currentOffset</span>().<span class="hljs-variable">yOffset</span> <span class="hljs-variable">+ scrollHeight</span>),</li><li>    <span class="hljs-variable">animation</span>: {</li><li>      <span class="hljs-variable">duration</span>: <span class="hljs-title class_">duration</span>,</li><li>      <span class="hljs-variable">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-title class_">Smooth</span>,</li><li>      <span class="hljs-variable">canOverScroll</span>: <span class="hljs-keyword">false</span></li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/common/CommonUtils.ets#L22-L32" target="_blank">CommonUtils.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section769993903316">Web组件长截图<i class="anchor-icon anchor-icon-link" anchorid="section769993903316" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section338282219482" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section338282219482" tips="复制节点链接"></i></h3><p>Web组件的长截图功能与之前介绍的滚动组件长截图在使用场景上相似，两者均旨在为用户提供快速便捷的数据信息分享和保存方式。主要区别在于，Web组件专门针对网页内容进行截图，确保用户能够完整地捕获和分享浏览的网页信息。</p> </div> <div class="tiledSection"><h3 id="section1132315291487">实现效果<i class="anchor-icon anchor-icon-link" anchorid="section1132315291487" tips="复制节点链接"></i></h3><p>点击“截图”按钮即可完成整个网页的长截图，并可将截图保存至相册。</p> <p><span><img height="545.5261" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163030.22030430589073674237723398386648:50001231000000:2800:FE6C1131004B1499EF0707D9E944CF8E70E80E9FD195C13BDA5E674E22BE6635.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section1718974112481">功能实现<i class="anchor-icon anchor-icon-link" anchorid="section1718974112481" tips="复制节点链接"></i></h3></div> <p>Web组件的长截图可以通过前文介绍的滚动截图方案以及使用WebView提供的webPageSnapshot()方法进行全量截图。本章将重点介绍webPageSnapshot()方法的使用方法，而滚动截图的相关信息已在前文详述。</p> <p><strong>使用滚动截图的方式进行长截图</strong></p> <p>Web组件滚动长截图和滚动组件长截图开发流程大体一样，主要是控制组件的滚动的方法不同。List组件使用的是Scroller，而Web组件使用的是webViewController。</p> <p>在滚动截图过程中，webViewController负责控制Web组件的滚动，通过调用webViewController.scrollBy()方法来实现。为了判断是否已滚动到底部，使用this.webViewController.getPageHeight() 方法获取网页内容的总高度，并将当前偏移量this.curYOffset加上组件自身的高度与网页总高度进行比较。如果两者的和小于网页总高度，则表示尚未触底。</p> <div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshot.ets#L82-L109" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * One click screenshot loop traversal screenshot and merge</span></li><li><span class="hljs-comment"> */</span></li><li>async snapAndMerge() {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.scrollYOffsets.push(<span class="hljs-keyword">this</span>.curYOffset);</li><li>    <span class="hljs-comment">// Call the component screenshot interface to obtain the current screenshot</span></li><li>    <span class="hljs-keyword">const</span> pixelMap = await <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().<span class="hljs-keyword">get</span>(WEB_ID);</li><li>    let area: image.PositionArea =</li><li>      await ImageUtils.getSnapshotArea(pixelMap, <span class="hljs-keyword">this</span>.scrollYOffsets, <span class="hljs-keyword">this</span>.webComponentWidth,</li><li>        <span class="hljs-keyword">this</span>.webComponentHeight);</li><li>    <span class="hljs-keyword">this</span>.areaArray.push(area);</li><li>    <span class="hljs-comment">// Determine whether the bottom has been reached during the loop process</span></li><li>    <span class="hljs-keyword">if</span> (Math.ceil(<span class="hljs-keyword">this</span>.curYOffset + <span class="hljs-keyword">this</span>.webComponentHeight) &lt; <span class="hljs-keyword">this</span>.webviewController.getPageHeight()) {</li><li>      <span class="hljs-comment">// Not scrolling to the bottom, scrolling to the next page</span></li><li>      <span class="hljs-keyword">this</span>.webviewController.scrollBy(<span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.scrollHeight, <span class="hljs-number">500</span>);</li><li>      await CommonUtils.sleep(<span class="hljs-number">600</span>)</li><li>      await <span class="hljs-keyword">this</span>.snapAndMerge();</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.mergedImage =</li><li>        await ImageUtils.mergeImage(<span class="hljs-keyword">this</span>.areaArray, <span class="hljs-keyword">this</span>.scrollYOffsets[<span class="hljs-keyword">this</span>.scrollYOffsets.length - <span class="hljs-number">1</span>],</li><li>          <span class="hljs-keyword">this</span>.webComponentWidth, <span class="hljs-keyword">this</span>.webComponentHeight);</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    let error = err <span class="hljs-keyword">as</span> BusinessError;</li><li>    Logger.error(TAG, `snapAndMerge err, errCode: ${error.code}, error mesage: ${error.message}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshot.ets#L82-L109" target="_blank">WebSnapshot.ets</a></div></div></div></div> <p><strong>使用webPageSnapshot()方法进行网页全量截图</strong></p> <p>此外，Web组件还可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-webview-webviewcontroller#webpagesnapshot12" target="_blank">webPageSnapshot()</a>方法进行网页全量截图，比较适合结构简单、静态元素的页面长截图。如果网页中有动态资源，结构相对复杂，比如有固定的标题头等，推荐上面的滚动长截图方案。使用webPageSnapshot()方法实现长截图的步骤如下：</p> <ol><li>Web初始化，调用enableWholeWebPageDrawing()方法开启网页全量绘制能力。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L33-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">initializeWebEngine</span>();</li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">enableWholeWebPageDrawing</span>();</li><li>    webview.<span class="hljs-property">WebviewController</span>.<span class="hljs-title function_">prepareForPageLoad</span>(<span class="hljs-variable constant_">EXAMPLE_URL</span>, <span class="hljs-literal">true</span>, <span class="hljs-number">2</span>);</li><li>  } <span class="hljs-keyword">catch</span> (err) {</li><li>    <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`web snapshot init err, errCode: <span class="hljs-subst">${error.code}</span>, error mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L33-L42" target="_blank">WebSnapshotWebTag.ets</a></div></div></div></div> </li><li>获取网页内容高度和宽度。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L107-L123" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">getWebSize</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SCRIPT</span> = <span class="hljs-string">'[document.documentElement.scrollWidth, document.documentElement.scrollHeight]'</span>;</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">runJavaScriptExt</span>(<span class="hljs-variable constant_">SCRIPT</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (result.<span class="hljs-title function_">getType</span>() === webview.<span class="hljs-property">JsMessageType</span>.<span class="hljs-property">ARRAY</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Width</span> = (result.<span class="hljs-title function_">getArray</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>[])[<span class="hljs-number">0</span>];</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Height</span> = (result.<span class="hljs-title function_">getArray</span>() <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>[])[<span class="hljs-number">1</span>];</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`h5Width is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.h5Width}</span>, h5Height is <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.h5Height}</span>`</span>);</li><li>      }</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getWebSize exception, errCode: <span class="hljs-subst">${error.code}</span>, error mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getWebSize failed, errCode: <span class="hljs-subst">${err.code}</span>, error mesage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L107-L123" target="_blank">WebSnapshotWebTag.ets</a></div></div></div></div> </li><li>调用webPageSnapshot()方法，进行网页截图。<div class="screenLinkPre"><div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L91-L103" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">async</span> <span class="hljs-title function_">webSnapshot</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">webviewController</span>.<span class="hljs-title function_">webPageSnapshot</span>({ <span class="hljs-attr">id</span>: <span class="hljs-variable constant_">WEB_ID</span>, <span class="hljs-attr">size</span>: { <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Width</span>, <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">h5Height</span> } },</li><li>      <span class="hljs-keyword">async</span> (error, result) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (result) {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-property">longPixelMap</span> = result.<span class="hljs-property">imagePixelMap</span>;</li><li>        }</li><li>      });</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    <span class="hljs-keyword">let</span> err = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`webSnapshot err, errCode: <span class="hljs-subst">${err.code}</span>, error mesage: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice/blob/master/entry/src/main/ets/view/WebSnapshotWebTag.ets#L91-L103" target="_blank">WebSnapshotWebTag.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>加载网络html文件时，需要在entry/src/main路径下的module.json5中配置网络权限。示例代码如下所示：</p> <div _ngcontent-bda-c106="" class="highlight-div"><div _ngcontent-bda-c106="" class="highlight-div-header"><div _ngcontent-bda-c106="" class="highlight-div-header-left"><div _ngcontent-bda-c106="" class="handle-button expand-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-bda-c106="" class="highlight-div-header-right"><div _ngcontent-bda-c106="" class="handle-button ai-button"></div><div _ngcontent-bda-c106="" class="handle-button line-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-bda-c106="" class="handle-button theme-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-bda-c106="" class="handle-button copy-button"><div _ngcontent-bda-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-bda-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li>{</li><li>  <span class="hljs-string">"module"</span>: {</li><li>    <span class="hljs-string">"requestPermissions"</span>: [</li><li>      {</li><li>        <span class="hljs-string">"name"</span>: <span class="hljs-string">"ohos.permission.INTERNET"</span></li><li>      }</li><li>    ]</li><li>  }</li><li>}</li></ol></pre></div></div> </div></div></div> <div class="tiledSection"><h2 id="section1566681910427">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1566681910427" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/LongSnapshotPractice" target="_blank">实现长截图功能</a></li></ul> </div> </div> <div></div></div>