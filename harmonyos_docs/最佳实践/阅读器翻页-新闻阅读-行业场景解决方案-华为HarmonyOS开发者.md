<h1 _ngcontent-qvu-c119="" class="doc-title ng-star-inserted" title="阅读器翻页"> 阅读器翻页 </h1>

<div _ngcontent-qvu-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section101810515578">概述<i class="anchor-icon anchor-icon-link" anchorid="section101810515578" tips="复制节点链接"></i></h2><p>在文本阅读器应用上，翻页时可以使用不同的效果展示页面变更，通常有以下翻页效果：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-reader-page-flip#section1232510531285">上下翻页</a>：向上或向下的滑动效果，适合垂直滚动的文本阅读（如电子书、长篇文章）。</li><li><a href="/consumer/cn/doc/best-practices/bpta-reader-page-flip#section213018591812">覆盖翻页</a>：通过水平滑动使当前页面向左侧滑出显示下一页，上一页从左侧滑入覆盖当前页，形成连贯的过渡效果。</li><li><a href="/consumer/cn/doc/best-practices/bpta-reader-page-flip#section3853128914">仿真翻页</a>：模拟真实纸张的弯曲、翻折动作，例如页面边缘的弧形变形与阴影投影，实现沉浸式的体验效果。</li></ul> <p>本文主要对上述翻页效果的实现进行讲解，旨在帮助开发者了解常见翻页动效开发的流程及实现细节。</p> </div> <div class="tiledSection"><h2 id="section1232510531285">上下翻页<i class="anchor-icon anchor-icon-link" anchorid="section1232510531285" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section467817111137" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section467817111137" tips="复制节点链接"></i></h3><p>上下翻页时，页面内容沿着垂直方向移动。当用户向上滑动时，当前页面内容向上滑出屏幕顶部，同时下一页内容从屏幕底部滑入；向下滑动则相反（当前页向下滑出，上一页从顶部滑入）。实现效果如下：</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.31019749847996951733143405114805:50001231000000:2800:800CAA1AADFAE1153511B56D1B76FA400BEFD5BDD9FB88C2567B955BACCC8724.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section633012318139">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section633012318139" tips="复制节点链接"></i></h3><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List</a>组件作为容器组件，提供上下滑动的能力。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-listitem" target="_blank">ListItem</a>组件存放每一页的内容。页面内容可以自行定义，本文使用Text组件展示文本内容。</p> </div> <div class="tiledSection"><h3 id="section2447142812138">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section2447142812138" tips="复制节点链接"></i></h3><ol><li>构建模拟数据。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/UpDownFlipPage.ets#L24-L42" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/UpDownFlipPage.ets</span></li><li>@<span class="hljs-title function_">Link</span> <span class="hljs-variable">currentPageNum</span>: <span class="hljs-title class_">number</span>;</li><li><span class="hljs-keyword">private</span> <span class="hljs-variable">data</span>: <span class="hljs-title class_">BasicDataSource</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">BasicDataSource</span>([]);</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> <span class="hljs-variable">i</span> = <span class="hljs-variable">Constants</span>.<span class="hljs-variable">PAGE_FLIP_PAGE_START</span>; <span class="hljs-variable">i</span> &lt;= <span class="hljs-title class_">Constants</span>.<span class="hljs-title class_">PAGE_FLIP_PAGE_END</span>; <span class="hljs-title class_">i</span>++) {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">data</span>.<span class="hljs-title function_">pushItem</span>(<span class="hljs-variable">Constants</span>.<span class="hljs-variable">PAGE_FLIP_RESOURCE</span> + <span class="hljs-variable">i</span>.<span class="hljs-title function_">toString</span>());</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/UpDownFlipPage.ets#L24-L42" target="_blank">UpDownFlipPage.ets</a></div></div></div></div> </li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-list" target="_blank">List</a>组件实现上下翻页效果。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/UpDownFlipPage.ets#L46-L73" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/UpDownFlipPage.ets</span></li><li><span class="hljs-title class_">List</span>({ <span class="hljs-attr">initialIndex</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPageNum</span> - <span class="hljs-number">1</span>, <span class="hljs-attr">scroller</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">scroller</span> }) {</li><li>  <span class="hljs-title class_">LazyForEach</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span>, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span></span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">ListItem</span>() {</li><li>      <span class="hljs-title class_">Text</span>($r(item))</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }, <span class="hljs-function">(<span class="hljs-params">item: <span class="hljs-built_in">string</span>, index: <span class="hljs-built_in">number</span></span>) =&gt;</span> index + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(item))</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>.<span class="hljs-title function_">onScrollIndex</span>(<span class="hljs-function">(<span class="hljs-params">firstIndex: <span class="hljs-built_in">number</span></span>) =&gt;</span> {</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPageNum</span> = firstIndex + <span class="hljs-number">1</span>;</li><li>})</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/UpDownFlipPage.ets#L46-L73" target="_blank">UpDownFlipPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section213018591812">覆盖翻页<i class="anchor-icon anchor-icon-link" anchorid="section213018591812" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section182342539154" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section182342539154" tips="复制节点链接"></i></h3><p>覆盖翻页效果模拟卡片切换，新页面（上一页）从屏幕的左侧水平滑入，完全覆盖当前页面。当前页支持从屏幕另一侧滑出，滑出时显示下层新页面。在整个过程中页面没有弯曲或折叠效果，页面作为一个整体平面进行移动。效果如下：</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.49637786897126299849152199078023:50001231000000:2800:BC8EA63ABCDABA1A699CCE852A8926DD060B795F84316C84AD61047B593822C7.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section1196380141613">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1196380141613" tips="复制节点链接"></i></h3><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-stack" target="_blank">Stack</a>堆叠容器，存放1、2、3三个页面，借助图形变换的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-transformation#translate" target="_blank">translate</a>平移属性，将上层页面向左平移屏幕宽度移至窗口左侧。使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>滑动手势事件判断手势滑动方向及平移距离，依据滑动方向及平移距离，执行1页面向右平移滑入屏幕，或2页面向左平移滑出屏幕。滑动手势结束后通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-explicit-animation" target="_blank">显式动画 (animateTo)</a>完成页面平移至窗口边缘，并重新渲染1、2、3页面。</p> <p><span><img height="316.15430000000003" originheight="2065" originwidth="3464" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.78312591910783357726753081292373:50001231000000:2800:930060815477E95D995BC692BEFEA2E436EEA655060386C2BCCEE3251CAE3246.jpg" title="点击放大" width="532"></span></p> </div> <div class="tiledSection"><h3 id="section1234818715162">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section1234818715162" tips="复制节点链接"></i></h3><ol><li>使用Stack堆叠容器存放3个页面，并将上层页面向左平移至屏幕外。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L22-L348" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/CoverFlipPage.ets</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">CoverFlipPage</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">offsetX</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">screenW</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Stack</span>() {</li><li>      <span class="hljs-comment">// Next page.</span></li><li>      <span class="hljs-title function_">ReaderPage</span>({ <span class="hljs-variable">content</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">rightPageContent</span> })</li><li>
</li><li>      <span class="hljs-comment">// Current page.</span></li><li>      <span class="hljs-title function_">ReaderPage</span>({ <span class="hljs-variable">content</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">midPageContent</span> })</li><li>        .<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">offsetX</span> &gt;= <span class="hljs-variable">Constants</span>.<span class="hljs-variable">PAGE_FLIP_ZERO</span> ? <span class="hljs-variable">Constants</span>.<span class="hljs-variable">PAGE_FLIP_ZERO</span> : <span class="hljs-keyword">this</span>.<span class="hljs-title class_">offsetX</span> })</li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-comment">// Previous page, shift the window width to the left.</span></li><li>      <span class="hljs-title function_">ReaderPage</span>({ <span class="hljs-variable">content</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">leftPageContent</span> })</li><li>        .<span class="hljs-title function_">translate</span>({ <span class="hljs-variable">x</span>: -<span class="hljs-keyword">this</span>.<span class="hljs-title class_">screenW</span> + <span class="hljs-keyword">this</span>.<span class="hljs-title class_">offsetX</span> })</li><li>        <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L22-L348" target="_blank">CoverFlipPage.ets</a></div></div></div></div> </li><li>根据滑动手势事件获取平移的距离，修改状态变量offsetX刷新页面，控制页面移动。手势结束后调用自定义方法pageAnimateTo()方法执行显示动画，完成页面剩余滑动。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L197-L282" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/CoverFlipPage.ets</span></li><li>.<span class="hljs-title function_">gesture</span>(</li><li>  <span class="hljs-title class_">PanGesture</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">panOption</span>)</li><li>    .<span class="hljs-title function_">onActionUpdate</span>(<span class="hljs-function">(<span class="hljs-params">event?: GestureEvent</span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">offsetX</span> = event.<span class="hljs-property">offsetX</span>;</li><li>        <span class="hljs-comment">// ...</span></li><li>    })</li><li>    .<span class="hljs-title function_">onActionEnd</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pageAnimateTo</span>(<span class="hljs-literal">false</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>    })</li><li>)</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L197-L282" target="_blank">CoverFlipPage.ets</a></div></div></div></div> </li><li>pageAnimateTo()方法中设置offSetX的结束值，手势向右时offsetX的值为屏幕宽度screenW，手势向左时offsetX的值为负的屏幕宽度-screenW。设置完成后animateTo方法自动插入过渡动画。动画播放结束后，onFinish()完成回调方法中重置offsetX为0，执行自定义方法simulatePageContent()方法更新各内容页ReaderPage组件展示的数据。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L92-L161" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/CoverFlipPage.ets</span></li><li><span class="hljs-keyword">private</span> pageAnimateTo(isClick: boolean, isLeft?: boolean) {</li><li>  <span class="hljs-keyword">this</span>.getUIContext().animateTo({</li><li>    duration: Constants.PAGE_FLIP_TO_AST_DURATION,</li><li>    curve: Curve.EaseOut,</li><li>    onFinish: () =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">this</span>.offsetX = Constants.PAGE_FLIP_ZERO;</li><li>      <span class="hljs-keyword">this</span>.simulatePageContent();</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }, () =&gt; {</li><li>    <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">this</span>.offsetX = <span class="hljs-keyword">this</span>.screenW;</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">this</span>.offsetX = -<span class="hljs-keyword">this</span>.screenW;</li><li>        <span class="hljs-comment">// ...</span></li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/CoverFlipPage.ets#L92-L161" target="_blank">CoverFlipPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section3853128914">仿真翻页<i class="anchor-icon anchor-icon-link" anchorid="section3853128914" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section14105101612167" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section14105101612167" tips="复制节点链接"></i></h3><p>仿真翻页效果模拟真实纸质书的翻页体验。用户拖动页面的角落（右上角或右下角），被拖动的页面会随着手指的移动而卷曲、折叠。在翻动过程中，可以看到当前页的背面（为当前页的翻转显示效果）以及被翻页覆盖的下一页内容逐渐显露出来。翻页轨迹遵循贝塞尔曲线，并伴有阴影效果增强立体感。翻页效果如下：</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.51757411789836732473739983601557:50001231000000:2800:A12B38723237346231C21009282A9A9C2AD9103855B82A5572A993B2D22932FD.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section125994236164">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section125994236164" tips="复制节点链接"></i></h3><p>仿真翻页基于覆盖翻页的页面布局，使用系统接口对当前页或上一页进行截图保存为pixelMap，传递至ArkGraphics 2D的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-drawing" target="_blank">@ohos.graphics.drawing (绘制模块)</a>的相关绘制接口实现了当前页、背页、阴影等区域的绘制。页面绘制通过滑动手势事件<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-gestures-pangesture" target="_blank">PanGesture</a>触发，获取手指在屏幕上的位置，通过该位置信息计算仿真翻页曲线所依赖的相关点位。手势结束时使用定时器模拟滑动触摸的点位并触发页面绘制，判断结束条件终止绘制。</p> <p><strong>仿真翻页绘制实现关键点</strong></p> <ol><li>仿真翻页控制点。仿真翻页可以看做下图三个区域组合而成。要绘制出其中曲线及直线，需要计算出一组特定的坐标点（参考下图），计算公式详见开发步骤。<p><span><img height="553.28" originheight="2517" originwidth="1210" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163344.49504903616331033691444856176498:50001231000000:2800:E765FFAFE01B2B73326EF32EFA9253737752BC8743427F8840D58030554D7F5A.png" title="点击放大" width="266"></span></p> </li><li>曲线绘制。为使用上述坐标点绘制出曲线，需要使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-drawing" target="_blank">@ohos.graphics.drawing (绘制模块)</a>的相关接口实现，如<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-graphics-drawing-path#lineto" target="_blank">Path.lineTo()</a>连接线段；<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-graphics-drawing-path#quadto" target="_blank">Path.quadTo()</a>实现二阶贝塞尔曲线；<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-graphics-drawing-canvas#clippath12" target="_blank">Canvas.clipPath()</a>实现对画布裁剪等。</li><li>内容绘制。仿真翻页绘制的内容来源于使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-componentsnapshot#componentsnapshotgetsync12" target="_blank">@ohos.arkui.componentSnapshot (组件截图)</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-arkui-componentsnapshot#componentsnapshotgetsync12" target="_blank">componentSnapshot.getSync()</a>接口获取的组件截图pixelMap，然后使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-drawing" target="_blank">@ohos.graphics.drawing (绘制模块)</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-graphics-drawing-canvas#drawpixelmapmesh12" target="_blank">Canvas.drawPixelMapMesh()</a>实现绘制。</li><li>阴影效果渲染。主要使用了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-graphics-drawing" target="_blank">@ohos.graphics.drawing (绘制模块)</a>的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-graphics-drawing-shadereffect" target="_blank">ShaderEffect</a>着色器实现。通过为画刷设置着色器效果，并设置相关参数，完成了渐变阴影的绘制。</li></ol> </div> <div class="tiledSection"><h3 id="section78291530141620">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section78291530141620" tips="复制节点链接"></i></h3><ol><li>仿真翻页页面布局<p>仿真翻页页面布局同覆盖翻页大体相同，屏幕区域保留当前页和下一页层叠，上一页向左移出屏幕。不同的是增加NodeContainer组件，在滑动手势事件触发时显示，用于绘制仿真翻页效果，翻页效果结束时隐藏。</p> <div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L103-L141" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li>Stack() {</li><li>  <span class="hljs-comment">// Page area is the same as overlay page cover.</span></li><li>  ReaderPage({ content: <span class="hljs-keyword">this</span>.rightPageContent })</li><li>
</li><li>  ReaderPage({ content: <span class="hljs-keyword">this</span>.midPageContent })</li><li>    .translate({ x: <span class="hljs-keyword">this</span>.offsetX &gt;= Constants.PAGE_FLIP_ZERO ? Constants.PAGE_FLIP_ZERO : <span class="hljs-keyword">this</span>.offsetX })</li><li>    .id(<span class="hljs-string">'middlePage'</span>)<span class="hljs-comment">// Mark the component ID and use it as a screenshot.</span></li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>  ReaderPage({ content: <span class="hljs-keyword">this</span>.leftPageContent })</li><li>    .translate({ x: -<span class="hljs-keyword">this</span>.screenW + <span class="hljs-keyword">this</span>.offsetX })</li><li>    .id(<span class="hljs-string">'leftPage'</span>) <span class="hljs-comment">// Mark the component ID and use it as a screenshot.</span></li><li>
</li><li>  <span class="hljs-comment">// Display when flipping pages, drawing the current or previous page.</span></li><li>  NodeContainer(<span class="hljs-keyword">this</span>.myNodeController)</li><li>    .width(<span class="hljs-keyword">this</span>.getUIContext().px2vp(<span class="hljs-keyword">this</span>.windowWidth))</li><li>    .height(<span class="hljs-keyword">this</span>.getUIContext().px2vp(<span class="hljs-keyword">this</span>.windowHeight))</li><li>    .visibility(<span class="hljs-keyword">this</span>.isNodeShow ? Visibility.Visible : Visibility.None)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L103-L141" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>滑动手势事件<ol><li>滑动手势事件触发时，记录首个点的横纵坐标，作为手势的起始位置，横坐标用于判断手势结束时页面的滑动方向，纵坐标用于判断手势的起始位置，上部、中部或下部，绘制仿真翻页时区分仿真翻页的类型。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L97-L301" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li>build() {</li><li>  <span class="hljs-comment">// ...</span></li><li>  Stack() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .gesture(</li><li>    PanGesture({ fingers: <span class="hljs-number">1</span> })</li><li>      .onActionUpdate((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.panPositionX === <span class="hljs-number">0</span>) {</li><li>          <span class="hljs-keyword">this</span>.initPanPositionX(tmpFingerInfo);</li><li>          <span class="hljs-keyword">return</span>;</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      })</li><li>      <span class="hljs-comment">// ...</span></li><li>  )</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span> initPanPositionX(tmpFingerInfo: FingerInfo): void {</li><li>  <span class="hljs-keyword">this</span>.panPositionX = tmpFingerInfo.localX;</li><li>  let panPositionY = <span class="hljs-keyword">this</span>.getUIContext().vp2px(tmpFingerInfo.localY);</li><li>
</li><li>  <span class="hljs-comment">// Obtain the position of the first touch point and determine the starting area for sliding.</span></li><li>  <span class="hljs-keyword">if</span> (panPositionY &lt; (<span class="hljs-keyword">this</span>.windowHeight / <span class="hljs-number">3</span>)) {</li><li>    <span class="hljs-keyword">this</span>.drawPosition = DrawPosition.DP_TOP;</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (panPositionY &gt;</li><li>    (<span class="hljs-keyword">this</span>.windowHeight * <span class="hljs-number">2</span> / <span class="hljs-number">3</span>)) {</li><li>    <span class="hljs-keyword">this</span>.drawPosition = DrawPosition.DP_BOTTOM;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.drawPosition = DrawPosition.DP_MIDDLE;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L97-L301" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>在onActionUpdate回调中，当检测到第二个触摸点坐标时，与首个点横坐标进行比较。横坐标大于首个点，手势向右，截图上一页，用于绘制上一页的仿真翻页显示在屏幕中覆盖当前页；横坐标小于首个点，手势向左，截图当前页，用于绘制当前页仿真翻页效果露出下一页， 并隐藏当前页。设置NodeContainer组件为显示状态。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L98-L336" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li>build() {</li><li>  <span class="hljs-comment">// ...</span></li><li>  Stack() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .gesture(</li><li>    PanGesture({ fingers: <span class="hljs-number">1</span> })</li><li>      .onActionUpdate((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// Perform a check before starting to draw.</span></li><li>        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isDrawing) {</li><li>          <span class="hljs-comment">// ...</span></li><li>          <span class="hljs-keyword">this</span>.firstDrawingInit(tmpFingerInfo);</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      })</li><li>      <span class="hljs-comment">// ...</span></li><li>  )</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span> firstDrawingInit(tmpFingerInfo: FingerInfo): void {</li><li>  <span class="hljs-comment">// The initial sliding direction of the page is used to determine whether to continue or cancel flipping forward or backward.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.panPositionX &lt; tmpFingerInfo.localX) {</li><li>    <span class="hljs-comment">// When flipping forward, take a screenshot of the previous page, and the flipping type is middle flipping.</span></li><li>    <span class="hljs-keyword">this</span>.pageMoveForward = MoveForward.MF_FORWARD;</li><li>    <span class="hljs-keyword">this</span>.snapPageId = <span class="hljs-string">'leftPage'</span>;</li><li>    <span class="hljs-keyword">this</span>.drawPosition = DrawPosition.DP_MIDDLE</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// When flipping back, take a screenshot of the current page and hide it.</span></li><li>    <span class="hljs-keyword">this</span>.pageMoveForward = MoveForward.MF_BACKWARD;</li><li>    <span class="hljs-keyword">this</span>.snapPageId = <span class="hljs-string">'middlePage'</span>;</li><li>    <span class="hljs-keyword">this</span>.isMiddlePageHide = <span class="hljs-literal">true</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Take a screenshot after confirming the sliding direction of the page.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pagePixelMap) {</li><li>    <span class="hljs-keyword">this</span>.pagePixelMap.release();</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">this</span>.pagePixelMap = <span class="hljs-keyword">this</span>.getUIContext().getComponentSnapshot().getSync(<span class="hljs-keyword">this</span>.snapPageId);</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    hilog.error(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'EmulationFlip'</span>,</li><li>      `getComponentSnapshot().getSync failed. Cause: ${JSON.stringify(error)}`)</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">true</span>;</li><li>  <span class="hljs-keyword">this</span>.isNodeShow = <span class="hljs-literal">true</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L98-L336" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>准备绘制需要的坐标数据，横纵坐标转换为px单位，用于仿真翻页绘制，使用AppStorage保存。比较当前横坐标与上一次的横坐标，判断当前手势的方向，用于手势释放判断页面自动翻页的方向。记录当前横坐标。调用newRectNode()方法更新NodeContainer组件。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L99-L365" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li>build() {</li><li>  <span class="hljs-comment">// ...</span></li><li>  Stack() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .gesture(</li><li>    PanGesture({ fingers: <span class="hljs-number">1</span> })</li><li>      .onActionUpdate((event: GestureEvent) =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-comment">// Execute drawing.</span></li><li>        <span class="hljs-keyword">this</span>.drawing(tmpFingerInfo);</li><li>      })</li><li>      <span class="hljs-comment">// ...</span></li><li>  )</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">private</span> drawing(tmpFingerInfo: FingerInfo): void {</li><li>  <span class="hljs-comment">// Determine the latest sliding direction of the gesture, and after releasing the gesture,</span></li><li>  <span class="hljs-comment">// combine it with the sliding direction of the page to determine whether to flip or cancel.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.panPositionX &lt; tmpFingerInfo.localX) {</li><li>    <span class="hljs-keyword">this</span>.gestureMoveForward = MoveForward.MF_FORWARD;</li><li>    <span class="hljs-keyword">this</span>.panPositionX = tmpFingerInfo.localX;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">this</span>.gestureMoveForward = MoveForward.MF_BACKWARD;</li><li>    <span class="hljs-keyword">this</span>.panPositionX = tmpFingerInfo.localX;</li><li>  }</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'drawState'</span>, DrawState.DS_MOVING);</li><li>
</li><li>  <span class="hljs-comment">// Convert to px units.</span></li><li>  <span class="hljs-keyword">this</span>.positionX = <span class="hljs-keyword">this</span>.getUIContext().vp2px(tmpFingerInfo.localX);</li><li>  <span class="hljs-keyword">this</span>.positionY = <span class="hljs-keyword">this</span>.getUIContext().vp2px(tmpFingerInfo.localY);</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'positionX'</span>, <span class="hljs-keyword">this</span>.positionX);</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'positionY'</span>, <span class="hljs-keyword">this</span>.positionY);</li><li>
</li><li>  <span class="hljs-comment">// Execute drawing.</span></li><li>  <span class="hljs-keyword">this</span>.newRectNode();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L99-L365" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li></ol> </li><li>仿真页面绘制<ol><li>NodeContainer组件控制器清空所有节点，新增渲染节点，渲染节点用于仿真翻页的绘制。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L64-L81" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li><span class="hljs-title function_">newRectNode</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-comment">// Creates a RectRenderNode object.</span></li><li>  <span class="hljs-keyword">const</span> rectNode = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RectRenderNode</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>.<span class="hljs-title function_">clearNodes</span>();</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">myNodeController</span>.<span class="hljs-title function_">addNode</span>(rectNode);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L64-L81" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>在RenderNode进行绘制时，draw()方法会被调用。首先执行初始化init()方法。通过AppStorage获取触摸点的横纵坐标，并判断手势起始位置，计算仿真翻页需要的坐标点以及绘制阴影时需要的相关数值。通过手势触摸点计算页角点A，限制A点纵坐标的范围，从而限制书页的翻起程度。保存点A的纵坐标。各点的计算方法见代码。计算结束后判断当前区域是否还在屏幕区域内，保存判断结果。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L123-L346" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/viewmodel/PageNodeController.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectRenderNode</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">RenderNode</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">draw</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">DrawContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">canvas</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">canvas</span>;</li><li>
</li><li>    <span class="hljs-comment">// Initialize data.</span></li><li>    <span class="hljs-keyword">init</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Initialize data.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-keyword">init</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Obtain touch points.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">x</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionX'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">y</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionY'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-variable">pointA</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyPoint</span>(<span class="hljs-variable">x</span>, <span class="hljs-variable">y</span>);</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">touchPoint</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyPoint</span>(<span class="hljs-variable">x</span>, <span class="hljs-variable">y</span>);</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">drawState</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'drawState'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">drawStartPosition</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'drawPosition'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>
</li><li>  <span class="hljs-comment">// Determine the area where sliding begins.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">DrawPosition</span>.<span class="hljs-variable">DP_TOP</span> === <span class="hljs-variable">drawStartPosition</span>) {</li><li>    <span class="hljs-comment">// The touch point is at the top.</span></li><li>    <span class="hljs-variable">pointF</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyPoint</span>(<span class="hljs-variable">viewWidth</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">drawState</span> !== <span class="hljs-variable">DrawState</span>.<span class="hljs-variable">DS_RELEASE</span>) {</li><li>      <span class="hljs-title function_">calcPointAByTouchPoint</span>(<span class="hljs-variable">touchPoint</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-variable">DrawPosition</span>.<span class="hljs-variable">DP_BOTTOM</span> === <span class="hljs-variable">drawStartPosition</span>) {</li><li>    <span class="hljs-comment">// The touch point is below.</span></li><li>    <span class="hljs-variable">pointF</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">MyPoint</span>(<span class="hljs-variable">viewWidth</span>, <span class="hljs-variable">viewHeight</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">drawState</span> !== <span class="hljs-variable">DrawState</span>.<span class="hljs-variable">DS_RELEASE</span>) {</li><li>      <span class="hljs-title function_">calcPointAByTouchPoint</span>(<span class="hljs-variable">touchPoint</span>);</li><li>    }</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// The touch point is in the middle.</span></li><li>    <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">viewHeight</span> - <span class="hljs-number">1</span>;</li><li>    <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">viewWidth</span>;</li><li>    <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">viewHeight</span>;</li><li>  }</li><li>  <span class="hljs-comment">// Saves the y-coordinate of point A.</span></li><li>  <span class="hljs-variable">AppStorage</span>.<span class="hljs-title class_">setOrCreate</span>&lt;<span class="hljs-title class_">number</span>&gt;(<span class="hljs-string">'flipPositionY'</span>, <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>);</li><li>
</li><li>  <span class="hljs-comment">// Calculate all path points.</span></li><li>  <span class="hljs-title function_">calcPointsXY</span>();</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Calculate the y-coordinate of point A based on the touch point.</span></li><li><span class="hljs-comment"> * @param touchPoint Touch point.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">calcPointAByTouchPoint</span>(<span class="hljs-variable">touchPoint</span>: <span class="hljs-title class_">MyPoint</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">r</span> = <span class="hljs-variable">Constants</span>.<span class="hljs-variable">SIXTY_PERCENT</span> * <span class="hljs-variable">viewWidth</span>;</li><li>  <span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">x</span>;</li><li>
</li><li>  <span class="hljs-comment">// Reset the y value and restrict the region where the y value is located.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> === <span class="hljs-variable">viewHeight</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tmpY</span> = <span class="hljs-variable">viewHeight</span> - <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-variable">r</span>, <span class="hljs-number">2</span>) - <span class="hljs-variable">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">x</span> - (<span class="hljs-variable">viewWidth</span> - <span class="hljs-variable">r</span>), <span class="hljs-number">2</span>)))</li><li>    <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">y</span> &gt;= <span class="hljs-variable">tmpY</span> ? <span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">y</span> : <span class="hljs-title class_">tmpY</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">tmpY</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">sqrt</span>(<span class="hljs-variable">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-variable">r</span>, <span class="hljs-number">2</span>) - <span class="hljs-variable">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">x</span> - (<span class="hljs-variable">viewWidth</span> - <span class="hljs-variable">r</span>), <span class="hljs-number">2</span>)))</li><li>    <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">touchPoint</span>.<span class="hljs-variable">y</span> &gt;= <span class="hljs-variable">tmpY</span> ? <span class="hljs-variable">tmpY</span> : <span class="hljs-title class_">touchPoint</span>.<span class="hljs-title class_">y</span>;</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Calculate the coordinates of each path point.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">calcPointsXY</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-variable">pointG</span>.<span class="hljs-variable">x</span> = (<span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span>) / <span class="hljs-number">2</span>;</li><li>  <span class="hljs-variable">pointG</span>.<span class="hljs-variable">y</span> = (<span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>) / <span class="hljs-number">2</span>;</li><li>
</li><li>  <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">pointG</span>.<span class="hljs-variable">x</span> - (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">y</span>) * (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">y</span>) / (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">x</span>);</li><li>  <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>;</li><li>
</li><li>  <span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span>;</li><li>  <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">pointG</span>.<span class="hljs-variable">y</span> - (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">x</span>) * (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">x</span>) / (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointG</span>.<span class="hljs-variable">y</span>);</li><li>
</li><li>  <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> - (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>) / <span class="hljs-number">2</span>;</li><li>  <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>;</li><li>
</li><li>  <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">x</span> = <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span>;</li><li>  <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">y</span> = <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> - (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span>) / <span class="hljs-number">2</span>;</li><li>
</li><li>  <span class="hljs-variable">pointB</span> = <span class="hljs-title function_">getIntersectionPoint</span>(<span class="hljs-variable">pointA</span>, <span class="hljs-variable">pointE</span>, <span class="hljs-variable">pointC</span>, <span class="hljs-variable">pointJ</span>);</li><li>  <span class="hljs-variable">pointK</span> = <span class="hljs-title function_">getIntersectionPoint</span>(<span class="hljs-variable">pointA</span>, <span class="hljs-variable">pointH</span>, <span class="hljs-variable">pointC</span>, <span class="hljs-variable">pointJ</span>);</li><li>
</li><li>  <span class="hljs-variable">pointD</span>.<span class="hljs-variable">x</span> = (<span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span> + <span class="hljs-number">2</span> * <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">pointB</span>.<span class="hljs-variable">x</span>) / <span class="hljs-number">4</span>;</li><li>  <span class="hljs-variable">pointD</span>.<span class="hljs-variable">y</span> = (<span class="hljs-number">2</span> * <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">pointB</span>.<span class="hljs-variable">y</span>) / <span class="hljs-number">4</span>;</li><li>
</li><li>  <span class="hljs-variable">pointI</span>.<span class="hljs-variable">x</span> = (<span class="hljs-variable">pointJ</span>.<span class="hljs-variable">x</span> + <span class="hljs-number">2</span> * <span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">pointK</span>.<span class="hljs-variable">x</span>) / <span class="hljs-number">4</span>;</li><li>  <span class="hljs-variable">pointI</span>.<span class="hljs-variable">y</span> = (<span class="hljs-number">2</span> * <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">pointK</span>.<span class="hljs-variable">y</span>) / <span class="hljs-number">4</span>;</li><li>
</li><li>  <span class="hljs-comment">//Calculate the distance from point d to line ae and use it to draw shadows.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">lA</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">lB</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">lC</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span> * <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> * <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-variable">lPathAShadowDis</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>((<span class="hljs-variable">lA</span> * <span class="hljs-variable">pointD</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">lB</span> * <span class="hljs-variable">pointD</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">lC</span>) / <span class="hljs-variable">Math</span>.<span class="hljs-title function_">hypot</span>(<span class="hljs-variable">lA</span>, <span class="hljs-variable">lB</span>));</li><li>
</li><li>  <span class="hljs-comment">// Calculate the distance from point i to ah and use it to draw shadows.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rA</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rB</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rC</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span> * <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span> * <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-variable">rPathAShadowDis</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">abs</span>((<span class="hljs-variable">rA</span> * <span class="hljs-variable">pointI</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">rB</span> * <span class="hljs-variable">pointI</span>.<span class="hljs-variable">y</span> + <span class="hljs-variable">rC</span>) / <span class="hljs-variable">Math</span>.<span class="hljs-title function_">hypot</span>(<span class="hljs-variable">rA</span>, <span class="hljs-variable">rB</span>));</li><li>
</li><li>  <span class="hljs-comment">// Check if the drawing area is still in the window. If it is not in the window, the drawing ends.</span></li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">checkDrawingAreaInWindow</span>()) {</li><li>    <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isFinished'</span>, <span class="hljs-keyword">true</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L123-L346" target="_blank">PageNodeController.ets</a></div></div></div></div> </li><li>绘制下一页上的阴影。使用上一步计算的相关数值，配置绘制阴影所需的着色器shaderEffect，使用canvas及画刷绘制阴影。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L124-L783" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/viewmodel/PageNodeController.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectRenderNode</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">RenderNode</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">draw</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">DrawContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">canvas</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">canvas</span>;</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Draw the shadow shown on the next page.</span></li><li>    <span class="hljs-title function_">drawPathBShadow</span>(<span class="hljs-variable">canvas</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Draw the shadow shown on the next page.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param canvas canvas</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">drawPathBShadow</span>(<span class="hljs-variable">canvas</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Canvas</span>) {</li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">save</span>()</li><li>  <span class="hljs-comment">// Gradient color array.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">deepColor</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0xff111111</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">lightColor</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0x00111111</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">gradientColors</span>: <span class="hljs-title class_">number</span>[] = [<span class="hljs-variable">deepColor</span>, <span class="hljs-variable">lightColor</span>];</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>
</li><li>  <span class="hljs-comment">// The distance from A to F.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">aToF</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">hypot</span>((<span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span>), (<span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>));</li><li>  <span class="hljs-comment">// The distance from A to F.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">viewDiagonalLength</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">hypot</span>(<span class="hljs-variable">viewWidth</span>, <span class="hljs-variable">viewHeight</span>);</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">left</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">right</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">top</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">bottom</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">viewDiagonalLength</span> + <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span>;</li><li>
</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> === <span class="hljs-variable">viewWidth</span> &amp;&amp; <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> === <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-comment">// The F point is located in the upper right corner.</span></li><li>    <span class="hljs-variable">left</span> = <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span>;</li><li>    <span class="hljs-variable">right</span> = <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span> + <span class="hljs-variable">aToF</span> / <span class="hljs-number">4</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">left</span> = <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">aToF</span> / <span class="hljs-number">4</span>;</li><li>    <span class="hljs-variable">right</span> = <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span>;</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Calculate the rotation angle between two points (calculated in radians and converted into angles).</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">deltaX</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">deltaY</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">radians</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">atan2</span>(<span class="hljs-variable">deltaY</span>, <span class="hljs-variable">deltaX</span>);</li><li>  <span class="hljs-comment">// Convert radians to angles.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rotateDegrees</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">radians</span> * <span class="hljs-number">180</span> / <span class="hljs-variable">Math</span>.<span class="hljs-variable">PI</span>;</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">startPt</span>: <span class="hljs-title class_">common2D</span>.<span class="hljs-title class_">Point</span> = { <span class="hljs-variable">x</span>: <span class="hljs-title class_">pointF</span>.<span class="hljs-title class_">y</span> === <span class="hljs-number">0</span> ? <span class="hljs-variable">right</span> : <span class="hljs-title class_">left</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">top</span> };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">endPt</span>: <span class="hljs-title class_">common2D</span>.<span class="hljs-title class_">Point</span> = { <span class="hljs-variable">x</span>: <span class="hljs-title class_">pointF</span>.<span class="hljs-title class_">y</span> === <span class="hljs-number">0</span> ? <span class="hljs-variable">left</span> : <span class="hljs-title class_">right</span>, <span class="hljs-variable">y</span>: <span class="hljs-title class_">top</span> };</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">shaderEffect</span> = <span class="hljs-variable">drawing</span>.<span class="hljs-variable">ShaderEffect</span>.<span class="hljs-title function_">createLinearGradient</span>(<span class="hljs-variable">endPt</span>, <span class="hljs-variable">startPt</span>, <span class="hljs-variable">gradientColors</span>, <span class="hljs-variable">drawing</span>.<span class="hljs-variable">TileMode</span>.<span class="hljs-variable">MIRROR</span>);</li><li>
</li><li>  <span class="hljs-comment">// Perform rotation.</span></li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">rotate</span>(<span class="hljs-variable">rotateDegrees</span>, <span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span>);</li><li>
</li><li>  <span class="hljs-comment">// Draw shadows.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">rect</span>: <span class="hljs-title class_">common2D</span>.<span class="hljs-title class_">Rect</span> = {</li><li>    <span class="hljs-variable">left</span>: <span class="hljs-title class_">left</span>,</li><li>    <span class="hljs-variable">top</span>: <span class="hljs-title class_">top</span>,</li><li>    <span class="hljs-variable">right</span>: <span class="hljs-title class_">right</span>,</li><li>    <span class="hljs-variable">bottom</span>: <span class="hljs-title class_">bottom</span></li><li>  };</li><li>  <span class="hljs-title function_">drawShadow</span>(<span class="hljs-variable">canvas</span>, <span class="hljs-variable">shaderEffect</span>, <span class="hljs-variable">rect</span>);</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Draw shaded areas.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param canvas canvas</span></li><li><span class="hljs-comment"> * @param shaderEffect shader effect</span></li><li><span class="hljs-comment"> * @param rect rect</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">drawShadow</span>(<span class="hljs-variable">canvas</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Canvas</span>, <span class="hljs-variable">shaderEffect</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">ShaderEffect</span>, <span class="hljs-variable">rect</span>: <span class="hljs-title class_">common2D</span>.<span class="hljs-title class_">Rect</span>) {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">tmpBrush</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Brush</span>();</li><li>  <span class="hljs-variable">tmpBrush</span>.<span class="hljs-title function_">setShaderEffect</span>(<span class="hljs-variable">shaderEffect</span>);</li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachBrush</span>(<span class="hljs-variable">tmpBrush</span>);</li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawRect</span>(<span class="hljs-variable">rect</span>.<span class="hljs-variable">left</span>, <span class="hljs-variable">rect</span>.<span class="hljs-variable">top</span>, <span class="hljs-variable">rect</span>.<span class="hljs-variable">right</span>, <span class="hljs-variable">rect</span>.<span class="hljs-variable">bottom</span>);</li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">detachBrush</span>();</li><li>  <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">restore</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L124-L783" target="_blank">PageNodeController.ets</a></div></div></div></div> </li><li>绘制仿真翻页背面内容及阴影。首先根据计算出的绘制曲线依赖的点，规划处背面区域pathC ，使用clipPath()方法裁剪出该区域。为绘制区域设置旋转矩阵，实现将截图获取的页面pixelMap，旋转并翻转成需要的背页效果。最后绘制背页区域的阴影，此处阴影计算的算法同上一步。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L125-L453" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/viewmodel/PageNodeController.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectRenderNode</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">RenderNode</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">draw</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">DrawContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">canvas</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">canvas</span>;</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Draw the back area for flipping pages.</span></li><li>    <span class="hljs-title function_">drawPathC</span>(<span class="hljs-variable">canvas</span>);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Draw the back area for flipping pages.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param canvas canvas</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">drawPathC</span>(<span class="hljs-variable">canvas</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Canvas</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Graphics.Drawing'</span>)) {</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachBrush</span>(<span class="hljs-variable">pathABrush</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">reset</span>();</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">moveTo</span>(<span class="hljs-variable">pointI</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointI</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointD</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointD</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointB</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointB</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointK</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointK</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">pathC</span>.<span class="hljs-title function_">close</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawPath</span>(<span class="hljs-variable">pathC</span>);</li><li>
</li><li>    <span class="hljs-comment">// Draw the content on the back.</span></li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">save</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">clipPath</span>(<span class="hljs-variable">pathC</span>);</li><li>
</li><li>    <span class="hljs-comment">// Set the inversion and rotation matrices.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">eh</span> = <span class="hljs-variable">Math</span>.<span class="hljs-title function_">hypot</span>(<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">sin0</span> = (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> - <span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>) / <span class="hljs-variable">eh</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">cos0</span> = (<span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span> - <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span>) / <span class="hljs-variable">eh</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">value</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">number</span>&gt; = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1.0</span>];</li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">0</span>] = -(<span class="hljs-number">1</span> - <span class="hljs-number">2</span> * <span class="hljs-variable">sin0</span> * <span class="hljs-variable">sin0</span>);</li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">1</span>] = <span class="hljs-number">2</span> * <span class="hljs-variable">sin0</span> * <span class="hljs-variable">cos0</span>;</li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">3</span>] = <span class="hljs-number">2</span> * <span class="hljs-variable">sin0</span> * <span class="hljs-variable">cos0</span>;</li><li>    <span class="hljs-variable">value</span>[<span class="hljs-number">4</span>] = <span class="hljs-number">1</span> - <span class="hljs-number">2</span> * <span class="hljs-variable">sin0</span> * <span class="hljs-variable">sin0</span>;</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">matrix</span> = <span class="hljs-variable">new</span> <span class="hljs-variable">drawing</span>.<span class="hljs-title function_">Matrix</span>();</li><li>    <span class="hljs-variable">matrix</span>.<span class="hljs-title function_">reset</span>();</li><li>    <span class="hljs-variable">matrix</span>.<span class="hljs-title function_">setMatrix</span>(<span class="hljs-variable">value</span>);</li><li>    <span class="hljs-variable">matrix</span>.<span class="hljs-title function_">preTranslate</span>(-<span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>, -<span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">matrix</span>.<span class="hljs-title function_">postTranslate</span>(<span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">concatMatrix</span>(<span class="hljs-variable">matrix</span>);</li><li>
</li><li>    <span class="hljs-comment">// Draw the current page on the back.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pagePixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'pagePixelMap'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">image</span>.<span class="hljs-variable">PixelMap</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">verts</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">number</span>&gt; = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">viewWidth</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">viewHeight</span>, <span class="hljs-variable">viewWidth</span>, <span class="hljs-variable">viewHeight</span>];</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawPixelMapMesh</span>(<span class="hljs-variable">pagePixelMap</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">verts</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">null</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">restore</span>();</li><li>
</li><li>    <span class="hljs-comment">// Change the color on the back.</span></li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">detachBrush</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachBrush</span>(<span class="hljs-variable">pathCBrush</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawPath</span>(<span class="hljs-variable">pathC</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">detachBrush</span>();</li><li>
</li><li>    <span class="hljs-comment">// Draw shadows in the back area.</span></li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">save</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">clipPath</span>(<span class="hljs-variable">pathC</span>);</li><li>    <span class="hljs-title function_">drawPathCShadow</span>(<span class="hljs-variable">canvas</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">restore</span>();</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L125-L453" target="_blank">PageNodeController.ets</a></div></div></div></div> </li><li>绘制页面左侧文字区域及阴影。根据计算出的绘制曲线依赖的点，规划处背面区域pathA，裁剪出该区域。将截图保存的页面pixelMap绘制在该区域，并绘制该区域的阴影。完成仿真翻页的绘制。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L126-L487" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/viewmodel/PageNodeController.ets</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RectRenderNode</span> <span class="hljs-variable">extends</span> <span class="hljs-variable">RenderNode</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">draw</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">DrawContext</span>): <span class="hljs-title class_">void</span> {</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-variable">canvas</span> = <span class="hljs-variable">context</span>.<span class="hljs-variable">canvas</span>;</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-comment">// Retrieve the cropped area of the current page.</span></li><li>    <span class="hljs-title function_">getPathA</span>();</li><li>
</li><li>    <span class="hljs-comment">// Draw the current page area.</span></li><li>    <span class="hljs-title function_">drawPathAContent</span>(<span class="hljs-variable">canvas</span>);</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Retrieve the cropped area of the current page.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">getPathA</span>(): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Graphics.Drawing'</span>)) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-comment">// Point F is located in the upper right corner, calculate pathA.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> === <span class="hljs-variable">viewWidth</span> &amp;&amp; <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">reset</span>();</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">quadTo</span>(<span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span>, <span class="hljs-variable">pointB</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointB</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointK</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointK</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">quadTo</span>(<span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span>, <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">viewWidth</span>, <span class="hljs-variable">viewHeight</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">viewHeight</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">close</span>();</li><li>    }</li><li>    <span class="hljs-comment">// Point F is located in the bottom right corner, calculate pathA.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">pointF</span>.<span class="hljs-variable">x</span> === <span class="hljs-variable">viewWidth</span> &amp;&amp; <span class="hljs-variable">pointF</span>.<span class="hljs-variable">y</span> === <span class="hljs-variable">viewHeight</span>) {</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">reset</span>();</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-number">0</span>, <span class="hljs-variable">viewHeight</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointC</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointC</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">quadTo</span>(<span class="hljs-variable">pointE</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointE</span>.<span class="hljs-variable">y</span>, <span class="hljs-variable">pointB</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointB</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointA</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointA</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">pointK</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointK</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">quadTo</span>(<span class="hljs-variable">pointH</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointH</span>.<span class="hljs-variable">y</span>, <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">x</span>, <span class="hljs-variable">pointJ</span>.<span class="hljs-variable">y</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">lineTo</span>(<span class="hljs-variable">viewWidth</span>, <span class="hljs-number">0</span>);</li><li>      <span class="hljs-variable">pathA</span>.<span class="hljs-title function_">close</span>();</li><li>    }</li><li>  }</li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Draw the current page area.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * @param canvas canvas</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-variable">function</span> <span class="hljs-title function_">drawPathAContent</span>(<span class="hljs-variable">canvas</span>: <span class="hljs-title class_">drawing</span>.<span class="hljs-title class_">Canvas</span>): <span class="hljs-title class_">void</span> {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">canIUse</span>(<span class="hljs-string">'SystemCapability.Graphics.Drawing'</span>)) {</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">attachBrush</span>(<span class="hljs-variable">pathABrush</span>);</li><li>
</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">save</span>();</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">clipPath</span>(<span class="hljs-variable">pathA</span>);</li><li>
</li><li>    <span class="hljs-comment">// Obtain a screenshot pixelMap for displaying the current page.</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">pagePixelMap</span>: <span class="hljs-title class_">image</span>.<span class="hljs-title class_">PixelMap</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'pagePixelMap'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">image</span>.<span class="hljs-variable">PixelMap</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewWidth</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">viewHeight</span>: <span class="hljs-title class_">number</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-variable">number</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">verts</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">number</span>&gt; = [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">viewWidth</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">viewHeight</span>, <span class="hljs-variable">viewWidth</span>, <span class="hljs-variable">viewHeight</span>];</li><li>    <span class="hljs-comment">// Execute drawing.</span></li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">drawPixelMapMesh</span>(<span class="hljs-variable">pagePixelMap</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-variable">verts</span>, <span class="hljs-number">0</span>, <span class="hljs-variable">null</span>, <span class="hljs-number">0</span>);</li><li>    <span class="hljs-variable">canvas</span>.<span class="hljs-title function_">restore</span>();</li><li>
</li><li>    <span class="hljs-comment">// Draw the shadow of the current page.</span></li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'drawPosition'</span>) === <span class="hljs-variable">DrawPosition</span>.<span class="hljs-variable">DP_MIDDLE</span>) {</li><li>      <span class="hljs-title function_">drawPathAHorizontalShadow</span>(<span class="hljs-variable">canvas</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-title function_">drawPathALeftShadow</span>(<span class="hljs-variable">canvas</span>);</li><li>      <span class="hljs-title function_">drawPathARightShadow</span>(<span class="hljs-variable">canvas</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/viewmodel/PageNodeController.ets#L126-L487" target="_blank">PageNodeController.ets</a></div></div></div></div> </li></ol> </li><li>滑动手势结束。滑动手势结束后获取最后一次绘制的页角A点的纵坐标。判断当前手势的移动方向，设置自动绘制的步进值。使用定时器执行自动绘制。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L100-L425" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li>build() {</li><li>  <span class="hljs-comment">// ...</span></li><li>  Stack() {</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  .gesture(</li><li>    PanGesture({ fingers: <span class="hljs-number">1</span> })</li><li>    <span class="hljs-comment">// ...</span></li><li>      .onActionEnd(() =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>
</li><li>        <span class="hljs-comment">// Perform automatic sliding.</span></li><li>        <span class="hljs-keyword">this</span>.autoFlipPage();</li><li>        <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;</li><li>      })</li><li>  )</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Perform automatic drawing.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">private</span> autoFlipPage(): void {</li><li>  AppStorage.<span class="hljs-keyword">set</span>(<span class="hljs-string">'drawState'</span>, DrawState.DS_RELEASE);</li><li>  <span class="hljs-comment">// Get the vertical axis of the drawn footer.</span></li><li>  AppStorage.setOrCreate(<span class="hljs-string">'positionY'</span>, (AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'flipPositionY'</span>) <span class="hljs-keyword">as</span> number));</li><li>  let num: number = Constants.DISTANCE_FRACTION;</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.gestureMoveForward === MoveForward.MF_FORWARD) {</li><li>    <span class="hljs-comment">// Page forward to calculate diff.</span></li><li>    let xDiff = (<span class="hljs-keyword">this</span>.windowWidth - <span class="hljs-keyword">this</span>.positionX) / num;</li><li>    let yDiff = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.drawPosition === DrawPosition.DP_BOTTOM) {</li><li>      yDiff = (<span class="hljs-keyword">this</span>.windowHeight - <span class="hljs-keyword">this</span>.positionY) / num;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      yDiff = (<span class="hljs-number">0</span> - <span class="hljs-keyword">this</span>.positionY) / num;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">this</span>.setTimer(xDiff, yDiff, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.newRectNode();</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// Next Page.</span></li><li>    <span class="hljs-keyword">this</span>.setTimer(Constants.FLIP_X_DIFF, <span class="hljs-number">0</span>, () =&gt; {</li><li>      <span class="hljs-keyword">this</span>.newRectNode();</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L100-L425" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>自动绘制翻页动效<ol><li>根据最后手势的移动方向，页面需要自动向右侧还原，或向左侧翻页。根据上一步获取的步进值，计算新的触摸点，执行新的绘制。并使用定时器更新触摸点。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L505-L549" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setTimer</span>(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, yDiff: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>  <span class="hljs-comment">// Automatically flip forward.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">gestureMoveForward</span> === <span class="hljs-title class_">MoveForward</span>.<span class="hljs-property">MF_FORWARD</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeID</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, yDiff: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> x = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionX'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span> + xDiff;</li><li>      <span class="hljs-keyword">let</span> y = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionY'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span> + yDiff;</li><li>      <span class="hljs-comment">// Page forward termination condition.</span></li><li>      <span class="hljs-keyword">if</span> (x &gt;= (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) - <span class="hljs-number">1</span> || y &gt;= (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) ||</li><li>        y &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishLastGesture</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'positionX'</span>, x);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'positionY'</span>, y);</li><li>        <span class="hljs-title function_">drawNode</span>();</li><li>      }</li><li>    }, <span class="hljs-title class_">Constants</span>.<span class="hljs-property">TIMER_DURATION</span>, xDiff, yDiff, drawNode);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// Automatically flip backwards.</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isFinished'</span>, <span class="hljs-literal">false</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeID</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, _: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">let</span> x = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionX'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span> + xDiff;</li><li>      <span class="hljs-keyword">let</span> y = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'positionY'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>      <span class="hljs-comment">// Obtain the termination condition for determining when flipping back to draw.</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">isFinished</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'isFinished'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;</li><li>      <span class="hljs-keyword">if</span> (isFinished) {</li><li>        <span class="hljs-comment">// End automatic drawing.</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishLastGesture</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'positionX'</span>, x);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'positionY'</span>, y);</li><li>        <span class="hljs-title function_">drawNode</span>();</li><li>      }</li><li>    }, <span class="hljs-title class_">Constants</span>.<span class="hljs-property">TIMER_DURATION</span>, xDiff, yDiff, drawNode);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L505-L549" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li><li>定时器中增加绘制结束条件判断，页面向右侧还原时使用触摸的横纵坐标判断，页面向左翻页使用计算曲线关键点时判断绘制区域是否还在屏幕内存储的结果。执行finishLastGesture()结束绘制。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L506-L550" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setTimer</span>(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, yDiff: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) {</li><li>  <span class="hljs-comment">// Automatically flip forward.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">gestureMoveForward</span> === <span class="hljs-title class_">MoveForward</span>.<span class="hljs-property">MF_FORWARD</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeID</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, yDiff: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// Page forward termination condition.</span></li><li>      <span class="hljs-keyword">if</span> (x &gt;= (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowWidth'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) - <span class="hljs-number">1</span> || y &gt;= (<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'windowHeight'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>) ||</li><li>        y &lt;= <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishLastGesture</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    }, <span class="hljs-title class_">Constants</span>.<span class="hljs-property">TIMER_DURATION</span>, xDiff, yDiff, drawNode);</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// Automatically flip backwards.</span></li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isFinished'</span>, <span class="hljs-literal">false</span>);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">timeID</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">(<span class="hljs-params">xDiff: <span class="hljs-built_in">number</span>, _: <span class="hljs-built_in">number</span>, drawNode: () =&gt; <span class="hljs-built_in">void</span></span>) =&gt;</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-comment">// Obtain the termination condition for determining when flipping back to draw.</span></li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">isFinished</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'isFinished'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;</li><li>      <span class="hljs-keyword">if</span> (isFinished) {</li><li>        <span class="hljs-comment">// End automatic drawing.</span></li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">finishLastGesture</span>();</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    }, <span class="hljs-title class_">Constants</span>.<span class="hljs-property">TIMER_DURATION</span>, xDiff, yDiff, drawNode);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L506-L550" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li></ol> </li><li>动效结束更新内容页。判断动效结束后，清空定时器，根据页面初始移动方向及最后的手势移动方向更新页面内容，重新绘制页面。重置相关手势、绘制过程的状态变量。此时结束一次仿真翻页的绘制。<div class="screenLinkPre"><div _ngcontent-qvu-c106="" class="highlight-div"><div _ngcontent-qvu-c106="" class="highlight-div-header"><div _ngcontent-qvu-c106="" class="highlight-div-header-left"><div _ngcontent-qvu-c106="" class="handle-button expand-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-qvu-c106="" class="highlight-div-header-right"><div _ngcontent-qvu-c106="" class="handle-button ai-button"></div><div _ngcontent-qvu-c106="" class="handle-button line-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-qvu-c106="" class="handle-button theme-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-qvu-c106="" class="handle-button copy-button"><div _ngcontent-qvu-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-qvu-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L466-L494" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// entry/src/main/ets/view/EmulationFlipPage.ets</span></li><li><span class="hljs-keyword">private</span> finishLastGesture() {</li><li>  clearInterval(<span class="hljs-keyword">this</span>.timeID);</li><li>  <span class="hljs-keyword">this</span>.timeID = -<span class="hljs-number">1</span>;</li><li>
</li><li>  <span class="hljs-comment">// Previous page.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pageMoveForward === MoveForward.MF_FORWARD &amp;&amp; <span class="hljs-keyword">this</span>.gestureMoveForward === MoveForward.MF_FORWARD) {</li><li>    <span class="hljs-keyword">this</span>.currentPageNum--;</li><li>    <span class="hljs-keyword">this</span>.simulatePageContent();</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Next page.</span></li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pageMoveForward === MoveForward.MF_BACKWARD &amp;&amp; <span class="hljs-keyword">this</span>.gestureMoveForward === MoveForward.MF_BACKWARD) {</li><li>    <span class="hljs-keyword">this</span>.currentPageNum++;</li><li>    <span class="hljs-keyword">this</span>.simulatePageContent();</li><li>  }</li><li>
</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'positionX'</span>, -<span class="hljs-number">1</span>);</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'positionY'</span>, -<span class="hljs-number">1</span>);</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'drawPosition'</span>, DrawPosition.DP_NONE);</li><li>  AppStorage.setOrCreate(<span class="hljs-string">'drawState'</span>, DrawState.DS_NONE);</li><li>  <span class="hljs-keyword">this</span>.isMiddlePageHide = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">this</span>.isNodeShow = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">this</span>.gestureMoveForward = MoveForward.MF_NONE;</li><li>  <span class="hljs-keyword">this</span>.panPositionX = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-keyword">this</span>.drawPosition = DrawPosition.DP_NONE;</li><li>  <span class="hljs-keyword">this</span>.isDrawing = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">this</span>.pagePixelMap?.release();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/PageFlip/blob/master/entry/src/main/ets/view/EmulationFlipPage.ets#L466-L494" target="_blank">EmulationFlipPage.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section13557146132318">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section13557146132318" tips="复制节点链接"></i></h3><p><a href="https://gitee.com/harmonyos_samples/PageFlip" target="_blank">实现阅读器翻页效果</a></p> </div> </div> <div></div></div>