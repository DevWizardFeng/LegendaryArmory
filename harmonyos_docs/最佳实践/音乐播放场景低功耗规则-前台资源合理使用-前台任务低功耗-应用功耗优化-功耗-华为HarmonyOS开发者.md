<h1 _ngcontent-dnj-c119="" class="doc-title ng-star-inserted" title="音乐播放场景低功耗规则"> 音乐播放场景低功耗规则 </h1>

<div _ngcontent-dnj-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section7437026171217">规则<i class="anchor-icon anchor-icon-link" anchorid="section7437026171217" tips="复制节点链接"></i></h2></div> <ul><li>音乐类应用静音时关闭音效处理算法。</li><li>音乐类应用播放时设置正确应用类型，走系统低功耗方案。</li><li>音乐类应用在后台播放时无需设置播放状态，通过接入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-kit" target="_blank">AVSession Kit（音视频播控服务）</a>，设置资源的时长、播放状态（暂停、播放）、播放位置、倍速即可，不需要应用实时更新播放进度。</li></ul> <div class="tiledSection"><h2 id="section41002910234">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section41002910234" tips="复制节点链接"></i></h2></div> <div class="p">为了避免静音播放时冗余音效处理算法导致的快速耗电，可以通过设置当前播放实例的音效模式来解决。关闭应用音效的方法如下所示：<div class="screenLinkPre"><div _ngcontent-dnj-c106="" class="highlight-div"><div _ngcontent-dnj-c106="" class="highlight-div-header"><div _ngcontent-dnj-c106="" class="highlight-div-header-left"><div _ngcontent-dnj-c106="" class="handle-button expand-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dnj-c106="" class="highlight-div-header-right"><div _ngcontent-dnj-c106="" class="handle-button ai-button"></div><div _ngcontent-dnj-c106="" class="handle-button line-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dnj-c106="" class="handle-button theme-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dnj-c106="" class="handle-button copy-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dnj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L21-L41" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>audioRenderer!.<span class="hljs-title function_">setAudioEffectMode</span>(audio.<span class="hljs-property">AudioEffectMode</span>.<span class="hljs-property">EFFECT_NONE</span>, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>  <span class="hljs-keyword">if</span> (err) {</li><li>    hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">`Failed to set params, code is <span class="hljs-subst">${err.code}</span>, message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'Callback invoked to indicate a successful audio effect mode setting.'</span>);</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L21-L41" target="_blank">MusicPlayRule.ets</a></div></div></div></div> </div> <div class="p">设置音乐播放的usage类型为audio.StreamUsage.STREAM_USAGE_MUSIC，确保音乐类应用能使用系统低功耗方案。<div class="screenLinkPre"><div _ngcontent-dnj-c106="" class="highlight-div"><div _ngcontent-dnj-c106="" class="highlight-div-header"><div _ngcontent-dnj-c106="" class="highlight-div-header-left"><div _ngcontent-dnj-c106="" class="handle-button expand-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dnj-c106="" class="highlight-div-header-right"><div _ngcontent-dnj-c106="" class="handle-button ai-button"></div><div _ngcontent-dnj-c106="" class="handle-button line-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dnj-c106="" class="handle-button theme-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dnj-c106="" class="handle-button copy-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dnj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L22-L67" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">audio</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">audioStreamInfo</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioStreamInfo</span> = {</li><li>  <span class="hljs-variable">samplingRate</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioSamplingRate</span>.<span class="hljs-title class_">SAMPLE_RATE_44100</span>,</li><li>  <span class="hljs-variable">channels</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioChannel</span>.<span class="hljs-title class_">CHANNEL_1</span>,</li><li>  <span class="hljs-variable">sampleFormat</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioSampleFormat</span>.<span class="hljs-title class_">SAMPLE_FORMAT_S16LE</span>,</li><li>  <span class="hljs-variable">encodingType</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioEncodingType</span>.<span class="hljs-title class_">ENCODING_TYPE_RAW</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">audioRendererInfo</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioRendererInfo</span> = {</li><li>  <span class="hljs-variable">usage</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">StreamUsage</span>.<span class="hljs-title class_">STREAM_USAGE_MUSIC</span>,</li><li>  <span class="hljs-variable">rendererFlags</span>: <span class="hljs-number">0</span></li><li>};</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">audioRendererOptions</span>: <span class="hljs-title class_">audio</span>.<span class="hljs-title class_">AudioRendererOptions</span> = {</li><li>  <span class="hljs-variable">streamInfo</span>: <span class="hljs-title class_">audioStreamInfo</span>,</li><li>  <span class="hljs-variable">rendererInfo</span>: <span class="hljs-title class_">audioRendererInfo</span></li><li>};</li><li><span class="hljs-variable">audio</span>.<span class="hljs-title function_">createAudioRenderer</span>(<span class="hljs-variable">audioRendererOptions</span>, (<span class="hljs-variable">err</span>, <span class="hljs-variable">data</span>) =&gt; {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, `<span class="hljs-variable">Invoke</span> <span class="hljs-variable">createAudioRenderer</span> <span class="hljs-variable">failed</span>, <span class="hljs-variable">code</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span> <span class="hljs-keyword">is</span> ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, <span class="hljs-string">'Invoke createAudioRenderer succeeded.'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">audioRenderer</span> = <span class="hljs-variable">data</span>;</li><li>  }</li><li>});</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L22-L67" target="_blank">MusicPlayRule.ets</a></div></div></div></div> </div> <p>设置音乐应用后台播放时，需指定播放位置。播控中心将利用这些信息展示进度，无需频繁更新进度条，从而避免增加binder负载。</p> <div class="screenLinkPre"><div _ngcontent-dnj-c106="" class="highlight-div"><div _ngcontent-dnj-c106="" class="highlight-div-header"><div _ngcontent-dnj-c106="" class="highlight-div-header-left"><div _ngcontent-dnj-c106="" class="handle-button expand-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dnj-c106="" class="highlight-div-header-right"><div _ngcontent-dnj-c106="" class="handle-button ai-button"></div><div _ngcontent-dnj-c106="" class="handle-button line-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dnj-c106="" class="handle-button theme-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dnj-c106="" class="handle-button copy-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dnj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L27-L110" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">avSession</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable">uiContext</span>: <span class="hljs-title class_">UIContext</span> | <span class="hljs-title class_">undefined</span> = <span class="hljs-variable">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'uiContext'</span>);</li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span> = <span class="hljs-variable">uiContext</span>?.<span class="hljs-title function_">getHostContext</span>()!;</li><li>
</li><li><span class="hljs-variable">async</span> <span class="hljs-variable">function</span> <span class="hljs-title function_">setListener</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">void</span>&gt; {</li><li>  <span class="hljs-comment">// Assuming that a session has been created, see the previous example for how to create a session</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">type</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">AVSessionType</span> = <span class="hljs-string">'audio'</span>;</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">session</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">AVSession</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">avSession</span>.<span class="hljs-title function_">createAVSession</span>(<span class="hljs-variable">context</span>, <span class="hljs-string">'SESSION_NAME'</span>, <span class="hljs-keyword">type</span>);</li><li>
</li><li>  <span class="hljs-comment">// Set the duration of the property</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">metadata</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">AVMetadata</span> = {</li><li>    <span class="hljs-variable">assetId</span>: <span class="hljs-string">'0'</span>,</li><li>    <span class="hljs-variable">title</span>: <span class="hljs-string">'TITLE'</span>,</li><li>    <span class="hljs-variable">mediaImage</span>: <span class="hljs-string">'IMAGE'</span>,</li><li>    <span class="hljs-variable">duration</span>: <span class="hljs-number">23000</span>, <span class="hljs-comment">// The duration of the resource, measured in milliseconds</span></li><li>  };</li><li>  <span class="hljs-variable">session</span>.<span class="hljs-title function_">setAVMetadata</span>(<span class="hljs-variable">metadata</span>).<span class="hljs-title function_">then</span>(() =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, `<span class="hljs-variable">SetAVMetadata</span> <span class="hljs-variable">successfully</span>`);</li><li>  }).<span class="hljs-keyword">catch</span>((<span class="hljs-variable">err</span>: <span class="hljs-title class_">BusinessError</span>) =&gt; {</li><li>    <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">set</span> <span class="hljs-variable">AVMetadata</span>. <span class="hljs-variable">Code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>  });</li><li>
</li><li>  <span class="hljs-comment">// Set Status: Playback Status, Progress Position, Playback Speed, Cache Time</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">playbackState</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">AVPlaybackState</span> = {</li><li>    <span class="hljs-variable">state</span>: <span class="hljs-title class_">avSession</span>.<span class="hljs-title class_">PlaybackState</span>.<span class="hljs-title class_">PLAYBACK_STATE_PLAY</span>, <span class="hljs-comment">// Playback status</span></li><li>    <span class="hljs-variable">position</span>: {</li><li>      <span class="hljs-variable">elapsedTime</span>: <span class="hljs-number">1000</span>, <span class="hljs-comment">// The position that has been played, in ms</span></li><li>      <span class="hljs-variable">updateTime</span>: <span class="hljs-title class_">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title class_">getTime</span>(), <span class="hljs-comment">// The timestamp of when the app updated the current location, in ms</span></li><li>    },</li><li>    <span class="hljs-variable">speed</span>: <span class="hljs-number">1.0</span>, <span class="hljs-comment">// Optional, the default is 1.0, the speed of playback, set according to the speed supported in the app, the system does not do verification</span></li><li>    <span class="hljs-variable">bufferedTime</span>: <span class="hljs-number">14000</span>, <span class="hljs-comment">// Optional, the time for which the resource is cached, in ms</span></li><li>  };</li><li>  <span class="hljs-variable">session</span>.<span class="hljs-title function_">setAVPlaybackState</span>(<span class="hljs-variable">playbackState</span>, (<span class="hljs-variable">err</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">err</span>) {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, `<span class="hljs-variable">Failed</span> <span class="hljs-variable">to</span> <span class="hljs-variable">set</span> <span class="hljs-variable">AVPlaybackState</span>. <span class="hljs-variable">Code</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">code</span>}, <span class="hljs-variable">message</span>: ${<span class="hljs-variable">err</span>.<span class="hljs-variable">message</span>}`);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-string">'Sample'</span>, `<span class="hljs-variable">SetAVPlaybackState</span> <span class="hljs-variable">successfully</span>`);</li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/RationalUseOfFrontEndResources/entry/src/main/ets/pages/MusicPlayRule.ets#L27-L110" target="_blank">MusicPlayRule.ets</a></div></div></div></div> <div class="tiledSection"><h2 id="section16461935163413">调测验证<i class="anchor-icon anchor-icon-link" anchorid="section16461935163413" tips="复制节点链接"></i></h2></div> <div class="p">usage可以通过以下命令查看日志确认：<div _ngcontent-dnj-c106="" class="highlight-div"><div _ngcontent-dnj-c106="" class="highlight-div-header"><div _ngcontent-dnj-c106="" class="highlight-div-header-left"><div _ngcontent-dnj-c106="" class="handle-button expand-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-dnj-c106="" class="highlight-div-header-right"><div _ngcontent-dnj-c106="" class="handle-button ai-button"></div><div _ngcontent-dnj-c106="" class="handle-button line-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-dnj-c106="" class="handle-button theme-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-dnj-c106="" class="handle-button copy-button"><div _ngcontent-dnj-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-dnj-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-perl" data-highlighted="yes"><ol class="linenums"><li>hdc shell</li><li>hilog | <span class="hljs-keyword">grep</span> usage</li></ol></pre></div></div> </div> <p>执行效果示意如下图所示：</p> <p class="msonormal"><span><img height="19.950000000000003" originheight="33" originwidth="899" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163444.82094230702574615393220316416915:50001231000000:2800:0DE1B9D97006B228859BE57AA7C76D6E8104BE73CB262EDFD0222C67BDB6CB15.png" title="点击放大" width="551.95"></span></p> </div> <div></div></div>