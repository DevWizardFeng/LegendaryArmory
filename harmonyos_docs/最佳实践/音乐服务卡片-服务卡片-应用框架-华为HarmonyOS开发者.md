<h1 _ngcontent-efi-c119="" class="doc-title ng-star-inserted" title="音乐服务卡片"> 音乐服务卡片 </h1>

<div _ngcontent-efi-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1264953212439">概述<i class="anchor-icon anchor-icon-link" anchorid="section1264953212439" tips="复制节点链接"></i></h2><p>服务卡片，简称“卡片”，<span style="color: rgb(13,13,13);">是系统一种呈现信息和交互操作的载体，</span>在应用或元服务中提取关键信息和核心操作，以卡片的形式展示在桌面上，用户通过与服务卡片交互即可实现服务直达，减少交互层级，提升用户体验。</p> <p>典型的服务卡片使用场景有音乐服务卡片。音乐服务卡片将音乐应用的重要信息与核心功能操作前置到卡片上，以卡片的形式呈现给用户，如音乐播控、歌单推荐、心动歌词、动态歌词等。用户可通过音乐服务卡片快速访问音乐应用的核心功能，无需打开完整的应用界面。</p> <div class="fignone"><span class="figcap"><b>图1 </b>音乐服务卡片场景效果图</span><br><span><img height="405.6367" originheight="937" originwidth="1659" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162955.35669851683917550389195886862114:50001231000000:2800:53B73F564A898A88F954697F89919A4A8D5C2FCBFAD8E77F459625108E68225F.png" title="点击放大" width="718.2"></span></div> <p>本文将以音乐服务卡片场景为例，分别介绍音乐播控、歌单推荐、心动歌词、动态歌词四种服务卡片的实现，包括卡片设计和功能开发，以及开发中常见的一些问题。通过本案例，开发者可以更加深入的了解服务卡片与应用的交互和卡片的数据更新机制，快速高效的进行精美的服务卡片开发。</p> </div> <div class="tiledSection"><h2 id="section385211614818">场景介绍<i class="anchor-icon anchor-icon-link" anchorid="section385211614818" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section29858211157" class="firsth2">音乐播控<i class="anchor-icon anchor-icon-link" anchorid="section29858211157" tips="复制节点链接"></i></h3><p><span><img height="551.9367000000001" originheight="886" originwidth="427" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162955.82392255907572018889509793557720:50001231000000:2800:780001035A545AE2870A7B15A4924015BA5BB1FDFB4EB976334F020DFBA476D0.png" title="点击放大" width="266"></span></p> <p>场景定义：</p> <ul><li>体验：用户无需打开应用，直接在卡片上就能控制基本的音乐播放功能操作，节省操作步骤，提升用户体验。</li></ul> <ul><li>功能：用户可以通过服务卡片直接实现音乐播放，包括播放、暂停、上一首、下一首、收藏等操作。</li></ul> </div> <div class="tiledSection"><h3 id="section676616256342">动态歌词<i class="anchor-icon anchor-icon-link" anchorid="section676616256342" tips="复制节点链接"></i></h3><p><span><img height="541.96968" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162955.33992680901045743529675524606607:50001231000000:2800:6C69491D2704F16AD5DE9555D20DF0A3B8B437D3FADAC38D31B42827A2950E9C.jpg" title="点击放大" width="260.3475"></span></p> <p>场景定义：</p> <ul><li>体验：用户不仅可以播放音乐，还可以看到与当前播放进度实时匹配的歌词内容，增强用户体验。</li></ul> <ul><li>功能：用户可以通过服务卡片直接实现音乐播放并实时显示歌词，包括播放、暂停、上一首、下一首、根据播放进度显示歌词等操作。</li></ul> </div> <div class="tiledSection"><h3 id="section15105143319153">歌单推荐<i class="anchor-icon anchor-icon-link" anchorid="section15105143319153" tips="复制节点链接"></i></h3><p><span><img height="550.921245" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162957.99917667964306600365313545527225:50001231000000:2800:63B4A24653569CF706C44811B91A5111E12D55FB269245A54229A45D40DF7A50.png" title="点击放大" width="266.33250000000004"></span></p> <p>场景定义：</p> <ul><li>体验：用户在播放音乐时，可以直接在卡片上看到推荐的歌曲列表，点击即可切换和收藏，增强用户对音乐选择的便捷性和个性化体验。</li><li>功能：服务卡片可以根据用户的音乐偏好和当前播放内容，实时推荐相关歌曲或歌单。点击“我的收藏”跳转到应用收藏列表；点击“热门歌单”，跳转到歌单列表。</li></ul> </div> <div class="tiledSection"><h3 id="section11589333181512">心动歌词<i class="anchor-icon anchor-icon-link" anchorid="section11589333181512" tips="复制节点链接"></i></h3><p><span><img height="559.1754910000001" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162957.91011507378551291338496739625821:50001231000000:2800:C00A19E327E98AA790A50A8D5CD81689F4BFFBA87B598626D1BE73BE1FBCED0E.png" title="点击放大" width="270.3225"></span></p> <p>场景定义：</p> <ul><li>体验：以用户个性化互动为核心，通过歌词内容增强用户情感共鸣和音乐体验，通过技术创新深度链接用户情感，提供更加富有个性化的音乐体验。</li></ul> <ul><li>功能：根据用户的听歌历史和偏好，推荐与其喜好相符的歌词卡片。</li></ul> </div> <div class="tiledSection"><h3 id="section162191816919">场景互动卡片<i class="anchor-icon anchor-icon-link" anchorid="section162191816919" tips="复制节点链接"></i></h3><p><span><img height="549.5161" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162957.83893847727664030265522694406674:50001231000000:2800:6D79EDBD3549BAC032EDDD4099E72F1838B8A03933EA7722BA15A677DA28D806.png" title="点击放大" width="266"></span></p> <p>场景定义：</p> <ul><li>体验：客户可以通过点击卡片，卡片展示溢出屏幕的动效，提供技术创新提供富有趣味的用户体验。</li><li>功能：提供富有趣味的用户互动。</li></ul> </div> <div class="tiledSection"><h2 id="section157841550141811">卡片设计<i class="anchor-icon anchor-icon-link" anchorid="section157841550141811" tips="复制节点链接"></i></h2><p>在设计方面，服务卡片需要遵循突出服务内容、明确划分有限的操作空间、展示必要的信息和图片以及轻量交互<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/system-features-service-widget-0000002087671904#section111mcpsimp" target="_blank">体验原则</a>，关于卡片内容设计遵循<a href="https://developer.huawei.com/consumer/cn/doc/design-guides/system-features-service-widget-0000002087671904#section248mcpsimp" target="_blank">卡片内容设计</a>规范，例如卡片沉浸式体验设计，包含图片和用色丰富的沉浸式卡片，背景色吸取内容图中的色彩。</p> <div class="fignone"><span class="figcap"><b>图2 </b>音乐服务卡片沉浸效果图</span><br><span><img height="456.855" originheight="583" originwidth="667" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.28834337690117957865972368482221:50001231000000:2800:B5F324C3D86A00A80F5CBB7CC0FACCA8B279DC0BABA3A5DD434A910290747C26.png" title="点击放大" width="523.6875"></span></div> <p>音乐播控、歌单推荐、心动歌词和动态歌词卡片设计效果如下所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表1 </b>音乐卡片设计效果</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.1" valign="top" width="8.809119088091192%"><p>卡片名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.2" valign="top" width="8.37916208379162%"><p>卡片规格</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.3" valign="top" width="13.828617138286173%"><p>功能简介</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.4" valign="top" width="25.907409259074093%"><p>卡片效果1</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.5" valign="top" width="28.157184281571844%"><p>卡片效果2</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.8.5.2.7.1.6" valign="top" width="14.918508149185081%"><p>桌面效果</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="8.809119088091192%"><p>音乐播控</p> </td> <td class="cellrowborder" valign="top" width="8.37916208379162%"><p>[2x2] [2x4]</p> </td> <td class="cellrowborder" valign="top" width="13.828617138286173%"><ol><li>音乐播放控制，点击上一曲/下一曲，音乐封面会跟随歌曲切换。</li><li>音乐收藏/取消收藏功能</li></ol> </td> <td class="cellrowborder" valign="top" width="25.907409259074093%"><p><span><img height="134.33" originheight="302" originwidth="299" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.57195339786408010409413819646611:50001231000000:2800:8D8E97B9EF0D0941199530871083486FE523AC511A266B6C863E3EC459500D78.png" width="133" class="notEnlarge"></span></p> </td> <td class="cellrowborder" valign="top" width="28.157184281571844%"><p><span><img height="108.96736982301772" originheight="853" originwidth="1840" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.77606807721665667385443763766408:50001231000000:2800:65D51E34F71F1F5BAEFF9592D88F5552390627B5E08198C93FC457F6921CAC74.png" title="点击放大" width="235.046095390461"></span></p> </td> <td class="cellrowborder" valign="top" width="14.918508149185081%"><p><span><img height="234.3186579104801" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.17685083140860102156611953809600:50001231000000:2800:05018991274BB2033743DA8DB5BCEBBB3516985DD35D1CEEDE98DBE1DEF322B4.png" title="点击放大" width="113.25027497250275"></span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.809119088091192%"><p>歌单推荐</p> </td> <td class="cellrowborder" valign="top" width="8.37916208379162%"><p>[1x2] [2x4]</p> </td> <td class="cellrowborder" valign="top" width="13.828617138286173%"><ol><li>点击我的收藏跳转到应用收藏列表。</li><li>点击热门歌单，跳转到歌单列表。</li></ol> </td> <td class="cellrowborder" valign="top" width="25.907409259074093%"><p><span><img height="47.6007" originheight="287" originwidth="802" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.19967473832508628164334011145287:50001231000000:2800:D298624A732CBD53AD0A4655CA91A734F9436CCD6699F0CFE614A86798F7E32A.png" title="点击放大" width="133"></span></p> </td> <td class="cellrowborder" valign="top" width="28.157184281571844%"><p><span><img height="108.87335138486154" originheight="781" originwidth="1686" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.41550859756009331671515940258057:50001231000000:2800:C396FE13F8F8FFC77D1F5A36E967C862D8EA64FF152B700E337C9D2BBBBEADCE.png" title="点击放大" width="235.046095390461"></span></p> </td> <td class="cellrowborder" valign="top" width="14.918508149185081%"><p><span><img height="234.28701567599856" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.60322671954433684608381617048693:50001231000000:2800:AF1A4C97796DB3FE74E2C4C9B3A8B5F03376D13A4DFED27872ACBDFC9BFCE0E6.png" title="点击放大" width="113.25027497250275"></span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.809119088091192%"><p>心动歌词</p> </td> <td class="cellrowborder" valign="top" width="8.37916208379162%"><p>[2x4] [4x4]</p> </td> <td class="cellrowborder" valign="top" width="13.828617138286173%"><ol><li>展示心动歌词，以及歌曲信息。</li><li>点击卡片拉起对应歌曲播放页面。</li></ol> </td> <td class="cellrowborder" valign="top" width="25.907409259074093%"><p><span><img height="99.11459158084193" originheight="805" originwidth="1741" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.13841106525147745788925116603830:50001231000000:2800:D4A6A0233DCD985FD90CDDE44F0A007D6A779AEB66A2C4C3D5412FC958CDB2D7.png" title="点击放大" width="214.34816518348165"></span></p> </td> <td class="cellrowborder" valign="top" width="28.157184281571844%"><p><span><img height="245.39987589241085" originheight="1019" originwidth="976" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.19544378477950225154540574732611:50001231000000:2800:C8F59EBD9D170A486FC5EFDB0C430063A5ECBA5CCADF511BF82ACDA056CA51D6.png" title="点击放大" width="235.046095390461"></span></p> </td> <td class="cellrowborder" valign="top" width="14.918508149185081%"><p><span><img height="234.2595908312581" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.06701309006688146007186525411403:50001231000000:2800:A563B92E5159FBC96DDC1F0064FF2CE455EE81A4B71DBFADD7D0F7F2FEA01DDA.png" title="点击放大" width="113.25027497250275"></span></p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="8.809119088091192%"><p>动态歌词</p> </td> <td class="cellrowborder" valign="top" width="8.37916208379162%"><p>[2x4]</p> </td> <td class="cellrowborder" valign="top" width="13.828617138286173%"><ol><li>音乐播放控制，点击上一曲/下一曲，音乐封面会跟随歌曲切换。</li><li>当前音乐歌词会跟随播放进度，显示对应歌词。</li></ol> </td> <td class="cellrowborder" valign="top" width="25.907409259074093%"><p><span><img height="99.56422338579921" originheight="151" originwidth="332" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162958.36822365353204019489456795582890:50001231000000:2800:96C70B6AB8DE51F87C0B8B4D9E7BE61D453363751B455C088F5F2ED50C3580CD.png" title="点击放大" width="214.34816518348165"></span></p> </td> <td class="cellrowborder" valign="top" width="28.157184281571844%"><p>暂无</p> </td> <td class="cellrowborder" valign="top" width="14.918508149185081%"><p><span><img height="240.08303292337433" originheight="2317" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.27567692273430350728051572843319:50001231000000:2800:3121DA9AD2E56049A432ACA031B1945E6AA7BE2F59E10586D934F077E2D722E7.jpg" title="点击放大" width="113.25027497250275"></span></p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section168853651115">实现方案<i class="anchor-icon anchor-icon-link" anchorid="section168853651115" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section5663114711426" class="firsth2">整体方案<i class="anchor-icon anchor-icon-link" anchorid="section5663114711426" tips="复制节点链接"></i></h3><p>音乐应用作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/formkit-overview#服务卡片架构" target="_blank">卡片提供方</a>，提供音乐服务卡片的内容显示、控件布局和卡片交互处理逻辑。桌面作为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/formkit-overview#服务卡片架构" target="_blank">卡片使用方</a>，即卡片的宿主应用，控制卡片在桌面中展示的位置和内容。卡片框架管理卡片生命周期和刷新机制，负责卡片页面的渲染。关于卡片提供方、使用方和卡片框架的详细内容可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-form-overview#实现原理" target="_blank">ArkTS卡片实现原理</a>。</p> <div class="fignone"><span class="figcap"><b>图3 </b>音乐服务卡片运行机制</span><br><span><img height="265.272224" originheight="401" originwidth="874" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.57507738095049429385077330915084:50001231000000:2800:F8EF350E9476598519177DD619AFA7EC56604D7FE5C2C2742D4E5B26E4842D12.png" title="点击放大" width="570.57"></span></div> <p>音乐应用包含<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-ability-uiability" target="_blank">UIAbility</a>（主进程）和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability" target="_blank">FormExtensionAbility</a>（卡片进程）两个进程。其中，主进程包含音乐播控、收藏、热门歌单、以及歌词处理等功能模块；卡片进程是卡片业务逻辑模块，提供卡片创建、刷新、销毁等生命周期回调。如下图所示：</p> <div class="fignone"><span class="figcap"><b>图4 </b>音乐应用进程结构</span><br><span><img height="396.928259" originheight="470" originwidth="600" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.42545120570244869775699376890969:50001231000000:2800:A5328DE764E194A9CBC2BE7E06DC621E8E730BFAA59B9454F6BA3F8CF067F3DC.png" title="点击放大" width="506.73"></span></div> <p>开发者可以根据FormExtensionAbility生命周期回调，在对应回调方法中处理卡片数据持久化、卡片数据更新等操作，FormExtensionAbility生命周期回调时机和功能实现说明如下表所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表2 </b>卡片生命周期说明</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.10.7.2.3.1.1" valign="top" width="31.1%"><p>生命周期</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.10.7.2.3.1.2" valign="top" width="68.89999999999999%"><p>回调时机</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="31.1%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability#formextensionabilityonaddform" target="_blank">onAddForm</a></p> </td> <td class="cellrowborder" valign="top" width="68.89999999999999%"><p>长按APP图标/卡片后，点击“服务卡片”拉起卡片视图后</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="31.1%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability#formextensionabilityonupdateform" target="_blank">onUpdateForm</a></p> </td> <td class="cellrowborder" valign="top" width="68.89999999999999%"><p>定时更新、定点更新、卡片使用方主动请求更新时执行回调</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="31.1%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability#formextensionabilityonformevent" target="_blank">onFormEvent</a></p> </td> <td class="cellrowborder" valign="top" width="68.89999999999999%"><p>用户触发了卡片上的postCardAction或FormLink中的message事件</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="31.1%"><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability#formextensionabilityonremoveform" target="_blank">onRemoveForm</a></p> </td> <td class="cellrowborder" valign="top" width="68.89999999999999%"><p>长按卡片选择“移除”后</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h3 id="section1871133584812">互动卡片<i class="anchor-icon anchor-icon-link" anchorid="section1871133584812" tips="复制节点链接"></i></h3><p>场景类型互动卡片在定位上是对普通卡片能力的增强，因此开发者需首先完成普通卡片的业务开发。之后在特定业务环节通过接口请求，触发互动卡片特有的动态效果。开发者可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-liveform" target="_blank">互动卡片开发</a>。</p> <p><span><img height="549.5161" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.71556584679363605155933388218906:50001231000000:2800:C57F41EB1422FFC13131F20CBDAB9CC64FC55895861AC8966CF625FF8D8DA115.png" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section20851252508">关键技术<i class="anchor-icon anchor-icon-link" anchorid="section20851252508" tips="复制节点链接"></i></h3><p>在服务卡片开发中，会使用多种关键技术共同来实现不同类型的卡片，比如卡片规格的选择、卡片的沉浸式效果、卡片的更新以及数据持久化等。具体关键技术介绍如下：</p> <ol><li><strong>卡片的选择</strong><ul><li>动态卡片支持通用事件能力和自定义动效能力，适用于有复杂业务逻辑和交互的场景，功能丰富但内存开销较大。</li><li>静态卡片支持UI组件和布局能力，不支持通用事件和自定义动效能力，卡片内容以静态图显示，可以通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-formlink" target="_blank">FormLink</a>组件跳转到指定的UIAbility，适用于展示类卡片（UI相对固定），功能简单但可以有效控制内存开销。</li></ul> <p>音乐播控卡片和动态歌词卡片具有播放/暂停、上一曲/下一曲、收藏等功能，需较强的播控逻辑和交互处理，更适合选择动态卡片；歌单推荐和心动歌词仅需要页面跳转功能，业务逻辑和交互都比较简单，选择静态卡片更合适。</p> </li><li><strong>沉浸式卡片</strong><p>沉浸式卡片设计能给用户带来更好的视觉体验，开发者可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit" target="_blank">@ohos.effectKit</a>模块的ColorPicker的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit#getmaincolor" target="_blank">getMainColor()</a>方法获取歌曲封面图像主色，作为卡片的背景色，使卡片和歌曲封面融为一体达到卡片沉浸效果。此外，在一些场景下，还可以给卡片添加背景图片，使用Image组件的blur属性或者@ohos.effectKit模块的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit#blur" target="_blank">blur()</a>方法给图片做模糊化处理，来达到卡片沉浸效果。</p> </li><li><strong>卡片更新与数据交互</strong><p>针对音乐服务卡片这种多类型多规格的卡片场景，推荐使用关系型数据库<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-data-relationalstore" target="_blank">relationalStore</a>进行卡片数据持久化存储。</p> <p>应用主进程通过FormProvider的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider#formproviderupdateform" target="_blank">updateForm()</a>方法实现卡片的主动刷新，例如更新歌曲信息、歌词信息等；在FormExtensionAbility的onUpdateForm()生命周期回调方法中实现卡片被动刷新逻辑，例如定时和定点刷新。</p> <p>关于服务卡片的数据交互和更新机制，具体可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-card-update-and-data-interaction" target="_blank">卡片更新与数据交互</a>。</p> </li></ol> </div> <div class="tiledSection"><h3 id="section1889820381498">卡片实现方案<i class="anchor-icon anchor-icon-link" anchorid="section1889820381498" tips="复制节点链接"></i></h3><p><strong>音乐播控卡片</strong></p> <ul><li>音乐播控卡片具有播放/暂停、上一曲/下一曲、收藏等功能，需较强的播控逻辑和交互处理，选择动态卡片实现。</li><li>音乐播控卡片和应用之间存在较多的交互，选择使用动态卡片来实现。动态卡片支持通用事件能力和自定义动效能力，适用于有复杂业务逻辑和交互的场景。动态卡片的创建可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-creation" target="_blank">创建ArkTS卡片</a><strong>。</strong></li><li>卡片与应用主进程之间通过call事件进行交互，比如播放、暂停、收藏等。call事件的发送和订阅可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-overview" target="_blank">通过router或call事件刷新卡片内容</a>。</li><li>本示例音乐播放功能使用的是AVPlayer，具体实现可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-avplayer-for-playback" target="_blank">使用AVPlayer播放音频(ArkTS)</a>。为保证音乐能在后台播放或熄屏播放，需要接入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-access-scene" target="_blank">AVSession（媒体会话）</a>和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/continuous-task" target="_blank">申请长时任务</a>，避免播放被系统强制中断。</li><li>场景动效类型互动卡片采用的是LiveFormExtensionAbility完成其页面的布局和渲染。</li></ul> <p><strong>动态歌词卡片</strong></p> <ul><li>该卡片支持切换歌曲、播控、跳转功能，可参考前面<a href="/consumer/cn/doc/best-practices/bpta-music-card#section1889820381498">音乐播控卡片</a>相关介绍。</li><li>动态歌词可实时显示与当前播放进度匹配的歌词内容。切换歌曲时，除更新歌曲基本信息外，歌词部分会同步更新并从头开始跟随播放进度显示，需要开发者在实际开发中获取相应歌曲的歌词信息。歌词在播放期间以及切换不同歌曲的时候，需要通过动画实现歌词的平滑<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-transition-animation-component" target="_blank">过渡效果</a>。在卡片初始化的时候，需要预处理好歌词数组，在音频进度回调中，需根据当前时间匹配对应歌词，并更新卡片。</li><li>应用内添加卡片到桌面功能。在应用内长按指定元素，将弹出包含"添加至桌面"选项的菜单，点击后弹出应用支持的卡片。长按添加至桌面菜单可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-formmenu" target="_blank">FormMenu</a>组件。</li></ul> <p><strong>歌单推荐卡片</strong></p> <ul><li>歌单推荐卡片没有复杂的业务逻辑和数据交互，选择使用静态卡片来实现，歌单推荐的交互动作主要是点击卡片对应组件之后，拉起应用主进程进行页面跳转。</li><li>页面跳转通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-formlink" target="_blank">FormLink</a>组件router类型事件来实现。</li><li>卡片创建的时候会加载网络图片，网络图片的刷新可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-image-update" target="_blank">刷新本地图片和网络图片</a>。</li></ul> <p><strong>心动歌词卡片</strong></p> <ul><li>心动歌词卡片和应用主进程之间交互逻辑比较简单，仅有点击卡片跳转到应用播放页面的交互，所以选择静态卡片实现，通过FormLink组件实现点击卡片跳转。</li><li>心动歌词卡片内容主要是通过被动刷新的方式进行卡片数据刷新，在FormExtensionAbility的<span style="color: rgb(0,38,84);">onUpdateForm()回调方法中，对卡片数据进行刷新</span>，在卡片配置文件form_config中配置updateDuration参数实现定时刷新。具体实现可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-passive-refresh" target="_blank">卡片定时刷新和定点刷新</a>。</li></ul> </div> <div class="tiledSection"><h2 id="section74001613133517">场景实现<i class="anchor-icon anchor-icon-link" anchorid="section74001613133517" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section13895124019481" class="firsth2">音乐播控卡片<i class="anchor-icon anchor-icon-link" anchorid="section13895124019481" tips="复制节点链接"></i></h3><p><strong>实现步骤</strong></p> <p>音乐播控卡片的主要实现步骤如下：<span><img height="50.94934707903779" originheight="70" originwidth="1264" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.16468140959565856281897839947669:50001231000000:2800:84EAE6129BEC9F8BBD543BE99865B8954C4969C109967DAABA2C9B0ECABB2E95.png" title="点击放大" width="920"></span></p> <div class="p">其中“实现音乐播控功能”需要通过卡片、数据库、媒体播放等多个模块之间的数据交互来实现，音乐播控功能实现时序图如下：<div class="fignone"><span class="figcap"><b>图5 </b>卡片音乐播控时序图</span><br><span><img height="358.697941" originheight="439" originwidth="1034" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.19718918661936932033783567600962:50001231000000:2800:0C5BF12ED63E1B96036F6B275C11CC80F5C1C3ED4C468628B8075EC18CB952BA.png" title="点击放大" width="844.8825"></span></div> </div> <p>音乐播控卡片的详细开发流程如下：</p> <ol><li><strong>开发卡片UI布局</strong><div class="fignone"><span class="figcap"><b>图6 </b>音乐播控卡片效果图</span><br><span><img height="159.6931" originheight="329" originwidth="1096" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.63439889397101015121047905311381:50001231000000:2800:24CA54F7488710BF5224350BB358D1A93A5E8D9562C04901FD81E74E74C0AA61.png" title="点击放大" width="532"></span></div> <p>分别创建2x2和2x4两个规格的动态卡片，动态卡片的创建可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-creation" target="_blank">创建ArkTS卡片</a>。对于比较复杂的布局，优先考虑使用相对布局 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-layout-development-relative-layout" target="_blank">RelativeContainer</a>来减少性能开销。由于2x4卡片包含了2x2卡片的功能，下面将以2x4卡片为例介绍音乐播控卡片的实现。</p> <p>在卡片布局文件中定义卡片所需要的变量信息，使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage#localstorageprop" target="_blank">@LocalStorageProp</a>装饰器修饰，用于接收应用侧传递过来的数据，其中isPlay与isCollected分别表示歌曲的播放和收藏状态，根据状态的不同展示不同的图标，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L38-L239" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li><span class="hljs-keyword">let</span> <span class="hljs-variable">storageUpdateCall</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">LocalStorage</span>();</li><li>
</li><li>@<span class="hljs-title function_">Entry</span>(<span class="hljs-variable">storageUpdateCall</span>)</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">PlayControlCard2x4</span> {</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'formId'</span>) <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'isNeedRequestUpdate'</span>) @<span class="hljs-title function_">Watch</span>(<span class="hljs-string">'requestData'</span>) <span class="hljs-variable">isNeedRequestUpdate</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'isPlay'</span>) <span class="hljs-variable">isPlay</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'title'</span>) <span class="hljs-variable">title</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'SongName'</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'isCollected'</span>) <span class="hljs-variable">isCollected</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'musicCover'</span>) <span class="hljs-variable">musicCover</span>: <span class="hljs-title class_">Resource</span> = $<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.ic_dream'</span>);</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'singer'</span>) <span class="hljs-variable">singer</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'Singer'</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'songId'</span>) <span class="hljs-variable">songId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'imageColor'</span>) <span class="hljs-variable">imageColor</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'rgba(76, 72, 68, 1)'</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'imageColorHex'</span>) <span class="hljs-variable">imageColorHex</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'18191d'</span>;</li><li>
</li><li>  <span class="hljs-title function_">requestData</span>() {</li><li>    <span class="hljs-variable">ActionUtils</span>.<span class="hljs-title function_">updateControlCardAction</span>(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.<span class="hljs-variable">formId</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">RelativeContainer</span>() {</li><li>      <span class="hljs-title function_">Image</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">musicCover</span>)</li><li>        <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title function_">SymbolGlyph</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isCollected</span> ? $<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.symbol.heart_fill'</span>) : $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">sys</span>.<span class="hljs-title class_">symbol</span>.<span class="hljs-title class_">heart</span>'))</li><li>        <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">SymbolGlyph</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.symbol.backward_end_fill'</span>))</li><li>          <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title function_">SymbolGlyph</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isPlay</span> ? $<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.symbol.pause'</span>) : $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">sys</span>.<span class="hljs-title class_">symbol</span>.<span class="hljs-title class_">play_fill</span>'))</li><li>          <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title function_">SymbolGlyph</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.symbol.forward_end_fill'</span>))</li><li>          <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L38-L239" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> </li><li><strong>卡片数据初始化</strong><div class="p">用户长按桌面应用图标，桌面弹出卡片添加弹窗时，需要对卡片数据进行初始化，能让用户直观的理解到卡片所提供的服务内容、功能和样式。同时，音乐播控卡片的预览数据和应用当前播放歌曲应该保持一致。<div class="fignone"><span class="figcap"><b>图7 </b>音乐播控卡片预览效果</span><br><span><img height="486.956491" originheight="1026" originwidth="496" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.34176079628454922065368069639124:50001231000000:2800:40352F586389085DA1EDB90F6C9D9D62D40C7156224156592B2D9FD706DBBC2A.png" title="点击放大" width="235.41000000000003"></span></div> </div> <p>在音乐应用中，EntryFormAbility继承了FormExtensionAbility类并实现了其生命周期回调方法。当预览卡片时，会触发EntryFormAbility的onAddForm()回调方法，在此方法中可以获取卡片名称、卡片ID等信息。开发者可以根据卡片名称判断是否为音乐播控卡片，如果是，则调用FormUtils.updateMusicControlCard()方法更新卡片数据。FormUtils是卡片管理工具类，封装了卡片添加、删除、更新等相关功能。示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L38-L210" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>) {</li><li>      <span class="hljs-keyword">let</span> formId = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_identity'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> formName = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_name'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trigger3DLiveRequest</span>(formId);</li><li>
</li><li>      <span class="hljs-keyword">if</span> (formName.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'PlayControlCard'</span>)) {</li><li>        <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateMusicControlCard</span>(formId, <span class="hljs-literal">true</span>);</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L38-L210" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <p>由于在卡片进程FormExtensionAbility中无法直接获取歌曲播放状态，需要应用主进程来主动更新卡片播放状态。可以通过FormExtensionAbility给卡片传递一个isNeedRequestUpdate标识，当卡片收到该标识后，给应用主进程发送call事件主动更新卡片信息。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L44-L449" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">updateMusicControlCard</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span>, needUpdate: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateMusicControlCard formId:<span class="hljs-subst">${formId}</span>,needUpdate:<span class="hljs-subst">${needUpdate}</span>`</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">updateData</span>: <span class="hljs-title class_">UpdateData</span> = {</li><li>      <span class="hljs-attr">isNeedRequestUpdate</span>: needUpdate,</li><li>      <span class="hljs-attr">formId</span>: formId,</li><li>    };</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateForm</span>(formId, updateData);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateForm</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span>, updateData: <span class="hljs-built_in">object</span></span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm  updateData: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(updateData)}</span>}`</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(updateData);</li><li>    formProvider</li><li>      .<span class="hljs-title function_">updateForm</span>(formId, formMsg)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm success formId:  <span class="hljs-subst">${formId}</span>}`</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      });</li><li>  }</li><li>
</li><li>
</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L44-L449" target="_blank">FormUtils.ets</a></div></div></div></div> <p>音乐播控卡片订阅到isNeedRequestUpdate变化后，发送call事件请求卡片更新。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L39-L240" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li>let storageUpdateCall = new LocalStorage();</li><li>
</li><li><span class="hljs-meta">@Entry(storageUpdateCall)</span></li><li><span class="hljs-meta">@Component</span></li><li>struct PlayControlCard2x4 {</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'formId'</span>)</span> formId: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'isNeedRequestUpdate'</span>)</span> <span class="hljs-meta">@Watch(<span class="hljs-string">'requestData'</span>)</span> isNeedRequestUpdate: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  requestData() {</li><li>    ActionUtils.updateControlCardAction(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">this</span>.formId);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L39-L240" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L47-L58" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/model/ActionUtils.ets</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">updateControlCardAction</span>(<span class="hljs-variable">component</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span>) {</li><li>  <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable">component</span>, {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-title class_">FormCarAction</span>.<span class="hljs-title class_">CALL</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">ENTRY_ABILITY</span>,</li><li>    <span class="hljs-variable">params</span>: {</li><li>      <span class="hljs-variable">method</span>: <span class="hljs-title class_">CallMethod</span>.<span class="hljs-title class_">REQUEST_UPDATE_CARD</span>,</li><li>      <span class="hljs-variable">formId</span>: <span class="hljs-title class_">formId</span>,</li><li>    },</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L47-L58" target="_blank">ActionUtils.ets</a></div></div></div></div> <p>应用主进程EntryAbility收到call事件后，根据卡片ID对卡片数据进行更新。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L41-L459" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  requestUpdatePlayCard = <span class="hljs-function">(<span class="hljs-params">data: rpc.MessageSequence</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'requestUpdatePlayCard'</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data.<span class="hljs-title function_">readString</span>());</li><li>    <span class="hljs-keyword">let</span> formId = params.<span class="hljs-property">formId</span>;</li><li>    <span class="hljs-keyword">if</span> (formId) {</li><li>      <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateMusicControlSingle</span>(context, formId);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'requestUpdatePlayCard'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">requestUpdatePlayCard</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L41-L459" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>在卡片更新前需要获取卡片更新的相关数据，获取音乐播放状态isPlay、播放的歌曲信息songItem以及从数据库中获取歌曲的收藏状态，然后调用FormUtils的updateForm()方法更新卡片。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L45-L450" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateMusicControlSingle</span>(<span class="hljs-params">context: Context, formId: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">let</span> isPlay = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'isPlay'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">songItem</span>: <span class="hljs-title class_">SongItem</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'currentSong'</span>) <span class="hljs-keyword">as</span> <span class="hljs-title class_">SongItem</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">collectedSongList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">SongItem</span>&gt; = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SongRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(context).<span class="hljs-title function_">queryCollectedSongs</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormControlData</span>();</li><li>    formData.<span class="hljs-property">isPlay</span> = isPlay;</li><li>    formData.<span class="hljs-property">formId</span> = formId;</li><li>    formData.<span class="hljs-property">singer</span> = songItem.<span class="hljs-property">singer</span>;</li><li>    formData.<span class="hljs-property">title</span> = songItem.<span class="hljs-property">title</span>;</li><li>    formData.<span class="hljs-property">songId</span> = songItem.<span class="hljs-property">id</span>;</li><li>    formData.<span class="hljs-property">musicCover</span> = songItem.<span class="hljs-property">label</span>;</li><li>    formData.<span class="hljs-property">isCollected</span> = collectedSongList.<span class="hljs-title function_">findIndex</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">id</span> === songItem.<span class="hljs-property">id</span>) &gt;= <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateForm</span>(formData.<span class="hljs-property">formId</span>, formData);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L45-L450" target="_blank">FormUtils.ets</a></div></div></div></div> </li><li><strong>卡片信息持久化</strong><p>音乐播控卡片有2x2和2x4两种规格，每种规格都可创建多个卡片。为确保切换歌曲时所有相关卡片的信息能够同步更新，需根据每个卡片的唯一ID和类型进行统一管理。因此，应将这些信息持久化存储，以便在需要时查询并准确刷新卡片内容，保持数据一致性。</p> <p>当用户长按桌面应用图标以展示卡片列表时，会触发EntryFormAbility的生命周期方法onAddForm()。在此回调函数中，可以利用关系型数据库relationalStore保存卡片的相关信息，如卡片ID、名称等。而当卡片被移除时，则应在onRemoveForm()回调函数中同步删除数据库中的相应记录，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L39-L211" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-params">want: Want</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onAddForm'</span>);</li><li>    <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>) {</li><li>      <span class="hljs-keyword">let</span> formId = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_identity'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> formName = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_name'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> formDimension = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_dimension'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>
</li><li>      <span class="hljs-keyword">let</span> formInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormInfo</span>();</li><li>      formInfo.<span class="hljs-property">formId</span> = formId;</li><li>      formInfo.<span class="hljs-property">formDimension</span> = formDimension;</li><li>      formInfo.<span class="hljs-property">formName</span> = formName;</li><li>      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onAddForm formInfo: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(formInfo)}</span>`</span>);</li><li>      <span class="hljs-title class_">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">insertForm</span>(formInfo);</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onRemoveForm</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span></span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onRemoveForm'</span>);</li><li>    <span class="hljs-comment">// Called to notify the form provider that a specified form has been destroyed.</span></li><li>    <span class="hljs-title class_">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>).<span class="hljs-title function_">deleteForm</span>(formId);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L39-L211" target="_blank">EntryFormAbility.ets</a></div></div></div></div> </li><li><strong>实现卡片播控功能</strong><p>为了确保卡片和应用的播放状态始终保持同步，无论是在音乐应用的播放页面还是在桌面卡片上点击播放、暂停、上一首或下一首按钮，都应即时更新卡片和应用的播放界面信息。</p> <ol><li>发送音乐播控相关的call事件。<p>给“播放/暂停”等播控相关的组件绑定onClick事件，调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-postcardaction" target="_blank">postCardAction</a>接口触发call事件，向音乐应用发送音乐播控信息。postCardAction方法封装在ActionUtils里面，参数action为事件类型，值为FormCarAction.CALL（枚举值为“call”）；method为方法名，用于触发UIAbility中对应的方法；type为播控操作类型，例如PlayActionType.PLAY表示播放。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L44-L245" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li>let storageUpdateCall = new LocalStorage();</li><li>
</li><li><span class="hljs-meta">@Entry(storageUpdateCall)</span></li><li><span class="hljs-meta">@Component</span></li><li>struct PlayControlCard2x4 {</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'formId'</span>)</span> formId: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'isPlay'</span>)</span> isPlay: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  build() {</li><li>    RelativeContainer() {</li><li>      <span class="hljs-comment">// ...</span></li><li>      Row() {</li><li>        SymbolGlyph($r(<span class="hljs-string">'sys.symbol.backward_end_fill'</span>))</li><li>          .fontSize(<span class="hljs-number">24</span>)</li><li>          .fontColor([<span class="hljs-string">'#E5FFFFFF'</span>])</li><li>          .onClick(() =&gt; {</li><li>            ActionUtils.playByAction(<span class="hljs-keyword">this</span>, PlayActionType.PREVIOUS, <span class="hljs-keyword">this</span>.formId);</li><li>          })</li><li>        SymbolGlyph(<span class="hljs-keyword">this</span>.isPlay ? $r(<span class="hljs-string">'sys.symbol.pause'</span>) : $r(<span class="hljs-string">'sys.symbol.play_fill'</span>))</li><li>          <span class="hljs-comment">// ...</span></li><li>          .onClick(() =&gt; {</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isPlay) {</li><li>              ActionUtils.playByAction(<span class="hljs-keyword">this</span>, PlayActionType.PAUSE, <span class="hljs-keyword">this</span>.formId);</li><li>            } <span class="hljs-keyword">else</span> {</li><li>              ActionUtils.playByAction(<span class="hljs-keyword">this</span>, PlayActionType.PLAY, <span class="hljs-keyword">this</span>.formId);</li><li>            }</li><li>          })</li><li>        SymbolGlyph($r(<span class="hljs-string">'sys.symbol.forward_end_fill'</span>))</li><li>          <span class="hljs-comment">// ...</span></li><li>          .onClick(() =&gt; {</li><li>            ActionUtils.playByAction(<span class="hljs-keyword">this</span>, PlayActionType.NEXT, <span class="hljs-keyword">this</span>.formId);</li><li>          })</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L44-L245" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L26-L43" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/model/ActionUtils.ets</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">playByAction</span>(<span class="hljs-variable">component</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">PlayActionType</span>, <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span>) {</li><li>  <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable">component</span>, {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-title class_">FormCarAction</span>.<span class="hljs-title class_">CALL</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">ENTRY_ABILITY</span>,</li><li>    <span class="hljs-variable">params</span>: {</li><li>      <span class="hljs-variable">method</span>: <span class="hljs-title class_">CallMethod</span>.<span class="hljs-title class_">PLAY_BY_ACTION</span>,</li><li>      <span class="hljs-variable">playActionType</span>: <span class="hljs-keyword">type</span>,</li><li>      <span class="hljs-variable">formId</span>: <span class="hljs-title class_">formId</span>,</li><li>    },</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L26-L43" target="_blank">ActionUtils.ets</a></div></div></div></div> </li><li>订阅和处理卡片发送的call事件。<p>在EntryAbility（即应用主进程的入口UIAbility）的onCreate方法中，使用callee.on()方法订阅卡片发送的call事件。当EntryAbility接收到call事件后，根据事件类型playActionType，调用MediaService中的playByAction()方法来控制音乐播放。MediaService封装了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/media-kit-intro#avplayer" target="_blank">AVPlayer</a>的媒体播放功能，如歌曲资源加载、播放/暂停等，具体实现可以参考<a href="https://gitee.com/harmonyos_samples/MusicCard" target="_blank">音乐服务卡片</a>示例代码中的MediaService.ets源码。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L43-L480" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  playByActionCall = <span class="hljs-function">(<span class="hljs-params">data: rpc.MessageSequence</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data.<span class="hljs-title function_">readString</span>());</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`playByActionCall playActionType:<span class="hljs-subst">${params.playActionType}</span>`</span>);</li><li>      <span class="hljs-keyword">if</span> (params.<span class="hljs-property">playActionType</span>) {</li><li>        <span class="hljs-keyword">let</span> <span class="hljs-attr">playActionType</span>: <span class="hljs-title class_">PlayActionType</span> = params.<span class="hljs-property">playActionType</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">PlayActionType</span>;</li><li>        <span class="hljs-keyword">if</span> (isInitSuccess) {</li><li>          <span class="hljs-title class_">MediaService</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">playByAction</span>(playActionType);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initSongData</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>            <span class="hljs-title class_">MediaService</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">playByAction</span>(playActionType);</li><li>          });</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`playByActionCall err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  };</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'playByAction'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">playByActionCall</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`playByAction register failed with error <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'Ability onDestroy'</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'playByAction'</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDestroy err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L43-L480" target="_blank">EntryAbility.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/MediaService.ets#L390-L409" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/MediaService.ets</span></li><li><span class="hljs-keyword">public</span> playByAction(action: PlayActionType): void {</li><li>  switch (action) {</li><li>    case PlayActionType.PAUSE:</li><li>      <span class="hljs-keyword">this</span>.pause();</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PlayActionType.PLAY:</li><li>      <span class="hljs-keyword">this</span>.isFirstLoadAsset = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-keyword">this</span>.play();</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PlayActionType.PREVIOUS:</li><li>      <span class="hljs-keyword">this</span>.playPrevious();</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case PlayActionType.NEXT:</li><li>      <span class="hljs-keyword">this</span>.playNext();</li><li>      <span class="hljs-keyword">break</span>;</li><li>    default:</li><li>      <span class="hljs-keyword">break</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/MediaService.ets#L390-L409" target="_blank">MediaService.ets</a></div></div></div></div> </li><li>根据媒体播放状态更新卡片和应用播放界面信息。<p>点击卡片的播放/暂停等按钮，拉起EntryAbility至后台播放/暂停歌曲时，卡片上的播放状态需要同步更新。</p> <p>在EntryAbility的onCreate方法中，调用MediaService的setOnPlayStateCall()方法监听播放状态（如播放/暂停、上一曲/下一曲）变化。在setOnPlayStateCall()回调函数中，将播放状态isPlay和歌曲信息保存到AppStorage，以同步刷新应用界面。然后调用FormUtils的updateMusicControlCards()方法更新卡片数据，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L44-L481" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li>export default <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-title">extends</span> <span class="hljs-title">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  onCreate(want: Want, launchParam: AbilityConstant.LaunchParam) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    MediaService.getInstance().setOnPlayStateCall(async (<span class="hljs-keyword">data</span>: SongChangedData) =&gt; {</li><li>      <span class="hljs-comment">// ...</span></li><li>      AppStorage.setOrCreate(<span class="hljs-string">'isPlay'</span>, <span class="hljs-keyword">data</span>.isPlay);</li><li>      AppStorage.setOrCreate(<span class="hljs-string">'selectIndex'</span>, <span class="hljs-keyword">data</span>.selectIndex);</li><li>      AppStorage.setOrCreate(<span class="hljs-string">'currentSong'</span>, <span class="hljs-keyword">data</span>.songItem);</li><li>      PreferencesUtil.getInstance().putCurrentSong(context, <span class="hljs-keyword">data</span>.songItem);</li><li>      FormUtils.updateMusicControlCards(<span class="hljs-keyword">this</span>.context, <span class="hljs-keyword">data</span>.songItem, <span class="hljs-keyword">data</span>.isPlay);</li><li>
</li><li>      <span class="hljs-comment">// ...</span></li><li>    });</li><li>
</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L44-L481" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>卡片的更新需要根据卡片的ID进行更新，通过调用formProvider.updateForm()方法来实现。所以在更新卡片之前，需先从数据库中获取所有待更新的卡片集合，随后遍历该集合，依据formId批量更新2x2和2x4两种规格的所有相关音乐播控卡片，确保它们的数据一致性。更新的内容包括播放状态（isPlay）、歌手名（singer）和歌曲封面（musicCover）等。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L46-L451" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateMusicControlCards</span>(<span class="hljs-params">context: Context, songItem: SongItem, isPlay: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FormInfo</span>&gt; = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(context).<span class="hljs-title function_">queryFormByName</span>(<span class="hljs-string">'PlayControlCard'</span>);</li><li>    <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormControlData</span>();</li><li>    formData.<span class="hljs-property">isPlay</span> = isPlay;</li><li>    formData.<span class="hljs-property">singer</span> = songItem.<span class="hljs-property">singer</span>;</li><li>    formData.<span class="hljs-property">title</span> = songItem.<span class="hljs-property">title</span>;</li><li>    formData.<span class="hljs-property">songId</span> = songItem.<span class="hljs-property">id</span>;</li><li>    formData.<span class="hljs-property">musicCover</span> = songItem.<span class="hljs-property">label</span>;</li><li>    formData.<span class="hljs-property">isCollected</span> = isCollected;</li><li>    formData.<span class="hljs-property">imageColor</span> = imageDealData.<span class="hljs-property">imageColor</span>;</li><li>    formData.<span class="hljs-property">imageColorHex</span> = imageDealData.<span class="hljs-property">imageColorHex</span>;</li><li>
</li><li>    formList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">formInfo</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateForm</span>(formInfo.<span class="hljs-property">formId</span>, formData);</li><li>    });</li><li>  }</li><li>
</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title function_">updateForm</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span>, updateData: <span class="hljs-built_in">object</span></span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm  updateData: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(updateData)}</span>}`</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formMsg</span>: formBindingData.<span class="hljs-property">FormBindingData</span> = formBindingData.<span class="hljs-title function_">createFormBindingData</span>(updateData);</li><li>    formProvider</li><li>      .<span class="hljs-title function_">updateForm</span>(formId, formMsg)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm success formId:  <span class="hljs-subst">${formId}</span>}`</span>);</li><li>      })</li><li>      .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateForm failed: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>      });</li><li>  }</li><li>
</li><li>
</li><li>
</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L46-L451" target="_blank">FormUtils.ets</a></div></div></div></div>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><caption><b>表3 </b>音乐播控卡片更新效果图</caption><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.15.6.4.3.3.6.2.4.1.1" valign="top" width="33.33333333333333%"><p>批量更新卡片</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.15.6.4.3.3.6.2.4.1.2" valign="top" width="33.33333333333333%"><p>通过卡片切换歌曲，卡片和应用均更新数据</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.15.6.4.3.3.6.2.4.1.3" valign="top" width="33.33333333333333%"><p>通过应用切换歌曲，卡片和应用均更新数据</p> </th> </tr> </thead> <tbody><tr><td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="548.969204" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.52208225810218583759682916201809:50001231000000:2800:989EC3D52476DE24153268AD81CB9085B082A3F7CB346931B48CC0CBC30C6A01.gif" title="点击放大" width="265.33500000000004"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="548.969204" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.75951253215998519139491093173496:50001231000000:2800:EBFA3516280524F22BCE6C03EBA2BE57377248F7678D695AD6B78D2444DB534B.gif" title="点击放大" width="265.33500000000004"></span></p> </td> <td align="center" class="cellrowborder" valign="top" width="33.33333333333333%"><p><span><img height="546.90531" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211162959.40243054613335244081226756667904:50001231000000:2800:CEB863D0B3AAD1E3B0367BC3822902CF3DF40D23A674DCCAE0E9EB366A7992B8.gif" title="点击放大" width="264.33750000000003"></span></p> </td> </tr>  </tbody></table></div> </div> </li><li>应用进程被销毁前更新播放状态。<p>当应用进程被销毁的时候，如果此时音乐卡片处于播放状态（显示暂停图标），应用应该更新卡片为未播放的状态（显示播放图标），并将状态更新同步到卡片UI。应用主进程被销毁前会触发EntryAbility里面的onDestroy()生命周期回调方法，在此方法中执行卡片更新逻辑，更新卡片播放状态isPlay为false。示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L45-L482" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">let</span> isPlay = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'isPlay'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">boolean</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (isPlay) {</li><li>        <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateCardPlayStatus</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-literal">false</span>);</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDestroy err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L45-L482" target="_blank">EntryAbility.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L48-L453" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">updateCardCollectStatus</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-variable">isCollected</span>: <span class="hljs-title class_">boolean</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">updateData</span>: <span class="hljs-title class_">UpdateData</span> = {</li><li>      <span class="hljs-variable">isCollected</span>: <span class="hljs-title class_">isCollected</span>,</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">formList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FormInfo</span>&gt; = <span class="hljs-variable">await</span> <span class="hljs-variable">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable">context</span>).<span class="hljs-title function_">queryFormByName</span>(<span class="hljs-string">'PlayControlCard'</span>);</li><li>    <span class="hljs-variable">formList</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">formInfo</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">updateForm</span>(<span class="hljs-variable">formInfo</span>.<span class="hljs-variable">formId</span>, <span class="hljs-variable">updateData</span>);</li><li>    });</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L48-L453" target="_blank">FormUtils.ets</a></div></div></div></div> </li></ol> </li><li><strong>实现卡片收藏功能</strong><p>收藏功能和音乐播控的实现方式相同，都是通过call事件拉起应用主进程至后台，应用主进程通过callee.on()监听到收藏的call事件后，进行收藏业务处理，然后更新卡片。</p> <ol><li>卡片发送收藏call事件给应用。<p>首先在卡片侧给收藏图标添加onClick事件，绑定postAction事件，发送收藏操作call事件。变量isCollected表示收藏状态，用于接收应用更新的收藏状态数据。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L41-L242" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li>let storageUpdateCall = new LocalStorage();</li><li>
</li><li><span class="hljs-meta">@Entry(storageUpdateCall)</span></li><li><span class="hljs-meta">@Component</span></li><li>struct PlayControlCard2x4 {</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'formId'</span>)</span> formId: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'isPlay'</span>)</span> isPlay: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'isCollected'</span>)</span> isCollected: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'musicCover'</span>)</span> musicCover: Resource = $r(<span class="hljs-string">'app.media.ic_dream'</span>);</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'singer'</span>)</span> singer: string = <span class="hljs-string">'Singer'</span>;</li><li>  <span class="hljs-meta">@LocalStorageProp(<span class="hljs-string">'songId'</span>)</span> songId: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// ...</span></li><li>  build() {</li><li>    RelativeContainer() {</li><li>      Image(<span class="hljs-keyword">this</span>.musicCover)</li><li>        <span class="hljs-comment">// ...</span></li><li>      SymbolGlyph(<span class="hljs-keyword">this</span>.isCollected ? $r(<span class="hljs-string">'sys.symbol.heart_fill'</span>) : $r(<span class="hljs-string">'sys.symbol.heart'</span>))</li><li>        <span class="hljs-comment">// ...</span></li><li>        .onClick(() =&gt; {</li><li>          <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isCollected) {</li><li>            ActionUtils.collectAction(<span class="hljs-keyword">this</span>, CollectAction.UNCOLLECTED, <span class="hljs-keyword">this</span>.formId, <span class="hljs-keyword">this</span>.songId);</li><li>          } <span class="hljs-keyword">else</span> {</li><li>            ActionUtils.collectAction(<span class="hljs-keyword">this</span>, CollectAction.COLLECTED, <span class="hljs-keyword">this</span>.formId, <span class="hljs-keyword">this</span>.songId);</li><li>          }</li><li>        })</li><li>      <span class="hljs-comment">// ...</span></li><li>      Row() {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L41-L242" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L69-L82" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/model/ActionUtils.ets</span></li><li><span class="hljs-title function_">collectAction</span>(<span class="hljs-variable">component</span>: <span class="hljs-title class_">Object</span>, <span class="hljs-keyword">type</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">songId</span>: <span class="hljs-title class_">string</span>) {</li><li>  <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable">component</span>, {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-title class_">FormCarAction</span>.<span class="hljs-title class_">CALL</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">ENTRY_ABILITY</span>,</li><li>    <span class="hljs-variable">params</span>: {</li><li>      <span class="hljs-variable">method</span>: <span class="hljs-title class_">CallMethod</span>.<span class="hljs-title class_">COLLECT_ACTION</span>,</li><li>      <span class="hljs-variable">collectActionType</span>: <span class="hljs-keyword">type</span>,</li><li>      <span class="hljs-variable">formId</span>: <span class="hljs-title class_">formId</span>,</li><li>      <span class="hljs-variable">songId</span>: <span class="hljs-title class_">songId</span>,</li><li>    },</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L69-L82" target="_blank">ActionUtils.ets</a></div></div></div></div> </li><li>订阅和处理卡片发送的收藏call事件。<p>在EntryAbility的onCreate方法中订阅卡片发送的收藏call事件，获取call事件携带的参数collectActionType，collectActionType为CollectAction.COLLECTED的时候表示收藏操作，为CollectAction.UNCOLLECTED的时候，表示取消收藏。根据collectActionType的值更新数据库中的收藏状态数据，再更新卡片的收藏状态。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L46-L483" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  collectActionCall = <span class="hljs-function">(<span class="hljs-params">data: rpc.MessageSequence</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data.<span class="hljs-title function_">readString</span>());</li><li>      <span class="hljs-keyword">if</span> (params.<span class="hljs-property">collectActionType</span>) {</li><li>        <span class="hljs-keyword">let</span> songRdbHelper = <span class="hljs-title class_">SongRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(context);</li><li>        <span class="hljs-keyword">if</span> (params.<span class="hljs-property">collectActionType</span> === <span class="hljs-title class_">CollectAction</span>.<span class="hljs-property">COLLECTED</span>) {</li><li>          songRdbHelper.<span class="hljs-title function_">updateCollected</span>(params.<span class="hljs-property">songId</span>, <span class="hljs-title class_">CollectAction</span>.<span class="hljs-property">COLLECTED</span>);</li><li>          <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateCardCollectStatus</span>(context, <span class="hljs-literal">true</span>);</li><li>          context.<span class="hljs-property">eventHub</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'collected'</span>, params.<span class="hljs-property">songId</span>, <span class="hljs-title class_">CollectAction</span>.<span class="hljs-property">COLLECTED</span>);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>          songRdbHelper.<span class="hljs-title function_">updateCollected</span>(params.<span class="hljs-property">songId</span>, <span class="hljs-title class_">CollectAction</span>.<span class="hljs-property">UNCOLLECTED</span>);</li><li>          <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateCardCollectStatus</span>(context, <span class="hljs-literal">false</span>);</li><li>          context.<span class="hljs-property">eventHub</span>.<span class="hljs-title function_">emit</span>(<span class="hljs-string">'collected'</span>, params.<span class="hljs-property">songId</span>, <span class="hljs-title class_">CollectAction</span>.<span class="hljs-property">UNCOLLECTED</span>);</li><li>        }</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`collectActionCall err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;</li><li>  };</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'collectAction'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">collectActionCall</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`playByAction register failed with error <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(error)}</span>`</span>);</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onDestroy</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">callee</span>.<span class="hljs-title function_">off</span>(<span class="hljs-string">'collectAction'</span>);</li><li>      <span class="hljs-comment">// ...</span></li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onDestroy err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L46-L483" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>批量更新卡片。<p>卡片的收藏状态更新，和播控状态更新逻辑相同，同样需要批量更新多个播控卡片，在更新前需要在数据库中查询所有桌面上的音乐播控卡片，然后遍历更新。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L48-L453" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">updateCardCollectStatus</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-variable">isCollected</span>: <span class="hljs-title class_">boolean</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">updateData</span>: <span class="hljs-title class_">UpdateData</span> = {</li><li>      <span class="hljs-variable">isCollected</span>: <span class="hljs-title class_">isCollected</span>,</li><li>    };</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">formList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FormInfo</span>&gt; = <span class="hljs-variable">await</span> <span class="hljs-variable">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable">context</span>).<span class="hljs-title function_">queryFormByName</span>(<span class="hljs-string">'PlayControlCard'</span>);</li><li>    <span class="hljs-variable">formList</span>.<span class="hljs-title function_">forEach</span>((<span class="hljs-variable">formInfo</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">updateForm</span>(<span class="hljs-variable">formInfo</span>.<span class="hljs-variable">formId</span>, <span class="hljs-variable">updateData</span>);</li><li>    });</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L48-L453" target="_blank">FormUtils.ets</a></div></div></div></div> <p>同理应用主进程进行收藏/取消收藏操作时，也需要更新卡片，使卡片和应用主进程收藏状态保持一致。给歌曲列表项的收藏图标，绑定onClick事件，调用FormUtils工具类的updateCardCollectStatus()方法更新卡片收藏状态。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/SongListItem.ets#L22-L110" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-meta">@Reusable</span></li><li><span class="hljs-meta">@Component</span></li><li>export struct SongListItem {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  async collected() {</li><li>    let context = <span class="hljs-keyword">this</span>.getUIContext().getHostContext()!</li><li>    let songRdbHelper = SongRdbHelper.getInstance(context);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.item.isCollected) {</li><li>      await songRdbHelper.updateCollected(<span class="hljs-keyword">this</span>.item.id, <span class="hljs-string">'0'</span>);</li><li>      FormUtils.updateCardCollectStatus(context, <span class="hljs-literal">false</span>);</li><li>      <span class="hljs-keyword">this</span>.item.isCollected = <span class="hljs-literal">false</span>;</li><li>      context.eventHub.emit(<span class="hljs-string">'collected'</span>, <span class="hljs-keyword">this</span>.item.id, <span class="hljs-string">'0'</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      await songRdbHelper.updateCollected(<span class="hljs-keyword">this</span>.item.id, <span class="hljs-string">'1'</span>);</li><li>      FormUtils.updateCardCollectStatus(context, <span class="hljs-literal">true</span>);</li><li>      <span class="hljs-keyword">this</span>.item.isCollected = <span class="hljs-literal">true</span>;</li><li>      context.eventHub.emit(<span class="hljs-string">'collected'</span>, <span class="hljs-keyword">this</span>.item.id, <span class="hljs-string">'1'</span>);</li><li>    }</li><li>  }</li><li>
</li><li>  build() {</li><li>    Row() {</li><li>      <span class="hljs-comment">// ...</span></li><li>        Image(<span class="hljs-keyword">this</span>.item.isCollected ? $r(<span class="hljs-string">'app.media.ic_item_collected'</span>) :</li><li>        $r(<span class="hljs-string">'app.media.ic_item_uncollected'</span>))<span class="hljs-comment">// ...</span></li><li>          .onClick(() =&gt; {</li><li>            <span class="hljs-keyword">this</span>.collected();</li><li>          })</li><li>      }</li><li>    }</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/SongListItem.ets#L22-L110" target="_blank">SongListItem.ets</a></div></div></div></div> </li></ol> </li><li><strong>实现沉浸式卡片效果</strong><p>整个卡片的色调跟随歌曲封面图片来进行变化，这种沉浸式效果会给用户不断变化的视觉感受，防止了固定的UI色彩造成用户的审美疲劳。可以利用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit" target="_blank">effectKit</a>图像效果的智能取色<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-effectkit#colorpicker" target="_blank">ColorPicker</a>取出歌曲封面图片的主颜色，以实现沉浸式UI效果。当歌曲切换的时候，可以先对歌曲封面图片进行取色，将歌曲封面图片的颜色imageColorHex更新给卡片。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L49-L454" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateMusicControlCards</span>(<span class="hljs-params">context: Context, songItem: SongItem, isPlay: <span class="hljs-built_in">boolean</span></span>) {</li><li>    <span class="hljs-keyword">let</span> isCollected = <span class="hljs-keyword">await</span> <span class="hljs-title class_">SongRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(context).<span class="hljs-title function_">isCollected</span>(songItem.<span class="hljs-property">id</span>);</li><li>    <span class="hljs-keyword">let</span> imageDealData = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ImageUtils</span>.<span class="hljs-title function_">getImageDealData</span>(context, songItem.<span class="hljs-property">label</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formList</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">FormInfo</span>&gt; = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(context).<span class="hljs-title function_">queryFormByName</span>(<span class="hljs-string">'PlayControlCard'</span>);</li><li>    <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormControlData</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>    formData.<span class="hljs-property">imageColorHex</span> = imageDealData.<span class="hljs-property">imageColorHex</span>;</li><li>
</li><li>    formList.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">formInfo</span>) =&gt;</span> {</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateForm</span>(formInfo.<span class="hljs-property">formId</span>, formData);</li><li>    });</li><li>  }</li><li>
</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L49-L454" target="_blank">FormUtils.ets</a></div></div></div></div> <p>使用effectKit模块的colorPicker.getMainColorSync()方法，获取封面图片主要颜色，转化为十六进制格式数据。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/ImageUtils.ets#L35-L212" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getImageDealData</span>(<span class="hljs-attr">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-attr">imgRes</span>: <span class="hljs-title class_">Resource</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ImageDealData</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> value = context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getMediaContentSync</span>(imgRes.<span class="hljs-property">id</span>);</li><li>        <span class="hljs-keyword">let</span> imageData = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getImageDealDataByArr</span>(value.<span class="hljs-property">buffer</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>);</li><li>        <span class="hljs-title function_">resolve</span>(imageData);</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getImageDealData err :<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>        <span class="hljs-title function_">reject</span>(err);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-title function_">getImageDealDataByArr</span>(<span class="hljs-attr">buffer</span>: <span class="hljs-title class_">ArrayBuffer</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">ImageDealData</span>&gt; {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">async</span> (resolve, reject) =&gt; {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        <span class="hljs-keyword">let</span> pixelMap = image.<span class="hljs-title function_">createImageSource</span>(buffer).<span class="hljs-title function_">createPixelMapSync</span>();</li><li>        <span class="hljs-keyword">if</span> (buffer.<span class="hljs-property">byteLength</span> &gt; <span class="hljs-number">2048</span> * <span class="hljs-number">1024</span>) {</li><li>          pixelMap = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">compressImage</span>(pixelMap, <span class="hljs-number">2048</span>);</li><li>        }</li><li>        <span class="hljs-keyword">let</span> imageData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageDealData</span>();</li><li>        <span class="hljs-keyword">let</span> colorPicker = <span class="hljs-keyword">await</span> effectKit.<span class="hljs-title function_">createColorPicker</span>(pixelMap);</li><li>        <span class="hljs-keyword">let</span> mainColor = colorPicker.<span class="hljs-title function_">getMainColorSync</span>();</li><li>        <span class="hljs-keyword">let</span> colorArr = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dealColor</span>(mainColor.<span class="hljs-property">red</span>, mainColor.<span class="hljs-property">green</span>, mainColor.<span class="hljs-property">blue</span>);</li><li>        <span class="hljs-keyword">let</span> imageColor = <span class="hljs-string">`rgba(<span class="hljs-subst">${colorArr[<span class="hljs-number">0</span>]}</span>, <span class="hljs-subst">${colorArr[<span class="hljs-number">1</span>]}</span>, <span class="hljs-subst">${colorArr[<span class="hljs-number">2</span>]}</span>, 1)`</span>;</li><li>        <span class="hljs-keyword">let</span> imageColorHex = <span class="hljs-string">`<span class="hljs-subst">${colorArr[<span class="hljs-number">0</span>].toString(<span class="hljs-number">16</span>)}</span><span class="hljs-subst">${colorArr[<span class="hljs-number">1</span>].toString(<span class="hljs-number">16</span>)}</span><span class="hljs-subst">${colorArr[<span class="hljs-number">2</span>].toString(<span class="hljs-number">16</span>)}</span>`</span>;</li><li>        <span class="hljs-comment">// ...</span></li><li>        imageData.<span class="hljs-property">imageColorHex</span> = imageColorHex;</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title function_">resolve</span>(imageData);</li><li>      } <span class="hljs-keyword">catch</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`getImageDealDataByArr err :<span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>        <span class="hljs-title function_">reject</span>(err);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/ImageUtils.ets#L35-L212" target="_blank">ImageUtils.ets</a></div></div></div></div> <p>卡片侧获取到图片颜色imageColorHex后<strong> </strong>，颜色的数据格式为rgb，可以使用linearGradient属性，给imageColorHex设置不同的透明度，做渐变色处理，使卡片背景平滑过渡自然。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L42-L243" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li><span class="hljs-keyword">let</span> storageUpdateCall = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span>(storageUpdateCall)</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PlayControlCard2</span>x4 {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'imageColorHex'</span>) <span class="hljs-attr">imageColorHex</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">'18191d'</span>;</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">ActionUtils</span>.<span class="hljs-title function_">jumpPlayPage</span>(<span class="hljs-variable language_">this</span>);</li><li>    })</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L42-L243" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> <div class="p">效果图如下：<div class="fignone"><span class="figcap"><b>图8 </b>卡片沉浸效果图</span></div> </div> <div class="p"><span><img height="431.332965" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.76139712786938578327371814185860:50001231000000:2800:E0C3951CE94BA090D9B7E2D1B9C9B49CE40EA3BC0B0B82BB0355B6B799680568.gif" title="点击放大" width="208.47750000000002"></span><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>智能取色Picker目前支持取出PixelMap图片中的主要颜色、平均颜色、饱和度最高、以及占比靠前的颜色。在沉浸式UI中应避免出现纯白色或者纯黑色的色调背景，防止服务卡片的其他组件及内容受到影响。</p> </div></div></div> </div> </li><li><strong>从播控卡片拉起播放页面</strong><p>当用户点击卡片播控组件（“播放/暂停”等播控相关组件）以外的区域时，可以通过router事件来实现，拉起应用主进程的EntryAbility。</p> <p>给卡片最外层布局RelativeContainer绑定onClick事件，通过postCardAction发送router事件，设置参数type的值为RouterType.PLAYER，表示该router事件的目的是拉起播放页面。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L43-L244" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/PlayControlCard2x4.ets</span></li><li><span class="hljs-keyword">let</span> storageUpdateCall = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>
</li><li><span class="hljs-meta">@Entry</span>(storageUpdateCall)</li><li><span class="hljs-meta">@Component</span></li><li>struct <span class="hljs-title class_">PlayControlCard2</span>x4 {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@LocalStorageProp</span>(<span class="hljs-string">'songId'</span>) <span class="hljs-attr">songId</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">RelativeContainer</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">ActionUtils</span>.<span class="hljs-title function_">jumpPlayPage</span>(<span class="hljs-variable language_">this</span>);</li><li>    })</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/PlayControlCard2x4.ets#L43-L244" target="_blank">PlayControlCard2x4.ets</a></div></div></div></div> <p></p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L86-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/model/ActionUtils.ets</span></li><li><span class="hljs-title function_">jumpPlayPage</span>(<span class="hljs-variable">component</span>: <span class="hljs-title class_">Object</span>) {</li><li>  <span class="hljs-title function_">postCardAction</span>(<span class="hljs-variable">component</span>, {</li><li>    <span class="hljs-variable">action</span>: <span class="hljs-title class_">FormCarAction</span>.<span class="hljs-title class_">ROUTER</span>,</li><li>    <span class="hljs-variable">abilityName</span>: <span class="hljs-title class_">ENTRY_ABILITY</span>,</li><li>    <span class="hljs-variable">params</span>: {</li><li>      <span class="hljs-keyword">type</span>: <span class="hljs-title class_">RouterType</span>.<span class="hljs-title class_">PLAYER</span>,</li><li>    },</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/model/ActionUtils.ets#L86-L96" target="_blank">ActionUtils.ets</a></div></div></div></div> <p>如果EntryAbility未在后台运行，拉起UIAbility的时候会触发onCreate生命周期回调；如果EntryAbility已在后台运行，会触发onNewWant()生命周期回调。可以分别在EntryAbility的onCreate和onNewWant中获取卡片传递过来的router事件参数type。当type为RouterType.PLAYER时，使用AppStorage设置isShowPlay为true，用来拉起播放界面。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L485" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleParams</span>(want);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleParams</span>(want);</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">handleParams</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'handleParams'</span>);</li><li>    <span class="hljs-keyword">if</span> (want?.<span class="hljs-property">parameters</span>?.<span class="hljs-property">params</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(want.<span class="hljs-property">parameters</span>.<span class="hljs-property">params</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-keyword">type</span> = params.<span class="hljs-property">type</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">RouterType</span>.<span class="hljs-property">PLAYLISTS</span>) {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isToHotPlaylist'</span>, <span class="hljs-literal">true</span>);</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">RouterType</span>.<span class="hljs-property">COLLECTED</span>) {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'mainTabIndex'</span>, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isShowPlay'</span>, <span class="hljs-literal">false</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L485" target="_blank">EntryAbility.ets</a></div></div></div></div> <p>播放页面是通过bindContentCover方法绑定的一个弹窗，通过状态变量isShowPlay来控制其显示和隐藏，isShowPlay使用@StorageLink装饰器修饰用于接收EntryAbility中isShowPlay的值，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/PlayController.ets#L24-L188" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/components/PlayController.ets</span></li><li><span class="hljs-meta">@Component</span></li><li><span class="hljs-keyword">export</span> struct <span class="hljs-title class_">PlayController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-meta">@StorageLink</span>(<span class="hljs-string">'isShowPlay'</span>) <span class="hljs-attr">isShowPlay</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-title class_">Row</span>() {</li><li>      <span class="hljs-title class_">Row</span>() {</li><li>        <span class="hljs-comment">// ...</span></li><li>      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowPlay</span> = <span class="hljs-literal">true</span>;</li><li>      })</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  <span class="hljs-title class_">MusicPlayBuilder</span>() {</li><li>    <span class="hljs-title class_">PlayerView</span>({ <span class="hljs-attr">isShowPlay</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">isShowPlay</span> })</li><li>      .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>      .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>      <span class="hljs-comment">// ...</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/PlayController.ets#L24-L188" target="_blank">PlayController.ets</a></div></div></div></div> <div class="p">效果图如下：<div class="fignone"><span class="figcap"><b>图9 </b>点击卡片跳转到播放页面</span><br><span><img height="454.03407000000004" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.46300352860683138470158732392299:50001231000000:2800:DEC27DBCDCBCEDD70E0CCEC40D57D4852796859CAF7766316B0EB8101F5DC547.gif" title="点击放大" width="219.45000000000002"></span></div> </div> </li></ol> </div> <div class="tiledSection"><h3 id="section1319413512335">动态歌词卡片<i class="anchor-icon anchor-icon-link" anchorid="section1319413512335" tips="复制节点链接"></i></h3><p><strong>动态歌词场景实现步骤</strong></p> </div> <p>动态歌词卡片的主要实现步骤如下：</p> <p><span><img height="80.0679420289855" originheight="116" originwidth="1310" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.27401072996407338826112774638920:50001231000000:2800:15986E53DBCDE9C15A8A756D5150CF217E92883B560026B5FF6FEE3F9FDC0817.png" title="点击放大" width="920"></span></p> <p>动态歌词目前支持2*4规格的卡片，效果图如下：</p> <div class="fignone"><span class="figcap"><b>图10 </b>动态歌词卡片效果图</span><br><span><img originheight="151" originwidth="332" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.34288281104296099102531382183731:50001231000000:2800:AFEE42C73E32F658B0DFC2DFF97ACF897E1ACF83734FF459295C3C2CDB33DA0C.png" width="332" height="151"></span></div> <p>动态歌词卡片的<strong>播控</strong>相关内容，具体实现请参考<a href="/consumer/cn/doc/best-practices/bpta-music-card#section13895124019481">音乐播控卡片</a>的详细开发流程。</p> <div class="p">动态歌词卡片的<strong>歌词切换功能</strong>开发流程如下：<ol><li>动态歌词卡片更新，具体请参考音乐播控卡片的<a href="/consumer/cn/doc/best-practices/bpta-music-card#section13895124019481">卡片数据初始化</a>内容。</li><li>更新动态歌词卡片时，需要处理歌词相关的数据，在1.音乐播控卡片的<a href="/consumer/cn/doc/best-practices/bpta-music-card#section13895124019481">卡片数据初始化</a>基础上，新增getSongLyricsArray()方法获取当前歌曲的歌词数组lrcArray，通过调用FormUtils的updateForm()方法更新卡片。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-csharp" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L253-L303" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title">updateMusicControlSingle</span>(<span class="hljs-params">context: Context, formId: <span class="hljs-built_in">string</span></span>)</span> {</li><li>  <span class="hljs-keyword">let</span> isPlay = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'isPlay'</span>) <span class="hljs-keyword">as</span> boolean;</li><li>  <span class="hljs-keyword">let</span> songItem: SongItem = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'currentSong'</span>) <span class="hljs-keyword">as</span> SongItem;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">let</span> dynamicLrcStr = getSongLyricsArray(context, songItem);</li><li>  <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> FormControlData();</li><li>  formData.isPlay = isPlay;</li><li>  formData.formId = formId;</li><li>  <span class="hljs-comment">// ...</span></li><li>  formData.lrcArray = dynamicLrcStr;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">this</span>.updateForm(formData.formId, formData);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L253-L303" target="_blank">FormUtils.ets</a></div></div></div></div> </li><li>卡片页面使用页面级的UI状态存储<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-localstorage" target="_blank">LocalStorage</a>接收onAddForm()接口传递的数据，参考音乐播控卡片的<a href="/consumer/cn/doc/best-practices/bpta-music-card#section13895124019481">卡片数据初始化</a>内容。使用装饰器@LocalStorageProp装饰的状态变量接收数据类的详细信息，装饰器@LocalStorageProp(key)中的key值需与数据类的键值一一对应。动态歌词卡片展示歌词的时候，用的就是更新卡片所新增的lrcArray歌词数组字段，用户点击播放歌曲后，就会根据播放进度显示对应歌词信息。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/DynamicLyrics.ets#L40-L209" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Entry</span>(storageUpdateCall1)</li><li><span class="hljs-variable">@Component</span></li><li>struct DynamicLyrics {</li><li>  <span class="hljs-variable">@LocalStorageProp</span>(<span class="hljs-string">'lrcArray'</span>) <span class="hljs-attribute">lrcArray</span>: Array&lt;string&gt; =</li><li>    [<span class="hljs-string">'This is lyrics sample'</span>, <span class="hljs-string">'This is lyrics sample'</span>, <span class="hljs-string">'This is lyrics sample'</span>, <span class="hljs-string">'This is lyrics sample'</span>];</li><li>  <span class="hljs-variable">@LocalStorageProp</span>(<span class="hljs-string">'formId'</span>) <span class="hljs-attribute">formId</span>: string = <span class="hljs-string">''</span>;</li><li>  <span class="hljs-variable">@LocalStorageProp</span>(<span class="hljs-string">'isPlay'</span>) <span class="hljs-attribute">isPlay</span>: boolean = false;</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/DynamicLyrics.ets#L40-L209" target="_blank">DynamicLyrics.ets</a></div></div></div></div> </li><li>为了实现歌词上一句与下一句之间平滑的切换效果，使用ForEach新增删除组件结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-transition-animation-component" target="_blank">组件内转场</a>给每一行歌词Text组件绑定transition属性，实现歌词之间显示的过渡效果。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/DynamicLyrics.ets#L89-L100" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">Column</span>() {</li><li>  <span class="hljs-title function_">ForEach</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">lrcArray</span>.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>), (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; {</li><li>    <span class="hljs-title function_">Text</span>(<span class="hljs-variable">item</span>)</li><li>      .<span class="hljs-title function_">fontSize</span>(<span class="hljs-variable">index</span> &lt;= <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentLyricIndex</span> ? <span class="hljs-number">16</span> : <span class="hljs-number">13</span>)</li><li>      .<span class="hljs-title function_">fontWeight</span>(<span class="hljs-number">700</span>)</li><li>      .<span class="hljs-title function_">fontColor</span>(<span class="hljs-variable">index</span> &lt;= <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentLyricIndex</span> ? <span class="hljs-title class_">Color</span>.<span class="hljs-title class_">White</span> : '#<span class="hljs-number">99</span><span class="hljs-title class_">FFFFFF</span>')</li><li>      .<span class="hljs-title function_">lineHeight</span>(<span class="hljs-number">30</span>)</li><li>      .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">top</span>: <span class="hljs-title class_">index</span> === <span class="hljs-number">0</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">12</span> })</li><li>      .<span class="hljs-title function_">displayPriority</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">lrcArray</span>.<span class="hljs-variable">length</span> - <span class="hljs-variable">index</span>)</li><li>      .<span class="hljs-title function_">transition</span>(<span class="hljs-variable">TransitionEffect</span>.<span class="hljs-variable">OPACITY</span>.<span class="hljs-title function_">animation</span>({ <span class="hljs-variable">duration</span>: <span class="hljs-number">200</span>, <span class="hljs-variable">curve</span>: <span class="hljs-title class_">Curve</span>.<span class="hljs-title class_">Smooth</span>,<span class="hljs-variable">tempo</span>:<span class="hljs-number">2</span> }))</li><li>  }, (<span class="hljs-variable">item</span>: <span class="hljs-title class_">string</span>, <span class="hljs-variable">index</span>: <span class="hljs-title class_">number</span>) =&gt; (<span class="hljs-variable">item</span> + <span class="hljs-variable">index</span>))</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/DynamicLyrics.ets#L89-L100" target="_blank">DynamicLyrics.ets</a></div></div></div></div> <p>动态歌词最终效果图如下：</p> <div class="fignone"><span class="figcap"><b>图11 </b>动态歌词最终效果图</span><br><span><img originheight="480" originwidth="225" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.15822924055346577467056663920984:50001231000000:2800:C03D353112BD2004866A208B77B160644593AE0CA6C66BD01C337E18C096003B.gif" class="notEnlarge" width="225" height="480"></span></div> </li></ol> </div> <p><strong>应用内添加卡片到桌面场景实现步骤</strong></p> <p>应用内<strong>添加卡片到桌面</strong>功能开发流程如下：</p> <p><span><img height="439.15536000000003" originheight="570" originwidth="391" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.81327118882993583080884047908471:50001231000000:2800:F300505B54DE5482DDF94F245E9B1595FAE8560E26B809AAB4F6B4DA2243BC68.png" title="点击放大" width="301.245"></span></p> <ol><li>配置好添加卡片的相关数据（ cardRealName：卡片名称；cardDimension：卡片类型； displayName：显示名称； description：卡片描述； url：预览图），已完成卡片布局开发。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L64-L318" data-highlighted="yes"><ol class="linenums"><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">MenuComp</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">card</span>: <span class="hljs-title class_">CardInfo</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">CardInfo</span>();</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">cardInfos</span>: <span class="hljs-title class_">CardInfo</span>[] = [{</li><li>    <span class="hljs-variable">cardRealName</span>: <span class="hljs-string">'PlayControlCard2x2'</span>,</li><li>    <span class="hljs-variable">cardDimension</span>: <span class="hljs-number">2</span>,</li><li>    <span class="hljs-variable">displayName</span>: <span class="hljs-string">'app.string.widget_display_name_control'</span>,</li><li>    <span class="hljs-variable">description</span>: <span class="hljs-string">'app.string.widget_desc_control'</span>,</li><li>    <span class="hljs-variable">url</span>: <span class="hljs-string">'app.media.PlayControlCard2x2'</span></li><li>  },</li><li>    <span class="hljs-comment">// ...</span></li><li>  ]</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L64-L318" target="_blank">MenuComp.ets</a></div></div></div></div> </li><li>在实现添加至桌面功能时，需要用到<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-formmenu" target="_blank">FormMenu</a>菜单组件。首先需要导入<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-formmenu#addformmenuitem" target="_blank">AddFormMenuItem</a>模块，在AddFormMenuItem里面配置好相关参数，在其中的参数options回调中，获取添加是否成功的信息，提示用户，以便用户感知。最后在应用内点击按钮后显示交互菜单。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L16-L259" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">AddFormMenuItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>;</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li>  @<span class="hljs-title function_">Builder</span></li><li>  <span class="hljs-title function_">MyMenu</span>() {</li><li>    <span class="hljs-title function_">Menu</span>() {</li><li>      <span class="hljs-title function_">AddFormMenuItem</span>(</li><li>        {</li><li>          <span class="hljs-variable">bundleName</span>: <span class="hljs-string">'com.huawei.music.card'</span>, <span class="hljs-comment">// Package Name</span></li><li>          <span class="hljs-variable">abilityName</span>: <span class="hljs-string">'PhoneFormAbility'</span>, <span class="hljs-comment">// Module Capability Name</span></li><li>          <span class="hljs-variable">parameters</span>: {</li><li>            <span class="hljs-string">'ohos.extra.param.key.form_dimension'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">card</span>.<span class="hljs-title class_">cardDimension</span>, <span class="hljs-comment">// Card size, 1 represents 1*2 card, 2 represents 2*2 card, 3 represents 2*4 card, 4 represents 4*4 card, 7 represents 6*4 card, 6 represents 1*1 card</span></li><li>            <span class="hljs-string">'ohos.extra.param.key.form_name'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">card</span>.<span class="hljs-title class_">cardRealName</span>, <span class="hljs-comment">// Card Name</span></li><li>            <span class="hljs-string">'ohos.extra.param.key.module_name'</span>: <span class="hljs-string">'entry'</span> <span class="hljs-comment">// Module name to which the card belongs</span></li><li>          },</li><li>        },</li><li>        <span class="hljs-keyword">this</span>.<span class="hljs-variable">compId</span>,</li><li>        {</li><li>          <span class="hljs-variable">formBindingData</span>: <span class="hljs-title class_">formBindingData</span>.<span class="hljs-title class_">createFormBindingData</span>({}),</li><li>          <span class="hljs-variable">callback</span>: (<span class="hljs-title class_">error</span>, <span class="hljs-title class_">formId</span>) =&gt; {</li><li>            <span class="hljs-variable">hilog</span>.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x3900</span>, <span class="hljs-variable">tag</span>, `<span class="hljs-variable">callback</span> <span class="hljs-variable">info</span>：<span class="hljs-variable">error</span> = ${<span class="hljs-variable">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable">error</span>)}, <span class="hljs-variable">formId</span> = ${<span class="hljs-variable">formId</span>}`);</li><li>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">error</span>?.<span class="hljs-variable">code</span> === <span class="hljs-number">0</span>) {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">successfully_added_to_desktop</span>'),</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>              });</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-variable">isShow</span> = <span class="hljs-keyword">false</span></li><li>            } <span class="hljs-keyword">else</span> {</li><li>              <span class="hljs-keyword">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getPromptAction</span>().<span class="hljs-title function_">showToast</span>({</li><li>                <span class="hljs-variable">message</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">string</span>.<span class="hljs-title class_">error_added_to_desktop</span>'),</li><li>                <span class="hljs-variable">duration</span>: <span class="hljs-number">1000</span></li><li>              });</li><li>            }</li><li>          },</li><li>          <span class="hljs-variable">style</span>: {}</li><li>        }</li><li>      )</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L16-L259" target="_blank">MenuComp.ets</a></div></div></div></div> </li><li>在"我的"tab 页面，右上角点击"+"号，触发下拉菜单，点击选项："添加桌面小组件"。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L287-L304" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_ invoke__">build</span>() {</li><li>  <span class="hljs-title function_ invoke__">Column</span>() {</li><li>    <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'+'</span>)</li><li>      .<span class="hljs-title function_ invoke__">height</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_ invoke__">fontSize</span>(<span class="hljs-number">30</span>)</li><li>      .<span class="hljs-title function_ invoke__">textAlign</span>(TextAlign.Center)</li><li>      .<span class="hljs-title function_ invoke__">lineHeight</span>(<span class="hljs-number">40</span>)</li><li>      .<span class="hljs-title function_ invoke__">fontWeight</span>(<span class="hljs-number">300</span>)</li><li>      .<span class="hljs-title function_ invoke__">bindSheet</span>(<span class="hljs-variable">$$this</span>.isShow, this.<span class="hljs-title function_ invoke__">SheetModal</span>(), {</li><li>        <span class="hljs-attr">detents</span>: [<span class="hljs-number">600</span>, SheetSize.MEDIUM, SheetSize.LARGE],</li><li>        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-string">'#ededeb'</span>,</li><li>        <span class="hljs-attr">dragBar</span>: <span class="hljs-literal">true</span>,</li><li>        <span class="hljs-attr">title</span>: { <span class="hljs-attr">title</span>: <span class="hljs-variable">$r</span>(<span class="hljs-string">'app.string.add_desktop_widget'</span>), subtitle: <span class="hljs-string">""</span> },</li><li>        onDisappear: () =&gt; {</li><li>          this.isShow = <span class="hljs-literal">false</span></li><li>        }</li><li>      })</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L287-L304" target="_blank">MenuComp.ets</a></div></div></div></div> </li><li>弹出模态窗。<p>在<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-sheet-transition" target="_blank">模态窗</a>组件中，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-basic-components-menu" target="_blank">Menu</a>结合<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-arkui-advanced-formmenu" target="_blank">FormMenu</a>组件生成可选的卡片类型列表。通过前置条件配置好的信息，拿到所有卡片预览图，采用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-swiper" target="_blank">轮播图</a>的方式，提供给用户选择不同的卡片预览图，给每一个预览图绑定<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-universal-attributes-menu#bindcontextmenu8" target="_blank">bindContextMenu</a>属性，预览图支持长按后，添加到桌面。</p> <p>用户通过轮播图选择需要添加的卡片之后，也可以通过模态窗下方“添加到桌面”按钮，把卡片添加到桌面。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-less" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L135-L219" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">@Builder</span></li><li><span class="hljs-built_in">SheetModal</span>() {</li><li>  <span class="hljs-selector-tag">Column</span>() {</li><li>    <span class="hljs-comment">// ...</span></li><li>
</li><li>    <span class="hljs-selector-tag">Button</span>($<span class="hljs-built_in">r</span>(<span class="hljs-string">'app.string.long_pressc_btn'</span>))</li><li>      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)</li><li>      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">328</span>)</li><li>      <span class="hljs-selector-class">.height</span>(<span class="hljs-number">40</span>)</li><li>      <span class="hljs-selector-class">.bindContextMenu</span>(this.<span class="hljs-built_in">MyMenu</span>(), ResponseType.LongPress, {</li><li>        placement: Placement.TopLeft</li><li>      })</li><li>  }</li><li>  .<span class="hljs-built_in">alignItems</span>(HorizontalAlign.Center)</li><li>  .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-built_in">height</span>(<span class="hljs-string">'100%'</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/components/MenuComp.ets#L135-L219" target="_blank">MenuComp.ets</a></div></div></div></div> <p>应用内添加到桌面效果图如下：</p> <div class="fignone"><span class="figcap"><b>图12 </b>应用内添加到桌面</span><br><span><img height="476.722141" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.32723329456280883160628697524560:50001231000000:2800:C775E56D96E03F269415017DF024580F5D2371C2508A084E582440FCB767B66D.gif" title="点击放大" width="230.4225"></span></div> </li></ol> <div class="tiledSection"><h3 id="section174601441132220">音乐播控互动卡片<i class="anchor-icon anchor-icon-link" anchorid="section174601441132220" tips="复制节点链接"></i></h3><p><span><img height="549.5161" originheight="2258" originwidth="1093" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163000.94612889845277420075451833635369:50001231000000:2800:F3D3186A8E49C0FBDBC167743F66854365E3853172F1F428E6334FA9A4072228.png" title="点击放大" width="266"></span>/</p> <p><strong>实现步骤</strong></p> <ol><li>用户点击普通卡片播放按钮，卡片会通过FormExtensionAbility的onFormEvent()方法触发溢出接口。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/entryformability/EntryFormAbility.ets#L162-L169" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">onFormEvent</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span>, message: <span class="hljs-built_in">string</span></span>) {</li><li>  <span class="hljs-comment">// Called when a specified message event defined by the form provider is triggered.</span></li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">shortMessage</span>: <span class="hljs-built_in">string</span> = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(message)[<span class="hljs-string">'message'</span>];</li><li>  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onFormEvent'</span>);</li><li>  <span class="hljs-keyword">if</span> (shortMessage === <span class="hljs-string">'requestOverFlow'</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">trigger3DLiveRequest</span>(formId);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/entryformability/EntryFormAbility.ets#L162-L169" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <div class="p">请求溢出接口如下<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-php" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/entryformability/EntryFormAbility.ets#L143-L158" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_ invoke__">trigger3DLiveRequest</span>(<span class="hljs-attr">formId</span>: <span class="hljs-keyword">string</span>) {</li><li>  formProvider.<span class="hljs-title function_ invoke__">requestOverflow</span>(formId, {</li><li>    <span class="hljs-attr">area</span>: {</li><li>      <span class="hljs-attr">left</span>: -<span class="hljs-number">37</span>,</li><li>      <span class="hljs-attr">top</span>: -<span class="hljs-number">37</span>,</li><li>      <span class="hljs-attr">width</span>: <span class="hljs-number">224</span>,</li><li>      <span class="hljs-attr">height</span>: <span class="hljs-number">224</span></li><li>    },</li><li>    <span class="hljs-attr">duration</span>: <span class="hljs-number">3500</span></li><li>  }).<span class="hljs-title function_ invoke__">then</span>(() =&gt; {</li><li>      Logger.<span class="hljs-title function_ invoke__">info</span>(TAG, <span class="hljs-string">'requestOverflow result succeed'</span>);</li><li>  }).<span class="hljs-keyword">catch</span>((error: BusinessError) =&gt; {</li><li>    Logger.<span class="hljs-title function_ invoke__">error</span>( TAG, `requestOverflow <span class="hljs-keyword">catch</span> error, <span class="hljs-attr">code</span>: ${error.code}, <span class="hljs-attr">message</span>: ${error.message}`)</li><li>  })</li><li>  <span class="hljs-keyword">return</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/entryformability/EntryFormAbility.ets#L143-L158" target="_blank">EntryFormAbility.ets</a></div></div></div></div> </div> </li><li>LiveFormExtensionAbility中配置卡片激活态ui文件，并设置背景图。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/uiextensionability/UIExtensionAbility.ets#L27-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UIExtensionAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">LiveFormExtensionAbility</span> {</li><li>  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onLiveFormCreate</span>(<span class="hljs-params">liveFormInfo: LiveFormInfo, session: UIExtensionContentSession</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onLiveFormCreate, liveformInfo: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(liveFormInfo)}</span>`</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">storage</span>: <span class="hljs-title class_">LocalStorage</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalStorage</span>();</li><li>    storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'context'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formId</span>: <span class="hljs-built_in">string</span> = liveFormInfo.<span class="hljs-property">formId</span>;</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'formId'</span>, formId);</li><li>    storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'formId'</span>, formId);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">formRect</span>: formInfo.<span class="hljs-property">Rect</span> = liveFormInfo.<span class="hljs-property">rect</span>;</li><li>    storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'formRect'</span>, formRect);</li><li>
</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">borderRadius</span>: <span class="hljs-built_in">number</span> = liveFormInfo.<span class="hljs-property">borderRadius</span>;</li><li>    storage.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'radius'</span>, borderRadius);</li><li>
</li><li>    <span class="hljs-keyword">try</span> {</li><li>      session.<span class="hljs-title function_">loadContent</span>(<span class="hljs-string">'uiextensionability/pages/Index'</span>, storage);</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      hilog.<span class="hljs-title function_">error</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`loadContent catch error, code: <span class="hljs-subst">${error.code}</span>, message: <span class="hljs-subst">${error.message}</span>`</span>)</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">let</span> songRdbHelper = <span class="hljs-title class_">SongRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">initSongs</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">SongItem</span>&gt; = <span class="hljs-keyword">await</span> songRdbHelper.<span class="hljs-title function_">queryAllSongs</span>();</li><li>    <span class="hljs-keyword">if</span> (initSongs.<span class="hljs-property">length</span> &lt;= <span class="hljs-number">0</span>) {</li><li>      initSongs = <span class="hljs-title function_">getSongListData</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      songRdbHelper.<span class="hljs-title function_">insertSongs</span>(initSongs);</li><li>    }</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'songList'</span>, initSongs);</li><li>    <span class="hljs-keyword">let</span> currentSong = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getCurrentSong</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>    <span class="hljs-keyword">if</span> (!currentSong) {</li><li>      currentSong = initSongs[<span class="hljs-number">0</span>];</li><li>      <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">putCurrentSong</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, currentSong);</li><li>    }</li><li>    <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'currentSong'</span>, currentSong);</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onLiveFormDestroy</span>(<span class="hljs-attr">liveFormInfo</span>: <span class="hljs-title class_">LiveFormInfo</span>): <span class="hljs-built_in">void</span> {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`onLiveFormDestroy, liveFormInfo: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(liveFormInfo)}</span>`</span>);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/uiextensionability/UIExtensionAbility.ets#L27-L68" target="_blank">UIExtensionAbility.ets</a></div></div></div></div> <div class="p"><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>设置背景图的目的是为了盖住普通卡片的布局，重新绘制激活态卡片。</p> </div></div></div> </div> </li><li>在激活态UI文件中绘制与普通卡片文件相同的ui布局，并描绘溢出动效。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/uiextensionability/pages/Index.ets#L87-L176" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-title function_">build</span>() {</li><li>  <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">BottomStart</span> }) {</li><li>    <span class="hljs-title function_">RelativeContainer</span>() {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .<span class="hljs-title function_">height</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">formHeight</span>)</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">formWidth</span>)</li><li>    .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">19.5</span>)</li><li>    .<span class="hljs-title function_">padding</span>(<span class="hljs-number">12</span>)</li><li>    .<span class="hljs-title function_">linearGradient</span>({</li><li>      <span class="hljs-variable">direction</span>: <span class="hljs-title class_">GradientDirection</span>.<span class="hljs-title class_">Bottom</span>,</li><li>      <span class="hljs-variable">repeating</span>: <span class="hljs-keyword">false</span>,</li><li>      <span class="hljs-variable">colors</span>: [[`#<span class="hljs-variable">ff</span>${<span class="hljs-keyword">this</span>.<span class="hljs-variable">imageColorHex</span>}`, <span class="hljs-number">0.0</span>], [`#<span class="hljs-variable">ff</span>${<span class="hljs-keyword">this</span>.<span class="hljs-variable">imageColorHex</span>}`, <span class="hljs-number">0.5</span>],</li><li>        [`#<span class="hljs-variable">ff</span>${<span class="hljs-keyword">this</span>.<span class="hljs-variable">imageColorHex</span>}`, <span class="hljs-number">1.0</span>]]</li><li>    })</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-variable">top</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">marketNameInfo</span> === <span class="hljs-string">'HUAWEI Mate 60'</span> ? <span class="hljs-number">37.5</span> : <span class="hljs-number">29</span>,</li><li>      <span class="hljs-variable">left</span>: <span class="hljs-number">37.2</span>,</li><li>      <span class="hljs-variable">right</span>: <span class="hljs-number">37.2</span>,</li><li>      <span class="hljs-variable">bottom</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">marketNameInfo</span> === <span class="hljs-string">'HUAWEI Mate 60'</span> ? <span class="hljs-number">37.5</span> : <span class="hljs-number">29</span></li><li>    })</li><li>
</li><li>    <span class="hljs-title function_">Stack</span>({ <span class="hljs-variable">alignContent</span>: <span class="hljs-title class_">Alignment</span>.<span class="hljs-title class_">Center</span> }) {</li><li>      <span class="hljs-title function_">Image</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.media.blackVinyl'</span>))</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">88</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">88</span>)</li><li>
</li><li>      <span class="hljs-title function_">Button</span>()</li><li>        .<span class="hljs-title function_">backgroundImage</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentSong</span>.<span class="hljs-variable">label</span>)</li><li>        .<span class="hljs-title function_">backgroundImageSize</span>(<span class="hljs-variable">ImageSize</span>.<span class="hljs-variable">Cover</span>)</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-number">58</span>)</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-number">58</span>)</li><li>        .<span class="hljs-title function_">backgroundColor</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'sys.color.titlebar_icon_background_color'</span>))</li><li>    }</li><li>    .<span class="hljs-title function_">alignRules</span>(<span class="hljs-variable">CoverAlignRules</span>)</li><li>    .<span class="hljs-title function_">margin</span>({</li><li>      <span class="hljs-variable">left</span>: <span class="hljs-number">51</span>,</li><li>      <span class="hljs-variable">bottom</span>: <span class="hljs-number">41</span></li><li>    })</li><li>    .<span class="hljs-title function_">scale</span>({</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">columnScale</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">columnScale</span></li><li>    })</li><li>    .<span class="hljs-title function_">translate</span>({</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">columnTranslate</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">rowTranslate</span></li><li>    })</li><li>    .<span class="hljs-title function_">rotate</span>({</li><li>      <span class="hljs-variable">x</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">y</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-variable">z</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-variable">angle</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">rotateAngle</span></li><li>    })</li><li>    .<span class="hljs-title function_">onAppear</span>(() =&gt; {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-title function_">runEnlargeAnimation</span>();</li><li>    })</li><li>  }</li><li>  .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)</li><li>  .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/c9fcac6e29657b5f24ec7193ba71e2a653741e56/entry/src/main/ets/uiextensionability/pages/Index.ets#L87-L176" target="_blank">Index.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h3 id="section98956403488">歌单推荐卡片<i class="anchor-icon anchor-icon-link" anchorid="section98956403488" tips="复制节点链接"></i></h3><p>歌单推荐有1x2和2x4两个规格的卡片，效果图如下：</p> <div class="fignone"><span class="figcap"><b>图13 </b>歌单推荐卡片效果图</span></div> <p><span><img height="184.165499" originheight="202" originwidth="686" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163001.33516335512602860453902425148343:50001231000000:2800:048BCA418FA768E4A392B8DB9E735FF0BCB47E59CB46D4DF01C0C371737D7DA9.png" title="点击放大" width="625.4325"></span></p> <p><strong>实现步骤</strong></p> <ol><li><strong>更新卡片图片</strong><p>歌单推荐封面图片加载的是网络图片，加载网络图片需要申请ohos.permission.INTERNET权限。在卡片预览的时候会下载网络图片，并更新到卡片。网络图片的下载以及如何更新到卡片，开发者可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-image-update" target="_blank">刷新本地图片和网络图片</a>。</p> <ol><li>首先在EntryFormAbility的onAddForm()方法中，调用FormUtils的updateRecommendedCard()方法更新卡片，示例代码如下。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L40-L215" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-title function_">onAddForm</span>(<span class="hljs-params">want: Want</span>) {</li><li>    hilog.<span class="hljs-title function_">info</span>(<span class="hljs-number">0x0000</span>, <span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'onAddForm'</span>);</li><li>    <span class="hljs-keyword">if</span> (want.<span class="hljs-property">parameters</span>) {</li><li>      <span class="hljs-keyword">let</span> formId = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_identity'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-keyword">let</span> formName = want.<span class="hljs-property">parameters</span>[<span class="hljs-string">'ohos.extra.param.key.form_name'</span>] <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>
</li><li>      <span class="hljs-keyword">if</span> (formName === <span class="hljs-string">'RecommendedMusic1x2'</span> || formInfo.<span class="hljs-property">formName</span> === <span class="hljs-string">'RecommendedMusic2x4'</span>) {</li><li>        <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateRecommendedCard</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, formInfo.<span class="hljs-property">formId</span>, <span class="hljs-variable constant_">IMAGE_URL1</span>);</li><li>      }</li><li>    }</li><li>    <span class="hljs-keyword">return</span> formBindingData.<span class="hljs-title function_">createFormBindingData</span>(<span class="hljs-string">''</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L40-L215" target="_blank">EntryFormAbility.ets</a></div></div></div></div> </li><li>然后通过updateRecommendedCard()方法下载网络图片，并将图片添加到缓存中，接着调用updateForm()方法更新卡片。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L50-L455" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateRecommendedCard</span>(<span class="hljs-params">context: Context, formId: <span class="hljs-built_in">string</span>, imageUrl: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">let</span> tempDir = context.<span class="hljs-title function_">getApplicationContext</span>().<span class="hljs-property">tempDir</span>;</li><li>      <span class="hljs-keyword">let</span> fileName = <span class="hljs-string">'file'</span> + <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();</li><li>      <span class="hljs-keyword">let</span> tmpFile = tempDir + <span class="hljs-string">'/'</span> + fileName + <span class="hljs-string">'.jpg'</span>;</li><li>      <span class="hljs-keyword">let</span> httpRequest = http.<span class="hljs-title function_">createHttp</span>();</li><li>      <span class="hljs-keyword">let</span> data = <span class="hljs-keyword">await</span> httpRequest.<span class="hljs-title function_">request</span>(imageUrl);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">imgMap</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = {};</li><li>
</li><li>      <span class="hljs-keyword">class</span> <span class="hljs-title class_">FormDataClass</span> {</li><li>        <span class="hljs-attr">imgBg</span>: <span class="hljs-built_in">string</span> = fileName;</li><li>        <span class="hljs-attr">formImages</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>&gt; = imgMap;</li><li>        <span class="hljs-attr">isLoaded</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>;</li><li>        <span class="hljs-attr">imageColorHex</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">''</span>;</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">if</span> (data.<span class="hljs-property">responseCode</span> === http.<span class="hljs-property">ResponseCode</span>.<span class="hljs-property">OK</span>) {</li><li>        <span class="hljs-keyword">let</span> imgFile = fileIo.<span class="hljs-title function_">openSync</span>(tmpFile, fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_WRITE</span> | fileIo.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">CREATE</span>);</li><li>        imgMap[fileName] = imgFile.<span class="hljs-property">fd</span>;</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">imageBuffer</span>: <span class="hljs-title class_">ArrayBuffer</span> = data.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>;</li><li>          <span class="hljs-keyword">let</span> <span class="hljs-attr">writeLen</span>: <span class="hljs-built_in">number</span> = fileIo.<span class="hljs-title function_">writeSync</span>(imgFile.<span class="hljs-property">fd</span>, imageBuffer);</li><li>          <span class="hljs-keyword">let</span> imageDealData = <span class="hljs-keyword">await</span> <span class="hljs-title class_">ImageUtils</span>.<span class="hljs-title function_">getImageDealDataByArr</span>(imageBuffer);</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`write data to file succeed and size is: <span class="hljs-subst">${writeLen}</span>`</span>);</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ArkTSCard download complete: <span class="hljs-subst">${tmpFile}</span>`</span>);</li><li>          <span class="hljs-keyword">let</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormDataClass</span>();</li><li>          formData.<span class="hljs-property">imageColorHex</span> = imageDealData.<span class="hljs-property">imageColorHex</span>;</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateForm</span>(formId, formData);</li><li>        } <span class="hljs-keyword">catch</span> (err) {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`write data to file failed with error: <span class="hljs-subst">${<span class="hljs-built_in">JSON</span>.stringify(err)}</span>`</span>);</li><li>        } <span class="hljs-keyword">finally</span> {</li><li>          fileIo.<span class="hljs-title function_">closeSync</span>(imgFile);</li><li>          httpRequest.<span class="hljs-title function_">destroy</span>();</li><li>        }</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ArkTSCard download task failed`</span>);</li><li>      }</li><li>    } <span class="hljs-keyword">catch</span> (err) {</li><li>      <span class="hljs-keyword">let</span> error = err <span class="hljs-keyword">as</span> <span class="hljs-title class_">BusinessError</span>;</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`updateRecommendedCard err, code: <span class="hljs-subst">${error.code}</span>, mesage: <span class="hljs-subst">${error.message}</span>`</span>);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L50-L455" target="_blank">FormUtils.ets</a></div></div></div></div> </li><li>最后Image组件通过入参(memory://fileName)的方式来进行加载缓存中的图片。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/RecommendedMusic2x4.ets#L21-L150" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/RecommendedMusic2x4.ets</span></li><li>@<span class="hljs-title function_">Entry</span>(<span class="hljs-variable">storageUpdateCall2</span>)</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RecommendedMusic2x4</span> {</li><li>  <span class="hljs-variable">readonly</span> <span class="hljs-variable">ABILITY_NAME</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>  <span class="hljs-variable">readonly</span> <span class="hljs-variable">ACTION_TYPE</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'router'</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'imgBg'</span>) <span class="hljs-variable">imgBg</span>: <span class="hljs-title class_">ResourceStr</span> = <span class="hljs-string">''</span>;</li><li>  @<span class="hljs-title function_">LocalStorageProp</span>(<span class="hljs-string">'isLoaded'</span>) <span class="hljs-variable">isLoaded</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">FormLink</span>({</li><li>      <span class="hljs-variable">action</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ACTION_TYPE</span>,</li><li>      <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ABILITY_NAME</span>,</li><li>    }) {</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Image</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isLoaded</span> ? `<span class="hljs-variable">memory</span>:<span class="hljs-comment">//${this.imgBg}` : $r('app.media.ic_avatar16'))</span></li><li>          .<span class="hljs-title function_">height</span>(<span class="hljs-string">'100%'</span>)</li><li>          .<span class="hljs-title function_">borderRadius</span>(<span class="hljs-number">10</span>)</li><li>          .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>          .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">right</span>: <span class="hljs-number">6</span> })</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/RecommendedMusic2x4.ets#L21-L150" target="_blank">RecommendedMusic2x4.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>卡片加载的图片过大可能会导致卡片白屏，建议卡片加载的图片大小不超过2M，在加载卡片图片前需要判断下图片是否过大，如果过大可以采取压缩的方案，图片压缩可以参考FAQ：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-image-16" target="_blank">如何将PixelMap压缩到指定大小以下</a>。</p> </div></div></div> </li><li><strong>卡片跳转功能实现</strong><p>下面将以2x4卡片实现为例进行介绍，歌单推荐卡片使用的是静态卡片，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-container-formlink" target="_blank">FormLink</a>组件进行跳转，有以下三种跳转场景。</p> <ul><li>点击“我的收藏”方块跳转到收藏页面。</li><li>点击“热门歌单”跳转到热门歌单页面。</li><li>点击其他区域直接拉起应用。</li></ul> <ol><li>在卡片中使用FormLink组件绑定router事件。<div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/RecommendedMusic2x4.ets#L22-L151" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/RecommendedMusic2x4.ets</span></li><li>@<span class="hljs-title function_">Entry</span>(<span class="hljs-variable">storageUpdateCall2</span>)</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">RecommendedMusic2x4</span> {</li><li>  <span class="hljs-variable">readonly</span> <span class="hljs-variable">ABILITY_NAME</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'EntryAbility'</span>;</li><li>  <span class="hljs-variable">readonly</span> <span class="hljs-variable">ACTION_TYPE</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'router'</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">FormLink</span>({</li><li>      <span class="hljs-variable">action</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ACTION_TYPE</span>,</li><li>      <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ABILITY_NAME</span>,</li><li>    }) {</li><li>      <span class="hljs-title function_">Row</span>() {</li><li>        <span class="hljs-title function_">Image</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">isLoaded</span> ? `<span class="hljs-variable">memory</span>:<span class="hljs-comment">//${this.imgBg}` : $r('app.media.ic_avatar16'))</span></li><li>          <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-title function_">Column</span>() {</li><li>          <span class="hljs-title function_">FormLink</span>({</li><li>            <span class="hljs-variable">action</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ACTION_TYPE</span>,</li><li>            <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ABILITY_NAME</span>,</li><li>            <span class="hljs-variable">params</span>: {</li><li>              <span class="hljs-keyword">type</span>: <span class="hljs-title class_">RouterType</span>.<span class="hljs-title class_">COLLECTED</span></li><li>            }</li><li>          }) {</li><li>            <span class="hljs-title function_">Column</span>() {</li><li>              <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.my_collect'</span>))</li><li>                <span class="hljs-comment">// ...</span></li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Favorite songs'</span>)</li><li>                <span class="hljs-comment">// ...</span></li><li>            }</li><li>            <span class="hljs-comment">// ...</span></li><li>          }</li><li>
</li><li>          <span class="hljs-title function_">FormLink</span>({</li><li>            <span class="hljs-variable">action</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ACTION_TYPE</span>,</li><li>            <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">ABILITY_NAME</span>,</li><li>            <span class="hljs-variable">params</span>: {</li><li>              <span class="hljs-keyword">type</span>: <span class="hljs-title class_">RouterType</span>.<span class="hljs-title class_">PLAYLISTS</span></li><li>            }</li><li>          }) {</li><li>            <span class="hljs-title function_">Column</span>() {</li><li>              <span class="hljs-title function_">Text</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.string.hot_playlists'</span>))</li><li>                <span class="hljs-comment">// ...</span></li><li>              <span class="hljs-title function_">Text</span>(<span class="hljs-string">'Hot playlists'</span>)</li><li>                <span class="hljs-comment">// ...</span></li><li>            }</li><li>            <span class="hljs-comment">// ...</span></li><li>          }</li><li>        }</li><li>        .<span class="hljs-title function_">layoutWeight</span>(<span class="hljs-number">1</span>)</li><li>        .<span class="hljs-title function_">margin</span>({ <span class="hljs-variable">left</span>: <span class="hljs-number">6</span> })</li><li>      }</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/RecommendedMusic2x4.ets#L22-L151" target="_blank">RecommendedMusic2x4.ets</a></div></div></div></div> </li><li>在EntryAbility的生命周期中处理跳转事件。<p>通过router事件拉起应用后，在应用侧EntryAbility的onCreate和onNewWant中接收到这三个事件以及事件携带的参数，为了区分，此处新增一个参数type，根据type，应用侧收到事件后可以做相应的业务处理。此处最外层的FormLink仅仅是拉起应用，不需要处理。后续处理“跳转收藏页面”和“跳转热门歌单”两个事件，示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L485" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/entryability/EntryAbility.ets</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onCreate</span>(<span class="hljs-params">want: Want, launchParam: AbilityConstant.LaunchParam</span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleParams</span>(want);</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleParams</span>(want);</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-title function_">handleParams</span>(<span class="hljs-params">want: Want</span>) {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'handleParams'</span>);</li><li>    <span class="hljs-keyword">if</span> (want?.<span class="hljs-property">parameters</span>?.<span class="hljs-property">params</span>) {</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-attr">params</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-title class_">Object</span>&gt; = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(want.<span class="hljs-property">parameters</span>.<span class="hljs-property">params</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>);</li><li>      <span class="hljs-keyword">let</span> <span class="hljs-keyword">type</span> = params.<span class="hljs-property">type</span> <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">RouterType</span>.<span class="hljs-property">PLAYLISTS</span>) {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isToHotPlaylist'</span>, <span class="hljs-literal">true</span>);</li><li>      }</li><li>
</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">type</span> === <span class="hljs-title class_">RouterType</span>.<span class="hljs-property">COLLECTED</span>) {</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'mainTabIndex'</span>, <span class="hljs-number">1</span>);</li><li>        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isShowPlay'</span>, <span class="hljs-literal">false</span>);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryability/EntryAbility.ets#L48-L485" target="_blank">EntryAbility.ets</a></div></div></div></div> </li><li>在MainPage中根据参数跳转收藏页和热门歌单页面。<p>在音乐应用中，“我的收藏”页面是首页Tabs的一个页签。通过更新AppStorage中的mainTabIndex值来切换页面，其中1表示“我的收藏”标签页。首页通过@StorageLink监听mainTabIndex的变化以实现页面切换。</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L26-L107" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/MainPage.ets</span></li><li>@<span class="hljs-title function_">Entry</span></li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainPage</span> {</li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'mainTabIndex'</span>) <span class="hljs-variable">currentIndex</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">Provide</span>(<span class="hljs-string">'pageStack'</span>) <span class="hljs-variable">pageStack</span>: <span class="hljs-title class_">NavPathStack</span> = <span class="hljs-variable">new</span> <span class="hljs-title function_">NavPathStack</span>();</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Navigation</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">pageStack</span>) {</li><li>      <span class="hljs-title function_">Column</span>() {</li><li>        <span class="hljs-title function_">Tabs</span>({ <span class="hljs-variable">index</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">currentIndex</span>, <span class="hljs-variable">barPosition</span>: <span class="hljs-title class_">BarPosition</span>.<span class="hljs-title class_">End</span> }) {</li><li>          <span class="hljs-title function_">TabContent</span>() {</li><li>            <span class="hljs-title function_">RecommendedMusic</span>()</li><li>          }</li><li>
</li><li>          <span class="hljs-title function_">TabContent</span>() {</li><li>            <span class="hljs-title function_">CollectedMusic</span>()</li><li>          }</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>        .<span class="hljs-title function_">onChange</span>((<span class="hljs-variable">index</span>) =&gt; {</li><li>          <span class="hljs-keyword">this</span>.<span class="hljs-variable">currentIndex</span> = <span class="hljs-variable">index</span>;</li><li>        })</li><li>
</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      .<span class="hljs-title function_">padding</span>({</li><li>        <span class="hljs-variable">top</span>: <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title class_">get</span>&lt;<span class="hljs-title class_">number</span>&gt;('<span class="hljs-title class_">statusBarHeight</span>') ?? <span class="hljs-number">0</span>,</li><li>        <span class="hljs-variable">bottom</span>: <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title class_">get</span>&lt;<span class="hljs-title class_">number</span>&gt;('<span class="hljs-title class_">naviIndicatorHeight</span>') ?? <span class="hljs-number">0</span></li><li>      })</li><li>      .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#F1F3F5'</span>)</li><li>
</li><li>    }</li><li>    .<span class="hljs-title function_">hideTitleBar</span>(<span class="hljs-keyword">true</span>)</li><li>    .<span class="hljs-title function_">navDestination</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">PageMap</span>)</li><li>    .<span class="hljs-title function_">mode</span>(<span class="hljs-variable">NavigationMode</span>.<span class="hljs-variable">Stack</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L26-L107" target="_blank">MainPage.ets</a></div></div></div></div> <p>跳转热门歌单，是当用户点击卡片上的“热门歌单”拉起应用后，音乐应用会从首页自动跳转到热门歌单列表页面。这一过程通过在MainPage的onPageShow回调函数中判断isToPlaylists参数来实现，如果该参数为true，则使用pageStack.pushPathByName()方法跳转到热门歌单页面。示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L27-L108" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/pages/MainPage.ets</span></li><li><span class="hljs-meta">@Entry</span></li><li><span class="hljs-meta">@Component</span></li><li>struct MainPage {</li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'mainTabIndex'</span>)</span> currentIndex: number = <span class="hljs-number">0</span>;</li><li>  <span class="hljs-meta">@Provide(<span class="hljs-string">'pageStack'</span>)</span> pageStack: NavPathStack = new NavPathStack();</li><li>  <span class="hljs-meta">@StorageLink(<span class="hljs-string">'isToHotPlaylist'</span>)</span> isToHotPlaylist: boolean = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-meta">@Builder</span></li><li>  PageMap(name: string) {</li><li>    <span class="hljs-keyword">if</span> (name === <span class="hljs-string">'Playlists'</span>) {</li><li>      HotPlaylist()</li><li>    }</li><li>  }</li><li>
</li><li>  onPageShow(): void {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isToHotPlaylist) {</li><li>      <span class="hljs-keyword">this</span>.isToHotPlaylist = <span class="hljs-literal">false</span>;</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-keyword">if</span> (stackIndexArray.length &gt; <span class="hljs-number">0</span> &amp;&amp; stackIndexArray[stackIndexArray.length-<span class="hljs-number">1</span>] === <span class="hljs-string">'Playlists'</span>) {</li><li>        <span class="hljs-keyword">this</span>.pageStack.replacePathByName(<span class="hljs-string">'Playlists'</span>, <span class="hljs-keyword">this</span>.playlistsTitle);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.pageStack.pushPathByName(<span class="hljs-string">'Playlists'</span>, <span class="hljs-keyword">this</span>.playlistsTitle);</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li>  build() {</li><li>    Navigation(<span class="hljs-keyword">this</span>.pageStack) {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>    .hideTitleBar(<span class="hljs-literal">true</span>)</li><li>    .navDestination(<span class="hljs-keyword">this</span>.PageMap)</li><li>    .mode(NavigationMode.Stack)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L27-L108" target="_blank">MainPage.ets</a></div></div></div></div> </li></ol> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>在通过卡片多次拉起应用进行页面路由时，可能会导致页面栈中同一页面出现多次，从而使得返回操作需要执行多次。为了避免这种情况，应对页面跳转逻辑进行优化，具体处理方法可以参考：<a href="/consumer/cn/doc/best-practices/bpta-music-card#section11706154125217">多次点击服务卡片拉起应用指定页面后，该页面在路由栈内存在多个，导致返回上一面需要多次返回操作</a>。</p> </div></div></div> <p></p> <p>跳转效果如下图所示：</p> <div class="fignone"><span class="figcap"><b>图14 </b>点击卡片跳转效果图</span><br><span><img height="495.30569900000006" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163001.54761881723696981087145468922127:50001231000000:2800:1859733B5DF7092F32FF235A3B753212DC3F32E414BEF80474B75AD4CF0374C6.gif" title="点击放大" width="239.4"></span></div> </li></ol> </div> <div class="tiledSection"><h3 id="section1889524013481">心动歌词卡片<i class="anchor-icon anchor-icon-link" anchorid="section1889524013481" tips="复制节点链接"></i></h3><p>本章将介绍心动歌词卡片的两大核心功能：歌词卡片数据更新和沉浸式卡片设计。歌词卡片数据通过定时刷新来更新卡片数据，而沉浸式卡片则通过设置背景色和背景图片来增强视觉体验。</p> <p><strong>实现步骤</strong></p> <ol><li>歌词卡片数据更新实现。<p>本示例中歌词卡片是通过定时刷新的方式进行刷新，首先需要在卡片配置文件form_config中进行配置，设置updateEnabled参数的值为true，表示卡片支持周期性刷新（包含定时刷新和定点刷新），设置updateDuration参数的值为1，表示每隔30分钟会进行刷新卡片，参数配置如下：</p> <div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/resources/base/profile/form_config.json</span></li><li>{</li><li>  <span class="hljs-string">"forms"</span>: [</li><li>    <span class="hljs-comment">// ...</span></li><li>    {</li><li>      <span class="hljs-string">"name"</span>: <span class="hljs-string">"LyricsCard"</span>,</li><li>      <span class="hljs-comment">// ...</span></li><li>      <span class="hljs-string">"updateDuration"</span>: <span class="hljs-number">1</span>,</li><li>      <span class="hljs-string">"defaultDimension"</span>: <span class="hljs-string">"2*4"</span>,</li><li>      <span class="hljs-string">"supportDimensions"</span>: [</li><li>        <span class="hljs-string">"2*4"</span>,</li><li>        <span class="hljs-string">"4*4"</span></li><li>      ]</li><li>    }</li><li>  ]</li><li>}</li></ol></pre></div></div> <p>接着在EntryFormAbility的onUpdateForm()回调方法中，对卡片数据进行刷新。由于onUpdateForm()方法中的参数只有formId，而本示例涉及三种类型的卡片（音乐播控、歌单推荐和心动歌词），因此需要依据formId查询数据库以获取卡片的具体信息。若查询到卡片的formName为"LyricsCard"，则执行相应的数据更新操作。示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L41-L216" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryFormAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">FormExtensionAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onUpdateForm</span>(<span class="hljs-params">formId: <span class="hljs-built_in">string</span></span>) {</li><li>    <span class="hljs-comment">// ...</span></li><li>    <span class="hljs-title class_">FormRdbHelper</span>.<span class="hljs-title function_">getInstance</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>)</li><li>      .<span class="hljs-title function_">queryFormById</span>(formId)</li><li>      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">formInfo</span>) =&gt;</span> {</li><li>        <span class="hljs-comment">// ...</span></li><li>        <span class="hljs-keyword">if</span> (formInfo.<span class="hljs-property">formName</span> === <span class="hljs-string">'LyricsCard'</span>) {</li><li>          <span class="hljs-title class_">FormUtils</span>.<span class="hljs-title function_">updateLyricsCard</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, formInfo.<span class="hljs-property">formId</span>);</li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      });</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/entryformability/EntryFormAbility.ets#L41-L216" target="_blank">EntryFormAbility.ets</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L51-L456" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/utils/FormUtils.ets</span></li><li><span class="hljs-keyword">class</span> <span class="hljs-title class_">FormUtils</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-variable">async</span> <span class="hljs-title function_">updateLyricsCard</span>(<span class="hljs-variable">context</span>: <span class="hljs-title class_">Context</span>, <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span>) {</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">songData</span> = <span class="hljs-title function_">getRandomLyrics</span>(<span class="hljs-variable">context</span>);</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">songItem</span>: <span class="hljs-title class_">SongItem</span> = <span class="hljs-variable">songData</span>.<span class="hljs-variable">songItem</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">SongItem</span>;</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-variable">imageDealData</span> = <span class="hljs-variable">await</span> <span class="hljs-variable">ImageUtils</span>.<span class="hljs-title function_">getImageDealData</span>(<span class="hljs-variable">context</span>, <span class="hljs-variable">songItem</span>.<span class="hljs-variable">label</span>);</li><li>
</li><li>    <span class="hljs-keyword">class</span> <span class="hljs-title class_">CardUpdateData</span> {</li><li>      <span class="hljs-variable">lrcArray</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt; = <span class="hljs-variable">songData</span>.<span class="hljs-variable">randomLrcStr</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Array</span>&lt;<span class="hljs-title class_">string</span>&gt;;</li><li>      <span class="hljs-variable">formId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">formId</span>;</li><li>      <span class="hljs-variable">singer</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">songItem</span>.<span class="hljs-variable">singer</span>;</li><li>      <span class="hljs-variable">title</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">songItem</span>.<span class="hljs-variable">title</span>;</li><li>      <span class="hljs-variable">songId</span>: <span class="hljs-title class_">string</span> = <span class="hljs-variable">songItem</span>.<span class="hljs-variable">id</span>;</li><li>      <span class="hljs-variable">musicCover</span>: <span class="hljs-title class_">Resource</span> = <span class="hljs-variable">songItem</span>.<span class="hljs-variable">label</span>;</li><li>      <span class="hljs-variable">imageColor</span> = <span class="hljs-variable">imageDealData</span>.<span class="hljs-variable">imageColor</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-title function_">updateForm</span>(<span class="hljs-variable">formId</span>, <span class="hljs-variable">new</span> <span class="hljs-title function_">CardUpdateData</span>());</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/utils/FormUtils.ets#L51-L456" target="_blank">FormUtils.ets</a></div></div></div></div> </li><li>卡片沉浸式方案实现。<p>使用Stack堆叠布局，将歌曲封面作为底部背景图，设置图片大小'200%'、透明度0.5、以及模糊度100，开发者可以根据设计自行调节。使用歌曲封面图片的颜色imageColor作为卡片背景色，imageColor的获取可参考<a href="/consumer/cn/doc/best-practices/bpta-music-card#section29858211157">音乐播控</a>卡片章节。示例代码如下：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-scss" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/LyricsCard.ets#L21-L126" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// src/main/ets/widget/pages/LyricsCard.ets</span></li><li><span class="hljs-keyword">@Entry</span>(storageUpdateCall1)</li><li><span class="hljs-keyword">@Component</span></li><li>struct LyricsCard {</li><li>  <span class="hljs-keyword">@LocalStorageProp</span>(<span class="hljs-string">'musicCover'</span>) <span class="hljs-attribute">musicCover</span>: Resource = <span class="hljs-variable">$r</span>(<span class="hljs-string">'app.media.ic_dream'</span>);</li><li>  <span class="hljs-keyword">@LocalStorageProp</span>(<span class="hljs-string">'imageColor'</span>) <span class="hljs-attribute">imageColor</span>: string = <span class="hljs-string">'rgba(76, 72, 68, 1)'</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-built_in">build</span>() {</li><li>    <span class="hljs-built_in">FormLink</span>({</li><li>      action: FormCarAction.ROUTER,</li><li>      abilityName: ENTRY_ABILITY,</li><li>      params: {</li><li>        songId: this.songId,</li><li>        type: RouterType.LYRICS</li><li>      }</li><li>    }) {</li><li>      <span class="hljs-built_in">Stack</span>() {</li><li>        <span class="hljs-built_in">Image</span>(this.musicCover)</li><li>          <span class="hljs-selector-class">.height</span>('<span class="hljs-number">200%</span>')</li><li>          <span class="hljs-selector-class">.width</span>('<span class="hljs-number">200%</span>')</li><li>          <span class="hljs-selector-class">.objectFit</span>(ImageFit.Cover)</li><li>          <span class="hljs-selector-class">.opacity</span>(<span class="hljs-number">0.5</span>)</li><li>          <span class="hljs-selector-class">.blur</span>(<span class="hljs-number">100</span>)</li><li>
</li><li>        <span class="hljs-built_in">Column</span>() {</li><li>          <span class="hljs-comment">// ...</span></li><li>        }</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-selector-class">.backgroundColor</span>(this.imageColor)</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/widget/pages/LyricsCard.ets#L21-L126" target="_blank">LyricsCard.ets</a></div></div></div></div> <p>效果图如下：</p> <div class="fignone"><span class="figcap"><b>图15 </b>心动歌词卡片效果图</span><p><span><img height="241.856909" originheight="396" originwidth="926" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163001.40483417597399505635489424997773:50001231000000:2800:06550140823CDF825B7C12606C1530C1B4FBFF8091A4603311BB5A8302C9EA9F.png" title="点击放大" width="565.5825"></span></p> </div> </li></ol> </div> <div class="tiledSection"><h2 id="section20968184219325">常见问题<i class="anchor-icon anchor-icon-link" anchorid="section20968184219325" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section11706154125217" class="firsth2">多次点击服务卡片拉起应用指定页面后，该页面在路由栈内存在多个，导致返回上一面需要多次返回操作。<i class="anchor-icon anchor-icon-link" anchorid="section11706154125217" tips="复制节点链接"></i></h3><p>应用在接收到对应的router跳转事件后，处理跳转的时候需要判断跳转的页面是否已经在路由栈的栈顶，如果在的话需要替换当前的页面，如果不在的话，重新push这个页面到栈。下面以Navigation跳转路由页面为例：</p> <div class="screenLinkPre"><div _ngcontent-efi-c106="" class="highlight-div"><div _ngcontent-efi-c106="" class="highlight-div-header"><div _ngcontent-efi-c106="" class="highlight-div-header-left"><div _ngcontent-efi-c106="" class="handle-button expand-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-efi-c106="" class="highlight-div-header-right"><div _ngcontent-efi-c106="" class="handle-button ai-button"></div><div _ngcontent-efi-c106="" class="handle-button line-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-efi-c106="" class="handle-button theme-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-efi-c106="" class="handle-button copy-button"><div _ngcontent-efi-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-efi-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L52-L59" data-highlighted="yes"><ol class="linenums"><li>let stackIndexArray = <span class="hljs-keyword">this</span>.pageStack.getAllPathName();</li><li><span class="hljs-keyword">if</span> (stackIndexArray.length &gt; <span class="hljs-number">0</span> &amp;&amp; stackIndexArray[stackIndexArray.length-<span class="hljs-number">1</span>] === <span class="hljs-string">'Playlists'</span>) {</li><li>  <span class="hljs-keyword">this</span>.pageStack.replacePathByName(<span class="hljs-string">'Playlists'</span>, <span class="hljs-keyword">this</span>.playlistsTitle);</li><li>} <span class="hljs-keyword">else</span> {</li><li>  <span class="hljs-keyword">this</span>.pageStack.pushPathByName(<span class="hljs-string">'Playlists'</span>, <span class="hljs-keyword">this</span>.playlistsTitle);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/MusicCard/blob/master/entry/src/main/ets/pages/MainPage.ets#L52-L59" target="_blank">MainPage.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section1023610106530">手机重启/解锁后卡片内图片消失，出现白屏<i class="anchor-icon anchor-icon-link" anchorid="section1023610106530" tips="复制节点链接"></i></h3><p>该问题可能是卡片加载的图片过大导致的，在加载卡片图片前需要判断图片是否过大，如果过大可以采取压缩的方案，图片压缩可以参考FAQ：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-faqs/faqs-image-16" target="_blank">如何将PixelMap压缩到指定大小以下</a>。关于卡片图片加载规格限制说明可以参考：<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-image-update" target="_blank">刷新本地图片和网络图片</a>。</p> </div> <div class="tiledSection"><h3 id="section11148144315538">手机重启后卡片数据变回兜底内容<i class="anchor-icon anchor-icon-link" anchorid="section11148144315538" tips="复制节点链接"></i></h3><p>卡片框架在重启时是使用onAddForm()回调方法的返回值，若应用重启前调用updateForm()更新的数据和onAddForm()方法返回的数据不一致，可能导致设备重启前后卡片数据不一致，因此需要对数据做持久化处理。例如使用关系型数据库存储卡片最新数据，在FormExtensionAbility的onAddForm()生命周期回调中，获取数据库中的最新数据后，使用updateForm()方法更新卡片。</p> </div> <div class="tiledSection"><h3 id="section15723885417">在卡片生命周期和应用UIAbility生命周期获取的temp目录不同，需要分别获取，不能一次存储两端使用。<i class="anchor-icon anchor-icon-link" anchorid="section15723885417" tips="复制节点链接"></i></h3><p>卡片更新时图片存储在从UIAbility的context获取的temp路径下，与创建时拉起的FormExtensionAbility的temp路径不同。若直接用数据库取出的数据进行卡片更新，会导致图片不能加载。因此，如果在FormExtensionAbility中，从数据库中取到卡片最新数据后，需要再次获取FormExtensionAbility下的temp路径打开本地/网络图片，获取到对应的fd之后再进行数据绑定刷新。</p> </div> <div class="tiledSection"><h3 id="section173874612549">如何进行卡片渲染问题定位？<i class="anchor-icon anchor-icon-link" anchorid="section173874612549" tips="复制节点链接"></i></h3><p>可以在DevEco Studio中查看日志，选择“com.ohos.formrenderservice”卡片渲染服务，通过error日志查看具体卡片渲染报错原因。</p> </div> <div class="tiledSection"><h2 id="section1566681910427">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section1566681910427" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/MusicCard" target="_blank">音乐服务卡片</a></li></ul> </div> </div> <div></div></div>