<h1 _ngcontent-iiq-c119="" class="doc-title ng-star-inserted" title="音画同步"> 音画同步 </h1>

<div _ngcontent-iiq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section104mcpsimp">概述<i class="anchor-icon anchor-icon-link" anchorid="section104mcpsimp" tips="复制节点链接"></i></h2><p>精确的音视频同步是媒体播放的关键体验之一。通常来说，在录制音频和视频时需要做到同步，并且录制后的视频在播放设备（例如手机、电视、媒体播放器）上播放时也需要做到同步。目前，视频在播放时可能会出现音视频不同步现象，严重影响用户体验。</p> <p>根据当前HarmonyOS APP开发过程中遇到的音画同步业务场景，总结出如下三种典型场景：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section340411415017">本地视频的音画同步</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section18863195213010">网络视频的音画同步</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section125452116310">录制视频的音画同步</a></li></ul> <p>从上述三种典型场景出发，本文旨在指导第三方视频播放应用正确获取并使用音频和视频相关信息来保证播放时的音视频同步。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>如果开发者使用自研播放器引擎而非AVPlayer，也可以参考该解决方案思路实现优化。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section41961218113419">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section41961218113419" tips="复制节点链接"></i></h2><p>音视频数据的最小处理单元称为帧。音频流和视频流都被分割成帧，所有帧都被标记为需要按特定的时间戳显示。音频和视频可以独立下载和解码，具有匹配时间戳的音频和视频帧应同时呈现，以达到音视频（A/V）同步的效果。</p> </div> <div class="tiledSection"><h3 id="section0486552347" class="firsth2">音画同步标准<i class="anchor-icon anchor-icon-link" anchorid="section0486552347" tips="复制节点链接"></i></h3></div> <ul><li>PTS（送显时间戳）指音视频数据在播放时应该显示给用户的时间戳。它表示解码后的音视频数据在播放时应该出现在屏幕上或传递给音视频输出设备的时间点。PTS用于控制音视频的播放顺序和时序，以确保音视频在正确的时间点进行显示或播放。</li><li>DTS（解码时间戳）指音视频数据在解码器中开始解码的时间戳。它表示解码器应该从输入数据流中读取和解码的特定时间点。DTS用于控制解码器的解码顺序，确保音视频数据按照正确的顺序解码。</li></ul>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.1.3.1.1" valign="top" width="12.3%"><p>帧</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.1.3.1.2" valign="top" width="87.7%"><p>解释</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="12.3%"><p>I帧(I-frame)</p> </td> <td class="cellrowborder" valign="top" width="87.7%"><p>内部画面（intra picture）或关键帧（key frame）。I帧是一个全帧压缩的编码帧，包含了一幅完整的图像数据。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.3%"><p>P帧(P-frame)</p> </td> <td class="cellrowborder" valign="top" width="87.7%"><p>前向预测编码帧（predictive-frame）。P帧不是完整的数据帧，而是只包含与前面I帧或P帧的差异数据。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="12.3%"><p>B帧(B-frame)</p> </td> <td class="cellrowborder" valign="top" width="87.7%"><p>双向预测内插编码帧（bi-directional interpolated prediction frame）。B帧也是一个压缩帧，它同时参考前面的I帧或P帧和后面的P帧来进行编码。</p> </td> </tr>  </tbody></table></div> </div> <ol><li>为了衡量音画同步的性能，用对应音频和视频帧实际播放时间的差值作为数值指标，数值大于0ms表示声音提前画面，小于0ms表示声音落后画面。</li><li>最大卡顿时长，单帧图像停滞时间超过100ms的，定义为卡顿一次，连续测试5分钟。</li><li>平均播放帧率，平均每秒播放帧数，不反映每帧显示时长。</li></ol>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.7.1.3.1.1" valign="top" width="50%"><p>时间差范围</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.7.1.3.1.2" valign="top" width="50%"><p>主观体验</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>[-80ms, 25ms]</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>无法察觉</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>[-125ms, 45ms]</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>能够察觉</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>[-185ms, 90ms]</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>无法接受</p> </td> </tr>  </tbody></table></div> </div> <div class="tiledSection"><h3 id="section18302114711394">音画同步方案思路<i class="anchor-icon anchor-icon-link" anchorid="section18302114711394" tips="复制节点链接"></i></h3></div> <p>理论上，因为音频通路存在时延，要保证播放时的音视频同步，有三种解决方案可用：</p> <ul><li>连续播放音频帧：使用音频播放位置作为主时间参考，并将视频播放位置与其匹配。</li><li>使用系统时间作为参考：将音频和视频播放与系统时间匹配。</li><li>使用视频播放作为参考：让音频匹配视频。已统一在区间后面加上空格。</li></ul> <p>三种方案的优缺点对比如下：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.1.4.1.1" valign="top" width="33.33333333333333%"><p>方案名称</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.1.4.1.2" valign="top" width="33.33333333333333%"><p>优点</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.1.4.1.3" valign="top" width="33.33333333333333%"><p>缺点</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>连续播放音频帧</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><ol><li>用户肉眼的敏感度较弱，不易察觉视频微小的调整。</li><li>视频刷新时间的调整相对便捷。</li></ol> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>如果视频帧率不稳定或渲染延迟大，可能导致视频卡顿或跳帧。</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>使用系统时间作为参考</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>可以最大限度的保证音频和视频都不发生跳帧行为。</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><ol><li>需要额外依赖系统时钟，增加了系统复杂性和维护成本。</li><li>系统时钟的准确性对同步效果影响较大，如果系统时钟不准确，可能导致同步效果大打折扣。</li></ol> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>使用视频播放作为参考</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>音频可根据视频帧进行调整，减少音频跳帧的情况。</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><ol><li>音频播放可能会出现等待或加速的情况，相较于视频会对用户的影响更为严重和明显。</li><li>如果视频帧率不稳定，可能导致音频同步困难。</li></ol> </td> </tr>  </tbody></table></div> </div> <p>第一个方案是具有连续音频数据流的选项，其没有对音频帧的显示时间、播放速度或持续时间进行任何调整。这些参数的任何调整都很容易被人耳注意到，并导致音频干扰故障。处理这些故障需要对音频重新采样，然而重新采样会导致音调的改变。</p> <p>因此，一般的多媒体应用多使用音频播放位置作为主时间参考。以下章节主要以此解决方案进行说明（其他两个选项不在本文档的范围内）。</p> <div class="tiledSection"><h3 id="section3976172773620">连续播放音频帧方案<i class="anchor-icon anchor-icon-link" anchorid="section3976172773620" tips="复制节点链接"></i></h3></div> <p>该方案使用音频播放位置作为主时间参考，并将视频播放位置与其匹配，使音画同步指标达到用户无法察觉的[-80ms, 25ms]范围。</p> <p>解决方案使用：</p> <ul><li>视频同步到音频（主流方案）。</li><li>获取音频渲染进度，动态调整视频渲染进度。</li></ul> <p>最终实现音画同步[-80ms, 25ms]的效果。</p> <p><strong>连续播放音帧方案示意图</strong></p> <p><span><img height="481.22038701382195" originheight="793" originwidth="1516" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163040.23642004415661874728605052795172:50001231000000:2800:1DD51BE46237F3F6C9D9883128E9C1BF81655BB6CED1EE3E20DA83B6D54ABB09.png" title="点击放大" width="920"></span></p> <p>音频和视频的管道必须同时以相同的时间戳呈现每帧数据。将音频播放位置用作主时间参考，而视频管道只输出与最新渲染音频帧匹配的视频帧。对于所有可能的实现，精确计算最后一次呈现的音频时间戳是至关重要的。<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a> 接口用以查询音频管道各个阶段的音频时间戳和延迟信息，此信息可用于控制视频管道，使视频帧与音频帧匹配。</p> <p>基于以上示意图，具体来说，在监听到视频帧的时候，首先去获取当前音频渲染位置，在获取成功的情况下计算该视频帧PTS与当前音频渲染位置的延迟时间，对延迟时间进行如下判断确定送显策略。</p> <ul><li><strong>视频帧相较于音频渲染位置过早时，视频帧则等待一段时间再送显</strong>。</li><li><strong>延迟时间在可接受的延迟范围内该视频帧立即送显</strong>。</li><li><strong>当视频帧相较于音频渲染位置过晚时则丢弃该视频帧</strong>。</li></ul> <div class="tiledSection"><h2 id="section340411415017">本地视频的音画同步<i class="anchor-icon anchor-icon-link" anchorid="section340411415017" tips="复制节点链接"></i></h2><p>从本地媒体库中选择视频资源进行播放是三方视频类应用常见的场景。</p> </div> <div class="tiledSection"><h3 id="section691575913343" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section691575913343" tips="复制节点链接"></i></h3><p>系统中提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoviewpicker" target="_blank">PhotoViewPicker()</a>接口用于获取本地视频资源。三方视频播放应用可以使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithfd" target="_blank">OH_AVSource_CreateWithFD()</a>接口对本地视频资源进行解封装，获取和使用对应的音频和视频信息后，使用连续播放音频帧方案进行音频和视频的播放同步。具体开发步骤如下所示。</p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoviewpicker" target="_blank">PhotoViewPicker()</a>获取本地视频资源。</li><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithfd" target="_blank">OH_AVSource_CreateWithFD()</a>对本地视频资源进行解封装处理，获取音频和视频信息。</li><li>使用<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section3976172773620">连续播放音频帧方案</a>进行音画同步播放。</li></ol> </div> <div class="tiledSection"><h3 id="section640118113514">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section640118113514" tips="复制节点链接"></i></h3><ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-photoaccesshelper-photoviewpicker" target="_blank">PhotoViewPicker()</a>获取本地视频资源。</li></ol> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/ets/common/utils/FileUtil.ets#L39-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">selectFileFromLocal</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">let</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">FileUtil</span>.<span class="hljs-title function_">getPhotoViewPicker</span>().<span class="hljs-title function_">select</span>({</li><li>      <span class="hljs-title class_">MIMEType</span>: photoAccessHelper.<span class="hljs-property">PhotoViewMIMETypes</span>.<span class="hljs-property">VIDEO_TYPE</span>,</li><li>      <span class="hljs-attr">maxSelectNumber</span>: <span class="hljs-number">1</span></li><li>    })</li><li>    <span class="hljs-keyword">let</span> selectFilePath = result.<span class="hljs-property">photoUris</span>[<span class="hljs-number">0</span>];</li><li>    <span class="hljs-keyword">if</span> (!selectFilePath) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span></li><li>    }</li><li>    <span class="hljs-keyword">return</span> selectFilePath;</li><li>  } <span class="hljs-keyword">catch</span> (e) {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/ets/common/utils/FileUtil.ets#L39-L53" target="_blank">FileUtil.ets</a></div></div></div></div> <p>2. 使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithfd" target="_blank">OH_AVSource_CreateWithFD()</a>对本地视频资源进行解封装处理，获取音频帧和视频帧信息。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Demuxer.cpp#L25-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Demuxer::Create</span><span class="hljs-params">(SampleInfo &amp;info)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (info.isLocal) {</li><li>        <span class="hljs-comment">// From the local video scenario</span></li><li>        source = <span class="hljs-built_in">OH_AVSource_CreateWithFD</span>(info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// From the local video scenario</span></li><li>        source = <span class="hljs-built_in">OH_AVSource_CreateWithURI</span>(info.networkUri);</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(source != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR,</li><li>                             <span class="hljs-string">"Create demuxer source failed, fd: %{public}d, offset: %{public}"</span> PRId64</li><li>                             <span class="hljs-string">", file size: %{public}"</span> PRId64,</li><li>                             info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>    demuxer = <span class="hljs-built_in">OH_AVDemuxer_CreateWithSource</span>(source);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Demuxer.cpp#L25-L50" target="_blank">Demuxer.cpp</a></div></div></div></div> <p>3. 收到视频帧的时候，通过调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>接口获取音频渲染位置等信息。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L295-L300" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// get audio render position</span></li><li><span class="hljs-type">int64_t</span> framePosition = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int64_t</span> timeStamp = <span class="hljs-number">0</span>;</li><li><span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AudioRenderer_GetTimestamp</span>(audioRenderer, CLOCK_MONOTONIC, &amp;framePosition, &amp;timeStamp);</li><li>
</li><li>audioTimeStamp = timeStamp;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L295-L300" target="_blank">Player.cpp</a></div></div></div></div> <p>4. 音频启动前暂不做音画同步，视频帧直接送显。</p> <p>音频启动前，timestamp和framePosition返回结果为0。为避免出现卡顿等问题，暂不同步，视频帧直接送显。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L303-L310" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// audio render getTimeStamp error, render it</span></li><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">ret</span> != <span class="hljs-variable">AUDIOSTREAM_SUCCESS</span> || (<span class="hljs-variable">timeStamp</span> == <span class="hljs-number">0</span>) || (<span class="hljs-variable">framePosition</span> == <span class="hljs-number">0</span>)) {</li><li>    <span class="hljs-comment">// first frame, render without wait</span></li><li>    <span class="hljs-variable">videoDecoder</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>, <span class="hljs-keyword">true</span>);</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_until</span>(<span class="hljs-variable">lastPushTime</span> <span class="hljs-variable">+ std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">microseconds</span>(<span class="hljs-title class_">sampleInfo</span>.<span class="hljs-title class_">frameInterval</span>));</li><li>    <span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li>    <span class="hljs-keyword">continue</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L303-L310" target="_blank">Player.cpp</a></div></div></div></div> <div class="p">5. 根据视频帧PTS和音频渲染位置计算延迟。<ul><li>audioPlayedTime: 音频帧期望渲染时间。</li><li>videoPlayedTime: 视频帧期望送显时间。</li><li>waitTimeUs : 视频帧相对于音频帧延迟时间。</li></ul> </div> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L313-L326" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// after seek, audio render flush, framePosition = 0, then writtenSampleCnt = 0</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">latency</span> =</li><li>    (<span class="hljs-variable">audioDecContext</span>-&gt;<span class="hljs-title class_">frameWrittenForSpeed</span> - <span class="hljs-title class_">framePosition</span>) * <span class="hljs-number">1000</span> * <span class="hljs-number">1000</span> / <span class="hljs-variable">sampleInfo</span>.<span class="hljs-variable">audioSampleRate</span> / <span class="hljs-variable">speed</span>;</li><li><span class="hljs-title function_">AVCODEC_SAMPLE_LOGI</span>(<span class="hljs-string">"VD latency: %{public}ld writtenSampleCnt: %{public}ld"</span>, <span class="hljs-variable">latency</span>, <span class="hljs-variable">writtenSampleCnt</span>);</li><li>
</li><li><span class="hljs-variable">nowTimeStamp</span> = <span class="hljs-title function_">GetCurrentTime</span>();</li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">anchorDiff</span> = (<span class="hljs-variable">nowTimeStamp</span> - <span class="hljs-variable">audioTimeStamp</span>) / <span class="hljs-number">1000</span>;</li><li><span class="hljs-comment">// us, audio buffer accelerate render time</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">audioPlayedTime</span> = <span class="hljs-variable">audioDecContext</span>-&gt;<span class="hljs-title class_">currentPosAudioBufferPts</span> - <span class="hljs-title class_">latency</span> + <span class="hljs-title class_">anchorDiff</span>;</li><li><span class="hljs-comment">// us, video buffer expected render time</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">videoPlayedTime</span> = <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>;</li><li>
</li><li><span class="hljs-comment">// audio render timeStamp and now timeStamp diff</span></li><li><span class="hljs-variable">int64_t</span> <span class="hljs-variable">waitTimeUs</span> = <span class="hljs-variable">videoPlayedTime</span> - <span class="hljs-variable">audioPlayedTime</span>;</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L313-L326" target="_blank">Player.cpp</a></div></div></div></div> <div class="p">6. 根据业务延迟做音画同步策略。<ul><li>[ , -40ms)  视频帧较晚时，丢弃此帧。</li><li>[-40ms, 0ms) 视频帧直接送显。</li><li>[0ms, ) 视频帧较早，根据业务需要选择渐进同步。</li></ul> </div> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-objectivec" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L335-L351" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// video buffer is too late, drop it</span></li><li><span class="hljs-keyword">if</span> (waitTimeUs &lt; WAIT_TIME_US_THRESHOLD_WARNING) {</li><li>    dropFrame = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-built_in">AVCODEC_SAMPLE_LOGE</span>(<span class="hljs-string">"VD buffer is too late"</span>);</li><li>} <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-built_in">AVCODEC_SAMPLE_LOGE</span>(<span class="hljs-string">"VD buffer is too early waitTimeUs: %{public}ld"</span>, waitTimeUs);</li><li>    <span class="hljs-comment">// [0, ), render it with waitTimeUs, max 1s</span></li><li>    <span class="hljs-comment">// [-40,0), render it</span></li><li>    <span class="hljs-keyword">if</span> (waitTimeUs &gt; WAIT_TIME_US_THRESHOLD) {</li><li>        waitTimeUs = WAIT_TIME_US_THRESHOLD;</li><li>    }</li><li>    <span class="hljs-comment">// per frame render time reduced by 33ms</span></li><li>    <span class="hljs-keyword">if</span> (waitTimeUs &gt; sampleInfo.frameInterval + PER_SINK_TIME_THRESHOLD) {</li><li>        waitTimeUs = sampleInfo.frameInterval + PER_SINK_TIME_THRESHOLD;</li><li>        <span class="hljs-built_in">AVCODEC_SAMPLE_LOGE</span>(<span class="hljs-string">"VD buffer is too early and reduced 33ms, waitTimeUs: %{public}ld"</span>, waitTimeUs);</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L335-L351" target="_blank">Player.cpp</a></div></div></div></div> <p>7. 进行音画渐进同步。视频帧较早时，等待一段时间送显。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L354-L358" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">if</span> (<span class="hljs-variable">waitTimeUs</span> &gt; <span class="hljs-number">0</span>) {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">this_thread</span>::<span class="hljs-title class_">sleep_for</span>(<span class="hljs-variable">std</span>::<span class="hljs-variable">chrono</span>::<span class="hljs-title class_">microseconds</span>(<span class="hljs-title class_">waitTimeUs</span>));</li><li>}</li><li><span class="hljs-variable">lastPushTime</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">chrono</span>::<span class="hljs-title class_">system_clock</span>::<span class="hljs-title class_">now</span>();</li><li><span class="hljs-variable">ret</span> = <span class="hljs-variable">videoDecoder</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>, !<span class="hljs-title class_">dropFrame</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/player/Player.cpp#L354-L358" target="_blank">Player.cpp</a></div></div></div></div> <div class="p"><div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_start" target="_blank">OH_AudioRenderer_Start()</a>接口执行后到真正写入硬件有一定延迟，因此该接口在调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_start" target="_blank">OH_AudioRenderer_Start()</a>接口之后，过一会才会拿到有效值，期间音频未发声时建议画面帧先按照正常速度播放，后续再逐步追赶音频位置从而提升用户看到画面的起播时延。</li><li>当framePosition和timestamp以稳定的速度前进后，建议调用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>接口不要太频繁。推荐200ms一次，可以每分钟一次，最好不要低于200ms一次。频繁调用可能会带来功耗问题，因此在能保证音画同步效果的情况下，不需要频繁的查询时间戳。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_flush" target="_blank">OH_AudioRenderer_Flush()</a>接口执行后，framePosition返回值会重新（从0）开始计算。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_getframeswritten" target="_blank">OH_AudioRenderer_GetFramesWritten()</a> 接口在Flush时候不会清空，该接口和<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>接口不建议配合使用。</li><li>音频设备切换过程中<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>接口返回的framePosition和timestamp保证不会倒退，但由于新设备写入有时延，会出现音频进度短暂停滞，建议画面帧保持流畅播放不要产生卡顿。</li><li><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-audiorenderer-h#oh_audiorenderer_gettimestamp" target="_blank">OH_AudioRenderer_GetTimestamp()</a>接口获取的是实际写到硬件的采样帧数，不受倍速影响。对AudioRenderer设置了倍速的场景下，播放进度计算需要特殊处理，系统保证应用设置完倍速接口后，新写入AudioRenderer的采样点才会做倍速处理。</li></ul> </div></div></div> </div> </div> <div class="tiledSection"><h2 id="section18863195213010">网络视频的音画同步<i class="anchor-icon anchor-icon-link" anchorid="section18863195213010" tips="复制节点链接"></i></h2><p>除了播放本地视频外，三方视频应用还有播放网络视频的场景。</p> </div> <div class="tiledSection"><h3 id="section1622931912358" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section1622931912358" tips="复制节点链接"></i></h3><p>系统提供了<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithuri" target="_blank">OH_AVSource_CreateWithURI()</a>接口，可以对网络视频资源直接进行解封装并获取对应的音频和视频信息，然后使用连续播放音频帧方案进行音频和视频的播放同步。具体开发步骤如下所示。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithuri" target="_blank">OH_AVSource_CreateWithURI()</a>接口需要先配置网络权限ohos.permission.INTERNET。</p> </div></div></div> </div> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithuri" target="_blank">OH_AVSource_CreateWithURI()</a>接口对网络资源进行解封装处理，获取音频和视频信息。</li><li>使用<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section3976172773620">连续播放音频帧方案</a>进行音画同步播放。</li></ol> <div class="tiledSection"><h3 id="section3810929203520">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section3810929203520" tips="复制节点链接"></i></h3><p>1. 使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avsource-h#oh_avsource_createwithuri" target="_blank">OH_AVSource_CreateWithURI()</a>接口对网络资源进行解封装处理，获取音频和视频信息。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Demuxer.cpp#L25-L50" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Demuxer::Create</span><span class="hljs-params">(SampleInfo &amp;info)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (info.isLocal) {</li><li>        <span class="hljs-comment">// From the local video scenario</span></li><li>        source = <span class="hljs-built_in">OH_AVSource_CreateWithFD</span>(info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// From the local video scenario</span></li><li>        source = <span class="hljs-built_in">OH_AVSource_CreateWithURI</span>(info.networkUri);</li><li>    }</li><li>
</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(source != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR,</li><li>                             <span class="hljs-string">"Create demuxer source failed, fd: %{public}d, offset: %{public}"</span> PRId64</li><li>                             <span class="hljs-string">", file size: %{public}"</span> PRId64,</li><li>                             info.inputFd, info.inputFileOffset, info.inputFileSize);</li><li>    demuxer = <span class="hljs-built_in">OH_AVDemuxer_CreateWithSource</span>(source);</li><li>    <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Demuxer.cpp#L25-L50" target="_blank">Demuxer.cpp</a></div></div></div></div> <p>2. 解封资源得到音频帧和视频帧后，参考本章<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section340411415017">本地视频的音画同步</a>的<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section640118113514">开发步骤</a>中第3~7步进行音画同步播放。</p> </div> <div class="tiledSection"><h2 id="section125452116310">录制视频的音画同步<i class="anchor-icon anchor-icon-link" anchorid="section125452116310" tips="复制节点链接"></i></h2><p>有些三方视频应用还有录制的功能，在开发录制功能时，也需要保证录制的视频音画同步。</p> <p>当前可以使用如下两种方式实现视频录制。</p> <ul><li><strong>使用Camera+AVRecorder录制</strong>：AVRecorder集成了音频捕获，音频编码，视频编码，音视频封装功能，主要适用于实现简单视频录制并直接得到本地媒体文件的场景。</li><li><strong>使用Camera+AVCodec录制</strong>：AVCodec是系统提供的底层能力接口，需要应用自己实现音视频的编码和封装功能，主要适用于对视频录制自定义程度较高的场景。</li></ul> <p>当然在录制的过程中也需要保证录制的音频和视频音画同步，以保证录制后的视频在播放过程中即使不做处理也能做到音画同步。</p> <p>录制视频是将音频帧和视频帧按照时间戳（PTS）分别写入音频轨和视频轨后封装成视频文件的过程。时间戳就类似于音频轨和视频轨上的“坐标”，播放的进度到此时间戳（PTS）时，就会播放此“坐标”对应的音频帧和视频帧。所以如何给音频轨和视频轨写入时间戳（PTS）是保证录制视频音画同步的关键一步。</p> <p>Camera+AVRecorder录制方案中，给音轨和视频轨的时间戳的功能由高度封装的AVRecorder接口实现，不涉及开发者自己将时间戳写入音轨和视频轨并进行同步操作的关键步骤，所以这个场景不多赘述，需要了解可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-hdrvivid#section58824491485" target="_blank">使用Camera+AVRecorder录制</a>。</p> <p>接下来主要介绍在Camera+AVCodec录制的方案中，如何给音轨和视频轨添加时间戳并实现音画同步播放。</p> </div> <div class="tiledSection"><h3 id="section17762193673519" class="firsth2">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section17762193673519" tips="复制节点链接"></i></h3><p>添加时间戳（PTS）前，需要先确定时间基准，一般是以系统单调时钟为时间基准，且统一时间单位为微秒（μs）。</p> <ul><li><strong>系统单调时钟</strong>：该时钟从系统启动时开始计时，单调递增，不受系统时间修改、时区切换的影响。例如，音频启动录音时，第1秒时间戳为1000000μs，第2秒为2000000μs，以此类推。</li></ul> <p>确定时间基准后，下一步需要知道如何获取视频帧和音频帧的时间戳。</p> <ul><li><strong>视频帧</strong>：视频帧是由相机采集，采集频率由设定得帧率决定，如30fps，就代表相机每隔固定时间33.3ms 捕获一帧图像。这些原始帧的时间戳是单调递增的、间隔均匀地，但是受相机传感器、编码算力等因素影响，可能会出现帧间抖动，如30fps理论间隔时间是33.3ms，实际可能波动到30-38ms，甚至偶尔丢帧。</li><li><strong>音频帧</strong>：音频采集/编码逻辑简单、对硬件的需求低，所以在时间间隔稳定性和抗干扰能力上要比视频帧稳定。<p>因为音频帧比较稳定，所以可以将每一音频帧采集时的时间戳（此时间戳基于系统单调时钟）作为坐标写入音轨。通过接口<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getbufferattr" target="_blank">OH_AVBuffer_GetBufferAttr()</a>获取的PTS就是此音频帧的时间戳，可作为坐标写入音轨。</p> </li></ul> <p>而视频帧不稳定，其时间戳需要以帧率为基础来计算下，计算公式为：视频帧的时间戳 = (1000000/帧率) * (n-1) 。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><ul><li>1000000这是指的是1s = 1000000us，是系统单调时钟的单位。</li><li>n指的是此视频帧的在此视频里面的顺序，n=1,2...n ，第1帧时n=1，第2帧时n=2，以此类推。</li><li>以帧率30fps的视频为例，第1帧的时间戳为0us，第2帧的时间戳为 (1000000/30) * 1。</li></ul> </div></div></div> <p>获取到音频帧和视频帧的时间戳后，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avmuxer-h#oh_avmuxer_writesample" target="_blank">OH_AVMuxer_WriteSample()</a>接口将时间戳分别写入对应的轨道。这样关键的一步就完成了。主要的开发步骤如下。</p> <ol><li>先完成视频录制功能，视频录制的详细开发流程可以参考<a href="https://developer.huawei.com/consumer/cn/doc/best-practices/bpta-hdrvivid#section1809191617421" target="_blank">使用Camera+AVCodec录制</a>。</li><li>在执行音频帧和视频帧的封装操作时，参考此章节的方法，将时间戳分别写入音轨和视频轨。</li><li>视频录制完成将保存在本地，后续音画同步播放参考本章<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section340411415017">本地视频的音画同步</a>。</li></ol> </div> <div class="tiledSection"><h3 id="section3446124515354">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section3446124515354" tips="复制节点链接"></i></h3><p>详细的视频录制功能已有最佳实践介绍，并且录制后的视频保存在本地，其音画同步的开发步骤和本章本地视频音画同步一样，所以不过多赘述。这里主要介绍下，在视频录制的过程中，如何给音轨和视频轨添加时间戳。</p> <ol><li>使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avbuffer-h#oh_avbuffer_getbufferattr" target="_blank">OH_AVBuffer_GetBufferAttr()</a>获取音频帧的时间戳。</li></ol> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/common/SampleInfo.h#L81-L94" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CodecBufferInfo</span> {</li><li>    <span class="hljs-type">uint32_t</span> bufferIndex = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-type">uintptr_t</span> *buffer = <span class="hljs-literal">nullptr</span>;</li><li>    <span class="hljs-type">uint8_t</span> *bufferAddr = <span class="hljs-literal">nullptr</span>;</li><li>    OH_AVCodecBufferAttr attr = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, AVCODEC_BUFFER_FLAGS_NONE};</li><li>
</li><li>    <span class="hljs-function"><span class="hljs-keyword">explicit</span> <span class="hljs-title">CodecBufferInfo</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> *addr)</span> : bufferAddr(addr){</span>};</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint8_t</span> *addr, <span class="hljs-type">int32_t</span> bufferSize)</li><li>        : <span class="hljs-built_in">bufferAddr</span>(addr), <span class="hljs-built_in">attr</span>({<span class="hljs-number">0</span>, bufferSize, <span class="hljs-number">0</span>, AVCODEC_BUFFER_FLAGS_NONE}){};</li><li>    <span class="hljs-built_in">CodecBufferInfo</span>(<span class="hljs-type">uint32_t</span> argBufferIndex, OH_AVBuffer *argBuffer)</li><li>        : <span class="hljs-built_in">bufferIndex</span>(argBufferIndex), <span class="hljs-built_in">buffer</span>(<span class="hljs-built_in">reinterpret_cast</span>&lt;<span class="hljs-type">uintptr_t</span> *&gt;(argBuffer)) {</li><li>        <span class="hljs-built_in">OH_AVBuffer_GetBufferAttr</span>(argBuffer, &amp;attr);</li><li>    };</li><li>};</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/common/SampleInfo.h#L81-L94" target="_blank">SampleInfo.h</a></div></div></div></div> <p>2. 用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avmuxer-h#oh_avmuxer_writesample" target="_blank">OH_AVMuxer_WriteSample()</a>接口将时间戳写入音频轨。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/kangliangup/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L84-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::WriteSample</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> trackId, OH_AVBuffer *buffer, OH_AVCodecBufferAttr &amp;attr)</span></span>{</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(writeMutex_)</span></span>;</li><li>
</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(muxer_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Muxer is null"</span>);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(buffer != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Get a empty buffer"</span>);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(buffer, &amp;attr);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"SetBufferAttr failed"</span>);</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_AVMuxer_WriteSampleBuffer</span>(muxer_, trackId, buffer);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Write sample failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/kangliangup/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L84-L96" target="_blank">Muxer.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L295-L318" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">AudioEncOutputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_CONTINUE_LOG</span>(!<span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(),</li><li>                               <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>        <span class="hljs-title function_">AVCODEC_SAMPLE_LOGW</span>(</li><li>            <span class="hljs-string">"Audio Out buffer count: %{public}u, size: %{public}d, flag: %{public}u, pts: %{public}"</span> <span class="hljs-variable">PRId64</span>,</li><li>            <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>);</li><li>        <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">WriteSample</span>(<span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">GetAudioTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                            <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">audioEncoder_</span>-&gt;<span class="hljs-title class_">FreeOutputData</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-string">"Encoder output thread out"</span>);</li><li>    }</li><li>    <span class="hljs-title function_">AVCODEC_SAMPLE_LOGI</span>(<span class="hljs-string">"Exit, frame count: %{public}u"</span>, <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">inputFrameCount</span>);</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L295-L318" target="_blank">Recorder.cpp</a></div></div></div></div> <p>3. 计算视频帧的时间戳，用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/capi-native-avmuxer-h#oh_avmuxer_writesample" target="_blank">OH_AVMuxer_WriteSample()</a>接口将时间戳写入视频轨。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L24-L32" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">namespace</span> {</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">constexpr</span> <span class="hljs-type">int64_t</span> MICROSECOND = <span class="hljs-number">1000000</span>;</li><li><span class="hljs-comment">// ...</span></li><li>} </li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L24-L32" target="_blank">Recorder.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L119-L151" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">void</span> <span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">EncOutputThread</span>() {</li><li>    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">true</span>) {</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">unique_lock</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputMutex</span>);</li><li>        <span class="hljs-variable">bool</span> <span class="hljs-variable">condRet</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputCond</span>.<span class="hljs-title class_">wait_for</span>(</li><li>            <span class="hljs-title class_">lock</span>, <span class="hljs-number">5</span><span class="hljs-title class_">s</span>, [<span class="hljs-keyword">this</span>]() { <span class="hljs-keyword">return</span> !<span class="hljs-title class_">isStarted_</span> || !<span class="hljs-title class_">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(); });</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">isStarted_</span>, <span class="hljs-string">"Work done, thread out"</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_CONTINUE_LOG</span>(!<span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">empty</span>(),</li><li>                               <span class="hljs-string">"Buffer queue is empty, continue, cond ret: %{public}d"</span>, <span class="hljs-variable">condRet</span>);</li><li>
</li><li>        <span class="hljs-variable">CodecBufferInfo</span> <span class="hljs-variable">bufferInfo</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">front</span>();</li><li>        <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputBufferInfoQueue</span>.<span class="hljs-title class_">pop</span>();</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(!(<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_EOS</span>), <span class="hljs-string">"Catch EOS, thread out"</span>);</li><li>        <span class="hljs-variable">lock</span>.<span class="hljs-title function_">unlock</span>();</li><li>        <span class="hljs-keyword">if</span> ((<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> &amp; <span class="hljs-title class_">AVCODEC_BUFFER_FLAGS_SYNC_FRAME</span>) ||</li><li>            (<span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span> == <span class="hljs-variable">AVCODEC_BUFFER_FLAGS_NONE</span>)) {</li><li>            <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>++;</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span> * <span class="hljs-title class_">MICROSECOND</span> / <span class="hljs-variable">sampleInfo_</span>.<span class="hljs-variable">frameRate</span>;</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span> = <span class="hljs-number">0</span>;</li><li>        }</li><li>        <span class="hljs-title function_">AVCODEC_SAMPLE_LOGW</span>(<span class="hljs-string">"Out buffer count: %{public}u, size: %{public}d, flag: %{public}u, pts: %{public}"</span> <span class="hljs-variable">PRId64</span>,</li><li>                            <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">size</span>, <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">flags</span>,</li><li>                            <span class="hljs-variable">bufferInfo</span>.<span class="hljs-variable">attr</span>.<span class="hljs-variable">pts</span>);</li><li>
</li><li>        <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">WriteSample</span>(<span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">GetVideoTrackId</span>(), <span class="hljs-title class_">reinterpret_cast</span>&lt;<span class="hljs-variable">OH_AVBuffer</span> *&gt;(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">buffer</span>),</li><li>                            <span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">attr</span>);</li><li>        <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">FreeOutputBuffer</span>(<span class="hljs-title class_">bufferInfo</span>.<span class="hljs-title class_">bufferIndex</span>);</li><li>        <span class="hljs-title function_">CHECK_AND_BREAK_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-string">"Encoder output thread out"</span>);</li><li>    }</li><li>    <span class="hljs-title function_">AVCODEC_SAMPLE_LOGI</span>(<span class="hljs-string">"Exit, frame count: %{public}u"</span>, <span class="hljs-variable">encContext_</span>-&gt;<span class="hljs-title class_">outputFrameCount</span>);</li><li>    <span class="hljs-title function_">StartRelease</span>();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L119-L151" target="_blank">Recorder.cpp</a></div></div></div></div> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L84-L96" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-function"><span class="hljs-type">int32_t</span> <span class="hljs-title">Muxer::WriteSample</span><span class="hljs-params">(<span class="hljs-type">int32_t</span> trackId, OH_AVBuffer *buffer, OH_AVCodecBufferAttr &amp;attr)</span></span>{</li><li>    <span class="hljs-function">std::lock_guard&lt;std::mutex&gt; <span class="hljs-title">lock</span><span class="hljs-params">(writeMutex_)</span></span>;</li><li>
</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(muxer_ != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Muxer is null"</span>);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(buffer != <span class="hljs-literal">nullptr</span>, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Get a empty buffer"</span>);</li><li>
</li><li>    <span class="hljs-type">int32_t</span> ret = <span class="hljs-built_in">OH_AVBuffer_SetBufferAttr</span>(buffer, &amp;attr);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"SetBufferAttr failed"</span>);</li><li>
</li><li>    ret = <span class="hljs-built_in">OH_AVMuxer_WriteSampleBuffer</span>(muxer_, trackId, buffer);</li><li>    <span class="hljs-built_in">CHECK_AND_RETURN_RET_LOG</span>(ret == AV_ERR_OK, AVCODEC_SAMPLE_ERR_ERROR, <span class="hljs-string">"Write sample failed"</span>);</li><li>    <span class="hljs-keyword">return</span> AVCODEC_SAMPLE_ERR_OK;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/capbilities/Muxer.cpp#L84-L96" target="_blank">Muxer.cpp</a></div></div></div></div> <p>3. 执行封装操作，将录制的音频帧和视频帧封装成本地视频文件，并存入媒体库中。</p> <div class="screenLinkPre"><div _ngcontent-iiq-c106="" class="highlight-div"><div _ngcontent-iiq-c106="" class="highlight-div-header"><div _ngcontent-iiq-c106="" class="highlight-div-header-left"><div _ngcontent-iiq-c106="" class="handle-button expand-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-iiq-c106="" class="highlight-div-header-right"><div _ngcontent-iiq-c106="" class="handle-button ai-button"></div><div _ngcontent-iiq-c106="" class="handle-button line-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-iiq-c106="" class="handle-button theme-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-iiq-c106="" class="handle-button copy-button"><div _ngcontent-iiq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-iiq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L73-L115" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-variable">int32_t</span> <span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">Start</span>() {</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">lock_guard</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">mutex</span>&gt; <span class="hljs-title class_">lock</span>(<span class="hljs-title class_">mutex_</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(!<span class="hljs-variable">isStarted_</span>, <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Already started."</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">encContext_</span> != <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>, <span class="hljs-string">"Already started."</span>);</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">videoEncoder_</span> != <span class="hljs-variable">nullptr</span> &amp;&amp; <span class="hljs-variable">muxer_</span> != <span class="hljs-variable">nullptr</span>, <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>,</li><li>                             <span class="hljs-string">"Already started."</span>);</li><li>
</li><li>    <span class="hljs-variable">int32_t</span> <span class="hljs-variable">ret</span> = <span class="hljs-variable">muxer_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-variable">ret</span>, <span class="hljs-string">"Muxer start failed"</span>);</li><li>    <span class="hljs-variable">ret</span> = <span class="hljs-variable">videoEncoder_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>    <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-variable">ret</span>, <span class="hljs-string">"Encoder start failed"</span>);</li><li>
</li><li>    <span class="hljs-variable">isStarted_</span> = <span class="hljs-keyword">true</span>;</li><li>    <span class="hljs-variable">encOutputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">EncOutputThread</span>, <span class="hljs-keyword">this</span>);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">encOutputThread_</span> == <span class="hljs-variable">nullptr</span>) {</li><li>        <span class="hljs-title function_">AVCODEC_SAMPLE_LOGE</span>(<span class="hljs-string">"Create thread failed"</span>);</li><li>        <span class="hljs-title function_">StartRelease</span>();</li><li>        <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncContext_</span>) {</li><li>        <span class="hljs-comment">// Start AudioCapturer</span></li><li>        <span class="hljs-variable">audioCapturer_</span>-&gt;<span class="hljs-title class_">AudioCapturerStart</span>();</li><li>
</li><li>        <span class="hljs-variable">ret</span> = <span class="hljs-variable">audioEncoder_</span>-&gt;<span class="hljs-title class_">Start</span>();</li><li>        <span class="hljs-title function_">CHECK_AND_RETURN_RET_LOG</span>(<span class="hljs-variable">ret</span> == <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>, <span class="hljs-variable">ret</span>, <span class="hljs-string">"Audio Encoder start failed"</span>);</li><li>        <span class="hljs-variable">isStarted_</span> = <span class="hljs-keyword">true</span>;</li><li>        <span class="hljs-variable">audioEncInputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">AudioEncInputThread</span>, <span class="hljs-keyword">this</span>);</li><li>        <span class="hljs-variable">audioEncOutputThread_</span> = <span class="hljs-variable">std</span>::<span class="hljs-title class_">make_unique</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt;(&amp;<span class="hljs-variable">Recorder</span>::<span class="hljs-title class_">AudioEncOutputThread</span>, <span class="hljs-keyword">this</span>);</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncInputThread_</span> == <span class="hljs-variable">nullptr</span> || <span class="hljs-variable">audioEncOutputThread_</span> == <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-title function_">AVCODEC_SAMPLE_LOGE</span>(<span class="hljs-string">"Create thread failed"</span>);</li><li>            <span class="hljs-title function_">StartRelease</span>();</li><li>            <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_ERROR</span>;</li><li>        }</li><li>        </li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">audioEncContext_</span> != <span class="hljs-variable">nullptr</span>) {</li><li>            <span class="hljs-variable">audioEncContext_</span>-&gt;<span class="hljs-title class_">ClearCache</span>();</li><li>        }</li><li>    }</li><li>
</li><li>    <span class="hljs-title function_">AVCODEC_SAMPLE_LOGI</span>(<span class="hljs-string">"Succeed"</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">AVCODEC_SAMPLE_ERR_OK</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync/blob/master/entry/src/main/cpp/recorder/Recorder.cpp#L73-L115" target="_blank">Recorder.cpp</a></div></div></div></div> <p>4. 从媒体库中选择录制的视频，进行音画同步的播放。后续开发步骤参考本章<a href="/consumer/cn/doc/best-practices/bpta-audio-video-synchronization#section340411415017">本地视频的音画同步</a>。</p> </div> <div class="tiledSection"><h2 id="section579014539290">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section579014539290" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/AudioToVideoSync" target="_blank">实现音画同步播放效果</a></li></ul> </div> </div> <div></div></div>