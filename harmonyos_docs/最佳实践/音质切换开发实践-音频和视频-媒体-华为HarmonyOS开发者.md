<h1 _ngcontent-xqy-c119="" class="doc-title ng-star-inserted" title="音质切换开发实践"> 音质切换开发实践 </h1>

<div _ngcontent-xqy-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section1641373913213">概述<i class="anchor-icon anchor-icon-link" anchorid="section1641373913213" tips="复制节点链接"></i></h2><p>在音乐播放应用中，同一首歌曲在不同音质间的切换是一种常见功能，而音频文件的压缩方式是影响音质的关键因素之一。下表展示了不同压缩方式对应的音质对比：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.1.3.1.5.1.1" valign="top" width="24.972497249724974%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.5.1.2" valign="top" width="25.02250225022502%"><p>代表格式</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.5.1.3" valign="top" width="25.002500250025%"><p>播放能力支持</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.1.3.1.5.1.4" valign="top" width="25.002500250025%"><p>特点</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="24.972497249724974%"><p>未压缩</p> </td> <td class="cellrowborder" valign="top" width="25.02250225022502%"><p>PCM/WAV</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>PCM：AudioRenderer</p> <p>WAV：AVPlayer</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>高保真、体积大</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24.972497249724974%"><p>无损压缩</p> </td> <td class="cellrowborder" valign="top" width="25.02250225022502%"><p>FLAC/APE</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>AVPlayer</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>可还原原始数据</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24.972497249724974%"><p>有损压缩</p> </td> <td class="cellrowborder" valign="top" width="25.02250225022502%"><p>MP3/AAC</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>AVPlayer</p> </td> <td class="cellrowborder" valign="top" width="25.002500250025%"><p>体积小、音质损失</p> </td> </tr>  </tbody></table></div> </div> <p>音质可以在未压缩、无损压缩和有损压缩之间切换，根据上述播放能力支持范围可以看出，音质切换的本质为<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiorenderer" target="_blank">AudioRenderer</a>与<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer" target="_blank">AVPlayer</a>的播放切换，以及AVPlayer与AVPlayer的播放切换（即使用AVPlayer在不同音频格式间的播放切换）。</p> <p></p> <p>本文将介绍以下两种音质切换场景的实现：</p> <ul><li><a href="/consumer/cn/doc/best-practices/bpta-sound-quality-switching#section1718774317213">AudioRenderer与AVPlayer播放切换</a></li><li><a href="/consumer/cn/doc/best-practices/bpta-sound-quality-switching#section198441182235">AVPlayer与AVPlayer播放切换</a></li></ul> </div> <div class="tiledSection"><h2 id="section1718774317213">AudioRenderer与AVPlayer播放切换<i class="anchor-icon anchor-icon-link" anchorid="section1718774317213" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section5675201102210" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section5675201102210" tips="复制节点链接"></i></h3><p>本场景以同一音频文件的PCM格式与MP3格式之间进行切换播放为例，切换后保持音频播放进度一致，即无缝衔接。</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163042.65569301240150813728102179780299:50001231000000:2800:13591B4E96ABD27E1F59B07ADBE8842DA8B2D908B252D67E3BCEBB8414EAAF90.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section87234152227">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section87234152227" tips="复制节点链接"></i></h3><ol><li>使用AudioRenderer播放PCM文件，即MP3音质（标清）切换到无损未压缩的PCM音质时，通过跳转的时间戳计算出新的offset偏移位置，待下次读取音频数据时，从该offset偏移位置开始读取，AudioRenderer即可实现跳转至指定位置播放。</li><li>使用AVPlayer播放MP3文件，即无损未压缩的PCM音质切换到MP3音质（标清）时，通过AVPlayer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>接口可直接跳转到对应时间戳位置播放。</li></ol> </div> <div class="tiledSection"><h3 id="section681994314225">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section681994314225" tips="复制节点链接"></i></h3><ol><li>在MediaTools类中，定义如下方法：<ul><li>msToCountdownTime()：根据当前毫秒数转换为分钟格式。</li><li>getMsFromByteLength()：根据字节长度转化为播放时间长度。</li><li>getOffsetFromTime()：根据播放时间长度转化为字节长度。</li></ul> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/utils/MediaTools.ets#L25-L68" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaTools</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">msToCountdownTime</span>(<span class="hljs-attr">ms</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">string</span> {</li><li>    <span class="hljs-keyword">if</span> (!ms) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-string">'00:00'</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> days = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(ms / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>));</li><li>    <span class="hljs-keyword">const</span> hours = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((ms % (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>)) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>));</li><li>    <span class="hljs-keyword">const</span> minutes = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((ms % (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span>)) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span>));</li><li>    <span class="hljs-keyword">const</span> seconds = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((ms % (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span>)) / <span class="hljs-number">1000</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${(days ? MediaTools.fill(days) + <span class="hljs-string">':'</span> : <span class="hljs-string">''</span>)}</span><span class="hljs-subst">${(hours ? MediaTools.fill(hours) + <span class="hljs-string">':'</span> : <span class="hljs-string">''</span>)}</span></span></li><li><span class="hljs-string">      <span class="hljs-subst">${MediaTools.fill(minutes)}</span>:<span class="hljs-subst">${MediaTools.fill(seconds)}</span> `</span>.<span class="hljs-title function_">trim</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getMsFromByteLength</span>(<span class="hljs-attr">byteLength</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">number</span> {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-number">1000</span> * (byteLength / <span class="hljs-variable constant_">SECOND_BUFFER_WALK</span>);</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getOffsetFromTime</span>(<span class="hljs-params">curMs: <span class="hljs-built_in">number</span></span>) {</li><li>    <span class="hljs-keyword">return</span> (curMs / <span class="hljs-number">1000</span>) * <span class="hljs-variable constant_">SECOND_BUFFER_WALK</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/utils/MediaTools.ets#L25-L68" target="_blank">MediaTools.ets</a></div></div></div></div> </li><li>在AVPlayerController类中，定义如下方法：<ul><li>reset()：在其中调用AVPlayer实例的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#reset9" target="_blank">reset()</a>方法，重置播放。</li><li>pause()：在其中调用AVPlayer实例的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#pause9-1" target="_blank">pause()</a>方法，暂停播放。</li><li>seek()：在其中调用AVPlayer实例的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-media-avplayer#seek9" target="_blank">seek()</a>，跳转播放。</li></ul> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/AVPlayerController.ets#L22-L144" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVPlayerController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">reset</span>(<span class="hljs-attr">fd</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">offset</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">length</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentTime</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'progress'</span>) <span class="hljs-keyword">as</span> <span class="hljs-built_in">number</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">isReset</span> = <span class="hljs-literal">true</span>;</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">reset</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span> != <span class="hljs-literal">undefined</span>) {</li><li>        <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>.<span class="hljs-property">fdSrc</span> = { <span class="hljs-attr">fd</span>: fd, <span class="hljs-attr">offset</span>: offset, <span class="hljs-attr">length</span>: length };</li><li>      }</li><li>    })</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-comment">// Pause playback</span></li><li>  <span class="hljs-title function_">pause</span>(): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">pause</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'AVPlayerController pause error!'</span>);</li><li>    })</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Jump to playback</span></li><li>  <span class="hljs-title function_">seek</span>(<span class="hljs-attr">currentTime</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">avPlayer</span>?.<span class="hljs-title function_">seek</span>(currentTime, media.<span class="hljs-property">SeekMode</span>.<span class="hljs-property">SEEK_NEXT_SYNC</span>);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/AVPlayerController.ets#L22-L144" target="_blank">AVPlayerController.ets</a></div></div></div></div> </li><li>在AudioRendererController类中，定义如下方法：<ul><li>initAudioRenderer()：初始化，获取AudioRenderer实例。</li><li>setWriteDataCallback()：写入音频数据。</li><li>start()：在其中调用AudioRenderer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiorenderer#start8" target="_blank">start()</a>方法，启动音频渲染器。</li><li>pause()：在其中调用AudioRenderer的<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiorenderer#pause8" target="_blank">pause()</a>方法，暂停音频渲染。</li><li>seek()：自定义seek()方法保存当前播放进度、时间的转换和字节长度，用于AudioRenderer跳转播放。</li></ul> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/AudioRendererController.ets#L22-L192" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AudioRendererController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Initialization AudioRenderer</span></li><li>  <span class="hljs-keyword">public</span> async initAudioRenderer(fd: number, offset: number, length: number): Promise&lt;void&gt; {</li><li>    <span class="hljs-keyword">this</span>.fd = fd; <span class="hljs-comment">// File descriptor</span></li><li>    <span class="hljs-keyword">this</span>.offset = offset; <span class="hljs-comment">// Start offset</span></li><li>    <span class="hljs-keyword">this</span>.currentOffset = offset; <span class="hljs-comment">// Current offset</span></li><li>    <span class="hljs-keyword">this</span>.length = length; <span class="hljs-comment">// File length</span></li><li>    <span class="hljs-comment">// Audio stream information</span></li><li>    let audioStreamInfo: audio.AudioStreamInfo = {</li><li>      samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_48000, <span class="hljs-comment">// Audio file sampling rate</span></li><li>      channels: audio.AudioChannel.CHANNEL_2, <span class="hljs-comment">// Number of audio file channels</span></li><li>      sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE, <span class="hljs-comment">// Audio sampling format</span></li><li>      encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW <span class="hljs-comment">// Audio encoding format</span></li><li>    };</li><li>    <span class="hljs-comment">// AudioRenderer information</span></li><li>    let audioRendererInfo: audio.AudioRendererInfo = {</li><li>      usage: audio.StreamUsage.STREAM_USAGE_MUSIC, <span class="hljs-comment">// Audio stream usage type</span></li><li>      rendererFlags: <span class="hljs-number">0</span> <span class="hljs-comment">// Audio renderer flag</span></li><li>    };</li><li>    <span class="hljs-comment">// AudioRenderer options information</span></li><li>    let audioRendererOptions: audio.AudioRendererOptions = {</li><li>      streamInfo: audioStreamInfo,</li><li>      rendererInfo: audioRendererInfo</li><li>    };</li><li>    <span class="hljs-comment">// Get audio renderer</span></li><li>    await audio.createAudioRenderer(audioRendererOptions).then((<span class="hljs-keyword">data</span>) =&gt; {</li><li>      <span class="hljs-keyword">this</span>.audioRenderer = <span class="hljs-keyword">data</span>;</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRenderer !== undefined) {</li><li>        <span class="hljs-keyword">try</span> {</li><li>          <span class="hljs-comment">// Set the focus model to independent focus mode</span></li><li>          <span class="hljs-keyword">this</span>.audioRenderer.setInterruptMode(audio.InterruptMode.INDEPENDENT_MODE);</li><li>          <span class="hljs-keyword">this</span>.setWriteDataCallback(); <span class="hljs-comment">// Write audio data</span></li><li>        } <span class="hljs-keyword">catch</span> (error) {</li><li>          Logger.error(<span class="hljs-string">'createAudioRenderer is calling.'</span>);</li><li>        }</li><li>      }</li><li>    });</li><li>    <span class="hljs-comment">// Convert the file length to the corresponding number of milliseconds and store it in AppStorage.</span></li><li>    AppStorage.setOrCreate(<span class="hljs-string">'progressMax'</span>, MediaTools.getMsFromByteLength(<span class="hljs-keyword">this</span>.length));</li><li>    <span class="hljs-comment">// Convert the file length to the corresponding number of milliseconds, then convert it to a timestamp and store it in AppStorage.</span></li><li>    AppStorage.setOrCreate(<span class="hljs-string">'totalTime'</span>, MediaTools.msToCountdownTime(MediaTools.getMsFromByteLength(<span class="hljs-keyword">this</span>.length)));</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">// Write audio data</span></li><li>  <span class="hljs-keyword">private</span> setWriteDataCallback(): void {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-comment">// Listening for audio data writing</span></li><li>      <span class="hljs-keyword">this</span>.audioRenderer?.on(<span class="hljs-string">'writeData'</span>, (buffer) =&gt; {</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.currentOffset - <span class="hljs-keyword">this</span>.offset &gt;= <span class="hljs-keyword">this</span>.length) {</li><li>          <span class="hljs-keyword">this</span>.currentOffset = <span class="hljs-keyword">this</span>.offset;</li><li>          <span class="hljs-keyword">this</span>.seek(<span class="hljs-number">0</span>);</li><li>        }</li><li>        let options: ReadOptions = {</li><li>          offset: <span class="hljs-keyword">this</span>.currentOffset,</li><li>          length: buffer.byteLength</li><li>        };</li><li>        let bufferLength = fileIo.readSync(<span class="hljs-keyword">this</span>.fd, buffer, options);</li><li>        <span class="hljs-keyword">this</span>.currentOffset += buffer.byteLength;</li><li>        let processOffset = <span class="hljs-keyword">this</span>.currentOffset - <span class="hljs-keyword">this</span>.offset;</li><li>
</li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.offset + <span class="hljs-keyword">this</span>.length &lt;= <span class="hljs-keyword">this</span>.currentOffset) {</li><li>          let view = new DataView(buffer);</li><li>          Logger.info(<span class="hljs-string">'currentOffset ：'</span> + <span class="hljs-keyword">this</span>.currentOffset + <span class="hljs-string">'  endOffset:'</span> + (<span class="hljs-keyword">this</span>.offset + <span class="hljs-keyword">this</span>.length) +</li><li>            <span class="hljs-string">' bufferLength:'</span> + bufferLength);</li><li>          <span class="hljs-keyword">for</span> (let i = bufferLength - <span class="hljs-number">1</span>; i &gt; processOffset - <span class="hljs-keyword">this</span>.length; i--) {</li><li>            view.setUint8(i, <span class="hljs-number">0</span>);</li><li>          }</li><li>        }</li><li>
</li><li>        let curMs = MediaTools.getMsFromByteLength(processOffset);</li><li>        AppStorage.setOrCreate(<span class="hljs-string">'progress'</span>, curMs);</li><li>        AppStorage.setOrCreate(<span class="hljs-string">'currentTime'</span>, MediaTools.msToCountdownTime(curMs));</li><li>      })</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      Logger.error(<span class="hljs-string">'setWriteDataCallback is failed. '</span> + error);</li><li>    }</li><li>  }</li><li>
</li><li>
</li><li>  <span class="hljs-keyword">public</span> async start(): Promise&lt;void&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRenderer !== undefined) {</li><li>      <span class="hljs-comment">// Audio state</span></li><li>      let stateGroup = [audio.AudioState.STATE_PREPARED, audio.AudioState.STATE_PAUSED, audio.AudioState.STATE_STOPPED];</li><li>      <span class="hljs-keyword">if</span> (stateGroup.indexOf(<span class="hljs-keyword">this</span>.audioRenderer.state.valueOf()) === -<span class="hljs-number">1</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-comment">// Starting the AudioRenderer</span></li><li>      <span class="hljs-keyword">this</span>.audioRenderer.start((err: BusinessError) =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>      });</li><li>    }</li><li>  }</li><li>
</li><li>  <span class="hljs-keyword">public</span> pause(): void {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRenderer !== undefined) {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRenderer.state.valueOf() !== audio.AudioState.STATE_RUNNING) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>     <span class="hljs-comment">// Pause Audio rendering</span></li><li>      <span class="hljs-keyword">this</span>.audioRenderer.pause((err: BusinessError) =&gt; {</li><li>        <span class="hljs-comment">// ...</span></li><li>      });</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// Jump to playback</span></li><li>  <span class="hljs-keyword">public</span> seek(ms: number): void {</li><li>    <span class="hljs-keyword">this</span>.curMs = ms;</li><li>    AppStorage.setOrCreate(<span class="hljs-string">'progress'</span>, <span class="hljs-keyword">this</span>.curMs);</li><li>    AppStorage.setOrCreate(<span class="hljs-string">'currentTime'</span>, MediaTools.msToCountdownTime(<span class="hljs-keyword">this</span>.curMs));</li><li>    <span class="hljs-keyword">this</span>.currentOffset = <span class="hljs-keyword">this</span>.offset + MediaTools.getOffsetFromTime(<span class="hljs-keyword">this</span>.curMs);</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/AudioRendererController.ets#L22-L192" target="_blank">AudioRendererController.ets</a></div></div></div></div> </li><li>在PlayerController类中，定义如下方法：<ul><li>changeType()：传入rawFileDescriptor音频资源描述符，并通过audioType的值，判断使用AudioRenderer或AVPlayer播放音频。</li><li>seek()：通过判断isAVPlayer()返回值，调用AVPlayerController或AudioRendererController对应的seek()方法，用于跳转指定位置播放音频资源。</li><li>isAVPlayer()：用于判断是否使用AVPlayer播放音频资源。</li></ul> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/PlayerController.ets#L22-L120" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlayerController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Modifying the audio format</span></li><li>  changeType(rawFileDescriptor: resourceManager.RawFileDescriptor, audioType: AudioType) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.rawFileDescriptor = rawFileDescriptor;</li><li>      <span class="hljs-keyword">if</span> (audioType === <span class="hljs-number">1</span> || audioType === <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-keyword">this</span>.audioRendererController?.pause(); <span class="hljs-comment">// Pause AudioRenderer playback</span></li><li>        <span class="hljs-comment">// Reset AVPlayer playback</span></li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.reset(<span class="hljs-keyword">this</span>.rawFileDescriptor.fd, <span class="hljs-keyword">this</span>.rawFileDescriptor.offset,</li><li>          <span class="hljs-keyword">this</span>.rawFileDescriptor.length);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.pause(); <span class="hljs-comment">// Pause AVPlayer playback</span></li><li>        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRendererController === undefined) {</li><li>          <span class="hljs-keyword">this</span>.audioRendererController = new AudioRendererController();</li><li>        }</li><li>        <span class="hljs-comment">// Create an AudioRenderer instance and listen for audio data writing</span></li><li>        <span class="hljs-keyword">this</span>.audioRendererController.initAudioRenderer(<span class="hljs-keyword">this</span>.rawFileDescriptor.fd, <span class="hljs-keyword">this</span>.rawFileDescriptor.offset,</li><li>          <span class="hljs-keyword">this</span>.rawFileDescriptor.length).then(() =&gt; {</li><li>          <span class="hljs-keyword">this</span>.audioRendererController?.start(); <span class="hljs-comment">// Start AudioRenderer audio render</span></li><li>        });</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.currentType = audioType;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      Logger.error(<span class="hljs-string">'changeType error!'</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Determine the return value of isAVPlayer() and call the corresponding seek() method</span></li><li>  seek(currentTime: number): void {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isAVPlayer()) {</li><li>      <span class="hljs-keyword">this</span>.avPlayerController?.seek(currentTime);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-keyword">this</span>.audioRendererController?.seek(currentTime);</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Determine whether to use AVPlayer for playback</span></li><li>  isAVPlayer(): boolean {</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.currentType === <span class="hljs-number">1</span> || <span class="hljs-keyword">this</span>.currentType === <span class="hljs-number">2</span>;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/PlayerController.ets#L22-L120" target="_blank">PlayerController.ets</a></div></div></div></div> </li><li>在页面中自定义changeType()事件，通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-resource-manager#getrawfd9-1" target="_blank">getRawfd()</a>获取resources/rawfile目录下的音频资源，将获取到的数据传入PlayerController的changeType()方法，调用playerController的seek()方法传入当前Slider进度的值，用于跳转播放。<div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L220-L228" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">changeType</span>(<span class="hljs-attr">songSrc</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">audioType</span>: <span class="hljs-title class_">AudioType</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(songSrc).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">rawFileDescriptor</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerController</span>.<span class="hljs-title function_">changeType</span>(rawFileDescriptor, audioType);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerController</span>.<span class="hljs-title function_">seek</span>(current);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`resourceManager error code <span class="hljs-subst">${error.code}</span> message <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L220-L228" target="_blank">ControlAreaComponent.ets</a></div></div></div></div> <p>通过给对应MenuItem子组件添加对应点击事件，在其中调用changeType()方法传入音频资源文件路径和对应音频格式audioType，实现音频资源PCM格式与MP3格式的切换播放，即AudioRenderer与AVPlayer切换播放。</p> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L160-L216" data-highlighted="yes"><ol class="linenums"><li>Menu() {</li><li>  MenuItem({</li><li>    content: $r(<span class="hljs-string">'app.string.standard_quality'</span>),</li><li>  }).onClick(() =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.index === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.text = $r(<span class="hljs-string">'app.string.standard_quality'</span>);</li><li>    <span class="hljs-keyword">this</span>.index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">this</span>.changeType(<span class="hljs-keyword">this</span>.songData.src + AudioName.MP3, AudioType.MP3);</li><li>    <span class="hljs-keyword">this</span>.isPlay = <span class="hljs-literal">true</span>;</li><li>  })</li><li>  <span class="hljs-comment">// ...</span></li><li>  MenuItem({</li><li>    content: $r(<span class="hljs-string">'app.string.pcm_high_quality'</span>),</li><li>  })</li><li>    .onClick(() =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.index === <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.text = $r(<span class="hljs-string">'app.string.pcm_high_quality'</span>);</li><li>      <span class="hljs-keyword">this</span>.index = <span class="hljs-number">2</span>;</li><li>      <span class="hljs-keyword">this</span>.changeType(<span class="hljs-keyword">this</span>.songData.src + AudioName.PCM, AudioType.PCM);</li><li>      <span class="hljs-keyword">this</span>.isPlay = <span class="hljs-literal">true</span>;</li><li>    })</li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L160-L216" target="_blank">ControlAreaComponent.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section198441182235">AVPlayer与AVPlayer播放切换<i class="anchor-icon anchor-icon-link" anchorid="section198441182235" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section2361431122319" class="firsth2">场景描述<i class="anchor-icon anchor-icon-link" anchorid="section2361431122319" tips="复制节点链接"></i></h3><p>本场景以同一音频文件的FLAC格式与MP3格式之间进行切换播放为例，切换后保持音频播放进度一致，即无缝衔接。</p> <p><span><img height="549.2900000000001" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163042.02483316007492389907459084915765:50001231000000:2800:264FAEE1A384388350AD5D86A4329DC8438E381BFE05D8F220C153AA1AD74386.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h3 id="section18365141118247">实现原理<i class="anchor-icon anchor-icon-link" anchorid="section18365141118247" tips="复制节点链接"></i></h3><p>使用同一个AVPlayer实例播放FLAC文件和MP3文件，每次切换后对AVPlayer进行重置，重新设置音频资源url，然后通过AVPlayer的seek()接口直接跳转到对应时间戳位置播放。</p> </div> <div class="tiledSection"><h3 id="section18888134017242">开发步骤<i class="anchor-icon anchor-icon-link" anchorid="section18888134017242" tips="复制节点链接"></i></h3><ol><li>在MenuItem组件的点击事件中调用自定义changeType()方法，传入音频资源文件路径和对应音频格式audioType。<div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L161-L215" data-highlighted="yes"><ol class="linenums"><li>Menu() {</li><li>  MenuItem({</li><li>    content: $r(<span class="hljs-string">'app.string.standard_quality'</span>),</li><li>  }).onClick(() =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.index === <span class="hljs-number">0</span>) {</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">this</span>.text = $r(<span class="hljs-string">'app.string.standard_quality'</span>);</li><li>    <span class="hljs-keyword">this</span>.index = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-keyword">this</span>.changeType(<span class="hljs-keyword">this</span>.songData.src + AudioName.MP3, AudioType.MP3);</li><li>    <span class="hljs-keyword">this</span>.isPlay = <span class="hljs-literal">true</span>;</li><li>  })</li><li>  MenuItem({</li><li>    content: $r(<span class="hljs-string">'app.string.flac_high_quality'</span>),</li><li>  })</li><li>    .onClick(() =&gt; {</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.index === <span class="hljs-number">1</span>) {</li><li>        <span class="hljs-keyword">return</span>;</li><li>      }</li><li>      <span class="hljs-keyword">this</span>.text = $r(<span class="hljs-string">'app.string.flac_high_quality'</span>);</li><li>      <span class="hljs-keyword">this</span>.index = <span class="hljs-number">1</span>;</li><li>      <span class="hljs-keyword">this</span>.changeType(<span class="hljs-keyword">this</span>.songData.src + AudioName.FLAC, AudioType.FLAC);</li><li>      <span class="hljs-keyword">this</span>.isPlay = <span class="hljs-literal">true</span>;</li><li>    })</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li><li><span class="hljs-comment">// ...</span></li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L161-L215" target="_blank">ControlAreaComponent.ets</a></div></div></div></div> </li><li>同样的，在页面自定义changeType()事件中，通过getRawfd()获取音频资源，将获取到的数据传入PlayerController的changeType()方法，调用playerController的seek()方法传入当前Slider进度值，用于跳转播放。<div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L220-L228" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">changeType</span>(<span class="hljs-attr">songSrc</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">audioType</span>: <span class="hljs-title class_">AudioType</span>): <span class="hljs-built_in">void</span> {</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">current</span>: <span class="hljs-built_in">number</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">value</span>;</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">getHostContext</span>()?.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFd</span>(songSrc).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">rawFileDescriptor</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerController</span>.<span class="hljs-title function_">changeType</span>(rawFileDescriptor, audioType);</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">playerController</span>.<span class="hljs-title function_">seek</span>(current);</li><li>  }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`resourceManager error code <span class="hljs-subst">${error.code}</span> message <span class="hljs-subst">${error.message}</span>`</span>);</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/components/ControlAreaComponent.ets#L220-L228" target="_blank">ControlAreaComponent.ets</a></div></div></div></div> </li><li>在PlayerController的changeType()方法中：<ol><li>通过传入的audioType的值，判断音频是否为MP3或FLAC格式。</li><li>调用audioRendererController的pause()方法，暂停AudioRenderer音频渲染。</li><li>通过avPlayerController的reset()方法重置音频资源的描述符、偏移量和文件长度，实现音频资源FLAC格式与MP3格式的切换播放，即AVPlayer与AVPlayer切换播放。</li></ol> <div class="screenLinkPre"><div _ngcontent-xqy-c106="" class="highlight-div"><div _ngcontent-xqy-c106="" class="highlight-div-header"><div _ngcontent-xqy-c106="" class="highlight-div-header-left"><div _ngcontent-xqy-c106="" class="handle-button expand-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-xqy-c106="" class="highlight-div-header-right"><div _ngcontent-xqy-c106="" class="handle-button ai-button"></div><div _ngcontent-xqy-c106="" class="handle-button line-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-xqy-c106="" class="handle-button theme-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-xqy-c106="" class="handle-button copy-button"><div _ngcontent-xqy-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-xqy-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/PlayerController.ets#L23-L119" data-highlighted="yes"><ol class="linenums"><li>export <span class="hljs-keyword">class</span> <span class="hljs-title class_">PlayerController</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Modifying the audio format</span></li><li>  changeType(rawFileDescriptor: resourceManager.RawFileDescriptor, audioType: AudioType) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">this</span>.rawFileDescriptor = rawFileDescriptor;</li><li>      <span class="hljs-keyword">if</span> (audioType === <span class="hljs-number">1</span> || audioType === <span class="hljs-number">2</span>) {</li><li>        <span class="hljs-keyword">this</span>.audioRendererController?.pause(); <span class="hljs-comment">// Pause AudioRenderer playback</span></li><li>        <span class="hljs-comment">// Reset AVPlayer playback</span></li><li>        <span class="hljs-keyword">this</span>.avPlayerController?.reset(<span class="hljs-keyword">this</span>.rawFileDescriptor.fd, <span class="hljs-keyword">this</span>.rawFileDescriptor.offset,</li><li>          <span class="hljs-keyword">this</span>.rawFileDescriptor.length);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-comment">// ...</span></li><li>      }</li><li>      <span class="hljs-keyword">this</span>.currentType = audioType;</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      Logger.error(<span class="hljs-string">'changeType error!'</span>);</li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-comment">// Determine the return value of isAVPlayer() and call the corresponding seek() method</span></li><li>  seek(currentTime: number): void {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isAVPlayer()) {</li><li>      <span class="hljs-keyword">this</span>.avPlayerController?.seek(currentTime);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>      <span class="hljs-comment">// ...</span></li><li>    }</li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-format-switch/blob/master/entry/src/main/ets/player/PlayerController.ets#L23-L119" target="_blank">PlayerController.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section43330241255">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section43330241255" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/audio-format-switch" target="_blank">实现音质切换</a></li></ul> </div> </div> <div></div></div>