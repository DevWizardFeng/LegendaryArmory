<h1 _ngcontent-ofq-c119="" class="doc-title ng-star-inserted" title="音频播放交互场景"> 音频播放交互场景 </h1>

<div _ngcontent-ofq-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section476219594558">概述<i class="anchor-icon anchor-icon-link" anchorid="section476219594558" tips="复制节点链接"></i></h2><p>对于音频播放类应用，除了歌曲播控的基础能力外，各种交互场景的设计也对用户体验有着重要的影响。本文以音乐播放器应用为例，从应用与用户、播放设备以及其他应用的交互三方面入手，分别对典型使用场景给出示例方案，为应用带来灵活多样、符合用户直觉的交互体验。</p> <p><span><img height="549.2767" originheight="1080" originwidth="523" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.36385373884140465467102378243863:50001231000000:2800:51DDF9E9FFE8ABAFEB3460F6A9265774E53C24BB098AF7DDEC182D39A51D14F8.gif" title="点击放大" width="266"></span></p> </div> <div class="tiledSection"><h2 id="section052022317325">场景分析<i class="anchor-icon anchor-icon-link" anchorid="section052022317325" tips="复制节点链接"></i></h2><p>根据当前HarmonyOS APP开发过程中遇到的实际音频类应用业务场景，总结提炼出如下典型场景，设计其交互功能与方案以供参考：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.2.3.1.4.1.1" valign="top" width="24.47%"><p>场景分类</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.4.1.2" valign="top" width="26.419999999999998%"><p>典型场景</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.2.3.1.4.1.3" valign="top" width="49.11%"><p>场景描述</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="2" valign="top" width="24.47%"><p>与用户交互</p> </td> <td class="cellrowborder" valign="top" width="26.419999999999998%"><p>播控中心操控</p> </td> <td class="cellrowborder" valign="top" width="49.11%"><p>无需进入应用直接通过播控中心操控歌曲状态</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>后台播放音乐</p> </td> <td class="cellrowborder" valign="top"><p>应用位于后台长时间持续播放音乐</p> </td> </tr> <tr><td class="cellrowborder" rowspan="3" valign="top" width="24.47%"><p>与音频播放设备交互</p> </td> <td class="cellrowborder" valign="top" width="26.419999999999998%"><p>播放设备的状态发生改变</p> </td> <td class="cellrowborder" valign="top" width="49.11%"><p>新设备可用、旧设备不可用、用户切换设备场景的适配方案</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>响应播放设备的指令</p> </td> <td class="cellrowborder" valign="top"><p>蓝牙耳机控制应用播放状态</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>用户主动切换播放设备</p> </td> <td class="cellrowborder" valign="top"><p>通过投播组件选择播放设备</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="24.47%"><p>与其他应用交互</p> </td> <td class="cellrowborder" valign="top" width="26.419999999999998%"><p>与其他应用音频冲突</p> </td> <td class="cellrowborder" valign="top" width="49.11%"><p>被其他音频打断、与其他音频并发</p> </td> </tr>  </tbody></table></div> </div> </div> <div class="tiledSection"><h2 id="section82654344020">与用户交互<i class="anchor-icon anchor-icon-link" anchorid="section82654344020" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1245419358228" class="firsth2">播控中心控制音乐状态<i class="anchor-icon anchor-icon-link" anchorid="section1245419358228" tips="复制节点链接"></i></h3></div> <p>在应用接入播控中心后，用户可以直接通过播控中心修改音频播放状态，如暂停/播放、下一首、切换播放模式、拖动进度条等，应用内的音频信息和状态也会同步显示在播控中心界面上，使得用户与应用的交互更加灵活易用。同时与播控中心交互使用的AVSession还管控着应用的后台播放能力，因此对于音乐类应用一般推荐接入播控中心，具体适用场景可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/avsession-access-scene" target="_blank">应用接入AVSession场景介绍</a>。</p> <p>应用与播控中心交互的过程如下图所示：</p> <p><span><img height="462.87591000000003" originheight="630" originwidth="953" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.06110146952959579644749732241885:50001231000000:2800:C61BC506CD0049285C5D67971AE9F38C72B0D642D846C289E033190B7BE74A54.png" title="点击放大" width="700.245"></span></p> <p>由图可见，应用的接入流程可以主要分为三个部分：创建AVSession、监听播控中心通知以及向播控中心上报应用状态，以下分别给出具体实现：</p> <ol><li>应用创建媒体会话<div class="p">在应用的音频渲染器初始化的时候创建并激活AVSession，将此会话用作应用与播控中心交互的媒介，音乐类应用选择创建audio类型的AVSession，不同类型的AVSession对应不同的播控中心样式，详细指导参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/using-avsession-developer" target="_blank">媒体会话提供方</a>。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L18-L383" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { avSession } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AVSessionController</span> {</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-title class_">AVSession</span>: avSession.<span class="hljs-property">AVSession</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">songList</span>: <span class="hljs-title class_">SongItem</span>[] = [];</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">musicIndex</span>: <span class="hljs-built_in">number</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-keyword">private</span> <span class="hljs-attr">audioRendererController</span>: <span class="hljs-title class_">AudioRendererController</span> | <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>;</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">initAVSession</span>(<span class="hljs-params"></span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'context'</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`session create failed : conext is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererController</span> = <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'audioRendererController'</span>);</li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRendererController</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`session create failed : audioRendererController is undefined`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span> = <span class="hljs-keyword">await</span> avSession.<span class="hljs-title function_">createAVSession</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-string">"PLAY_AUDIO"</span>, <span class="hljs-string">'audio'</span>);</li><li>    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>.<span class="hljs-title function_">activate</span>();</li><li>    <span class="hljs-comment">// ...</span></li><li>  }</li><li>  <span class="hljs-comment">// ...</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L18-L383" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> </li><li>注册播控中心通知回调<div class="p">当用户在锁屏或者其他界面时希望通过播控中心控制应用的播放状态，比如播放、暂停、下一首等，应用需要设置监听回调来对播控中心的通知做出对应的调整，只有设置了回调，播控中心侧的按钮才会亮起来，否则按钮将会置灰。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L157-L168" data-highlighted="yes"><ol class="linenums"><li>async setListenerForMesFromController() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.AVSession) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'play'</span>, <span class="hljs-keyword">this</span>.onPlay);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'pause'</span>, <span class="hljs-keyword">this</span>.onPause);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'playNext'</span>, <span class="hljs-keyword">this</span>.onPlayNext);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'playPrevious'</span>, <span class="hljs-keyword">this</span>.onPlayPrevious);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'seek'</span>, <span class="hljs-keyword">this</span>.onSeek);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'setLoopMode'</span>, <span class="hljs-keyword">this</span>.onSetLoopMode);</li><li>  <span class="hljs-keyword">this</span>.AVSession.on(<span class="hljs-string">'toggleFavorite'</span>, <span class="hljs-keyword">this</span>.onToggleFavorite);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L157-L168" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> <div class="p">适配时需要注意播控中心点击循环模式图标后，应用在回调中只会收到当前播控中心的图标状态，因此开发者需要在业务代码中自己管理状态切换顺序（如：单曲循环-&gt;顺序播放-&gt;随机播放-&gt;单曲循环），根据收到的当前状态指定要切换到的下一个状态。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L219-L240" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> onSetLoopMode: (loopMode: avSession.LoopMode) =&gt; void = (loopMode: avSession.LoopMode) =&gt; {</li><li>  Logger.info(TAG, `on setLoopMode , <span class="hljs-keyword">do</span> loopMode task`);</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.audioRendererController) {</li><li>    Logger.error(TAG, <span class="hljs-string">'audioRendererController is undefined in onSetLoopMode'</span>);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  switch (loopMode) {</li><li>    case avSession.LoopMode.LOOP_MODE_SINGLE:</li><li>      <span class="hljs-keyword">this</span>.audioRendererController.setPlayModel(MusicPlayMode.ORDER);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case avSession.LoopMode.LOOP_MODE_SEQUENCE:</li><li>      <span class="hljs-keyword">this</span>.audioRendererController.setPlayModel(MusicPlayMode.RANDOM);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    case avSession.LoopMode.LOOP_MODE_SHUFFLE:</li><li>      <span class="hljs-keyword">this</span>.audioRendererController.setPlayModel(MusicPlayMode.SINGLE_CYCLE);</li><li>      <span class="hljs-keyword">break</span>;</li><li>    default:</li><li>      <span class="hljs-keyword">break</span>;</li><li>  }</li><li>  <span class="hljs-keyword">this</span>.setPlayModeToAVSession();</li><li>  <span class="hljs-keyword">this</span>.setPlayModeToControlArea();</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L219-L240" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> <div class="p">应用如果已切换到后台，用户点击播控中心，将由播控中心负责拉起应用。应用需要配置参数来选择拉起的应用和页面，并通过setLaunchAbility()方法配置给媒体会话。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L81-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setLaunchAbility</span>() {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.<span class="hljs-variable">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-variable">wantAgentInfo</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">WantAgentInfo</span> = {</li><li>    <span class="hljs-variable">wants</span>: [</li><li>      {</li><li>        <span class="hljs-variable">bundleName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">bundleName</span>,</li><li>        <span class="hljs-variable">abilityName</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">context</span>.<span class="hljs-title class_">abilityInfo</span>.<span class="hljs-title class_">name</span></li><li>      }</li><li>    ],</li><li>    <span class="hljs-variable">operationType</span>: <span class="hljs-title class_">wantAgent</span>.<span class="hljs-title class_">OperationType</span>.<span class="hljs-title class_">START_ABILITIES</span>,</li><li>    <span class="hljs-variable">requestCode</span>: <span class="hljs-number">0</span>,</li><li>    <span class="hljs-variable">wantAgentFlags</span>: [<span class="hljs-variable">wantAgent</span>.<span class="hljs-variable">WantAgentFlags</span>.<span class="hljs-variable">UPDATE_PRESENT_FLAG</span>]</li><li>  };</li><li>  <span class="hljs-variable">wantAgent</span>.<span class="hljs-title function_">getWantAgent</span>(<span class="hljs-variable">wantAgentInfo</span>).<span class="hljs-title function_">then</span>((<span class="hljs-variable">agent</span>) =&gt; {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.<span class="hljs-variable">AVSession</span>) {</li><li>      <span class="hljs-keyword">this</span>.<span class="hljs-variable">AVSession</span>.<span class="hljs-title function_">setLaunchAbility</span>(<span class="hljs-variable">agent</span>);</li><li>    }</li><li>  });</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L81-L101" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> </li><li>应用状态上报播控中心<div class="p">当应用内音频信息发生改变时，如用户手动在应用内操作或应用响应播控中心通知进行调整后，需要向播控中心上报应用中的音频状态数据，播控中心修改界面显示来达到播控中心与应用的状态同步，通过setAVPlaybackState()方法可以上报媒体播放状态，如暂停、播放、进度调整、循环模式、收藏状态等。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L281-L368" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setFavoriteState</span>(<span class="hljs-params">isFavorite: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>.<span class="hljs-title function_">setAVPlaybackState</span>({ isFavorite }, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVPlaybackState BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVPlaybackState successfully'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">setProgressState</span>(<span class="hljs-params">ms: <span class="hljs-built_in">number</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>.<span class="hljs-title function_">setAVPlaybackState</span>({</li><li>      <span class="hljs-attr">position</span>: {</li><li>        <span class="hljs-attr">elapsedTime</span>: ms,</li><li>        <span class="hljs-attr">updateTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">getTime</span>()</li><li>      }</li><li>    }, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVPlaybackState BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVPlaybackState successfully'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-title function_">setPlayState</span>(<span class="hljs-params">isPlay: <span class="hljs-built_in">boolean</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>.<span class="hljs-title function_">setAVPlaybackState</span>({</li><li>      <span class="hljs-attr">state</span>: isPlay ? avSession.<span class="hljs-property">PlaybackState</span>.<span class="hljs-property">PLAYBACK_STATE_PLAY</span> : avSession.<span class="hljs-property">PlaybackState</span>.<span class="hljs-property">PLAYBACK_STATE_PAUSE</span>,</li><li>    }, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVPlaybackState BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVPlaybackState successfully'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setLoopModeState</span>(<span class="hljs-params">AVSessionLoopMode: avSession.LoopMode</span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>) {</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">AVSession</span>.<span class="hljs-title function_">setAVPlaybackState</span>({ <span class="hljs-attr">loopMode</span>: <span class="hljs-title class_">AVSessionLoopMode</span> }, <span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`SetAVPlaybackState BusinessError: code: <span class="hljs-subst">${err.code}</span>, message: <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'SetAVPlaybackState successfully'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L281-L368" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> <div class="p">通过setAVMetadata()方法可以上报媒体会话元数据如标题、歌手、歌词等。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L120-L153" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> async setAVMetadata() {</li><li>  <span class="hljs-keyword">this</span>.musicIndex = AppStorage.<span class="hljs-keyword">get</span>(<span class="hljs-string">'selectIndex'</span>);</li><li>  Logger.info(TAG, <span class="hljs-string">'current musicIndex is:'</span> + <span class="hljs-keyword">this</span>.musicIndex);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.musicIndex === undefined) {</li><li>    <span class="hljs-keyword">this</span>.musicIndex = <span class="hljs-number">0</span>;</li><li>  }</li><li>  <span class="hljs-keyword">try</span> {</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.context) {</li><li>      let mediaImage = await MediaTools.getPixelMapFromResource(<span class="hljs-keyword">this</span>.context,</li><li>        <span class="hljs-keyword">this</span>.songList[<span class="hljs-keyword">this</span>.musicIndex].label <span class="hljs-keyword">as</span> resourceManager.Resource);</li><li>      Logger.info(TAG, <span class="hljs-string">'getPixelMapFromResource success'</span> + JSON.stringify(mediaImage));</li><li>      let metadata: avSession.AVMetadata = {</li><li>        assetId: `${<span class="hljs-keyword">this</span>.musicIndex}`,</li><li>        title: <span class="hljs-keyword">this</span>.songList[<span class="hljs-keyword">this</span>.musicIndex].title,</li><li>        artist: <span class="hljs-keyword">this</span>.songList[<span class="hljs-keyword">this</span>.musicIndex].singer,</li><li>        mediaImage: mediaImage,</li><li>        duration: <span class="hljs-keyword">this</span>.getDuration(),</li><li>      };</li><li>      let lrc = await MediaTools.getLrcFromRawFile(<span class="hljs-keyword">this</span>.context, <span class="hljs-keyword">this</span>.songList[<span class="hljs-keyword">this</span>.musicIndex].lyric);</li><li>      <span class="hljs-keyword">if</span> (lrc) {</li><li>        metadata.lyric = lrc;</li><li>      }</li><li>      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.AVSession) {</li><li>        <span class="hljs-keyword">this</span>.AVSession.setAVMetadata(metadata).then(() =&gt; {</li><li>          Logger.info(TAG, <span class="hljs-string">'SetAVMetadata successfully'</span>);</li><li>        }).<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>          Logger.error(TAG, `SetAVMetadata BusinessError: code: ${err.code}, message: ${err.message}`);</li><li>        });</li><li>      }</li><li>    }</li><li>  } <span class="hljs-keyword">catch</span> (error) {</li><li>    Logger.error(TAG, `SetAVMetadata <span class="hljs-keyword">try</span>: code: ${(error <span class="hljs-keyword">as</span> BusinessError).code}`);</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AVSessionController.ets#L120-L153" target="_blank">AVSessionController.ets</a></div></div></div></div> </div> <div class="p">注意此处上报歌词信息需要获取歌词lrc文件数据，解码成字符串后上传，具体处理如下：<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/MediaTools.ets#L20-L79" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { util } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MediaTools</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-keyword">static</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">getLrcFromRawFile</span>(<span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>, <span class="hljs-attr">filename</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">undefined</span>&gt; {</li><li>    <span class="hljs-keyword">if</span> (!filename) {</li><li>      <span class="hljs-keyword">return</span> <span class="hljs-literal">undefined</span>;</li><li>    }</li><li>    <span class="hljs-keyword">const</span> <span class="hljs-attr">lyricUint8Array</span>: <span class="hljs-title class_">Uint8Array</span> = <span class="hljs-keyword">await</span> context.<span class="hljs-property">resourceManager</span>.<span class="hljs-title function_">getRawFileContent</span>(filename);</li><li>    <span class="hljs-keyword">let</span> textDecoder = util.<span class="hljs-property">TextDecoder</span>.<span class="hljs-title function_">create</span>(<span class="hljs-string">'utf-8'</span>, { <span class="hljs-attr">ignoreBOM</span>: <span class="hljs-literal">true</span> });</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">resStr</span>: <span class="hljs-built_in">string</span> = textDecoder.<span class="hljs-title function_">decodeToString</span>(lyricUint8Array, { <span class="hljs-attr">stream</span>: <span class="hljs-literal">false</span> });</li><li>    <span class="hljs-keyword">return</span> resStr;</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/MediaTools.ets#L20-L79" target="_blank">MediaTools.ets</a></div></div></div></div> </div> <p>适配后效果如图，应用内的歌词、播放进度、收藏状态、循环模式、歌曲信息与播控中心展示状态一致：</p> <p></p> <p><span><img height="547.64346" originheight="923" originwidth="1176" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.95317980594114777918450336550666:50001231000000:2800:0664C738C76BE3E58C77E77E4F0C12EF02083291FC484D0A2BF12098ACEED1D4.png" title="点击放大" width="695.6126100000001"></span></p> </li></ol> <div class="tiledSection"><h3 id="section10270165418229">后台播放音乐<i class="anchor-icon anchor-icon-link" anchorid="section10270165418229" tips="复制节点链接"></i></h3><p>实现播控中心的接入后，解除了必须进入应用才能调整播放状态的限制，但应用退到后台状态后很快就会被挂起，导致歌曲中断。此时在接入AVSession的基础上还需要申请长时任务，保证歌曲能在后台一直保持播放状态，达到连贯的听歌体验，具体实现方式如下：</p> <ol><li>创建后台管理类，使用BackgroundTasksKit的startBackgroundRunning()/stopBackgroundRunning()方法分别申请和取消后台运行任务，长时任务类型选择AUDIO_PLAYBACK，表示音视频后台播放。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/BackgroundUtil.ets#L16-L76" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { wantAgent, common } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { backgroundTaskManager } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BackgroundTasksKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./Logger'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">TAG</span> = <span class="hljs-string">'BackgroundUtil'</span>;</li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BackgroundUtil</span> {</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Start background task.</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">context</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">startContinuousTask</span>(context?: common.<span class="hljs-property">UIAbilityContext</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">if</span> (!context) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'startContinuousTask failed'</span>, <span class="hljs-string">`context undefined`</span>);</li><li>      <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">let</span> <span class="hljs-attr">wantAgentInfo</span>: wantAgent.<span class="hljs-property">WantAgentInfo</span> = {</li><li>      <span class="hljs-attr">wants</span>: [</li><li>        {</li><li>          <span class="hljs-attr">bundleName</span>: context.<span class="hljs-property">abilityInfo</span>.<span class="hljs-property">bundleName</span>,</li><li>          <span class="hljs-attr">abilityName</span>: context.<span class="hljs-property">abilityInfo</span>.<span class="hljs-property">name</span></li><li>        }</li><li>      ],</li><li>      <span class="hljs-attr">operationType</span>: wantAgent.<span class="hljs-property">OperationType</span>.<span class="hljs-property">START_ABILITY</span>,</li><li>      <span class="hljs-attr">requestCode</span>: <span class="hljs-number">0</span>,</li><li>      <span class="hljs-attr">wantAgentFlags</span>: [wantAgent.<span class="hljs-property">WantAgentFlags</span>.<span class="hljs-property">UPDATE_PRESENT_FLAG</span>]</li><li>    };</li><li>
</li><li>    wantAgent.<span class="hljs-title function_">getWantAgent</span>(wantAgentInfo).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">wantAgentObj: <span class="hljs-built_in">Object</span></span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">try</span> {</li><li>        backgroundTaskManager.<span class="hljs-title function_">startBackgroundRunning</span>(context,</li><li>          backgroundTaskManager.<span class="hljs-property">BackgroundMode</span>.<span class="hljs-property">AUDIO_PLAYBACK</span>, wantAgentObj).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'this audioRenderer: '</span>, <span class="hljs-string">'startBackgroundRunning succeeded'</span>);</li><li>        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>          <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'this audioRenderer: '</span>, <span class="hljs-string">`startBackgroundRunning failed Cause: code <span class="hljs-subst">${error.code}</span>`</span>);</li><li>        });</li><li>      } <span class="hljs-keyword">catch</span> (error) {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`startBackgroundRunning failed.message <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-comment">/**</span></li><li><span class="hljs-comment">   * Stop background task.</span></li><li><span class="hljs-comment">   *</span></li><li><span class="hljs-comment">   * <span class="hljs-doctag">@param</span> <span class="hljs-variable">context</span></span></li><li><span class="hljs-comment">   */</span></li><li>  <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title function_">stopContinuousTask</span>(<span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span>): <span class="hljs-built_in">void</span> {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      backgroundTaskManager.<span class="hljs-title function_">stopBackgroundRunning</span>(context).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'this audioRenderer: '</span>, <span class="hljs-string">'stopBackgroundRunning succeeded'</span>);</li><li>      }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'this audioRenderer: '</span>, <span class="hljs-string">`stopBackgroundRunning failed Cause: code <span class="hljs-subst">${error.code}</span>`</span>);</li><li>      });</li><li>    } <span class="hljs-keyword">catch</span> (error) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`stopBackgroundRunning failed. message <span class="hljs-subst">${(error <span class="hljs-keyword">as</span> BusinessError).message}</span>`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/BackgroundUtil.ets#L16-L76" target="_blank">BackgroundUtil.ets</a></div></div></div></div> </li><li>在音乐播放时申请长时任务，达到默认支持后台播放的效果。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-kotlin" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L266-L376" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * Play music by index.</span></li><li><span class="hljs-comment"> *</span></li><li><span class="hljs-comment"> * <span class="hljs-doctag">@param</span> musicIndex</span></li><li><span class="hljs-comment"> */</span></li><li>async play(musicIndex: number = <span class="hljs-keyword">this</span>.musicIndex) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.audioRenderer) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">if</span> (musicIndex &gt;= <span class="hljs-keyword">this</span>.songList.length) {</li><li>    Logger.error(TAG, `current musicIndex ${musicIndex}`);</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  BackgroundUtil.startContinuousTask(<span class="hljs-keyword">this</span>.context);</li><li>  <span class="hljs-keyword">this</span>.updateMusicIndex(musicIndex);</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isFirst) {</li><li>    <span class="hljs-keyword">this</span>.isFirst = <span class="hljs-literal">false</span>;</li><li>    await <span class="hljs-keyword">this</span>.loadSongAssent();</li><li>    await <span class="hljs-keyword">this</span>.stop();</li><li>    await <span class="hljs-keyword">this</span>.start();</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    await <span class="hljs-keyword">this</span>.stop();</li><li>    <span class="hljs-keyword">this</span>.updateIsPlay(<span class="hljs-literal">false</span>);</li><li>    await <span class="hljs-keyword">this</span>.reset();</li><li>  }</li><li>}</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-comment">/**</span></li><li><span class="hljs-comment"> * start music.</span></li><li><span class="hljs-comment"> */</span></li><li><span class="hljs-keyword">public</span> async start() {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.audioRenderer) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      await <span class="hljs-keyword">this</span>.audioRenderer.start().<span class="hljs-keyword">catch</span>((err: BusinessError) =&gt; {</li><li>        Logger.error(TAG, `start failed,code <span class="hljs-keyword">is</span> ${err.code},message <span class="hljs-keyword">is</span> ${err.message}`);</li><li>      })</li><li>      <span class="hljs-keyword">this</span>.updateIsPlay(<span class="hljs-literal">true</span>);</li><li>      BackgroundUtil.startContinuousTask(<span class="hljs-keyword">this</span>.context);</li><li>      Logger.info(TAG, <span class="hljs-string">'start success'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      Logger.error(TAG, `start failed,audioRenderer <span class="hljs-keyword">is</span> undefined`);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L266-L376" target="_blank">AudioRendererController.ets</a></div></div></div></div> </li><li>在音频渲染器释放的时候取消长时任务。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L523-L537" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">release</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>    <span class="hljs-keyword">try</span> {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">release</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>        <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`release failed,code is <span class="hljs-subst">${err.code}</span>,message is <span class="hljs-subst">${err.message}</span>`</span>);</li><li>      })</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-property">avSessionController</span>?.<span class="hljs-title function_">unregisterSessionListener</span>();</li><li>      <span class="hljs-title class_">BackgroundUtil</span>.<span class="hljs-title function_">stopContinuousTask</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'release success'</span>);</li><li>    } <span class="hljs-keyword">catch</span> (e) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`release failed,audioRenderer is undefined`</span>);</li><li>    }</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L523-L537" target="_blank">AudioRendererController.ets</a></div></div></div></div> </li></ol> </div> <div class="tiledSection"><h2 id="section9602351928">与播放设备交互<i class="anchor-icon anchor-icon-link" anchorid="section9602351928" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section59905283238" class="firsth2">播放设备状态发生改变<i class="anchor-icon anchor-icon-link" anchorid="section59905283238" tips="复制节点链接"></i></h3><p>当应用连接的播放设备状态发生改变时，需要及时做出对应的处理，从音频流输出目标的切换、音频播放状态的改变到应用界面的更新，都应该与系统行为以及用户直觉相符，来保证交互体验的一致性，以下分别对各种变更场景给出适配方案：</p> <ol><li>新设备可用<p>新设备上线时，会触发播放设备自动切换，切换的优先级按下图所示，个人类设备高于公共类设备，同一优先级遵循后入优先原则。因此如果一开始通过扬声器播放，接入耳机后会自动切换至耳机播放，无需应用主动切换。</p> <p><span><img height="480.235469" originheight="1024" originwidth="1123" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.04078441094937388746939394190552:50001231000000:2800:B6F01C4D5C9F87B6008FFE3F2DF4F104E3EEA3E029DFBB6B69DD72B5B70AD2ED.png" title="点击放大" width="526.6800000000001"></span></p> <p>应用可以通过监听outputDeviceChangeWithInfo事件来感知外放设备的切换，新设备上线对应的变更原因是AudioStreamDeviceChangeReason.REASON_NEW_DEVICE_AVAILABLE，如上所述这种情况切换到新的设备播放的行为是系统行为，应用不需要主动改变输出设备；如果有特殊业务逻辑如接入新设备时暂停播放或者对新接入设备进行管理等，可在此类回调中进行处理。</p> </li><li>旧设备不可用<div class="p">正在发声的设备不可用后（有线耳机断开、蓝牙开关关闭、蓝牙耳机入盒、多连接耳机被抢占等），应用需要根据使用场景选择暂停播放或使用新设备继续播放。在此列出一些常用类型场景的处理建议，应用可以根据需要做出调整。 <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.12.3.2.1.1.1.3.1.1" valign="top" width="50%"><p>类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.12.3.2.1.1.1.3.1.2" valign="top" width="50%"><p>处理建议</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="50%"><p>游戏场景</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>不进行暂停</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>音乐场景</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>根据回调进行暂停</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>听书场景</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>根据回调进行暂停</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="50%"><p>视频场景</p> </td> <td class="cellrowborder" valign="top" width="50%"><p>根据回调进行暂停</p> </td> </tr>  </tbody></table></div> </div> </div> <p>应用同样可以监听设备变更事件并对AudioStreamDeviceChangeReason.REASON_OLD_DEVICE_UNAVAILABLE的场景进行处理，在回调中根据当前播放设备类型选择后续行为，例如为扬声器时暂停，为其他设备则继续播放。</p> <p>注意具有佩戴检测能力的蓝牙耳机入耳、摘下时会通过播控中心分别对应用发送播放和暂停的通知，应用可以通过监听播控中心指令而非设备变更事件来适配此类操作。</p> </li><li>用户强选<p>当用户通过<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ohos-multimedia-avcastpicker#avcastpicker" target="_blank">投播组件</a>主动切换输出设备时，系统会自动切换到新选择的设备播放音频，应用可以对变更原因为AudioStreamDeviceChangeReason.REASON_OVERRODE的事件处理自己的业务逻辑，接入投播组件可以参考<a href="/consumer/cn/doc/best-practices/bpta-audio-interaction-practice#section17613152517110">主动切换播放设备</a>。</p> </li></ol> <p>示例代码如下，分别对各种类型的设备状态改变事件做出对应的处理：</p> <div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L189-L207" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setOutputDeviceChangeCallback</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'outputDeviceChangeWithInfo'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">outputDeviceChangeCallback</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">outputDeviceChangeCallback</span>: <span class="hljs-function">(<span class="hljs-params">deviceChangeInfo: audio.AudioStreamDeviceChangeInfo</span>) =&gt;</span> <span class="hljs-built_in">void</span> =</li><li>  <span class="hljs-function">(<span class="hljs-params">deviceChangeInfo: audio.AudioStreamDeviceChangeInfo</span>) =&gt;</span> {</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`DeviceInfo id: <span class="hljs-subst">${deviceChangeInfo.devices[<span class="hljs-number">0</span>].id}</span>`</span>);</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`DeviceInfo name: <span class="hljs-subst">${deviceChangeInfo.devices[<span class="hljs-number">0</span>].name}</span>`</span>);</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`DeviceInfo address: <span class="hljs-subst">${deviceChangeInfo.devices[<span class="hljs-number">0</span>].address}</span>`</span>);</li><li>    <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Device change reason: <span class="hljs-subst">${deviceChangeInfo.changeReason}</span>`</span>);</li><li>    <span class="hljs-keyword">if</span> (deviceChangeInfo.<span class="hljs-property">changeReason</span> === audio.<span class="hljs-property">AudioStreamDeviceChangeReason</span>.<span class="hljs-property">REASON_OLD_DEVICE_UNAVAILABLE</span>) {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`Device change reason: <span class="hljs-subst">${deviceChangeInfo.changeReason}</span>`</span>);</li><li>      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pause</span>();</li><li>    }</li><li>  }</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L189-L207" target="_blank">AudioRendererController.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section27081949171019">响应播放设备指令<i class="anchor-icon anchor-icon-link" anchorid="section27081949171019" tips="复制节点链接"></i></h3><p>通过有线耳机、蓝牙耳机实现对音频的播放、暂停、上一首、下一首等基本操作，需要应用接入播控中心，并注册播控命令事件监听，以便响应播控中心下发的命令。应用通过蓝牙耳机发送指令与直接点击播控中心控制音频机制相同，因此接入播控中心监听播控指令即可，具体接入过程可参考<a href="/consumer/cn/doc/best-practices/bpta-audio-interaction-practice#section1245419358228">播控中心控制音乐状态</a>。</p> </div> <div class="tiledSection"><h3 id="section17613152517110">用户主动切换播放设备<i class="anchor-icon anchor-icon-link" anchorid="section17613152517110" tips="复制节点链接"></i></h3></div> <div class="p">应用内可以提供主动切换播放设备的能力，来提升交互的灵活性，此时需要接入AVCastPicker组件，在用户界面点击此投播组件并在弹框中选择目标设备即可切换设备播放，接入指导可参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/distributed-playback-guide" target="_blank">投播组件开发指导</a>。<div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/entry/src/main/ets/components/TopAreaComponent.ets#L17-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">AVCastPicker</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AVSessionKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">SongItem</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ohos/MediaService'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">StyleConstants</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/constants/StyleConstants'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-variable">BreakpointType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../common/utils/BreakpointSystem'</span>;</li><li>
</li><li>@<span class="hljs-title function_">Component</span></li><li><span class="hljs-variable">export</span> <span class="hljs-keyword">struct</span> <span class="hljs-title class_">TopAreaComponent</span> {</li><li>  @<span class="hljs-title function_">StorageProp</span>(<span class="hljs-string">'currentBreakpoint'</span>) <span class="hljs-variable">currentBreakpoint</span>: <span class="hljs-title class_">string</span> = <span class="hljs-string">'sm'</span>;</li><li>  @<span class="hljs-title function_">StorageLink</span>(<span class="hljs-string">'songList'</span>) <span class="hljs-variable">songList</span>: <span class="hljs-title class_">SongItem</span>[] = [];</li><li>  @<span class="hljs-title function_">StorageProp</span>(<span class="hljs-string">'selectIndex'</span>) @<span class="hljs-title function_">Watch</span>(<span class="hljs-string">'getIsDark'</span>) <span class="hljs-variable">selectIndex</span>: <span class="hljs-title class_">number</span> = <span class="hljs-number">0</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">isDark</span>: <span class="hljs-title class_">boolean</span> = <span class="hljs-keyword">true</span>;</li><li>  @<span class="hljs-title function_">State</span> <span class="hljs-variable">color</span>: <span class="hljs-title class_">Color</span> = <span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span></li><li>
</li><li>  <span class="hljs-title function_">getIsDark</span>() {</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">isDark</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">songList</span>[<span class="hljs-keyword">this</span>.<span class="hljs-variable">selectIndex</span>].<span class="hljs-variable">isDarkBackground</span>;</li><li>    <span class="hljs-keyword">this</span>.<span class="hljs-variable">color</span> = <span class="hljs-keyword">this</span>.<span class="hljs-variable">isDark</span> ? <span class="hljs-variable">Color</span>.<span class="hljs-variable">White</span> : <span class="hljs-title class_">Color</span>.<span class="hljs-title class_">Black</span></li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">build</span>() {</li><li>    <span class="hljs-title function_">Row</span>() {</li><li>      <span class="hljs-title function_">AVCastPicker</span>({ <span class="hljs-variable">normalColor</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">color</span>, <span class="hljs-variable">activeColor</span>: <span class="hljs-keyword">this</span>.<span class="hljs-title class_">color</span> })</li><li>        .<span class="hljs-title function_">width</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">BreakpointType</span>({</li><li>          <span class="hljs-variable">sm</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">common_image</span>'),</li><li>          <span class="hljs-variable">md</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">common_image</span>'),</li><li>          <span class="hljs-variable">lg</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">control_image_lg</span>')</li><li>        }).<span class="hljs-title function_">getValue</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentBreakpoint</span>))</li><li>        .<span class="hljs-title function_">height</span>(<span class="hljs-variable">new</span> <span class="hljs-title function_">BreakpointType</span>({</li><li>          <span class="hljs-variable">sm</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">common_image</span>'),</li><li>          <span class="hljs-variable">md</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">common_image</span>'),</li><li>          <span class="hljs-variable">lg</span>: $<span class="hljs-title class_">r</span>('<span class="hljs-title class_">app</span>.<span class="hljs-title class_">float</span>.<span class="hljs-title class_">control_image_lg</span>')</li><li>        }).<span class="hljs-title function_">getValue</span>(<span class="hljs-keyword">this</span>.<span class="hljs-variable">currentBreakpoint</span>))</li><li>    }</li><li>    .<span class="hljs-title function_">height</span>($<span class="hljs-title function_">r</span>(<span class="hljs-string">'app.float.info_margin_top_sm'</span>))</li><li>    .<span class="hljs-title function_">width</span>(<span class="hljs-variable">StyleConstants</span>.<span class="hljs-variable">FULL_WIDTH</span>)</li><li>    .<span class="hljs-title function_">justifyContent</span>(<span class="hljs-variable">FlexAlign</span>.<span class="hljs-variable">End</span>)</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/entry/src/main/ets/components/TopAreaComponent.ets#L17-L53" target="_blank">TopAreaComponent.ets</a></div></div></div></div> </div> <p>将投播组件布局在页面的合理位置，点击选择音频输出设备，如图所示可以从本机扬声器切换到已连接的蓝牙耳机：</p> <p><span><img height="550.3407000000001" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163038.50313832927410264964310557587489:50001231000000:2800:799666EE85C225219C494ACEB9CB9AFAE1FDAC5E6258F83755FBAA35AC7BE1EC.gif" title="点击放大" width="266"></span></p> <div class="tiledSection"><h2 id="section717172111420">与其他应用交互<i class="anchor-icon anchor-icon-link" anchorid="section717172111420" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section1039664718231" class="firsth2">与其他应用音频冲突<i class="anchor-icon anchor-icon-link" anchorid="section1039664718231" tips="复制节点链接"></i></h3></div> <p>当与其他应用的音频发生冲突，多个音频流同时播放时，系统预设了音频打断策略，对多音频的并发进行管控，只有持有音频焦点的音频流才可以正常播放，避免多个音频流无序并发播放的现象出现。为了维持应用和系统的状态一致性，保证符合用户直觉的交互体验，推荐应用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency#处理音频焦点变化" target="_blank">处理音频焦点变化</a>，并在收到音频打断事件（<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-i#interruptevent9" target="_blank">InterruptEvent</a>）时做出相应处理。对于音乐类应用，被各种<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback-concurrency#处理音频焦点变化" target="_blank">处理音频焦点变化</a>类型的其他应用音频打断场景和效果如下表所示：</p>  <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.1" valign="top" width="18.9%"><p>先播应用音频类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.2" valign="top" width="39.489999999999995%"><p>后播应用音频类型</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.21.1.4.1.3" valign="top" width="41.61%"><p>打断效果</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" rowspan="13" valign="top" width="18.9%"><p>音乐</p> </td> <td class="cellrowborder" valign="top" width="39.489999999999995%"><p>闹钟</p> </td> <td class="cellrowborder" rowspan="6" valign="top" width="41.61%"><p>后播应用播放时，先播应用暂停播放；后播应用停止播放后，先播应用恢复播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>电话</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>铃声</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>VOIP 铃声(全屏呼叫/呼叫页面/横幅呼叫)</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>VOIP 通话</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>VOIP MESSAGE(微信语音/畅联)</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>导航</p> </td> <td class="cellrowborder" rowspan="3" valign="top"><p>后播应用播放时，先播应用降低音量持续播放；后播应用停止播放后，先播应用恢复音量继续播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>TextReader控件朗读语音</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>语音助手类短语音</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>音乐</p> </td> <td class="cellrowborder" rowspan="2" valign="top"><p>后播应用播放时，先播应用停止播放；后播应用停止播放后，先播应用不再恢复播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>视频</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>游戏</p> </td> <td class="cellrowborder" rowspan="2" valign="top"><p>先播、后播应用并发混音播放</p> </td> </tr> <tr><td class="cellrowborder" valign="top"><p>系统音效(锁屏/按键)</p> </td> </tr>  </tbody></table></div> </div> <p>如表所示，根据应用打断效果主要可以分为四个类型：暂停后恢复、降低音量后恢复、停止后不恢复和并发播放，以下分别对这四类场景给出适配方案：</p> <ol><li>暂停后恢复场景<p>后播音频类型为闹钟/电话/铃声/VOIP音频时，先播音频暂停播放；待后播音频播放完毕后，先播音频恢复播放。应用可以注册焦点事件监听，当此类打断事件发生时，系统会自动暂停先播音频，应用侧会接收到INTERRUPT_HINT_PAUSE事件，此时只需更新播放和UI界面状态为暂停态即可，不需要主动停止音频流。当后播音频结束后，应用接收到INTERRUPT_HINT_RESUME事件，此时系统不会主动继续播放先播音频，应用需主动调用播放方法续播音频流。</p> </li><li>降低音量后恢复场景<p>当后播应用音频类型为导航/TextReader语音/语音助手类语音播报时，先播音频应降低音量持续播放；后播音频播报结束后，先播音频恢复音量继续播放。注意此类打断事件的音量降低/恢复行为是系统行为，应用无需主动调整音量。在降低音量和恢复时会分别收到INTERRUPT_HINT_DUCK和INTERRUPT_HINT_UNDUCK回调，应用可以在回调中按需更新页面状态或处理其他业务逻辑。</p> </li><li>停止后不恢复场景<p>当后播应用音频类型为音乐/视频时，音乐终止播放；后播音频停止后，音乐不恢复播放。应用可以注册焦点事件监听，接收到INTERRUPT_HINT_STOP事件时，停止音乐播放，并更新UI界面。</p> </li><li>并发场景<ul><li>当后播应用音频类型为游戏或系统提示音（锁屏、按键）时，先播音频不停止，与后播音频混音并发播放。此行为是系统默认行为，应用侧不需要适配。</li><li>如果是音乐音频于后台播放，前台音视频静音并发播放的场景，则需要前台应用使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiorenderer#setsilentmodeandmixwithothers12" target="_blank">setSilentModeAndMixWithOthers</a>接口开启静音并发模式，否则系统会根据音频流类型默认触发对应打断场景。当前台音视频取消静音播放时，setSilentModeAndMixWithOthers()接口关闭静音并发模式，同时使用<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/arkts-apis-audio-audiosessionmanager#activateaudiosession12" target="_blank">activateAudioSession</a>激活音频会话（AudioSession）并指定音频会话策略为暂停模式（CONCURRENCY_PAUSE_OTHERS），使后台音频处于暂停模式。当前台音频暂停后，再次开启静音并发模式时，可以使后台音频恢复播放。</li></ul> </li></ol> <p>综上四种情况，在audioRenderer.on('audioInterrupt')回调中分别对各种打断类型场景做出对应处理，并实现静音播放接口及设置音频会话策略为暂停模式，示例代码实现如下：</p> <div class="screenLinkPre"><div _ngcontent-ofq-c106="" class="highlight-div"><div _ngcontent-ofq-c106="" class="highlight-div-header"><div _ngcontent-ofq-c106="" class="highlight-div-header-left"><div _ngcontent-ofq-c106="" class="handle-button expand-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-ofq-c106="" class="highlight-div-header-right"><div _ngcontent-ofq-c106="" class="handle-button ai-button"></div><div _ngcontent-ofq-c106="" class="handle-button line-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-ofq-c106="" class="handle-button theme-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-ofq-c106="" class="handle-button copy-button"><div _ngcontent-ofq-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-ofq-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-typescript" codehub="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L151-L262" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">private</span> <span class="hljs-title function_">setInterruptCallback</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">on</span>(<span class="hljs-string">'audioInterrupt'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">interruptCallback</span>);</li><li>}</li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-attr">interruptCallback</span>: <span class="hljs-function">(<span class="hljs-params">interruptEvent: audio.InterruptEvent</span>) =&gt;</span> <span class="hljs-built_in">void</span> =</li><li>  <span class="hljs-function">(<span class="hljs-params">interruptEvent: audio.InterruptEvent</span>) =&gt;</span> {</li><li>    <span class="hljs-keyword">if</span> (interruptEvent.<span class="hljs-property">forceType</span> === audio.<span class="hljs-property">InterruptForceType</span>.<span class="hljs-property">INTERRUPT_FORCE</span>) {</li><li>      <span class="hljs-keyword">switch</span> (interruptEvent.<span class="hljs-property">hintType</span>) {</li><li>        <span class="hljs-keyword">case</span> audio.<span class="hljs-property">InterruptHint</span>.<span class="hljs-property">INTERRUPT_HINT_PAUSE</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateIsPlay</span>(<span class="hljs-literal">false</span>);</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> audio.<span class="hljs-property">InterruptHint</span>.<span class="hljs-property">INTERRUPT_HINT_STOP</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">updateIsPlay</span>(<span class="hljs-literal">false</span>);</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">pause</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> audio.<span class="hljs-property">InterruptHint</span>.<span class="hljs-property">INTERRUPT_HINT_DUCK</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-keyword">case</span> audio.<span class="hljs-property">InterruptHint</span>.<span class="hljs-property">INTERRUPT_HINT_UNDUCK</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (interruptEvent.<span class="hljs-property">forceType</span> === audio.<span class="hljs-property">InterruptForceType</span>.<span class="hljs-property">INTERRUPT_SHARE</span>) {</li><li>      <span class="hljs-keyword">switch</span> (interruptEvent.<span class="hljs-property">hintType</span>) {</li><li>        <span class="hljs-keyword">case</span> audio.<span class="hljs-property">InterruptHint</span>.<span class="hljs-property">INTERRUPT_HINT_RESUME</span>:</li><li>          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">start</span>();</li><li>          <span class="hljs-keyword">break</span>;</li><li>        <span class="hljs-attr">default</span>:</li><li>          <span class="hljs-keyword">break</span>;</li><li>      }</li><li>    }</li><li>  }</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setSilentModeAndMixWithOthersFromPrefer</span>(<span class="hljs-params"></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">formIds</span>: <span class="hljs-built_in">string</span>[] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getFormIds</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>  <span class="hljs-keyword">let</span> isSupportSilent = <span class="hljs-literal">false</span>;</li><li>  <span class="hljs-keyword">if</span> (formIds.<span class="hljs-title function_">includes</span>(<span class="hljs-variable constant_">SILENT_ID</span>)) {</li><li>    isSupportSilent = <span class="hljs-literal">true</span>;</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    isSupportSilent = <span class="hljs-literal">false</span>;</li><li>  }</li><li>  <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isSilentMode'</span>, isSupportSilent);</li><li>  <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">setSilentModeAndMixWithOthers</span>(isSupportSilent);</li><li>}</li><li>
</li><li><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">setSilentModeAndMixWithOthers</span>(<span class="hljs-params">isSupportSilent: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span></span>) {</li><li>  <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>) {</li><li>    <span class="hljs-keyword">return</span>;</li><li>  }</li><li>  <span class="hljs-keyword">let</span> audioManger = audio.<span class="hljs-title function_">getAudioManager</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">audioSessionManager</span>: audio.<span class="hljs-property">AudioSessionManager</span> = audioManger.<span class="hljs-title function_">getSessionManager</span>();</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">strategy</span>: audio.<span class="hljs-property">AudioSessionStrategy</span> = {</li><li>    <span class="hljs-attr">concurrencyMode</span>: audio.<span class="hljs-property">AudioConcurrencyMode</span>.<span class="hljs-property">CONCURRENCY_PAUSE_OTHERS</span></li><li>  };</li><li>
</li><li>  <span class="hljs-keyword">let</span> <span class="hljs-attr">formIds</span>: <span class="hljs-built_in">string</span>[] = <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">getFormIds</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>);</li><li>  <span class="hljs-keyword">if</span> (isSupportSilent) {</li><li>    <span class="hljs-keyword">if</span> (!formIds.<span class="hljs-title function_">includes</span>(<span class="hljs-variable constant_">SILENT_ID</span>)) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">addFormId</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable constant_">SILENT_ID</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">setSilentModeAndMixWithOthers</span>(isSupportSilent);</li><li>    <span class="hljs-comment">// After using AudioSession, the system sends INTERRUPT_INT-REUME to the previously interrupted audio stream.</span></li><li>    audioSessionManager.<span class="hljs-title function_">deactivateAudioSession</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'deactivateAudioSession SUCCESS'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li>    });</li><li>  } <span class="hljs-keyword">else</span> {</li><li>    <span class="hljs-comment">// AudioSession needs to be activated first, and then unmute.</span></li><li>    audioSessionManager.<span class="hljs-title function_">activateAudioSession</span>(strategy).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">'activateAudioSession SUCCESS'</span>);</li><li>    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {</li><li>      <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">error</span>(<span class="hljs-variable constant_">TAG</span>, <span class="hljs-string">`ERROR: <span class="hljs-subst">${err}</span>`</span>);</li><li>    });</li><li>    <span class="hljs-keyword">if</span> (formIds.<span class="hljs-title function_">includes</span>(<span class="hljs-variable constant_">SILENT_ID</span>)) {</li><li>      <span class="hljs-keyword">await</span> <span class="hljs-title class_">PreferencesUtil</span>.<span class="hljs-title function_">getInstance</span>().<span class="hljs-title function_">removeFormId</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">context</span>, <span class="hljs-variable constant_">SILENT_ID</span>);</li><li>    }</li><li>    <span class="hljs-variable language_">this</span>.<span class="hljs-property">audioRenderer</span>.<span class="hljs-title function_">setSilentModeAndMixWithOthers</span>(isSupportSilent);</li><li>  }</li><li>  <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'isSilentMode'</span>, isSupportSilent);</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/audio-interaction/blob/master/MediaService/src/main/ets/utils/AudioRendererController.ets#L151-L262" target="_blank">AudioRendererController.ets</a></div></div></div></div> <div class="tiledSection"><h3 id="section132081237141816">检测应用音频冲突适配完整性<i class="anchor-icon anchor-icon-link" anchorid="section132081237141816" tips="复制节点链接"></i></h3><p><a href="https://gitee.com/harmonyos_samples/HMMediaDiagnosticsTool" target="_blank">这里</a>提供了一个音频检测应用，开发者可以用来检测自己开发的音频应用在不同场景下的功能完备度和准确性等，帮助开发者修复音频焦点类的应用功能问题。</p> </div> <div class="tiledSection"><h2 id="section17392182619572">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section17392182619572" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/audio-interaction" target="_blank">基于AudioRenderer的音频播控和多场景交互</a></li></ul> </div> </div> <div></div></div>