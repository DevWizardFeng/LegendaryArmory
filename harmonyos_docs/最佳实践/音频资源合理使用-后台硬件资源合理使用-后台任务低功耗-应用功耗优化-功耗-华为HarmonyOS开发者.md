<h1 _ngcontent-nag-c119="" class="doc-title ng-star-inserted" title="音频资源合理使用"> 音频资源合理使用 </h1>

<div _ngcontent-nag-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><p>无长时任务的应用退到后台时，禁止使用麦克风和扬声器。</p> <div class="tiledSection"><h2 id="section20669262229">约束<i class="anchor-icon anchor-icon-link" anchorid="section20669262229" tips="复制节点链接"></i></h2><p>NA</p> </div> <div class="tiledSection"><h2 id="section964013428226">示例<i class="anchor-icon anchor-icon-link" anchorid="section964013428226" tips="复制节点链接"></i></h2></div> <div class="tiledSection"><h3 id="section7717642134215" class="firsth2">播音场景（audioRenderer）<i class="anchor-icon anchor-icon-link" anchorid="section7717642134215" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AudioRenderer.ets#L7-L51" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>
</li><li>  <span class="hljs-comment">// Create an AudioRenderer based on the service requirements at the foreground</span></li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-keyword">void</span> {</li><li>    audio.<span class="hljs-title function_">createAudioRenderer</span>(audioRendererOptions, (<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {}));</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">// Return to the background to stop or pause</span></li><li>    audioRenderer.<span class="hljs-title function_">stop</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {});</li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AudioRenderer.ets#L7-L51" target="_blank">AudioRenderer.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section166941764441">播音场景（AVPlayer）<i class="anchor-icon anchor-icon-link" anchorid="section166941764441" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AvPlayer.ets#L9-L26" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li>
</li><li><span class="hljs-comment">// ...</span></li><li>
</li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">//Playing according to service requirements in the foreground</span></li><li>    avPlayer.<span class="hljs-title function_">play</span>();</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">// Return to the background to stop playing or pause</span></li><li>    avPlayer.<span class="hljs-title function_">stop</span>(); <span class="hljs-comment">// Or pause();</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AvPlayer.ets#L9-L26" target="_blank">AvPlayer.ets</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section196383162445">播音场景（OpenSL ES）<i class="anchor-icon anchor-icon-link" anchorid="section196383162445" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/OpenSL.cpp#L7-L14" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//The foreground scene starts to play</span></li><li><span class="hljs-variable">SLPlayItfplayItf</span>=<span class="hljs-variable">nullptr</span>;</li><li>(*<span class="hljs-variable">pcmPlayerObject</span>)-&gt;<span class="hljs-title class_">GetInterface</span>(<span class="hljs-title class_">pcmPlayerObject</span>,<span class="hljs-title class_">SL_IID_PLAY</span>,&amp;<span class="hljs-title class_">playItf</span>);</li><li>(*<span class="hljs-variable">playItf</span>)-&gt;<span class="hljs-title class_">SetPlayState</span>(<span class="hljs-title class_">playItf</span>,<span class="hljs-title class_">SL_PLAYSTATE_PLAYING</span>);</li><li><span class="hljs-comment">// Stop playing the background scene</span></li><li>(*<span class="hljs-variable">playItf</span>)-&gt;<span class="hljs-title class_">SetPlayState</span>(<span class="hljs-title class_">playItf</span>,<span class="hljs-title class_">SL_PLAYSTATE_STOPPED</span>);</li><li>(*<span class="hljs-variable">pcmPlayerObject</span>)-&gt;<span class="hljs-title class_">Destroy</span>(<span class="hljs-title class_">pcmPlayerObject</span>);</li><li>(*<span class="hljs-variable">engineObject</span>)-&gt;<span class="hljs-title class_">Destroy</span>(<span class="hljs-title class_">engineObject</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/OpenSL.cpp#L7-L14" target="_blank">OpenSL.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section692843618449">播音场景（OHAudio）<i class="anchor-icon anchor-icon-link" anchorid="section692843618449" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/OpenSL.cpp#L23-L30" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">//Construct the audio stream to play</span></li><li><span class="hljs-variable">OH_AudioRenderer</span>*<span class="hljs-variable">audioRenderer</span>;</li><li><span class="hljs-variable">ret</span>=<span class="hljs-title function_">OH_AudioStreamBuilder_GenerateRenderer</span>(<span class="hljs-variable">builder</span>,&amp;<span class="hljs-title class_">audioRenderer</span>);</li><li>
</li><li><span class="hljs-comment">//The foreground scene starts to play</span></li><li><span class="hljs-variable">ret</span>=<span class="hljs-title function_">OH_AudioRenderer_Start</span>(<span class="hljs-variable">audioRenderer</span>);</li><li><span class="hljs-comment">// Stop playing the background scene</span></li><li><span class="hljs-variable">ret</span>=<span class="hljs-title function_">OH_AudioRenderer_Stop</span>(<span class="hljs-variable">audioRenderer</span>);</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/OpenSL.cpp#L23-L30" target="_blank">OpenSL.cpp</a></div></div></div></div> </div> <div class="tiledSection"><h3 id="section4798174854416">播音场景（SoundPool）<i class="anchor-icon anchor-icon-link" anchorid="section4798174854416" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AvPlayer.ets#L6-L53" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { fileIo <span class="hljs-keyword">as</span> fs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;</li><li><span class="hljs-keyword">import</span> { media } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.MediaKit'</span>;</li><li>
</li><li><span class="hljs-keyword">const</span> <span class="hljs-title function_">SoundPool</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"></span>) =&gt; {</li><li>
</li><li>  <span class="hljs-comment">//Construct the audio stream to play</span></li><li>  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">open</span>(<span class="hljs-string">'/test_01.mp3'</span>, fs.<span class="hljs-property">OpenMode</span>.<span class="hljs-property">READ_ONLY</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">file: fs.File</span>) =&gt;</span> {</li><li>    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">"filefd:"</span> + file.<span class="hljs-property">fd</span>);</li><li>    uri = <span class="hljs-string">'fd://'</span> + (file.<span class="hljs-property">fd</span>).<span class="hljs-title function_">toString</span>()</li><li>  }); <span class="hljs-comment">// '/test_01.mp3' is used as an example. The path of the file needs to be transferred</span></li><li>  soundId = <span class="hljs-keyword">await</span> soundPool.<span class="hljs-title function_">load</span>(uri);</li><li>  <span class="hljs-comment">//The foreground scene starts to play</span></li><li>  streamId = <span class="hljs-keyword">await</span> soundPool.<span class="hljs-title function_">play</span>(soundId);</li><li>  <span class="hljs-comment">//Stop playing in the background scenario: soundPool.stop (streamId);</span></li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/AvPlayer.ets#L6-L53" target="_blank">AvPlayer.ets</a></div></div></div></div> <p>有关音频播放开发相关接口的使用，详情可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-playback" target="_blank">音频播放</a>。</p> </div> <div class="tiledSection"><h3 id="section1357126154814">录音场景<i class="anchor-icon anchor-icon-link" anchorid="section1357126154814" tips="复制节点链接"></i></h3><div class="screenLinkPre"><div _ngcontent-nag-c106="" class="highlight-div"><div _ngcontent-nag-c106="" class="highlight-div-header"><div _ngcontent-nag-c106="" class="highlight-div-header-left"><div _ngcontent-nag-c106="" class="handle-button expand-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-nag-c106="" class="highlight-div-header-right"><div _ngcontent-nag-c106="" class="handle-button ai-button"></div><div _ngcontent-nag-c106="" class="handle-button line-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-nag-c106="" class="handle-button theme-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-nag-c106="" class="handle-button copy-button"><div _ngcontent-nag-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-nag-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-javascript" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/Recording.ets#L7-L57" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">UIAbility</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;</li><li><span class="hljs-keyword">import</span> { <span class="hljs-title class_">BusinessError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.BasicServicesKit'</span>;</li><li><span class="hljs-keyword">import</span> { audio } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AudioKit'</span>;</li><li><span class="hljs-comment">// ...</span></li><li><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {</li><li>  <span class="hljs-comment">// ...</span></li><li>
</li><li>  <span class="hljs-title function_">onForeground</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">//Apply for the resources required by the system, or reapply for the resources released in onBackground ()</span></li><li>    audio.<span class="hljs-title function_">createAudioCapturer</span>(audioCapturerOptions, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {</li><li>      <span class="hljs-keyword">if</span> (err) {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`InvokecreateAudioCapturerfailed,codeis<span class="hljs-subst">${err.code}</span>,messageis<span class="hljs-subst">${err.message}</span>`</span>);</li><li>      } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">info</span>(<span class="hljs-string">'InvokecreateAudioCapturersucceeded.'</span>);</li><li>      }</li><li>    });</li><li>  }</li><li>
</li><li>  <span class="hljs-title function_">onBackground</span>(): <span class="hljs-keyword">void</span> {</li><li>    <span class="hljs-comment">//Release resources when the UI is invisible</span></li><li>    audioCapturer.<span class="hljs-title function_">stop</span>(<span class="hljs-function">(<span class="hljs-params">err: BusinessError</span>) =&gt;</span> {});</li><li>    <span class="hljs-comment">//Or pause();</span></li><li>  }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/BptaUseResources/entry/src/main/ets/pages/music/Recording.ets#L7-L57" target="_blank">Recording.ets</a></div></div></div></div> </div> <p>有关音频录制开发相关接口的使用，详情可以参考<a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/audio-recording" target="_blank">音频录制</a>。</p> </div> <div></div></div>