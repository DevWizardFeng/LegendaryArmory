<h1 _ngcontent-foc-c119="" class="doc-title ng-star-inserted" title="高负载场景线程优先级设置"> 高负载场景线程优先级设置 </h1>

<div _ngcontent-foc-c106="" auitextselectionexpansion="" class="markdown-body ng-star-inserted" style="position: relative;"> <div><div class="tiledSection"><h2 id="section104mcpsimp">概述<i class="anchor-icon anchor-icon-link" anchorid="section104mcpsimp" tips="复制节点链接"></i></h2><p>在现代软件开发中，多线程或多进程的并发处理已成为常态。在多线程环境中，不同线程执行的任务可能具有不同的重要性和紧急程度。<span style="color: rgb(64,64,64);">在高负载情况下，系统资源（如CPU时间）变得尤为宝贵，此时若关键线程（例如UI渲染线程）因频繁被非关键线程抢占而无法获得足够的连续执行时间和资源保障，可能会导致画面卡顿、延迟等问题，从而严重影响用户体验。</span></p> </div> <div class="tiledSection"><h2 id="section107mcpsimp">解决思路<i class="anchor-icon anchor-icon-link" anchorid="section107mcpsimp" tips="复制节点链接"></i></h2><p>在负载较重的时候，为了让关键的任务能够拿到足够的资源，系统会依据任务的重要性，给任务分配相应的时间片，重要性越高的任务，可以分配到越多的时间片。那么开发者在可以识别自己应用中的关键线程的情况下，针对各个线程的任务紧急程度，给予关键线程相对较高的QoS等级以防止被其他线程打断，从而保证应用的流畅运行和更好的用户体验。</p> </div> <div class="tiledSection"><h3 id="section110mcpsimp" class="firsth2">QoS<i class="anchor-icon anchor-icon-link" anchorid="section110mcpsimp" tips="复制节点链接"></i></h3><p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/qos-guidelines" target="_blank">服务质量（QoS）</a>一文介绍了QoS的基本概念、原理、各个QoS等级适用的场景及负载特征及相关接口的用法。</p> <p>在操作系统层面，QoS等级是一种用于区分不同线程优先级和服务质量的技术。通常系统会自动识别主线程，并在前台焦点情况下为其配置高于开放给应用开发者调用的QoS等级，以确保其优先执行。</p> <p>与ArkTS端 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-taskpool#priority" target="_blank">taskpool.Priority</a> 的线程优先级类似，QoS提供的优先级等级也都会相对应的映射到内核的优先级上。不过QoS提供的等级更多，自适应调度策略更强，它们属于两套不同的逻辑。</p> <p><a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-overview" target="_blank">FFRT（Function Flow运行时）</a>的QoS提供了ffrt_qos_inherit（-1）到ffrt_qos_user_initiated（3）5个优先等级，它与当前的QoS接口有着同一套底层逻辑。'两者的差别在于，当前开发所用的QoS接口是直接开放给应用线程的，而FFRT的QoS则是面向任务的优先级配置，关于线程编程模型和任务编程模型的对比详见 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/ffrt-overview" target="_blank">FFRT 概述</a> 。</p> </div> <div class="tiledSection"><h2 id="section119mcpsimp">场景示例<i class="anchor-icon anchor-icon-link" anchorid="section119mcpsimp" tips="复制节点链接"></i></h2><p>下面是一个在高负载情况下，配置了不同QoS等级的两个关键线程完成相同计算任务所花时间的对比图，从界面的运行结果可以看到在高负载情况下，配置了高优先级的线程执行完计算所花的时间更少一些。</p> <p><span><img height="550.3407000000001" originheight="720" originwidth="348" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.46229011561751944172537817908711:50001231000000:2800:517ABBD82FF93EC2830D4B4BFDC54FEC6330DD5854FDD65EC8F80C5B06474065.gif" title="点击放大" width="266"></span></p> <p>具体实现步骤如下：</p> <p>1、实现负载线程所要完成的任务。</p> <div class="screenLinkPre"><div _ngcontent-foc-c106="" class="highlight-div"><div _ngcontent-foc-c106="" class="highlight-div-header"><div _ngcontent-foc-c106="" class="highlight-div-header-left"><div _ngcontent-foc-c106="" class="handle-button expand-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-foc-c106="" class="highlight-div-header-right"><div _ngcontent-foc-c106="" class="handle-button ai-button"></div><div _ngcontent-foc-c106="" class="handle-button line-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-foc-c106="" class="handle-button theme-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-foc-c106="" class="handle-button copy-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-foc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L105-L135" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// the Load task</span></li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AddLoads</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (!n) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"invalid input."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// set QoS level</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_QoS_SetThreadQoS</span>(QoS_Level::QOS_BACKGROUND);</li><li>    <span class="hljs-keyword">if</span> (ret) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"set load thread QoS level failed."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// bind cpu</span></li><li>    <span class="hljs-type">cpu_set_t</span> mask;</li><li>    <span class="hljs-built_in">CPU_SET</span>(*g_affinity, &amp;mask);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_setaffinity</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"bind load thread failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-comment">// Perform load calculation</span></li><li>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; BOUND; i++) {</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> j = <span class="hljs-number">0</span>; j &lt; BOUND; j++) {</li><li>            <span class="hljs-type">int</span> x = (i + j) - n;</li><li>            <span class="hljs-built_in">printf</span>(<span class="hljs-string">"%d"</span>, x);</li><li>        }</li><li>    }</li><li>    <span class="hljs-comment">// reset load flag</span></li><li>    g_addLoad = <span class="hljs-literal">false</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L105-L135" target="_blank">main.cpp</a></div></div></div></div> <p>2、实现高、低QoS等级计算线程（关键线程）所要完成的计算任务（斐波那契数列计算）。先通过 <a href="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/qos-guidelines#oh_qos_setthreadqos" target="_blank">OH_QoS_SetThreadQoS</a> 接口设置当前线程的QoS等级，再执行 DoFib() 斐波那契数列计算。</p> <div class="screenLinkPre"><div _ngcontent-foc-c106="" class="highlight-div"><div _ngcontent-foc-c106="" class="highlight-div-header"><div _ngcontent-foc-c106="" class="highlight-div-header-left"><div _ngcontent-foc-c106="" class="handle-button expand-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-foc-c106="" class="highlight-div-header-right"><div _ngcontent-foc-c106="" class="handle-button ai-button"></div><div _ngcontent-foc-c106="" class="handle-button line-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-foc-c106="" class="handle-button theme-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-foc-c106="" class="handle-button copy-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-foc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cpp" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L37-L101" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-comment">// Perform Fibonacci sequence calculations</span></li><li><span class="hljs-function"><span class="hljs-type">long</span> <span class="hljs-type">long</span> <span class="hljs-title">DoFib</span><span class="hljs-params">(<span class="hljs-type">double</span> n)</span> </span>{</li><li>    <span class="hljs-keyword">if</span> (n == ONE) {</li><li>        <span class="hljs-keyword">return</span> ONE;</li><li>    }</li><li>    <span class="hljs-keyword">if</span> (n == TWO) {</li><li>        <span class="hljs-keyword">return</span> TWO;</li><li>    }</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-built_in">DoFib</span>(n - ONE) + <span class="hljs-built_in">DoFib</span>(n - TWO);</li><li>}</li><li>
</li><li><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetQoS</span><span class="hljs-params">(QoS_Level level)</span> </span>{</li><li>    <span class="hljs-comment">// set QoS level</span></li><li>    <span class="hljs-type">int</span> ret = <span class="hljs-built_in">OH_QoS_SetThreadQoS</span>(level);</li><li>    <span class="hljs-keyword">if</span> (!ret) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"set qos level success."</span>);</li><li>        <span class="hljs-comment">//  query qos level</span></li><li>        QoS_Level queryLevel = QOS_DEFAULT;</li><li>        ret = <span class="hljs-built_in">OH_QoS_GetThreadQoS</span>(&amp;queryLevel);</li><li>        <span class="hljs-keyword">if</span> (!ret) {</li><li>            <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"the qos level of current thread : %{public}d"</span>,</li><li>                         queryLevel);</li><li>        } <span class="hljs-keyword">else</span> {</li><li>            <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"get qos level failed."</span>);</li><li>            <span class="hljs-keyword">return</span>;</li><li>        }</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"get level qos failed!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// bind cpu</span></li><li>    <span class="hljs-type">cpu_set_t</span> mask;</li><li>    <span class="hljs-built_in">CPU_SET</span>(*g_affinity, &amp;mask);</li><li>    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">sched_setaffinity</span>(<span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(mask), &amp;mask) != <span class="hljs-number">0</span>) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"bind qos thread failed"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>    <span class="hljs-keyword">auto</span> startTime = std::chrono::system_clock::<span class="hljs-built_in">now</span>();</li><li>    <span class="hljs-comment">// Execute computational tasks</span></li><li>    <span class="hljs-type">long</span> <span class="hljs-type">long</span> res = <span class="hljs-built_in">DoFib</span>(DEPTH);</li><li>    <span class="hljs-keyword">auto</span> endTime = std::chrono::system_clock::<span class="hljs-built_in">now</span>();</li><li>    g_durationTime = std::chrono::<span class="hljs-built_in">duration</span>&lt;<span class="hljs-type">double</span>, std::milli&gt;(endTime - startTime).<span class="hljs-built_in">count</span>();</li><li>    <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"calculate res is: %{public}llu"</span>, res);</li><li>
</li><li>    <span class="hljs-comment">// Reset QoS level</span></li><li>    ret = <span class="hljs-built_in">OH_QoS_ResetThreadQoS</span>();</li><li>    <span class="hljs-keyword">if</span> (!ret) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"reset qos level success."</span>);</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"reset qos level failed!"</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// after reset QoS, query QoS again will fail</span></li><li>    QoS_Level queryLevelTwo;</li><li>    ret = <span class="hljs-built_in">OH_QoS_GetThreadQoS</span>(&amp;queryLevelTwo);</li><li>    <span class="hljs-keyword">if</span> (!ret) {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_INFO, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"the qos level after: %{public}d"</span>, queryLevelTwo);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    } <span class="hljs-keyword">else</span> {</li><li>        <span class="hljs-built_in">OH_LOG_Print</span>(LOG_APP, LOG_ERROR, LOG_PRINT_DOMAIN, <span class="hljs-string">"QoS"</span>, <span class="hljs-string">"query qos level failed after reset."</span>);</li><li>        <span class="hljs-keyword">return</span>;</li><li>    }</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L37-L101" target="_blank">main.cpp</a></div></div></div></div> <p>3、然后分别将计算线程（关键线程）设置低、高QoS等级来对比两者在相同的高负载情况下完成相同层级的斐波那契数列计算所花时间。</p> <ul><li><strong>给计算线程配置低QoS等级</strong><div class="screenLinkPre"><div _ngcontent-foc-c106="" class="highlight-div"><div _ngcontent-foc-c106="" class="highlight-div-header"><div _ngcontent-foc-c106="" class="highlight-div-header-left"><div _ngcontent-foc-c106="" class="handle-button expand-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-foc-c106="" class="highlight-div-header-right"><div _ngcontent-foc-c106="" class="handle-button ai-button"></div><div _ngcontent-foc-c106="" class="handle-button line-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-foc-c106="" class="handle-button theme-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-foc-c106="" class="handle-button copy-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-foc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L164-L186" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">lowQoSCalculate</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">g_durationTime</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// Simulate system load</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">g_addLoad</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt; <span class="hljs-title class_">loadThreads</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">TASKS</span>; <span class="hljs-title class_">i</span>++) {</li><li>            <span class="hljs-comment">// Activate threads to execute load tasks</span></li><li>            <span class="hljs-variable">loadThreads</span>.<span class="hljs-title function_">emplace_back</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>(<span class="hljs-title class_">AddLoads</span>, <span class="hljs-title class_">TASKS</span>));</li><li>            <span class="hljs-variable">loadThreads</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">detach</span>();</li><li>        }</li><li>        <span class="hljs-variable">g_addLoad</span> = <span class="hljs-keyword">true</span>;</li><li>    }</li><li>
</li><li>    <span class="hljs-comment">// set QOS_BACKGROUND level</span></li><li>    <span class="hljs-variable">QoS_Level</span> <span class="hljs-variable">level</span> = <span class="hljs-variable">QoS_Level</span>::<span class="hljs-title class_">QOS_BACKGROUND</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">task</span>(<span class="hljs-title class_">SetQoS</span>, <span class="hljs-title class_">level</span>);</li><li>    <span class="hljs-variable">task</span>.<span class="hljs-title function_">join</span>();</li><li>
</li><li>    <span class="hljs-comment">// Return calculation time</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">res</span>;</li><li>    <span class="hljs-title function_">napi_create_double</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">g_durationTime</span>, &amp;<span class="hljs-title class_">res</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">res</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L164-L186" target="_blank">main.cpp</a></div></div></div></div> </li></ul> <p>计算线程（线程id：39260）设置低QoS等级trace图：</p> <p><span><img height="132.66750000000002" originheight="321" originwidth="1263" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.19884557626359500901980354964113:50001231000000:2800:A44E005FD18F0A87C5CF91745ACAFEA44696E8A0930654DF5F916FD510DB1769.png" title="点击放大" width="523.6875"></span></p> <p>如上图所示，计算线程执行完计算任务耗时726.8毫秒。</p> <ul><li><strong>给计算线程配置高QoS等级</strong><div class="screenLinkPre"><div _ngcontent-foc-c106="" class="highlight-div"><div _ngcontent-foc-c106="" class="highlight-div-header"><div _ngcontent-foc-c106="" class="highlight-div-header-left"><div _ngcontent-foc-c106="" class="handle-button expand-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">收起</div></div></div><div _ngcontent-foc-c106="" class="highlight-div-header-right"><div _ngcontent-foc-c106="" class="handle-button ai-button"></div><div _ngcontent-foc-c106="" class="handle-button line-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">自动换行</div></div><div _ngcontent-foc-c106="" class="handle-button theme-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">深色代码主题</div></div><div _ngcontent-foc-c106="" class="handle-button copy-button"><div _ngcontent-foc-c106="" class="handle-hover-tips">复制</div></div></div></div><div _ngcontent-foc-c106="" class="highlight-scroll-div"><pre class="screen prettyprint linenums hljs language-cangjie" codehub="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L139-L160" data-highlighted="yes"><ol class="linenums"><li><span class="hljs-keyword">static</span> <span class="hljs-variable">napi_value</span> <span class="hljs-title function_">highQoSCalculate</span>(<span class="hljs-variable">napi_env</span> <span class="hljs-variable">env</span>, <span class="hljs-variable">napi_callback_info</span> <span class="hljs-variable">info</span>) {</li><li>    <span class="hljs-variable">g_durationTime</span> = <span class="hljs-number">0</span>;</li><li>    <span class="hljs-comment">// Simulate system load</span></li><li>    <span class="hljs-keyword">if</span> (!<span class="hljs-variable">g_addLoad</span>) {</li><li>        <span class="hljs-variable">std</span>::<span class="hljs-title class_">vector</span>&lt;<span class="hljs-title class_">std</span>::<span class="hljs-title class_">thread</span>&gt; <span class="hljs-title class_">loadThreads</span>;</li><li>        <span class="hljs-keyword">for</span> (<span class="hljs-variable">int</span> <span class="hljs-variable">i</span> = <span class="hljs-number">0</span>; <span class="hljs-variable">i</span> &lt; <span class="hljs-title class_">TASKS</span>; <span class="hljs-title class_">i</span>++) {</li><li>            <span class="hljs-comment">// Activate threads to execute load tasks</span></li><li>            <span class="hljs-variable">loadThreads</span>.<span class="hljs-title function_">emplace_back</span>(<span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span>(<span class="hljs-title class_">AddLoads</span>, <span class="hljs-title class_">TASKS</span>));</li><li>            <span class="hljs-variable">loadThreads</span>[<span class="hljs-variable">i</span>].<span class="hljs-title function_">detach</span>();</li><li>        }</li><li>        <span class="hljs-variable">g_addLoad</span> = <span class="hljs-keyword">true</span>;</li><li>    }</li><li>    <span class="hljs-comment">// set QOS_USER_INTERACTIVE level</span></li><li>    <span class="hljs-variable">QoS_Level</span> <span class="hljs-variable">level</span> = <span class="hljs-variable">QoS_Level</span>::<span class="hljs-title class_">QOS_USER_INTERACTIVE</span>;</li><li>    <span class="hljs-variable">std</span>::<span class="hljs-title class_">thread</span> <span class="hljs-title class_">task</span>(<span class="hljs-title class_">SetQoS</span>, <span class="hljs-title class_">level</span>);</li><li>    <span class="hljs-variable">task</span>.<span class="hljs-title function_">join</span>();</li><li>
</li><li>    <span class="hljs-comment">// Return calculation time</span></li><li>    <span class="hljs-variable">napi_value</span> <span class="hljs-variable">res</span>;</li><li>    <span class="hljs-title function_">napi_create_double</span>(<span class="hljs-variable">env</span>, <span class="hljs-variable">g_durationTime</span>, &amp;<span class="hljs-title class_">res</span>);</li><li>    <span class="hljs-keyword">return</span> <span class="hljs-variable">res</span>;</li><li>}</li></ol></pre><div class="screen-link-div"><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/blob/master/NdkQoS/entry/src/main/cpp/main.cpp#L139-L160" target="_blank">main.cpp</a></div></div></div></div> </li></ul> <p>计算线程（线程id：39204）设置高QoS等级trace图：</p> <p><span><img height="138.6525" originheight="275" originwidth="1036" src="https://alliance-communityfile-drcn.dbankcdn.com/FileServer/getFile/cmtyPub/011/111/111/0000000000011111111.20251211163057.92886088136260018818683136203029:50001231000000:2800:C06C77BE5F995B7A5D2417CE00DE4B69C949305D477F4405533D95C511ACACF6.png" title="点击放大" width="523.6875"></span></p> <p>如上图所示，计算线程执行完计算任务耗时323.9毫秒。</p> <div><div class="hw-editor-tip info"><div class="title">说明</div><div class="content"><p>该示例只在高负载压力下有效。</p> <p>在低负载情况下，由于系统资源相对充足，大多数线程能够获得足够的CPU时间，因此优先级设置对线程执行效率的影响不明显。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section148mcpsimp">总结<i class="anchor-icon anchor-icon-link" anchorid="section148mcpsimp" tips="复制节点链接"></i></h2> <div class="tablenoborder"><div class="tbBox"><table class="layoutFixed idpTab"><thead><tr><th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.1" valign="top" width="33.33333333333333%"><p>方案</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.2" valign="top" width="33.33333333333333%"><p>斐波那契数列项数</p> </th> <th align="left" class="cellrowborder" id="mcps1.3.5.2.1.4.1.3" valign="top" width="33.33333333333333%"><p>计算耗时</p> </th> </tr> </thead> <tbody><tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>低Qos等级 QOS_BACKGROUND</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>34</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>726.8毫秒</p> </td> </tr> <tr><td class="cellrowborder" valign="top" width="33.33333333333333%"><p>高Qos等级 QOS_USER_INTERACTIVE</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>34</p> </td> <td class="cellrowborder" valign="top" width="33.33333333333333%"><p>323.9毫秒</p> </td> </tr>  </tbody></table></div> </div> <p>通过上述对比可以发现，<strong> 高负载压力下</strong>，高QoS优先级的线程可以更快的执行完计算任务。因此在实践中我们通过合理设置线程优先级，给关键线程以相对较高的QoS等级可以有效地避免关键线程被打断，从而保证应用程序的稳定性和响应性。</p> <div><div class="hw-editor-tip warn"><div class="title">注意</div><div class="content"><p>由于整机资源有限，若应用内部方法均设置高QoS等级，将导致资源相互抢占。此外，高QoS等级线程会相比低等级线程获取更多资源，过度提升线程QoS等级可能引起其他线程饥饿，从而影响整个系统的稳定运行。因此，线程QoS等级的设置需要结合具体应用场景和需求。</p> </div></div></div> </div> <div class="tiledSection"><h2 id="section579014539290">示例代码<i class="anchor-icon anchor-icon-link" anchorid="section579014539290" tips="复制节点链接"></i></h2><ul><li><a href="https://gitee.com/harmonyos_samples/BestPracticeSnippets/tree/master/NdkQoS" target="_blank">基于QoS设置线程优先级</a></li></ul> </div> </div></div>